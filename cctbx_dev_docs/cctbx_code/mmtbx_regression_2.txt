

 *******************************************************************************
mmtbx/regression/model/tst_model_biomt_mtrix.py
from __future__ import absolute_import, division, print_function
import iotbx.pdb
import mmtbx.model
import time

"""
Test multiplication of hierarchy and SS annotations in different combinations
of MTRIX and BIOMT records presence.
"""

single_mtrix_txt = """
MTRIX1   1  1.000000  0.000000  0.000000        0.00000    1
MTRIX2   1  0.000000  1.000000  0.000000        0.00000    1
MTRIX3   1  0.000000  0.000000  1.000000        0.00000    1
MTRIX1   2  0.479787 -0.038259 -0.876550        0.00000
MTRIX2   2 -0.530698  0.782918 -0.324654        0.00000
MTRIX3   2  0.698688  0.620947  0.355330        0.00000
"""


mtrix_txt = """
MTRIX1   1  1.000000  0.000000  0.000000        0.00000    1
MTRIX2   1  0.000000  1.000000  0.000000        0.00000    1
MTRIX3   1  0.000000  0.000000  1.000000        0.00000    1
MTRIX1   2  0.479787 -0.038259 -0.876550        0.00000
MTRIX2   2 -0.530698  0.782918 -0.324654        0.00000
MTRIX3   2  0.698688  0.620947  0.355330        0.00000
MTRIX1   3 -0.361936 -0.592602 -0.719600        0.00000
MTRIX2   3 -0.896947  0.431671  0.095646        0.00000
MTRIX3   3  0.253950  0.680060 -0.687769        0.00000
"""

biomt_txt = """
REMARK 350   BIOMT1   1  1.000000  0.000000  0.000000        0.00000
REMARK 350   BIOMT2   1  0.000000  1.000000  0.000000        0.00000
REMARK 350   BIOMT3   1  0.000000  0.000000  1.000000        0.00000
REMARK 350   BIOMT1   2  0.500000 -0.809017  0.309017        0.00000
REMARK 350   BIOMT2   2  0.809017  0.309017 -0.500000        0.00000
REMARK 350   BIOMT3   2  0.309017  0.500000  0.809017        0.00000
REMARK 350   BIOMT1   3 -0.309017 -0.500000  0.809017        0.00000
REMARK 350   BIOMT2   3  0.500000 -0.809017 -0.309017        0.00000
REMARK 350   BIOMT3   3  0.809017  0.309017  0.500000        0.00000
"""

ss_txt = """
HELIX    6   6 ARG A  316  LEU A  318  5                                   3
HELIX    7   7 SER A  335  ASN A  341  1                                   7
SHEET    1   E 2 TYR A 305  SER A 308  0
SHEET    2   E 2 GLN A 311  GLU A 314 -1  O  ARG A 313   N  PHE A 306

"""

# 300 atoms
atoms_txt = """
CRYST1   10.000   10.000   10.000  90.00  90.00  90.00 P 1
ATOM   2065  N   GLY A 304       3.950 -35.449 102.015  1.00 21.30           N
ATOM   2066  CA  GLY A 304       4.631 -35.764 103.257  1.00 19.87           C
ATOM   2067  C   GLY A 304       6.074 -36.196 103.097  1.00 19.37           C
ATOM   2068  O   GLY A 304       6.642 -36.823 103.994  1.00 18.69           O
ATOM   2069  N   TYR A 305       6.673 -35.863 101.957  1.00 19.21           N
ATOM   2070  CA  TYR A 305       8.065 -36.210 101.688  1.00 18.15           C
ATOM   2071  C   TYR A 305       8.975 -35.002 101.819  1.00 18.33           C
ATOM   2072  O   TYR A 305       8.673 -33.920 101.314  1.00 19.14           O
ATOM   2073  CB  TYR A 305       8.202 -36.803 100.289  1.00 17.45           C
ATOM   2074  CG  TYR A 305       7.826 -38.258 100.228  1.00 18.23           C
ATOM   2075  CD1 TYR A 305       8.761 -39.250 100.515  1.00 18.89           C
ATOM   2076  CD2 TYR A 305       6.526 -38.647  99.917  1.00 17.60           C
ATOM   2077  CE1 TYR A 305       8.411 -40.595 100.493  1.00 18.65           C
ATOM   2078  CE2 TYR A 305       6.166 -39.982  99.895  1.00 18.16           C
ATOM   2079  CZ  TYR A 305       7.112 -40.954 100.182  1.00 18.93           C
ATOM   2080  OH  TYR A 305       6.756 -42.284 100.149  1.00 20.67           O
ATOM   2081  N   PHE A 306      10.097 -35.200 102.498  1.00 18.08           N
ATOM   2082  CA  PHE A 306      11.061 -34.133 102.707  1.00 18.50           C
ATOM   2083  C   PHE A 306      12.458 -34.585 102.325  1.00 19.27           C
ATOM   2084  O   PHE A 306      12.737 -35.780 102.239  1.00 19.20           O
ATOM   2085  CB  PHE A 306      11.071 -33.720 104.181  1.00 18.35           C
ATOM   2086  CG  PHE A 306       9.784 -33.115 104.650  1.00 18.59           C
ATOM   2087  CD1 PHE A 306       9.582 -31.744 104.580  1.00 18.76           C
ATOM   2088  CD2 PHE A 306       8.765 -33.919 105.141  1.00 18.71           C
ATOM   2089  CE1 PHE A 306       8.379 -31.180 104.994  1.00 19.56           C
ATOM   2090  CE2 PHE A 306       7.558 -33.366 105.557  1.00 20.09           C
ATOM   2091  CZ  PHE A 306       7.365 -31.993 105.483  1.00 20.22           C
ATOM   2092  N   MET A 307      13.330 -33.615 102.088  1.00 20.68           N
ATOM   2093  CA  MET A 307      14.717 -33.899 101.773  1.00 21.16           C
ATOM   2094  C   MET A 307      15.423 -33.667 103.103  1.00 22.68           C
ATOM   2095  O   MET A 307      15.811 -32.544 103.417  1.00 23.48           O
ATOM   2096  CB  MET A 307      15.243 -32.920 100.729  1.00 20.61           C
ATOM   2097  CG  MET A 307      16.666 -33.197 100.265  1.00 21.45           C
ATOM   2098  SD  MET A 307      16.835 -34.726  99.306  1.00 21.53           S
ATOM   2099  CE  MET A 307      18.018 -35.567 100.270  1.00 21.98           C
ATOM   2100  N   SER A 308      15.551 -34.726 103.900  1.00 23.90           N
ATOM   2101  CA  SER A 308      16.196 -34.629 105.204  1.00 25.50           C
ATOM   2102  C   SER A 308      17.711 -34.736 105.044  1.00 26.51           C
ATOM   2103  O   SER A 308      18.287 -35.817 105.177  1.00 26.25           O
ATOM   2104  CB  SER A 308      15.681 -35.736 106.127  1.00 25.33           C
ATOM   2105  OG  SER A 308      16.066 -35.503 107.471  1.00 28.15           O
ATOM   2106  N   ASN A 309      18.344 -33.602 104.754  1.00 27.44           N
ATOM   2107  CA  ASN A 309      19.787 -33.533 104.556  1.00 28.19           C
ATOM   2108  C   ASN A 309      20.235 -34.192 103.260  1.00 28.98           C
ATOM   2109  O   ASN A 309      20.106 -33.612 102.183  1.00 30.58           O
ATOM   2110  CB  ASN A 309      20.522 -34.170 105.737  1.00 28.18           C
ATOM   2111  CG  ASN A 309      20.631 -33.238 106.923  1.00 28.56           C
ATOM   2112  OD1 ASN A 309      21.308 -32.212 106.855  1.00 28.58           O
ATOM   2113  ND2 ASN A 309      19.963 -33.585 108.017  1.00 27.94           N
ATOM   2114  N   ASP A 310      20.753 -35.410 103.369  1.00 28.99           N
ATOM   2115  CA  ASP A 310      21.249 -36.144 102.212  1.00 28.59           C
ATOM   2116  C   ASP A 310      20.246 -37.125 101.612  1.00 27.76           C
ATOM   2117  O   ASP A 310      20.386 -37.526 100.457  1.00 28.39           O
ATOM   2118  CB  ASP A 310      22.514 -36.904 102.598  1.00 30.83           C
ATOM   2119  CG  ASP A 310      22.271 -37.900 103.717  1.00 33.72           C
ATOM   2120  OD1 ASP A 310      21.917 -37.469 104.838  1.00 32.95           O
ATOM   2121  OD2 ASP A 310      22.426 -39.118 103.473  1.00 34.80           O
ATOM   2122  N   GLN A 311      19.238 -37.512 102.388  1.00 26.40           N
ATOM   2123  CA  GLN A 311      18.239 -38.461 101.910  1.00 24.95           C
ATOM   2124  C   GLN A 311      16.812 -37.956 101.941  1.00 23.86           C
ATOM   2125  O   GLN A 311      16.499 -36.941 102.561  1.00 23.90           O
ATOM   2126  CB  GLN A 311      18.268 -39.739 102.741  1.00 27.17           C
ATOM   2127  CG  GLN A 311      19.513 -40.558 102.642  1.00 31.00           C
ATOM   2128  CD  GLN A 311      19.343 -41.880 103.340  1.00 32.73           C
ATOM   2129  OE1 GLN A 311      18.986 -41.928 104.519  1.00 32.73           O
ATOM   2130  NE2 GLN A 311      19.591 -42.969 102.618  1.00 35.40           N
ATOM   2131  N   ILE A 312      15.948 -38.706 101.272  1.00 22.64           N
ATOM   2132  CA  ILE A 312      14.529 -38.409 101.221  1.00 20.51           C
ATOM   2133  C   ILE A 312      13.903 -39.134 102.404  1.00 21.02           C
ATOM   2134  O   ILE A 312      14.209 -40.300 102.653  1.00 21.21           O
ATOM   2135  CB  ILE A 312      13.886 -38.956  99.933  1.00 19.13           C
ATOM   2136  CG1 ILE A 312      14.452 -38.229  98.715  1.00 18.32           C
ATOM   2137  CG2 ILE A 312      12.375 -38.824 100.008  1.00 17.77           C
ATOM   2138  CD1 ILE A 312      13.918 -38.745  97.395  1.00 17.16           C
ATOM   2139  N   ARG A 313      13.042 -38.442 103.140  1.00 21.29           N
ATOM   2140  CA  ARG A 313      12.363 -39.049 104.275  1.00 21.69           C
ATOM   2141  C   ARG A 313      10.872 -38.764 104.223  1.00 22.24           C
ATOM   2142  O   ARG A 313      10.445 -37.705 103.766  1.00 22.50           O
ATOM   2143  CB  ARG A 313      12.932 -38.539 105.601  1.00 21.74           C
ATOM   2144  CG  ARG A 313      14.216 -39.223 106.028  1.00 23.27           C
ATOM   2145  CD  ARG A 313      14.488 -39.007 107.511  1.00 24.27           C
ATOM   2146  NE  ARG A 313      15.647 -39.768 107.970  1.00 26.04           N
ATOM   2147  CZ  ARG A 313      16.906 -39.483 107.652  1.00 26.93           C
ATOM   2148  NH1 ARG A 313      17.177 -38.443 106.873  1.00 26.76           N
ATOM   2149  NH2 ARG A 313      17.895 -40.244 108.103  1.00 27.18           N
ATOM   2150  N   GLU A 314      10.085 -39.729 104.686  1.00 23.21           N
ATOM   2151  CA  GLU A 314       8.637 -39.591 104.709  1.00 23.33           C
ATOM   2152  C   GLU A 314       8.256 -39.096 106.107  1.00 23.56           C
ATOM   2153  O   GLU A 314       8.950 -39.370 107.084  1.00 23.95           O
ATOM   2154  CB  GLU A 314       7.990 -40.946 104.405  1.00 23.60           C
ATOM   2155  CG  GLU A 314       6.517 -40.906 104.006  1.00 25.54           C
ATOM   2156  CD  GLU A 314       5.571 -40.837 105.196  1.00 27.64           C
ATOM   2157  OE1 GLU A 314       5.803 -41.568 106.184  1.00 27.37           O
ATOM   2158  OE2 GLU A 314       4.586 -40.068 105.137  1.00 27.35           O
ATOM   2159  N   ARG A 315       7.162 -38.349 106.187  1.00 23.65           N
ATOM   2160  CA  ARG A 315       6.672 -37.790 107.443  1.00 22.98           C
ATOM   2161  C   ARG A 315       6.921 -38.651 108.687  1.00 22.60           C
ATOM   2162  O   ARG A 315       7.532 -38.196 109.653  1.00 22.85           O
ATOM   2163  CB  ARG A 315       5.173 -37.516 107.323  1.00 23.23           C
ATOM   2164  CG  ARG A 315       4.735 -36.167 107.842  1.00 24.91           C
ATOM   2165  CD  ARG A 315       3.231 -36.143 108.070  1.00 28.73           C
ATOM   2166  NE  ARG A 315       2.444 -36.339 106.853  1.00 31.17           N
ATOM   2167  CZ  ARG A 315       2.358 -35.454 105.863  1.00 34.22           C
ATOM   2168  NH1 ARG A 315       3.018 -34.301 105.937  1.00 36.07           N
ATOM   2169  NH2 ARG A 315       1.596 -35.715 104.805  1.00 32.99           N
ATOM   2170  N   ARG A 316       6.447 -39.893 108.657  1.00 22.00           N
ATOM   2171  CA  ARG A 316       6.578 -40.806 109.792  1.00 21.99           C
ATOM   2172  C   ARG A 316       7.984 -41.091 110.302  1.00 23.09           C
ATOM   2173  O   ARG A 316       8.149 -41.529 111.439  1.00 23.65           O
ATOM   2174  CB  ARG A 316       5.886 -42.136 109.475  1.00 21.22           C
ATOM   2175  CG  ARG A 316       4.373 -42.042 109.402  1.00 23.38           C
ATOM   2176  CD  ARG A 316       3.836 -42.668 108.123  1.00 26.73           C
ATOM   2177  NE  ARG A 316       3.995 -44.121 108.085  1.00 28.42           N
ATOM   2178  CZ  ARG A 316       4.479 -44.789 107.040  1.00 28.61           C
ATOM   2179  NH1 ARG A 316       4.857 -44.132 105.954  1.00 29.34           N
ATOM   2180  NH2 ARG A 316       4.571 -46.113 107.074  1.00 27.85           N
ATOM   2181  N   ASP A 317       9.000 -40.846 109.485  1.00 25.17           N
ATOM   2182  CA  ASP A 317      10.363 -41.127 109.913  1.00 26.92           C
ATOM   2183  C   ASP A 317      11.076 -39.946 110.566  1.00 26.95           C
ATOM   2184  O   ASP A 317      12.094 -40.123 111.234  1.00 27.91           O
ATOM   2185  CB  ASP A 317      11.184 -41.652 108.733  1.00 31.20           C
ATOM   2186  CG  ASP A 317      12.583 -42.075 109.139  1.00 35.93           C
ATOM   2187  OD1 ASP A 317      13.435 -41.187 109.360  1.00 40.17           O
ATOM   2188  OD2 ASP A 317      12.831 -43.295 109.250  1.00 37.90           O
ATOM   2189  N   LEU A 318      10.550 -38.741 110.378  1.00 26.49           N
ATOM   2190  CA  LEU A 318      11.155 -37.560 110.985  1.00 26.24           C
ATOM   2191  C   LEU A 318      10.717 -37.537 112.448  1.00 26.95           C
ATOM   2192  O   LEU A 318       9.800 -36.810 112.828  1.00 27.99           O
ATOM   2193  CB  LEU A 318      10.693 -36.301 110.252  1.00 24.34           C
ATOM   2194  CG  LEU A 318      11.071 -36.288 108.768  1.00 23.72           C
ATOM   2195  CD1 LEU A 318      10.394 -35.132 108.065  1.00 24.49           C
ATOM   2196  CD2 LEU A 318      12.580 -36.193 108.629  1.00 24.02           C
ATOM   2197  N   THR A 319      11.392 -38.343 113.259  1.00 27.73           N
ATOM   2198  CA  THR A 319      11.076 -38.486 114.676  1.00 27.93           C
ATOM   2199  C   THR A 319      11.764 -37.518 115.637  1.00 28.67           C
ATOM   2200  O   THR A 319      11.364 -37.407 116.795  1.00 29.01           O
ATOM   2201  CB  THR A 319      11.379 -39.919 115.137  1.00 27.93           C
ATOM   2202  OG1 THR A 319      12.746 -40.235 114.841  1.00 27.70           O
ATOM   2203  CG2 THR A 319      10.472 -40.911 114.417  1.00 26.51           C
ATOM   2204  N   THR A 320      12.797 -36.826 115.169  1.00 29.46           N
ATOM   2205  CA  THR A 320      13.513 -35.872 116.011  1.00 29.47           C
ATOM   2206  C   THR A 320      12.739 -34.564 116.150  1.00 30.76           C
ATOM   2207  O   THR A 320      12.574 -34.041 117.251  1.00 31.05           O
ATOM   2208  CB  THR A 320      14.900 -35.571 115.435  1.00 29.84           C
ATOM   2209  OG1 THR A 320      15.722 -36.738 115.556  1.00 28.30           O
ATOM   2210  CG2 THR A 320      15.548 -34.398 116.168  1.00 30.39           C
ATOM   2211  N   SER A 321      12.274 -34.035 115.023  1.00 31.46           N
ATOM   2212  CA  SER A 321      11.505 -32.799 115.014  1.00 31.46           C
ATOM   2213  C   SER A 321      10.184 -33.067 114.316  1.00 30.56           C
ATOM   2214  O   SER A 321      10.104 -33.934 113.448  1.00 32.00           O
ATOM   2215  CB  SER A 321      12.270 -31.700 114.277  1.00 33.39           C
ATOM   2216  OG  SER A 321      13.478 -31.389 114.950  1.00 37.51           O
ATOM   2217  N   VAL A 322       9.149 -32.325 114.694  1.00 28.32           N
ATOM   2218  CA  VAL A 322       7.829 -32.503 114.103  1.00 25.27           C
ATOM   2219  C   VAL A 322       7.760 -31.974 112.671  1.00 24.50           C
ATOM   2220  O   VAL A 322       8.001 -30.794 112.424  1.00 24.31           O
ATOM   2221  CB  VAL A 322       6.756 -31.795 114.945  1.00 24.16           C
ATOM   2222  CG1 VAL A 322       5.380 -32.058 114.362  1.00 24.15           C
ATOM   2223  CG2 VAL A 322       6.830 -32.275 116.380  1.00 23.55           C
ATOM   2224  N   PRO A 323       7.429 -32.850 111.708  1.00 23.60           N
ATOM   2225  CA  PRO A 323       7.325 -32.477 110.294  1.00 22.62           C
ATOM   2226  C   PRO A 323       6.166 -31.512 110.044  1.00 22.04           C
ATOM   2227  O   PRO A 323       5.076 -31.683 110.594  1.00 21.04           O
ATOM   2228  CB  PRO A 323       7.097 -33.816 109.596  1.00 22.18           C
ATOM   2229  CG  PRO A 323       7.725 -34.803 110.523  1.00 23.36           C
ATOM   2230  CD  PRO A 323       7.282 -34.306 111.868  1.00 23.35           C
ATOM   2231  N   PRO A 324       6.389 -30.483 109.214  1.00 21.26           N
ATOM   2232  CA  PRO A 324       5.345 -29.504 108.905  1.00 20.28           C
ATOM   2233  C   PRO A 324       4.265 -30.149 108.052  1.00 20.15           C
ATOM   2234  O   PRO A 324       4.394 -31.297 107.620  1.00 21.43           O
ATOM   2235  CB  PRO A 324       6.093 -28.424 108.128  1.00 20.19           C
ATOM   2236  CG  PRO A 324       7.499 -28.565 108.593  1.00 22.05           C
ATOM   2237  CD  PRO A 324       7.676 -30.054 108.644  1.00 21.65           C
ATOM   2238  N   VAL A 325       3.207 -29.394 107.797  1.00 18.93           N
ATOM   2239  CA  VAL A 325       2.106 -29.878 106.986  1.00 17.74           C
ATOM   2240  C   VAL A 325       1.533 -28.648 106.265  1.00 18.27           C
ATOM   2241  O   VAL A 325       1.462 -27.564 106.845  1.00 19.21           O
ATOM   2242  CB  VAL A 325       1.065 -30.589 107.891  1.00 15.23           C
ATOM   2243  CG1 VAL A 325       0.310 -29.581 108.721  1.00 16.64           C
ATOM   2244  CG2 VAL A 325       0.144 -31.438 107.066  1.00 16.39           C
ATOM   2245  N   ALA A 326       1.160 -28.802 104.998  1.00 18.66           N
ATOM   2246  CA  ALA A 326       0.636 -27.680 104.211  1.00 19.12           C
ATOM   2247  C   ALA A 326      -0.783 -27.267 104.588  1.00 19.46           C
ATOM   2248  O   ALA A 326      -1.755 -27.780 104.035  1.00 22.10           O
ATOM   2249  CB  ALA A 326       0.699 -28.016 102.723  1.00 17.55           C
ATOM   2250  N   LEU A 327      -0.898 -26.324 105.516  1.00 17.63           N
ATOM   2251  CA  LEU A 327      -2.205 -25.855 105.961  1.00 16.12           C
ATOM   2252  C   LEU A 327      -2.471 -24.440 105.467  1.00 16.88           C
ATOM   2253  O   LEU A 327      -1.590 -23.795 104.901  1.00 18.47           O
ATOM   2254  CB  LEU A 327      -2.279 -25.897 107.487  1.00 13.74           C
ATOM   2255  CG  LEU A 327      -1.897 -27.240 108.115  1.00 11.17           C
ATOM   2256  CD1 LEU A 327      -1.930 -27.126 109.624  1.00  9.68           C
ATOM   2257  CD2 LEU A 327      -2.840 -28.330 107.633  1.00  9.69           C
ATOM   2258  N   THR A 328      -3.692 -23.962 105.683  1.00 16.51           N
ATOM   2259  CA  THR A 328      -4.076 -22.623 105.254  1.00 15.88           C
ATOM   2260  C   THR A 328      -3.155 -21.559 105.881  1.00 15.66           C
ATOM   2261  O   THR A 328      -3.011 -21.475 107.101  1.00 14.78           O
ATOM   2262  CB  THR A 328      -5.577 -22.379 105.580  1.00 14.98           C
ATOM   2263  OG1 THR A 328      -5.835 -20.975 105.690  1.00 15.31           O
ATOM   2264  CG2 THR A 328      -5.968 -23.098 106.862  1.00 16.50           C
ATOM   2265  N   ALA A 329      -2.535 -20.758 105.015  1.00 15.68           N
ATOM   2266  CA  ALA A 329      -1.570 -19.718 105.391  1.00 15.70           C
ATOM   2267  C   ALA A 329      -2.002 -18.573 106.305  1.00 16.13           C
ATOM   2268  O   ALA A 329      -3.165 -18.169 106.317  1.00 15.82           O
ATOM   2269  CB  ALA A 329      -0.949 -19.136 104.123  1.00 15.02           C
ATOM   2270  N   THR A 330      -1.028 -18.050 107.054  1.00 17.52           N
ATOM   2271  CA  THR A 330      -1.220 -16.930 107.984  1.00 18.76           C
ATOM   2272  C   THR A 330       0.039 -16.068 108.050  1.00 18.94           C
ATOM   2273  O   THR A 330       1.134 -16.520 107.713  1.00 18.98           O
ATOM   2274  CB  THR A 330      -1.486 -17.400 109.427  1.00 18.55           C
ATOM   2275  OG1 THR A 330      -2.582 -18.314 109.441  1.00 25.08           O
ATOM   2276  CG2 THR A 330      -1.826 -16.215 110.316  1.00 17.33           C
ATOM   2277  N   LYS A 331      -0.130 -14.826 108.494  1.00 18.76           N
ATOM   2278  CA  LYS A 331       0.981 -13.893 108.648  1.00 18.12           C
ATOM   2279  C   LYS A 331       1.276 -13.801 110.140  1.00 18.19           C
ATOM   2280  O   LYS A 331       2.396 -13.505 110.551  1.00 19.51           O
ATOM   2281  CB  LYS A 331       0.595 -12.500 108.149  1.00 17.57           C
ATOM   2282  CG  LYS A 331       0.218 -12.405 106.686  1.00 18.42           C
ATOM   2283  CD  LYS A 331      -0.306 -11.007 106.356  1.00 18.16           C
ATOM   2284  CE  LYS A 331       0.701  -9.919 106.725  1.00 16.46           C
ATOM   2285  NZ  LYS A 331       0.187  -8.552 106.431  1.00 15.24           N
ATOM   2286  N   LEU A 332       0.247 -14.064 110.937  1.00 18.16           N
ATOM   2287  CA  LEU A 332       0.315 -14.001 112.393  1.00 18.94           C
ATOM   2288  C   LEU A 332       1.112 -15.152 113.006  1.00 20.72           C
ATOM   2289  O   LEU A 332       1.034 -15.408 114.207  1.00 21.12           O
ATOM   2290  CB  LEU A 332      -1.111 -13.996 112.944  1.00 17.77           C
ATOM   2291  CG  LEU A 332      -2.055 -13.055 112.181  1.00 15.45           C
ATOM   2292  CD1 LEU A 332      -3.501 -13.375 112.509  1.00 14.04           C
ATOM   2293  CD2 LEU A 332      -1.723 -11.617 112.522  1.00 12.75           C
ATOM   2294  N   ASN A 333       1.880 -15.838 112.166  1.00 23.44           N
ATOM   2295  CA  ASN A 333       2.703 -16.971 112.578  1.00 23.93           C
ATOM   2296  C   ASN A 333       4.150 -16.545 112.728  1.00 24.70           C
ATOM   2297  O   ASN A 333       4.853 -16.992 113.632  1.00 24.54           O
ATOM   2298  CB  ASN A 333       2.646 -18.062 111.515  1.00 26.61           C
ATOM   2299  CG  ASN A 333       1.858 -19.250 111.956  1.00 29.55           C
ATOM   2300  OD1 ASN A 333       2.146 -19.843 112.991  1.00 33.22           O
ATOM   2301  ND2 ASN A 333       0.853 -19.617 111.173  1.00 34.06           N
ATOM   2302  N   GLN A 334       4.586 -15.696 111.803  1.00 24.83           N
ATOM   2303  CA  GLN A 334       5.948 -15.190 111.768  1.00 24.33           C
ATOM   2304  C   GLN A 334       6.154 -14.072 112.782  1.00 23.29           C
ATOM   2305  O   GLN A 334       5.292 -13.209 112.949  1.00 23.17           O
ATOM   2306  CB  GLN A 334       6.257 -14.671 110.362  1.00 26.56           C
ATOM   2307  CG  GLN A 334       7.356 -15.429 109.623  1.00 29.28           C
ATOM   2308  CD  GLN A 334       7.077 -16.915 109.515  1.00 28.54           C
ATOM   2309  OE1 GLN A 334       6.021 -17.330 109.038  1.00 28.36           O
ATOM   2310  NE2 GLN A 334       8.031 -17.725 109.954  1.00 29.34           N
ATOM   2311  N   SER A 335       7.298 -14.094 113.459  1.00 21.22           N
ATOM   2312  CA  SER A 335       7.616 -13.065 114.439  1.00 19.84           C
ATOM   2313  C   SER A 335       8.243 -11.891 113.700  1.00 19.90           C
ATOM   2314  O   SER A 335       8.584 -12.005 112.522  1.00 19.68           O
ATOM   2315  CB  SER A 335       8.600 -13.597 115.479  1.00 19.73           C
ATOM   2316  OG  SER A 335       9.870 -13.836 114.897  1.00 20.23           O
ATOM   2317  N   ALA A 336       8.401 -10.767 114.393  1.00 19.82           N
ATOM   2318  CA  ALA A 336       8.988  -9.579 113.787  1.00 18.90           C
ATOM   2319  C   ALA A 336      10.408  -9.856 113.309  1.00 19.44           C
ATOM   2320  O   ALA A 336      10.807  -9.413 112.232  1.00 18.92           O
ATOM   2321  CB  ALA A 336       8.987  -8.436 114.780  1.00 18.18           C
ATOM   2322  N   SER A 337      11.169 -10.592 114.112  1.00 20.65           N
ATOM   2323  CA  SER A 337      12.543 -10.918 113.756  1.00 21.77           C
ATOM   2324  C   SER A 337      12.601 -11.896 112.588  1.00 21.99           C
ATOM   2325  O   SER A 337      13.536 -11.852 111.790  1.00 22.49           O
ATOM   2326  CB  SER A 337      13.280 -11.495 114.963  1.00 21.52           C
ATOM   2327  OG  SER A 337      12.584 -12.609 115.487  1.00 27.59           O
ATOM   2328  N   ASN A 338      11.610 -12.779 112.484  1.00 22.03           N
ATOM   2329  CA  ASN A 338      11.584 -13.729 111.378  1.00 22.50           C
ATOM   2330  C   ASN A 338      11.427 -12.965 110.068  1.00 22.06           C
ATOM   2331  O   ASN A 338      12.155 -13.213 109.108  1.00 21.25           O
ATOM   2332  CB  ASN A 338      10.430 -14.727 111.517  1.00 25.28           C
ATOM   2333  CG  ASN A 338      10.682 -15.778 112.586  1.00 27.64           C
ATOM   2334  OD1 ASN A 338      11.812 -16.237 112.773  1.00 28.04           O
ATOM   2335  ND2 ASN A 338       9.620 -16.181 113.280  1.00 28.11           N
ATOM   2336  N   ASN A 339      10.477 -12.032 110.038  1.00 21.49           N
ATOM   2337  CA  ASN A 339      10.232 -11.229 108.844  1.00 20.40           C
ATOM   2338  C   ASN A 339      11.511 -10.562 108.357  1.00 19.57           C
ATOM   2339  O   ASN A 339      11.764 -10.496 107.156  1.00 20.36           O
ATOM   2340  CB  ASN A 339       9.186 -10.147 109.115  1.00 20.32           C
ATOM   2341  CG  ASN A 339       7.869 -10.714 109.585  1.00 20.71           C
ATOM   2342  OD1 ASN A 339       7.471 -11.806 109.178  1.00 22.61           O
ATOM   2343  ND2 ASN A 339       7.174  -9.969 110.435  1.00 19.61           N
ATOM   2344  N   LEU A 340      12.312 -10.065 109.294  1.00 17.69           N
ATOM   2345  CA  LEU A 340      13.561  -9.405 108.942  1.00 16.22           C
ATOM   2346  C   LEU A 340      14.507 -10.326 108.185  1.00 16.58           C
ATOM   2347  O   LEU A 340      15.286  -9.866 107.349  1.00 18.23           O
ATOM   2348  CB  LEU A 340      14.251  -8.872 110.198  1.00 13.20           C
ATOM   2349  CG  LEU A 340      13.589  -7.648 110.832  1.00 10.55           C
ATOM   2350  CD1 LEU A 340      14.276  -7.322 112.136  1.00  9.92           C
ATOM   2351  CD2 LEU A 340      13.663  -6.465 109.877  1.00  9.35           C
ATOM   2352  N   ASN A 341      14.435 -11.624 108.468  1.00 16.36           N
ATOM   2353  CA  ASN A 341      15.295 -12.597 107.798  1.00 15.90           C
ATOM   2354  C   ASN A 341      14.594 -13.269 106.626  1.00 15.59           C
ATOM   2355  O   ASN A 341      14.917 -14.403 106.269  1.00 15.34           O
ATOM   2356  CB  ASN A 341      15.754 -13.670 108.782  1.00 15.76           C
ATOM   2357  CG  ASN A 341      16.460 -13.089 109.977  1.00 16.78           C
ATOM   2358  OD1 ASN A 341      17.302 -12.200 109.841  1.00 19.51           O
ATOM   2359  ND2 ASN A 341      16.132 -13.593 111.161  1.00 16.09           N
ATOM   2360  N   ALA A 342      13.640 -12.566 106.027  1.00 14.50           N
ATOM   2361  CA  ALA A 342      12.894 -13.105 104.900  1.00 13.77           C
ATOM   2362  C   ALA A 342      13.788 -13.386 103.695  1.00 14.02           C
ATOM   2363  O   ALA A 342      14.703 -12.618 103.392  1.00 14.49           O
ATOM   2364  CB  ALA A 342      11.782 -12.143 104.511  1.00 12.29           C
"""

def exercise_single_mtrix():
  inp = iotbx.pdb.input(lines=single_mtrix_txt+ss_txt+atoms_txt, source_info=None)
  model = mmtbx.model.manager(
    model_input = inp)
  # print (model.model_as_pdb())
  assert model.get_number_of_atoms() == 600, model.get_number_of_atoms()
  assert model.get_hierarchy().atoms_size() == 600
  assert model.get_xray_structure().scatterers().size() == 600
  ss_ann = model.get_ss_annotation()
  # print ss_ann.as_pdb_str()
  assert ss_ann.get_n_helices() == 4
  assert ss_ann.get_n_sheets() == 2

def exercise_mtrix():
  inp = iotbx.pdb.input(lines=mtrix_txt+ss_txt+atoms_txt, source_info=None)
  model = mmtbx.model.manager(
    model_input = inp)
  assert model.get_number_of_atoms() == 900, model.get_number_of_atoms()
  assert model.get_hierarchy().atoms_size() == 900
  assert model.get_xray_structure().scatterers().size() == 900
  ss_ann = model.get_ss_annotation()
  # print ss_ann.as_pdb_str()
  assert ss_ann.get_n_helices() == 6
  assert ss_ann.get_n_sheets() == 3


def exercise_biomt():
  inp = iotbx.pdb.input(lines=biomt_txt+ss_txt+atoms_txt, source_info=None)
  model = mmtbx.model.manager(
    model_input = inp)
  assert model.get_number_of_atoms() == 300, model.get_number_of_atoms()
  assert model.get_hierarchy().atoms_size() == 300
  assert model.get_xray_structure().scatterers().size() == 300
  ss_ann = model.get_ss_annotation()
  assert ss_ann.get_n_helices() == 2
  assert ss_ann.get_n_sheets() == 1
  model.expand_with_BIOMT_records()
  assert model.get_number_of_atoms() == 900, model.get_number_of_atoms()
  assert model.get_hierarchy().atoms_size() == 900
  assert model.get_xray_structure().scatterers().size() == 900, model.get_xray_structure().scatterers().size()
  ss_ann = model.get_ss_annotation()
  assert ss_ann.get_n_helices() == 6
  assert ss_ann.get_n_sheets() == 3

def exercise_both():
  inp = iotbx.pdb.input(lines=mtrix_txt+biomt_txt+ss_txt+atoms_txt, source_info=None)
  model = mmtbx.model.manager(
    model_input = inp)
  assert model.get_number_of_atoms() == 900, model.get_number_of_atoms()
  assert model.get_hierarchy().atoms_size() == 900
  assert model.get_xray_structure().scatterers().size() == 900
  ss_ann = model.get_ss_annotation()
  # print ss_ann.as_pdb_str()
  # print "="*30
  assert ss_ann.get_n_helices() == 6
  assert ss_ann.get_n_sheets() == 3
  model.expand_with_BIOMT_records()
  assert model.get_number_of_atoms() == 2700, model.get_number_of_atoms()
  assert model.get_hierarchy().atoms_size() == 2700
  assert model.get_xray_structure().scatterers().size() == 2700, model.get_xray_structure().scatterers().size()
  ss_ann = model.get_ss_annotation()
  # print ss_ann.as_pdb_str()
  assert ss_ann.get_n_helices() == 18
  assert ss_ann.get_n_sheets() == 9
  return


if (__name__ == "__main__"):
  t0 = time.time()
  exercise_single_mtrix()
  exercise_mtrix()
  exercise_biomt()
  exercise_both()
  print("Total time: %8.3f"%(time.time() - t0))
  print("OK.")


 *******************************************************************************


 *******************************************************************************
mmtbx/regression/model/tst_model_biomt_mtrix_2.py
from __future__ import absolute_import, division, print_function
import iotbx.pdb
import mmtbx.model
import time

"""
Test multiplication of hierarchy and SS annotations in different combinations
of MTRIX and BIOMT records presence.
Corner case where MTRIX and BIOMT are identical. We want to silently skip BIOMT multiplication
if MTRIX was done, but not skip if MTRIX was not done.
"""

# pdb id: 7a5v
pdb_lines = """
CRYST1    1.000    1.000    1.000  90.00  90.00  90.00 P 1

MTRIX1   1  1.000000  0.000000  0.000000        0.00000    1
MTRIX2   1  0.000000  1.000000  0.000000        0.00000    1
MTRIX3   1  0.000000  0.000000  1.000000        0.00000    1
MTRIX1   2  0.309017 -0.951057  0.000000      239.91182
MTRIX2   2  0.951057  0.309017  0.000000      -37.99830
MTRIX3   2  0.000000  0.000000  1.000000        0.00000
MTRIX1   3 -0.809017 -0.587785  0.000000      350.18719
MTRIX2   3  0.587785 -0.809017  0.000000      178.42929
MTRIX3   3  0.000000  0.000000  1.000000        0.00000

REMARK 350   BIOMT1   1  1.000000  0.000000  0.000000        0.00000
REMARK 350   BIOMT2   1  0.000000  1.000000  0.000000        0.00000
REMARK 350   BIOMT3   1  0.000000  0.000000  1.000000        0.00000
REMARK 350   BIOMT1   2  0.309017 -0.951057  0.000000      239.91182
REMARK 350   BIOMT2   2  0.951057  0.309017  0.000000      -37.99830
REMARK 350   BIOMT3   2  0.000000  0.000000  1.000000        0.00000
REMARK 350   BIOMT1   3 -0.809017 -0.587785  0.000000      350.18719
REMARK 350   BIOMT2   3  0.587785 -0.809017  0.000000      178.42929
REMARK 350   BIOMT3   3  0.000000  0.000000  1.000000        0.00000

ATOM     21  N   SER A  10     121.825 143.282  92.198  1.00 49.53           N
ATOM     22  CA  SER A  10     122.763 143.750  91.142  1.00 53.90           C
ATOM     23  C   SER A  10     122.515 145.240  90.852  1.00 44.64           C
ATOM     24  O   SER A  10     123.502 145.971  90.659  1.00 49.23           O
ATOM     25  CB  SER A  10     122.649 142.922  89.891  1.00 54.86           C
ATOM     26  OG  SER A  10     121.430 143.193  89.228  1.00 60.17           O
ATOM     27  N   PHE A  11     121.253 145.670  90.877  1.00 39.99           N
ATOM     28  CA  PHE A  11     120.852 147.084  90.685  1.00 46.43           C
ATOM     29  C   PHE A  11     121.347 147.931  91.873  1.00 53.53           C
ATOM     30  O   PHE A  11     121.866 149.042  91.635  1.00 45.84           O
ATOM     31  CB  PHE A  11     119.339 147.230  90.531  1.00 45.10           C
ATOM     32  CG  PHE A  11     118.884 148.665  90.434  1.00 50.94           C
ATOM     33  CD1 PHE A  11     119.380 149.498  89.437  1.00 58.07           C
ATOM     34  CD2 PHE A  11     118.032 149.212  91.385  1.00 57.16           C
ATOM     35  CE1 PHE A  11     118.988 150.831  89.362  1.00 56.76           C
ATOM     36  CE2 PHE A  11     117.629 150.541  91.299  1.00 59.88           C
ATOM     37  CZ  PHE A  11     118.121 151.352  90.299  1.00 55.92           C
ATOM     38  N   VAL A  12     121.144 147.455  93.110  1.00 43.35           N
ATOM     39  CA  VAL A  12     121.615 148.167  94.333  1.00 40.73           C
ATOM     40  C   VAL A  12     123.143 148.194  94.308  1.00 37.70           C
ATOM     41  O   VAL A  12     123.700 149.281  94.511  1.00 41.01           O
ATOM     42  CB  VAL A  12     121.073 147.560  95.640  1.00 46.83           C
ATOM     43  CG1 VAL A  12     121.686 148.244  96.866  1.00 40.11           C
ATOM     44  CG2 VAL A  12     119.551 147.638  95.701  1.00 41.22           C
ATOM     45  N   LYS A  13     123.785 147.091  93.923  1.00 36.58           N
ATOM     46  CA  LYS A  13     125.268 147.018  93.854  1.00 41.77           C
ATOM     47  C   LYS A  13     125.761 148.054  92.839  1.00 42.08           C
ATOM     48  O   LYS A  13     126.776 148.724  93.128  1.00 38.35           O
ATOM     49  CB  LYS A  13     125.757 145.612  93.490  1.00 46.55           C
ATOM     50  CG  LYS A  13     127.268 145.492  93.315  1.00 46.87           C
ATOM     51  CD  LYS A  13     127.740 144.113  92.898  1.00 58.69           C
ATOM     52  CE  LYS A  13     129.223 144.071  92.578  1.00 64.30           C
ATOM     53  NZ  LYS A  13     130.049 143.879  93.793  1.00 72.87           N
ATOM     54  N   GLU A  14     125.080 148.160  91.694  1.00 42.55           N
ATOM     55  CA  GLU A  14     125.407 149.148  90.630  1.00 47.24           C
ATOM     56  C   GLU A  14     125.269 150.559  91.210  1.00 34.67           C
ATOM     57  O   GLU A  14     126.169 151.376  90.970  1.00 40.45           O
ATOM     58  CB  GLU A  14     124.498 148.982  89.407  1.00 52.19           C
ATOM     59  CG  GLU A  14     125.009 147.963  88.402  1.00 82.30           C
ATOM     60  CD  GLU A  14     124.265 147.939  87.071  1.00104.62           C
"""

def exercise_biomt_only():
  """
  Use-case for phenix.pdb.biomt_reconstruction - we want to expand only using biomt
  """
  inp = iotbx.pdb.input(lines=pdb_lines, source_info=None)
  model = mmtbx.model.manager(
    model_input = inp,
    expand_with_mtrix = False)
  assert model.get_number_of_atoms() == 40, model.get_number_of_atoms()
  model.expand_with_BIOMT_records()
  assert model.get_number_of_atoms() == 120, model.get_number_of_atoms()

def exercise_mtrix_only():
  """
  Use-case for phenix.pdb.mtrix_reconstruction - we want to expand only using mtrix
  """
  inp = iotbx.pdb.input(lines=pdb_lines, source_info=None)
  model = mmtbx.model.manager(
    model_input = inp)
  assert model.get_number_of_atoms() == 120, model.get_number_of_atoms()

  # use-case for phenix.real_space_refine ??? when normally we want to expand by MTRIX first
  # and by BIOMT second, but not in case when BIOMT == MTRIX...
  model.expand_with_BIOMT_records()
  assert model.get_number_of_atoms() == 120, model.get_number_of_atoms()

if (__name__ == "__main__"):
  t0 = time.time()
  exercise_biomt_only()
  exercise_mtrix_only()
  print("Total time: %8.3f"%(time.time() - t0))
  print("OK.")


 *******************************************************************************


 *******************************************************************************
mmtbx/regression/model/tst_model_cart_ref_restraints.py
from __future__ import absolute_import, division, print_function
import mmtbx.model
import libtbx.load_env
from libtbx.utils import format_cpu_times
from libtbx.test_utils import approx_equal
import iotbx.pdb
from six.moves import range

# 1yjp
pdb_str = """\
CRYST1   21.937    4.866   23.477  90.00 107.08  90.00 P 1 21 1      2
ORIGX1      1.000000  0.000000  0.000000        0.00000
ORIGX2      0.000000  1.000000  0.000000        0.00000
ORIGX3      0.000000  0.000000  1.000000        0.00000
SCALE1      0.045585  0.000000  0.014006        0.00000
SCALE2      0.000000  0.205508  0.000000        0.00000
SCALE3      0.000000  0.000000  0.044560        0.00000
ATOM      1  N   GLY A   1      -9.009   4.612   6.102  1.00 16.77           N
ATOM      2  CA  GLY A   1      -9.052   4.207   4.651  1.00 16.57           C
ATOM      3  C   GLY A   1      -8.015   3.140   4.419  1.00 16.16           C
ATOM      4  O   GLY A   1      -7.523   2.521   5.381  1.00 16.78           O
ATOM      5  N   ASN A   2      -7.656   2.923   3.155  1.00 15.02           N
ATOM      6  CA  ASN A   2      -6.522   2.038   2.831  1.00 14.10           C
ATOM      7  C   ASN A   2      -5.241   2.537   3.427  1.00 13.13           C
ATOM      8  O   ASN A   2      -4.978   3.742   3.426  1.00 11.91           O
ATOM      9  CB  ASN A   2      -6.346   1.881   1.341  1.00 15.38           C
ATOM     10  CG  ASN A   2      -7.584   1.342   0.692  1.00 14.08           C
ATOM     11  OD1 ASN A   2      -8.025   0.227   1.016  1.00 17.46           O
ATOM     12  ND2 ASN A   2      -8.204   2.155  -0.169  1.00 11.72           N
ATOM     13  N   ASN A   3      -4.438   1.590   3.905  1.00 12.26           N
ATOM     14  CA  ASN A   3      -3.193   1.904   4.589  1.00 11.74           C
ATOM     15  C   ASN A   3      -1.955   1.332   3.895  1.00 11.10           C
ATOM     16  O   ASN A   3      -1.872   0.119   3.648  1.00 10.42           O
ATOM     17  CB  ASN A   3      -3.259   1.378   6.042  1.00 12.15           C
ATOM     18  CG  ASN A   3      -2.006   1.739   6.861  1.00 12.82           C
ATOM     19  OD1 ASN A   3      -1.702   2.925   7.072  1.00 15.05           O
ATOM     20  ND2 ASN A   3      -1.271   0.715   7.306  1.00 13.48           N
ATOM     21  N   GLN A   4      -1.005   2.228   3.598  1.00 10.29           N
ATOM     22  CA  GLN A   4       0.384   1.888   3.199  1.00 10.53           C
ATOM     23  C   GLN A   4       1.435   2.606   4.088  1.00 10.24           C
ATOM     24  O   GLN A   4       1.547   3.843   4.115  1.00  8.86           O
ATOM     25  CB  GLN A   4       0.656   2.148   1.711  1.00  9.80           C
ATOM     26  CG  GLN A   4       1.944   1.458   1.213  1.00 10.25           C
ATOM     27  CD  GLN A   4       2.504   2.044  -0.089  1.00 12.43           C
ATOM     28  OE1 GLN A   4       2.744   3.268  -0.190  1.00 14.62           O
ATOM     29  NE2 GLN A   4       2.750   1.161  -1.091  1.00  9.05           N
ATOM     30  N   GLN A   5       2.154   1.821   4.871  1.00 10.38           N
ATOM     31  CA  GLN A   5       3.270   2.361   5.640  1.00 11.39           C
ATOM     32  C   GLN A   5       4.594   1.768   5.172  1.00 11.52           C
ATOM     33  O   GLN A   5       4.768   0.546   5.054  1.00 12.05           O
ATOM     34  CB  GLN A   5       3.056   2.183   7.147  1.00 11.96           C
ATOM     35  CG  GLN A   5       1.829   2.950   7.647  1.00 10.81           C
ATOM     36  CD  GLN A   5       1.344   2.414   8.954  1.00 13.10           C
ATOM     37  OE1 GLN A   5       0.774   1.325   9.002  1.00 10.65           O
ATOM     38  NE2 GLN A   5       1.549   3.187  10.039  1.00 12.30           N
ATOM     39  N   ASN A   6       5.514   2.664   4.856  1.00 11.99           N
ATOM     40  CA  ASN A   6       6.831   2.310   4.318  1.00 12.30           C
ATOM     41  C   ASN A   6       7.854   2.761   5.324  1.00 13.40           C
ATOM     42  O   ASN A   6       8.219   3.943   5.374  1.00 13.92           O
ATOM     43  CB  ASN A   6       7.065   3.016   2.993  1.00 12.13           C
ATOM     44  CG  ASN A   6       5.961   2.735   2.003  1.00 12.77           C
ATOM     45  OD1 ASN A   6       5.798   1.604   1.551  1.00 14.27           O
ATOM     46  ND2 ASN A   6       5.195   3.747   1.679  1.00 10.07           N
ATOM     47  N   TYR A   7       8.292   1.817   6.147  1.00 14.70           N
ATOM     48  CA  TYR A   7       9.159   2.144   7.299  1.00 15.18           C
ATOM     49  C   TYR A   7      10.603   2.331   6.885  1.00 15.91           C
ATOM     50  O   TYR A   7      11.041   1.811   5.855  1.00 15.76           O
ATOM     51  CB  TYR A   7       9.061   1.065   8.369  1.00 15.35           C
ATOM     52  CG  TYR A   7       7.665   0.929   8.902  1.00 14.45           C
ATOM     53  CD1 TYR A   7       6.771   0.021   8.327  1.00 15.68           C
ATOM     54  CD2 TYR A   7       7.210   1.756   9.920  1.00 14.80           C
ATOM     55  CE1 TYR A   7       5.480  -0.094   8.796  1.00 13.46           C
ATOM     56  CE2 TYR A   7       5.904   1.649  10.416  1.00 14.33           C
ATOM     57  CZ  TYR A   7       5.047   0.729   9.831  1.00 15.09           C
ATOM     58  OH  TYR A   7       3.766   0.589  10.291  1.00 14.39           O
ATOM     59  OXT TYR A   7      11.358   2.999   7.612  1.00 17.49           O
"""

pdb_str_h = """\
CRYST1   21.937    4.866   23.477  90.00 107.08  90.00 P 1 21 1      2
ORIGX1      1.000000  0.000000  0.000000        0.00000
ORIGX2      0.000000  1.000000  0.000000        0.00000
ORIGX3      0.000000  0.000000  1.000000        0.00000
SCALE1      0.045585  0.000000  0.014006        0.00000
SCALE2      0.000000  0.205508  0.000000        0.00000
SCALE3      0.000000  0.000000  0.044560        0.00000
ATOM      1  N   GLY A   1      -9.009   4.612   6.102  1.00 16.77           N
ATOM      2  CA  GLY A   1      -9.052   4.207   4.651  1.00 16.57           C
ATOM      3  C   GLY A   1      -8.015   3.140   4.419  1.00 16.16           C
ATOM      4  O   GLY A   1      -7.523   2.521   5.381  1.00 16.78           O
ATOM      0  H1  GLY A   1      -9.510   5.337   6.223  1.00 16.77           H   new
ATOM      0  H2  GLY A   1      -9.322   3.948   6.605  1.00 16.77           H   new
ATOM      0  H3  GLY A   1      -8.169   4.790   6.336  1.00 16.77           H   new
ATOM      0  HA2 GLY A   1      -9.934   3.875   4.420  1.00 16.57           H   new
ATOM      0  HA3 GLY A   1      -8.879   4.974   4.082  1.00 16.57           H   new
ATOM      5  N   ASN A   2      -7.656   2.923   3.155  1.00 15.02           N
ATOM      6  CA  ASN A   2      -6.522   2.038   2.831  1.00 14.10           C
ATOM      7  C   ASN A   2      -5.241   2.537   3.427  1.00 13.13           C
ATOM      8  O   ASN A   2      -4.978   3.742   3.426  1.00 11.91           O
ATOM      9  CB  ASN A   2      -6.346   1.881   1.341  1.00 15.38           C
ATOM     10  CG  ASN A   2      -7.584   1.342   0.692  1.00 14.08           C
ATOM     11  OD1 ASN A   2      -8.025   0.227   1.016  1.00 17.46           O
ATOM     12  ND2 ASN A   2      -8.204   2.155  -0.169  1.00 11.72           N
ATOM      0  H   ASN A   2      -8.047   3.272   2.473  1.00 15.02           H   new
ATOM      0  HA  ASN A   2      -6.733   1.174   3.217  1.00 14.10           H   new
ATOM      0  HB2 ASN A   2      -6.122   2.739   0.949  1.00 15.38           H   new
ATOM      0  HB3 ASN A   2      -5.601   1.285   1.164  1.00 15.38           H   new
ATOM      0 HD21 ASN A   2      -8.947   1.914  -0.529  1.00 11.72           H   new
ATOM      0 HD22 ASN A   2      -7.860   2.919  -0.363  1.00 11.72           H   new
ATOM     13  N   ASN A   3      -4.438   1.590   3.905  1.00 12.26           N
ATOM     14  CA  ASN A   3      -3.193   1.904   4.589  1.00 11.74           C
ATOM     15  C   ASN A   3      -1.955   1.332   3.895  1.00 11.10           C
ATOM     16  O   ASN A   3      -1.872   0.119   3.648  1.00 10.42           O
ATOM     17  CB  ASN A   3      -3.259   1.378   6.042  1.00 12.15           C
ATOM     18  CG  ASN A   3      -2.006   1.739   6.861  1.00 12.82           C
ATOM     19  OD1 ASN A   3      -1.702   2.925   7.072  1.00 15.05           O
ATOM     20  ND2 ASN A   3      -1.271   0.715   7.306  1.00 13.48           N
ATOM      0  H   ASN A   3      -4.602   0.748   3.841  1.00 12.26           H   new
ATOM      0  HA  ASN A   3      -3.100   2.869   4.573  1.00 11.74           H   new
ATOM      0  HB2 ASN A   3      -4.044   1.744   6.479  1.00 12.15           H   new
ATOM      0  HB3 ASN A   3      -3.366   0.414   6.029  1.00 12.15           H   new
ATOM      0 HD21 ASN A   3      -0.555   0.864   7.759  1.00 13.48           H   new
ATOM      0 HD22 ASN A   3      -1.514  -0.093   7.140  1.00 13.48           H   new
ATOM     21  N   GLN A   4      -1.005   2.228   3.598  1.00 10.29           N
ATOM     22  CA  GLN A   4       0.384   1.888   3.199  1.00 10.53           C
ATOM     23  C   GLN A   4       1.435   2.606   4.088  1.00 10.24           C
ATOM     24  O   GLN A   4       1.547   3.843   4.115  1.00  8.86           O
ATOM     25  CB  GLN A   4       0.656   2.148   1.711  1.00  9.80           C
ATOM     26  CG  GLN A   4       1.944   1.458   1.213  1.00 10.25           C
ATOM     27  CD  GLN A   4       2.504   2.044  -0.089  1.00 12.43           C
ATOM     28  OE1 GLN A   4       2.744   3.268  -0.190  1.00 14.62           O
ATOM     29  NE2 GLN A   4       2.750   1.161  -1.091  1.00  9.05           N
ATOM      0  H   GLN A   4      -1.149   3.076   3.622  1.00 10.29           H   new
ATOM      0  HA  GLN A   4       0.474   0.933   3.341  1.00 10.53           H   new
ATOM      0  HB2 GLN A   4      -0.098   1.834   1.188  1.00  9.80           H   new
ATOM      0  HB3 GLN A   4       0.726   3.104   1.561  1.00  9.80           H   new
ATOM      0  HG2 GLN A   4       2.622   1.523   1.904  1.00 10.25           H   new
ATOM      0  HG3 GLN A   4       1.763   0.514   1.080  1.00 10.25           H   new
ATOM      0 HE21 GLN A   4       2.571   0.327  -0.983  1.00  9.05           H   new
ATOM      0 HE22 GLN A   4       3.085   1.436  -1.834  1.00  9.05           H   new
ATOM     30  N   GLN A   5       2.154   1.821   4.871  1.00 10.38           N
ATOM     31  CA  GLN A   5       3.270   2.361   5.640  1.00 11.39           C
ATOM     32  C   GLN A   5       4.594   1.768   5.172  1.00 11.52           C
ATOM     33  O   GLN A   5       4.768   0.546   5.054  1.00 12.05           O
ATOM     34  CB  GLN A   5       3.056   2.183   7.147  1.00 11.96           C
ATOM     35  CG  GLN A   5       1.829   2.950   7.647  1.00 10.81           C
ATOM     36  CD  GLN A   5       1.344   2.414   8.954  1.00 13.10           C
ATOM     37  OE1 GLN A   5       0.774   1.325   9.002  1.00 10.65           O
ATOM     38  NE2 GLN A   5       1.549   3.187  10.039  1.00 12.30           N
ATOM      0  H   GLN A   5       2.017   0.978   4.974  1.00 10.38           H   new
ATOM      0  HA  GLN A   5       3.309   3.316   5.477  1.00 11.39           H   new
ATOM      0  HB2 GLN A   5       2.951   1.240   7.349  1.00 11.96           H   new
ATOM      0  HB3 GLN A   5       3.844   2.489   7.623  1.00 11.96           H   new
ATOM      0  HG2 GLN A   5       2.050   3.889   7.743  1.00 10.81           H   new
ATOM      0  HG3 GLN A   5       1.119   2.892   6.989  1.00 10.81           H   new
ATOM      0 HE21 GLN A   5       1.953   3.942   9.959  1.00 12.30           H   new
ATOM      0 HE22 GLN A   5       1.276   2.925  10.811  1.00 12.30           H   new
ATOM     39  N   ASN A   6       5.514   2.664   4.856  1.00 11.99           N
ATOM     40  CA  ASN A   6       6.831   2.310   4.318  1.00 12.30           C
ATOM     41  C   ASN A   6       7.854   2.761   5.324  1.00 13.40           C
ATOM     42  O   ASN A   6       8.219   3.943   5.374  1.00 13.92           O
ATOM     43  CB  ASN A   6       7.065   3.016   2.993  1.00 12.13           C
ATOM     44  CG  ASN A   6       5.961   2.735   2.003  1.00 12.77           C
ATOM     45  OD1 ASN A   6       5.798   1.604   1.551  1.00 14.27           O
ATOM     46  ND2 ASN A   6       5.195   3.747   1.679  1.00 10.07           N
ATOM      0  H   ASN A   6       5.395   3.511   4.947  1.00 11.99           H   new
ATOM      0  HA  ASN A   6       6.892   1.355   4.162  1.00 12.30           H   new
ATOM      0  HB2 ASN A   6       7.129   3.972   3.143  1.00 12.13           H   new
ATOM      0  HB3 ASN A   6       7.914   2.730   2.620  1.00 12.13           H   new
ATOM      0 HD21 ASN A   6       4.545   3.635   1.128  1.00 10.07           H   new
ATOM      0 HD22 ASN A   6       5.342   4.524   2.018  1.00 10.07           H   new
ATOM     47  N   TYR A   7       8.292   1.817   6.147  1.00 14.70           N
ATOM     48  CA  TYR A   7       9.159   2.144   7.299  1.00 15.18           C
ATOM     49  C   TYR A   7      10.603   2.331   6.885  1.00 15.91           C
ATOM     50  O   TYR A   7      11.041   1.811   5.855  1.00 15.76           O
ATOM     51  CB  TYR A   7       9.061   1.065   8.369  1.00 15.35           C
ATOM     52  CG  TYR A   7       7.665   0.929   8.902  1.00 14.45           C
ATOM     53  CD1 TYR A   7       6.771   0.021   8.327  1.00 15.68           C
ATOM     54  CD2 TYR A   7       7.210   1.756   9.920  1.00 14.80           C
ATOM     55  CE1 TYR A   7       5.480  -0.094   8.796  1.00 13.46           C
ATOM     56  CE2 TYR A   7       5.904   1.649  10.416  1.00 14.33           C
ATOM     57  CZ  TYR A   7       5.047   0.729   9.831  1.00 15.09           C
ATOM     58  OH  TYR A   7       3.766   0.589  10.291  1.00 14.39           O
ATOM     59  OXT TYR A   7      11.358   2.999   7.612  1.00 17.49           O
ATOM      0  H   TYR A   7       8.106   0.981   6.066  1.00 14.70           H   new
ATOM      0  HA  TYR A   7       8.843   2.985   7.664  1.00 15.18           H   new
ATOM      0  HB2 TYR A   7       9.349   0.216   7.999  1.00 15.35           H   new
ATOM      0  HB3 TYR A   7       9.666   1.277   9.097  1.00 15.35           H   new
ATOM      0  HD1 TYR A   7       7.051  -0.513   7.619  1.00 15.68           H   new
ATOM      0  HD2 TYR A   7       7.783   2.394  10.280  1.00 14.80           H   new
ATOM      0  HE1 TYR A   7       4.901  -0.719   8.422  1.00 13.46           H   new
ATOM      0  HE2 TYR A   7       5.618   2.183  11.122  1.00 14.33           H   new
ATOM      0  HH  TYR A   7       3.629   1.138  10.911  1.00 14.39           H   new
"""

pdb_str_base = """\
CRYST1   21.937    4.866   23.477  90.00 107.08  90.00 P 1 21 1      2
ORIGX1      1.000000  0.000000  0.000000        0.00000
ORIGX2      0.000000  1.000000  0.000000        0.00000
ORIGX3      0.000000  0.000000  1.000000        0.00000
SCALE1      0.045585  0.000000  0.014006        0.00000
SCALE2      0.000000  0.205508  0.000000        0.00000
SCALE3      0.000000  0.000000  0.044560        0.00000
ATOM      1  N   GLY A   1      -9.009   4.612   6.102  1.00 16.77           N
ATOM      2  CA  GLY A   1      -9.052   4.207   4.651  1.00 16.57           C
ATOM      3  C   GLY A   1      -8.015   3.140   4.419  1.00 16.16           C
ATOM      4  O   GLY A   1      -7.523   2.521   5.381  1.00 16.78           O
ATOM      5  N   ASN A   2      -7.656   2.923   3.155  1.00 15.02           N
ATOM      6  CA  ASN A   2      -6.522   2.038   2.831  1.00 14.10           C
ATOM      7  C   ASN A   2      -5.241   2.537   3.427  1.00 13.13           C
ATOM      8  O   ASN A   2      -4.978   3.742   3.426  1.00 11.91           O
ATOM      9  CB  ASN A   2      -6.346   1.881   1.341  1.00 15.38           C
ATOM     10  CG  ASN A   2      -7.584   1.342   0.692  1.00 14.08           C
ATOM     11  OD1 ASN A   2      -8.025   0.227   1.016  1.00 17.46           O
ATOM     12  ND2 ASN A   2      -8.204   2.155  -0.169  1.00 11.72           N
ATOM     13  N   ASN A   3      -4.438   1.590   3.905  1.00 12.26           N
ATOM     14  CA  ASN A   3      -3.193   1.904   4.589  1.00 11.74           C
ATOM     15  C   ASN A   3      -1.955   1.332   3.895  1.00 11.10           C
ATOM     16  O   ASN A   3      -1.872   0.119   3.648  1.00 10.42           O
ATOM     17  CB  ASN A   3      -3.259   1.378   6.042  1.00 12.15           C
ATOM     18  CG  ASN A   3      -2.006   1.739   6.861  1.00 12.82           C
ATOM     19  OD1 ASN A   3      -1.702   2.925   7.072  1.00 15.05           O
ATOM     20  ND2 ASN A   3      -1.271   0.715   7.306  1.00 13.48           N
"""

pdb_str_water = """\
HETATM   61  O   HOH A   8      -6.471   5.227   7.124  1.00 22.62           O
HETATM   62  O   HOH A   9      10.431   1.858   3.216  1.00 19.71           O
HETATM   63  O   HOH A  10     -11.286   1.756  -1.468  1.00 17.08           O
HETATM   64  O   HOH A  11      11.808   4.179   9.970  1.00 23.99           O
HETATM   65  O   HOH A  12      13.605   1.327   9.198  1.00 26.17           O
"""

def exercise_adopting_coord_restraints():
  inp_1 = iotbx.pdb.input(lines=pdb_str_h, source_info=None)
  h_model = mmtbx.model.manager(model_input = inp_1)
  h_model.process(make_restraints=True)

  inp_2 = iotbx.pdb.input(lines=pdb_str, source_info=None)
  model = mmtbx.model.manager(model_input = inp_2)
  model.process(make_restraints=True)

  # case 1: big model adopting small model.
  h_model.set_reference_coordinate_restraints(ref_model = model)
  # print h_model.restraints_as_geo()
  rcp = h_model.get_restraints_manager().geometry.reference_coordinate_proxies
  assert len(rcp) == 59
  # Note iseqs, hydrogens are skipped
  answer = [ [(0,) , (-9.009, 4.612, 6.102), 25.0],
             [(1,) , (-9.052, 4.207, 4.651), 25.0],
             [(2,) , (-8.015, 3.14,  4.419), 25.0],
             [(3,) , (-7.523, 2.521, 5.381), 25.0],
             [(9,) , (-7.656, 2.923, 3.155), 25.0],
             [(10,), (-6.522, 2.038, 2.831), 25.0]]
  # for p in rcp:
  #   print p.i_seqs, p.ref_sites, p.weight

  for i in range(6):
    assert rcp[i].i_seqs == answer[i][0], "%s %s" % (rcp[i].i_seqs, answer[i][0])
    assert approx_equal(rcp[i].ref_sites, answer[i][1])
    assert approx_equal(rcp[i].weight, answer[i][2]), "%s, %s" % (rcp[i].weight, answer[i][2])

  # case 2: small model adopting big model.
  model.set_reference_coordinate_restraints(ref_model=h_model)
  rcp = model.get_restraints_manager().geometry.reference_coordinate_proxies
  assert len(rcp) == 59
  # Note iseqs, hydrogens are skipped
  answer = [ [(0,), (-9.009, 4.612, 6.102), 25.0],
             [(1,), (-9.052, 4.207, 4.651), 25.0],
             [(2,), (-8.015, 3.14,  4.419), 25.0],
             [(3,), (-7.523, 2.521, 5.381), 25.0],
             [(4,), (-7.656, 2.923, 3.155), 25.0],
             [(5,),  (-6.522, 2.038, 2.831), 25.0]]
  for i in range(6):
    assert rcp[i].i_seqs == answer[i][0]
    assert approx_equal(rcp[i].ref_sites, answer[i][1])
    assert approx_equal(rcp[i].weight, answer[i][2]), "%s, %s" % (rcp[i].weight, answer[i][2])

def exercise_adopting_coord_restraints_water():
  inp_1 = iotbx.pdb.input(lines=pdb_str_base, source_info=None)
  nowat_model = mmtbx.model.manager(model_input = inp_1)
  nowat_model.process(make_restraints=True)
  # Changing coordinates a little to make sure right ones are used for
  # reference restraints
  for a in nowat_model.get_hierarchy().atoms():
    a.xyz = (a.xyz[0]+1, a.xyz[1], a.xyz[2])
  nowat_model.set_sites_cart_from_hierarchy()

  inp_2 = iotbx.pdb.input(lines=pdb_str_base+pdb_str_water, source_info=None)
  wat_model = mmtbx.model.manager(model_input = inp_2)
  wat_model.process(make_restraints=True)
  nowat_model.set_reference_coordinate_restraints(
      ref_model = wat_model)
  rcp = nowat_model.get_restraints_manager().geometry.reference_coordinate_proxies
  assert len(rcp) == 20, len(rcp)
  answer = [[(0,) , (-9.009, 4.612, 6.102), 25.0],
            [(1,) , (-9.052, 4.207, 4.651), 25.0],
            [(2,) , (-8.015, 3.14,  4.419), 25.0],
            [(3,) , (-7.523, 2.521, 5.381), 25.0],
            [(4,) , (-7.656, 2.923, 3.155), 25.0],
            [(5,) , (-6.522, 2.038, 2.831), 25.0],
            [(6,) , (-5.241, 2.537, 3.427), 25.0],
            [(7,) , (-4.978, 3.742, 3.426), 25.0],
            [(8,) , (-6.346, 1.881, 1.341), 25.0],
            [(9,) , (-7.584, 1.342, 0.692), 25.0],
            [(10,), (-8.025, 0.227, 1.016), 25.0],
            [(11,), (-8.204, 2.155, -0.169), 25.0],
            [(12,), (-4.438, 1.59,  3.905), 25.0],
            [(13,), (-3.193, 1.904, 4.589), 25.0],
            [(14,), (-1.955, 1.332, 3.895), 25.0],
            [(15,), (-1.872, 0.119, 3.648), 25.0],
            [(16,), (-3.259, 1.378, 6.042), 25.0],
            [(17,), (-2.006, 1.739, 6.861), 25.0],
            [(18,), (-1.702, 2.925, 7.072), 25.0],
            [(19,), (-1.271, 0.715, 7.306), 25.0]]
  for i in range(20):
    assert rcp[i].i_seqs == answer[i][0]
    assert approx_equal(rcp[i].ref_sites, answer[i][1])
    assert approx_equal(rcp[i].weight, answer[i][2]), "%s, %s" % (rcp[i].weight, answer[i][2])

  # print nowat_model.model_as_pdb()
  wat_model.set_reference_coordinate_restraints(ref_model=nowat_model)
  rcp = wat_model.get_restraints_manager().geometry.reference_coordinate_proxies
  assert len(rcp) == 20, len(rcp)
  # Note different x coord here
  answer = [[(0,) , (-8.009, 4.612, 6.102), 25.0],
            [(1,) , (-8.052, 4.207, 4.651), 25.0],
            [(2,) , (-7.015, 3.14,  4.419), 25.0],
            [(3,) , (-6.523, 2.521, 5.381), 25.0],
            [(4,) , (-6.656, 2.923, 3.155), 25.0],
            [(5,) , (-5.522, 2.038, 2.831), 25.0],
            [(6,) , (-4.241, 2.537, 3.427), 25.0],
            [(7,) , (-3.978, 3.742, 3.426), 25.0],
            [(8,) , (-5.346, 1.881, 1.341), 25.0],
            [(9,) , (-6.584, 1.342, 0.692), 25.0],
            [(10,), (-7.025, 0.227, 1.016), 25.0],
            [(11,), (-7.204, 2.155, -0.169), 25.0],
            [(12,), (-3.438, 1.59,  3.905), 25.0],
            [(13,), (-2.193, 1.904, 4.589), 25.0],
            [(14,), (-0.955, 1.332, 3.895), 25.0],
            [(15,), (-0.872, 0.119, 3.648), 25.0],
            [(16,), (-2.259, 1.378, 6.042), 25.0],
            [(17,), (-1.006, 1.739, 6.861), 25.0],
            [(18,), (-0.702, 2.925, 7.072), 25.0],
            [(19,), (-0.271, 0.715, 7.306), 25.0]]
  for i in range(20):
    assert rcp[i].i_seqs == answer[i][0]
    assert approx_equal(rcp[i].ref_sites, answer[i][1])
    assert approx_equal(rcp[i].weight, answer[i][2]), "%s, %s" % (rcp[i].weight, answer[i][2])
  # for p in rcp:
  #   print p.i_seqs, p.ref_sites, p.weight

def run():
  if (not libtbx.env.has_module("reduce")):
    print("Reduce not installed.")
    return
  exercise_adopting_coord_restraints()
  exercise_adopting_coord_restraints_water()

  print(format_cpu_times())

if (__name__ == "__main__"):
  run()


 *******************************************************************************


 *******************************************************************************
mmtbx/regression/model/tst_model_dedeuterate.py
from __future__ import absolute_import, division, print_function
import time, sys, os
from six.moves import cStringIO as StringIO
import libtbx.load_env
import mmtbx.model
import iotbx.pdb
from mmtbx.monomer_library import pdb_interpretation

def run():
  verbose = "--verbose" in sys.argv[1:]
  exercise_00(verbose=verbose)
  exercise_01(verbose=verbose)
  exercise_02(verbose=verbose)
  exercise_03(verbose=verbose)
  exercise_04(verbose=verbose)
  exercise_05(verbose=verbose)

def get_model(file_name, log, pdb_str=None):
  pdb_interpretation_params = iotbx.phil.parse(
          input_string=pdb_interpretation.grand_master_phil_str, process_includes=True).extract()
  pdb_interpretation_params.pdb_interpretation.sort_atoms=False
  if not pdb_str:
    pdb_inp = iotbx.pdb.input(file_name=file_name)
  else:
    pdb_inp = iotbx.pdb.input(lines=pdb_str, source_info=None)
  model = mmtbx.model.manager(
      model_input = pdb_inp,
      stop_for_unknowns = False,
      log=log)
  model.process(pdb_interpretation_params=pdb_interpretation_params)
  return model

def exercise_00(verbose):
  if (verbose): log = sys.stdout
  else: log = StringIO()
  pdb_file = libtbx.env.find_in_repositories(
    relative_path="phenix_regression/pdb/occ_mix1.pdb",
    test=os.path.isfile)
  model = get_model(pdb_file, log)
  model.de_deuterate()
  assert(len(model.hd_group_selections())==0)
  ph = model.get_hierarchy()
  atoms = ph.atoms()
  assert(atoms.extract_element().count('D') == 0)
  assert(model.get_hd_selection().count(True) == 14)
  atom_names = [x.strip() for x in atoms.extract_name()]
  assert ('DA' not in atom_names)

def exercise_01(verbose):
  if (verbose): log = sys.stdout
  else: log = StringIO()
  pdb_file = libtbx.env.find_in_repositories(
    relative_path="phenix_regression/pdb/ala_hd.pdb",
    test=os.path.isfile)
  model = get_model(pdb_file, log)
  model.de_deuterate()
  assert(len(model.hd_group_selections())==0)
  ph = model.get_hierarchy()
  atoms = ph.atoms()
  assert(atoms.extract_element().count('D') == 0)
  assert(model.get_hd_selection().count(True) == 7)

def exercise_02(verbose):
  if (verbose): log = sys.stdout
  else: log = StringIO()
  pdb_file = libtbx.env.find_in_repositories(
    relative_path="phenix_regression/pdb/ala_lys_arg_ser_tyr_neutron_hd.pdb",
    test=os.path.isfile)
  model = get_model(pdb_file, log)
  model.de_deuterate()
  assert(len(model.hd_group_selections())==0)
  ph = model.get_hierarchy()
  atoms = ph.atoms()
  assert(atoms.extract_element().count('D') == 0)
  assert(model.get_hd_selection().count(True) == 47)

def exercise_03(verbose):
  if (verbose): log = sys.stdout
  else: log = StringIO()
  pdb_file = libtbx.env.find_in_repositories(
    relative_path="phenix_regression/pdb/NAD_594_HD.pdb",
    test=os.path.isfile)
  model = get_model(pdb_file, log)
  model.de_deuterate()
  assert(len(model.hd_group_selections())==0)
  ph = model.get_hierarchy()
  atoms = ph.atoms()
  assert(atoms.extract_element().count('D') == 0)
  assert(model.get_hd_selection().count(True) == 43)

def exercise_04(verbose):
  if (verbose): log = sys.stdout
  else: log = StringIO()
  model = get_model(file_name=None, log = log, pdb_str = pdb_str_1)
  model.de_deuterate()
  assert(len(model.hd_group_selections())==0)
  ph = model.get_hierarchy()
  atoms = ph.atoms()
  assert(atoms.extract_element().count('D') == 0)
  assert(model.get_hd_selection().count(True) == 15)
  atom_names = [x.strip() for x in atoms.extract_name()]
  assert ('D' not in atom_names)
  assert ('DG' not in atom_names)

def exercise_05(verbose):
  if (verbose): log = sys.stdout
  else: log = StringIO()
  model = get_model(file_name=None, log = log, pdb_str = pdb_str_2)
  #model.get_hierarchy().write_pdb_file(file_name="haha.pdb")
  model.de_deuterate()
  assert(len(model.hd_group_selections())==0)
  ph = model.get_hierarchy()
  atoms = ph.atoms()
  assert(atoms.extract_element().count('D') == 0)
  #print(model.get_hd_selection().count(True))
  assert(model.get_hd_selection().count(True) == 44)
  assert(model.selection('resname DOD').count(True) == 0)
  #ph.write_pdb_file(file_name="test.pdb")

pdb_str_1 = '''
CRYST1   43.705   48.284   96.292  90.00  90.00  90.00 P 1
SCALE1      0.022881  0.000000  0.000000        0.00000
SCALE2      0.000000  0.020711  0.000000        0.00000
SCALE3      0.000000  0.000000  0.010385        0.00000
ATOM     65  N   SER A   4       9.243 -32.509 -36.471  1.00 38.02           N
ATOM     66  CA  SER A   4      10.063 -33.604 -36.981  1.00 39.55           C
ATOM     67  C   SER A   4      11.459 -33.153 -37.367  1.00 37.45           C
ATOM     68  O   SER A   4      11.633 -32.304 -38.239  1.00 38.82           O
ATOM     69  CB  SER A   4       9.384 -34.279 -38.180  1.00 41.66           C
ATOM     70  OG  SER A   4       8.375 -35.181 -37.753  1.00 44.91           O
ATOM     71  DA  SER A   4      10.165 -34.324 -36.187  1.00 38.72           D
ATOM     72  D  ASER A   4       8.730 -31.950 -37.103  0.62 38.48           D
ATOM     73  DB2ASER A   4      10.116 -34.818 -38.774  0.63 41.36           D
ATOM     74  DB3ASER A   4       8.918 -33.518 -38.793  0.36 41.73           D
ATOM     75  DG ASER A   4       8.699 -36.084 -37.842  0.36 43.61           D
ATOM     76  H  BSER A   4       8.730 -31.950 -37.103  0.28 38.48           H
ATOM     77  HB2BSER A   4       8.918 -33.518 -38.793  0.64 41.73           H
ATOM     78  HB3BSER A   4      10.116 -34.818 -38.774  0.37 41.36           H
ATOM     79  HG BSER A   4       8.699 -36.084 -37.842  0.64 43.61           H
ATOM     80  N   SER A   5      26.478 -19.398  45.776  1.00 19.78           N
ATOM     81  C   SER A   5      27.940 -19.562  43.818  1.00 21.99           C
ATOM     82  O   SER A   5      29.005 -19.770  43.306  1.00 21.20           O
ATOM     83  CA ASER A   5      27.849 -19.441  45.318  0.64 18.99           C
ATOM     84  CB ASER A   5      28.611 -20.590  45.987  0.64 21.66           C
ATOM     85  OG ASER A   5      28.819 -20.337  47.363  0.64 23.21           O
ATOM     86  DG ASER A   5      29.639 -20.155  47.499  0.64 22.10           D
ATOM     87  H  ASER A   5      26.064 -20.150  45.742  0.06 18.55           H
ATOM     88  HA ASER A   5      28.296 -18.610  45.561  0.64 20.89           H
ATOM     89  HB2ASER A   5      28.094 -21.408  45.903  0.00 22.17           H
ATOM     90  HB3ASER A   5      29.468 -20.686  45.544  0.64 22.38           H
ATOM     91  CA BSER A   5      27.851 -19.476  45.322  0.36 19.02           C
ATOM     92  CB BSER A   5      28.561 -20.680  45.932  0.36 21.98           C
ATOM     93  OG BSER A   5      28.005 -21.879  45.425  0.36 25.40           O
ATOM     94  D  BSER A   5      26.023 -20.128  45.688  0.94 18.55           D
ATOM     95  HA BSER A   5      28.327 -18.675  45.599  0.36 21.03           H
ATOM     96  HB2BSER A   5      29.498 -20.638  45.691  0.36 22.55           H
ATOM     97  HB3BSER A   5      28.462 -20.665  46.898  0.36 23.83           H
ATOM     98  HG BSER A   5      27.486 -22.196  46.000  0.36 22.10           H
TER
'''

pdb_str_2 = '''
CRYST1   43.705   48.284   96.292  90.00  90.00  90.00 P 1
SCALE1      0.022881  0.000000  0.000000        0.00000
SCALE2      0.000000  0.020711  0.000000        0.00000
SCALE3      0.000000  0.000000  0.010385        0.00000
ATOM      1  N   ASN A   1      25.174 -24.761 -21.940  1.00 16.59           N
ATOM      2  CA  ASN A   1      25.971 -25.578 -22.850  1.00 17.25           C
ATOM      3  C   ASN A   1      26.037 -24.941 -24.225  1.00 16.66           C
ATOM      4  O   ASN A   1      27.077 -24.979 -24.874  1.00 18.42           O
ATOM      5  CB  ASN A   1      25.498 -27.040 -22.913  1.00 18.30           C
ATOM      6  CG  ASN A   1      24.187 -27.208 -23.672  1.00 20.42           C
ATOM      7  OD1 ASN A   1      23.167 -26.590 -23.335  1.00 20.87           O
ATOM      8  ND2 ASN A   1      24.200 -28.069 -24.685  1.00 18.15           N
ATOM      9  DA  ASN A   1      26.975 -25.581 -22.461  1.00 15.99           D
ATOM     10 DD21 ASN A   1      25.030 -28.545 -24.882  1.00 16.07           D
ATOM     11  D  AASN A   1      24.379 -25.105 -21.517  0.82 16.71           D
ATOM     12  DB2AASN A   1      25.358 -27.400 -21.898  0.65 18.82           D
ATOM     13  DB3AASN A   1      26.255 -27.641 -23.402  0.56 18.30           D
ATOM     14 DD22AASN A   1      23.370 -28.163 -25.192  0.72 16.98           D
ATOM     15  H  BASN A   1      24.379 -25.105 -21.517  0.18 16.71           H
ATOM     16  HB2BASN A   1      26.255 -27.641 -23.402  0.44 18.30           H
ATOM     17  HB3BASN A   1      25.358 -27.400 -21.898  0.35 18.82           H
ATOM     18 HD22BASN A   1      23.370 -28.163 -25.192  0.28 16.98           H
ATOM     19  N   ASN A   2      23.615 -22.281 -25.492  1.00 16.59           N
ATOM     20  CA  ASN A   2      24.412 -23.098 -26.402  1.00 17.25           C
ATOM     21  C   ASN A   2      24.478 -22.461 -27.777  1.00 16.66           C
ATOM     22  O   ASN A   2      25.518 -22.499 -28.426  1.00 18.42           O
ATOM     23  CB  ASN A   2      23.939 -24.560 -26.465  1.00 18.30           C
ATOM     24  CG  ASN A   2      22.628 -24.728 -27.224  1.00 20.42           C
ATOM     25  OD1 ASN A   2      21.608 -24.110 -26.887  1.00 20.87           O
ATOM     26  ND2 ASN A   2      22.641 -25.589 -28.237  1.00 18.15           N
ATOM     27  DA  ASN A   2      25.416 -23.101 -26.013  1.00 15.99           D
ATOM     28 HD21 ASN A   2      23.471 -26.065 -28.434  1.00 16.07           H
ATOM     29  D  AASN A   2      22.820 -22.625 -25.069  0.82 16.71           D
ATOM     30  DB2AASN A   2      23.799 -24.920 -25.450  0.65 18.82           D
ATOM     31  DB3AASN A   2      24.696 -25.161 -26.954  0.56 18.30           D
ATOM     32 DD22AASN A   2      21.811 -25.683 -28.744  0.72 16.98           D
ATOM     33  H  BASN A   2      22.820 -22.625 -25.069  0.18 16.71           H
ATOM     34  HB2BASN A   2      24.696 -25.161 -26.954  0.44 18.30           H
ATOM     35  HB3BASN A   2      23.799 -24.920 -25.450  0.35 18.82           H
ATOM     36 HD22BASN A   2      21.811 -25.683 -28.744  0.28 16.98           H
ATOM     37  N   LEU A   3      23.374 -21.865 -28.222  1.00 15.90           N
ATOM     38  CA  LEU A   3      23.342 -21.224 -29.530  1.00 15.47           C
ATOM     39  C   LEU A   3      23.637 -19.727 -29.491  1.00 18.18           C
ATOM     40  O   LEU A   3      24.174 -19.175 -30.462  1.00 20.24           O
ATOM     41  CB  LEU A   3      22.021 -21.521 -30.238  1.00 15.76           C
ATOM     42  CG  LEU A   3      21.790 -23.005 -30.533  1.00 19.30           C
ATOM     43  CD1 LEU A   3      20.460 -23.197 -31.290  1.00 20.74           C
ATOM     44  CD2 LEU A   3      22.957 -23.627 -31.336  1.00 17.02           C
ATOM     45  DA  LEU A   3      24.132 -21.653 -30.101  1.00 12.76           D
ATOM     46  DB3 LEU A   3      21.233 -21.196 -29.610  1.00 17.93           D
ATOM     47  D  ALEU A   3      22.567 -21.865 -27.663  0.91 16.63           D
ATOM     48  DB2ALEU A   3      21.964 -20.976 -31.155  0.67 16.51           D
ATOM     49  DG ALEU A   3      21.719 -23.530 -29.581  0.68 18.31           D
ATOM     50 DD11ALEU A   3      19.620 -22.925 -30.652  0.74 20.52           D
ATOM     51 DD12ALEU A   3      20.364 -24.239 -31.597  0.77 19.78           D
ATOM     52 DD13ALEU A   3      20.458 -22.568 -32.171  0.49 20.26           D
ATOM     53 DD21ALEU A   3      23.466 -22.855 -31.890  0.40 16.87           D
ATOM     54 DD22ALEU A   3      22.563 -24.357 -32.028  0.00 16.68           D
ATOM     55 DD23ALEU A   3      23.653 -24.109 -30.673  0.89 14.39           D
ATOM     56  H  BLEU A   3      22.567 -21.865 -27.663  0.09 16.63           H
ATOM     57  HB2BLEU A   3      21.964 -20.976 -31.155  0.33 14.51           H
ATOM     58  HG BLEU A   3      21.719 -23.530 -29.581  0.32 18.31           H
ATOM     59 HD11BLEU A   3      19.620 -22.925 -30.652  0.26 20.52           H
ATOM     60 HD12BLEU A   3      20.364 -24.239 -31.597  0.23 19.78           H
ATOM     61 HD13BLEU A   3      20.458 -22.568 -32.171  0.51 20.26           H
ATOM     62 HD21BLEU A   3      23.466 -22.855 -31.890  0.60 16.87           H
ATOM     63 HD22BLEU A   3      22.563 -24.357 -32.028  0.58 16.68           H
ATOM     64 HD23BLEU A   3      23.653 -24.109 -30.673  0.11 14.39           H
TER
HETATM  100  O   DOD B   1      25.202 -21.329 -23.306  1.00 30.00           O
HETATM  101  D1  DOD B   1      25.963 -20.763 -23.255  1.00 30.00           D
HETATM  102  D2  DOD B   1      24.439 -20.764 -23.305  1.00 30.00           D
HETATM  103  O   HOH B   2      26.442 -21.454 -25.349  1.00 30.00           O
HETATM  104  D1  HOH B   2      27.249 -20.953 -25.339  1.00 30.00           D
HETATM  105  O   HOH B   3      24.970 -18.184 -24.460  1.00 30.00           O
HETATM  106  O   HOH B   4      21.573 -23.174 -24.023  1.00 30.00           O
HETATM  107  D2  HOH B   4      20.731 -22.736 -24.071  1.00 30.00           D
HETATM  108  D1 AHOH B   4      22.045 -22.784 -23.297  1.00 30.00           D
HETATM  109  D1 BHOH B   4      22.145 -21.784 -22.297  1.00 30.00           D
HETATM  110  D1  HOH B   5      21.772 -27.767 -28.880  1.00 30.00           D
HETATM  111  O   DOD B   6      17.493 -24.723 -25.229  1.00 20.00           O
HETATM  112  D1  DOD B   6      17.492 -25.660 -25.470  1.00 20.00           D
HETATM  113  D2  DOD B   6      18.304 -24.255 -25.470  1.00 20.00           D
TER     114      HOH B   6
HETATM    1  PG  ATP C   1       3.232  -0.948  -8.256  1.00 20.00      A    P
HETATM    2  O1G ATP C   1       4.490  -0.168  -7.985  1.00 20.00      A    O
HETATM    3  O2G ATP C   1       2.572  -0.420  -9.500  1.00 20.00      A    O
HETATM    4  O3G ATP C   1       3.573  -2.392  -8.447  1.00 20.00      A    O
HETATM    5  PB  ATP C   1       2.368   0.364  -5.856  1.00 20.00      A    P
HETATM    6  O1B ATP C   1       3.702   0.219  -5.162  1.00 20.00      A    O
HETATM    7  O2B ATP C   1       2.287   1.719  -6.506  1.00 20.00      A    O
HETATM    8  O3B ATP C   1       2.218  -0.793  -6.996  1.00 20.00      A    O
HETATM    9  PA  ATP C   1       0.926   1.250  -3.494  1.00 20.00      A    P
HETATM   10  O1A ATP C   1      -0.200   2.200  -3.825  1.00 20.00      A    O
HETATM   11  O2A ATP C   1       2.197   2.037  -3.253  1.00 20.00      A    O
HETATM   12  O3A ATP C   1       1.155   0.210  -4.753  1.00 20.00      A    O
HETATM   13  O5' ATP C   1       0.538   0.381  -2.115  1.00 20.00      A    O
HETATM   14  C5' ATP C   1      -0.378   0.948  -1.194  1.00 20.00      A    C
HETATM   15  C4' ATP C   1      -1.094  -0.162  -0.442  1.00 20.00      A    C
HETATM   16  O4' ATP C   1      -0.263  -0.783   0.344  1.00 20.00      A    O
HETATM   17  C3' ATP C   1      -2.258   0.478   0.549  1.00 20.00      A    C
HETATM   18  O3' ATP C   1      -3.508   0.701  -0.219  1.00 20.00      A    O
HETATM   19  C2' ATP C   1      -2.450  -0.373   1.436  1.00 20.00      A    C
HETATM   20  O2' ATP C   1      -3.564  -1.296   1.031  1.00 20.00      A    O
HETATM   21  C1' ATP C   1      -1.075  -1.183   1.553  1.00 20.00      A    C
HETATM   22  N9  ATP C   1      -0.436  -0.847   2.669  1.00 20.00      A    N
HETATM   23  C8  ATP C   1       0.891  -0.729   2.488  1.00 20.00      A    C
HETATM   24  N7  ATP C   1       1.445  -0.426   3.672  1.00 20.00      A    N
HETATM   25  C5  ATP C   1       0.455  -0.356   4.593  1.00 20.00      A    C
HETATM   26  C6  ATP C   1       0.464  -0.066   5.953  1.00 20.00      A    C
HETATM   27  N6  ATP C   1       1.576   0.468   6.779  1.00 20.00      A    N
HETATM   28  N1  ATP C   1      -0.678  -0.046   6.637  1.00 20.00      A    N
HETATM   29  C2  ATP C   1      -1.855  -0.311   6.004  1.00 20.00      A    C
HETATM   30  N3  ATP C   1      -1.865  -0.595   4.675  1.00 20.00      A    N
HETATM   31  C4  ATP C   1      -0.703  -0.615   3.975  1.00 20.00      A    C
HETATM   32 H5'1 ATP C   1       0.163   1.581  -0.485  1.00 20.00      A    H
HETATM   33 H5'2 ATP C   1      -1.105   1.545  -1.731  1.00 20.00      A    H
HETATM   34  H4' ATP C   1      -1.548  -0.870  -1.145  1.00 20.00      A    H
HETATM   35  H3' ATP C   1      -1.912   1.393   0.983  1.00 20.00      A    H
HETATM   36 HO3' ATP C   1      -3.892   1.548   0.031  1.00 20.00      A    H
HETATM   37  H2' ATP C   1      -2.680   0.114   2.384  1.00 20.00      A    H
HETATM   38 HO2' ATP C   1      -4.066  -1.553   1.810  1.00 20.00      A    H
HETATM   39  H1' ATP C   1      -1.273  -2.266   1.534  1.00 20.00      A    H
HETATM   40  H8  ATP C   1       1.431  -0.922   1.560  1.00 20.00      A    H
HETATM   41 HN61 ATP C   1       2.477   0.646   6.359  1.00 20.00      A    H
HETATM   42 HN62 ATP C   1       1.445   0.610   7.769  1.00 20.00      A    H
HETATM   43  H2  ATP C   1      -2.804  -0.294   6.573  1.00 20.00      A    H
TER
END
'''

if (__name__ == "__main__"):
  t0 = time.time()
  run()
  print("OK. Time: %8.3f"%(time.time()-t0))


 *******************************************************************************


 *******************************************************************************
mmtbx/regression/model/tst_model_get_vdw_radii.py
from __future__ import absolute_import, division, print_function
import iotbx.pdb
import mmtbx.utils
import mmtbx.model
from libtbx.utils import null_out

pdb = """
CRYST1   31.000   18.000   43.000  90.00  90.00  90.00 P 2 21 21
HETATM    1  C24 8ZB C   1     -11.000  13.211  10.894  1.00 30.00           C
HETATM    2  C28 8ZB C   1     -11.000  11.722  10.295  1.00 30.00           C
HETATM    3  C31 8ZB C   1     -10.000  11.074  10.706  1.00 30.00           C
HETATM    4  C36 8ZB C   1     -10.000  19.626  10.001  1.00 30.00           C
HETATM    5  C38 8ZB C   1      -8.000  18.259  10.474  1.00 30.00           C
HETATM    6  C39 8ZB C   1      -8.000  18.457  10.949  1.00 30.00           C
HETATM    7  C40 8ZB C   1      -9.000  19.327  10.279  1.00 30.00           C
HETATM    8  C49 8ZB C   1      -6.000  19.546  10.455  1.00 30.00           C
HETATM    9  C50 8ZB C   1      -6.000  18.069  10.155  1.00 30.00           C
HETATM   10  C51 8ZB C   1      -7.000  17.489  10.934  1.00 30.00           C
HETATM   11  C53 8ZB C   1      -6.000  15.539  10.000  1.00 30.00           C
HETATM   12  C55 8ZB C   1      -5.000  17.242  10.321  1.00 30.00           C
HETATM   13  N47 8ZB C   1      -7.000  18.437  10.617  1.00 30.00           N
HETATM   14  N48 8ZB C   1      -5.000  19.513  10.551  1.00 30.00           N
HETATM   15  N52 8ZB C   1      -7.000  16.248  10.879  1.00 30.00           N
HETATM   16  N54 8ZB C   1      -5.000  15.993  10.237  1.00 30.00           N
HETATM   17  N57 8ZB C   1      -4.000  17.770  10.517  1.00 30.00           N
HETATM   18  O37 8ZB C   1      -9.000  19.010  10.951  1.00 30.00           O
HETATM   19  O41 8ZB C   1      -7.000  18.355  10.894  1.00 30.00           O
HETATM   20  O42 8ZB C   1     -10.000  18.384  10.923  1.00 30.00           O
TER
END
"""

cif = """
data_comp_list
#
#
#
#
#
loop_
_chem_comp.id
_chem_comp.three_letter_code
_chem_comp.name
_chem_comp.group
_chem_comp.number_atoms_all
_chem_comp.number_atoms_nh
_chem_comp.desc_level
8ZB 8ZB
'_2__R_,3__R_,4__S_,5__R__-2-_6-aminopurin-9-yl_-5-propyl-oxolane-3,4-diol'
non-polymer 37 20 .
data_comp_8ZB
loop_
_chem_comp_atom.comp_id
_chem_comp_atom.atom_id
_chem_comp_atom.type_symbol
_chem_comp_atom.type_energy
_chem_comp_atom.partial_charge
_chem_comp_atom.x
_chem_comp_atom.y
_chem_comp_atom.z
8ZB C24 C CH3  -0.065 5.193  -2.668 -0.514
8ZB C28 C CH2  -0.054 4.269  -1.547 -0.941
8ZB C31 C CH2  -0.024 3.677  -0.800 0.239
8ZB C36 C CH1  0.090  2.849  0.415  -0.131
8ZB C38 C CH1  0.167  0.586  0.822  -0.595
8ZB C39 C CH1  0.128  1.070  1.901  0.383
8ZB C40 C CH1  0.111  2.276  1.217  1.029
8ZB C49 C CR16 0.100  -0.400 -1.049 0.802
8ZB C50 C CR6  0.147  -2.470 -0.881 0.363
8ZB C51 C CR6  0.167  -1.837 0.107  -0.374
8ZB C53 C CR16 0.120  -3.743 0.809  -1.235
8ZB C55 C CR6  0.147  -3.871 -0.970 0.239
8ZB N47 N NR6  -0.285 -0.499 -0.007 -0.082
8ZB N48 N NRD6 -0.231 -1.549 -1.607 1.103
8ZB N52 N NRD6 -0.216 -2.419 0.988  -1.196
8ZB N54 N NRD6 -0.219 -4.486 -0.092 -0.584
8ZB N57 N NH2  -0.341 -4.618 -1.871 0.885
8ZB O37 O O2   -0.348 1.695  -0.016 -0.883
8ZB O41 O OH1  -0.385 1.438  3.076  -0.331
8ZB O42 O OH1  -0.387 3.232  2.149  1.524
8ZB H2  H HCH3 0.023  6.163  -2.277 -0.210
8ZB H1  H HCH3 0.023  4.799  -3.242 0.324
8ZB H29 H HCH3 0.023  5.383  -3.375 -1.320
8ZB H28 H HCH2 0.026  4.777  -0.858 -1.614
8ZB H33 H HCH2 0.026  3.458  -1.960 -1.539
8ZB H35 H HCH2 0.029  3.085  -1.495 0.832
8ZB H31 H HCH2 0.029  4.465  -0.458 0.907
8ZB H61 H HCH1 0.062  3.420  1.059  -0.799
8ZB H62 H HCH1 0.087  0.266  1.231  -1.553
8ZB H44 H HCH1 0.067  0.317  2.156  1.128
8ZB H43 H HCH1 0.065  1.967  0.592  1.865
8ZB H58 H HCR  0.103  0.549  -1.387 1.216
8ZB H56 H HCR  0.105  -4.305 1.478  -1.885
8ZB H60 H HNH2 0.144  -4.185 -2.546 1.507
8ZB H59 H HNH2 0.144  -5.627 -1.913 0.779
8ZB H46 H HOH1 0.210  0.856  3.798  0.026
8ZB H45 H HOH1 0.210  2.872  2.596  2.335
loop_
_chem_comp_bond.comp_id
_chem_comp_bond.atom_id_1
_chem_comp_bond.atom_id_2
_chem_comp_bond.type
_chem_comp_bond.value_dist
_chem_comp_bond.value_dist_esd
8ZB C24 C28 single   1.513 0.038
8ZB C24 H1  single   1.089 0.010
8ZB C24 H2  single   1.089 0.010
8ZB C24 H29 single   1.089 0.010
8ZB C28 C31 single   1.516 0.024
8ZB C28 H28 single   1.089 0.010
8ZB C28 H33 single   1.089 0.010
8ZB C31 C36 single   1.516 0.013
8ZB C31 H31 single   1.089 0.010
8ZB C31 H35 single   1.089 0.010
8ZB C36 C40 single   1.526 0.013
8ZB C36 H61 single   1.089 0.010
8ZB C36 O37 single   1.444 0.011
8ZB C38 C39 single   1.531 0.014
8ZB C38 H62 single   1.089 0.010
8ZB C38 N47 single   1.459 0.012
8ZB C38 O37 single   1.416 0.011
8ZB C39 C40 single   1.531 0.013
8ZB C39 H44 single   1.089 0.010
8ZB C39 O41 single   1.423 0.012
8ZB C40 H43 single   1.089 0.010
8ZB C40 O42 single   1.423 0.012
8ZB C49 H58 single   1.089 0.010
8ZB C49 N47 aromatic 1.370 0.008
8ZB C49 N48 aromatic 1.311 0.008
8ZB C50 C51 aromatic 1.388 0.011
8ZB C50 C55 aromatic 1.409 0.010
8ZB C50 N48 aromatic 1.387 0.007
8ZB C51 N47 aromatic 1.374 0.008
8ZB C51 N52 aromatic 1.338 0.012
8ZB C53 H56 single   1.089 0.010
8ZB C53 N52 aromatic 1.334 0.011
8ZB C53 N54 aromatic 1.334 0.011
8ZB C55 N54 aromatic 1.350 0.010
8ZB C55 N57 single   1.337 0.014
8ZB N57 H59 single   1.015 0.010
8ZB N57 H60 single   1.015 0.010
8ZB O41 H46 single   0.993 0.010
8ZB O42 H45 single   0.993 0.010
loop_
_chem_comp_angle.comp_id
_chem_comp_angle.atom_id_1
_chem_comp_angle.atom_id_2
_chem_comp_angle.atom_id_3
_chem_comp_angle.value_angle
_chem_comp_angle.value_angle_esd
8ZB C28 C24 H1  112.7 3.0
8ZB C28 C24 H2  110.9 3.0
8ZB H1  C24 H2  107.3 3.0
8ZB C28 C24 H29 112.1 3.0
8ZB H1  C24 H29 106.8 3.0
8ZB H2  C24 H29 106.6 3.0
8ZB C24 C28 C31 112.7 1.9
8ZB C24 C28 H28 110.8 3.0
8ZB C31 C28 H28 110.5 3.0
8ZB C24 C28 H33 109.3 3.0
8ZB C31 C28 H33 109.0 3.0
8ZB H28 C28 H33 104.4 3.0
8ZB C28 C31 C36 114.6 1.8
8ZB C28 C31 H31 110.5 3.0
8ZB C36 C31 H31 107.1 3.0
8ZB C28 C31 H35 108.9 3.0
8ZB C36 C31 H35 110.4 3.0
8ZB H31 C31 H35 105.2 3.0
8ZB C31 C36 C40 116.2 1.2
8ZB C31 C36 H61 109.6 3.0
8ZB C40 C36 H61 110.7 3.0
8ZB C31 C36 O37 108.8 1.1
8ZB C40 C36 O37 105.2 1.3
8ZB H61 C36 O37 106.3 3.0
8ZB C39 C38 H62 113.0 3.0
8ZB C39 C38 N47 114.2 1.5
8ZB H62 C38 N47 107.6 3.0
8ZB C39 C38 O37 106.5 1.2
8ZB H62 C38 O37 105.9 3.0
8ZB N47 C38 O37 108.3 1.3
8ZB C38 C39 C40 101.5 1.2
8ZB C38 C39 H44 112.9 3.0
8ZB C40 C39 H44 111.5 3.0
8ZB C38 C39 O41 110.5 2.8
8ZB C40 C39 O41 111.9 2.7
8ZB H44 C39 O41 109.4 3.0
8ZB C36 C40 C39 102.5 1.0
8ZB C36 C40 H43 113.0 3.0
8ZB C39 C40 H43 111.0 3.0
8ZB C36 C40 O42 111.0 2.5
8ZB C39 C40 O42 111.9 2.7
8ZB H43 C40 O42 107.5 3.0
8ZB H58 C49 N47 122.9 3.0
8ZB H58 C49 N48 123.1 3.0
8ZB N47 C49 N48 114.1 0.7
8ZB C51 C50 C55 117.0 0.6
8ZB C51 C50 N48 110.7 0.5
8ZB C55 C50 N48 132.1 1.2
8ZB C50 C51 N47 105.8 0.5
8ZB C50 C51 N52 126.8 0.7
8ZB N47 C51 N52 127.0 1.1
8ZB H56 C53 N52 116.3 3.0
8ZB H56 C53 N54 114.9 3.0
8ZB N52 C53 N54 128.7 0.9
8ZB C50 C55 N54 117.6 1.0
8ZB C50 C55 N57 123.5 1.1
8ZB N54 C55 N57 118.2 1.2
8ZB C38 N47 C49 126.8 1.9
8ZB C38 N47 C51 126.8 1.8
8ZB C49 N47 C51 105.7 0.5
8ZB C49 N48 C50 103.7 0.5
8ZB C51 N52 C53 111.9 2.2
8ZB C53 N54 C55 118.6 1.0
8ZB C55 N57 H59 122.2 3.0
8ZB C55 N57 H60 120.4 3.0
8ZB H59 N57 H60 117.3 3.0
8ZB C36 O37 C38 109.4 1.6
8ZB C39 O41 H46 105.4 3.0
8ZB C40 O42 H45 109.5 3.0
loop_
_chem_comp_chir.comp_id
_chem_comp_chir.id
_chem_comp_chir.atom_id_centre
_chem_comp_chir.atom_id_1
_chem_comp_chir.atom_id_2
_chem_comp_chir.atom_id_3
_chem_comp_chir.volume_sign
8ZB chir_04 C36 O37 C40 C31 negative
8ZB chir_05 C38 O37 N47 C39 negative
8ZB chir_06 C39 O41 C40 C38 positive
8ZB chir_07 C40 O42 C39 C36 negative
loop_
_chem_comp_plane_atom.comp_id
_chem_comp_plane_atom.plane_id
_chem_comp_plane_atom.atom_id
_chem_comp_plane_atom.dist_esd
8ZB csd-C50  C50 0.020
8ZB csd-C50  C51 0.020
8ZB csd-C50  C55 0.020
8ZB csd-C50  N48 0.020
8ZB csd-C51  C51 0.020
8ZB csd-C51  C50 0.020
8ZB csd-C51  N47 0.020
8ZB csd-C51  N52 0.020
8ZB csd-C55  C55 0.020
8ZB csd-C55  C50 0.020
8ZB csd-C55  N54 0.020
8ZB csd-C55  N57 0.020
8ZB csd-N47  N47 0.020
8ZB csd-N47  C38 0.020
8ZB csd-N47  C49 0.020
8ZB csd-N47  C51 0.020
8ZB qm-C49   C49 0.020
8ZB qm-C49   N47 0.020
8ZB qm-C49   N48 0.020
8ZB qm-C49   H58 0.020
8ZB qm-C53   C53 0.020
8ZB qm-C53   N52 0.020
8ZB qm-C53   N54 0.020
8ZB qm-C53   H56 0.020
8ZB qm-N57   N57 0.020
8ZB qm-N57   C55 0.020
8ZB qm-N57   H59 0.020
8ZB qm-N57   H60 0.020
8ZB qmf-01   C50 0.020
8ZB qmf-01   C55 0.020
8ZB qmf-01   N57 0.020
8ZB qmf-01   H59 0.020
8ZB ring5A-1 C49 0.020
8ZB ring5A-1 N47 0.020
8ZB ring5A-1 C51 0.020
8ZB ring5A-1 C50 0.020
8ZB ring5A-2 N47 0.020
8ZB ring5A-2 C51 0.020
8ZB ring5A-2 C50 0.020
8ZB ring5A-2 N48 0.020
8ZB ring5A-3 C51 0.020
8ZB ring5A-3 C50 0.020
8ZB ring5A-3 N48 0.020
8ZB ring5A-3 C49 0.020
8ZB ring5A-4 C50 0.020
8ZB ring5A-4 N48 0.020
8ZB ring5A-4 C49 0.020
8ZB ring5A-4 N47 0.020
8ZB ring5A-5 N48 0.020
8ZB ring5A-5 C49 0.020
8ZB ring5A-5 N47 0.020
8ZB ring5A-5 C51 0.020
8ZB ring6A-1 C50 0.020
8ZB ring6A-1 C51 0.020
8ZB ring6A-1 N52 0.020
8ZB ring6A-1 C53 0.020
8ZB ring6A-2 C51 0.020
8ZB ring6A-2 N52 0.020
8ZB ring6A-2 C53 0.020
8ZB ring6A-2 N54 0.020
8ZB ring6A-3 N52 0.020
8ZB ring6A-3 C53 0.020
8ZB ring6A-3 N54 0.020
8ZB ring6A-3 C55 0.020
8ZB ring6A-4 C53 0.020
8ZB ring6A-4 N54 0.020
8ZB ring6A-4 C55 0.020
8ZB ring6A-4 C50 0.020
8ZB ring6A-5 N54 0.020
8ZB ring6A-5 C55 0.020
8ZB ring6A-5 C50 0.020
8ZB ring6A-5 C51 0.020
8ZB ring6A-6 C55 0.020
8ZB ring6A-6 C50 0.020
8ZB ring6A-6 C51 0.020
8ZB ring6A-6 N52 0.020
loop_
_chem_comp_tor.comp_id
_chem_comp_tor.id
_chem_comp_tor.atom_id_1
_chem_comp_tor.atom_id_2
_chem_comp_tor.atom_id_3
_chem_comp_tor.atom_id_4
_chem_comp_tor.value_angle
_chem_comp_tor.value_angle_esd
_chem_comp_tor.period
8ZB other-001      H1  C24 C28 C31 0.0   1000000.0 10
8ZB csd-sp3sp3-01  C24 C28 C31 C36 180.0 12.3      3
8ZB csd-sp3sp3-02  C28 C31 C36 C40 180.0 12.3      3
8ZB other-002      C31 C36 C40 C39 0.0   1000000.0 10
8ZB other-003      C31 C36 O37 C38 0.0   1000000.0 10
8ZB other-004      N47 C38 C39 C40 0.0   1000000.0 10
8ZB other-005      C39 C38 N47 C49 0.0   1000000.0 10
8ZB other-006      C39 C38 O37 C36 0.0   1000000.0 10
8ZB other-007      C38 C39 C40 C36 0.0   1000000.0 10
8ZB other-008      C38 C39 O41 H46 0.0   1000000.0 10
8ZB other-009      C36 C40 O42 H45 0.0   1000000.0 10
8ZB CONST_ring5A-5 N48 C49 N47 C51 0.0   1000000.0 0
8ZB CONST_ring5A-4 N47 C49 N48 C50 0.0   1000000.0 0
8ZB CONST_ring6A-6 C55 C50 C51 N52 0.0   1000000.0 0
8ZB CONST_ring6A-5 C51 C50 C55 N54 0.0   1000000.0 0
8ZB CONST_ring5A-3 C51 C50 N48 C49 0.0   1000000.0 0
8ZB CONST_ring5A-1 C50 C51 N47 C49 0.0   1000000.0 0
8ZB CONST_ring6A-1 C50 C51 N52 C53 0.0   1000000.0 0
8ZB CONST_ring6A-2 N54 C53 N52 C51 0.0   1000000.0 0
8ZB CONST_ring6A-3 N52 C53 N54 C55 0.0   1000000.0 0
8ZB CONST_ring6A-4 C50 C55 N54 C53 0.0   1000000.0 0
8ZB qmf-01         C50 C55 N57 H59 180.0 1000000.0 2

#
#
"""

def run(prefix = "tst_model_get_vdw_radii"):
  fo = open("%s.pdb"%prefix,"w")
  print(pdb, file=fo)
  fo.close()
  fo = open("%s.cif"%prefix,"w")
  print(cif, file=fo)
  fo.close()
  #
  i = mmtbx.utils.process_command_line_args(args = ["%s.cif"%prefix])
  pdb_inp = iotbx.pdb.input(file_name = "%s.pdb"%prefix)
  model = mmtbx.model.manager(
    model_input       = pdb_inp,
    restraint_objects = i.cif_objects,
    log               = null_out())
  model.process()
  derived_keys = model.get_vdw_radii()
  # compare with answer
  for atom_name in pdb_inp.atoms().extract_name():
    assert atom_name.strip() in derived_keys

if (__name__ == "__main__"):
  run()


 *******************************************************************************


 *******************************************************************************
mmtbx/regression/model/tst_model_merge.py
from __future__ import absolute_import, division, print_function
import mmtbx.model
import iotbx.pdb
from libtbx.utils import format_cpu_times
from iotbx.regression.ncs.tst_ncs import pdb_str_5
from libtbx.utils import null_out


def exercise_merge():
  inp = iotbx.pdb.input(lines=pdb_str_5, source_info=None)
  ab = mmtbx.model.manager(model_input=inp)
  ab.set_log(null_out())
  a = ab.apply_selection_string('chain A')
  b = ab.apply_selection_string('chain B')
  assert a.overall_counts().n_residues == 3
  a.merge_other_model(b)
  assert a.overall_counts().n_residues == 5

  try:
    ab.merge_other_model(b)
    raise AssertionError("Failed to fail in duplicate merge")
  except Exception as e:
    pass # ok

def run():
  exercise_merge()
  print(format_cpu_times())

if (__name__ == "__main__"):
  run()


 *******************************************************************************


 *******************************************************************************
mmtbx/regression/model/tst_model_mtrix.py
from __future__ import absolute_import, division, print_function
import mmtbx.model
import iotbx.pdb
from libtbx.utils import format_cpu_times, null_out

pdb_str_1="""
CRYST1   10.000   10.000   10.000  90.00  90.00  90.00 P 1
HELIX    1   1 THR A    1  THR A    2  1                                   6
HELIX    1   1 THR B    1  THR B    2  1                                   6
SHEET    1   A 2 THR A   1  THR A   3  0
SHEET    2   A 2 THR B   4  THR B   5 -1  O  THR B   4   N  THR A   2
MTRIX1   1  1.000000  0.000000  0.000000        0.00000    1
MTRIX2   1  0.000000  1.000000  0.000000        0.00000    1
MTRIX3   1  0.000000  0.000000  1.000000        0.00000    1
MTRIX1   2  0.496590 -0.643597  0.582393        0.00000
MTRIX2   2  0.867925  0.376088 -0.324443        0.00000
MTRIX3   2 -0.010221  0.666588  0.745356        0.00000
MTRIX1   3 -0.317946 -0.173437  0.932111        0.00000
MTRIX2   3  0.760735 -0.633422  0.141629        0.00000
MTRIX3   3  0.565855  0.754120  0.333333        0.00000
ATOM      1  N   THR A   1       5.111   8.080   7.645  1.00 20.00           N
ATOM      2  CA  THR A   1       5.000   6.722   7.125  1.00 20.00           C
ATOM      3  C   THR A   1       5.075   5.694   8.249  1.00 20.00           C
ATOM      4  O   THR A   4       5.890   5.818   9.163  1.00 20.00           O
ATOM      5  CB  THR A   5       6.101   6.421   6.092  1.00 20.00           C
ATOM      6  OG1 THR A   6       6.001   7.343   5.000  1.00 20.00           O
ATOM      7  CG2 THR A   7       5.964   5.000   5.565  1.00 20.00           C
TER
END
"""

pdb_str_2="""
HELIX    1   1 THR A    1  THR A    2  1                                   6
SHEET    1   A 2 THR A   1  THR A   3  0
SHEET    2   A 2 THR B   4  THR B   5 -1  O  THR B   4   N  THR A   2
MTRIX1   1  1.000000  0.000000  0.000000        0.00000    1
MTRIX2   1  0.000000  1.000000  0.000000        0.00000    1
MTRIX3   1  0.000000  0.000000  1.000000        0.00000    1
MTRIX1   2  0.496590 -0.643597  0.582393        0.00000
MTRIX2   2  0.867925  0.376088 -0.324443        0.00000
MTRIX3   2 -0.010221  0.666588  0.745356        0.00000
MTRIX1   3 -0.317946 -0.173437  0.932111        0.00000
MTRIX2   3  0.760735 -0.633422  0.141629        0.00000
MTRIX3   3  0.565855  0.754120  0.333333        0.00000
ATOM      1  N   THR A   1       5.111   8.080   7.645  1.00 20.00           N
ATOM      2  CA  THR A   1       5.000   6.722   7.125  1.00 20.00           C
ATOM      3  C   THR A   1       5.075   5.694   8.249  1.00 20.00           C
ATOM      4  O   THR B   4       5.890   5.818   9.163  1.00 20.00           O
ATOM      5  CB  THR B   5       6.101   6.421   6.092  1.00 20.00           C
ATOM      6  OG1 THR C   6       6.001   7.343   5.000  1.00 20.00           O
ATOM      7  CG2 THR C   7       5.964   5.000   5.565  1.00 20.00           C
TER
END
"""

def exercise_1():
  inp = iotbx.pdb.input(source_info=None, lines=pdb_str_1)
  model = mmtbx.model.manager(
      model_input = inp,
      log = null_out())
  model.process(make_restraints=True)
  assert model.get_number_of_atoms() == 21, model.get_number_of_atoms()
  assert model.get_hierarchy().atoms_size() == 21
  assert model.get_xray_structure().scatterers().size() == 21
  ss = model.get_ss_annotation()
  # print ss.as_pdb_str()
  # STOP()
  assert ss.get_n_helices() == 3
  # because the second strand contains chain B which is not in ATOM records
  # whole sheet got discarded.
  assert ss.get_n_sheets() == 0
  rm = model.get_restraints_manager()
  assert rm.geometry.pair_proxies().bond_proxies.simple.size() == 6
  # since No NCS was set, these functions return the whole thing and no
  # master selection
  assert model.get_master_hierarchy().atoms_size() == 21
  assert model.get_master_selection().size() == 0
  # print model.model_as_pdb()
  # print "="*40

  # Here we set NCS constraints
  inp = iotbx.pdb.input(source_info=None, lines=pdb_str_1)
  pdb_int_params = mmtbx.model.manager.get_default_pdb_interpretation_params()
  pdb_int_params.pdb_interpretation.ncs_search.enabled=True
  model = mmtbx.model.manager(
      model_input = inp,
      log = null_out())
  model.process(pdb_interpretation_params = pdb_int_params)
  # model.get_xray_structure()
  assert not model.ncs_constraints_present()
  assert model.get_ncs_obj() is not None
  model.setup_ncs_constraints_groups()
  # print model.get_ncs_obj()
  assert model.ncs_constraints_present()
  assert model.get_master_hierarchy().atoms_size() == 7
  # print model.get_master_hierarchy().as_pdb_string()
  # print list(model.get_master_selection())
  assert list(model.get_master_selection()).count(True) == 7

def exercise_2():
  """
  Same as 1 but automatic NCS search procedure does not match short chains,
  in this case chains B,C, so they left out of NCS.
  Not clear if we should utilize MTRIX instead of searching for NCS
  because currently we don't output them and in consecutive runs NCS
  search would be utilized anyway, potentially yelding different groups.
  """
  inp = iotbx.pdb.input(source_info=None, lines=pdb_str_2)
  pdb_int_params = mmtbx.model.manager.get_default_pdb_interpretation_params()
  pdb_int_params.pdb_interpretation.ncs_search.enabled=True
  model = mmtbx.model.manager(
      model_input = inp,
      log = null_out())
  model.process(pdb_interpretation_params = pdb_int_params)
  # model.get_xray_structure()
  ss = model.get_ss_annotation()
  assert ss.get_n_helices() == 3
  assert ss.get_n_sheets() == 3

  assert not model.ncs_constraints_present()
  assert model.get_ncs_obj() is not None
  model.setup_ncs_constraints_groups()
  # print model.get_ncs_obj()
  assert model.ncs_constraints_present()
  assert model.get_master_hierarchy().atoms_size() == 15
  # print model.get_master_hierarchy().as_pdb_string()
  assert list(model.get_master_selection()).count(True) == 15

if (__name__ == "__main__"):
  exercise_1()
  exercise_2()
  print(format_cpu_times())
  print("OK")


 *******************************************************************************


 *******************************************************************************
mmtbx/regression/model/tst_model_ncs.py
from __future__ import absolute_import, division, print_function
import mmtbx.model
import iotbx.pdb
from cctbx.array_family import flex
from libtbx.utils import format_cpu_times
from libtbx.test_utils import approx_equal, show_diff
from iotbx.regression.ncs.tst_ncs import pdb_str_5
from mmtbx.regression.ncs.tst_ncs_search import test_pdb_6


def exercise_set_sites_cart_ncs():
  """
  No extra atoms
  """
  inp = iotbx.pdb.input(lines=pdb_str_5, source_info=None)
  model = mmtbx.model.manager(model_input=inp)
  model.search_for_ncs()
  nrgl = model.get_ncs_groups()
  nrgl._show()
  print ('n model atoms:', model.get_number_of_atoms())
  print ('n master atoms:', model.get_master_selection().count(True))
  print ('n master atoms:', model.get_master_selection().iselection().size())
  print ('n master atoms:', model.get_master_hierarchy().atoms_size())

  assert model.get_master_selection().count(True) ==\
      model.get_master_selection().iselection().size() ==\
      model.get_master_hierarchy().atoms_size()

  h = model.get_hierarchy()
  # print('h sites:', list(h.atoms().extract_xyz()))

  # Warning: here here mh is not deep-copy, therefore when we change atom coords
  # they are changing in model.get_hierarchy() as well
  mh = model.get_master_hierarchy()
  new_sites_cart = flex.vec3_double([(1.0, 1.0, 1.0)]*42)
  mh.atoms().set_xyz(new_sites_cart)
  model.set_sites_cart_from_hierarchy(multiply_ncs=True)
  h = model.get_hierarchy()
  new_xyz=h.atoms().extract_xyz()
  # print('h sites:', list(new_xyz))

  # checking if setting went as supposed:
  assert approx_equal(new_xyz[0], (1.0, 1.0, 1.0), eps=1e-4)
  assert approx_equal(new_xyz[42], (-0.6420293330506949, 1.2600792663765976, 7.999997229451341), eps=1e-4)
  assert approx_equal(new_xyz[84], (-1.396802536808536, -0.22123285934616377, 1.000000038694047), eps=1e-4)
  for i in range(3):
    for j in range(42):
      assert approx_equal(new_xyz[42*i+j], new_xyz[42*i], eps=1e-4)

def exercise_set_sites_cart_ncs_with_extra_atoms():
  inp = iotbx.pdb.input(lines=test_pdb_6, source_info=None)
  model = mmtbx.model.manager(model_input=inp)

  model.search_for_ncs()
  nrgl = model.get_ncs_groups()
  nrgl._show(brief=False)
  print ('n model atoms:', model.get_number_of_atoms())
  print ('n master atoms:', model.get_master_selection().count(True))
  print ('n master atoms:', model.get_master_selection().iselection().size())
  print ('n master isel:', list(model.get_master_selection().iselection()))
  print ('n master atoms:', model.get_master_hierarchy().atoms_size())
  print ('n master hierarchy:\n', model.get_master_hierarchy().as_pdb_string())


  # Note that "HETATM   32  C2  NDG H" and "HETATM   35  C2  NDG L"
  # don't belong to any master/copy
  assert not show_diff(model.get_master_hierarchy().as_pdb_string(),"""\
ATOM      1  N   ASP H   5      91.286 -31.834  73.572  1.00 77.83           N
ATOM      2  CA  ASP H   5      90.511 -32.072  72.317  1.00 78.04           C
ATOM      3  C   ASP H   5      90.136 -30.762  71.617  1.00 77.70           C
ATOM      4  O   ASP H   5      89.553 -29.857  72.225  1.00 77.56           O
ATOM      5  N   THR H   6      91.286 -31.834  73.572  1.00 77.83           N
ATOM      6  CA  THR H   6      90.511 -32.072  72.317  1.00 78.04           C
TER
ATOM      7  N   GLY I 501      91.286 -31.834  73.572  1.00 77.83           N
ATOM      8  CA  GLY I 501      90.511 -32.072  72.317  1.00 78.04           C
ATOM      9  C   GLY I 501      90.136 -30.762  71.617  1.00 77.70           C
ATOM     10  O   GLY I 501      89.553 -29.857  72.225  1.00 77.56           O
TER
HETATM   31  C1  NDG H 640      91.286 -31.834  73.572  1.00 77.83           C
HETATM   32  C2  NDG H 640      91.286 -31.834  73.572  1.00 77.83           C
HETATM   35  C2  NDG L 646      61.028 -14.273  81.262  1.00 69.80           C
""")

  mh = model.get_master_hierarchy()
  # Note that atoms outside NCS are getting 2.0 as xyz
  new_sites_cart = flex.vec3_double([
      (1.0, 1.0, 1.0),
      (1.0, 1.0, 1.0),
      (1.0, 1.0, 1.0),
      (1.0, 1.0, 1.0),
      (1.0, 1.0, 1.0),
      (1.0, 1.0, 1.0)]
      + [(3.0, 3.0, 3.0)]*4 +
      [(1.0, 1.0, 1.0),    # <--- Note this atom belongs the first NCS group
      (2.0, 2.0, 2.0),
      (2.0, 2.0, 2.0)]
      )
  mh.atoms().set_xyz(new_sites_cart)
  # print('='*80)
  # print (mh.as_pdb_string())
  model.set_sites_cart_from_hierarchy(multiply_ncs=True)
  h = model.get_hierarchy()
  new_xyz=h.atoms().extract_xyz()
  # print(model.model_as_pdb())
  # print (list(new_xyz))

  assert approx_equal(new_xyz[31], (2.0, 2.0, 2.0), eps=1e-4)
  assert approx_equal(new_xyz[34], (2.0, 2.0, 2.0), eps=1e-4)

  assert approx_equal(new_xyz[0], (1.0, 1.0, 1.0), eps=1e-4)
  assert approx_equal(new_xyz[5], (1.0, 1.0, 1.0), eps=1e-4)
  assert approx_equal(new_xyz[6], (3.0, 3.0, 3.0), eps=1e-4)
  assert approx_equal(new_xyz[9], (3.0, 3.0, 3.0), eps=1e-4)


  assert nrgl.check_for_max_rmsd(sites_cart=new_xyz, chain_max_rmsd=0.0)

  for i in [[0, 1, 2, 3, 4, 5, 30], [10, 11, 12, 13, 14, 15, 32],
      [20, 21, 22, 23, 24, 25, 33]]:
    for j in i:
      assert approx_equal(new_xyz[j], new_xyz[i[0]], eps=1e-4)
  for i in [[6, 7, 8, 9], [16, 17, 18, 19], [26, 27, 28, 29]]:
    for j in i:
      assert approx_equal(new_xyz[j], new_xyz[i[0]], eps=1e-4)

def exercise_set_sites_cart_no_ncs():
  inp = iotbx.pdb.input(lines=pdb_str_5, source_info=None)
  model = mmtbx.model.manager(model_input=inp, expand_with_mtrix=False)
  model.search_for_ncs()
  nrgl = model.get_ncs_groups()
  nrgl._show()
  print ('n model atoms:', model.get_number_of_atoms())
  print ('n master atoms:', model.get_master_selection().count(True))
  print ('n master atoms:', model.get_master_selection().iselection().size())
  print ('n master atoms:', model.get_master_hierarchy().atoms_size())

  assert model.get_master_selection().count(True) ==\
      model.get_master_selection().iselection().size() ==\
      model.get_master_hierarchy().atoms_size()

  h = model.get_hierarchy()
  # Warning: here here mh is not deep-copy, therefore when we change atom coords
  # they are changing in model.get_hierarchy() as well
  mh = model.get_master_hierarchy()
  new_sites_cart = flex.vec3_double([(1.0, 1.0, 1.0)]*42)
  mh.atoms().set_xyz(new_sites_cart)
  model.set_sites_cart_from_hierarchy(multiply_ncs=True)
  h = model.get_hierarchy()
  new_xyz=h.atoms().extract_xyz()
  # print('h sites:', list(new_xyz))
  # checking if setting went as supposed:
  for j in range(42):
    assert approx_equal(new_xyz[j], (1.0, 1.0, 1.0), eps=1e-4)

def run():
  exercise_set_sites_cart_ncs()
  exercise_set_sites_cart_ncs_with_extra_atoms()
  exercise_set_sites_cart_no_ncs()
  print(format_cpu_times())

if (__name__ == "__main__"):
  run()


 *******************************************************************************


 *******************************************************************************
mmtbx/regression/model/tst_model_neutralize_scatterers.py
from __future__ import absolute_import, division, print_function
import time
import mmtbx.model
import iotbx.pdb
from libtbx.utils import null_out

neutral_atoms_list = ['Ru', 'Re', 'Ra', 'Rb', 'Rn', 'Rh', 'Be', 'Ba', 'Bi',
  'Bk', 'Br', 'H', 'P', 'Os', 'Ge', 'Gd', 'Ga', 'Pr', 'Pt', 'Pu', 'C', 'Pb',
  'Pa', 'Pd', 'Xe', 'Po', 'Pm', 'Ho', 'Hf', 'Hg', 'He', 'Mg', 'K', 'Mn', 'O',
  'S', 'W', 'Zn', 'Eu', 'Zr', 'Er', 'Ni', 'Na', 'Nb', 'Nd', 'Ne', 'Np', 'Fr',
  'Fe', 'B', 'F', 'Sr', 'N', 'Kr', 'Si', 'Sn', 'Sm', 'V', 'Sc', 'Sb', 'Se',
  'Co', 'Cm', 'Cl', 'Ca', 'Cf', 'Ce', 'Cd', 'Tm', 'Cs', 'Cr', 'Cu', 'La',
  'Li', 'Tl', 'Lu', 'Th', 'Ti', 'Te', 'Tb', 'Tc', 'Ta', 'Yb', 'Dy', 'I', 'U',
  'Y', 'Ac', 'Ag', 'Ir', 'Am', 'Al', 'As', 'Ar', 'Au', 'At', 'In', 'Mo']

def run_tst_xrs_and_hierarchy():
  # Check if scatterers in xrs are neutral after calling function
  pdb_inp = iotbx.pdb.input(source_info=None, lines=pdb_str)
  model = mmtbx.model.manager(
      model_input       = pdb_inp,
      log = null_out())

  model.neutralize_scatterers()
  xrs = model.get_xray_structure()
  for scatterer in xrs.scatterers():
    assert (scatterer.scattering_type  in neutral_atoms_list)

  # Check if pdb_hierarchy has neutral atoms as well
  pdb_str_neutralized = model.model_as_pdb()
  pdb_inp_neutralized = iotbx.pdb.input(
    source_info=None,
    lines=pdb_str_neutralized)
  model_neutralized = mmtbx.model.manager(
      model_input       = pdb_inp_neutralized,
      log = null_out())
  xrs_neutralized = model_neutralized.get_xray_structure()
  for scatterer in xrs_neutralized.scatterers():
    assert (scatterer.scattering_type  in neutral_atoms_list)

def run_tst_grm_after_neutralize_scatterers():
  # Look at nonbonded interaction CB - OE2 in Glu
  # OE2 has negative charge
  # vdw distance is 2.560 A when OE2 is neutral
  # vdw distance is 2.752 A when OE1 has O1- charge
  pdb_inp = iotbx.pdb.input(source_info=None, lines=pdb_str_2)

  model = mmtbx.model.manager(
      model_input       = pdb_inp,
      log = null_out())
  model.process(make_restraints=True)
  atoms = model.get_hierarchy().atoms()
  grm = model.get_restraints_manager()
#  with open('1.geo', 'w') as f:
#    f.write(model.restraints_as_geo())
  nonbonded_proxies = grm.geometry.pair_proxies().nonbonded_proxies.simple
  for nb_proxy in nonbonded_proxies:
    iseq, jseq = nb_proxy.i_seqs
    if (iseq==4 and jseq==8):
      vdw_distance1 = nb_proxy.vdw_distance
      assert(atoms[iseq].name.strip()=='CB')
      assert(atoms[jseq].name.strip()=='OE2')

  model = mmtbx.model.manager(
      model_input       = pdb_inp,
      log = null_out())
  model.process(make_restraints=False)
  model.neutralize_scatterers()
  model.process(make_restraints=True)
  atoms2 = model.get_hierarchy().atoms()
  grm2 = model.get_restraints_manager()
#  with open('2.geo', 'w') as f:
#    f.write(model.restraints_as_geo())
  nonbonded_proxies2 = grm2.geometry.pair_proxies().nonbonded_proxies.simple
  for nb_proxy in nonbonded_proxies2:
    iseq, jseq = nb_proxy.i_seqs
    if (iseq==4 and jseq==8):
      vdw_distance2 = nb_proxy.vdw_distance
      assert(atoms2[iseq].name.strip()=='CB')
      assert(atoms2[jseq].name.strip()=='OE2')

  assert(vdw_distance1 != vdw_distance2)


def tst_003():
  '''
  Make sure that scattering registry is really dropped after neutralizing
  '''
  pdb_inp = iotbx.pdb.input(lines=pdb_str_2, source_info=None)
  model = mmtbx.model.manager(model_input = pdb_inp, log = null_out())
  assert ('O1-' in
    model.get_xray_structure().scattering_type_registry().type_count_dict())
  charges = [a.charge for a in model.get_hierarchy().atoms()]
  assert ('1-' in charges)
  model.neutralize_scatterers()
  assert ('O1-' not in
    model.get_xray_structure().scattering_type_registry().type_count_dict())
  charges = [a.charge for a in model.get_hierarchy().atoms()]
  assert ('1-' not in charges)
  model.setup_scattering_dictionaries(scattering_table="electron")
  assert ('O1-' not in
    model.get_xray_structure().scattering_type_registry().type_count_dict())
  model.setup_scattering_dictionaries(
    scattering_table  = "electron",
    d_min             = 1.0,
    log               = null_out())
  assert ('O1-' not in
    model.get_xray_structure().scattering_type_registry().type_count_dict())

def tst_004():
  '''
  model.process() drops xrs, so neutralization is forgotten if only performed
  for scatterers. This tests makes sure that neutralization is propagated
  into model._model_input (pdb_inp).
  sort_atoms=False --> hierarchy is dropped
  '''
  pdb_inp = iotbx.pdb.input(lines=pdb_str_2, source_info=None)
  model = mmtbx.model.manager(model_input = pdb_inp, log = null_out())
  assert ('O1-' in
    model.get_xray_structure().scattering_type_registry().type_count_dict())
  model.neutralize_scatterers()
  assert ('O1-' not in
    model.get_xray_structure().scattering_type_registry().type_count_dict())
  params = mmtbx.model.manager.get_default_pdb_interpretation_params()
  params.pdb_interpretation.sort_atoms = False
  model.process(make_restraints=True, grm_normalization=True,
    pdb_interpretation_params = params)
  assert ('O1-' not in
    model.get_xray_structure().scattering_type_registry().type_count_dict())
  model.setup_scattering_dictionaries(
    scattering_table  = "electron",
    d_min             = 1.0,
    log               = null_out())
  assert ('O1-' not in
    model.get_xray_structure().scattering_type_registry().type_count_dict())

def tst_005():
  '''
  model.process() drops xrs, so neutralization is forgotten if only performed
  for scatterers. This tests makes sure that neutralization is propagated
  into model._model_input (pdb_inp).
  sort_atoms=False --> hierarchy is kept
  '''
  pdb_inp = iotbx.pdb.input(lines=pdb_str_2, source_info=None)
  model = mmtbx.model.manager(model_input = pdb_inp, log = null_out())
  assert ('O1-' in
    model.get_xray_structure().scattering_type_registry().type_count_dict())
  model.neutralize_scatterers()
  assert ('O1-' not in
    model.get_xray_structure().scattering_type_registry().type_count_dict())
  params = mmtbx.model.manager.get_default_pdb_interpretation_params()
  params.pdb_interpretation.sort_atoms = True
  model.process(make_restraints=True, grm_normalization=True,
    pdb_interpretation_params = params)
  assert ('O1-' not in
    model.get_xray_structure().scattering_type_registry().type_count_dict())
  model.setup_scattering_dictionaries(
    scattering_table  = "electron",
    d_min             = 1.0,
    log               = null_out())
  assert ('O1-' not in
    model.get_xray_structure().scattering_type_registry().type_count_dict())
  charges = [a.charge for a in model.get_hierarchy().atoms()]
  assert ('1-' not in charges)

pdb_str = """
CRYST1   36.960  124.370   41.010  90.00 116.55  90.00 P 1 21 1
SCALE1      0.027056  0.000000  0.013519        0.00000
SCALE2      0.000000  0.008041  0.000000        0.00000
SCALE3      0.000000  0.000000  0.027259        0.00000
HETATM 6628   H   H  A5000       6.345   4.777  15.778  1.00  7.19           H1-
HETATM 6629  He  He  A5001       0.898 -11.608   9.059  1.00  4.52          He
HETATM 6630  Li  Li  A5002      -9.341  15.181  18.207  1.00  4.40          Li
HETATM 6631  Li  Li  A5003      -8.813  -4.503  15.152  1.00  4.49          Li1+
HETATM 6632  Be  Be  A5004      -9.819   4.216  22.563  1.00  3.89          Be
HETATM 6633  Be  Be  A5005       7.293  18.903  22.780  1.00  6.69          Be2+
HETATM 6634   B   B  A5006       0.173   6.286  15.367  1.00  4.17           B
HETATM 6635   C   C  A5007      -0.383   1.594  13.039  1.00  4.58           C
HETATM 6636   N   N  A5008      -2.356   2.761  28.626  1.00  4.48           N
HETATM 6637   O   O  A5009      -1.579  -5.998  16.103  1.00  4.95           O
HETATM 6638   O   O  A5010     -13.313  18.722  16.219  1.00  7.64           O1-
HETATM 6639   O   O  A5011       4.042 -17.542  13.901  1.00  5.04           O2-
HETATM 6640   F   F  A5012       1.813 -15.513   8.453  1.00  4.89           F
HETATM 6641   F   F  A5013      -3.818  15.582  34.975  1.00  6.70           F1-
HETATM 6642  Ne  Ne  A5014       0.310 -17.405   7.121  1.00  5.09          Ne
HETATM 6643  Na  Na  A5015     -15.880 -13.960  21.123  1.00  5.49          Na
HETATM 6644  Na  Na  A5016       3.948 -16.112  11.472  1.00  5.30          Na1+
HETATM 6645  Mg  Mg  A5017      -5.457  -5.035  27.632  1.00  5.33          Mg
HETATM 6646  Mg  Mg  A5018      -1.033 -20.162  14.712  1.00  5.86          Mg2+
HETATM 6647  Al  Al  A5019      -4.100  13.292   7.498  1.00  5.86          Al
HETATM 6648  Al  Al  A5020      -9.492 -26.443  15.424  1.00  6.73          Al3+
HETATM 6649  Si  Si  A5021     -17.549 -17.302   8.636  1.00  6.46          Si
HETATM 6650  Si  Si  A5022       4.404  -7.020  14.825  1.00  6.87          Si4+
HETATM 6651   P   P  A5023     -10.836   7.859  11.832  1.00  5.89           P
HETATM 6652   S   S  A5024       0.998   3.980  13.754  1.00  5.70           S
HETATM 6653  Cl  Cl  A5025      -5.365  12.486   5.272  1.00  6.33          Cl
HETATM 6654  Cl  Cl  A5026     -15.556 -14.292  17.362  1.00  5.92          Cl1-
HETATM 6655  Ar  Ar  A5027       3.867 -15.378  22.380  1.00  7.31          Ar
HETATM 6656   K   K  A5028      -7.693   6.919  26.782  1.00  5.96           K
HETATM 6657   K   K  A5029      -6.978  30.897  25.968  0.80  5.32           K1+
HETATM 6658  Ca  Ca  A5030      -6.322 -25.130   8.738  1.00  5.59          Ca
HETATM 6659  Ca  Ca  A5031       6.962   7.229  16.925  1.00  6.08          Ca2+
HETATM 6660  Sc  Sc  A5032     -16.532  19.553  26.386  1.00  5.96          Sc
HETATM 6661  Sc  Sc  A5033       2.846 -13.052   7.763  1.00  5.81          Sc3+
HETATM 6662  Ti  Ti  A5034       1.784   0.090  -2.170  1.00  7.02          Ti
HETATM 6663  Ti  Ti  A5035       2.605 -14.287   0.491  1.00  6.70          Ti2+
HETATM 6664  Ti  Ti  A5036     -20.529  -8.793  13.734  1.00  6.46          Ti3+
HETATM 6665  Ti  Ti  A5037      -1.062  -0.582  14.744  1.00  6.45          Ti4+
HETATM 6666   V   V  A5038     -14.665   0.020  25.868  0.80  5.37           V
HETATM 6667   V   V  A5039      -1.000   3.064  31.898  1.00  6.58           V2+
HETATM 6668   V   V  A5040      -3.011  18.109  34.071  1.00  6.71           V3+
HETATM 6669   V   V  A5041      -8.717  31.117  28.097  1.00  8.45           V5+
HETATM 6670  Cr  Cr  A5042     -19.474  -9.238  17.375  1.00  7.04          Cr
HETATM 6671  Cr  Cr  A5043       2.577  12.013  31.099  1.00  7.46          Cr2+
HETATM 6672  Cr  Cr  A5044      -1.803  18.594  31.768  1.00  9.12          Cr3+
HETATM 6673  Mn  Mn  A5045      -5.340 -10.857  -4.897  1.00  9.22          Mn
HETATM 6674  Mn  Mn  A5046      -8.923   4.751  25.261  1.00  6.53          Mn2+
HETATM 6675  Mn  Mn  A5047     -14.493  -4.667   4.322  1.00  5.71          Mn3+
HETATM 6676  Mn  Mn  A5048      -7.935  12.827   4.276  1.00  7.36          Mn4+
HETATM 6677  Fe  Fe  A5049     -16.603 -15.963  22.859  1.00  6.52          Fe
HETATM 6678  Fe  Fe  A5050       5.273 -15.598  15.395  1.00  6.29          Fe2+
HETATM 6679  Fe  Fe  A5051       3.235   9.285  30.877  1.00  6.67          Fe3+
HETATM 6680  Co  Co  A5052       3.025 -18.039  22.544  1.00  6.99          Co
HETATM 6681  Co  Co  A5053      -0.542 -15.322  -4.060  1.00  7.59          Co2+
HETATM 6682  Co  Co  A5054     -15.891  10.115  10.580  1.00  8.16          Co3+
HETATM 6683  Ni  Ni  A5055     -18.117   2.800  31.652  1.00  8.25          Ni
HETATM 6684  Ni  Ni  A5056       4.325  -0.300  22.401  1.00  8.80          Ni2+
HETATM 6685  Ni  Ni  A5057     -10.666  -4.255   5.624  1.00  7.56          Ni3+
HETATM 6686  Cu  Cu  A5058       7.586  19.226  29.730  1.00  9.19          Cu
HETATM 6687  Cu  Cu  A5059      -8.448  26.719  21.195  1.00  8.94          Cu1+
HETATM 6688  Cu  Cu  A5060       1.615 -22.177   9.005  0.70  6.61          Cu2+
HETATM 6689  Zn  Zn  A5061     -17.611  31.917  21.108  1.00  7.51          Zn
HETATM 6690  Zn  Zn  A5062      -9.590  -3.484  29.577  1.00  6.73          Zn2+
HETATM 6691  Ga  Ga  A5063      -9.010 -23.725  17.437  1.00  6.62          Ga
HETATM 6692  Ga  Ga  A5064     -11.495  -2.227   4.073  0.79  5.34          Ga3+
HETATM 6693  Ge  Ge  A5065      -5.323 -27.884   9.135  1.00  7.29          Ge
HETATM 6694  Ge  Ge  A5066     -11.995 -24.557  19.436  1.00  7.76          Ge4+
HETATM 6695  As  As  A5067       8.866  12.749  23.235  1.00  9.38          As
HETATM 6696  Se  Se  A5068     -20.992  -5.261   6.751  1.00 10.30          Se
HETATM 6697  Br  Br  A5069     -11.955  16.592  37.039  1.00 10.09          Br
HETATM 6698  Br  Br  A5070      -4.929 -13.595  -5.436  1.00  9.30          Br1-
HETATM 6699  Kr  Kr  A5071      -5.562 -22.177   1.544  1.00  7.55          Kr
HETATM 6700  Rb  Rb  A5072      -1.071   2.859  -0.759  0.80  6.86          Rb
HETATM 6701  Rb  Rb  A5073     -16.938 -10.770  -0.110  1.00  9.09          Rb1+
HETATM 6702  Sr  Sr  A5074      -7.582 -21.920  19.111  0.70  5.55          Sr
HETATM 6703  Sr  Sr  A5075       6.197  12.147  11.582  1.00  7.42          Sr2+
HETATM 6704   Y   Y  A5076     -23.796  -1.956   8.962  0.70 19.49           Y
HETATM 6705   Y   Y  A5077       9.894   4.496  22.239  1.00  9.32           Y3+
HETATM 6706  Zr  Zr  A5078     -21.108 -13.726  13.696  1.00  8.40          Zr
HETATM 6707  Zr  Zr  A5079       5.444  -2.244  -0.988  1.00 10.26          Zr4+
HETATM 6708  Nb  Nb  A5080       1.428 -32.632  10.473  1.00  7.70          Nb
HETATM 6709  Nb  Nb  A5081     -11.489  22.783  34.873  1.00  9.91          Nb3+
HETATM 6710  Nb  Nb  A5082      -5.022   8.426  -0.521  1.00  9.46          Nb5+
HETATM 6711  Mo  Mo  A5083       4.245 -26.322  18.944  1.00  9.17          Mo
HETATM 6712  Mo  Mo  A5084     -21.686  31.635  22.531  1.00  8.64          Mo3+
HETATM 6713  Mo  Mo  A5085       5.619   0.799   8.811  1.00  9.02          Mo5+
HETATM 6714  Mo  Mo  A5086     -20.860  -2.905   5.430  1.00 10.43          Mo6+
HETATM 6715  Tc  Tc  A5087      10.698  16.257  24.585  1.00  8.87          Tc
HETATM 6716  Ru  Ru  A5088     -13.683 -23.315  21.718  0.80  8.64          Ru
HETATM 6717  Ru  Ru  A5089     -15.661  11.589   8.016  1.00  8.65          Ru3+
HETATM 6718  Ru  Ru  A5090     -12.698   2.182  34.354  1.00  8.53          Ru4+
HETATM 6719  Rh  Rh  A5091     -17.937 -14.404   3.222  1.00 11.95          Rh
HETATM 6720  Rh  Rh  A5092       9.630   8.424   8.317  1.00  9.93          Rh3+
HETATM 6721  Rh  Rh  A5093       4.321 -24.967  11.322  1.00 10.50          Rh4+
HETATM 6722  Pd  Pd  A5094       2.854  22.947  17.184  1.00  9.90          Pd
HETATM 6723  Pd  Pd  A5095     -18.873  15.498  20.461  1.00  9.71          Pd2+
HETATM 6724  Pd  Pd  A5096       5.173 -14.697   1.413  1.00  8.92          Pd4+
HETATM 6725  Ag  Ag  A5097      13.750   8.522  14.089  0.90  8.83          Ag
HETATM 6726  Ag  Ag  A5098       3.960 -14.391  24.920  1.00 10.92          Ag1+
HETATM 6727  Ag  Ag  A5099     -17.719  14.157  22.605  1.00  8.67          Ag2+
HETATM 6728  Cd  Cd  A5100     -13.886  -0.324  33.947  1.00  8.25          Cd
HETATM 6729  Cd  Cd  A5101      -0.211  -8.780  26.524  1.00  7.97          Cd2+
HETATM 6730  In  In  A5102       7.556 -13.249   0.737  0.70  6.51          In
HETATM 6731  In  In  A5103     -21.951 -11.151  14.274  1.00  8.87          In3+
HETATM 6732  Sn  Sn  A5104     -14.061  -1.934  27.862  0.80  5.90          Sn
HETATM 6733  Sn  Sn  A5105     -14.045  20.753  14.529  1.00 10.10          Sn2+
HETATM 6734  Sn  Sn  A5106      -8.571 -21.026  26.684  1.00  8.59          Sn4+
HETATM 6735  Sb  Sb  A5107      -3.422 -29.610  15.693  1.00  8.74          Sb
HETATM 6736  Sb  Sb  A5108     -17.171   8.243   8.941  0.80  8.41          Sb3+
HETATM 6737  Sb  Sb  A5109      -1.387  18.424  36.218  1.00 10.11          Sb5+
HETATM 6738  Te  Te  A5110     -18.238   8.843  16.853  1.00  8.90          Te
HETATM 6739   I   I  A5111     -12.911 -10.114  -3.539  1.00 10.15           I
HETATM 6740   I   I  A5112     -14.718   0.056  29.622  0.80  6.93           I1-
HETATM 6741  Xe  Xe  A5113       3.198  24.539  23.772  1.00 10.25          Xe
HETATM 6742  Cs  Cs  A5114      -9.544  -5.654  -3.780  1.00 12.88          Cs
HETATM 6743  Cs  Cs  A5115     -14.304  29.432  17.958  1.00 10.60          Cs1+
HETATM 6744  Ba  Ba  A5116       0.027 -31.416  18.068  1.00 11.49          Ba
HETATM 6745  Ba  Ba  A5117       2.957 -22.353  -4.387  0.70  8.04          Ba2+
HETATM 6746  La  La  A5118       5.044   8.538  33.082  1.00 12.08          La
HETATM 6747  La  La  A5119     -18.925 -19.092   7.000  1.00 14.18          La3+
HETATM 6748  Ce  Ce  A5120       3.686 -31.641  11.616  1.00 12.00          Ce
HETATM 6749  Ce  Ce  A5121       4.314 -21.047   4.935  1.00 13.08          Ce3+
HETATM 6750  Ce  Ce  A5122     -12.952 -11.779  -1.393  1.00 10.99          Ce4+
HETATM 6751  Pr  Pr  A5123     -22.006  -1.983  17.485  1.00 10.26          Pr
HETATM 6752  Pr  Pr  A5124      -3.968  -5.120  30.009  1.00  8.71          Pr3+
HETATM 6753  Pr  Pr  A5125     -16.808 -13.442  32.754  1.00 10.21          Pr4+
HETATM 6754  Nd  Nd  A5126     -18.522 -19.217  21.909  1.00 11.45          Nd
HETATM 6755  Nd  Nd  A5127       7.389 -14.736  13.689  0.79  9.38          Nd3+
HETATM 6756  Pm  Pm  A5128      -6.170   0.637  -4.572  1.00 11.33          Pm
HETATM 6757  Pm  Pm  A5129     -14.747   4.266  34.323  0.70  7.31          Pm3+
HETATM 6758  Sm  Sm  A5130      10.579  11.382  21.519  1.00  8.24          Sm
HETATM 6759  Sm  Sm  A5131     -19.700 -16.238  30.105  1.00  9.42          Sm3+
HETATM 6760  Eu  Eu  A5132     -22.579 -14.695  17.219  1.00  9.41          Eu
HETATM 6761  Eu  Eu  A5133       0.431  22.503  15.354  1.00 10.83          Eu2+
HETATM 6762  Eu  Eu  A5134       3.775  -0.454   4.787  1.00 10.46          Eu3+
HETATM 6763  Gd  Gd  A5135       8.736 -13.435   3.171  0.70  7.33          Gd
HETATM 6764  Gd  Gd  A5136       0.738  -6.147  26.648  0.60  5.75          Gd3+
HETATM 6765  Tb  Tb  A5137       1.394 -23.570  -0.951  0.70  9.59          Tb
HETATM 6766  Tb  Tb  A5138     -19.678   6.552  16.380  1.00  9.94          Tb3+
HETATM 6767  Dy  Dy  A5139      -2.871 -28.584  20.001  1.00  9.75          Dy
HETATM 6768  Dy  Dy  A5140     -13.866  27.937  31.785  1.00 11.94          Dy3+
HETATM 6769  Ho  Ho  A5141       3.567  -2.449   6.680  1.00 10.18          Ho
HETATM 6770  Ho  Ho  A5142      -9.008 -27.341   6.794  1.00 12.93          Ho3+
HETATM 6771  Er  Er  A5143     -23.728  12.240  13.099  0.60  8.45          Er
HETATM 6772  Er  Er  A5144     -11.400 -26.489   5.781  1.00 10.82          Er3+
HETATM 6773  Tm  Tm  A5145       0.539   8.340   4.707  1.00 11.51          Tm
HETATM 6774  Tm  Tm  A5146      -4.464 -31.333   4.295  1.00 14.23          Tm3+
HETATM 6775  Yb  Yb  A5147       1.679 -13.251  26.060  1.00 10.97          Yb
HETATM 6776  Yb  Yb  A5148      16.068   6.165   7.249  1.00  9.59          Yb2+
HETATM 6777  Yb  Yb  A5149     -12.354  -3.161  29.667  1.00 10.37          Yb3+
HETATM 6778  Lu  Lu  A5150      -3.325  -9.756  -6.517  1.00 13.33          Lu
HETATM 6779  Lu  Lu  A5151      -0.150  -0.784  -3.769  1.00 11.21          Lu3+
HETATM 6780  Hf  Hf  A5152       0.864 -27.670  20.944  1.00 13.15          Hf
HETATM 6781  Hf  Hf  A5153       5.277  14.822   9.726  0.80  8.80          Hf4+
HETATM 6782  Ta  Ta  A5154      -0.920  25.709  32.136  1.00 12.95          Ta
HETATM 6783  Ta  Ta  A5155      -7.440  14.897  39.637  1.00 13.70          Ta5+
HETATM 6784   W   W  A5156      -1.897  16.311   9.508  0.30  8.01           W
HETATM 6785   W   W  A5157       9.876  -7.712  22.676  0.70 12.19           W6+
HETATM 6786  Re  Re  A5158       7.075  23.333  22.508  1.00 10.79          Re
HETATM 6787  Os  Os  A5159      -3.347  13.709   3.688  0.80 12.93          Os
HETATM 6788  Os  Os  A5160       4.584  25.908  28.447  0.70 11.73          Os4+
HETATM 6789  Ir  Ir  A5161     -10.135  14.821  39.519  1.00 12.17          Ir
HETATM 6790  Ir  Ir  A5162       7.822  15.920  12.630  0.80 11.10          Ir3+
HETATM 6791  Ir  Ir  A5163     -15.533  -9.718  -4.075  1.00 13.25          Ir4+
HETATM 6792  Pt  Pt  A5164     -21.586  15.788  20.362  1.00 12.26          Pt
HETATM 6793  Pt  Pt  A5165       1.617 -10.551  25.406  0.60  6.76          Pt2+
HETATM 6794  Pt  Pt  A5166       2.331  15.845  10.907  1.00 12.82          Pt4+
HETATM 6795  Au  Au  A5167     -20.388  24.283  25.576  0.80 10.02          Au
HETATM 6796  Au  Au  A5168     -16.045 -22.074  21.225  0.80  9.72          Au1+
HETATM 6797  Au  Au  A5169       0.061  -9.313  -3.705  1.00 11.60          Au3+
HETATM 6798  Hg  Hg  A5170       7.492 -17.244  12.425  1.00 13.30          Hg
HETATM 6799  Hg  Hg  A5171     -19.752   9.771  34.130  0.60  7.87          Hg1+
HETATM 6800  Hg  Hg  A5172       8.647 -12.463  12.618  0.76  9.72          Hg2+
HETATM 6801  Tl  Tl  A5173       3.978   9.179  37.165  1.00 13.43          Tl
HETATM 6802  Tl  Tl  A5174     -17.402  22.538  31.902  1.00 14.63          Tl1+
HETATM 6803  Tl  Tl  A5175       6.354  18.018  31.924  1.00 10.88          Tl3+
HETATM 6804  Pb  Pb  A5176       1.089  19.502  35.743  0.80  9.96          Pb
HETATM 6805  Pb  Pb  A5177      -0.157  11.746  38.584  1.00 11.69          Pb2+
HETATM 6806  Pb  Pb  A5178      -2.909   7.593  -2.014  1.00 11.66          Pb4+
HETATM 6807  Bi  Bi  A5179       8.977  13.583  13.488  0.86  7.85          Bi
HETATM 6808  Bi  Bi  A5180       6.665 -23.693  10.766  1.00 12.76          Bi3+
HETATM 6809  Bi  Bi  A5181     -11.604   1.117  -0.345  1.00 12.54          Bi5+
HETATM 6810  Po  Po  A5182     -17.302   0.369  30.581  1.00 10.82          Po
HETATM 6811  At  At  A5183     -19.659 -11.610  29.687  1.00 11.09          At
HETATM 6812  Rn  Rn  A5184      -3.968   1.929  -3.764  1.00 12.35          Rn
HETATM 6813  Fr  Fr  A5185      11.407 -18.267  17.735  1.00 12.98          Fr
HETATM 6814  Ra  Ra  A5186       5.397  25.468  22.317  1.00 12.46          Ra
HETATM 6815  Ra  Ra  A5187      -4.717   4.208  -2.299  0.60 11.91          Ra2+
HETATM 6816  Ac  Ac  A5188     -24.859  13.594  20.904  0.80 10.07          Ac
HETATM 6817  Ac  Ac  A5189      -0.525 -29.946  20.292  1.00 11.70          Ac3+
HETATM 6818  Th  Th  A5190     -24.085 -10.808  12.682  0.80  9.23          Th
HETATM 6819  Th  Th  A5191       2.450  17.612  37.060  1.00 14.59          Th4+
HETATM 6820  Pa  Pa  A5192      -8.704  -4.915  31.699  0.90  9.67          Pa
HETATM 6821   U   U  A5193      -4.418 -30.056  18.178  0.60  5.84           U
HETATM 6822   U   U  A5194      -2.425  -5.196  -4.808  1.00 14.11           U3+
HETATM 6823   U   U  A5195     -16.770  28.630  18.033  1.00 13.65           U4+
HETATM 6824   U   U  A5196     -17.157  23.223  16.403  0.70 11.62           U6+
HETATM 6825  Np  Np  A5197     -17.100 -11.582  -2.706  1.00 14.26          Np
HETATM 6826  Np  Np  A5198       4.790   5.726  -0.392  0.50 14.83          Np3+
HETATM 6827  Np  Np  A5199       0.569  27.671  27.800  1.00 16.07          Np4+
HETATM 6828  Np  Np  A5200       5.999  -4.767  -2.338  0.60  8.51          Np6+
HETATM 6829  Pu  Pu  A5201     -15.871  26.197  30.725  1.00 15.27          Pu
HETATM 6830  Pu  Pu  A5202       6.613  -0.513  20.819  1.00 14.76          Pu3+
HETATM 6831  Pu  Pu  A5203     -15.579  -3.630  26.346  0.70  7.25          Pu4+
HETATM 6832  Pu  Pu  A5204      -2.469   7.614  37.998  1.00 15.95          Pu6+
HETATM 6833  Am  Am  A5205     -23.621  -8.303  15.805  0.80  9.45          Am
HETATM 6834  Cm  Cm  A5206     -19.652  -9.388  23.334  0.80 16.78          Cm
HETATM 6835  Bk  Bk  A5207     -21.063 -13.891  29.633  0.69  9.58          Bk
HETATM 6836  Cf  Cf  A5208       6.155 -19.205   4.041  1.00 13.10          Cf
"""

pdb_str_2 = """
CRYST1   15.167   14.392   12.685  90.00  90.00  90.00 P 1
SCALE1      0.065933  0.000000  0.000000        0.00000
SCALE2      0.000000  0.069483  0.000000        0.00000
SCALE3      0.000000  0.000000  0.078833        0.00000
ATOM     70  N   GLU A 131      84.638 135.033  68.928  1.00204.16           N
ATOM     71  CA  GLU A 131      84.231 134.007  69.881  1.00204.16           C
ATOM     72  C   GLU A 131      83.568 134.620  71.099  1.00204.16           C
ATOM     73  O   GLU A 131      82.575 134.096  71.613  1.00204.16           O
ATOM     74  CB  GLU A 131      85.437 133.189  70.332  1.00204.16           C
ATOM     75  CG  GLU A 131      86.031 132.285  69.302  1.00204.16           C
ATOM     76  CD  GLU A 131      87.218 131.539  69.858  1.00204.16           C
ATOM     77  OE1 GLU A 131      87.626 131.851  70.997  1.00204.16           O
ATOM     78  OE2 GLU A 131      87.742 130.641  69.167  1.00204.16           O1-
"""

if (__name__ == "__main__"):
  t0 = time.time()
  run_tst_xrs_and_hierarchy()
  run_tst_grm_after_neutralize_scatterers()
  tst_003()
  tst_004()
  tst_005()
  print("OK. Time:", round(time.time()-t0, 2))


 *******************************************************************************


 *******************************************************************************
mmtbx/regression/model/tst_model_ramachandran.py
from __future__ import absolute_import, division, print_function
import mmtbx.model
import iotbx.pdb

from mmtbx.geometry_restraints.ramachandran import master_phil

from tst_model_remove_alternative_conformations import tst_pdb_str

def exercise_1(prefix="tst_model_ramachandran_1"):
  """ Make sure that set_ramachandran_plot_restraints() works. """
  inp = iotbx.pdb.input(lines=tst_pdb_str, source_info=None)
  model = mmtbx.model.manager(
      model_input = inp)
  model.process(make_restraints=True)
  rama_params = master_phil.fetch().extract().ramachandran_plot_restraints
  rama_params.favored = 'oldfield'
  rama_params.allowed = 'oldfield'
  rama_params.outlier = 'oldfield'
  model.set_ramachandran_plot_restraints(rama_params=rama_params)
  model.process(make_restraints=True)
  n = model.get_restraints_manager().geometry.ramachandran_manager.get_n_oldfield_proxies()
  assert n == 2

  rama_params.favored = 'emsley'
  rama_params.allowed = 'emsley'
  rama_params.outlier = 'emsley'
  model.set_ramachandran_plot_restraints(rama_params=rama_params)
  model.process(make_restraints=True)
  n = model.get_restraints_manager().geometry.ramachandran_manager.get_n_emsley_proxies()
  assert n == 2

if __name__ == '__main__':
  exercise_1()


 *******************************************************************************


 *******************************************************************************
mmtbx/regression/model/tst_model_remove_alternative_conformations.py
from __future__ import absolute_import, division, print_function
import mmtbx.model
import iotbx.pdb
from libtbx.test_utils import show_diff

tst_pdb_str = """\
ATOM  18920  N   PHE L   2     201.672 235.270 272.436  1.00 33.60           N
ATOM  18921  CA  PHE L   2     201.753 236.596 271.840  1.00 33.60           C
ATOM  18922  C   PHE L   2     200.597 237.520 272.192  1.00 33.60           C
ATOM  18923  O   PHE L   2     200.835 238.721 272.367  1.00 33.60           O
ATOM  18924  CB  PHE L   2     201.883 236.467 270.321  1.00 32.90           C
ATOM  18925  CG  PHE L   2     201.850 237.775 269.616  1.00 32.90           C
ATOM  18926  CD1 PHE L   2     202.865 238.689 269.797  1.00 32.90           C
ATOM  18927  CD2 PHE L   2     200.820 238.083 268.748  1.00 32.90           C
ATOM  18928  CE1 PHE L   2     202.829 239.908 269.166  1.00 32.90           C
ATOM  18929  CE2 PHE L   2     200.799 239.290 268.089  1.00 32.90           C
ATOM  18930  CZ  PHE L   2     201.803 240.201 268.300  1.00 32.90           C
ATOM  18931  N   SER L   3     199.357 236.979 272.328  1.00 34.28           N
ATOM  18932  C   SER L   3     197.907 238.857 271.631  1.00 34.28           C
ATOM  18933  O   SER L   3     198.129 240.024 271.974  1.00 34.28           O
ATOM  18934  CA ASER L   3     198.124 237.714 272.618  0.50 34.28           C
ATOM  18935  CB ASER L   3     198.121 238.241 274.053  0.50 35.83           C
ATOM  18936  OG ASER L   3     198.875 239.432 274.158  0.50 35.83           O
ATOM  18937  CA BSER L   3     198.130 237.722 272.621  0.50 34.28           C
ATOM  18938  CB BSER L   3     198.142 238.287 274.041  0.50 35.83           C
ATOM  18939  OG BSER L   3     197.037 239.151 274.236  0.50 35.83           O
ATOM  18940  N   PRO L   4     197.482 238.564 270.395  1.00 33.41           N
ATOM  18941  CA  PRO L   4     197.440 239.596 269.355  1.00 33.41           C
ATOM  18942  C   PRO L   4     196.353 240.646 269.519  1.00 33.41           C
ATOM  18943  O   PRO L   4     196.212 241.494 268.633  1.00 33.41           O
ATOM  18944  CB  PRO L   4     197.209 238.776 268.079  1.00 33.14           C
ATOM  18945  CG  PRO L   4     196.474 237.597 268.538  1.00 33.14           C
ATOM  18946  CD  PRO L   4     197.000 237.268 269.901  1.00 33.14           C
"""

def exercise_1(prefix="tst_model_remove_alternative_conformations_1"):
  """ Make sure that CA in SER3 gets to the right position. """
  inp = iotbx.pdb.input(lines=tst_pdb_str, source_info=None)
  model = mmtbx.model.manager(
      model_input = inp)
  model.remove_alternative_conformations(always_keep_one_conformer=False)
  assert not show_diff(model.model_as_pdb(), """\
ATOM      1  N   PHE L   2     201.672 235.270 272.436  1.00 33.60           N
ATOM      2  CA  PHE L   2     201.753 236.596 271.840  1.00 33.60           C
ATOM      3  C   PHE L   2     200.597 237.520 272.192  1.00 33.60           C
ATOM      4  O   PHE L   2     200.835 238.721 272.367  1.00 33.60           O
ATOM      5  CB  PHE L   2     201.883 236.467 270.321  1.00 32.90           C
ATOM      6  CG  PHE L   2     201.850 237.775 269.616  1.00 32.90           C
ATOM      7  CD1 PHE L   2     202.865 238.689 269.797  1.00 32.90           C
ATOM      8  CD2 PHE L   2     200.820 238.083 268.748  1.00 32.90           C
ATOM      9  CE1 PHE L   2     202.829 239.908 269.166  1.00 32.90           C
ATOM     10  CE2 PHE L   2     200.799 239.290 268.089  1.00 32.90           C
ATOM     11  CZ  PHE L   2     201.803 240.201 268.300  1.00 32.90           C
ATOM     12  N   SER L   3     199.357 236.979 272.328  1.00 34.28           N
ATOM     13  CA  SER L   3     198.124 237.714 272.618  1.00 34.28           C
ATOM     14  C   SER L   3     197.907 238.857 271.631  1.00 34.28           C
ATOM     15  O   SER L   3     198.129 240.024 271.974  1.00 34.28           O
ATOM     16  CB  SER L   3     198.121 238.241 274.053  1.00 35.83           C
ATOM     17  OG  SER L   3     198.875 239.432 274.158  1.00 35.83           O
ATOM     18  N   PRO L   4     197.482 238.564 270.395  1.00 33.41           N
ATOM     19  CA  PRO L   4     197.440 239.596 269.355  1.00 33.41           C
ATOM     20  C   PRO L   4     196.353 240.646 269.519  1.00 33.41           C
ATOM     21  O   PRO L   4     196.212 241.494 268.633  1.00 33.41           O
ATOM     22  CB  PRO L   4     197.209 238.776 268.079  1.00 33.14           C
ATOM     23  CG  PRO L   4     196.474 237.597 268.538  1.00 33.14           C
ATOM     24  CD  PRO L   4     197.000 237.268 269.901  1.00 33.14           C
TER
END
""")

if __name__ == '__main__':
  exercise_1()


 *******************************************************************************


 *******************************************************************************
mmtbx/regression/model/tst_model_set_hydrogen_bond_length.py
from __future__ import absolute_import, division, print_function
import time, sys
import mmtbx.model
import iotbx.pdb
from libtbx.utils import null_out
from libtbx.test_utils import approx_equal
from scitbx.array_family import flex

def compare_XH_bond_length_to_ideal(model):
  geometry = model.get_restraints_manager().geometry
  atoms = model.get_hierarchy().atoms()
  sites_cart = model.get_sites_cart()
  bond_proxies_simple, asu = \
    geometry.get_all_bond_proxies(sites_cart = sites_cart)
  hd_selection = model.get_hd_selection()
  for bp in bond_proxies_simple:
    i, j = bp.i_seqs
    if hd_selection[i] or hd_selection[j]:
      assert approx_equal(atoms[i].distance(atoms[j]),
                          bp.distance_ideal,
                          eps=0.001)
def get_dist(s1, s2):
  return flex.sqrt((s1 - s2).dot())

def tst_0():
  """
  Check going back and forth does not accumulate errors.
  Also, confirm: the change cannot be undone.
  """
  pdb_inp = iotbx.pdb.input(lines=pdb_str1, source_info=None)
  model = mmtbx.model.manager(
    model_input = pdb_inp,
    log         = null_out())
  sites_cart_o = model.get_sites_cart()
  model.set_hydrogen_bond_length(
    use_neutron_distances=True, show=False, log=null_out)
  sites_cart_n = model.get_sites_cart()
  model.set_hydrogen_bond_length(
    use_neutron_distances=False, show=False, log=null_out)
  sites_cart_x = model.get_sites_cart()
  dist_mean = flex.mean(get_dist(sites_cart_n, sites_cart_x))
  assert dist_mean > 0.07
  #
  model.set_hydrogen_bond_length(
    use_neutron_distances=True, show=False, log=null_out)
  sites_cart_n1 = model.get_sites_cart()
  dist_mean = flex.mean(get_dist(sites_cart_n, sites_cart_n1))
  assert approx_equal(dist_mean, 0)
  #
  model.set_hydrogen_bond_length(
    use_neutron_distances=False, show=False, log=null_out)
  sites_cart_x1 = model.get_sites_cart()
  dist_mean = flex.mean(get_dist(sites_cart_x, sites_cart_x1))
  assert approx_equal(dist_mean, 0)
  # This is irreversible
  for sites_cart in [sites_cart_n, sites_cart_n1, sites_cart_x, sites_cart_x1]:
    dist_mean = flex.mean(get_dist(sites_cart, sites_cart_o))
    assert dist_mean > 0.005

#-------------------------------------------------------------------------------

def tst_1():
  '''
  input model: bond lengths close to neutron but not quite
  input grm: neutron bond lengths
  '''
  pdb_inp = iotbx.pdb.input(lines=pdb_str1.split("\n"), source_info=None)
  params = mmtbx.model.manager.get_default_pdb_interpretation_params()
  params.pdb_interpretation.use_neutron_distances = True
  model = mmtbx.model.manager(
    model_input = pdb_inp,
    log         = null_out())
  model.process(pdb_interpretation_params=params,
    make_restraints=True)
  # request neutron bond lengths
  model.set_hydrogen_bond_length(use_neutron_distances=True,
                                 show=False,
                                 log=sys.stdout)
  compare_XH_bond_length_to_ideal(model = model)
  #STOP()
  # request X-ray bond lengths
  pdb_inp = iotbx.pdb.input(lines=pdb_str1.split("\n"), source_info=None)
  model = mmtbx.model.manager(
    model_input = pdb_inp,
    log         = null_out())
  model.process(pdb_interpretation_params=params, make_restraints=False)
  model.set_hydrogen_bond_length(use_neutron_distances=False,
                                 show=False,
                                 log=sys.stdout)
  compare_XH_bond_length_to_ideal(model = model)
#-------------------------------------------------------------------------------

def tst_2():
  '''
  input model: bond lengths close to neutron but not quite
  input grm: X-ray bond lengths
  '''
  pdb_inp = iotbx.pdb.input(lines=pdb_str1.split("\n"), source_info=None)
  params = mmtbx.model.manager.get_default_pdb_interpretation_params()
  params.pdb_interpretation.use_neutron_distances = False
  model = mmtbx.model.manager(
    model_input = pdb_inp,
    log         = null_out())
  model.process(pdb_interpretation_params = params)
  #
  # Check if selected individual bond lengths are correct
  atoms = model.get_hierarchy().atoms()
  assert (atoms[4].id_str() == 'pdb=" CB  ARG A  74 "')
  assert (atoms[18].id_str() == 'pdb=" HB2 ARG A  74 "')
  assert approx_equal(atoms[4].distance(atoms[18]), 1.08, eps = 0.005)
  assert (atoms[10].id_str() == 'pdb=" NH2 ARG A  74 "')
  assert (atoms[15].id_str() == 'pdb="DH21 ARG A  74 "')
  assert approx_equal(atoms[10].distance(atoms[15]), 0.99, eps = 0.005)
  # request neutron bond lengths
  model.set_hydrogen_bond_length(use_neutron_distances=True,
                                 show=False,
                                 log=sys.stdout)
  # Check if bond lengths are equal to ideal
  compare_XH_bond_length_to_ideal(model = model)
  # Check if selected individual bond lengths are correct
  atoms = model.get_hierarchy().atoms()
  assert approx_equal(atoms[4].distance(atoms[18]), 1.09, eps = 0.005)
  assert approx_equal(atoms[10].distance(atoms[15]), 1.02, eps = 0.005)
  # request X-ray bond lengths
  model.set_hydrogen_bond_length(use_neutron_distances=False,
                                 show=False,
                                 log=sys.stdout)
  compare_XH_bond_length_to_ideal(model = model)
  # Check if selected individual bond lengths are correct
  atoms = model.get_hierarchy().atoms()
  assert approx_equal(atoms[4].distance(atoms[18]), 0.97, eps = 0.005)
  assert approx_equal(atoms[10].distance(atoms[15]), 0.86, eps = 0.005)

#-------------------------------------------------------------------------------

def tst_3():
  '''
  Test if the modification works also when cif_objects are supplied
  (meaning there is a ligand cif file)
  '''
  pdb_inp = iotbx.pdb.input(lines=pdb_str2.split("\n"), source_info=None)
  cif_object = iotbx.cif.reader(input_string = cif_str2).model()
  # bla.cif does not exist, but cif_objects needs a filename in first position
  # of the tuple
  cif_objects = [('bla.cif', cif_object)]
  params = mmtbx.model.manager.get_default_pdb_interpretation_params()
  params.pdb_interpretation.use_neutron_distances = False
  model = mmtbx.model.manager(
    model_input = pdb_inp,
    restraint_objects = cif_objects,
    log         = null_out())
  model.process(pdb_interpretation_params = params)
  # request neutron bond lengths
  model.set_hydrogen_bond_length(use_neutron_distances=True,
                                 show=False,
                                 log=sys.stdout)
  compare_XH_bond_length_to_ideal(model = model)
  # request X-ray bond lengths
  model.set_hydrogen_bond_length(use_neutron_distances=False,
                                 show=False,
                                 log=sys.stdout)
  compare_XH_bond_length_to_ideal(model = model)

#-------------------------------------------------------------------------------
pdb_str1 = """
CRYST1   17.692   14.832   14.146  90.00  90.00  90.00 P 1
SCALE1      0.056523  0.000000  0.000000        0.00000
SCALE2      0.000000  0.067422  0.000000        0.00000
SCALE3      0.000000  0.000000  0.070691        0.00000
ATOM      1  N   ARG A  74       5.000   7.873   6.729  1.00 26.20           N
ATOM      2  CA  ARG A  74       6.196   8.078   7.547  1.00 25.89           C
ATOM      3  C   ARG A  74       6.284   9.534   7.986  1.00 24.08           C
ATOM      4  O   ARG A  74       6.576   9.832   9.146  1.00 23.39           O
ATOM      5  CB  ARG A  74       7.477   7.738   6.773  1.00 28.75           C
ATOM      6  CG  ARG A  74       7.718   6.268   6.516  1.00 33.03           C
ATOM      7  CD  ARG A  74       9.095   6.031   5.871  1.00 36.08           C
ATOM      8  NE  ARG A  74      10.208   6.328   6.778  1.00 37.90           N
ATOM      9  CZ  ARG A  74      11.051   7.351   6.639  1.00 38.74           C
ATOM     10  NH1 ARG A  74      10.896   8.234   5.654  1.00 38.21           N
ATOM     11  NH2 ARG A  74      12.056   7.493   7.500  1.00 38.01           N
ATOM     12  D   ARG A  74       5.091   7.539   5.816  0.81 26.33           D
ATOM     13  DE  ARG A  74      10.345   5.711   7.532  0.24 37.60           D
ATOM     14 DH11 ARG A  74      10.140   8.133   5.004  0.17 38.08           D
ATOM     15 DH12 ARG A  74      11.533   9.006   5.559  1.00 36.47           D
ATOM     16 DH21 ARG A  74      12.692   8.250   7.395  0.05 38.56           D
ATOM     17 DH22 ARG A  74      12.178   6.838   8.249  0.77 39.36           D
ATOM     18  HA  ARG A  74       6.132   7.447   8.424  1.00 26.28           H
ATOM     19  HB2 ARG A  74       7.441   8.242   5.818  1.00 29.24           H
ATOM     20  HB3 ARG A  74       8.320   8.122   7.334  1.00 28.50           H
ATOM     21  HG2 ARG A  74       7.669   5.728   7.450  1.00 33.30           H
ATOM     22  HG3 ARG A  74       6.953   5.908   5.849  1.00 32.25           H
ATOM     23  HD2 ARG A  74       9.163   5.000   5.580  1.00 36.76           H
ATOM     24  HD3 ARG A  74       9.184   6.659   5.000  1.00 36.58           H
"""
# i_seqs for X-H bonds
#0 11 pdb=" N   ARG A  74 " pdb=" D   ARG A  74 "
#1 17 pdb=" CA  ARG A  74 " pdb=" HA  ARG A  74 "
#4 18 pdb=" CB  ARG A  74 " pdb=" HB2 ARG A  74 "
#4 19 pdb=" CB  ARG A  74 " pdb=" HB3 ARG A  74 "
#5 20 pdb=" CG  ARG A  74 " pdb=" HG2 ARG A  74 "
#5 21 pdb=" CG  ARG A  74 " pdb=" HG3 ARG A  74 "
#6 22 pdb=" CD  ARG A  74 " pdb=" HD2 ARG A  74 "
#6 23 pdb=" CD  ARG A  74 " pdb=" HD3 ARG A  74 "
#7 12 pdb=" NE  ARG A  74 " pdb=" DE  ARG A  74 "
#9 13 pdb=" NH1 ARG A  74 " pdb="DH11 ARG A  74 "
#9 14 pdb=" NH1 ARG A  74 " pdb="DH12 ARG A  74 "
#10 15 pdb=" NH2 ARG A  74 " pdb="DH21 ARG A  74 "
#10 16 pdb=" NH2 ARG A  74 " pdb="DH22 ARG A  74 "


pdb_str2 = """
CRYST1   15.938   15.073   11.550  90.00  90.00  90.00 P 1
SCALE1      0.062743  0.000000  0.000000        0.00000
SCALE2      0.000000  0.066344  0.000000        0.00000
SCALE3      0.000000  0.000000  0.086580        0.00000
HETATM    1  C1  3HA   401       7.842   9.143   5.222  1.00 83.17           C
HETATM    2  C2  3HA   401       7.240   7.911   5.459  1.00 81.93           C
HETATM    3  C3  3HA   401       8.027   6.770   5.589  1.00 82.00           C
HETATM    4  C4  3HA   401       9.411   6.864   5.486  1.00 82.52           C
HETATM    5  C5  3HA   401      10.012   8.097   5.252  1.00 83.82           C
HETATM    6  C6  3HA   401       9.226   9.238   5.118  1.00 84.24           C
HETATM    7  C7  3HA   401       5.719   7.834   5.619  1.00 81.09           C
HETATM    8  N10 3HA   401       7.463   5.583   5.793  1.00 82.31           N
HETATM    9  O11 3HA   401      10.183   5.752   5.619  1.00 82.09           O
HETATM   10  O8  3HA   401       5.197   6.868   6.174  1.00 81.05           O
HETATM   11  O9  3HA   401       5.000   8.734   5.190  1.00 78.80           O
HETATM   12  H1  3HA   401       7.315   9.910   5.134  1.00 83.17           H
HETATM   13  H11 3HA   401      10.719   5.854   6.276  1.00 82.09           H
HETATM   14  H5  3HA   401      10.938   8.151   5.134  1.00 83.82           H
HETATM   15  H6  3HA   401       9.630  10.073   5.000  1.00 84.24           H
HETATM   16 H101 3HA   401       7.572   5.175   6.550  1.00 82.31           H
HETATM   17 H102 3HA   401       7.435   5.000   5.152  1.00 82.31           H
TER
END
"""

cif_str2 = """
#
data_comp_list
loop_
_chem_comp.id
_chem_comp.three_letter_code
_chem_comp.name
_chem_comp.group
_chem_comp.number_atoms_all
_chem_comp.number_atoms_nh
_chem_comp.desc_level
3HA 3HA "Unknown                  " ligand 17 11 .
#
data_comp_3HA
#
loop_
_chem_comp_atom.comp_id
_chem_comp_atom.atom_id
_chem_comp_atom.type_symbol
_chem_comp_atom.type_energy
_chem_comp_atom.charge
_chem_comp_atom.partial_charge
_chem_comp_atom.x
_chem_comp_atom.y
_chem_comp_atom.z
3HA        O8      O   OC    -1 .         -2.5304   -0.3544    2.0294
3HA        C7      C   C      0 .         -1.2760   -0.4611    2.0390
3HA        O9      O   O      0 .         -0.6571   -0.5146    3.1342
3HA        C2      C   CR6    0 .         -0.5023   -0.4939    0.7224
3HA        C1      C   CR16   0 .         -0.2734   -1.7018    0.0834
3HA        C6      C   CR16   0 .          0.4107   -1.7296   -1.1210
3HA        C5      C   CR16   0 .          0.8659   -0.5495   -1.6865
3HA        C4      C   CR6    0 .          0.6370    0.6583   -1.0475
3HA        O11     O   OH1    0 .          1.1017    1.8508   -1.6167
3HA        C3      C   CR6    0 .         -0.0471    0.6861    0.1569
3HA        N10     N   NH2    0 .         -0.3039    1.9536    0.8168
3HA        H1      H   HCR6   0 .         -0.6294   -2.6246    0.5256
3HA        H6      H   HCR6   0 .          0.5887   -2.6740   -1.6213
3HA        H5      H   HCR6   0 .          1.4009   -0.5713   -2.6283
3HA        H11     H   HOH1   0 .          2.0033    1.7449   -1.8770
3HA        H101    H   HNH2   0 .          0.0644    2.1253    1.7332
3HA        H102    H   HNH2   0 .         -0.8528    2.6556    0.3576
#
loop_
_chem_comp_bond.comp_id
_chem_comp_bond.atom_id_1
_chem_comp_bond.atom_id_2
_chem_comp_bond.type
_chem_comp_bond.value_dist
_chem_comp_bond.value_dist_esd
_chem_comp_bond.value_dist_neutron
3HA  O8      C7     deloc         1.259 0.020     1.259
3HA  C7      O9     deloc         1.259 0.020     1.259
3HA  C7      C2     single        1.527 0.020     1.527
3HA  C2      C1     aromatic      1.386 0.020     1.386
3HA  C2      C3     aromatic      1.385 0.020     1.385
3HA  C1      C6     aromatic      1.385 0.020     1.385
3HA  C1      H1     single        0.930 0.020     1.080
3HA  C6      C5     aromatic      1.385 0.020     1.385
3HA  C6      H6     single        0.930 0.020     1.080
3HA  C5      C4     aromatic      1.385 0.020     1.385
3HA  C5      H5     single        0.930 0.020     1.080
3HA  C4      O11    single        1.401 0.020     1.401
3HA  C4      C3     aromatic      1.385 0.020     1.385
3HA  O11     H11    single        0.850 0.020     0.980
3HA  C3      N10    single        1.452 0.020     1.452
3HA  N10     H101   single        0.860 0.020     1.020
3HA  N10     H102   single        0.860 0.020     1.020
#
loop_
_chem_comp_angle.comp_id
_chem_comp_angle.atom_id_1
_chem_comp_angle.atom_id_2
_chem_comp_angle.atom_id_3
_chem_comp_angle.value_angle
_chem_comp_angle.value_angle_esd
3HA  C2      C7      O9           120.00 3.000
3HA  C2      C7      O8           119.99 3.000
3HA  O9      C7      O8           120.00 3.000
3HA  C3      C2      C1           120.00 3.000
3HA  C3      C2      C7           120.00 3.000
3HA  C1      C2      C7           120.00 3.000
3HA  H1      C1      C6           120.00 3.000
3HA  H1      C1      C2           120.00 3.000
3HA  C6      C1      C2           120.00 3.000
3HA  H6      C6      C5           120.00 3.000
3HA  H6      C6      C1           120.00 3.000
3HA  C5      C6      C1           120.00 3.000
3HA  H5      C5      C4           120.00 3.000
3HA  H5      C5      C6           120.00 3.000
3HA  C4      C5      C6           120.00 3.000
3HA  C3      C4      O11          120.00 3.000
3HA  C3      C4      C5           120.00 3.000
3HA  O11     C4      C5           120.00 3.000
3HA  H11     O11     C4           109.47 3.000
3HA  N10     C3      C4           120.00 3.000
3HA  N10     C3      C2           120.00 3.000
3HA  C4      C3      C2           120.00 3.000
3HA  H102    N10     H101         120.00 3.000
3HA  H102    N10     C3           120.00 3.000
3HA  H101    N10     C3           120.00 3.000
#
loop_
_chem_comp_tor.comp_id
_chem_comp_tor.id
_chem_comp_tor.atom_id_1
_chem_comp_tor.atom_id_2
_chem_comp_tor.atom_id_3
_chem_comp_tor.atom_id_4
_chem_comp_tor.value_angle
_chem_comp_tor.value_angle_esd
_chem_comp_tor.period
3HA CONST_01      C5      C6      C1      C2             0.00   0.0 0
3HA CONST_02      C5      C4      C3      C2             0.00   0.0 0
3HA CONST_03      C4      C3      C2      C1            -0.00   0.0 0
3HA CONST_04      C4      C5      C6      C1            -0.00   0.0 0
3HA CONST_05      C3      C2      C1      C6             0.00   0.0 0
3HA CONST_06      C3      C4      C5      C6             0.00   0.0 0
3HA CONST_07      C6      C1      C2      C7           179.02   0.0 0
3HA CONST_08      C4      C3      C2      C7          -179.02   0.0 0
3HA CONST_09      O11     C4      C3      C2          -179.76   0.0 0
3HA CONST_10      N10     C3      C2      C1           179.11   0.0 0
3HA CONST_11      O11     C4      C5      C6           179.76   0.0 0
3HA CONST_12      N10     C3      C4      C5          -179.11   0.0 0
3HA CONST_13      H6      C6      C1      C2          -179.93   0.0 0
3HA CONST_14      H5      C5      C6      C1           180.00   0.0 0
3HA CONST_15      H1      C1      C6      C5          -180.00   0.0 0
3HA CONST_16      H101    N10     C3      C2            61.62   0.0 0
3HA CONST_17      H102    N10     C3      C2          -118.12   0.0 0
3HA Var_01        C1      C2      C7      O8           -88.86  30.0 2
#
loop_
_chem_comp_plane_atom.comp_id
_chem_comp_plane_atom.plane_id
_chem_comp_plane_atom.atom_id
_chem_comp_plane_atom.dist_esd
3HA plan-1  C7     0.020
3HA plan-1  C2     0.020
3HA plan-1  C1     0.020
3HA plan-1  C6     0.020
3HA plan-1  C5     0.020
3HA plan-1  C4     0.020
3HA plan-1  O11    0.020
3HA plan-1  C3     0.020
3HA plan-1  N10    0.020
3HA plan-1  H1     0.020
3HA plan-1  H6     0.020
3HA plan-1  H5     0.020
3HA plan-2  C3     0.020
3HA plan-2  N10    0.020
3HA plan-2  H101   0.020
3HA plan-2  H102   0.020
3HA plan-3  O8     0.020
3HA plan-3  C7     0.020
3HA plan-3  O9     0.020
3HA plan-3  C2     0.020
"""

if (__name__ == "__main__"):
  t0 = time.time()
  tst_0()
  tst_1()
  tst_2()
  tst_3()
  print("OK. Time: %8.3f"%(time.time()-t0))


 *******************************************************************************


 *******************************************************************************
mmtbx/regression/model/tst_model_symmetry.py
from __future__ import absolute_import, division, print_function
import mmtbx.model
import iotbx.pdb
from libtbx.utils import format_cpu_times

pdb_str_1 = """\
CRYST1   10.000   10.000   10.000  90.00  90.00  90.00 P 1
ATOM      1   N  ILE A  40       1.000   1.000   1.000  1.00162.33           C
ATOM      2  CA  LEU A  40      94.618  -5.253  91.582  1.00 87.10           C
TER
"""
pdb_str_2 = """\
CRYST1   20.000   30.000   40.000  90.00  90.00  90.00 P 1 21 1
ATOM      1   N  ILE A  40       1.000   1.000   1.000  1.00162.33           C
ATOM      2  CA  LEU A  40      94.618  -5.253  91.582  1.00 87.10           C
TER
"""
pdb_str_3= """\
CRYST1   40.000   40.000   60.000  90.00  90.00  90.00 I 4
ATOM      1   N  ILE A  40       1.000   1.000   1.000  1.00162.33           C
ATOM      2  CA  LEU A  40      94.618  -5.253  91.582  1.00 87.10           C
TER
"""


def exercise_symmetry():
  inp = iotbx.pdb.input(lines=pdb_str_1, source_info=None)
  a = mmtbx.model.manager(model_input=inp)
  inp = iotbx.pdb.input(lines=pdb_str_2, source_info=None)
  b = mmtbx.model.manager(model_input=inp)
  inp = iotbx.pdb.input(lines=pdb_str_3, source_info=None)
  c = mmtbx.model.manager(model_input=inp)
  c.set_unit_cell_crystal_symmetry(b.crystal_symmetry())
  c.set_shift_cart((23,1,7))

  print("A:",a.crystal_symmetry(),"A unit cell",a.unit_cell_crystal_symmetry())
  print("\nB:",b.crystal_symmetry(),"B unit cell:",
    b.unit_cell_crystal_symmetry())
  print("\nC:",c.crystal_symmetry(),"C unit cell:",
     c.unit_cell_crystal_symmetry())

  d = a.deep_copy()

  print('\nD:',d.crystal_symmetry(),"D unit cell:",
     d.unit_cell_crystal_symmetry())
  d.set_symmetry_and_shift_to_match_other(c)
  print('\nD matched to C:',d.crystal_symmetry(),
     "D matched to C unit cell:",d.unit_cell_crystal_symmetry())

  assert d.crystal_symmetry().is_similar_symmetry(c.crystal_symmetry())
  assert d.shift_cart() == c.shift_cart()
  assert d.unit_cell_crystal_symmetry().is_similar_symmetry(
     c.unit_cell_crystal_symmetry())

  assert not d.crystal_symmetry().is_similar_symmetry(a.crystal_symmetry())
  assert not a.unit_cell_crystal_symmetry()

def run():
  exercise_symmetry()
  print(format_cpu_times())

if (__name__ == "__main__"):
  run()


 *******************************************************************************


 *******************************************************************************
mmtbx/regression/model/tst_model_tors_ref_restraints.py
from __future__ import absolute_import, division, print_function
import mmtbx.model
import libtbx.load_env
from libtbx.utils import format_cpu_times
from libtbx.test_utils import approx_equal
import iotbx.pdb
from mmtbx.regression.model import tst_model_cart_ref_restraints


def exercise_adopting_ref_tors_restraints_h():
  params = mmtbx.model.manager.get_default_pdb_interpretation_params()
  params.pdb_interpretation.flip_symmetric_amino_acids=False
  inp_1 = iotbx.pdb.input(lines=tst_model_cart_ref_restraints.pdb_str_h, source_info=None)
  h_model = mmtbx.model.manager(model_input = inp_1)
  h_model.process(pdb_interpretation_params=params, make_restraints=True)

  inp_2 = iotbx.pdb.input(lines=tst_model_cart_ref_restraints.pdb_str, source_info=None)
  model = mmtbx.model.manager(model_input = inp_2)
  model.process(pdb_interpretation_params=params, make_restraints=True)
  params = mmtbx.model.manager.get_default_pdb_interpretation_params()
  params.pdb_interpretation.flip_symmetric_amino_acids=False
  params.reference_model.enabled=True
  params.reference_model.sigma = 2

  # case 1: big model adopting small model.
  h_model.set_reference_torsion_restraints(
      ref_model = model,
      params=params)
  assert h_model.get_restraints_manager().geometry.get_n_reference_dihedral_proxies() == 34
  reference_dihedral_proxies = h_model.get_restraints_manager().geometry.reference_dihedral_manager.reference_dihedral_proxies
  answer = [
[(1,   2,  9, 10), 171.515643141],
[(9,  10, 13, 14), -57.7746022999],
[(10, 13, 14, 15), -60.8369797925],
[(10, 11, 23, 24), -176.236177141],
[(23, 24, 27, 28), -176.840947675],
[(24, 27, 28, 29), 61.8839679236],
[(24, 25, 37, 38), 166.212120415],
[(37, 38, 41, 42), -164.6572256],
[(38, 41, 42, 43), -160.727030714],
[(41, 42, 43, 44), 54.0842898531],
[(38, 39, 54, 55), 173.187552548],
[(54, 55, 58, 59), -62.8213683054],
[(55, 58, 59, 60), 159.926433285],
[(58, 59, 60, 61), -72.3924878566],
[(55, 56, 71, 72), -176.726828257],
[(71, 72, 75, 76), -54.9041387187],
[(72, 75, 76, 77), -66.5778205786],
[(72, 73, 85, 86), -171.777645364],
[(85, 86, 89, 90), -60.9936732039],
[(86, 89, 90, 91), 91.6226963647],
[(91, 93, 95, 96), -179.330180577],
[(85, 86, 87, 97), 157.562627012],
[(0,   1,  2,  9), -162.221584042],
[(2,   9, 10, 11), -60.5820017501],
[(9,  10, 11, 23), 141.187189652],
[(11, 23, 24, 25), -119.250599331],
[(23, 24, 25, 37), 125.146913149],
[(25, 37, 38, 39), -126.159284697],
[(37, 38, 39, 54), 112.807868032],
[(39, 54, 55, 56), -114.975951407],
[(54, 55, 56, 71), 126.756425626],
[(56, 71, 72, 73), -116.419938986],
[(71, 72, 73, 85), 97.6949671859],
[(73, 85, 86, 87), -80.0636781782],
  ]

  for i, dp in enumerate(reference_dihedral_proxies):
    # print(dir(dp))
    # print(dp.i_seqs, dp.angle_ideal, answer[i][1])
    assert dp.i_seqs == answer[i][0]
    assert approx_equal(dp.angle_ideal, answer[i][1])
    assert approx_equal(dp.weight, 0.25)

  answer = [
[(1,   2,  4,  5), 171.515643141],
[(4,   5,  8,  9), -57.7746022999],
[(5,   8,  9, 10), -60.8369797925],
[(5,   6, 12, 13), -176.236177141],
[(12, 13, 16, 17), -176.840947675],
[(13, 16, 17, 18), 61.8839679236],
[(13, 14, 20, 21), 166.212120415],
[(20, 21, 24, 25), -164.6572256],
[(21, 24, 25, 26), -160.727030714],
[(24, 25, 26, 27), 54.0842898531],
[(21, 22, 29, 30), 173.187552548],
[(29, 30, 33, 34), -62.8213683054],
[(30, 33, 34, 35), 159.926433285],
[(33, 34, 35, 36), -72.3924878566],
[(30, 31, 38, 39), -176.726828257],
[(38, 39, 42, 43), -54.9041387187],
[(39, 42, 43, 44), -66.5778205786],
[(39, 40, 46, 47), -171.777645364],
[(46, 47, 50, 51), -60.9936732039],
[(47, 50, 51, 52), 91.6226963647],
[(52, 54, 56, 57), -179.330180577],
[(46, 47, 48, 58), 157.562627012],
[(0,   1,  2,  4), -162.221584042],
[(2,   4,  5,  6), -60.5820017501],
[(4,   5,  6, 12), 141.187189652],
[(6,  12, 13, 14), -119.250599331],
[(12, 13, 14, 20), 125.146913149],
[(14, 20, 21, 22), -126.159284697],
[(20, 21, 22, 29), 112.807868032],
[(22, 29, 30, 31), -114.975951407],
[(29, 30, 31, 38), 126.756425626],
[(31, 38, 39, 40), -116.419938986],
[(38, 39, 40, 46), 97.6949671859],
[(40, 46, 47, 48), -80.0636781782],
  ]
  params.reference_model.sigma = 4
  model.set_reference_torsion_restraints(
      ref_model = h_model,
      params=params)
  assert model.get_restraints_manager().geometry.get_n_reference_dihedral_proxies() == 34
  reference_dihedral_proxies = model.get_restraints_manager().geometry.reference_dihedral_manager.reference_dihedral_proxies
  for i, dp in enumerate(reference_dihedral_proxies):
    # print dp.i_seqs, dp.angle_ideal
    assert dp.i_seqs == answer[i][0]
    assert approx_equal(dp.angle_ideal, answer[i][1])
    assert approx_equal(dp.weight, 0.0625)

  # changing coords for every other atoms to modify torsion angles
  f = True
  for a in h_model.get_hierarchy().atoms():
    if f:
      a.xyz = (a.xyz[0]+0.5, a.xyz[1], a.xyz[2])
      f = False
    else:
      f = True
  new_targets = [
173.233628557,
-65.911305977,
-14.0162554531,
162.629939942,
-177.848862887,
84.054568441,
150.088700474,
-169.113940647,
-162.410889324,
98.509473131,
176.247405316,
-77.6303938113,
161.640293376,
-109.88499213,
-179.297617725,
-73.9436357254,
-5.54761865294,
154.179231454,
-58.3916258056,
89.6379144637,
-167.538405775,
155.271991752,
-168.005387354,
-38.998355844,
140.733342841,
-116.817012423,
131.119009065,
-122.898932369,
133.945203506,
-136.386148677,
113.946903271,
-102.742029233,
104.376893428,
-65.9529100865,
  ]
  h_model.set_sites_cart_from_hierarchy()
  model.set_reference_torsion_restraints(
      ref_model = h_model,
      params=params)
  assert model.get_restraints_manager().geometry.get_n_reference_dihedral_proxies() == 34
  reference_dihedral_proxies = model.get_restraints_manager().geometry.reference_dihedral_manager.reference_dihedral_proxies
  for i, dp in enumerate(reference_dihedral_proxies):
    # print dp.i_seqs, dp.angle_ideal
    assert dp.i_seqs == answer[i][0]
    assert approx_equal(dp.angle_ideal, new_targets[i])
    assert approx_equal(dp.weight, 0.0625)



def run():
  if (not libtbx.env.has_module("reduce")):
    print("Reduce not installed")
    return
  exercise_adopting_ref_tors_restraints_h()

  print(format_cpu_times())

if (__name__ == "__main__"):
  run()


 *******************************************************************************


 *******************************************************************************
mmtbx/regression/model/tst_model_utils_merge_models.py
from __future__ import absolute_import, division, print_function

from scitbx.array_family import flex
import iotbx.pdb
import mmtbx.model
from libtbx.utils import null_out
from libtbx.test_utils import show_diff
from mmtbx.model.utils import merge_models
import time

cryst_info = """\
CRYST1   21.937    4.866   23.477  90.00 107.08  90.00 P 1 21 1      2
ORIGX1      1.000000  0.000000  0.000000        0.00000
ORIGX2      0.000000  1.000000  0.000000        0.00000
ORIGX3      0.000000  0.000000  1.000000        0.00000
SCALE1      0.045585  0.000000  0.014006        0.00000
SCALE2      0.000000  0.205508  0.000000        0.00000
SCALE3      0.000000  0.000000  0.044560        0.00000
"""

cryst_info_2 = """\
CRYST1   21.937    5.866   23.477  90.00 107.08  90.00 P 1 21 1      2
ORIGX1      1.000000  0.000000  0.000000        0.00000
ORIGX2      0.000000  1.000000  0.000000        0.00000
ORIGX3      0.000000  0.000000  1.000000        0.00000
SCALE1      0.045585  0.000000  0.014006        0.00000
SCALE2      0.000000  0.205508  0.000000        0.00000
SCALE3      0.000000  0.000000  0.044560        0.00000
"""

pdb_str_1 = """\
ATOM      1  N   GLY A   1      -9.009   4.612   6.102  1.00 16.77           N
ATOM      2  CA  GLY A   1      -9.052   4.207   4.651  1.00 16.57           C
ATOM      3  C   GLY A   1      -8.015   3.140   4.419  1.00 16.16           C
ATOM      4  O   GLY A   1      -7.523   2.521   5.381  1.00 16.78           O
"""

pdb_str_2 = """\
ATOM      1  N   GLY B   1      -9.009   4.612   6.102  1.00 16.77           N
ATOM      2  CA  GLY B   1      -9.052   4.207   4.651  1.00 16.57           C
ATOM      3  C   GLY B   1      -8.015   3.140   4.419  1.00 16.16           C
ATOM      4  O   GLY B   1      -7.523   2.521   5.381  1.00 16.78           O
"""

pdb_str_2_1 = """\
ATOM      1  N   GLY C   1      -9.009   4.612   6.102  1.00 16.77           N
ATOM      2  CA  GLY C   1      -9.052   4.207   4.651  1.00 16.57           C
ATOM      3  C   GLY C   1      -8.015   3.140   4.419  1.00 16.16           C
ATOM      4  O   GLY C   1      -7.523   2.521   5.381  1.00 16.78           O
"""

pdb_str_3 = """\
MODEL        1
ATOM      1  N   GLY B   1      -9.009   4.612   6.102  1.00 16.77           N
ATOM      2  CA  GLY B   1      -9.052   4.207   4.651  1.00 16.57           C
ATOM      3  C   GLY B   1      -8.015   3.140   4.419  1.00 16.16           C
ATOM      4  O   GLY B   1      -7.523   2.521   5.381  1.00 16.78           O
TER
ENDMDL
MODEL        2
ATOM      1  N   GLY B   1      -9.009   4.612   6.102  1.00 16.77           N
ATOM      2  CA  GLY B   1      -9.052   4.207   4.651  1.00 16.57           C
ATOM      3  C   GLY B   1      -8.015   3.140   4.419  1.00 16.16           C
ATOM      4  O   GLY B   1      -7.523   2.521   5.381  1.00 16.78           O
TER
ENDMDL
"""

pdb_str_3_1 = """\
MODEL        1
ATOM      1  N   GLY C   1      -9.009   4.612   6.102  1.00 16.77           N
ATOM      2  CA  GLY C   1      -9.052   4.207   4.651  1.00 16.57           C
ATOM      3  C   GLY C   1      -8.015   3.140   4.419  1.00 16.16           C
ATOM      4  O   GLY C   1      -7.523   2.521   5.381  1.00 16.78           O
TER
ENDMDL
MODEL        2
ATOM      1  N   GLY D   1      -9.009   4.612   6.102  1.00 16.77           N
ATOM      2  CA  GLY D   1      -9.052   4.207   4.651  1.00 16.57           C
ATOM      3  C   GLY D   1      -8.015   3.140   4.419  1.00 16.16           C
ATOM      4  O   GLY D   1      -7.523   2.521   5.381  1.00 16.78           O
TER
ENDMDL
"""

pdb_str_4 = """\
ATOM      1  N   GLY A   1      -9.009   4.612   6.102  1.00 16.77           N
ATOM      2  CA  GLY A   1      -9.052   4.207   4.651  1.00 16.57           C
ATOM      3  CA  GLY A   1      -8.015   3.140   4.419  1.00 16.16           C
ATOM      4  O   GLY A   1      -7.523   2.521   5.381  1.00 16.78           O
"""

def tst_1():
  """
  testing assertions
  """
  m1 = mmtbx.model.manager(
      model_input = iotbx.pdb.input(lines=cryst_info+pdb_str_1, source_info=None),
      log = null_out())
  m2 = mmtbx.model.manager(
      model_input = iotbx.pdb.input(lines=cryst_info+pdb_str_2, source_info=None),
      log = null_out())
  m2_1 = mmtbx.model.manager(
      model_input = iotbx.pdb.input(lines=cryst_info_2+pdb_str_2, source_info=None),
      log = null_out())
  m2.process(make_restraints=True)
  m3 = mmtbx.model.manager(
      model_input = iotbx.pdb.input(lines=cryst_info+pdb_str_3, source_info=None),
      log = null_out())
  m4 = mmtbx.model.manager(
      model_input = iotbx.pdb.input(lines=cryst_info+pdb_str_4, source_info=None),
      log = null_out())

  try:
    new_model = merge_models([m1, m3])
  except AssertionError as e:
    assert not show_diff(str(e), """\
Cannot merge models that have differing numbers of hierarchy 'models'""")
  try:
    new_model = merge_models([m1, m2])
  except AssertionError as e:
    assert not show_diff(str(e), """\
Model #2 has GRM initialized.""")
  try:
    new_model = merge_models([m1, m2_1])
  except AssertionError as e:
    assert not show_diff(str(e), """\
Cannot merge models with different crystal symmetries (#2)""")
  try:
    new_model = merge_models([m1, m1])
  except AssertionError as e:
    assert not show_diff(str(e), """\
Duplicated chain ids are present.""")
  try:
    new_model = merge_models([m1, m4])
  except AssertionError as e:
    assert not show_diff(str(e), """\
Model #2 has erros: ['### ERROR: duplicate atom labels ###']""")

def tst_2():
  """
  Normal operation
  """
  answer = """\
CRYST1   21.937    4.866   23.477  90.00 107.08  90.00 P 1 21 1
SCALE1      0.045585  0.000000  0.014006        0.00000
SCALE2      0.000000  0.205508  0.000000        0.00000
SCALE3      0.000000  0.000000  0.044560        0.00000
ATOM      1  N   GLY A   1      -9.009   4.612   6.102  1.00 16.77           N
ATOM      2  CA  GLY A   1      -9.052   4.207   4.651  1.00 16.57           C
ATOM      3  C   GLY A   1      -8.015   3.140   4.419  1.00 16.16           C
ATOM      4  O   GLY A   1      -7.523   2.521   5.381  1.00 16.78           O
TER
ATOM      5  N   GLY B   1      -9.009   4.612   6.102  1.00 16.77           N
ATOM      6  CA  GLY B   1      -9.052   4.207   4.651  1.00 16.57           C
ATOM      7  C   GLY B   1      -8.015   3.140   4.419  1.00 16.16           C
ATOM      8  O   GLY B   1      -7.523   2.521   5.381  1.00 16.78           O
TER
END
"""
  m1 = mmtbx.model.manager(
      model_input = iotbx.pdb.input(lines=cryst_info+pdb_str_1, source_info=None),
      log = null_out())
  m2 = mmtbx.model.manager(
      model_input = iotbx.pdb.input(lines=cryst_info+pdb_str_2, source_info=None),
      log = null_out())
  new_model = merge_models([m1, m2])
  assert not show_diff(new_model.model_as_pdb(), answer)

  # make sure that new_model is detached from original models
  m1.get_hierarchy().atoms().set_b(flex.double([10]*4))
  m2.get_hierarchy().atoms().set_b(flex.double([20]*4))
  assert m1.get_hierarchy().atoms().extract_b() == flex.double([10]*4)
  assert m2.get_hierarchy().atoms().extract_b() == flex.double([20]*4)
  assert new_model.get_hierarchy().atoms().extract_b() == flex.double([16.77, 16.57, 16.16, 16.78]*2)
  # print(new_model.model_as_pdb())

def tst_3():
  """
  3 models
  """
  m1 = mmtbx.model.manager(
      model_input = iotbx.pdb.input(lines=cryst_info+pdb_str_1, source_info=None),
      log = null_out())
  m2 = mmtbx.model.manager(
      model_input = iotbx.pdb.input(lines=cryst_info+pdb_str_2, source_info=None),
      log = null_out())
  m3 = mmtbx.model.manager(
      model_input = iotbx.pdb.input(lines=cryst_info+pdb_str_2_1, source_info=None),
      log = null_out())
  new_model = merge_models([m1, m2, m3])
  assert len(new_model.get_hierarchy().only_model().chains()) == 3, len(new_model.get_hierarchy().only_model().chains())

def tst_4():
  """
  2 models with 2 hierarchy models
  """
  m1 = mmtbx.model.manager(
      model_input = iotbx.pdb.input(lines=cryst_info+pdb_str_3, source_info=None),
      log = null_out())
  m2 = mmtbx.model.manager(
      model_input = iotbx.pdb.input(lines=cryst_info+pdb_str_3_1, source_info=None),
      log = null_out())
  new_model = merge_models([m1, m2])
  assert len(new_model.get_hierarchy().models()) == 2
  assert len(new_model.get_hierarchy().models()[0].chains()) == 2
  assert len(new_model.get_hierarchy().models()[1].chains()) == 2
  assert [c.id for c in new_model.get_hierarchy().models()[0].chains()] == ['B', 'C']
  assert [c.id for c in new_model.get_hierarchy().models()[1].chains()] == ['B', 'D']
  print(new_model.model_as_pdb())

if (__name__ == "__main__"):
  t0 = time.time()
  tst_1()
  tst_2()
  tst_3()
  tst_4()
  print("Total time: %-8.4f"%(time.time()-t0))
  print("OK")


 *******************************************************************************


 *******************************************************************************
mmtbx/regression/model_idealization/tst_ext_map_01.py
from __future__ import absolute_import, division, print_function
from libtbx import easy_run
import libtbx.load_env
import os.path
import time

cryst_str = """\n
CRYST1   34.917   22.246   44.017  90.00  90.00  90.00 P 1
SCALE1      0.028639  0.000000  0.000000        0.00000
SCALE2      0.000000  0.044952  0.000000        0.00000
SCALE3      0.000000  0.000000  0.022718        0.00000
"""
# taken from phenix_regression/refinement/ncs/tst_ncs_0.py
pdb_str = """\
ATOM      1  N   ALA A   1      27.344  16.348  30.784  1.00 10.00           N
ATOM      2  CA  ALA A   1      26.429  15.281  31.335  1.00 10.00           C
ATOM      3  C   ALA A   1      26.610  14.025  30.603  1.00 10.00           C
ATOM      4  O   ALA A   1      26.479  13.979  29.356  1.00 10.00           O
ATOM      5  CB  ALA A   1      24.874  15.800  31.300  1.00 10.00           C
ATOM      1  N   ALA A   2      26.812  12.925  31.345  1.00 10.00           N
ATOM      2  CA  ALA A   2      27.084  11.577  30.797  1.00 10.00           C
ATOM      3  C   ALA A   2      25.856  10.737  30.707  1.00 10.00           C
ATOM      4  O   ALA A   2      25.741   9.860  29.891  1.00 10.00           O
ATOM      5  CB  ALA A   2      28.151  10.950  31.721  1.00 10.00           C
ATOM      1  N   ALA A   3      25.009  10.973  31.714  1.00 10.00           N
ATOM      2  CA  ALA A   3      23.621  10.543  31.560  1.00 10.00           C
ATOM      3  C   ALA A   3      23.023  11.008  30.214  1.00 10.00           C
ATOM      4  O   ALA A   3      22.786  10.233  29.249  1.00 10.00           O
ATOM      5  CB  ALA A   3      22.760  11.040  32.654  1.00 10.00           C
ATOM      1  N   ALA A   4      22.798  12.304  30.175  1.00 10.00           N
ATOM      2  CA  ALA A   4      22.329  13.084  28.981  1.00 10.00           C
ATOM      3  C   ALA A   4      23.116  12.816  27.721  1.00 10.00           C
ATOM      4  O   ALA A   4      22.533  12.805  26.670  1.00 10.00           O
ATOM      5  CB  ALA A   4      22.372  14.607  29.318  1.00 10.00           C
ATOM      1  N   ALA A   5      24.448  12.622  27.823  1.00 10.00           N
ATOM      2  CA  ALA A   5      25.228  12.407  26.573  1.00 10.00           C
ATOM      3  C   ALA A   5      25.222  10.947  26.143  1.00 10.00           C
ATOM      4  O   ALA A   5      25.386  10.664  24.983  1.00 10.00           O
ATOM      5  CB  ALA A   5      26.634  12.906  26.746  1.00 10.00           C
ATOM      1  N   ALA A   6      24.976  10.048  27.071  1.00 10.00           N
ATOM      2  CA  ALA A   6      24.857   8.614  26.805  1.00 10.00           C
ATOM      3  C   ALA A   6      23.537   8.349  26.054  1.00 10.00           C
ATOM      4  O   ALA A   6      23.439   7.570  25.057  1.00 10.00           O
ATOM      5  CB  ALA A   6      24.874   7.845  28.114  1.00 10.00           C
ATOM      1  N   ALA A   7      22.542   9.039  26.580  1.00 10.00           N
ATOM      2  CA  ALA A   7      21.228   8.903  25.942  1.00 10.00           C
ATOM      3  C   ALA A   7      21.329   9.698  24.628  1.00 10.00           C
ATOM      4  O   ALA A   7      20.707   9.383  23.632  1.00 10.00           O
ATOM      5  CB  ALA A   7      20.146   9.465  26.862  1.00 10.00           C
ATOM      1  N   ALA A   8      22.181  10.696  24.613  1.00 10.00           N
ATOM      2  CA  ALA A   8      22.526  11.372  23.378  1.00 10.00           C
ATOM      3  C   ALA A   8      23.351  10.555  22.448  1.00 10.00           C
ATOM      4  O   ALA A   8      23.618  10.883  21.252  1.00 10.00           O
ATOM      5  CB  ALA A   8      23.168  12.697  23.693  1.00 10.00           C
ATOM      1  N   ALA A   9      23.864   9.423  22.961  1.00 10.00           N
ATOM      2  CA  ALA A   9      24.785   8.541  22.264  1.00 10.00           C
ATOM      3  C   ALA A   9      24.057   7.451  21.484  1.00 10.00           C
ATOM      4  O   ALA A   9      24.127   7.381  20.257  1.00 10.00           O
ATOM      5  CB  ALA A   9      25.815   7.975  23.249  1.00 10.00           C
ATOM      1  N   ALA A  10      23.518   6.548  22.264  1.00 10.00           N
ATOM      2  CA  ALA A  10      22.629   5.525  21.690  1.00 10.00           C
ATOM      3  C   ALA A  10      21.549   6.308  21.009  1.00 10.00           C
ATOM      4  O   ALA A  10      21.114   5.933  19.930  1.00 10.00           O
ATOM      5  CB  ALA A  10      22.057   4.714  22.784  1.00 10.00           C
ATOM      1  N   ALA A  11      21.120   7.452  21.541  1.00 10.00           N
ATOM      2  CA  ALA A  11      20.186   8.260  20.874  1.00 10.00           C
ATOM      3  C   ALA A  11      20.978   9.215  19.937  1.00 10.00           C
ATOM      4  O   ALA A  11      20.386  10.177  19.507  1.00 10.00           O
ATOM      5  CB  ALA A  11      19.295   9.031  21.867  1.00 10.00           C
ATOM      1  N   ALA A  12      22.222   8.932  19.598  1.00 10.00           N
ATOM      2  CA  ALA A  12      22.896   9.709  18.563  1.00 10.00           C
ATOM      3  C   ALA A  12      22.924   8.925  17.308  1.00 10.00           C
ATOM      4  O   ALA A  12      22.982   9.445  16.193  1.00 10.00           O
ATOM      5  CB  ALA A  12      24.294  10.138  18.994  1.00 10.00           C
ATOM      1  N   ALA A  13      22.951   7.633  17.508  1.00 10.00           N
ATOM      2  CA  ALA A  13      22.709   6.629  16.554  1.00 10.00           C
ATOM      3  C   ALA A  13      21.275   6.673  16.206  1.00 10.00           C
ATOM      4  O   ALA A  13      20.870   6.521  15.092  1.00 10.00           O
ATOM      5  CB  ALA A  13      23.077   5.254  17.025  1.00 10.00           C
ATOM      1  N   ALA A  14      20.471   6.929  17.226  1.00 10.00           N
ATOM      2  CA  ALA A  14      19.039   6.992  17.025  1.00 10.00           C
ATOM      3  C   ALA A  14      18.676   8.380  16.528  1.00 10.00           C
ATOM      4  O   ALA A  14      17.748   8.556  15.761  1.00 10.00           O
ATOM      5  CB  ALA A  14      18.240   6.715  18.272  1.00 10.00           C
ATOM      1  N   ALA A  15      19.381   9.390  17.055  1.00 10.00           N
ATOM      2  CA  ALA A  15      19.204  10.743  16.669  1.00 10.00           C
ATOM      3  C   ALA A  15      19.407  10.807  15.174  1.00 10.00           C
ATOM      4  O   ALA A  15      18.402  10.987  14.424  1.00 10.00           O
ATOM      5  CB  ALA A  15      20.190  11.665  17.493  1.00 10.00           C
ATOM      1  N   ALA A  16      20.702  10.653  14.831  1.00 10.00           N
ATOM      2  CA  ALA A  16      21.206  10.546  13.480  1.00 10.00           C
ATOM      3  C   ALA A  16      20.484   9.612  12.585  1.00 10.00           C
ATOM      4  O   ALA A  16      20.380   9.918  11.386  1.00 10.00           O
ATOM      5  CB  ALA A  16      22.631  10.174  13.475  1.00 10.00           C
ATOM      1  N   ALA A  17      20.064   8.475  13.175  1.00 10.00           N
ATOM      2  CA  ALA A  17      19.355   7.473  12.426  1.00 10.00           C
ATOM      3  C   ALA A  17      17.924   7.807  12.064  1.00 10.00           C
ATOM      4  O   ALA A  17      17.535   7.721  10.871  1.00 10.00           O
ATOM      5  CB  ALA A  17      19.359   6.123  13.216  1.00 10.00           C
ATOM      1  N   ALA A  18      17.152   8.115  13.031  1.00 10.00           N
ATOM      2  CA  ALA A  18      15.835   8.594  12.861  1.00 10.00           C
ATOM      3  C   ALA A  18      15.811   9.835  11.861  1.00 10.00           C
ATOM      4  O   ALA A  18      15.020   9.889  10.868  1.00 10.00           O
ATOM      5  CB  ALA A  18      15.272   8.918  14.234  1.00 10.00           C
ATOM      1  N   ALA A  19      16.661  10.845  12.100  1.00 10.00           N
ATOM      2  CA  ALA A  19      16.435  12.061  11.275  1.00 10.00           C
ATOM      3  C   ALA A  19      17.004  11.815   9.833  1.00 10.00           C
ATOM      4  O   ALA A  19      16.334  12.117   8.857  1.00 10.00           O
ATOM      5  CB  ALA A  19      17.059  13.242  11.866  1.00 10.00           C
ATOM      1  N   ALA A  20      18.191  11.200   9.841  1.00 10.00           N
ATOM      2  CA  ALA A  20      19.091  11.247   8.697  1.00 10.00           C
ATOM      3  C   ALA A  20      19.549   9.835   8.231  1.00 10.00           C
ATOM      4  O   ALA A  20      20.670   9.692   7.663  1.00 10.00           O
ATOM      5  CB  ALA A  20      20.326  12.105   9.035  1.00 10.00           C
ATOM      1  N   ALA A  21      18.654   8.850   8.523  1.00 10.00           N
ATOM      2  CA  ALA A  21      18.827   7.437   8.168  1.00 10.00           C
ATOM      3  C   ALA A  21      17.565   6.607   8.282  1.00 10.00           C
ATOM      4  O   ALA A  21      16.485   6.992   7.820  1.00 10.00           O
ATOM      5  CB  ALA A  21      19.888   6.838   8.983  1.00 10.00           C
"""

def exercise_01(prefix="tst_mi_ext_map_test_01"):
  """
  Simple run to a completion with reference map. no SS annotations.
  """
  pdb_file = open("%s_start.pdb" % prefix, "w")
  pdb_file.write(cryst_str)
  pdb_file.write(pdb_str)
  pdb_file.close()
  # making map
  fmodel_cmd = " ".join([
      "phenix.fmodel",
      "%s_start.pdb" % prefix,
      "high_resolution=5",
      # "generate_fake_p1_symmetry=True",
      ])
  print(fmodel_cmd)
  assert not easy_run.call(fmodel_cmd)
  mtz2map_cmd = " ".join([
    "phenix.mtz2map",
    "%s_start.pdb.mtz" % prefix,
    "include_fmodel=True"])
  print(mtz2map_cmd)
  assert not easy_run.call(mtz2map_cmd)
  # STOP()
  cmd = " ".join([
      "phenix.model_idealization",
      "%s_start.pdb" % prefix,
      "%s_start.pdb_fmodel.ccp4" % prefix,
      "use_map_for_reference=True",
      "number_of_refinement_cycles=1",
      "run_minimization_first=False",
      "loop_idealization.number_of_ccd_trials=1",
      "n_macro=1",
      "debug=True",
      ">%s.log" % prefix])
  print(cmd)
  assert not easy_run.call(cmd)
  res_log = open("%s.log" % prefix, "r")
  log_lines = res_log.readlines()
  for l in [
      # "Secondary structure substitution step will be skipped\n",
      "  Minimizing...\n",
      "Using map as reference\n",
      "Preparing user map...\n",
      # "Ramachandran outliers:      0.00      0.00      0.00      0.00      0.00\n",
      "All done.\n"]:
    assert l in log_lines, "'%s' not in log file." % l
  res_log.close()
  # assert os.path.isfile("%s_start.pdb_idealized.pdb" % prefix)

if (__name__ == "__main__"):
  t0 = time.time()
  if (not libtbx.env.has_module(name="probe")):
    print("Skipping: probe not configured")
  else:
    exercise_01()
  print("Time: %.2f" % (time.time() - t0))
  print("OK")


 *******************************************************************************


 *******************************************************************************
mmtbx/regression/model_idealization/tst_ligands.py
from __future__ import absolute_import, division, print_function
from libtbx import easy_run
import libtbx.load_env
import os.path
import time

pdb_lines = """\
CRYST1  194.138  101.751   80.651  90.00 105.74  90.00 C 1 2 1       4
ATOM      1  N   MET A   1     -63.482  31.658  20.489  1.00 88.61           N
ATOM      2  CA  MET A   1     -64.594  31.042  19.724  1.00 87.28           C
ATOM      3  C   MET A   1     -65.689  30.614  20.691  1.00 85.59           C
ATOM      4  O   MET A   1     -65.419  30.412  21.876  1.00 85.68           O
ATOM      5  CB  MET A   1     -64.075  29.831  18.973  1.00 89.26           C
ATOM      6  CG  MET A   1     -62.902  30.150  18.065  1.00 92.21           C
ATOM      7  SD  MET A   1     -62.278  28.659  17.271  1.00 96.77           S
ATOM      8  CE  MET A   1     -63.798  27.825  16.920  1.00 94.61           C
ATOM      9  N   THR A   2     -66.924  30.488  20.211  1.00 83.63           N
ATOM     10  CA  THR A   2     -68.002  30.078  21.106  1.00 83.02           C
ATOM     11  C   THR A   2     -69.152  29.283  20.508  1.00 81.29           C
ATOM     12  O   THR A   2     -69.485  29.420  19.332  1.00 79.88           O
ATOM     13  CB  THR A   2     -68.642  31.264  21.829  1.00 84.34           C
ATOM     14  OG1 THR A   2     -69.678  31.807  21.006  1.00 86.38           O
ATOM     15  CG2 THR A   2     -67.602  32.328  22.151  1.00 86.86           C
ATOM     16  N   MET A   3     -69.768  28.490  21.387  1.00 79.99           N
ATOM     17  CA  MET A   3     -70.888  27.620  21.082  1.00 77.22           C
ATOM     18  C   MET A   3     -70.424  26.519  20.160  1.00 76.93           C
ATOM     19  O   MET A   3     -69.748  25.598  20.606  1.00 78.22           O
ATOM     20  CB  MET A   3     -72.019  28.431  20.476  1.00 76.32           C
ATOM     21  CG  MET A   3     -72.439  29.543  21.406  1.00 75.48           C
ATOM     22  SD  MET A   3     -72.756  28.964  23.098  1.00 75.99           S
ATOM     23  CE  MET A   3     -71.183  29.165  23.909  1.00 73.62           C
ATOM     24  N   ASP A   4     -70.753  26.588  18.880  1.00 76.31           N
ATOM     25  CA  ASP A   4     -70.290  25.529  18.001  1.00 75.92           C
ATOM     26  C   ASP A   4     -69.444  26.061  16.882  1.00 75.06           C
ATOM     27  O   ASP A   4     -69.938  26.667  15.939  1.00 75.09           O
ATOM     28  CB  ASP A   4     -71.451  24.727  17.426  1.00 76.22           C
ATOM     29  CG  ASP A   4     -70.984  23.449  16.763  1.00 76.96           C
ATOM     30  OD1 ASP A   4     -70.169  23.538  15.816  1.00 76.92           O
ATOM     31  OD2 ASP A   4     -71.428  22.362  17.205  1.00 77.39           O
ATOM     32  N   PHE A   5     -68.156  25.798  17.003  1.00 74.26           N
ATOM     33  CA  PHE A   5     -67.167  26.224  16.037  1.00 74.26           C
ATOM     34  C   PHE A   5     -67.515  25.771  14.623  1.00 72.79           C
ATOM     35  O   PHE A   5     -67.028  26.337  13.644  1.00 72.51           O
ATOM     36  CB  PHE A   5     -65.831  25.636  16.442  1.00 77.83           C
ATOM     37  CG  PHE A   5     -65.602  25.613  17.931  1.00 82.00           C
ATOM     38  CD1 PHE A   5     -64.713  24.690  18.492  1.00 84.76           C
ATOM     39  CD2 PHE A   5     -66.249  26.521  18.775  1.00 84.12           C
ATOM     40  CE1 PHE A   5     -64.473  24.672  19.871  1.00 85.57           C
ATOM     41  CE2 PHE A   5     -66.017  26.516  20.156  1.00 85.19           C
ATOM     42  CZ  PHE A   5     -65.127  25.589  20.708  1.00 86.02           C
HETATM 8902  C1  MLI A1001     -35.107  -8.183  19.606  1.00 48.70           C
HETATM 8903  C2  MLI A1001     -34.404  -7.934  20.966  1.00 47.76           C
HETATM 8904  C3  MLI A1001     -35.406  -7.002  18.730  1.00 51.13           C
HETATM 8905  O6  MLI A1001     -33.181  -7.738  21.141  1.00 48.11           O
HETATM 8906  O7  MLI A1001     -35.151  -7.962  21.978  1.00 44.44           O
HETATM 8907  O8  MLI A1001     -34.422  -6.274  18.392  1.00 48.51           O
HETATM 8908  O9  MLI A1001     -36.601  -6.959  18.453  1.00 53.02           O
"""

cif_lines = """\
#
data_comp_list
loop_
_chem_comp.id
_chem_comp.three_letter_code
_chem_comp.name
_chem_comp.group
_chem_comp.number_atoms_all
_chem_comp.number_atoms_nh
_chem_comp.desc_level
MLI MLI "Unknown                  " ligand 9 7 .
#
data_comp_MLI
#
loop_
_chem_comp_atom.comp_id
_chem_comp_atom.atom_id
_chem_comp_atom.type_symbol
_chem_comp_atom.type_energy
_chem_comp_atom.charge
_chem_comp_atom.partial_charge
_chem_comp_atom.x
_chem_comp_atom.y
_chem_comp_atom.z
MLI        C1      C   CH2    0 .         -0.3524   -0.0000   -0.4983
MLI        C2      C   C      0 .          1.1747   -0.0000   -0.4983
MLI        C3      C   C      0 .         -0.8614   -0.0000    0.9415
MLI        O6      O   O      0 .          1.8042    1.0799   -0.3478
MLI        O7      O   OC    -1 .          1.8042   -1.0799   -0.6489
MLI        O8      O   O      0 .         -1.2112    1.0802    1.4855
MLI        O9      O   OC    -1 .         -0.9313   -1.0802    1.5844
MLI        H11     H   HCH2   0 .         -0.7135    0.8845   -1.0090
MLI        H12     H   HCH2   0 .         -0.7135   -0.8845   -1.0090
#
loop_
_chem_comp_bond.comp_id
_chem_comp_bond.atom_id_1
_chem_comp_bond.atom_id_2
_chem_comp_bond.type
_chem_comp_bond.value_dist
_chem_comp_bond.value_dist_esd
_chem_comp_bond.value_dist_neutron
MLI  C1      C2     single        1.527 0.020     1.527
MLI  C1      C3     single        1.527 0.020     1.527
MLI  C1      H11    single        0.970 0.020     1.090
MLI  C1      H12    single        0.970 0.020     1.090
MLI  C2      O6     deloc         1.259 0.020     1.259
MLI  C2      O7     deloc         1.259 0.020     1.259
MLI  C3      O8     deloc         1.259 0.020     1.259
MLI  C3      O9     deloc         1.259 0.020     1.259
#
loop_
_chem_comp_angle.comp_id
_chem_comp_angle.atom_id_1
_chem_comp_angle.atom_id_2
_chem_comp_angle.atom_id_3
_chem_comp_angle.value_angle
_chem_comp_angle.value_angle_esd
MLI  H12     C1      H11          109.47 3.000
MLI  H12     C1      C3           109.47 3.000
MLI  H11     C1      C3           109.47 3.000
MLI  H12     C1      C2           109.47 3.000
MLI  H11     C1      C2           109.47 3.000
MLI  C3      C1      C2           109.47 3.000
MLI  O7      C2      O6           120.00 3.000
MLI  O7      C2      C1           120.00 3.000
MLI  O6      C2      C1           120.00 3.000
MLI  O9      C3      O8           120.00 3.000
MLI  O9      C3      C1           120.00 3.000
MLI  O8      C3      C1           120.00 3.000
#
loop_
_chem_comp_tor.comp_id
_chem_comp_tor.id
_chem_comp_tor.atom_id_1
_chem_comp_tor.atom_id_2
_chem_comp_tor.atom_id_3
_chem_comp_tor.atom_id_4
_chem_comp_tor.value_angle
_chem_comp_tor.value_angle_esd
_chem_comp_tor.period
MLI Var_01        O8      C3      C1      C2            97.82  30.0 3
MLI Var_02        O6      C2      C1      C3           -82.06  30.0 3
#
loop_
_chem_comp_plane_atom.comp_id
_chem_comp_plane_atom.plane_id
_chem_comp_plane_atom.atom_id
_chem_comp_plane_atom.dist_esd
MLI plan-1  C1     0.020
MLI plan-1  C2     0.020
MLI plan-1  O6     0.020
MLI plan-1  O7     0.020
MLI plan-2  C1     0.020
MLI plan-2  C3     0.020
MLI plan-2  O8     0.020
MLI plan-2  O9     0.020
"""

def exercise_01(prefix="tst_mi_ligands_test_01"):
  """
  Simple run to a completion with reference map. no SS annotations.
  """
  pdb_file = open("%s_start.pdb" % prefix, "w")
  pdb_file.write(pdb_lines)
  pdb_file.close()
  cif_file = open("%s_start.cif" % prefix, "w")
  cif_file.write(cif_lines)
  cif_file.close()
  cmd = " ".join([
      "phenix.model_idealization",
      "%s_start.pdb" % prefix,
      "%s_start.cif" % prefix,
      "use_map_for_reference=True",
      "number_of_refinement_cycles=1",
      "run_minimization_first=False",
      "loop_idealization.number_of_ccd_trials=1",
      "n_macro=1",
      "debug=True",
      ">%s.log" % prefix])
  print(cmd)
  assert not easy_run.call(cmd)
  res_log = open("%s.log" % prefix, "r")
  log_lines = res_log.readlines()
  for l in [
      # "Secondary structure substitution step will be skipped\n",
      "  Minimizing...\n",
      "Using map as reference\n",
      # "Ramachandran outliers:      0.00      0.00      0.00      0.00      0.00\n",
      "All done.\n"]:
    assert l in log_lines, "'%s' not in log file." % l
  res_log.close()
  # assert os.path.isfile("%s_start.pdb_idealized.pdb" % prefix)

if (__name__ == "__main__"):
  t0 = time.time()
  if (not libtbx.env.has_module(name="probe")):
    print("Skipping: probe not configured")
  else:
    exercise_01()
  print("Time: %.2f" % (time.time() - t0))
  print("OK")


 *******************************************************************************


 *******************************************************************************
mmtbx/regression/model_idealization/tst_nomap_01.py
from __future__ import absolute_import, division, print_function
from libtbx import easy_run
from mmtbx.secondary_structure.build.tst_2 import tst_01_start_lines
import libtbx.load_env
import os.path
import time

def exercise_01(prefix="tst_mi_test_01"):
  """
  Simple run to completion without SS in the file.
  SS idealization step should be skipped.
  """
  # no SS annotations
  pdb_file = open("%s_start.pdb" % prefix, "w")
  pdb_file.write(tst_01_start_lines)
  pdb_file.close()
  cmd = " ".join([
      "phenix.model_idealization",
      "%s_start.pdb" % prefix,
      "use_map_for_reference=False",
      "number_of_refinement_cycles=1",
      "n_macro=1",
      "output_pkl=True",
      ">%s.log" % prefix])
  print(cmd)
  assert not easy_run.call(cmd)
  res_log = open("%s.log" % prefix, "r")
  log_lines = res_log.readlines()
  for l in [
      # "Secondary structure substitution step will be skipped\n",
      "All done.\n"]:
    assert l in log_lines, "'%s' not in log file." % l
  res_log.close()
  # assert os.path.isfile("%s_start.pdb_idealized.pdb" % prefix)

if (__name__ == "__main__"):
  t0 = time.time()
  if (not libtbx.env.has_module(name="probe")):
    print("Skipping test: probe not configured")
  else:
    exercise_01()
  print("Time: %.2f" % (time.time() - t0))
  print("OK")


 *******************************************************************************


 *******************************************************************************
mmtbx/regression/model_idealization/tst_nomap_02.py
from __future__ import absolute_import, division, print_function
from libtbx import easy_run
from mmtbx.secondary_structure.build.tst_2 import tst_01_start_lines
import libtbx.load_env
import os.path
import time

def exercise_02(prefix="tst_mi_test_02"):
  """
  Simple run to completion with SS annotations in PDB file
  """
  h_records = """\
CRYST1  100.000  100.000  100.000  90.00  90.00  90.00 P 1
HELIX    1   1 PRO A    3  ALA A   21  1                                  19
HELIX    2   2 ARG A   23  GLN A   44  1                                  22
"""
  pdb_file = open("%s_start.pdb" % prefix, "w")
  pdb_file.write(h_records)
  pdb_file.write(tst_01_start_lines)
  pdb_file.close()
  cmd = " ".join([
      "phenix.model_idealization",
      "%s_start.pdb" % prefix,
      "use_map_for_reference=False",
      "number_of_refinement_cycles=1",
      "run_minimization_first=False",
      "n_macro=1",
      ">%s.log" % prefix])
  print(cmd)
  assert not easy_run.call(cmd)
  res_log = open("%s.log" % prefix, "r")
  log_lines = res_log.readlines()
  for l in [
      # "Replacing ss-elements with ideal ones:\n",
      "All done.\n"]:
    assert l in log_lines, "'%s' not in log file." % l
  res_log.close()
  assert os.path.isfile("%s_start.pdb_all_idealized.pdb" % prefix)
  res_pdb = open("%s_start.pdb_all_idealized.pdb" % prefix, "r")
  res_pdb_lines = res_pdb.readlines()
  res_pdb.close()
  for l in [
      "HELIX    1   1 PRO A    3  ALA A   21  1                                  19\n",
      "HELIX    2   2 ARG A   23  GLN A   44  1                                  22\n",
      ]:
    assert l in res_pdb_lines, "'%s' not in pdb file." % l

if (__name__ == "__main__"):
  t0 = time.time()
  if (not libtbx.env.has_module(name="probe")):
    print("Skipping test: probe not configured")
  else:
    exercise_02()
  print("Time: %.2f" % (time.time() - t0))
  print("OK")


 *******************************************************************************


 *******************************************************************************
mmtbx/regression/model_idealization/tst_nomap_03.py
from __future__ import absolute_import, division, print_function
from libtbx import easy_run
import libtbx.load_env
import os.path
import time

cryst_str = """\n
CRYST1   34.917   22.246   44.017  90.00  90.00  90.00 P 1
SCALE1      0.028639  0.000000  0.000000        0.00000
SCALE2      0.000000  0.044952  0.000000        0.00000
SCALE3      0.000000  0.000000  0.022718        0.00000
"""
# taken from phenix_regression/refinement/ncs/tst_ncs_0.py
pdb_str = """\
ATOM      1  N   ALA A   1      27.344  16.348  30.784  1.00 10.00           N
ATOM      2  CA  ALA A   1      26.429  15.281  31.335  1.00 10.00           C
ATOM      3  C   ALA A   1      26.610  14.025  30.603  1.00 10.00           C
ATOM      4  O   ALA A   1      26.479  13.979  29.356  1.00 10.00           O
ATOM      5  CB  ALA A   1      24.874  15.800  31.300  1.00 10.00           C
ATOM      1  N   ALA A   2      26.812  12.925  31.345  1.00 10.00           N
ATOM      2  CA  ALA A   2      27.084  11.577  30.797  1.00 10.00           C
ATOM      3  C   ALA A   2      25.856  10.737  30.707  1.00 10.00           C
ATOM      4  O   ALA A   2      25.741   9.860  29.891  1.00 10.00           O
ATOM      5  CB  ALA A   2      28.151  10.950  31.721  1.00 10.00           C
ATOM      1  N   ALA A   3      25.009  10.973  31.714  1.00 10.00           N
ATOM      2  CA  ALA A   3      23.621  10.543  31.560  1.00 10.00           C
ATOM      3  C   ALA A   3      23.023  11.008  30.214  1.00 10.00           C
ATOM      4  O   ALA A   3      22.786  10.233  29.249  1.00 10.00           O
ATOM      5  CB  ALA A   3      22.760  11.040  32.654  1.00 10.00           C
ATOM      1  N   ALA A   4      22.798  12.304  30.175  1.00 10.00           N
ATOM      2  CA  ALA A   4      22.329  13.084  28.981  1.00 10.00           C
ATOM      3  C   ALA A   4      23.116  12.816  27.721  1.00 10.00           C
ATOM      4  O   ALA A   4      22.533  12.805  26.670  1.00 10.00           O
ATOM      5  CB  ALA A   4      22.372  14.607  29.318  1.00 10.00           C
ATOM      1  N   ALA A   5      24.448  12.622  27.823  1.00 10.00           N
ATOM      2  CA  ALA A   5      25.228  12.407  26.573  1.00 10.00           C
ATOM      3  C   ALA A   5      25.222  10.947  26.143  1.00 10.00           C
ATOM      4  O   ALA A   5      25.386  10.664  24.983  1.00 10.00           O
ATOM      5  CB  ALA A   5      26.634  12.906  26.746  1.00 10.00           C
ATOM      1  N   ALA A   6      24.976  10.048  27.071  1.00 10.00           N
ATOM      2  CA  ALA A   6      24.857   8.614  26.805  1.00 10.00           C
ATOM      3  C   ALA A   6      23.537   8.349  26.054  1.00 10.00           C
ATOM      4  O   ALA A   6      23.439   7.570  25.057  1.00 10.00           O
ATOM      5  CB  ALA A   6      24.874   7.845  28.114  1.00 10.00           C
ATOM      1  N   ALA A   7      22.542   9.039  26.580  1.00 10.00           N
ATOM      2  CA  ALA A   7      21.228   8.903  25.942  1.00 10.00           C
ATOM      3  C   ALA A   7      21.329   9.698  24.628  1.00 10.00           C
ATOM      4  O   ALA A   7      20.707   9.383  23.632  1.00 10.00           O
ATOM      5  CB  ALA A   7      20.146   9.465  26.862  1.00 10.00           C
ATOM      1  N   ALA A   8      22.181  10.696  24.613  1.00 10.00           N
ATOM      2  CA  ALA A   8      22.526  11.372  23.378  1.00 10.00           C
ATOM      3  C   ALA A   8      23.351  10.555  22.448  1.00 10.00           C
ATOM      4  O   ALA A   8      23.618  10.883  21.252  1.00 10.00           O
ATOM      5  CB  ALA A   8      23.168  12.697  23.693  1.00 10.00           C
ATOM      1  N   ALA A   9      23.864   9.423  22.961  1.00 10.00           N
ATOM      2  CA  ALA A   9      24.785   8.541  22.264  1.00 10.00           C
ATOM      3  C   ALA A   9      24.057   7.451  21.484  1.00 10.00           C
ATOM      4  O   ALA A   9      24.127   7.381  20.257  1.00 10.00           O
ATOM      5  CB  ALA A   9      25.815   7.975  23.249  1.00 10.00           C
ATOM      1  N   ALA A  10      23.518   6.548  22.264  1.00 10.00           N
ATOM      2  CA  ALA A  10      22.629   5.525  21.690  1.00 10.00           C
ATOM      3  C   ALA A  10      21.549   6.308  21.009  1.00 10.00           C
ATOM      4  O   ALA A  10      21.114   5.933  19.930  1.00 10.00           O
ATOM      5  CB  ALA A  10      22.057   4.714  22.784  1.00 10.00           C
ATOM      1  N   ALA A  11      21.120   7.452  21.541  1.00 10.00           N
ATOM      2  CA  ALA A  11      20.186   8.260  20.874  1.00 10.00           C
ATOM      3  C   ALA A  11      20.978   9.215  19.937  1.00 10.00           C
ATOM      4  O   ALA A  11      20.386  10.177  19.507  1.00 10.00           O
ATOM      5  CB  ALA A  11      19.295   9.031  21.867  1.00 10.00           C
ATOM      1  N   ALA A  12      22.222   8.932  19.598  1.00 10.00           N
ATOM      2  CA  ALA A  12      22.896   9.709  18.563  1.00 10.00           C
ATOM      3  C   ALA A  12      22.924   8.925  17.308  1.00 10.00           C
ATOM      4  O   ALA A  12      22.982   9.445  16.193  1.00 10.00           O
ATOM      5  CB  ALA A  12      24.294  10.138  18.994  1.00 10.00           C
ATOM      1  N   ALA A  13      22.951   7.633  17.508  1.00 10.00           N
ATOM      2  CA  ALA A  13      22.709   6.629  16.554  1.00 10.00           C
ATOM      3  C   ALA A  13      21.275   6.673  16.206  1.00 10.00           C
ATOM      4  O   ALA A  13      20.870   6.521  15.092  1.00 10.00           O
ATOM      5  CB  ALA A  13      23.077   5.254  17.025  1.00 10.00           C
ATOM      1  N   ALA A  14      20.471   6.929  17.226  1.00 10.00           N
ATOM      2  CA  ALA A  14      19.039   6.992  17.025  1.00 10.00           C
ATOM      3  C   ALA A  14      18.676   8.380  16.528  1.00 10.00           C
ATOM      4  O   ALA A  14      17.748   8.556  15.761  1.00 10.00           O
ATOM      5  CB  ALA A  14      18.240   6.715  18.272  1.00 10.00           C
ATOM      1  N   ALA A  15      19.381   9.390  17.055  1.00 10.00           N
ATOM      2  CA  ALA A  15      19.204  10.743  16.669  1.00 10.00           C
ATOM      3  C   ALA A  15      19.407  10.807  15.174  1.00 10.00           C
ATOM      4  O   ALA A  15      18.402  10.987  14.424  1.00 10.00           O
ATOM      5  CB  ALA A  15      20.190  11.665  17.493  1.00 10.00           C
ATOM      1  N   ALA A  16      20.702  10.653  14.831  1.00 10.00           N
ATOM      2  CA  ALA A  16      21.206  10.546  13.480  1.00 10.00           C
ATOM      3  C   ALA A  16      20.484   9.612  12.585  1.00 10.00           C
ATOM      4  O   ALA A  16      20.380   9.918  11.386  1.00 10.00           O
ATOM      5  CB  ALA A  16      22.631  10.174  13.475  1.00 10.00           C
ATOM      1  N   ALA A  17      20.064   8.475  13.175  1.00 10.00           N
ATOM      2  CA  ALA A  17      19.355   7.473  12.426  1.00 10.00           C
ATOM      3  C   ALA A  17      17.924   7.807  12.064  1.00 10.00           C
ATOM      4  O   ALA A  17      17.535   7.721  10.871  1.00 10.00           O
ATOM      5  CB  ALA A  17      19.359   6.123  13.216  1.00 10.00           C
ATOM      1  N   ALA A  18      17.152   8.115  13.031  1.00 10.00           N
ATOM      2  CA  ALA A  18      15.835   8.594  12.861  1.00 10.00           C
ATOM      3  C   ALA A  18      15.811   9.835  11.861  1.00 10.00           C
ATOM      4  O   ALA A  18      15.020   9.889  10.868  1.00 10.00           O
ATOM      5  CB  ALA A  18      15.272   8.918  14.234  1.00 10.00           C
ATOM      1  N   ALA A  19      16.661  10.845  12.100  1.00 10.00           N
ATOM      2  CA  ALA A  19      16.435  12.061  11.275  1.00 10.00           C
ATOM      3  C   ALA A  19      17.004  11.815   9.833  1.00 10.00           C
ATOM      4  O   ALA A  19      16.334  12.117   8.857  1.00 10.00           O
ATOM      5  CB  ALA A  19      17.059  13.242  11.866  1.00 10.00           C
ATOM      1  N   ALA A  20      18.191  11.200   9.841  1.00 10.00           N
ATOM      2  CA  ALA A  20      19.091  11.247   8.697  1.00 10.00           C
ATOM      3  C   ALA A  20      19.549   9.835   8.231  1.00 10.00           C
ATOM      4  O   ALA A  20      20.670   9.692   7.663  1.00 10.00           O
ATOM      5  CB  ALA A  20      20.326  12.105   9.035  1.00 10.00           C
ATOM      1  N   ALA A  21      18.654   8.850   8.523  1.00 10.00           N
ATOM      2  CA  ALA A  21      18.827   7.437   8.168  1.00 10.00           C
ATOM      3  C   ALA A  21      17.565   6.607   8.282  1.00 10.00           C
ATOM      4  O   ALA A  21      16.485   6.992   7.820  1.00 10.00           O
ATOM      5  CB  ALA A  21      19.888   6.838   8.983  1.00 10.00           C
TER
ATOM      1  N   ALA B   1      16.348  17.420  35.897  1.00 50.00           N
ATOM      2  CA  ALA B   1      16.783  16.083  36.351  1.00 50.00           C
ATOM      3  C   ALA B   1      16.794  15.172  35.139  1.00 50.00           C
ATOM      4  O   ALA B   1      16.167  15.477  34.133  1.00 50.00           O
ATOM      5  CB  ALA B   1      15.785  15.534  37.468  1.00 50.00           C
ATOM      1  N   ALA B   2      17.491  14.058  35.255  1.00 50.00           N
ATOM      2  CA  ALA B   2      17.790  13.267  34.127  1.00 50.00           C
ATOM      3  C   ALA B   2      16.716  12.232  33.688  1.00 50.00           C
ATOM      4  O   ALA B   2      16.676  11.869  32.543  1.00 50.00           O
ATOM      5  CB  ALA B   2      19.125  12.656  34.415  1.00 50.00           C
ATOM      1  N   ALA B   3      15.904  11.687  34.605  1.00 50.00           N
ATOM      2  CA  ALA B   3      14.798  10.901  34.173  1.00 50.00           C
ATOM      3  C   ALA B   3      13.740  11.723  33.536  1.00 50.00           C
ATOM      4  O   ALA B   3      13.398  11.501  32.356  1.00 50.00           O
ATOM      5  CB  ALA B   3      14.148  10.176  35.403  1.00 50.00           C
ATOM      1  N   ALA B   4      13.239  12.708  34.247  1.00 50.00           N
ATOM      2  CA  ALA B   4      12.158  13.487  33.709  1.00 50.00           C
ATOM      3  C   ALA B   4      12.674  14.248  32.495  1.00 50.00           C
ATOM      4  O   ALA B   4      11.935  14.376  31.526  1.00 50.00           O
ATOM      5  CB  ALA B   4      11.553  14.432  34.712  1.00 50.00           C
ATOM      1  N   ALA B   5      13.947  14.627  32.479  1.00 50.00           N
ATOM      2  CA  ALA B   5      14.416  15.490  31.405  1.00 50.00           C
ATOM      3  C   ALA B   5      14.960  14.730  30.186  1.00 50.00           C
ATOM      4  O   ALA B   5      14.575  14.940  29.054  1.00 50.00           O
ATOM      5  CB  ALA B   5      15.464  16.431  31.928  1.00 50.00           C
ATOM      1  N   ALA B   6      15.867  13.827  30.546  1.00 50.00           N
ATOM      2  CA  ALA B   6      16.575  12.918  29.615  1.00 50.00           C
ATOM      3  C   ALA B   6      15.465  12.002  28.975  1.00 50.00           C
ATOM      4  O   ALA B   6      15.450  11.709  27.742  1.00 50.00           O
ATOM      5  CB  ALA B   6      17.632  12.157  30.362  1.00 50.00           C
ATOM      1  N   ALA B   7      14.542  11.597  29.783  1.00 50.00           N
ATOM      2  CA  ALA B   7      13.529  10.701  29.277  1.00 50.00           C
ATOM      3  C   ALA B   7      12.175  11.364  28.835  1.00 50.00           C
ATOM      4  O   ALA B   7      11.466  10.770  27.969  1.00 50.00           O
ATOM      5  CB  ALA B   7      13.161   9.644  30.376  1.00 50.00           C
ATOM      1  N   ALA B   8      11.753  12.455  29.452  1.00 50.00           N
ATOM      2  CA  ALA B   8      10.536  13.193  28.972  1.00 50.00           C
ATOM      3  C   ALA B   8      10.919  13.923  27.670  1.00 50.00           C
ATOM      4  O   ALA B   8      10.171  14.036  26.729  1.00 50.00           O
ATOM      5  CB  ALA B   8      10.032  14.139  30.014  1.00 50.00           C
ATOM      1  N   ALA B   9      12.185  14.247  27.579  1.00 50.00           N
ATOM      2  CA  ALA B   9      12.754  14.849  26.385  1.00 50.00           C
ATOM      3  C   ALA B   9      12.892  13.859  25.320  1.00 50.00           C
ATOM      4  O   ALA B   9      12.234  13.980  24.290  1.00 50.00           O
ATOM      5  CB  ALA B   9      14.108  15.448  26.695  1.00 50.00           C
ATOM      1  N   ALA B  10      13.655  12.794  25.566  1.00 50.00           N
ATOM      2  CA  ALA B  10      13.831  11.803  24.529  1.00 50.00           C
ATOM      3  C   ALA B  10      12.551  10.987  24.319  1.00 50.00           C
ATOM      4  O   ALA B  10      12.514  10.237  23.390  1.00 50.00           O
ATOM      5  CB  ALA B  10      15.024  10.750  24.992  1.00 50.00           C
ATOM      1  N   ALA B  11      11.558  11.184  25.126  1.00 50.00           N
ATOM      2  CA  ALA B  11      10.334  10.457  24.931  1.00 50.00           C
ATOM      3  C   ALA B  11       9.326  11.284  24.168  1.00 50.00           C
ATOM      4  O   ALA B  11       8.566  10.707  23.476  1.00 50.00           O
ATOM      5  CB  ALA B  11       9.644  10.042  26.251  1.00 50.00           C
ATOM      1  N   ALA B  12       9.277  12.611  24.334  1.00 50.00           N
ATOM      2  CA  ALA B  12       8.354  13.375  23.644  1.00 50.00           C
ATOM      3  C   ALA B  12       9.019  13.546  22.264  1.00 50.00           C
ATOM      4  O   ALA B  12       8.400  13.891  21.317  1.00 50.00           O
ATOM      5  CB  ALA B  12       8.056  14.678  24.287  1.00 50.00           C
ATOM      1  N   ALA B  13      10.333  13.339  22.264  1.00 50.00           N
ATOM      2  CA  ALA B  13      11.239  13.471  21.127  1.00 50.00           C
ATOM      3  C   ALA B  13      11.096  12.161  20.325  1.00 50.00           C
ATOM      4  O   ALA B  13      11.145  12.175  19.123  1.00 50.00           O
ATOM      5  CB  ALA B  13      12.584  13.665  21.596  1.00 50.00           C
ATOM      1  N   ALA B  14      11.051  11.078  21.086  1.00 50.00           N
ATOM      2  CA  ALA B  14      10.953   9.771  20.454  1.00 50.00           C
ATOM      3  C   ALA B  14       9.550   9.463  20.117  1.00 50.00           C
ATOM      4  O   ALA B  14       9.233   8.571  19.367  1.00 50.00           O
ATOM      5  CB  ALA B  14      11.461   8.697  21.413  1.00 50.00           C
ATOM      1  N   ALA B  15       8.669  10.215  20.743  1.00 50.00           N
ATOM      2  CA  ALA B  15       7.282  10.010  20.486  1.00 50.00           C
ATOM      3  C   ALA B  15       6.825  10.982  19.376  1.00 50.00           C
ATOM      4  O   ALA B  15       5.855  10.783  18.619  1.00 50.00           O
ATOM      5  CB  ALA B  15       6.367  10.306  21.797  1.00 50.00           C
ATOM      1  N   ALA B  16       7.511  12.143  19.430  1.00 50.00           N
ATOM      2  CA  ALA B  16       7.233  13.302  18.551  1.00 50.00           C
ATOM      3  C   ALA B  16       7.912  13.082  17.205  1.00 50.00           C
ATOM      4  O   ALA B  16       7.492  13.573  16.111  1.00 50.00           O
ATOM      5  CB  ALA B  16       7.762  14.594  19.165  1.00 50.00           C
ATOM      1  N   ALA B  17       9.071  12.427  17.269  1.00 50.00           N
ATOM      2  CA  ALA B  17       9.595  11.771  16.091  1.00 50.00           C
ATOM      3  C   ALA B  17       8.883  10.519  15.763  1.00 50.00           C
ATOM      4  O   ALA B  17       8.890  10.193  14.597  1.00 50.00           O
ATOM      5  CB  ALA B  17      11.046  11.518  16.265  1.00 50.00           C
ATOM      1  N   ALA B  18       8.315   9.809  16.722  1.00 50.00           N
ATOM      2  CA  ALA B  18       7.515   8.647  16.448  1.00 50.00           C
ATOM      3  C   ALA B  18       6.253   9.063  15.707  1.00 50.00           C
ATOM      4  O   ALA B  18       5.559   8.173  15.198  1.00 50.00           O
ATOM      5  CB  ALA B  18       7.129   7.915  17.695  1.00 50.00           C
ATOM      1  N   ALA B  19       5.866  10.332  15.772  1.00 50.00           N
ATOM      2  CA  ALA B  19       4.686  10.808  15.089  1.00 50.00           C
ATOM      3  C   ALA B  19       5.011  11.578  13.803  1.00 50.00           C
ATOM      4  O   ALA B  19       4.291  11.514  12.837  1.00 50.00           O
ATOM      5  CB  ALA B  19       3.854  11.710  15.960  1.00 50.00           C
ATOM      1  N   ALA B  20       6.176  12.195  13.822  1.00 50.00           N
ATOM      2  CA  ALA B  20       6.614  13.121  12.789  1.00 50.00           C
ATOM      3  C   ALA B  20       7.933  12.759  12.098  1.00 50.00           C
ATOM      4  O   ALA B  20       8.620  13.613  11.585  1.00 50.00           O
ATOM      5  CB  ALA B  20       6.823  14.498  13.449  1.00 50.00           C
ATOM      1  N   ALA B  21       8.284  11.511  12.050  1.00 50.00           N
ATOM      2  CA  ALA B  21       9.513  11.117  11.323  1.00 50.00           C
ATOM      3  C   ALA B  21       9.313   9.628  11.029  1.00 50.00           C
ATOM      4  O   ALA B  21       9.731   8.751  11.795  1.00 50.00           O
ATOM      5  CB  ALA B  21      10.799  11.332  12.178  1.00 50.00           C
TER
"""

def exercise_03(prefix="tst_mi_test_03"):
  """ Check if working with NCS in the model"""
  # with cryst
  pdb_file = open("%s_start.pdb" % prefix, "w")
  pdb_file.write(cryst_str)
  pdb_file.write(pdb_str)
  pdb_file.close()
  cmd = " ".join([
      "phenix.model_idealization",
      "%s_start.pdb" % prefix,
      "number_of_refinement_cycles=1",
      "use_map_for_reference=False",
      "n_macro=1",
      ">%s.log" % prefix])
  print(cmd)
  assert not easy_run.call(cmd)
  assert os.path.isfile("%s_start.pdb_all_idealized.pdb" % prefix)
  res_log = open("%s.log" % prefix, "r")
  log_lines = res_log.readlines()
  for l in [
      # "Using NCS constraints.\n",
      "All done.\n"]:
    assert l in log_lines, "'%s' not in log file." % l
  res_log.close()

if (__name__ == "__main__"):
  t0 = time.time()
  if (not libtbx.env.has_module(name="probe")):
    print("Skipping test: probe not configured")
  else:
    exercise_03()
  print("Time: %.2f" % (time.time() - t0))
  print("OK")


 *******************************************************************************
