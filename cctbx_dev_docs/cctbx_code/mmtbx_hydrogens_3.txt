

 *******************************************************************************
mmtbx/hydrogens/tst_riding_coefficients.py
from __future__ import absolute_import, division, print_function
import time
from mmtbx_hydrogens_ext import *

# ----------------------------------------------------
# test some properties of riding_coefficients object
# in particular: deep_copy
# ----------------------------------------------------

# initialize riding_coefficients object
def set_object():
  rc1 = riding_coefficients(
    htype ='flat_2neigbs',
    ih    = 1,
    a0    = 5,
    a1    = 2,
    a2    = 3,
    a3    = 6,
    a     = 3.467,
    b     = 5.4,
    h     = 3.58,
    n     = 2,
    disth = 0.887)
  return rc1

# test getter and setter
def exercise1():
  rc1 = set_object()
  # test getter
  assert (rc1.htype == 'flat_2neigbs')
  assert (rc1.ih    == 1)
  assert (rc1.a0    == 5)
  assert (rc1.a1    == 2)
  assert (rc1.a2    == 3)
  assert (rc1.a3    == 6)
  assert (rc1.a     == 3.467)
  assert (rc1.b     == 5.4)
  assert (rc1.h     == 3.58)
  assert (rc1.n     == 2)
  assert (rc1.disth == 0.887)

  # test setter
  rc1.htype = '3neigbs'
  rc1.ih    = 10
  rc1.a0    = 11
  rc1.a1    = 12
  rc1.a2    = 13
  rc1.a3    = 14
  rc1.a     = 2.5
  rc1.b     = 3.5
  rc1.h     = 4.5
  rc1.n     = 1
  rc1.disth = 1.0

  assert (rc1.htype == '3neigbs')
  assert (rc1.ih    == 10)
  assert (rc1.a0    == 11)
  assert (rc1.a1    == 12)
  assert (rc1.a2    == 13)
  assert (rc1.a3    == 14)
  assert (rc1.a     == 2.5)
  assert (rc1.b     == 3.5)
  assert (rc1.h     == 4.5)
  assert (rc1.n     == 1)
  assert (rc1.disth == 1.0)

# shallow copy
def exercise2():
  rc1 = set_object()
  rc2 = rc1
  assert (rc1.ih == 1)
  assert (rc2.ih == 1)

  rc2.ih = 100
  assert (rc1.ih == 100)
  assert (rc2.ih == 100)

# deep copy
def exercise3():
  rc1 = set_object()
  rc2 = riding_coefficients(rc1)

  rc2.htype = '3neigbs'
  rc2.ih    = 10
  rc2.a0    = 11
  rc2.a1    = 12
  rc2.a2    = 13
  rc2.a3    = 14
  rc2.a     = 2.5
  rc2.b     = 3.5
  rc2.h     = 4.5
  rc2.n     = 1
  rc2.disth = 1.0

  assert (rc1.htype == 'flat_2neigbs')
  assert (rc1.ih    == 1)
  assert (rc1.a0    == 5)
  assert (rc1.a1    == 2)
  assert (rc1.a2    == 3)
  assert (rc1.a3    == 6)
  assert (rc1.a     == 3.467)
  assert (rc1.b     == 5.4)
  assert (rc1.h     == 3.58)
  assert (rc1.n     == 2)
  assert (rc1.disth == 0.887)

  assert (rc2.htype == '3neigbs')
  assert (rc2.ih    == 10)
  assert (rc2.a0    == 11)
  assert (rc2.a1    == 12)
  assert (rc2.a2    == 13)
  assert (rc2.a3    == 14)
  assert (rc2.a     == 2.5)
  assert (rc2.b     == 3.5)
  assert (rc2.h     == 4.5)
  assert (rc2.n     == 1)
  assert (rc2.disth == 1.0)

if (__name__ == "__main__"):
  t0 = time.time()
  exercise1()
  exercise2()
  exercise3()
  print("OK. Time: %8.3f"%(time.time()-t0))


 *******************************************************************************


 *******************************************************************************
mmtbx/hydrogens/tst_riding_fd_1.py
from __future__ import absolute_import, division, print_function
import time
import iotbx.pdb
import mmtbx.model
from cctbx.array_family import flex
from libtbx.utils import null_out
from libtbx.test_utils import approx_equal
from six.moves import zip
from six.moves import range

#-----------------------------------------------------------------------------
# Finite difference test for modified gradients of riding H
# Every type of H geometry is tested:
# planar H
# tetragonal H
# two tetragonal H
# X-H2 group (ARG etc)
# propeller group
# H with rotational degree of freedom (SER, etc)
#-----------------------------------------------------------------------------

def exercise(pdb_str, eps, use_ideal_bonds_angles):
  pdb_inp = iotbx.pdb.input(lines=pdb_str.split("\n"), source_info=None)
  model = mmtbx.model.manager(
            model_input = pdb_inp,
            log         = null_out())
  model.process(make_restraints=True)
  geometry_restraints = model.restraints_manager.geometry
  xray_structure = model.get_xray_structure()

  model.setup_riding_h_manager()
  riding_h_manager = model.get_riding_h_manager()

  riding_h_manager.idealize_riding_h_positions(xray_structure = xray_structure)

  sites_cart = xray_structure.sites_cart()

  g_analytical = geometry_restraints.energies_sites(
    sites_cart = sites_cart,
    compute_gradients = True).gradients

  hd_selection = xray_structure.hd_selection()
  g_analytical_reduced = riding_h_manager.gradients_reduced_cpp(
    gradients    = g_analytical,
    sites_cart   = sites_cart,
    hd_selection = hd_selection)

  ex = [eps,0,0]
  ey = [0,eps,0]
  ez = [0,0,eps]
  g_fd = flex.vec3_double()
  for i_site in range(sites_cart.size()):
    g_fd_i = []
    for e in [ex,ey,ez]:
      ts = []
      for sign in [-1,1]:
        sites_cart_ = sites_cart.deep_copy()
        xray_structure_ = xray_structure.deep_copy_scatterers()
        sites_cart_[i_site] = [
          sites_cart_[i_site][j]+e[j]*sign for j in range(3)]
        xray_structure_.set_sites_cart(sites_cart_)
        # after shift, recalculate H position
        riding_h_manager.idealize_riding_h_positions(
          xray_structure=xray_structure_)
        sites_cart_ = xray_structure_.sites_cart()
        ts.append(geometry_restraints.energies_sites(
          sites_cart = sites_cart_,
          compute_gradients = False).target)
      g_fd_i.append((ts[1]-ts[0])/(2*eps))
    g_fd.append(g_fd_i)

  g_fd_reduced = g_fd.select(~hd_selection)

  for g1, g2 in zip(g_analytical_reduced, g_fd_reduced):
    assert approx_equal(g1,g2, 1.e-4)

# alg2a shaked
pdb_str_00 = """
CRYST1   16.660   13.261   16.215  90.00  90.00  90.00 P 1
SCALE1      0.060024  0.000000  0.000000        0.00000
SCALE2      0.000000  0.075409  0.000000        0.00000
SCALE3      0.000000  0.000000  0.061671        0.00000
ATOM      6  CG  TYR A   7       8.528   6.445   8.572  1.00 15.00           C
ATOM      8  CD2 TYR A   7       8.348   7.014   9.545  1.00 15.00           C
ATOM     10  CE2 TYR A   7       7.068   7.273  10.230  1.00 15.00           C
ATOM     17  HD2 TYR A   7       9.064   7.637  10.081  1.00 15.00           H
TER
"""
# alg2a ideal geometry
pdb_str_01 = """
CRYST1   16.660   13.261   16.215  90.00  90.00  90.00 P 1
SCALE1      0.060024  0.000000  0.000000        0.00000
SCALE2      0.000000  0.075409  0.000000        0.00000
SCALE3      0.000000  0.000000  0.061671        0.00000
ATOM      1  CG  TYR A   7       8.544   6.391   8.506  1.00 15.00           C
ATOM      2  CD2 TYR A   7       8.334   7.144   9.654  1.00 15.00           C
ATOM      3  CE2 TYR A   7       7.078   7.251  10.220  1.00 15.00           C
ATOM      4  HD2 TYR A   7       9.052   7.584  10.049  1.00 15.00           H
TER
"""
# alg2b shaked
pdb_str_02 = """
CRYST1   16.660   13.261   16.215  90.00  90.00  90.00 P 1
SCALE1      0.060024  0.000000  0.000000        0.00000
SCALE2      0.000000  0.075409  0.000000        0.00000
SCALE3      0.000000  0.000000  0.061671        0.00000
ATOM      2  CA  TYR A   7       9.887   7.460   6.606  1.00 15.00           C
ATOM      5  CB  TYR A   7       9.830   6.306   7.775  1.00 15.00           C
ATOM      6  CG  TYR A   7       8.528   6.445   8.572  1.00 15.00           C
ATOM     14  HB2 TYR A   7       9.943   5.616   7.588  1.00 15.00           H
END
"""
# alg2b ideal geometry
pdb_str_03 = """
CRYST1   16.660   13.261   16.215  90.00  90.00  90.00 P 1
SCALE1      0.060024  0.000000  0.000000        0.00000
SCALE2      0.000000  0.075409  0.000000        0.00000
SCALE3      0.000000  0.000000  0.061671        0.00000
ATOM      2  CA  TYR A   7       9.962   6.614   6.452  1.00 15.00           C
ATOM      5  CB  TYR A   7       9.920   6.991   7.935  1.00 15.00           C
ATOM      6  CG  TYR A   7       8.575   6.781   8.602  1.00 15.00           C
ATOM     14  HB2 TYR A   7      10.571   6.452   8.411  1.00 15.00           H
"""

# alg3 shaked
pdb_str_04 = """
CRYST1   16.660   13.261   16.215  90.00  90.00  90.00 P 1
SCALE1      0.060024  0.000000  0.000000        0.00000
SCALE2      0.000000  0.075409  0.000000        0.00000
SCALE3      0.000000  0.000000  0.061671        0.00000
ATOM      1  N   TYR A   7       9.035   7.089   5.637  1.00 15.00           N
ATOM      2  CA  TYR A   7       9.887   7.460   6.606  1.00 15.00           C
ATOM      3  C   TYR A   7      11.285   7.169   6.250  1.00 15.00           C
ATOM      5  CB  TYR A   7       9.830   6.306   7.775  1.00 15.00           C
ATOM     13  HA  TYR A   7       9.831   8.340   7.271  1.00 15.00           H
"""

# alg3 ideal geometry
pdb_str_05 = """
CRYST1   16.660   13.261   16.215  90.00  90.00  90.00 P 1
SCALE1      0.060024  0.000000  0.000000        0.00000
SCALE2      0.000000  0.075409  0.000000        0.00000
SCALE3      0.000000  0.000000  0.061671        0.00000
ATOM      1  N   TYR A   7       8.981   7.170   5.658  1.00 15.00           N
ATOM      2  CA  TYR A   7       9.949   7.360   6.732  1.00 15.00           C
ATOM      3  C   TYR A   7      11.374   7.278   6.195  1.00 15.00           C
ATOM      4  CB  TYR A   7       9.740   6.317   7.832  1.00 15.00           C
ATOM      5  HA  TYR A   7       9.823   8.239   7.122  1.00 15.00           H
"""

# alg1a shaked
pdb_str_06 = """
CRYST1   14.446   16.451   11.913  90.00  90.00  90.00 P 1
SCALE1      0.069223  0.000000  0.000000        0.00000
SCALE2      0.000000  0.060787  0.000000        0.00000
SCALE3      0.000000  0.000000  0.083942        0.00000
ATOM      8  NE  ARG A  50       5.682   6.869   5.406  1.00 10.00           N
ATOM      9  CZ  ARG A  50       6.378   6.261   5.888  1.00 10.00           C
ATOM     10  NH1 ARG A  50       7.214   6.770   6.820  1.00 10.00           N
ATOM     11  NH2 ARG A  50       6.924   5.048   5.452  1.00 10.00           N
ATOM     21 HH12 ARG A  50       7.949   6.540   7.393  1.00 10.00           H
"""

# alg1a idealized
pdb_str_07 = """
CRYST1   14.446   16.451   11.913  90.00  90.00  90.00 P 1
SCALE1      0.069223  0.000000  0.000000        0.00000
SCALE2      0.000000  0.060787  0.000000        0.00000
SCALE3      0.000000  0.000000  0.083942        0.00000
ATOM      1  NE  ARG A  50       5.543   6.877   5.312  1.00 10.00           N
ATOM      2  CZ  ARG A  50       6.559   6.257   5.905  1.00 10.00           C
ATOM      3  NH1 ARG A  50       7.213   6.851   6.894  1.00 10.00           N
ATOM      4  NH2 ARG A  50       6.920   5.044   5.510  1.00 10.00           N
ATOM      6 HH12 ARG A  50       7.870   6.449   7.277  1.00 10.00           H
"""

#alg1b_flat shaked
pdb_str_08 = """
CRYST1   16.660   13.261   16.215  90.00  90.00  90.00 P 1
SCALE1      0.060024  0.000000  0.000000        0.00000
SCALE2      0.000000  0.075409  0.000000        0.00000
SCALE3      0.000000  0.000000  0.061671        0.00000
ATOM      9  CE1 TYR A   7       6.338   5.396   8.586  1.00 15.00           C
ATOM     10  CE2 TYR A   7       7.068   7.273  10.230  1.00 15.00           C
ATOM     11  CZ  TYR A   7       6.090   6.501   9.765  1.00 15.00           C
ATOM     12  OH  TYR A   7       4.857   6.463  10.553  1.00 15.00           O
ATOM     20  HH  TYR A   7       5.208   7.016  11.256  1.00 15.00           H
"""

#alg1b_flat idealized
pdb_str_09 = """
CRYST1   16.660   13.261   16.215  90.00  90.00  90.00 P 1
SCALE1      0.060024  0.000000  0.000000        0.00000
SCALE2      0.000000  0.075409  0.000000        0.00000
SCALE3      0.000000  0.000000  0.061671        0.00000
ATOM      1  CE1 TYR A   7       6.239   5.565   8.724  1.00 15.00           C
ATOM      2  CE2 TYR A   7       7.170   7.259  10.131  1.00 15.00           C
ATOM      3  CZ  TYR A   7       6.130   6.416   9.803  1.00 15.00           C
ATOM      4  OH  TYR A   7       4.978   6.424  10.555  1.00 15.00           O
ATOM      5  HH  TYR A   7       5.045   6.985  11.177  1.00 15.00           H
"""

#alg1b shaked (HH out of plane)
pdb_str_10 = """
CRYST1   16.660   13.261   16.215  90.00  90.00  90.00 P 1
SCALE1      0.060024  0.000000  0.000000        0.00000
SCALE2      0.000000  0.075409  0.000000        0.00000
SCALE3      0.000000  0.000000  0.061671        0.00000
ATOM      9  CE1 TYR A   7       6.231   6.395   8.363  1.00 15.00           C
ATOM     10  CE2 TYR A   7       7.119   6.748  10.501  1.00 15.00           C
ATOM     11  CZ  TYR A   7       5.926   6.249   9.983  1.00 15.00           C
ATOM     12  OH  TYR A   7       4.831   6.083  10.481  1.00 15.00           O
ATOM     20  HH  TYR A   7       4.708   6.641  11.301  1.00 15.00           H
"""

# alg1b idealized (HH out of plane)
pdb_str_11 = """
CRYST1   16.660   13.261   16.215  90.00  90.00  90.00 P 1
SCALE1      0.060024  0.000000  0.000000        0.00000
SCALE2      0.000000  0.075409  0.000000        0.00000
SCALE3      0.000000  0.000000  0.061671        0.00000
ATOM      9  CE1 TYR A   7       6.193   6.410   8.461  1.00 15.00           C
ATOM     10  CE2 TYR A   7       7.242   6.572  10.604  1.00 15.00           C
ATOM     11  CZ  TYR A   7       6.111   6.396   9.837  1.00 15.00           C
ATOM     12  OH  TYR A   7       4.893   6.206  10.448  1.00 15.00           O
ATOM     20  HH  TYR A   7       4.878   6.603  11.188  1.00 15.00           H
"""

#alg1a shaked with both H atoms
pdb_str_06_bla = """
CRYST1   14.446   16.451   11.913  90.00  90.00  90.00 P 1
SCALE1      0.069223  0.000000  0.000000        0.00000
SCALE2      0.000000  0.060787  0.000000        0.00000
SCALE3      0.000000  0.000000  0.083942        0.00000
ATOM      8  NE  ARG A  50       5.682   6.869   5.406  1.00 10.00           N
ATOM      9  CZ  ARG A  50       6.378   6.261   5.888  1.00 10.00           C
ATOM     10  NH1 ARG A  50       7.214   6.770   6.820  1.00 10.00           N
ATOM     11  NH2 ARG A  50       6.924   5.048   5.452  1.00 10.00           N
ATOM     20 HH11 ARG A  50       6.939   7.628   7.092  1.00 10.00           H
ATOM     21 HH12 ARG A  50       7.949   6.540   7.393  1.00 10.00           H
"""

pdb_list = [pdb_str_00, pdb_str_01, pdb_str_02, pdb_str_03,
  pdb_str_04, pdb_str_05, pdb_str_06, pdb_str_07, pdb_str_08, pdb_str_09,
  pdb_str_10, pdb_str_11]

pdb_list_name = ['pdb_str_00', 'pdb_str_01', 'pdb_str_02', 'pdb_str_03',
  'pdb_str_04', 'pdb_str_05', 'pdb_str_06', 'pdb_str_07', 'pdb_str_08',
  'pdb_str_09', 'pdb_str_10', 'pdb_str_11']

def run():
  for use_ideal_bonds_angles in [True, False]:
    for pdb_str, str_name in zip(pdb_list,pdb_list_name):
      #print 'pdb_string:', str_name, 'idealize =', idealize
      exercise(pdb_str=pdb_str, eps=1.e-4,
        use_ideal_bonds_angles=use_ideal_bonds_angles)

if (__name__ == "__main__"):
  t0 = time.time()
  run()
  print("OK. Time:", round(time.time()-t0, 2), "seconds")


 *******************************************************************************


 *******************************************************************************
mmtbx/hydrogens/tst_riding_fd_2.py
from __future__ import absolute_import, division, print_function
import time
import iotbx.pdb
import mmtbx.model
from cctbx.array_family import flex
from libtbx.utils import null_out
from libtbx.test_utils import approx_equal
from six.moves import zip
from six.moves import range

#-----------------------------------------------------------------------------
# This finite difference test checks transformation of riding H gradients
# for all amino acids, one by one
#-----------------------------------------------------------------------------
#
def exercise(pdb_str, eps):
  pdb_inp = iotbx.pdb.input(lines=pdb_str.split("\n"), source_info=None)

  model = mmtbx.model.manager(
            model_input = pdb_inp,
            log         = null_out())
  model.process(make_restraints=True)
  geometry_restraints = model.restraints_manager.geometry
  xray_structure = model.get_xray_structure()

  model.setup_riding_h_manager()
  riding_h_manager = model.get_riding_h_manager()

  riding_h_manager.idealize_riding_h_positions(xray_structure = xray_structure)

  sites_cart = xray_structure.sites_cart()

  g_analytical = geometry_restraints.energies_sites(
    sites_cart = sites_cart,
    compute_gradients = True).gradients

  hd_selection = xray_structure.hd_selection()
  g_analytical_reduced = riding_h_manager.gradients_reduced_cpp(
    gradients    = g_analytical,
    sites_cart   = sites_cart,
    hd_selection = hd_selection)

  #
  ex = [eps,0,0]
  ey = [0,eps,0]
  ez = [0,0,eps]
  g_fd = flex.vec3_double()
  for i_site in range(sites_cart.size()):
    g_fd_i = []
    for e in [ex,ey,ez]:
      ts = []
      for sign in [-1,1]:
        sites_cart_ = sites_cart.deep_copy()
        xray_structure_ = xray_structure.deep_copy_scatterers()
        sites_cart_[i_site] = [
          sites_cart_[i_site][j]+e[j]*sign for j in range(3)]
        xray_structure_.set_sites_cart(sites_cart_)
        # after shift, recalculate H position
        riding_h_manager.idealize_riding_h_positions(
          xray_structure=xray_structure_)
        sites_cart_ = xray_structure_.sites_cart()
        ts.append(geometry_restraints.energies_sites(
          sites_cart = sites_cart_,
          compute_gradients = False).target)
      g_fd_i.append((ts[1]-ts[0])/(2*eps))
    g_fd.append(g_fd_i)

  g_fd_reduced = g_fd.select(~hd_selection)

  for g1, g2 in zip(g_analytical_reduced, g_fd_reduced):
    assert approx_equal(g1,g2, 1.e-4)


#Alanine
pdb_str_01 = """
CRYST1   11.863   12.347   12.550  90.00  90.00  90.00 P 1
SCALE1      0.084296  0.000000  0.000000        0.00000
SCALE2      0.000000  0.080991  0.000000        0.00000
SCALE3      0.000000  0.000000  0.079681        0.00000
ATOM      1  N   ALA B  84       7.017   5.016   7.287  1.00 10.00           N
ATOM      2  CA  ALA B  84       5.784   5.706   7.445  1.00 10.00           C
ATOM      3  C   ALA B  84       5.129   5.694   6.011  1.00 10.00           C
ATOM      4  O   ALA B  84       5.714   5.812   4.900  1.00 10.00           O
ATOM      5  CB  ALA B  84       6.261   7.426   7.444  1.00 10.00           C
ATOM      6  HA  ALA B  84       5.269   5.787   7.982  1.00 10.00           H
ATOM      7  HB1 ALA B  84       5.337   8.016   7.304  1.00 10.00           H
ATOM      8  HB2 ALA B  84       6.549   7.313   8.459  1.00 10.00           H
ATOM      9  HB3 ALA B  84       6.616   7.667   6.795  1.00 10.00           H
"""
# Arginine:
pdb_str_02 = """
CRYST1   14.446   16.451   11.913  90.00  90.00  90.00 P 1
SCALE1      0.069223  0.000000  0.000000        0.00000
SCALE2      0.000000  0.060787  0.000000        0.00000
SCALE3      0.000000  0.000000  0.083942        0.00000
ATOM      1  N   ARG A  50       6.642  11.452   6.691  1.00 10.00           N
ATOM      2  CA  ARG A  50       7.570  10.240   6.682  1.00 10.00           C
ATOM      3  C   ARG A  50       9.005  10.280   6.707  1.00 10.00           C
ATOM      4  O   ARG A  50       9.602  11.108   6.810  1.00 10.00           O
ATOM      5  CB  ARG A  50       6.962   9.371   5.075  1.00 10.00           C
ATOM      6  CG  ARG A  50       5.382   9.275   4.806  1.00 10.00           C
ATOM      7  CD  ARG A  50       4.830   7.928   6.084  1.00 10.00           C
ATOM      8  NE  ARG A  50       5.434   6.841   5.374  1.00 10.00           N
ATOM      9  CZ  ARG A  50       6.450   6.116   6.035  1.00 10.00           C
ATOM     10  NH1 ARG A  50       7.392   6.694   6.803  1.00 10.00           N
ATOM     11  NH2 ARG A  50       6.898   5.026   5.305  1.00 10.00           N
ATOM     12  HA  ARG A  50       6.817   9.405   7.203  1.00 10.00           H
ATOM     13  HB2 ARG A  50       7.451   9.961   4.409  1.00 10.00           H
ATOM     14  HB3 ARG A  50       7.391   8.588   5.297  1.00 10.00           H
ATOM     15  HG2 ARG A  50       5.016  10.089   5.174  1.00 10.00           H
ATOM     16  HG3 ARG A  50       5.385   9.031   4.141  1.00 10.00           H
ATOM     17  HD2 ARG A  50       5.268   8.147   6.643  1.00 10.00           H
ATOM     18  HD3 ARG A  50       3.909   8.226   5.899  1.00 10.00           H
ATOM     19  HE  ARG A  50       5.208   6.478   4.962  1.00 10.00           H
ATOM     20 HH11 ARG A  50       6.970   7.301   7.302  1.00 10.00           H
ATOM     21 HH12 ARG A  50       7.866   6.356   7.069  1.00 10.00           H
ATOM     22 HH21 ARG A  50       6.604   4.626   5.005  1.00 10.00           H
ATOM     23 HH22 ARG A  50       7.522   4.396   5.734  1.00 10.00           H
"""
#Asparagine
pdb_str_03 = """
CRYST1   13.889   13.738   13.126  90.00  90.00  90.00 P 1
SCALE1      0.071999  0.000000  0.000000        0.00000
SCALE2      0.000000  0.072791  0.000000        0.00000
SCALE3      0.000000  0.000000  0.076185        0.00000
ATOM      1  N   ASN A  35       5.108   6.598   6.668  1.00 10.00           N
ATOM      2  CA  ASN A  35       6.071   7.634   7.159  1.00 10.00           C
ATOM      3  C   ASN A  35       6.113   8.702   6.163  1.00 10.00           C
ATOM      4  O   ASN A  35       5.556   8.558   4.817  1.00 10.00           O
ATOM      5  CB  ASN A  35       7.439   6.520   6.538  1.00 10.00           C
ATOM      6  CG  ASN A  35       7.597   5.465   7.487  1.00 10.00           C
ATOM      7  OD1 ASN A  35       6.743   4.980   8.032  1.00 10.00           O
ATOM      8  ND2 ASN A  35       8.841   4.827   7.318  1.00 10.00           N
ATOM      9  HA  ASN A  35       6.387   7.612   7.973  1.00 10.00           H
ATOM     10  HB2 ASN A  35       7.452   6.464   5.548  1.00 10.00           H
ATOM     11  HB3 ASN A  35       8.153   7.444   6.485  1.00 10.00           H
ATOM     12 HD21 ASN A  35       9.022   4.464   7.804  1.00 10.00           H
ATOM     13 HD22 ASN A  35       9.521   5.284   7.192  1.00 10.00           H
"""
# Aspartic Acid
pdb_str_04 = """
CRYST1   14.178   13.514   11.978  90.00  90.00  90.00 P 1
SCALE1      0.070532  0.000000  0.000000        0.00000
SCALE2      0.000000  0.073997  0.000000        0.00000
SCALE3      0.000000  0.000000  0.083486        0.00000
ATOM      1  N   ASP A 121       4.844   6.380   4.967  1.00 10.00           N
ATOM      2  CA  ASP A 121       6.237   6.469   5.750  1.00 10.00           C
ATOM      3  C   ASP A 121       5.959   7.525   7.138  1.00 10.00           C
ATOM      4  O   ASP A 121       5.683   8.452   6.797  1.00 10.00           O
ATOM      5  CB  ASP A 121       7.582   6.234   5.277  1.00 10.00           C
ATOM      6  CG  ASP A 121       8.550   6.163   6.136  1.00 10.00           C
ATOM      7  OD1 ASP A 121       9.035   5.174   6.337  1.00 10.00           O
ATOM      8  OD2 ASP A 121       9.115   7.253   6.644  1.00 10.00           O
ATOM      9  HA  ASP A 121       6.173   5.442   6.266  1.00 10.00           H
ATOM     10  HB2 ASP A 121       7.509   5.748   4.630  1.00 10.00           H
ATOM     11  HB3 ASP A 121       7.714   7.340   4.588  1.00 10.00           H
"""
# Cysteine
pdb_str_05 = """
CRYST1   12.081   11.399   14.639  90.00  90.00  90.00 P 1
SCALE1      0.082775  0.000000  0.000000        0.00000
SCALE2      0.000000  0.087727  0.000000        0.00000
SCALE3      0.000000  0.000000  0.068311        0.00000
ATOM      1  N   CYS A  96       4.823   5.221   7.409  1.00 10.00           N
ATOM      2  CA  CYS A  96       6.273   5.028   7.456  1.00 10.00           C
ATOM      3  C   CYS A  96       6.932   5.026   9.008  1.00 10.00           C
ATOM      4  O   CYS A  96       7.163   5.942   9.454  1.00 10.00           O
ATOM      5  CB  CYS A  96       6.905   6.223   6.813  1.00 10.00           C
ATOM      6  SG  CYS A  96       6.265   6.407   5.142  1.00 10.00           S
ATOM      7  HA  CYS A  96       6.714   4.104   6.960  1.00 10.00           H
ATOM      8  HB2 CYS A  96       6.849   7.034   6.999  1.00 10.00           H
ATOM      9  HB3 CYS A  96       8.130   6.106   6.575  1.00 10.00           H
ATOM     10  HG  CYS A  96       6.882   7.238   4.630  1.00 10.00           H
"""
# Glutamine
pdb_str_06 = """
CRYST1   14.547   13.375   15.374  90.00  90.00  90.00 P 1
SCALE1      0.068743  0.000000  0.000000        0.00000
SCALE2      0.000000  0.074766  0.000000        0.00000
SCALE3      0.000000  0.000000  0.065045        0.00000
ATOM      1  N   GLN A  70       6.344   7.129   5.035  1.00 10.00           N
ATOM      2  CA  GLN A  70       6.644   6.208   6.336  1.00 10.00           C
ATOM      3  C   GLN A  70       5.352   6.178   6.970  1.00 10.00           C
ATOM      4  O   GLN A  70       5.126   4.898   7.373  1.00 10.00           O
ATOM      5  CB  GLN A  70       7.877   6.998   7.230  1.00 10.00           C
ATOM      6  CG  GLN A  70       7.974   6.681   8.575  1.00 10.00           C
ATOM      7  CD  GLN A  70       9.249   7.237   9.063  1.00 10.00           C
ATOM      8  OE1 GLN A  70       9.559   8.209   8.935  1.00 10.00           O
ATOM      9  NE2 GLN A  70       9.506   6.762  10.402  1.00 10.00           N
ATOM     10  HA  GLN A  70       7.249   5.584   6.195  1.00 10.00           H
ATOM     11  HB2 GLN A  70       8.663   7.126   6.476  1.00 10.00           H
ATOM     12  HB3 GLN A  70       7.331   8.179   7.116  1.00 10.00           H
ATOM     13  HG2 GLN A  70       7.234   6.385   8.986  1.00 10.00           H
ATOM     14  HG3 GLN A  70       8.549   5.809   8.279  1.00 10.00           H
ATOM     15 HE21 GLN A  70       9.114   6.119  10.657  1.00 10.00           H
ATOM     16 HE22 GLN A  70      10.235   7.102  10.671  1.00 10.00           H
"""
# Glutamic Acid
pdb_str_07 = """
CRYST1   15.127   14.767   13.161  90.00  90.00  90.00 P 1
SCALE1      0.066107  0.000000  0.000000        0.00000
SCALE2      0.000000  0.067719  0.000000        0.00000
SCALE3      0.000000  0.000000  0.075982        0.00000
ATOM      1  N   GLU A  24       9.022   8.042   4.852  1.00 10.00           N
ATOM      2  CA  GLU A  24       8.611   8.384   6.596  1.00 10.00           C
ATOM      3  C   GLU A  24       9.851   8.805   7.028  1.00 10.00           C
ATOM      4  O   GLU A  24      10.208   9.672   7.827  1.00 10.00           O
ATOM      5  CB  GLU A  24       8.163   7.285   7.084  1.00 10.00           C
ATOM      6  CG  GLU A  24       6.610   6.769   6.720  1.00 10.00           C
ATOM      7  CD  GLU A  24       6.069   5.633   7.216  1.00 10.00           C
ATOM      8  OE1 GLU A  24       5.180   5.275   7.007  1.00 10.00           O
ATOM      9  OE2 GLU A  24       6.826   5.071   8.182  1.00 10.00           O
ATOM     10  HA  GLU A  24       8.239   8.942   6.618  1.00 10.00           H
ATOM     11  HB2 GLU A  24       8.834   6.577   7.107  1.00 10.00           H
ATOM     12  HB3 GLU A  24       8.074   7.246   7.880  1.00 10.00           H
ATOM     13  HG2 GLU A  24       5.925   7.518   6.600  1.00 10.00           H
ATOM     14  HG3 GLU A  24       6.944   6.683   5.520  1.00 10.00           H
"""
# Glycine
pdb_str_08 = """
CRYST1   13.147   11.167   10.709  90.00  90.00  90.00 P 1
SCALE1      0.076063  0.000000  0.000000        0.00000
SCALE2      0.000000  0.089550  0.000000        0.00000
SCALE3      0.000000  0.000000  0.093379        0.00000
ATOM      1  N   GLY B  93       8.304   6.036   5.544  1.00 10.00           N
ATOM      2  CA  GLY B  93       7.319   4.905   5.595  1.00 10.00           C
ATOM      3  C   GLY B  93       5.882   5.364   4.847  1.00 10.00           C
ATOM      4  O   GLY B  93       5.143   5.776   5.738  1.00 10.00           O
ATOM      5  HA2 GLY B  93       7.870   4.339   5.372  1.00 10.00           H
ATOM      6  HA3 GLY B  93       7.123   4.618   6.529  1.00 10.00           H
"""

# Histidine
pdb_str_09 = """
CRYST1   12.286   14.857   15.512  90.00  90.00  90.00 P 1
SCALE1      0.081393  0.000000  0.000000        0.00000
SCALE2      0.000000  0.067308  0.000000        0.00000
SCALE3      0.000000  0.000000  0.064466        0.00000
ATOM      1  N   HIS A  34       7.292   7.714   9.065  1.00 10.00           N
ATOM      2  CA  HIS A  34       6.363   8.592   8.255  1.00 10.00           C
ATOM      3  C   HIS A  34       6.024   9.792   9.401  1.00 10.00           C
ATOM      4  O   HIS A  34       6.246   9.507  10.701  1.00 10.00           O
ATOM      5  CB  HIS A  34       4.951   8.082   8.105  1.00 10.00           C
ATOM      6  CG  HIS A  34       5.323   6.839   7.073  1.00 10.00           C
ATOM      7  ND1 HIS A  34       5.021   7.108   5.763  1.00 10.00           N
ATOM      8  CD2 HIS A  34       5.317   5.623   7.295  1.00 10.00           C
ATOM      9  CE1 HIS A  34       5.333   5.771   5.081  1.00 10.00           C
ATOM     10  NE2 HIS A  34       5.601   4.927   6.077  1.00 10.00           N
ATOM     11  HA  HIS A  34       6.539   9.000   7.667  1.00 10.00           H
ATOM     12  HB2 HIS A  34       4.722   7.760   8.940  1.00 10.00           H
ATOM     13  HB3 HIS A  34       4.532   8.544   7.770  1.00 10.00           H
ATOM     14  HD2 HIS A  34       5.433   5.063   7.987  1.00 10.00           H
ATOM     15  HE1 HIS A  34       5.162   5.891   3.986  1.00 10.00           H
"""
# Isoleucine
pdb_str_10 = """
CRYST1   14.040   13.236   13.685  90.00  90.00  90.00 P 1
SCALE1      0.071225  0.000000  0.000000        0.00000
SCALE2      0.000000  0.075552  0.000000        0.00000
SCALE3      0.000000  0.000000  0.073073        0.00000
ATOM      1  N   ILE B  81       6.774   6.654   8.528  1.00 10.00           N
ATOM      2  CA  ILE B  81       6.248   6.915   7.265  1.00 10.00           C
ATOM      3  C   ILE B  81       5.064   5.915   6.912  1.00 10.00           C
ATOM      4  O   ILE B  81       4.891   4.882   7.591  1.00 10.00           O
ATOM      5  CB  ILE B  81       7.374   7.060   6.201  1.00 10.00           C
ATOM      6  CG1 ILE B  81       7.928   5.644   6.013  1.00 10.00           C
ATOM      7  CG2 ILE B  81       8.450   8.146   6.766  1.00 10.00           C
ATOM      8  CD1 ILE B  81       9.014   5.797   4.814  1.00 10.00           C
ATOM      9  HA  ILE B  81       5.805   7.933   7.605  1.00 10.00           H
ATOM     10  HB  ILE B  81       6.968   7.172   5.320  1.00 10.00           H
ATOM     11 HG12 ILE B  81       8.488   5.662   7.117  1.00 10.00           H
ATOM     12 HG13 ILE B  81       7.287   4.921   5.901  1.00 10.00           H
ATOM     13 HG21 ILE B  81       8.841   8.468   5.740  1.00 10.00           H
ATOM     14 HG22 ILE B  81       7.916   9.169   6.877  1.00 10.00           H
ATOM     15 HG23 ILE B  81       8.650   8.115   7.619  1.00 10.00           H
ATOM     16 HD11 ILE B  81       9.263   4.839   4.994  1.00 10.00           H
ATOM     17 HD12 ILE B  81       8.679   5.953   4.216  1.00 10.00           H
ATOM     18 HD13 ILE B  81       9.551   6.406   5.137  1.00 10.00           H
"""

# Leucine
pdb_str_11 = """
CRYST1   13.550   15.138   12.702  90.00  90.00  90.00 P 1
SCALE1      0.073801  0.000000  0.000000        0.00000
SCALE2      0.000000  0.066059  0.000000        0.00000
SCALE3      0.000000  0.000000  0.078728        0.00000
ATOM      1  N   LEU B  94       6.273   6.593   4.935  1.00 10.00           N
ATOM      2  CA  LEU B  94       7.641   7.224   5.628  1.00 10.00           C
ATOM      3  C   LEU B  94       8.422   6.084   6.113  1.00 10.00           C
ATOM      4  O   LEU B  94       8.638   5.157   5.672  1.00 10.00           O
ATOM      5  CB  LEU B  94       7.066   8.117   6.861  1.00 10.00           C
ATOM      6  CG  LEU B  94       6.206   9.526   6.450  1.00 10.00           C
ATOM      7  CD1 LEU B  94       5.918  10.237   7.727  1.00 10.00           C
ATOM      8  CD2 LEU B  94       4.891   9.251   5.577  1.00 10.00           C
ATOM      9  HA  LEU B  94       7.928   7.858   4.837  1.00 10.00           H
ATOM     10  HB2 LEU B  94       6.600   7.347   7.185  1.00 10.00           H
ATOM     11  HB3 LEU B  94       7.833   8.235   7.219  1.00 10.00           H
ATOM     12  HG  LEU B  94       7.048   9.715   5.954  1.00 10.00           H
ATOM     13 HD11 LEU B  94       5.564  11.132   7.460  1.00 10.00           H
ATOM     14 HD12 LEU B  94       5.689   9.764   8.196  1.00 10.00           H
ATOM     15 HD13 LEU B  94       6.901  10.482   8.316  1.00 10.00           H
ATOM     16 HD21 LEU B  94       4.622   9.894   5.701  1.00 10.00           H
ATOM     17 HD22 LEU B  94       5.223   8.782   4.700  1.00 10.00           H
ATOM     18 HD23 LEU B  94       4.327   8.453   6.346  1.00 10.00           H
"""

# Lysine
pdb_str_12 = """
CRYST1   14.470   17.497   11.416  90.00  90.00  90.00 P 1
SCALE1      0.069109  0.000000  0.000000        0.00000
SCALE2      0.000000  0.057153  0.000000        0.00000
SCALE3      0.000000  0.000000  0.087596        0.00000
ATOM      1  N   LYS A  76       4.981  10.159   4.860  1.00 10.00           N
ATOM      2  CA  LYS A  76       5.876  10.071   6.050  1.00 10.00           C
ATOM      3  C   LYS A  76       6.304  11.829   6.325  1.00 10.00           C
ATOM      4  O   LYS A  76       5.161  12.466   6.576  1.00 10.00           O
ATOM      5  CB  LYS A  76       7.337   9.388   5.906  1.00 10.00           C
ATOM      6  CG  LYS A  76       7.118   7.831   5.788  1.00 10.00           C
ATOM      7  CD  LYS A  76       8.453   7.428   5.736  1.00 10.00           C
ATOM      8  CE  LYS A  76       8.134   5.835   5.433  1.00 10.00           C
ATOM      9  NZ  LYS A  76       9.426   4.919   5.392  1.00 10.00           N
ATOM     10  HA  LYS A  76       5.397  10.002   6.803  1.00 10.00           H
ATOM     11  HB2 LYS A  76       7.655   9.920   5.112  1.00 10.00           H
ATOM     12  HB3 LYS A  76       7.624   9.427   6.543  1.00 10.00           H
ATOM     13  HG2 LYS A  76       6.592   7.548   6.676  1.00 10.00           H
ATOM     14  HG3 LYS A  76       6.469   7.536   5.090  1.00 10.00           H
ATOM     15  HD2 LYS A  76       8.768   7.405   4.630  1.00 10.00           H
ATOM     16  HD3 LYS A  76       9.025   7.220   6.546  1.00 10.00           H
ATOM     17  HE2 LYS A  76       7.580   5.564   6.304  1.00 10.00           H
ATOM     18  HE3 LYS A  76       7.440   5.632   4.831  1.00 10.00           H
ATOM     19  HZ1 LYS A  76       9.379   4.186   5.442  1.00 10.00           H
ATOM     20  HZ2 LYS A  76       9.725   5.254   4.549  1.00 10.00           H
ATOM     21  HZ3 LYS A  76       9.965   5.006   6.093  1.00 10.00           H
"""

# Methionine
pdb_str_13 = """
CRYST1   13.775   12.351   15.645  90.00  90.00  90.00 P 1
SCALE1      0.072595  0.000000  0.000000        0.00000
SCALE2      0.000000  0.080965  0.000000        0.00000
SCALE3      0.000000  0.000000  0.063918        0.00000
ATOM      1  N   MET B  37       7.603   5.375   6.446  1.00 10.00           N
ATOM      2  CA  MET B  37       6.723   6.349   6.607  1.00 10.00           C
ATOM      3  C   MET B  37       6.323   7.146   5.241  1.00 10.00           C
ATOM      4  O   MET B  37       5.062   7.131   4.970  1.00 10.00           O
ATOM      5  CB  MET B  37       6.932   7.378   7.483  1.00 10.00           C
ATOM      6  CG  MET B  37       7.258   6.900   9.095  1.00 10.00           C
ATOM      7  SD  MET B  37       8.785   5.488   9.096  1.00 10.00           S
ATOM      8  CE  MET B  37       8.590   5.149  10.517  1.00 10.00           C
ATOM      9  HA  MET B  37       5.885   6.031   6.839  1.00 10.00           H
ATOM     10  HB2 MET B  37       7.862   7.670   7.351  1.00 10.00           H
ATOM     11  HB3 MET B  37       6.364   7.936   7.854  1.00 10.00           H
ATOM     12  HG2 MET B  37       7.509   7.571   9.764  1.00 10.00           H
ATOM     13  HG3 MET B  37       6.614   6.240   9.246  1.00 10.00           H
ATOM     14  HE1 MET B  37       9.624   4.355  10.601  1.00 10.00           H
ATOM     15  HE2 MET B  37       9.070   5.811  11.280  1.00 10.00           H
ATOM     16  HE3 MET B  37       8.003   4.499  11.109  1.00 10.00           H
"""

# Phenylanaline
pdb_str_14 = """
CRYST1   11.802   16.578   13.976  90.00  90.00  90.00 P 1
SCALE1      0.084731  0.000000  0.000000        0.00000
SCALE2      0.000000  0.060321  0.000000        0.00000
SCALE3      0.000000  0.000000  0.071551        0.00000
ATOM      1  N   PHE A  63       6.412   9.770   7.572  1.00 10.00           N
ATOM      2  CA  PHE A  63       6.289   9.157   6.198  1.00 10.00           C
ATOM      3  C   PHE A  63       6.292  10.223   5.110  1.00 10.00           C
ATOM      4  O   PHE A  63       6.451  11.437   5.241  1.00 10.00           O
ATOM      5  CB  PHE A  63       5.580   8.319   6.063  1.00 10.00           C
ATOM      6  CG  PHE A  63       5.743   6.958   6.849  1.00 10.00           C
ATOM      7  CD1 PHE A  63       6.569   6.117   6.768  1.00 10.00           C
ATOM      8  CD2 PHE A  63       5.050   7.055   8.045  1.00 10.00           C
ATOM      9  CE1 PHE A  63       6.802   5.054   7.620  1.00 10.00           C
ATOM     10  CE2 PHE A  63       5.331   6.153   8.840  1.00 10.00           C
ATOM     11  CZ  PHE A  63       6.270   5.103   8.840  1.00 10.00           C
ATOM     12  HA  PHE A  63       7.224   9.004   5.959  1.00 10.00           H
ATOM     13  HB2 PHE A  63       4.619   8.277   5.936  1.00 10.00           H
ATOM     14  HB3 PHE A  63       5.713   7.612   5.105  1.00 10.00           H
ATOM     15  HD1 PHE A  63       7.301   6.004   5.919  1.00 10.00           H
ATOM     16  HD2 PHE A  63       4.436   7.641   8.314  1.00 10.00           H
ATOM     17  HE1 PHE A  63       7.224   4.307   7.397  1.00 10.00           H
ATOM     18  HE2 PHE A  63       4.727   6.172   9.862  1.00 10.00           H
ATOM     19  HZ  PHE A  63       6.045   4.444   9.418  1.00 10.00           H
"""

# Proline
pdb_str_15 = """
CRYST1   12.293   14.006   12.486  90.00  90.00  90.00 P 1
SCALE1      0.081347  0.000000  0.000000        0.00000
SCALE2      0.000000  0.071398  0.000000        0.00000
SCALE3      0.000000  0.000000  0.080090        0.00000
ATOM      1  N   PRO A   4       4.920   7.325   6.411  1.00 10.00           N
ATOM      2  CA  PRO A   4       6.162   6.834   5.666  1.00 10.00           C
ATOM      3  C   PRO A   4       6.405   5.341   5.894  1.00 10.00           C
ATOM      4  O   PRO A   4       7.098   4.853   4.957  1.00 10.00           O
ATOM      5  CB  PRO A   4       7.380   7.894   6.618  1.00 10.00           C
ATOM      6  CG  PRO A   4       6.640   8.868   7.204  1.00 10.00           C
ATOM      7  CD  PRO A   4       5.415   8.476   7.560  1.00 10.00           C
ATOM      8  HA  PRO A   4       6.250   7.067   4.776  1.00 10.00           H
ATOM      9  HB2 PRO A   4       7.921   7.337   7.346  1.00 10.00           H
ATOM     10  HB3 PRO A   4       8.016   8.080   5.830  1.00 10.00           H
ATOM     11  HG2 PRO A   4       7.167   9.579   7.723  1.00 10.00           H
ATOM     12  HG3 PRO A   4       6.492   9.649   6.528  1.00 10.00           H
ATOM     13  HD2 PRO A   4       5.306   8.082   8.255  1.00 10.00           H
ATOM     14  HD3 PRO A   4       4.496   9.094   7.222  1.00 10.00           H
"""

# Serine
pdb_str_16 = """
CRYST1   12.893   12.708   12.721  90.00  90.00  90.00 P 1
SCALE1      0.077561  0.000000  0.000000        0.00000
SCALE2      0.000000  0.078691  0.000000        0.00000
SCALE3      0.000000  0.000000  0.078610        0.00000
ATOM      1  N   SER A  73       5.347   5.750   5.075  1.00 10.00           N
ATOM      2  CA  SER A  73       5.894   5.594   6.421  1.00 10.00           C
ATOM      3  C   SER A  73       5.946   7.282   6.996  1.00 10.00           C
ATOM      4  O   SER A  73       5.026   7.627   7.452  1.00 10.00           O
ATOM      5  CB  SER A  73       7.501   5.019   6.235  1.00 10.00           C
ATOM      6  OG  SER A  73       8.063   4.929   7.844  1.00 10.00           O
ATOM      7  HA  SER A  73       5.300   5.295   7.021  1.00 10.00           H
ATOM      8  HB2 SER A  73       7.399   4.067   6.115  1.00 10.00           H
ATOM      9  HB3 SER A  73       8.072   5.776   5.734  1.00 10.00           H
ATOM     10  HG  SER A  73       8.499   4.647   7.768  1.00 10.00           H
"""

# Threonine
pdb_str_17 = """
CRYST1   11.909   12.199   14.459  90.00  90.00  90.00 P 1
SCALE1      0.083970  0.000000  0.000000        0.00000
SCALE2      0.000000  0.081974  0.000000        0.00000
SCALE3      0.000000  0.000000  0.069161        0.00000
ATOM      1  N   THR A  68       6.967   7.035   7.598  1.00 10.00           N
ATOM      2  CA  THR A  68       5.580   6.835   7.409  1.00 10.00           C
ATOM      3  C   THR A  68       4.981   6.180   8.674  1.00 10.00           C
ATOM      4  O   THR A  68       6.079   5.829   9.469  1.00 10.00           O
ATOM      5  CB  THR A  68       5.071   6.452   6.355  1.00 10.00           C
ATOM      6  OG1 THR A  68       5.819   5.087   6.249  1.00 10.00           O
ATOM      7  CG2 THR A  68       5.178   7.219   5.045  1.00 10.00           C
ATOM      8  HA  THR A  68       4.978   7.946   7.649  1.00 10.00           H
ATOM      9  HB  THR A  68       3.853   6.156   6.182  1.00 10.00           H
ATOM     10  HG1 THR A  68       6.272   5.006   6.437  1.00 10.00           H
ATOM     11 HG21 THR A  68       5.183   6.722   4.241  1.00 10.00           H
ATOM     12 HG22 THR A  68       4.943   8.119   5.225  1.00 10.00           H
ATOM     13 HG23 THR A  68       6.305   7.117   4.778  1.00 10.00           H
"""

# Triptophane
pdb_str_18 = """
CRYST1   12.502   12.982   18.312  90.00  90.00  90.00 P 1
SCALE1      0.079987  0.000000  0.000000        0.00000
SCALE2      0.000000  0.077030  0.000000        0.00000
SCALE3      0.000000  0.000000  0.054609        0.00000
ATOM      1  N   TRP A  49       7.019   6.036   6.855  1.00 10.00           N
ATOM      2  CA  TRP A  49       6.009   5.654   7.261  1.00 10.00           C
ATOM      3  C   TRP A  49       5.132   5.145   5.877  1.00 10.00           C
ATOM      4  O   TRP A  49       5.267   5.983   5.027  1.00 10.00           O
ATOM      5  CB  TRP A  49       5.058   6.563   8.316  1.00 10.00           C
ATOM      6  CG  TRP A  49       6.065   6.967   9.207  1.00 10.00           C
ATOM      7  CD1 TRP A  49       6.863   7.994   9.455  1.00 10.00           C
ATOM      8  CD2 TRP A  49       5.959   6.505  10.743  1.00 10.00           C
ATOM      9  NE1 TRP A  49       7.435   8.004  10.831  1.00 10.00           N
ATOM     10  CE2 TRP A  49       6.803   7.200  11.335  1.00 10.00           C
ATOM     11  CE3 TRP A  49       5.119   5.187  11.318  1.00 10.00           C
ATOM     12  CZ2 TRP A  49       7.129   6.620  12.976  1.00 10.00           C
ATOM     13  CZ3 TRP A  49       5.299   5.155  12.457  1.00 10.00           C
ATOM     14  CH2 TRP A  49       6.374   5.658  13.211  1.00 10.00           C
ATOM     15  HA  TRP A  49       6.139   4.842   7.608  1.00 10.00           H
ATOM     16  HB2 TRP A  49       5.070   7.319   7.481  1.00 10.00           H
ATOM     17  HB3 TRP A  49       4.305   6.336   8.251  1.00 10.00           H
ATOM     18  HD1 TRP A  49       7.226   8.582   8.796  1.00 10.00           H
ATOM     19  HE1 TRP A  49       8.120   8.555  10.929  1.00 10.00           H
ATOM     20  HE3 TRP A  49       4.311   5.074  10.564  1.00 10.00           H
ATOM     21  HZ2 TRP A  49       7.806   7.092  13.214  1.00 10.00           H
ATOM     22  HZ3 TRP A  49       4.914   4.129  12.933  1.00 10.00           H
ATOM     23  HH2 TRP A  49       6.353   5.513  14.064  1.00 10.00           H
"""

# Tyrosine
pdb_str_19 = """
CRYST1   17.955   13.272   13.095  90.00  90.00  90.00 P 1
SCALE1      0.055695  0.000000  0.000000        0.00000
SCALE2      0.000000  0.075347  0.000000        0.00000
SCALE3      0.000000  0.000000  0.076365        0.00000
ATOM      1  N   TYR A 139      10.057   7.968   5.049  1.00 10.00           N
ATOM      2  CA  TYR A 139      10.657   7.531   6.379  1.00 10.00           C
ATOM      3  C   TYR A 139      12.203   7.725   6.416  1.00 10.00           C
ATOM      4  O   TYR A 139      12.999   8.272   7.373  1.00 10.00           O
ATOM      5  CB  TYR A 139      10.644   6.145   6.711  1.00 10.00           C
ATOM      6  CG  TYR A 139       9.159   5.899   6.690  1.00 10.00           C
ATOM      7  CD1 TYR A 139       8.503   5.230   5.513  1.00 10.00           C
ATOM      8  CD2 TYR A 139       8.317   6.046   8.121  1.00 10.00           C
ATOM      9  CE1 TYR A 139       6.876   4.938   5.643  1.00 10.00           C
ATOM     10  CE2 TYR A 139       7.209   5.706   8.077  1.00 10.00           C
ATOM     11  CZ  TYR A 139       6.420   5.365   6.855  1.00 10.00           C
ATOM     12  OH  TYR A 139       5.027   4.949   7.088  1.00 10.00           O
ATOM     13  HA  TYR A 139      10.303   8.174   6.785  1.00 10.00           H
ATOM     14  HB2 TYR A 139      10.989   5.647   5.882  1.00 10.00           H
ATOM     15  HB3 TYR A 139      10.828   5.883   7.586  1.00 10.00           H
ATOM     16  HD1 TYR A 139       8.618   5.356   4.741  1.00 10.00           H
ATOM     17  HD2 TYR A 139       8.841   6.121   8.546  1.00 10.00           H
ATOM     18  HE1 TYR A 139       6.432   5.030   4.892  1.00 10.00           H
ATOM     19  HE2 TYR A 139       6.780   5.619   9.066  1.00 10.00           H
ATOM     20  HH  TYR A 139       4.693   5.141   7.840  1.00 10.00           H
"""

# Valine
pdb_str_20 = """
CRYST1   12.396   13.122   13.130  90.00  90.00  90.00 P 1
SCALE1      0.080671  0.000000  0.000000        0.00000
SCALE2      0.000000  0.076208  0.000000        0.00000
SCALE3      0.000000  0.000000  0.076161        0.00000
ATOM      1  N   VAL B  78       4.820   5.520   7.634  1.00 10.00           N
ATOM      2  CA  VAL B  78       6.105   5.869   7.138  1.00 10.00           C
ATOM      3  C   VAL B  78       6.717   7.176   8.084  1.00 10.00           C
ATOM      4  O   VAL B  78       5.750   8.012   8.022  1.00 10.00           O
ATOM      5  CB  VAL B  78       6.029   6.374   5.701  1.00 10.00           C
ATOM      6  CG1 VAL B  78       5.673   4.961   4.874  1.00 10.00           C
ATOM      7  CG2 VAL B  78       7.349   6.810   5.233  1.00 10.00           C
ATOM      8  HA  VAL B  78       7.125   5.144   7.411  1.00 10.00           H
ATOM      9  HB  VAL B  78       5.404   6.962   5.498  1.00 10.00           H
ATOM     10 HG11 VAL B  78       5.583   5.210   4.024  1.00 10.00           H
ATOM     11 HG12 VAL B  78       6.062   4.120   5.126  1.00 10.00           H
ATOM     12 HG13 VAL B  78       4.907   4.924   5.317  1.00 10.00           H
ATOM     13 HG21 VAL B  78       7.299   7.038   4.409  1.00 10.00           H
ATOM     14 HG22 VAL B  78       7.542   7.634   5.823  1.00 10.00           H
ATOM     15 HG23 VAL B  78       7.889   5.963   5.346  1.00 10.00           H
"""

pdb_list = [pdb_str_01, pdb_str_02, pdb_str_03, pdb_str_04, pdb_str_05,
  pdb_str_06, pdb_str_07, pdb_str_08, pdb_str_09, pdb_str_10, pdb_str_11,
  pdb_str_12, pdb_str_13, pdb_str_14, pdb_str_15, pdb_str_16, pdb_str_17,
  pdb_str_18, pdb_str_19, pdb_str_20]
#
pdb_list_name = ['pdb_str_01', 'pdb_str_02', 'pdb_str_03', 'pdb_str_04', 'pdb_str_05',
  'pdb_str_06', 'pdb_str_07', 'pdb_str_08', 'pdb_str_09', 'pdb_str_10', 'pdb_str_11',
  'pdb_str_12', 'pdb_str_13', 'pdb_str_14', 'pdb_str_15', 'pdb_str_16', 'pdb_str_17',
  'pdb_str_18', 'pdb_str_19', 'pdb_str_20']

#pdb_list = [pdb_str_02]
#pdb_list_name = ['pdb_str_02']

def run():
  #for use_ideal_bonds_angles in [True, False]:
  for pdb_str, str_name in zip(pdb_list,pdb_list_name):
      #print 'pdb_string:', str_name, 'idealize =', idealize
    exercise(pdb_str=pdb_str, eps=1.e-4)


if (__name__ == "__main__"):
  t0 = time.time()
  run()
  print("OK. Time:", round(time.time()-t0, 2), "seconds")


 *******************************************************************************


 *******************************************************************************
mmtbx/hydrogens/tst_riding_fd_3.py
from __future__ import absolute_import, division, print_function
import time
import iotbx.pdb
import mmtbx.model
from cctbx.array_family import flex
from libtbx.utils import null_out
from libtbx.test_utils import approx_equal
from six.moves import zip
from six.moves import range

def exercise(pdb_str, eps):
  pdb_inp = iotbx.pdb.input(lines=pdb_str.split("\n"), source_info=None)

  model = mmtbx.model.manager(
            model_input = pdb_inp,
            log         = null_out())
  model.process(make_restraints=True)
  geometry_restraints = model.restraints_manager.geometry
  xray_structure = model.get_xray_structure()

  model.setup_riding_h_manager()
  riding_h_manager = model.get_riding_h_manager()

  riding_h_manager.idealize_riding_h_positions(xray_structure=xray_structure)

  sites_cart = xray_structure.sites_cart()

  g_analytical = geometry_restraints.energies_sites(
    sites_cart = sites_cart,
    compute_gradients = True).gradients

  hd_selection = xray_structure.hd_selection()
  g_analytical_reduced = riding_h_manager.gradients_reduced_cpp(
    gradients    = g_analytical,
    sites_cart   = sites_cart,
    hd_selection = hd_selection)
  #
  ex = [eps,0,0]
  ey = [0,eps,0]
  ez = [0,0,eps]
  g_fd = flex.vec3_double()
  for i_site in range(sites_cart.size()):
    g_fd_i = []
    for e in [ex,ey,ez]:
      ts = []
      for sign in [-1,1]:
        sites_cart_ = sites_cart.deep_copy()
        xray_structure_ = xray_structure.deep_copy_scatterers()
        sites_cart_[i_site] = [
          sites_cart_[i_site][j]+e[j]*sign for j in range(3)]
        xray_structure_.set_sites_cart(sites_cart_)
        # after shift, recalculate H position
        riding_h_manager.idealize_riding_h_positions(
          xray_structure=xray_structure_)
        sites_cart_ = xray_structure_.sites_cart()
        ts.append(geometry_restraints.energies_sites(
          sites_cart = sites_cart_,
          compute_gradients = False).target)
      g_fd_i.append((ts[1]-ts[0])/(2*eps))
    g_fd.append(g_fd_i)

  g_fd_reduced = g_fd.select(~hd_selection)

  for g1, g2 in zip(g_analytical_reduced, g_fd_reduced):
    assert approx_equal(g1,g2, 1.e-4)


pdb_str = """
CRYST1   30.000   30.000   30.000  90.00  90.00  90.00 P 1
SCALE1      0.033333  0.000000  0.000000        0.00000
SCALE2      0.000000  0.033333  0.000000        0.00000
SCALE3      0.000000  0.000000  0.033333        0.00000
ATOM      1  N   ARG A   2       3.050  19.481  25.856  1.00  0.00           N
ATOM      2  CA  ARG A   2       3.759  20.265  24.852  1.00  0.00           C
ATOM      3  C   ARG A   2       5.253  20.304  25.155  1.00  0.00           C
ATOM      4  O   ARG A   2       5.659  20.516  26.298  1.00  0.00           O
ATOM      5  CB  ARG A   2       3.197  21.687  24.787  1.00  0.00           C
ATOM      6  CG  ARG A   2       3.800  22.542  23.684  1.00  0.00           C
ATOM      7  CD  ARG A   2       3.128  23.904  23.607  1.00  0.00           C
ATOM      8  NE  ARG A   2       3.721  24.751  22.576  1.00  0.00           N
ATOM      9  CZ  ARG A   2       3.311  25.983  22.290  1.00  0.00           C
ATOM     10  NH1 ARG A   2       2.301  26.525  22.957  1.00  0.00           N1+
ATOM     11  NH2 ARG A   2       3.914  26.676  21.334  1.00  0.00           N
ATOM     12  HA  ARG A   2       3.638  19.852  23.983  1.00  0.00           H
ATOM     13  HB2 ARG A   2       2.240  21.637  24.633  1.00  0.00           H
ATOM     14  HB3 ARG A   2       3.370  22.129  25.633  1.00  0.00           H
ATOM     15  HG2 ARG A   2       4.743  22.680  23.864  1.00  0.00           H
ATOM     16  HG3 ARG A   2       3.682  22.096  22.831  1.00  0.00           H
ATOM     17  HD2 ARG A   2       2.189  23.783  23.396  1.00  0.00           H
ATOM     18  HD3 ARG A   2       3.224  24.355  24.460  1.00  0.00           H
ATOM     19  HE  ARG A   2       4.380  24.432  22.124  1.00  0.00           H
ATOM     20 HH11 ARG A   2       1.905  26.082  23.579  1.00  0.00           H
ATOM     21 HH12 ARG A   2       2.041  27.322  22.767  1.00  0.00           H
ATOM     22 HH21 ARG A   2       4.569  26.329  20.898  1.00  0.00           H
ATOM     23 HH22 ARG A   2       3.649  27.473  21.149  1.00  0.00           H
ATOM     24  N   HIS A   3       6.067  20.098  24.123  1.00  0.00           N
ATOM     25  CA  HIS A   3       7.516  20.107  24.260  1.00  0.00           C
ATOM     26  C   HIS A   3       8.133  20.732  23.018  1.00  0.00           C
ATOM     27  O   HIS A   3       7.638  20.536  21.904  1.00  0.00           O
ATOM     28  CB  HIS A   3       8.069  18.691  24.464  1.00  0.00           C
ATOM     29  CG  HIS A   3       7.630  18.050  25.743  1.00  0.00           C
ATOM     30  ND1 HIS A   3       8.154  18.399  26.969  1.00  0.00           N
ATOM     31  CD2 HIS A   3       6.716  17.080  25.988  1.00  0.00           C
ATOM     32  CE1 HIS A   3       7.582  17.674  27.913  1.00  0.00           C
ATOM     33  NE2 HIS A   3       6.706  16.865  27.344  1.00  0.00           N
ATOM     34  H   HIS A   3       5.797  19.948  23.320  1.00  0.00           H
ATOM     35  HA  HIS A   3       7.764  20.646  25.027  1.00  0.00           H
ATOM     36  HB2 HIS A   3       7.768  18.129  23.732  1.00  0.00           H
ATOM     37  HB3 HIS A   3       9.038  18.731  24.470  1.00  0.00           H
ATOM     38  HD2 HIS A   3       6.194  16.642  25.355  1.00  0.00           H
ATOM     39  HE1 HIS A   3       7.765  17.723  28.824  1.00  0.00           H
ATOM     40  N   LYS A   4       9.213  21.483  23.217  1.00  0.00           N
ATOM     41  CA  LYS A   4       9.902  22.139  22.116  1.00  0.00           C
ATOM     42  C   LYS A   4      11.340  22.409  22.530  1.00  0.00           C
ATOM     43  O   LYS A   4      11.602  22.774  23.678  1.00  0.00           O
ATOM     44  CB  LYS A   4       9.205  23.447  21.722  1.00  0.00           C
ATOM     45  CG  LYS A   4       9.799  24.121  20.495  1.00  0.00           C
ATOM     46  CD  LYS A   4       9.008  25.357  20.102  1.00  0.00           C
ATOM     47  CE  LYS A   4       9.606  26.035  18.880  1.00  0.00           C
ATOM     48  NZ  LYS A   4       8.842  27.250  18.484  1.00  0.00           N1+
ATOM     49  H   LYS A   4       9.568  21.628  23.987  1.00  0.00           H
ATOM     50  HA  LYS A   4       9.909  21.551  21.344  1.00  0.00           H
ATOM     51  HB2 LYS A   4       8.272  23.258  21.533  1.00  0.00           H
ATOM     52  HB3 LYS A   4       9.270  24.070  22.462  1.00  0.00           H
ATOM     53  HG2 LYS A   4      10.710  24.392  20.688  1.00  0.00           H
ATOM     54  HG3 LYS A   4       9.784  23.500  19.750  1.00  0.00           H
ATOM     55  HD2 LYS A   4       8.096  25.101  19.892  1.00  0.00           H
ATOM     56  HD3 LYS A   4       9.018  25.991  20.837  1.00  0.00           H
ATOM     57  HE2 LYS A   4      10.517  26.302  19.078  1.00  0.00           H
ATOM     58  HE3 LYS A   4       9.594  25.415  18.135  1.00  0.00           H
ATOM     59  HZ1 LYS A   4       9.215  27.624  17.768  1.00  0.00           H
ATOM     60  HZ2 LYS A   4       8.001  27.031  18.292  1.00  0.00           H
ATOM     61  HZ3 LYS A   4       8.842  27.840  19.151  1.00  0.00           H
ATOM     62  N   ASP A   5      12.263  22.226  21.588  1.00  0.00           N
ATOM     63  CA  ASP A   5      13.678  22.447  21.845  1.00  0.00           C
ATOM     64  C   ASP A   5      14.374  22.763  20.531  1.00  0.00           C
ATOM     65  O   ASP A   5      14.035  22.197  19.489  1.00  0.00           O
ATOM     66  CB  ASP A   5      14.324  21.224  22.508  1.00  0.00           C
ATOM     67  CG  ASP A   5      15.729  21.504  23.005  1.00  0.00           C
ATOM     68  OD1 ASP A   5      16.213  22.640  22.819  1.00  0.00           O
ATOM     69  OD2 ASP A   5      16.350  20.587  23.582  1.00  0.00           O1-
ATOM     70  H   ASP A   5      12.091  21.972  20.785  1.00  0.00           H
ATOM     71  HA  ASP A   5      13.783  23.208  22.438  1.00  0.00           H
ATOM     72  HB2 ASP A   5      13.785  20.954  23.267  1.00  0.00           H
ATOM     73  HB3 ASP A   5      14.372  20.503  21.861  1.00  0.00           H
ATOM     74  N   GLU A   6      15.346  23.668  20.589  1.00  0.00           N
ATOM     75  CA  GLU A   6      16.096  24.064  19.403  1.00  0.00           C
ATOM     76  C   GLU A   6      17.433  24.684  19.794  1.00  0.00           C
ATOM     77  O   GLU A   6      17.829  24.647  20.959  1.00  0.00           O
ATOM     78  CB  GLU A   6      15.283  25.051  18.561  1.00  0.00           C
ATOM     79  CG  GLU A   6      15.942  25.433  17.245  1.00  0.00           C
ATOM     80  CD  GLU A   6      15.076  26.352  16.405  1.00  0.00           C
ATOM     81  OE1 GLU A   6      13.969  26.708  16.861  1.00  0.00           O
ATOM     82  OE2 GLU A   6      15.503  26.718  15.290  1.00  0.00           O1-
ATOM     83  H   GLU A   6      15.592  24.070  21.309  1.00  0.00           H
ATOM     84  HA  GLU A   6      16.273  23.279  18.862  1.00  0.00           H
ATOM     85  HB2 GLU A   6      14.424  24.651  18.356  1.00  0.00           H
ATOM     86  HB3 GLU A   6      15.153  25.864  19.073  1.00  0.00           H
ATOM     87  HG2 GLU A   6      16.776  25.893  17.428  1.00  0.00           H
ATOM     88  HG3 GLU A   6      16.112  24.628  16.730  1.00  0.00           H
TER
ATOM     89  N   SER B   2      10.846   4.462  24.534  1.00  0.00           N
ATOM     90  CA  SER B   2      11.518   5.747  24.391  1.00  0.00           C
ATOM     91  C   SER B   2      13.032   5.575  24.457  1.00  0.00           C
ATOM     92  O   SER B   2      13.532   4.595  25.009  1.00  0.00           O
ATOM     93  CB  SER B   2      11.052   6.719  25.477  1.00  0.00           C
ATOM     94  OG  SER B   2      11.455   6.279  26.762  1.00  0.00           O
ATOM     95  HA  SER B   2      11.295   6.129  23.528  1.00  0.00           H
ATOM     96  HB2 SER B   2      11.440   7.591  25.307  1.00  0.00           H
ATOM     97  HB3 SER B   2      10.084   6.777  25.453  1.00  0.00           H
ATOM     98  HG  SER B   2      11.125   5.523  26.924  1.00  0.00           H
ATOM     99  N   THR B   3      13.758   6.536  23.889  1.00  0.00           N
ATOM    100  CA  THR B   3      15.212   6.498  23.880  1.00  0.00           C
ATOM    101  C   THR B   3      15.741   7.920  23.778  1.00  0.00           C
ATOM    102  O   THR B   3      15.212   8.733  23.015  1.00  0.00           O
ATOM    103  CB  THR B   3      15.746   5.652  22.717  1.00  0.00           C
ATOM    104  OG1 THR B   3      15.230   4.319  22.813  1.00  0.00           O
ATOM    105  CG2 THR B   3      17.268   5.606  22.740  1.00  0.00           C
ATOM    106  H   THR B   3      13.425   7.226  23.499  1.00  0.00           H
ATOM    107  HA  THR B   3      15.530   6.111  24.711  1.00  0.00           H
ATOM    108  HB  THR B   3      15.465   6.046  21.876  1.00  0.00           H
ATOM    109  HG1 THR B   3      15.519   3.852  22.178  1.00  0.00           H
ATOM    110 HG21 THR B   3      17.587   4.933  22.118  1.00  0.00           H
ATOM    111 HG22 THR B   3      17.633   6.467  22.484  1.00  0.00           H
ATOM    112 HG23 THR B   3      17.580   5.381  23.631  1.00  0.00           H
ATOM    113  N   ASN B   4      16.785   8.212  24.552  1.00  0.00           N
ATOM    114  CA  ASN B   4      17.402   9.533  24.564  1.00  0.00           C
ATOM    115  C   ASN B   4      18.904   9.364  24.725  1.00  0.00           C
ATOM    116  O   ASN B   4      19.359   8.747  25.692  1.00  0.00           O
ATOM    117  CB  ASN B   4      16.835  10.400  25.693  1.00  0.00           C
ATOM    118  CG  ASN B   4      15.357  10.690  25.518  1.00  0.00           C
ATOM    119  OD1 ASN B   4      14.528  10.254  26.317  1.00  0.00           O
ATOM    120  ND2 ASN B   4      15.019  11.430  24.468  1.00  0.00           N
ATOM    121  H   ASN B   4      17.158   7.651  25.086  1.00  0.00           H
ATOM    122  HA  ASN B   4      17.232   9.979  23.719  1.00  0.00           H
ATOM    123  HB2 ASN B   4      16.953   9.937  26.537  1.00  0.00           H
ATOM    124  HB3 ASN B   4      17.307  11.247  25.709  1.00  0.00           H
ATOM    125 HD21 ASN B   4      14.193  11.622  24.326  1.00  0.00           H
ATOM    126 HD22 ASN B   4      15.626  11.717  23.931  1.00  0.00           H
ATOM    127  N   GLN B   5      19.666   9.908  23.781  1.00  0.00           N
ATOM    128  CA  GLN B   5      21.121   9.817  23.821  1.00  0.00           C
ATOM    129  C   GLN B   5      21.756  11.122  23.352  1.00  0.00           C
ATOM    130  O   GLN B   5      21.299  11.734  22.387  1.00  0.00           O
ATOM    131  CB  GLN B   5      21.610   8.654  22.957  1.00  0.00           C
ATOM    132  CG  GLN B   5      21.217   7.283  23.483  1.00  0.00           C
ATOM    133  CD  GLN B   5      21.709   6.155  22.598  1.00  0.00           C
ATOM    134  OE1 GLN B   5      22.296   6.391  21.542  1.00  0.00           O
ATOM    135  NE2 GLN B   5      21.472   4.920  23.025  1.00  0.00           N
ATOM    136  H   GLN B   5      19.362  10.339  23.102  1.00  0.00           H
ATOM    137  HA  GLN B   5      21.406   9.656  24.734  1.00  0.00           H
ATOM    138  HB2 GLN B   5      21.235   8.747  22.067  1.00  0.00           H
ATOM    139  HB3 GLN B   5      22.578   8.686  22.909  1.00  0.00           H
ATOM    140  HG2 GLN B   5      21.600   7.161  24.366  1.00  0.00           H
ATOM    141  HG3 GLN B   5      20.250   7.227  23.530  1.00  0.00           H
ATOM    142 HE21 GLN B   5      21.732   4.246  22.559  1.00  0.00           H
ATOM    143 HE22 GLN B   5      21.059   4.795  23.769  1.00  0.00           H
TER
ATOM    144  N   CYS C   2      14.789  22.141   7.021  1.00  0.00           N
ATOM    145  CA  CYS C   2      15.170  23.547   7.063  1.00  0.00           C
ATOM    146  C   CYS C   2      16.660  23.696   7.350  1.00  0.00           C
ATOM    147  O   CYS C   2      17.074  23.780   8.506  1.00  0.00           O
ATOM    148  CB  CYS C   2      14.354  24.292   8.122  1.00  0.00           C
ATOM    149  SG  CYS C   2      14.698  26.064   8.213  1.00  0.00           S
ATOM    150  HA  CYS C   2      14.987  23.952   6.201  1.00  0.00           H
ATOM    151  HB2 CYS C   2      13.411  24.185   7.920  1.00  0.00           H
ATOM    152  HB3 CYS C   2      14.548  23.908   8.991  1.00  0.00           H
ATOM    153  HG  CYS C   2      14.012  26.553   9.067  1.00  0.00           H
ATOM    154  N   GLY C   3      17.463  23.727   6.287  1.00  0.00           N
ATOM    155  CA  GLY C   3      18.892  23.864   6.428  1.00  0.00           C
ATOM    156  C   GLY C   3      19.301  25.288   6.737  1.00  0.00           C
ATOM    157  O   GLY C   3      18.476  26.206   6.840  1.00  0.00           O
ATOM    158  H   GLY C   3      17.194  23.670   5.472  1.00  0.00           H
ATOM    159  HA2 GLY C   3      19.202  23.291   7.146  1.00  0.00           H
ATOM    160  HA3 GLY C   3      19.325  23.590   5.604  1.00  0.00           H
ATOM    161  N   PRO C   4      20.618  25.490   6.891  1.00  0.00           N
ATOM    162  CA  PRO C   4      21.173  26.813   7.198  1.00  0.00           C
ATOM    163  C   PRO C   4      21.113  27.768   6.010  1.00  0.00           C
ATOM    164  O   PRO C   4      21.345  27.333   4.882  1.00  0.00           O
ATOM    165  CB  PRO C   4      22.622  26.503   7.578  1.00  0.00           C
ATOM    166  CG  PRO C   4      22.943  25.252   6.843  1.00  0.00           C
ATOM    167  CD  PRO C   4      21.667  24.460   6.790  1.00  0.00           C
ATOM    168  HA  PRO C   4      20.715  27.207   7.957  1.00  0.00           H
ATOM    169  HB2 PRO C   4      23.199  27.228   7.291  1.00  0.00           H
ATOM    170  HB3 PRO C   4      22.689  26.366   8.536  1.00  0.00           H
ATOM    171  HG2 PRO C   4      23.244  25.471   5.947  1.00  0.00           H
ATOM    172  HG3 PRO C   4      23.628  24.761   7.322  1.00  0.00           H
ATOM    173  HD2 PRO C   4      21.599  23.988   5.945  1.00  0.00           H
ATOM    174  HD3 PRO C   4      21.617  23.851   7.543  1.00  0.00           H
TER
ATOM    175  N   ALA D   2       2.619   6.211   7.571  1.00  0.00           N
ATOM    176  CA  ALA D   2       3.623   7.047   8.219  1.00  0.00           C
ATOM    177  C   ALA D   2       4.961   6.321   8.294  1.00  0.00           C
ATOM    178  O   ALA D   2       5.056   5.233   8.863  1.00  0.00           O
ATOM    179  CB  ALA D   2       3.159   7.450   9.610  1.00  0.00           C
ATOM    180  HA  ALA D   2       3.748   7.855   7.697  1.00  0.00           H
ATOM    181  HB1 ALA D   2       3.840   8.005  10.021  1.00  0.00           H
ATOM    182  HB2 ALA D   2       2.329   7.947   9.534  1.00  0.00           H
ATOM    183  HB3 ALA D   2       3.018   6.650  10.139  1.00  0.00           H
ATOM    184  N   LEU D   3       6.002   6.934   7.712  1.00  0.00           N
ATOM    185  CA  LEU D   3       7.348   6.371   7.695  1.00  0.00           C
ATOM    186  C   LEU D   3       8.344   7.510   7.935  1.00  0.00           C
ATOM    187  O   LEU D   3       9.150   7.868   7.078  1.00  0.00           O
ATOM    188  CB  LEU D   3       7.634   5.644   6.379  1.00  0.00           C
ATOM    189  CG  LEU D   3       6.792   4.396   6.105  1.00  0.00           C
ATOM    190  CD1 LEU D   3       7.036   3.888   4.692  1.00  0.00           C
ATOM    191  CD2 LEU D   3       7.088   3.307   7.125  1.00  0.00           C
ATOM    192  H   LEU D   3       5.945   7.694   7.313  1.00  0.00           H
ATOM    193  HA  LEU D   3       7.438   5.734   8.421  1.00  0.00           H
ATOM    194  HB2 LEU D   3       7.479   6.264   5.649  1.00  0.00           H
ATOM    195  HB3 LEU D   3       8.565   5.371   6.377  1.00  0.00           H
ATOM    196  HG  LEU D   3       5.853   4.628   6.180  1.00  0.00           H
ATOM    197 HD11 LEU D   3       6.493   3.099   4.543  1.00  0.00           H
ATOM    198 HD12 LEU D   3       6.791   4.583   4.061  1.00  0.00           H
ATOM    199 HD13 LEU D   3       7.975   3.668   4.594  1.00  0.00           H
ATOM    200 HD21 LEU D   3       6.619   2.498   6.867  1.00  0.00           H
ATOM    201 HD22 LEU D   3       8.044   3.144   7.143  1.00  0.00           H
ATOM    202 HD23 LEU D   3       6.785   3.600   7.998  1.00  0.00           H
ATOM    203  N   ILE D   4       8.286   8.091   9.130  1.00  0.00           N
ATOM    204  CA  ILE D   4       9.174   9.189   9.499  1.00  0.00           C
ATOM    205  C   ILE D   4      10.531   8.595   9.863  1.00  0.00           C
ATOM    206  O   ILE D   4      10.691   7.990  10.926  1.00  0.00           O
ATOM    207  CB  ILE D   4       8.599  10.013  10.657  1.00  0.00           C
ATOM    208  CG1 ILE D   4       7.284  10.674  10.236  1.00  0.00           C
ATOM    209  CG2 ILE D   4       9.604  11.067  11.108  1.00  0.00           C
ATOM    210  CD1 ILE D   4       6.474  11.224  11.392  1.00  0.00           C
ATOM    211  H   ILE D   4       7.736   7.865   9.751  1.00  0.00           H
ATOM    212  HA  ILE D   4       9.293   9.777   8.736  1.00  0.00           H
ATOM    213  HB  ILE D   4       8.421   9.417  11.401  1.00  0.00           H
ATOM    214 HG12 ILE D   4       7.482  11.410   9.637  1.00  0.00           H
ATOM    215 HG13 ILE D   4       6.734  10.018   9.778  1.00  0.00           H
ATOM    216 HG21 ILE D   4       9.158  11.702  11.690  1.00  0.00           H
ATOM    217 HG22 ILE D   4      10.326  10.633  11.590  1.00  0.00           H
ATOM    218 HG23 ILE D   4       9.953  11.525  10.328  1.00  0.00           H
ATOM    219 HD11 ILE D   4       5.603  11.498  11.065  1.00  0.00           H
ATOM    220 HD12 ILE D   4       6.373  10.531  12.063  1.00  0.00           H
ATOM    221 HD13 ILE D   4       6.939  11.986  11.771  1.00  0.00           H
ATOM    222  N   MET D   5      11.514   8.768   8.978  1.00  0.00           N
ATOM    223  CA  MET D   5      12.863   8.258   9.192  1.00  0.00           C
ATOM    224  C   MET D   5      13.872   9.277   8.657  1.00  0.00           C
ATOM    225  O   MET D   5      14.680   9.000   7.775  1.00  0.00           O
ATOM    226  CB  MET D   5      13.042   6.896   8.525  1.00  0.00           C
ATOM    227  CG  MET D   5      12.226   5.783   9.162  1.00  0.00           C
ATOM    228  SD  MET D   5      12.466   4.191   8.350  1.00  0.00           S
ATOM    229  CE  MET D   5      11.320   3.166   9.268  1.00  0.00           C
ATOM    230  H   MET D   5      11.418   9.186   8.232  1.00  0.00           H
ATOM    231  HA  MET D   5      13.009   8.144  10.144  1.00  0.00           H
ATOM    232  HB2 MET D   5      12.772   6.965   7.596  1.00  0.00           H
ATOM    233  HB3 MET D   5      13.977   6.644   8.577  1.00  0.00           H
ATOM    234  HG2 MET D   5      12.490   5.689  10.091  1.00  0.00           H
ATOM    235  HG3 MET D   5      11.284   6.009   9.107  1.00  0.00           H
ATOM    236  HE1 MET D   5      11.356   2.262   8.918  1.00  0.00           H
ATOM    237  HE2 MET D   5      11.574   3.169  10.204  1.00  0.00           H
ATOM    238  HE3 MET D   5      10.425   3.525   9.167  1.00  0.00           H
ATOM    239  N   PHE D   6      13.825  10.488   9.205  1.00  0.00           N
ATOM    240  CA  PHE D   6      14.731  11.547   8.787  1.00  0.00           C
ATOM    241  C   PHE D   6      16.111  11.331   9.393  1.00  0.00           C
ATOM    242  O   PHE D   6      16.244  10.831  10.514  1.00  0.00           O
ATOM    243  CB  PHE D   6      14.186  12.914   9.206  1.00  0.00           C
ATOM    244  CG  PHE D   6      12.873  13.276   8.562  1.00  0.00           C
ATOM    245  CD1 PHE D   6      12.416  12.605   7.437  1.00  0.00           C
ATOM    246  CD2 PHE D   6      12.093  14.294   9.087  1.00  0.00           C
ATOM    247  CE1 PHE D   6      11.210  12.943   6.852  1.00  0.00           C
ATOM    248  CE2 PHE D   6      10.887  14.635   8.506  1.00  0.00           C
ATOM    249  CZ  PHE D   6      10.445  13.959   7.388  1.00  0.00           C
ATOM    250  H   PHE D   6      13.274  10.720   9.823  1.00  0.00           H
ATOM    251  HA  PHE D   6      14.827  11.530   7.822  1.00  0.00           H
ATOM    252  HB2 PHE D   6      14.055  12.916  10.167  1.00  0.00           H
ATOM    253  HB3 PHE D   6      14.833  13.595   8.962  1.00  0.00           H
ATOM    254  HD1 PHE D   6      12.924  11.919   7.069  1.00  0.00           H
ATOM    255  HD2 PHE D   6      12.386  14.753   9.841  1.00  0.00           H
ATOM    256  HE1 PHE D   6      10.914  12.486   6.099  1.00  0.00           H
ATOM    257  HE2 PHE D   6      10.373  15.320   8.869  1.00  0.00           H
ATOM    258  HZ  PHE D   6       9.634  14.188   6.995  1.00  0.00           H
ATOM    259  N   TRP D   7      17.142  11.711   8.641  1.00  0.00           N
ATOM    260  CA  TRP D   7      18.523  11.570   9.084  1.00  0.00           C
ATOM    261  C   TRP D   7      19.334  12.742   8.558  1.00  0.00           C
ATOM    262  O   TRP D   7      19.223  13.098   7.381  1.00  0.00           O
ATOM    263  CB  TRP D   7      19.129  10.247   8.600  1.00  0.00           C
ATOM    264  CG  TRP D   7      18.518   9.038   9.242  1.00  0.00           C
ATOM    265  CD1 TRP D   7      17.534   8.246   8.727  1.00  0.00           C
ATOM    266  CD2 TRP D   7      18.852   8.483  10.520  1.00  0.00           C
ATOM    267  NE1 TRP D   7      17.234   7.232   9.605  1.00  0.00           N
ATOM    268  CE2 TRP D   7      18.030   7.356  10.713  1.00  0.00           C
ATOM    269  CE3 TRP D   7      19.767   8.831  11.519  1.00  0.00           C
ATOM    270  CZ2 TRP D   7      18.095   6.573  11.864  1.00  0.00           C
ATOM    271  CZ3 TRP D   7      19.829   8.053  12.661  1.00  0.00           C
ATOM    272  CH2 TRP D   7      18.998   6.937  12.824  1.00  0.00           C
ATOM    273  H   TRP D   7      17.064  12.059   7.859  1.00  0.00           H
ATOM    274  HA  TRP D   7      18.555  11.585  10.053  1.00  0.00           H
ATOM    275  HB2 TRP D   7      18.996  10.173   7.642  1.00  0.00           H
ATOM    276  HB3 TRP D   7      20.077  10.244   8.803  1.00  0.00           H
ATOM    277  HD1 TRP D   7      17.125   8.373   7.901  1.00  0.00           H
ATOM    278  HE1 TRP D   7      16.644   6.620   9.479  1.00  0.00           H
ATOM    279  HE3 TRP D   7      20.322   9.570  11.418  1.00  0.00           H
ATOM    280  HZ2 TRP D   7      17.544   5.832  11.976  1.00  0.00           H
ATOM    281  HZ3 TRP D   7      20.434   8.274  13.332  1.00  0.00           H
ATOM    282  HH2 TRP D   7      19.063   6.433  13.603  1.00  0.00           H
ATOM    283  N   TYR D   8      20.146  13.338   9.431  1.00  0.00           N
ATOM    284  CA  TYR D   8      20.988  14.478   9.066  1.00  0.00           C
ATOM    285  C   TYR D   8      22.308  14.337   9.818  1.00  0.00           C
ATOM    286  O   TYR D   8      22.402  14.703  10.993  1.00  0.00           O
ATOM    287  CB  TYR D   8      20.302  15.800   9.392  1.00  0.00           C
ATOM    288  CG  TYR D   8      19.076  16.075   8.551  1.00  0.00           C
ATOM    289  CD1 TYR D   8      19.192  16.579   7.263  1.00  0.00           C
ATOM    290  CD2 TYR D   8      17.801  15.832   9.046  1.00  0.00           C
ATOM    291  CE1 TYR D   8      18.075  16.832   6.490  1.00  0.00           C
ATOM    292  CE2 TYR D   8      16.678  16.082   8.282  1.00  0.00           C
ATOM    293  CZ  TYR D   8      16.820  16.582   7.005  1.00  0.00           C
ATOM    294  OH  TYR D   8      15.704  16.833   6.240  1.00  0.00           O
ATOM    295  H   TYR D   8      20.228  13.097  10.252  1.00  0.00           H
ATOM    296  HA  TYR D   8      21.173  14.454   8.115  1.00  0.00           H
ATOM    297  HB2 TYR D   8      20.027  15.788  10.322  1.00  0.00           H
ATOM    298  HB3 TYR D   8      20.931  16.523   9.244  1.00  0.00           H
ATOM    299  HD1 TYR D   8      20.037  16.749   6.913  1.00  0.00           H
ATOM    300  HD2 TYR D   8      17.703  15.494   9.907  1.00  0.00           H
ATOM    301  HE1 TYR D   8      18.168  17.170   5.629  1.00  0.00           H
ATOM    302  HE2 TYR D   8      15.831  15.914   8.626  1.00  0.00           H
ATOM    303  HH  TYR D   8      15.010  16.638   6.671  1.00  0.00           H
ATOM    304  N   VAL D   9      23.320  13.807   9.139  1.00  0.00           N
ATOM    305  CA  VAL D   9      24.632  13.618   9.743  1.00  0.00           C
ATOM    306  C   VAL D   9      25.377  14.947   9.786  1.00  0.00           C
ATOM    307  O   VAL D   9      25.756  15.491   8.749  1.00  0.00           O
ATOM    308  CB  VAL D   9      25.449  12.559   8.980  1.00  0.00           C
ATOM    309  CG1 VAL D   9      26.843  12.427   9.578  1.00  0.00           C
ATOM    310  CG2 VAL D   9      24.726  11.220   8.995  1.00  0.00           C
ATOM    311  H   VAL D   9      23.271  13.548   8.320  1.00  0.00           H
ATOM    312  HA  VAL D   9      24.518  13.309  10.655  1.00  0.00           H
ATOM    313  HB  VAL D   9      25.544  12.838   8.056  1.00  0.00           H
ATOM    314 HG11 VAL D   9      27.251  11.612   9.245  1.00  0.00           H
ATOM    315 HG12 VAL D   9      27.376  13.193   9.316  1.00  0.00           H
ATOM    316 HG13 VAL D   9      26.769  12.386  10.544  1.00  0.00           H
ATOM    317 HG21 VAL D   9      25.275  10.560   8.542  1.00  0.00           H
ATOM    318 HG22 VAL D   9      24.578  10.952   9.915  1.00  0.00           H
ATOM    319 HG23 VAL D   9      23.876  11.314   8.536  1.00  0.00           H
TER
END
"""

def run():
  #for idealize in [True,False]:
  exercise(pdb_str=pdb_str, eps=1.e-4)

if (__name__ == "__main__"):
  t0 = time.time()
  run()
  print("OK. Time:", round(time.time()-t0, 2), "seconds")


 *******************************************************************************


 *******************************************************************************
mmtbx/hydrogens/tst_riding_fd_4.py
from __future__ import absolute_import, division, print_function
import time
import iotbx.pdb
import mmtbx.model
from cctbx.array_family import flex
from libtbx.utils import null_out
from libtbx.test_utils import approx_equal
from six.moves import zip
from six.moves import range

#-----------------------------------------------------------------------------
# This finite difference test checks transformation of riding H gradients
# for nucleic acids
#-----------------------------------------------------------------------------

def exercise(pdb_str, eps, idealize):
  pdb_inp = iotbx.pdb.input(lines=pdb_str.split("\n"), source_info=None)

  model = mmtbx.model.manager(
            model_input = pdb_inp,
            log         = null_out())
  model.process(make_restraints=True)
  geometry_restraints = model.restraints_manager.geometry
  xray_structure = model.get_xray_structure()

  model.setup_riding_h_manager()
  riding_h_manager = model.get_riding_h_manager()

  riding_h_manager.idealize_riding_h_positions(xray_structure=xray_structure)
  sites_cart = xray_structure.sites_cart()

  g_analytical = geometry_restraints.energies_sites(
    sites_cart = sites_cart, compute_gradients = True).gradients
  hd_selection = xray_structure.hd_selection()

  g_analytical_reduced = riding_h_manager.gradients_reduced_cpp(
    gradients    = g_analytical,
    sites_cart   = sites_cart,
    hd_selection = hd_selection)
  #
  ex = [eps,0,0]
  ey = [0,eps,0]
  ez = [0,0,eps]
  g_fd = flex.vec3_double()
  for i_site in range(sites_cart.size()):
    g_fd_i = []
    for e in [ex,ey,ez]:
      ts = []
      for sign in [-1,1]:
        sites_cart_ = sites_cart.deep_copy()
        xray_structure_ = xray_structure.deep_copy_scatterers()
        sites_cart_[i_site] = [
          sites_cart_[i_site][j]+e[j]*sign for j in range(3)]
        xray_structure_.set_sites_cart(sites_cart_)
        # after shift, recalculate H position
        riding_h_manager.idealize_riding_h_positions(
          xray_structure=xray_structure_)
        sites_cart_ = xray_structure_.sites_cart()
        ts.append(geometry_restraints.energies_sites(
          sites_cart = sites_cart_,
          compute_gradients = False).target)
      g_fd_i.append((ts[1]-ts[0])/(2*eps))
    g_fd.append(g_fd_i)

  g_fd_reduced = g_fd.select(~hd_selection)

  for g1, g2 in zip(g_analytical_reduced, g_fd_reduced):
    assert approx_equal(g1,g2, 1.e-4)


# DNA and RNA nucleic acids
pdb_str = """
CRYST1   30.000   30.000   30.000  90.00  90.00  90.00 P 1
SCALE1      0.033333  0.000000  0.000000        0.00000
SCALE2      0.000000  0.033333  0.000000        0.00000
SCALE3      0.000000  0.000000  0.033333        0.00000
ATOM      1  P    DA A   1       4.321   6.421   9.951  1.00 76.88           P
ATOM      2  OP1  DA A   1       3.975   5.004  10.200  1.00 78.59           O
ATOM      3  OP2  DA A   1       3.621   7.495  10.691  1.00 75.20           O
ATOM      4  O5'  DA A   1       5.895   6.618  10.165  1.00 78.76           O
ATOM      5  C5'  DA A   1       6.704   5.513  10.551  1.00 77.93           C
ATOM      6  C4'  DA A   1       8.179   5.858  10.453  1.00 78.66           C
ATOM      7  O4'  DA A   1       8.521   6.124   9.066  1.00 79.49           O
ATOM      8  C3'  DA A   1       8.598   7.103  11.220  1.00 78.23           C
ATOM      9  O3'  DA A   1       8.961   6.778  12.559  1.00 77.17           O
ATOM     10  C2'  DA A   1       9.776   7.622  10.408  1.00 79.34           C
ATOM     11  C1'  DA A   1       9.411   7.226   8.980  1.00 78.22           C
ATOM     12  N9   DA A   1       8.758   8.292   8.225  1.00 20.00           N
ATOM     13  C8   DA A   1       7.414   8.503   8.091  1.00 20.00           C
ATOM     14  N7   DA A   1       7.112   9.543   7.350  1.00 20.00           N
ATOM     15  C5   DA A   1       8.344  10.050   6.971  1.00 20.00           C
ATOM     16  C6   DA A   1       8.713  11.153   6.176  1.00 20.00           C
ATOM     17  N6   DA A   1       7.829  11.974   5.600  1.00 20.00           N
ATOM     18  N1   DA A   1      10.031  11.381   5.996  1.00 20.00           N
ATOM     19  C2   DA A   1      10.913  10.557   6.575  1.00 20.00           C
ATOM     20  N3   DA A   1      10.687   9.491   7.341  1.00 20.00           N
ATOM     21  C4   DA A   1       9.369   9.291   7.502  1.00 20.00           C
ATOM     22  H5'  DA A   1       6.514   4.760   9.969  1.00 77.93           H
ATOM     23 H5''  DA A   1       6.494   5.269  11.466  1.00 77.93           H
ATOM     24  H4'  DA A   1       8.701   5.104  10.767  1.00 78.66           H
ATOM     25  H3'  DA A   1       7.879   7.754  11.217  1.00 78.23           H
ATOM     26  H2'  DA A   1       9.849   8.586  10.488  1.00 79.34           H
ATOM     27 H2''  DA A   1      10.599   7.190  10.683  1.00 79.34           H
ATOM     28  H1'  DA A   1      10.214   6.951   8.511  1.00 78.22           H
ATOM     29  H8   DA A   1       6.772   7.960   8.488  1.00 20.00           H
ATOM     30  H61  DA A   1       8.103  12.635   5.123  1.00 20.00           H
ATOM     31  H62  DA A   1       6.986  11.841   5.706  1.00 20.00           H
ATOM     32  H2   DA A   1      11.808  10.757   6.421  1.00 20.00           H
ATOM     33  P    DC A   2       8.575   7.768  13.765  1.00 76.88           P
ATOM     34  OP1  DC A   2       8.992   7.120  15.028  1.00 78.59           O
ATOM     35  OP2  DC A   2       7.165   8.176  13.578  1.00 75.20           O
ATOM     36  O5'  DC A   2       9.494   9.054  13.516  1.00 78.76           O
ATOM     37  C5'  DC A   2      10.911   8.922  13.497  1.00 77.93           C
ATOM     38  C4'  DC A   2      11.571  10.212  13.045  1.00 78.66           C
ATOM     39  O4'  DC A   2      11.202  10.488  11.669  1.00 79.49           O
ATOM     40  C3'  DC A   2      11.163  11.450  13.828  1.00 78.23           C
ATOM     41  O3'  DC A   2      11.993  11.627  14.972  1.00 77.17           O
ATOM     42  C2'  DC A   2      11.332  12.566  12.806  1.00 79.34           C
ATOM     43  C1'  DC A   2      10.997  11.881  11.483  1.00 78.22           C
ATOM     44  N1   DC A   2       9.591  12.099  11.036  1.00 20.00           N
ATOM     45  C2   DC A   2       9.254  13.276  10.359  1.00 20.00           C
ATOM     46  O2   DC A   2      10.133  14.120  10.143  1.00 20.00           O
ATOM     47  N3   DC A   2       7.972  13.459   9.959  1.00 20.00           N
ATOM     48  C4   DC A   2       7.054  12.524  10.212  1.00 20.00           C
ATOM     49  N4   DC A   2       5.802  12.749   9.798  1.00 20.00           N
ATOM     50  C5   DC A   2       7.378  11.318  10.900  1.00 20.00           C
ATOM     51  C6   DC A   2       8.646  11.149  11.290  1.00 20.00           C
ATOM     52  H5'  DC A   2      11.156   8.208  12.888  1.00 77.93           H
ATOM     53 H5''  DC A   2      11.222   8.701  14.389  1.00 77.93           H
ATOM     54  H4'  DC A   2      12.534  10.109  13.099  1.00 78.66           H
ATOM     55  H3'  DC A   2      10.233  11.382  14.095  1.00 78.23           H
ATOM     56  H2'  DC A   2      10.711  13.290  12.984  1.00 79.34           H
ATOM     57 H2''  DC A   2      12.247  12.890  12.802  1.00 79.34           H
ATOM     58  H1'  DC A   2      11.602  12.202  10.797  1.00 78.22           H
ATOM     59  H41  DC A   2       5.188  12.166   9.949  1.00 20.00           H
ATOM     60  H42  DC A   2       5.612  13.476   9.380  1.00 20.00           H
ATOM     61  H5   DC A   2       6.731  10.673  11.071  1.00 20.00           H
ATOM     62  H6   DC A   2       8.886  10.372  11.740  1.00 20.00           H
ATOM     63  P    DG A   3      11.380  12.226  16.332  1.00 76.88           P
ATOM     64  OP1  DG A   3      12.439  12.169  17.364  1.00 78.59           O
ATOM     65  OP2  DG A   3      10.081  11.560  16.572  1.00 75.20           O
ATOM     66  O5'  DG A   3      11.087  13.759  15.979  1.00 78.76           O
ATOM     67  C5'  DG A   3      12.153  14.613  15.582  1.00 77.93           C
ATOM     68  C4'  DG A   3      11.625  15.948  15.088  1.00 78.66           C
ATOM     69  O4'  DG A   3      10.821  15.738  13.897  1.00 79.49           O
ATOM     70  C3'  DG A   3      10.718  16.679  16.065  1.00 78.23           C
ATOM     71  O3'  DG A   3      11.476  17.512  16.939  1.00 77.17           O
ATOM     72  C2'  DG A   3       9.805  17.477  15.146  1.00 79.34           C
ATOM     73  C1'  DG A   3       9.678  16.578  13.920  1.00 78.22           C
ATOM     74  N9   DG A   3       8.483  15.738  13.931  1.00 20.00           N
ATOM     75  C8   DG A   3       8.377  14.458  14.419  1.00 20.00           C
ATOM     76  N7   DG A   3       7.181  13.952  14.294  1.00 20.00           N
ATOM     77  C5   DG A   3       6.447  14.961  13.684  1.00 20.00           C
ATOM     78  C6   DG A   3       5.086  14.991  13.297  1.00 20.00           C
ATOM     79  O6   DG A   3       4.233  14.102  13.422  1.00 20.00           O
ATOM     80  N1   DG A   3       4.744  16.208  12.711  1.00 20.00           N
ATOM     81  C2   DG A   3       5.609  17.261  12.523  1.00 20.00           C
ATOM     82  N2   DG A   3       5.096  18.354  11.940  1.00 20.00           N
ATOM     83  N3   DG A   3       6.886  17.245  12.881  1.00 20.00           N
ATOM     84  C4   DG A   3       7.234  16.067  13.454  1.00 20.00           C
ATOM     85  H5'  DG A   3      12.655  14.186  14.870  1.00 77.93           H
ATOM     86 H5''  DG A   3      12.740  14.763  16.340  1.00 77.93           H
ATOM     87  H4'  DG A   3      12.376  16.521  14.865  1.00 78.66           H
ATOM     88  H3'  DG A   3      10.199  16.041  16.579  1.00 78.23           H
ATOM     89  H2'  DG A   3       8.938  17.616  15.561  1.00 79.34           H
ATOM     90 H2''  DG A   3      10.213  18.325  14.909  1.00 79.34           H
ATOM     91  H1'  DG A   3       9.672  17.129  13.121  1.00 78.22           H
ATOM     92  H8   DG A   3       9.088  13.997  14.801  1.00 20.00           H
ATOM     93  H1   DG A   3       3.932  16.308  12.447  1.00 20.00           H
ATOM     94  H21  DG A   3       5.594  19.042  11.803  1.00 20.00           H
ATOM     95  H22  DG A   3       4.269  18.367  11.703  1.00 20.00           H
ATOM     96  P    DT A   4      11.038  17.682  18.476  1.00 76.88           P
ATOM     97  OP1  DT A   4      12.063  18.517  19.142  1.00 78.59           O
ATOM     98  OP2  DT A   4      10.727  16.337  19.007  1.00 75.20           O
ATOM     99  O5'  DT A   4       9.670  18.508  18.398  1.00 78.76           O
ATOM    100  C5'  DT A   4       9.648  19.790  17.782  1.00 77.93           C
ATOM    101  C4'  DT A   4       8.226  20.307  17.653  1.00 78.66           C
ATOM    102  O4'  DT A   4       7.471  19.434  16.774  1.00 79.49           O
ATOM    103  C3'  DT A   4       7.437  20.345  18.951  1.00 78.23           C
ATOM    104  O3'  DT A   4       7.650  21.574  19.642  1.00 77.17           O
ATOM    105  C2'  DT A   4       5.998  20.186  18.477  1.00 79.34           C
ATOM    106  C1'  DT A   4       6.134  19.307  17.235  1.00 78.22           C
ATOM    107  N1   DT A   4       5.854  17.865  17.489  1.00 20.00           N
ATOM    108  C2   DT A   4       4.559  17.407  17.408  1.00 20.00           C
ATOM    109  O2   DT A   4       3.613  18.124  17.136  1.00 20.00           O
ATOM    110  N3   DT A   4       4.408  16.069  17.658  1.00 20.00           N
ATOM    111  C4   DT A   4       5.402  15.162  17.975  1.00 20.00           C
ATOM    112  O4   DT A   4       5.166  13.976  18.183  1.00 20.00           O
ATOM    113  C5   DT A   4       6.738  15.708  18.044  1.00 20.00           C
ATOM    114  C7   DT A   4       7.899  14.820  18.380  1.00 20.00           C
ATOM    115  C6   DT A   4       6.898  17.018  17.800  1.00 20.00           C
ATOM    116  H5'  DT A   4      10.044  19.726  16.899  1.00 77.93           H
ATOM    117 H5''  DT A   4      10.164  20.411  18.319  1.00 77.93           H
ATOM    118  H4'  DT A   4       8.247  21.198  17.270  1.00 78.66           H
ATOM    119  H3'  DT A   4       7.687  19.597  19.515  1.00 78.23           H
ATOM    120 HO3'  DT A   4       7.975  21.569  20.416  1.00 77.17           H
ATOM    121  H2'  DT A   4       5.463  19.742  19.153  1.00 79.34           H
ATOM    122 H2''  DT A   4       5.617  21.047  18.247  1.00 79.34           H
ATOM    123  H1'  DT A   4       5.530  19.632  16.549  1.00 78.22           H
ATOM    124  H3   DT A   4       3.607  15.760  17.614  1.00 20.00           H
ATOM    125  H71  DT A   4       8.506  14.781  17.623  1.00 20.00           H
ATOM    126  H72  DT A   4       8.367  15.177  19.151  1.00 20.00           H
ATOM    127  H73  DT A   4       7.577  13.927  18.582  1.00 20.00           H
ATOM    128  H6   DT A   4       7.756  17.372  17.844  1.00 20.00           H
TER
ATOM    129  P     A B   1      18.553   9.499  13.673  1.00 76.88           P
ATOM    130  OP1   A B   1      18.244   8.077  13.965  1.00 78.59           O
ATOM    131  OP2   A B   1      18.063  10.559  14.590  1.00 75.20           O
ATOM    132  O5'   A B   1      20.135   9.645  13.551  1.00 78.76           O
ATOM    133  C5'   A B   1      20.984   8.516  13.690  1.00 77.93           C
ATOM    134  C4'   A B   1      22.397   8.832  13.268  1.00 78.66           C
ATOM    135  O4'   A B   1      22.420   9.197  11.863  1.00 79.49           O
ATOM    136  C3'   A B   1      23.053  10.012  13.969  1.00 78.23           C
ATOM    137  O3'   A B   1      23.578   9.678  15.242  1.00 77.17           O
ATOM    138  C2'   A B   1      24.112  10.447  12.965  1.00 79.34           C
ATOM    139  O2'   A B   1      25.261   9.616  13.036  1.00 79.34           O
ATOM    140  C1'   A B   1      23.396  10.192  11.639  1.00 78.22           C
ATOM    141  N9    A B   1      22.725  11.403  11.128  1.00 20.00           N
ATOM    142  C8    A B   1      21.387  11.706  11.176  1.00 20.00           C
ATOM    143  N7    A B   1      21.088  12.863  10.637  1.00 20.00           N
ATOM    144  C5    A B   1      22.312  13.355  10.204  1.00 20.00           C
ATOM    145  C6    A B   1      22.676  14.544   9.548  1.00 20.00           C
ATOM    146  N6    A B   1      21.805  15.494   9.199  1.00 20.00           N
ATOM    147  N1    A B   1      23.983  14.727   9.259  1.00 20.00           N
ATOM    148  C2    A B   1      24.857  13.775   9.609  1.00 20.00           C
ATOM    149  N3    A B   1      24.636  12.617  10.227  1.00 20.00           N
ATOM    150  C4    A B   1      23.329  12.466  10.500  1.00 20.00           C
ATOM    151  H5'   A B   1      20.643   7.794  13.139  1.00 77.93           H
ATOM    152 H5''   A B   1      20.986   8.233  14.618  1.00 77.93           H
ATOM    153  H4'   A B   1      22.948   8.043  13.397  1.00 78.66           H
ATOM    154  H3'   A B   1      22.401  10.723  14.070  1.00 78.23           H
ATOM    155  H2'   A B   1      24.339  11.384  13.071  1.00 79.34           H
ATOM    156 HO2'   A B   1      25.651   9.749  13.767  1.00 79.34           H
ATOM    157  H1'   A B   1      24.035   9.875  10.982  1.00 78.22           H
ATOM    158  H8    A B   1      20.752  11.143  11.556  1.00 20.00           H
ATOM    159  H61   A B   1      22.081  16.203   8.797  1.00 20.00           H
ATOM    160  H62   A B   1      20.969  15.398   9.376  1.00 20.00           H
ATOM    161  H2    A B   1      25.744  13.946   9.388  1.00 20.00           H
ATOM    162  P     C B   2      23.325  10.645  16.500  1.00 76.88           P
ATOM    163  OP1   C B   2      23.900   9.992  17.704  1.00 78.59           O
ATOM    164  OP2   C B   2      21.895  11.044  16.495  1.00 75.20           O
ATOM    165  O5'   C B   2      24.199  11.937  16.177  1.00 78.76           O
ATOM    166  C5'   C B   2      25.609  11.848  16.041  1.00 77.93           C
ATOM    167  C4'   C B   2      26.197  13.135  15.518  1.00 78.66           C
ATOM    168  O4'   C B   2      25.672  13.412  14.193  1.00 79.49           O
ATOM    169  C3'   C B   2      25.871  14.389  16.315  1.00 78.23           C
ATOM    170  O3'   C B   2      26.696  14.550  17.457  1.00 77.17           O
ATOM    171  C2'   C B   2      26.036  15.493  15.280  1.00 79.34           C
ATOM    172  O2'   C B   2      27.405  15.824  15.094  1.00 79.34           O
ATOM    173  C1'   C B   2      25.517  14.805  14.017  1.00 78.22           C
ATOM    174  N1    C B   2      24.086  15.094  13.772  1.00 20.00           N
ATOM    175  C2    C B   2      23.736  16.306  13.170  1.00 20.00           C
ATOM    176  O2    C B   2      24.634  17.102  12.859  1.00 20.00           O
ATOM    177  N3    C B   2      22.430  16.578  12.942  1.00 20.00           N
ATOM    178  C4    C B   2      21.494  15.695  13.292  1.00 20.00           C
ATOM    179  N4    C B   2      20.218  16.005  13.048  1.00 20.00           N
ATOM    180  C5    C B   2      21.823  14.452  13.907  1.00 20.00           C
ATOM    181  C6    C B   2      23.119  14.195  14.126  1.00 20.00           C
ATOM    182  H5'   C B   2      25.824  11.130  15.426  1.00 77.93           H
ATOM    183 H5''   C B   2      25.999  11.651  16.907  1.00 77.93           H
ATOM    184  H4'   C B   2      27.161  13.040  15.462  1.00 78.66           H
ATOM    185  H3'   C B   2      24.943  14.354  16.595  1.00 78.23           H
ATOM    186  H2'   C B   2      25.505  16.273  15.503  1.00 79.34           H
ATOM    187 HO2'   C B   2      27.694  16.194  15.791  1.00 79.34           H
ATOM    188  H1'   C B   2      26.041  15.093  13.253  1.00 78.22           H
ATOM    189  H41   C B   2      19.593  15.456  13.265  1.00 20.00           H
ATOM    190  H42   C B   2      20.022  16.754  12.674  1.00 20.00           H
ATOM    191  H5    C B   2      21.163  13.843  14.147  1.00 20.00           H
ATOM    192  H6    C B   2      23.364  13.393  14.526  1.00 20.00           H
ATOM    193  P     G B   3      26.058  15.013  18.858  1.00 76.88           P
ATOM    194  OP1   G B   3      27.123  14.941  19.891  1.00 78.59           O
ATOM    195  OP2   G B   3      24.791  14.266  19.059  1.00 75.20           O
ATOM    196  O5'   G B   3      25.696  16.547  18.630  1.00 78.76           O
ATOM    197  C5'   G B   3      26.713  17.507  18.380  1.00 77.93           C
ATOM    198  C4'   G B   3      26.131  18.843  17.993  1.00 78.66           C
ATOM    199  O4'   G B   3      25.392  18.715  16.750  1.00 79.49           O
ATOM    200  C3'   G B   3      25.121  19.437  18.964  1.00 78.23           C
ATOM    201  O3'   G B   3      25.730  20.093  20.063  1.00 77.17           O
ATOM    202  C2'   G B   3      24.308  20.364  18.072  1.00 79.34           C
ATOM    203  O2'   G B   3      24.988  21.590  17.846  1.00 79.34           O
ATOM    204  C1'   G B   3      24.268  19.570  16.766  1.00 78.22           C
ATOM    205  N9    G B   3      23.049  18.747  16.654  1.00 20.00           N
ATOM    206  C8    G B   3      22.948  17.389  16.836  1.00 20.00           C
ATOM    207  N7    G B   3      21.735  16.938  16.671  1.00 20.00           N
ATOM    208  C5    G B   3      20.988  18.066  16.360  1.00 20.00           C
ATOM    209  C6    G B   3      19.605  18.202  16.074  1.00 20.00           C
ATOM    210  O6    G B   3      18.735  17.324  16.037  1.00 20.00           O
ATOM    211  N1    G B   3      19.265  19.526  15.812  1.00 20.00           N
ATOM    212  C2    G B   3      20.142  20.583  15.823  1.00 20.00           C
ATOM    213  N2    G B   3      19.620  21.786  15.544  1.00 20.00           N
ATOM    214  N3    G B   3      21.433  20.469  16.088  1.00 20.00           N
ATOM    215  C4    G B   3      21.785  19.192  16.345  1.00 20.00           C
ATOM    216  H5'   G B   3      27.279  17.188  17.659  1.00 77.93           H
ATOM    217 H5''   G B   3      27.250  17.615  19.180  1.00 77.93           H
ATOM    218  H4'   G B   3      26.854  19.476  17.865  1.00 78.66           H
ATOM    219  H3'   G B   3      24.546  18.729  19.295  1.00 78.23           H
ATOM    220  H2'   G B   3      23.416  20.507  18.427  1.00 79.34           H
ATOM    221 HO2'   G B   3      25.624  21.654  18.390  1.00 79.34           H
ATOM    222  H1'   G B   3      24.316  20.182  16.014  1.00 78.22           H
ATOM    223  H8    G B   3      23.671  16.847  17.056  1.00 20.00           H
ATOM    224  H1    G B   3      18.442  19.695  15.629  1.00 20.00           H
ATOM    225  H21   G B   3      18.776  21.865  15.394  1.00 20.00           H
ATOM    226  H22   G B   3      20.128  22.479  15.515  1.00 20.00           H
ATOM    227  P     U B   4      25.038  20.052  21.513  1.00 76.88           P
ATOM    228  OP1   U B   4      25.946  20.728  22.475  1.00 78.59           O
ATOM    229  OP2   U B   4      24.599  18.658  21.776  1.00 75.20           O
ATOM    230  O5'   U B   4      23.737  20.955  21.346  1.00 78.76           O
ATOM    231  C5'   U B   4      23.842  22.322  20.974  1.00 77.93           C
ATOM    232  C4'   U B   4      22.492  22.914  20.655  1.00 78.66           C
ATOM    233  O4'   U B   4      21.908  22.220  19.522  1.00 79.49           O
ATOM    234  C3'   U B   4      21.438  22.796  21.745  1.00 78.23           C
ATOM    235  O3'   U B   4      21.564  23.790  22.747  1.00 77.17           O
ATOM    236  C2'   U B   4      20.136  22.882  20.959  1.00 79.34           C
ATOM    237  O2'   U B   4      19.818  24.228  20.636  1.00 79.34           O
ATOM    238  C1'   U B   4      20.506  22.137  19.676  1.00 78.22           C
ATOM    239  N1    U B   4      20.119  20.709  19.729  1.00 20.00           N
ATOM    240  C2    U B   4      18.803  20.391  19.462  1.00 20.00           C
ATOM    241  O2    U B   4      17.962  21.229  19.188  1.00 20.00           O
ATOM    242  N3    U B   4      18.508  19.052  19.527  1.00 20.00           N
ATOM    243  C4    U B   4      19.379  18.023  19.826  1.00 20.00           C
ATOM    244  O4    U B   4      18.961  16.865  19.845  1.00 20.00           O
ATOM    245  C5    U B   4      20.725  18.433  20.091  1.00 20.00           C
ATOM    246  C6    U B   4      21.037  19.732  20.034  1.00 20.00           C
ATOM    247  H5'   U B   4      24.413  22.395  20.194  1.00 77.93           H
ATOM    248 H5''   U B   4      24.240  22.819  21.706  1.00 77.93           H
ATOM    249  H4'   U B   4      22.605  23.850  20.427  1.00 78.66           H
ATOM    250  H3'   U B   4      21.503  21.920  22.156  1.00 78.23           H
ATOM    251 HO3'   U B   4      20.932  24.324  22.892  1.00 77.17           H
ATOM    252  H2'   U B   4      19.409  22.442  21.427  1.00 79.34           H
ATOM    253 HO2'   U B   4      19.611  24.636  21.340  1.00 79.34           H
ATOM    254  H1'   U B   4      20.072  22.562  18.920  1.00 78.22           H
ATOM    255  H5    U B   4      21.375  17.802  20.301  1.00 20.00           H
ATOM    256  H3    U B   4      17.694  18.830  19.364  1.00 20.00           H
ATOM    257  H6    U B   4      21.915  19.985  20.208  1.00 20.00           H
TER
END
"""

def run():
  for idealize in [True,False]:
    exercise(pdb_str=pdb_str, eps=1.e-4, idealize=idealize)

if (__name__ == "__main__"):
  t0 = time.time()
  run()
  print("OK. Time:", round(time.time()-t0, 2), "seconds")


 *******************************************************************************


 *******************************************************************************
mmtbx/hydrogens/tst_riding_fd_5.py
from __future__ import absolute_import, division, print_function
import time
import iotbx.pdb
import mmtbx.model
from cctbx.array_family import flex
from libtbx.utils import null_out
from libtbx.test_utils import approx_equal
from six.moves import zip
from six.moves import range

#-----------------------------------------------------------------------------
# This finite difference test checks transformation of riding H gradients
# for H geometries, H/D exchanged
# C-H exchange might not be sensical, but it's always good to test anyway
#-----------------------------------------------------------------------------
#
def exercise(pdb_str, eps):
  pdb_inp = iotbx.pdb.input(lines=pdb_str.split("\n"), source_info=None)

  model = mmtbx.model.manager(
            model_input = pdb_inp,
            log         = null_out())
  model.process(make_restraints=True)
  geometry_restraints = model.restraints_manager.geometry
  xray_structure = model.get_xray_structure()

  model.setup_riding_h_manager()
  riding_h_manager = model.get_riding_h_manager()

  riding_h_manager.idealize_riding_h_positions(xray_structure=xray_structure)

  sites_cart = xray_structure.sites_cart()

  g_analytical = geometry_restraints.energies_sites(
    sites_cart        = sites_cart,
    compute_gradients = True).gradients

  hd_selection = xray_structure.hd_selection()
  g_analytical_reduced = riding_h_manager.gradients_reduced_cpp(
    gradients    = g_analytical,
    sites_cart   = sites_cart,
    hd_selection = hd_selection)
  #
  ex = [eps,0,0]
  ey = [0,eps,0]
  ez = [0,0,eps]
  g_fd = flex.vec3_double()
  for i_site in range(sites_cart.size()):
    g_fd_i = []
    for e in [ex,ey,ez]:
      ts = []
      for sign in [-1,1]:
        sites_cart_ = sites_cart.deep_copy()
        xray_structure_ = xray_structure.deep_copy_scatterers()
        sites_cart_[i_site] = [
          sites_cart_[i_site][j]+e[j]*sign for j in range(3)]
        xray_structure_.set_sites_cart(sites_cart_)
        # after shift, recalculate H position
        riding_h_manager.idealize_riding_h_positions(
          xray_structure=xray_structure_)
        sites_cart_ = xray_structure_.sites_cart()
        ts.append(geometry_restraints.energies_sites(
          sites_cart = sites_cart_,
          compute_gradients = False).target)
      g_fd_i.append((ts[1]-ts[0])/(2*eps))
    g_fd.append(g_fd_i)

  g_fd_reduced = g_fd.select(~hd_selection)

  for g1, g2 in zip(g_analytical_reduced, g_fd_reduced):
    assert approx_equal(g1,g2, 1.e-4)

# flat 2 neighbors
pdb_str_01 = """
CRYST1   15.083   11.251   14.394  90.00  90.00  90.00 P 1
SCALE1      0.066300  0.000000  0.000000        0.00000
SCALE2      0.000000  0.088881  0.000000        0.00000
SCALE3      0.000000  0.000000  0.069473        0.00000
ATOM      1  C   ARG A   2       5.253  20.304  25.155  1.00  0.00           C
ATOM      2  N   HIS A   3       6.067  20.098  24.123  1.00  0.00           N
ATOM      3  CA  HIS A   3       7.516  20.107  24.260  1.00  0.00           C
ATOM      4  H  AHIS A   3       5.747  19.921  23.171  0.50  0.00           H
ATOM      5  D  BHIS A   3       5.747  19.921  23.171  0.50  0.00           D
"""

# flat 2 neighbors shaked
pdb_str_02 = """
CRYST1   15.083   11.251   14.394  90.00  90.00  90.00 P 1
SCALE1      0.066300  0.000000  0.000000        0.00000
SCALE2      0.000000  0.088881  0.000000        0.00000
SCALE3      0.000000  0.000000  0.069473        0.00000
ATOM      1  C   ARG A   2       5.099  20.402  25.169  1.00  0.00           C
ATOM      2  N   HIS A   3       6.078  20.274  24.222  1.00  0.00           N
ATOM      3  CA  HIS A   3       7.421  19.969  24.222  1.00  0.00           C
ATOM      4  H  AHIS A   3       5.582  19.974  23.131  0.50  0.00           H
ATOM      5  D  BHIS A   3       5.926  20.100  23.155  0.50  0.00           D
"""

# alg1a minimized
pdb_str_03 = """
CRYST1   14.446   16.451   11.913  90.00  90.00  90.00 P 1
SCALE1      0.069223  0.000000  0.000000        0.00000
SCALE2      0.000000  0.060787  0.000000        0.00000
SCALE3      0.000000  0.000000  0.083942        0.00000
ATOM      1  CD  ARG A  50       4.896   7.973   6.011  1.00 10.00           C
ATOM      2  NE  ARG A  50       5.406   6.701   5.508  1.00 10.00           N
ATOM      3  CZ  ARG A  50       6.515   6.111   5.944  1.00 10.00           C
ATOM      4  NH1 ARG A  50       7.243   6.676   6.898  1.00 10.00           N
ATOM      5  NH2 ARG A  50       6.898   4.953   5.424  1.00 10.00           N
ATOM      6  HE AARG A  50       4.876   6.233   4.773  0.50 10.00           H
ATOM      7 HH11AARG A  50       6.956   7.567   7.304  0.50 10.00           H
ATOM      8 HH12AARG A  50       8.093   6.218   7.227  0.50 10.00           H
ATOM      9 HH21AARG A  50       6.342   4.515   4.690  0.50 10.00           H
ATOM     10 HH22AARG A  50       7.749   4.500   5.758  0.50 10.00           H
ATOM     11  DE BARG A  50       4.876   6.233   4.773  0.50 10.00           D
ATOM     12 DH11BARG A  50       6.956   7.567   7.304  0.50 10.00           D
ATOM     13 DH12BARG A  50       8.093   6.218   7.227  0.50 10.00           D
ATOM     14 DH21BARG A  50       6.342   4.515   4.690  0.50 10.00           D
ATOM     15 DH22BARG A  50       7.749   4.500   5.758  0.50 10.00           D
TER
"""

# alg1a shaked
pdb_str_04 = """
CRYST1   14.446   16.451   11.913  90.00  90.00  90.00 P 1
SCALE1      0.069223  0.000000  0.000000        0.00000
SCALE2      0.000000  0.060787  0.000000        0.00000
SCALE3      0.000000  0.000000  0.083942        0.00000
ATOM      1  CD  ARG A  50       4.830   7.928   6.084  1.00 10.00           C
ATOM      2  NE  ARG A  50       5.434   6.841   5.374  1.00 10.00           N
ATOM      3  CZ  ARG A  50       6.450   6.116   6.035  1.00 10.00           C
ATOM      4  NH1 ARG A  50       7.392   6.694   6.803  1.00 10.00           N
ATOM      5  NH2 ARG A  50       6.898   5.026   5.305  1.00 10.00           N
ATOM      6  HE AARG A  50       4.867   6.348   4.684  0.50 10.00           H
ATOM      7 HH11AARG A  50       7.140   7.516   7.352  0.50 10.00           H
ATOM      8 HH12AARG A  50       8.199   6.141   7.091  0.50 10.00           H
ATOM      9 HH21AARG A  50       6.308   4.628   4.574  0.50 10.00           H
ATOM     10 HH22AARG A  50       7.759   4.551   5.577  0.50 10.00           H
ATOM     11  DE BARG A  50       4.867   6.348   4.684  0.50 10.00           D
ATOM     12 DH11BARG A  50       7.140   7.516   7.352  0.50 10.00           D
ATOM     13 DH12BARG A  50       8.199   6.141   7.091  0.50 10.00           D
ATOM     14 DH21BARG A  50       6.308   4.628   4.574  0.50 10.00           D
ATOM     15 DH22BARG A  50       7.759   4.551   5.577  0.50 10.00           D
"""

# 2tetra
pdb_str_05 = """
CRYST1   27.805   30.931   25.453  90.00  90.00  90.00 P 1
SCALE1      0.035965  0.000000  0.000000        0.00000
SCALE2      0.000000  0.032330  0.000000        0.00000
SCALE3      0.000000  0.000000  0.039288        0.00000
ATOM      1  CA  SER A   3      11.057  14.432  13.617  1.00  5.95           C
ANISOU    1  CA  SER A   3      582    671   1007   -168    135    158       C
ATOM      2  CB  SER A   3      10.277  13.648  12.559  1.00  6.41           C
ANISOU    2  CB  SER A   3      638    591   1207   -162    148    106       C
ATOM      3  OG  SER A   3       9.060  14.298  12.238  1.00  7.60           O
ANISOU    3  OG  SER A   3      680    955   1251   -244   -164    339       O
ATOM      4  HB2ASER A   3      10.818  13.578  11.757  0.40  6.41           H
ATOM      5  HB3ASER A   3      10.081  12.763  12.904  0.40  6.41           H
ATOM      6  DB2BSER A   3      10.818  13.578  11.757  0.60  6.41           D
ATOM      7  DB3BSER A   3      10.081  12.763  12.904  0.60  6.41           D
"""

# 2tetra distorted
pdb_str_06 = """
CRYST1   27.805   30.931   25.453  90.00  90.00  90.00 P 1
SCALE1      0.035965  0.000000  0.000000        0.00000
SCALE2      0.000000  0.032330  0.000000        0.00000
SCALE3      0.000000  0.000000  0.039288        0.00000
ATOM      1  CA  SER A   3      10.856  14.444  13.455  1.00  5.95           C
ANISOU    1  CA  SER A   3      582    671   1007   -168    135    158       C
ATOM      2  CB  SER A   3      10.225  13.565  12.597  1.00  6.41           C
ANISOU    2  CB  SER A   3      638    591   1207   -162    148    106       C
ATOM      3  OG  SER A   3       9.123  14.383  12.193  1.00  7.60           O
ANISOU    3  OG  SER A   3      680    955   1251   -244   -164    339       O
ATOM      4  HB2ASER A   3      10.969  13.436  11.739  0.40  6.41           H
ATOM      5  HB3ASER A   3      10.028  12.954  13.077  0.40  6.41           H
ATOM      6  DB2BSER A   3      10.925  13.557  11.772  0.60  6.41           D
ATOM      7  DB3BSER A   3      10.287  12.654  12.803  0.60  6.41           D
"""

# 3tetra minimized
pdb_str_07 = """
CRYST1   27.805   30.931   25.453  90.00  90.00  90.00 P 1
SCALE1      0.035965  0.000000  0.000000        0.00000
SCALE2      0.000000  0.032330  0.000000        0.00000
SCALE3      0.000000  0.000000  0.039288        0.00000
ATOM      1  N   SER A   4       7.601  20.006  12.837  1.00  5.10           N
ANISOU    1  N   SER A   4      500    632    808   -107     58    104       N
ATOM      2  CA  SER A   4       7.145  18.738  13.391  1.00  5.95           C
ANISOU    2  CA  SER A   4      582    671   1007   -168    135    158       C
ATOM      3  C   SER A   4       8.313  17.949  13.971  1.00  5.79           C
ANISOU    3  C   SER A   4      661    588    952   -116    206    135       C
ATOM      4  CB  SER A   4       6.433  17.910  12.319  1.00  6.41           C
ANISOU    4  CB  SER A   4      638    591   1207   -162    148    106       C
ATOM      5  HA ASER A   4       6.513  18.912  14.106  0.55  5.95           H
ATOM      5  DA BSER A   4       6.513  18.912  14.106  0.45  5.95           D
"""

# 3tetra distorted
pdb_str_08 = """
CRYST1   27.805   30.931   25.453  90.00  90.00  90.00 P 1
SCALE1      0.035965  0.000000  0.000000        0.00000
SCALE2      0.000000  0.032330  0.000000        0.00000
SCALE3      0.000000  0.000000  0.039288        0.00000
ATOM      1  N   SER A   4       7.694  20.012  12.917  1.00  5.10           N
ANISOU    1  N   SER A   4      500    632    808   -107     58    104       N
ATOM      2  CA  SER A   4       7.004  18.841  13.534  1.00  5.95           C
ANISOU    2  CA  SER A   4      582    671   1007   -168    135    158       C
ATOM      3  C   SER A   4       8.178  17.985  14.068  1.00  5.79           C
ANISOU    3  C   SER A   4      661    588    952   -116    206    135       C
ATOM      4  CB  SER A   4       6.270  18.108  12.379  1.00  6.41           C
ANISOU    4  CB  SER A   4      638    591   1207   -162    148    106       C
ATOM      5  HA ASER A   4       6.524  18.724  14.126  0.55  5.95           H
ATOM      5  DA BSER A   4       6.513  18.912  14.106  0.45  5.95           H
"""

# alg1b minimized
pdb_str_09 = """CRYST1   27.805   30.931   25.453  90.00  90.00  90.00 P 1
SCALE1      0.035965  0.000000  0.000000        0.00000
SCALE2      0.000000  0.032330  0.000000        0.00000
SCALE3      0.000000  0.000000  0.039288        0.00000
ATOM      1  CA  SER A   6      10.253  21.454  16.783  1.00  5.95           C
ANISOU    1  CA  SER A   6      582    671   1007   -168    135    158       C
ATOM      2  CB  SER A   6       9.552  20.703  15.649  1.00  6.41           C
ANISOU    2  CB  SER A   6      638    591   1207   -162    148    106       C
ATOM      3  OG  SER A   6       8.345  21.347  15.280  1.00  7.60           O
ANISOU    3  OG  SER A   6      680    955   1251   -244   -164    339       O
ATOM      4  HB2 SER A   6      10.214  20.670  14.784  0.45  6.41           H
ATOM      5  HB3 SER A   6       9.325  19.690  15.982  0.45  6.41           H
ATOM      6  HG ASER A   6       7.910  20.853  14.554  0.55  7.60           H
ATOM      7  DG BSER A   6       7.910  20.853  14.554  0.55  7.60           D
TER
"""

# alg1b distorted
pdb_str_10 = """
CRYST1   27.805   30.931   25.453  90.00  90.00  90.00 P 1
SCALE1      0.035965  0.000000  0.000000        0.00000
SCALE2      0.000000  0.032330  0.000000        0.00000
SCALE3      0.000000  0.000000  0.039288        0.00000
ATOM      1  CA  SER A   6      10.083  21.475  16.848  1.00  5.95           C
ANISOU    1  CA  SER A   6      582    671   1007   -168    135    158       C
ATOM      2  CB  SER A   6       9.437  20.751  15.546  1.00  6.41           C
ANISOU    2  CB  SER A   6      638    591   1207   -162    148    106       C
ATOM      3  OG  SER A   6       8.368  21.346  15.146  1.00  7.60           O
ANISOU    3  OG  SER A   6      680    955   1251   -244   -164    339       O
ATOM      4  HB2 SER A   6      10.034  20.616  14.977  0.45  6.41           H
ATOM      5  HB3 SER A   6       9.158  19.775  16.137  0.45  6.41           H
ATOM      6  HG ASER A   6       7.964  20.906  14.679  0.55  7.60           H
ATOM      7  DG BSER A   6       7.989  20.672  14.454  0.55  7.60           D
"""

# propeller minimized
pdb_str_11 = """
CRYST1   27.805   30.931   25.453  90.00  90.00  90.00 P 1
SCALE1      0.035965  0.000000  0.000000        0.00000
SCALE2      0.000000  0.032330  0.000000        0.00000
SCALE3      0.000000  0.000000  0.039288        0.00000
ATOM      1  CA  VAL A   7      17.924   8.950  14.754  1.00 10.37           C
ANISOU    1  CA  VAL A   7     1783    902   1255     67   -148    -14       C
ATOM      2  CB  VAL A   7      16.678   8.886  13.852  1.00 11.26           C
ANISOU    2  CB  VAL A   7     1571    963   1743     96   -176     62       C
ATOM      3  CG1 VAL A   7      16.660  10.063  12.888  1.00 11.06           C
ANISOU    3  CG1 VAL A   7     1704   1072   1425    125   -105     37       C
ATOM      4 HG11AVAL A   7      16.643  10.888  13.399  0.35 13.27           H
ATOM      5 HG12AVAL A   7      15.868  10.002  12.331  0.35 13.27           H
ATOM      6 HG13AVAL A   7      17.457  10.030  12.336  0.35 13.27           H
ATOM      7 DG11BVAL A   7      16.643  10.888  13.399  0.65 13.27           D
ATOM      8 DG12BVAL A   7      15.868  10.002  12.331  0.65 13.27           D
ATOM      9 DG13BVAL A   7      17.457  10.030  12.336  0.65 13.27           D
"""

# propeller shaked
pdb_str_12 = """
CRYST1   27.805   30.931   25.453  90.00  90.00  90.00 P 1
SCALE1      0.035965  0.000000  0.000000        0.00000
SCALE2      0.000000  0.032330  0.000000        0.00000
SCALE3      0.000000  0.000000  0.039288        0.00000
ATOM      1  CA  VAL A   7      17.967   9.002  14.926  1.00 10.37           C
ANISOU    1  CA  VAL A   7     1783    902   1255     67   -148    -14       C
ATOM      2  CB  VAL A   7      16.698   8.861  13.864  1.00 11.26           C
ANISOU    2  CB  VAL A   7     1571    963   1743     96   -176     62       C
ATOM      3  CG1 VAL A   7      16.655  10.154  13.014  1.00 11.06           C
ANISOU    3  CG1 VAL A   7     1704   1072   1425    125   -105     37       C
ATOM      4 HG11AVAL A   7      16.508  10.702  13.486  0.35 13.27           H
ATOM      5 HG12AVAL A   7      15.946   9.926  12.504  0.35 13.27           H
ATOM      6 HG13AVAL A   7      17.430   9.954  12.137  0.35 13.27           H
ATOM      7 DG11BVAL A   7      16.842  11.073  13.530  0.65 13.27           D
ATOM      8 DG12BVAL A   7      15.776  10.049  12.295  0.65 13.27           D
ATOM      9 DG13BVAL A   7      17.656   9.940  12.381  0.65 13.27           D
"""

pdb_list = [pdb_str_01, pdb_str_02, pdb_str_03, pdb_str_04, pdb_str_05,
  pdb_str_06, pdb_str_07, pdb_str_08, pdb_str_09, pdb_str_10, pdb_str_11,
  pdb_str_12]
#
pdb_list_name = ['pdb_str_01', 'pdb_str_02', 'pdb_str_03', 'pdb_str_04', 'pdb_str_05',
  'pdb_str_06', 'pdb_str_07', 'pdb_str_08', 'pdb_str_09', 'pdb_str_10', 'pdb_str_11',
  'pdb_str_12']

#pdb_list = [pdb_str_02]
#pdb_list_name = ['pdb_str_02']

def run():
  #for idealize in [True, False]:
  for pdb_str, str_name in zip(pdb_list,pdb_list_name):
    #print 'pdb_string:', str_name#, 'idealize =', idealize
    exercise(pdb_str=pdb_str, eps=1.e-4)


if (__name__ == "__main__"):
  t0 = time.time()
  run()
  print("OK. Time:", round(time.time()-t0, 2), "seconds")


 *******************************************************************************


 *******************************************************************************
mmtbx/hydrogens/tst_riding_manager.py
from __future__ import absolute_import, division, print_function
import time
import mmtbx.model
import iotbx.pdb
from libtbx.utils import null_out
from libtbx import group_args

#-------------------------------------------------
# Test for deep_copy method in riding H manager
#-------------------------------------------------
def exercise1():
  pdb_inp = iotbx.pdb.input(lines=pdb_str.split("\n"), source_info=None)
  model = mmtbx.model.manager(
    model_input = pdb_inp,
    log         = null_out())
  model.process(make_restraints=True)
  pdb_hierarchy = model.get_hierarchy()
  sites_cart = model.get_sites_cart()
  atoms = pdb_hierarchy.atoms()

  model.setup_riding_h_manager()
  riding_h_manager = model.get_riding_h_manager()

  h_parameterization = riding_h_manager.h_parameterization
  number_h = model.get_hd_selection().count(True)
  number_h_para = len(h_parameterization) - h_parameterization.count(None)

  assert (number_h_para == number_h)

  rc = h_parameterization[20]

  new_manager = riding_h_manager.deep_copy()
  new_h_parameterization = new_manager.h_parameterization
  rc_new = new_h_parameterization[20]

  assert (rc_new.htype == rc.htype)
  assert (rc_new.ih    == rc.ih)
  assert (rc_new.a0    == rc.a0)
  assert (rc_new.a1    == rc.a1)
  assert (rc_new.a2    == rc.a2)
  assert (rc_new.a3    == rc.a3)
  assert (rc_new.a     == rc.a)
  assert (rc_new.b     == rc.b)
  assert (rc_new.h     == rc.h)
  assert (rc_new.n     == rc.n)
  assert (rc_new.disth == rc.disth)

  rc_new.htype = 'unk'
  rc_new.ih    = 0
  rc_new.a0    = 1
  rc_new.a1    = 2
  rc_new.a2    = 3
  rc_new.a3    = 4

  assert (rc_new.htype != rc.htype)
  assert (rc_new.ih != rc.ih)
  assert (rc_new.a0 != rc.a0)
  assert (rc_new.a1 != rc.a1)
  assert (rc_new.a2 != rc.a2)
  assert (rc_new.a3 != rc.a3)


def apply_selection(riding_h_manager, selection, answers):
  entries_original_h_para = 21
  entries_cpp_original    = 9
  h_parameterization = riding_h_manager.h_parameterization

  pdb_hierarchy = riding_h_manager.pdb_hierarchy
  n_atoms = pdb_hierarchy.atoms_size()

  selected_manager = riding_h_manager.select(selection)
  new_h_parameterization = selected_manager.h_parameterization

  # Check that length of h_para corresponds to known answer and to number
  # of atoms in hierarchy
  assert (len(h_parameterization) == entries_original_h_para)
  assert (len(h_parameterization) == n_atoms)
  assert (len(new_h_parameterization) == answers.entries_selected_h_para)
  assert (
    len(new_h_parameterization) == selected_manager.pdb_hierarchy.atoms_size())
  assert (len(riding_h_manager.parameterization_cpp) == entries_cpp_original)
  #print('number of entries in new_h_para_selected', len(new_h_parameterization))
  #print('para c++ new', len(selected_manager.parameterization_cpp))
  assert (
    len(selected_manager.parameterization_cpp) == answers.entries_cpp_selected)


  assert (
    selected_manager.hd_selection.count(True) == answers.h_in_selected_hierarchy)

  # check if calculated H position is close to input position (input H is ideal)
  # This will (in most cases) produce large deviations if reindexing failed
  atoms = selected_manager.pdb_hierarchy.atoms()
  sites_cart = atoms.extract_xyz()
  diagnostics = selected_manager.diagnostics(
    sites_cart         = sites_cart,
    threshold          = 0.05)
  h_distances = diagnostics.h_distances
  for ih in h_distances:
    assert (h_distances[ih] < 0.0001), \
      'distance too large: %s  atom: %s distance: %s ' \
      % (new_h_parameterization[ih].htype, atoms[ih].id_str(), h_distances[ih])

#-------------------------------------------------
# Test for select method in riding H manager
#-------------------------------------------------
def exercise2():
  pdb_inp = iotbx.pdb.input(lines=pdb_str.split("\n"), source_info=None)
  model = mmtbx.model.manager(
    model_input = pdb_inp,
    log         = null_out())
  model.process(make_restraints=True)
  pdb_hierarchy = model.get_hierarchy()

  model.setup_riding_h_manager()
  riding_h_manager = model.get_riding_h_manager()

  h_parameterization = riding_h_manager.h_parameterization
  number_h = model.get_hd_selection().count(True)
  number_h_para = len(h_parameterization) - h_parameterization.count(None)

  # Check that all H atoms are parameterized in original manager
  assert (number_h_para == number_h)

  # Test several selections and compare with known answers
  #
  #print('selection1 = not (name CE1 or name CB)')
  selection1 = pdb_hierarchy.atom_selection_cache().\
      selection("not (name CE1 or name CB)")
  answers1 = group_args(
    entries_selected_h_para = 19,
    entries_cpp_selected    = 3,
    h_in_selected_hierarchy = 9)
  apply_selection(
    riding_h_manager = riding_h_manager,
    selection        = selection1,
    answers          = answers1)
  #
  #print('selection2 = not (name CD1 or name HD2 or name C)')
  selection2 = pdb_hierarchy.atom_selection_cache().\
      selection("not (name CD1 or name HD2 or name C)")
  answers2 = group_args(
    entries_selected_h_para = 18,
    entries_cpp_selected    = 4,
    h_in_selected_hierarchy = 8)
  apply_selection(
    riding_h_manager = riding_h_manager,
    selection        = selection2,
    answers          = answers2)
  #
  #print('selection3 = not (name N or name HB2 or name CE2)')
  selection3 = pdb_hierarchy.atom_selection_cache().\
      selection("not (name N or name HB2 or name CE2)")
  answers3 = group_args(
    entries_selected_h_para = 18,
    entries_cpp_selected    = 4,
    h_in_selected_hierarchy = 8)
  apply_selection(
    riding_h_manager = riding_h_manager,
    selection        = selection3,
    answers          = answers3)

# Ideal amino acid TYR
pdb_str = """\
CRYST1   17.392   14.073   15.364  90.00  90.00  90.00 P 1
SCALE1      0.057498  0.000000  0.000000        0.00000
SCALE2      0.000000  0.071058  0.000000        0.00000
SCALE3      0.000000  0.000000  0.065087        0.00000
ATOM      1  N   TYR D   8      10.136   5.241   8.802  1.00  0.00           N
ATOM      2  CA  TYR D   8      10.978   6.381   8.437  1.00  0.00           C
ATOM      3  C   TYR D   8      12.298   6.240   9.189  1.00  0.00           C
ATOM      4  O   TYR D   8      12.392   6.606  10.364  1.00  0.00           O
ATOM      5  CB  TYR D   8      10.292   7.703   8.763  1.00  0.00           C
ATOM      6  CG  TYR D   8       9.066   7.978   7.922  1.00  0.00           C
ATOM      7  CD1 TYR D   8       9.182   8.482   6.634  1.00  0.00           C
ATOM      8  CD2 TYR D   8       7.791   7.735   8.417  1.00  0.00           C
ATOM      9  CE1 TYR D   8       8.065   8.735   5.861  1.00  0.00           C
ATOM     10  CE2 TYR D   8       6.668   7.985   7.653  1.00  0.00           C
ATOM     11  CZ  TYR D   8       6.810   8.485   6.376  1.00  0.00           C
ATOM     12  OH  TYR D   8       5.694   8.736   5.611  1.00  0.00           O
ATOM     13  H   TYR D   8      10.218   5.000   9.623  1.00  0.00           H
ATOM     14  HA  TYR D   8      11.163   6.357   7.486  1.00  0.00           H
ATOM     15  HB2 TYR D   8      10.017   7.691   9.693  1.00  0.00           H
ATOM     16  HB3 TYR D   8      10.921   8.426   8.615  1.00  0.00           H
ATOM     17  HD1 TYR D   8      10.027   8.652   6.284  1.00  0.00           H
ATOM     18  HD2 TYR D   8       7.693   7.397   9.278  1.00  0.00           H
ATOM     19  HE1 TYR D   8       8.158   9.073   5.000  1.00  0.00           H
ATOM     20  HE2 TYR D   8       5.821   7.817   7.997  1.00  0.00           H
ATOM     21  HH  TYR D   8       5.000   8.541   6.042  1.00  0.00           H
TER
END
"""

if (__name__ == "__main__"):
  t0 = time.time()
  exercise1()
  exercise2()
  print("OK. Time: %8.3f"%(time.time()-t0))


 *******************************************************************************


 *******************************************************************************
mmtbx/hydrogens/tst_riding_minimize.py
from __future__ import absolute_import, division, print_function
import time
from mmtbx import monomer_library
import mmtbx.monomer_library.server
import mmtbx.monomer_library.pdb_interpretation
from cctbx import geometry_restraints
import scitbx.lbfgs
import mmtbx.utils
# For lbfgs class:
from cctbx import xray
from cctbx import crystal
from cctbx.array_family import flex
import scitbx.lbfgs
from libtbx import adopt_init_args
import math
# for riding H:
from mmtbx.hydrogens import riding

class lbfgs(object):

  def __init__(self,
               xray_structure,
               geometry_restraints,
               states,
               riding_h_manager,
               use_riding,
               verbose,
               max_iterations = 1000,
               min_iterations = 0,
               correct_special_position_tolerance = 1.0):
    adopt_init_args(self, locals())
    # f = refinement target
    self.f = None
    self.correct_special_position_tolerance = correct_special_position_tolerance
    # self.x = coordinate shifts
    self.x = flex.double(self.xray_structure.n_parameters(), 0)
    self.h_parameterization = self.riding_h_manager.h_parameterization
    self._scatterers_start = self.xray_structure.scatterers()
    # -----------------------------------------------------
    if self.use_riding:
      self.hd_selection = self.xray_structure.hd_selection()
      self.x = flex.double(
        self.xray_structure.select(~self.hd_selection).n_parameters(), 0)
      self._scatterers_start = self.xray_structure.scatterers().select(
        ~self.hd_selection)
    # -----------------------------------------------------
    lbfgs_termination_params=scitbx.lbfgs.termination_parameters(
      max_iterations = max_iterations,
      min_iterations = min_iterations)
    self.minimizer = scitbx.lbfgs.run(
      target_evaluator          = self,
      termination_params        = lbfgs_termination_params,
      exception_handling_params = scitbx.lbfgs.exception_handling_parameters(
        ignore_line_search_failed_step_at_lower_bound = True))
    self.apply_shifts()
    del self._scatterers_start
    self.compute_target(compute_gradients = False)

  def apply_shifts(self):
    apply_shifts_result = xray.ext.minimization_apply_shifts(
      unit_cell      = self.xray_structure.unit_cell(),
      scatterers     = self._scatterers_start,
      shifts         = self.x)
    scatterers_shifted = apply_shifts_result.shifted_scatterers
    site_symmetry_table = self.xray_structure.site_symmetry_table()
    for i_seq in site_symmetry_table.special_position_indices():
      scatterers_shifted[i_seq].site = crystal.correct_special_position(
        crystal_symmetry = self.xray_structure,
        special_op       = site_symmetry_table.get(i_seq).special_op(),
        site_frac        = scatterers_shifted[i_seq].site,
        site_label       = scatterers_shifted[i_seq].label,
        tolerance        = self.correct_special_position_tolerance)
    # -----------------------------------------------------
    if self.use_riding:
      new_sites = self.xray_structure.sites_frac().set_selected(
        ~self.hd_selection, scatterers_shifted.extract_sites())
      self.xray_structure.set_sites_frac(new_sites)
      self.riding_h_manager.idealize_riding_h_positions(
          xray_structure = self.xray_structure)
    else:
      self.xray_structure.replace_scatterers(scatterers = scatterers_shifted)
    self.states.add(sites_cart = self.xray_structure.sites_cart())

  def compute_target(self, compute_gradients):
    target_and_grads = self.geometry_restraints.energies_sites(
      sites_cart = self.xray_structure.sites_cart(),
      compute_gradients = True)
    self.f = target_and_grads.target
    if(compute_gradients):
      self.grads = target_and_grads.gradients
    # -----------------------------------------------------
    # if use_riding hydrogen, modify the gradients
      if self.use_riding:
        self.grads = self.riding_h_manager.gradients_reduced_cpp(
          gradients    = self.grads,
          sites_cart   = self.xray_structure.sites_cart(),
          hd_selection = self.hd_selection)
    # -----------------------------------------------------
      self.g = self.grads.as_double()

  def callback_after_step(self, minimizer):
    if(self.verbose > 0):
      print("refinement.minimization step: f,iter,nfun:", self.f,minimizer.iter(),minimizer.nfun())

  def compute_functional_and_gradients(self):
    self.apply_shifts()
    self.compute_target(compute_gradients = True)
    if(self.verbose > 1):
      print ("xray.minimization line search: f,rms(g):",
        self.f, math.sqrt(flex.mean_sq(self.g)))
    return self.f, self.g

# distorted Tyrosine residue
pdb_str = """
CRYST1   16.660   13.261   16.215  90.00  90.00  90.00 P 1
SCALE1      0.060024  0.000000  0.000000        0.00000
SCALE2      0.000000  0.075409  0.000000        0.00000
SCALE3      0.000000  0.000000  0.061671        0.00000
ATOM      1  N   TYR A   7       9.035   7.089   5.637  1.00 15.00           N
ATOM      2  CA  TYR A   7       9.887   7.460   6.606  1.00 15.00           C
ATOM      3  C   TYR A   7      11.285   7.169   6.250  1.00 15.00           C
ATOM      4  O   TYR A   7      11.563   6.972   4.911  1.00 15.00           O
ATOM      5  CB  TYR A   7       9.830   6.306   7.775  1.00 15.00           C
ATOM      6  CG  TYR A   7       8.528   6.445   8.572  1.00 15.00           C
ATOM      7  CD1 TYR A   7       7.544   5.558   7.939  1.00 15.00           C
ATOM      8  CD2 TYR A   7       8.348   7.014   9.545  1.00 15.00           C
ATOM      9  CE1 TYR A   7       6.338   5.396   8.586  1.00 15.00           C
ATOM     10  CE2 TYR A   7       7.068   7.273  10.230  1.00 15.00           C
ATOM     11  CZ  TYR A   7       6.090   6.501   9.765  1.00 15.00           C
ATOM     12  OH  TYR A   7       4.857   6.463  10.553  1.00 15.00           O
ATOM     13  HA  TYR A   7       9.831   8.340   7.271  1.00 15.00           H
ATOM     14  HB2 TYR A   7       9.943   5.616   7.588  1.00 15.00           H
ATOM     15  HB3 TYR A   7      10.644   6.563   8.354  1.00 15.00           H
ATOM     16  HD1 TYR A   7       7.598   4.974   7.330  1.00 15.00           H
ATOM     17  HD2 TYR A   7       9.064   7.637  10.081  1.00 15.00           H
ATOM     18  HE1 TYR A   7       5.756   5.132   8.319  1.00 15.00           H
ATOM     19  HE2 TYR A   7       7.206   7.495  11.005  1.00 15.00           H
ATOM     20  HH  TYR A   7       5.208   7.016  11.256  1.00 15.00           H
TER
"""

def run():
  mon_lib_srv = monomer_library.server.server()
  ener_lib = monomer_library.server.ener_lib()
  processed_pdb_file = monomer_library.pdb_interpretation.process(
    mon_lib_srv    = mon_lib_srv,
    ener_lib       = ener_lib,
    file_name      = None,
    raw_records    = pdb_str,
    force_symmetry = True)
  pdb_hierarchy = processed_pdb_file.all_chain_proxies.pdb_hierarchy
  xray_structure = processed_pdb_file.xray_structure()
  #pdb_hierarchy.write_pdb_file(
  #  file_name        = "distorted.pdb",
  #  crystal_symmetry = xray_structure.crystal_symmetry())
  geometry_restraints = processed_pdb_file.geometry_restraints_manager(
    show_energies = False)
  #geometry_restraints.write_geo_file(file_name='start.geo')
  states = mmtbx.utils.states(
    pdb_hierarchy  = pdb_hierarchy)
  states.add(sites_cart = xray_structure.sites_cart())

  riding_h_manager = riding.manager(
    pdb_hierarchy       = pdb_hierarchy,
    geometry_restraints = geometry_restraints)

  states.add(sites_cart = xray_structure.sites_cart())
  #xray_structure.scatterers().flags_set_grads(state=False)
  xray_structure.scatterers().flags_set_grad_site(
    iselection = xray_structure.all_selection().iselection())

  use_riding = True
  minimized = lbfgs(
    xray_structure      = xray_structure,
    states              = states,
    geometry_restraints = geometry_restraints,
    riding_h_manager    = riding_h_manager,
    use_riding          = use_riding,
    verbose             = 0)
  #minimized.states.write(
  #  file_name        = "minimized_all_states.pdb",
  #  crystal_symmetry = xray_structure.crystal_symmetry())
  pdb_hierarchy.adopt_xray_structure(minimized.xray_structure)
  #pdb_hierarchy.write_pdb_file(
  #  file_name        = "minimized.pdb",
  #  crystal_symmetry = xray_structure.crystal_symmetry())

  target_final = geometry_restraints.energies_sites(
    sites_cart = xray_structure.sites_cart(),
    compute_gradients = True).target
  print('final target', target_final)
  assert (target_final < 1.5), 'Target of final riding model is too large'

if (__name__ == "__main__"):
  t0 = time.time()
  run()
  print("OK. Time:", round(time.time()-t0, 2), "seconds")


 *******************************************************************************


 *******************************************************************************
mmtbx/hydrogens/tst_validate_H.py
from __future__ import absolute_import, division, print_function
import os, time
import mmtbx.model
import iotbx.pdb
from mmtbx.monomer_library.pdb_interpretation import grand_master_phil_str
from libtbx.test_utils import approx_equal
from mmtbx.hydrogens.validate_H import validate_H, validate_H_results
from libtbx.utils import null_out
from six.moves import zip
#from validate_H_cl_app import master_params_str

pdb_str = """
CRYST1   43.705   48.284   96.292  90.00  90.00  90.00 P 1
SCALE1      0.022881  0.000000  0.000000        0.00000
SCALE2      0.000000  0.020711  0.000000        0.00000
SCALE3      0.000000  0.000000  0.010385        0.00000
ATOM      1  N   ASN A   1      25.174 -24.761 -21.940  1.00 16.59           N
ATOM      2  CA  ASN A   1      25.971 -25.578 -22.850  1.00 17.25           C
ATOM      3  C   ASN A   1      26.037 -24.941 -24.225  1.00 16.66           C
ATOM      4  O   ASN A   1      27.077 -24.979 -24.874  1.00 18.42           O
ATOM      5  CB  ASN A   1      25.498 -27.040 -22.913  1.00 18.30           C
ATOM      6  CG  ASN A   1      24.187 -27.208 -23.672  1.00 20.42           C
ATOM      7  OD1 ASN A   1      23.167 -26.590 -23.335  1.00 20.87           O
ATOM      8  ND2 ASN A   1      24.200 -28.069 -24.685  1.00 18.15           N
ATOM      9  DA  ASN A   1      26.975 -25.581 -22.461  1.00 15.99           D
ATOM     10 DD21 ASN A   1      25.030 -28.545 -24.882  1.00 16.07           D
ATOM     11  D  AASN A   1      24.379 -25.105 -21.517  0.82 16.71           D
ATOM     12  DB2AASN A   1      25.358 -27.400 -21.898  0.65 18.82           D
ATOM     13  DB3AASN A   1      26.255 -27.641 -23.402  0.56 18.30           D
ATOM     14 DD22AASN A   1      23.370 -28.163 -25.192  0.72 16.98           D
ATOM     15  H  BASN A   1      24.379 -25.105 -21.517  0.18 16.71           H
ATOM     16  HB2BASN A   1      26.255 -27.641 -23.402  0.44 18.30           H
ATOM     17  HB3BASN A   1      25.358 -27.400 -21.898  0.35 18.82           H
ATOM     18 HD22BASN A   1      23.370 -28.163 -25.192  0.28 16.98           H
ATOM     19  N   ASN A   2      23.615 -22.281 -25.492  1.00 16.59           N
ATOM     20  CA  ASN A   2      24.412 -23.098 -26.402  1.00 17.25           C
ATOM     21  C   ASN A   2      24.478 -22.461 -27.777  1.00 16.66           C
ATOM     22  O   ASN A   2      25.518 -22.499 -28.426  1.00 18.42           O
ATOM     23  CB  ASN A   2      23.939 -24.560 -26.465  1.00 18.30           C
ATOM     24  CG  ASN A   2      22.628 -24.728 -27.224  1.00 20.42           C
ATOM     25  OD1 ASN A   2      21.608 -24.110 -26.887  1.00 20.87           O
ATOM     26  ND2 ASN A   2      22.641 -25.589 -28.237  1.00 18.15           N
ATOM     27  DA  ASN A   2      25.416 -23.101 -26.013  1.00 15.99           D
ATOM     28 HD21 ASN A   2      23.471 -26.065 -28.434  1.00 16.07           H
ATOM     29  D  AASN A   2      22.820 -22.625 -25.069  0.82 16.71           D
ATOM     30  DB2AASN A   2      23.799 -24.920 -25.450  0.65 18.82           D
ATOM     31  DB3AASN A   2      24.696 -25.161 -26.954  0.56 18.30           D
ATOM     32 DD22AASN A   2      21.811 -25.683 -28.744  0.72 16.98           D
ATOM     33  H  BASN A   2      22.820 -22.625 -25.069  0.18 16.71           H
ATOM     34  HB2BASN A   2      24.696 -25.161 -26.954  0.44 18.30           H
ATOM     35  HB3BASN A   2      23.799 -24.920 -25.450  0.35 18.82           H
ATOM     36 HD22BASN A   2      21.811 -25.683 -28.744  0.28 16.98           H
ATOM     37  N   LEU A   3      23.374 -21.865 -28.222  1.00 15.90           N
ATOM     38  CA  LEU A   3      23.342 -21.224 -29.530  1.00 15.47           C
ATOM     39  C   LEU A   3      23.637 -19.727 -29.491  1.00 18.18           C
ATOM     40  O   LEU A   3      24.174 -19.175 -30.462  1.00 20.24           O
ATOM     41  CB  LEU A   3      22.021 -21.521 -30.238  1.00 15.76           C
ATOM     42  CG  LEU A   3      21.790 -23.005 -30.533  1.00 19.30           C
ATOM     43  CD1 LEU A   3      20.460 -23.197 -31.290  1.00 20.74           C
ATOM     44  CD2 LEU A   3      22.957 -23.627 -31.336  1.00 17.02           C
ATOM     45  DA  LEU A   3      24.132 -21.653 -30.101  1.00 12.76           D
ATOM     46  DB3 LEU A   3      21.233 -21.196 -29.610  1.00 17.93           D
ATOM     47  D  ALEU A   3      22.567 -21.865 -27.663  0.91 16.63           D
ATOM     48  DB2ALEU A   3      21.964 -20.976 -31.155  0.67 16.51           D
ATOM     49  DG ALEU A   3      21.719 -23.530 -29.581  0.68 18.31           D
ATOM     50 DD11ALEU A   3      19.620 -22.925 -30.652  0.74 20.52           D
ATOM     51 DD12ALEU A   3      20.364 -24.239 -31.597  0.77 19.78           D
ATOM     52 DD13ALEU A   3      20.458 -22.568 -32.171  0.49 20.26           D
ATOM     53 DD21ALEU A   3      23.466 -22.855 -31.890  0.40 16.87           D
ATOM     54 DD22ALEU A   3      22.563 -24.357 -32.028  0.00 16.68           D
ATOM     55 DD23ALEU A   3      23.653 -24.109 -30.673  0.89 14.39           D
ATOM     56  H  BLEU A   3      22.567 -21.865 -27.663  0.09 16.63           H
ATOM     57  HB2BLEU A   3      21.964 -20.976 -31.155  0.33 14.51           H
ATOM     58  HG BLEU A   3      21.719 -23.530 -29.581  0.32 18.31           H
ATOM     59 HD11BLEU A   3      19.620 -22.925 -30.652  0.26 20.52           H
ATOM     60 HD12BLEU A   3      20.364 -24.239 -31.597  0.23 19.78           H
ATOM     61 HD13BLEU A   3      20.458 -22.568 -32.171  0.51 20.26           H
ATOM     62 HD21BLEU A   3      23.466 -22.855 -31.890  0.60 16.87           H
ATOM     63 HD22BLEU A   3      22.563 -24.357 -32.028  0.58 16.68           H
ATOM     64 HD23BLEU A   3      23.653 -24.109 -30.673  0.11 14.39           H
ATOM     65  N   SER A   4       9.243 -32.509 -36.471  1.00 38.02           N
ATOM     66  CA  SER A   4      10.063 -33.604 -36.981  1.00 39.55           C
ATOM     67  C   SER A   4      11.459 -33.153 -37.367  1.00 37.45           C
ATOM     68  O   SER A   4      11.633 -32.304 -38.239  1.00 38.82           O
ATOM     69  CB  SER A   4       9.384 -34.279 -38.180  1.00 41.66           C
ATOM     70  OG  SER A   4       8.375 -35.181 -37.753  1.00 44.91           O
ATOM     71  DA  SER A   4      10.165 -34.324 -36.187  1.00 38.72           D
ATOM     72  D  ASER A   4       8.730 -31.950 -37.103  0.62 38.48           D
ATOM     73  DB2ASER A   4      10.116 -34.818 -38.774  0.63 41.36           D
ATOM     74  DB3ASER A   4       8.918 -33.518 -38.793  0.36 41.73           D
ATOM     75  DG ASER A   4       8.699 -36.084 -37.842  0.36 43.61           D
ATOM     76  H  BSER A   4       8.730 -31.950 -37.103  0.28 38.48           H
ATOM     77  HB2BSER A   4       8.918 -33.518 -38.793  0.64 41.73           H
ATOM     78  HB3BSER A   4      10.116 -34.818 -38.774  0.37 41.36           H
ATOM     79  HG BSER A   4       8.699 -36.084 -37.842  0.64 43.61           H
ATOM     80  N   SER A   5      26.478 -19.398  45.776  1.00 19.78           N
ATOM     81  C   SER A   5      27.940 -19.562  43.818  1.00 21.99           C
ATOM     82  O   SER A   5      29.005 -19.770  43.306  1.00 21.20           O
ATOM     83  CA ASER A   5      27.849 -19.441  45.318  0.64 18.99           C
ATOM     84  CB ASER A   5      28.611 -20.590  45.987  0.64 21.66           C
ATOM     85  OG ASER A   5      28.819 -20.337  47.363  0.64 23.21           O
ATOM     86  DG ASER A   5      29.639 -20.155  47.499  0.64 22.10           D
ATOM     87  H  ASER A   5      26.064 -20.150  45.742  0.06 18.55           H
ATOM     88  HA ASER A   5      28.296 -18.610  45.561  0.64 20.89           H
ATOM     89  HB2ASER A   5      28.094 -21.408  45.903  0.00 22.17           H
ATOM     90  HB3ASER A   5      29.468 -20.686  45.544  0.64 22.38           H
ATOM     91  CA BSER A   5      27.851 -19.476  45.322  0.36 19.02           C
ATOM     92  CB BSER A   5      28.561 -20.680  45.932  0.36 21.98           C
ATOM     93  OG BSER A   5      28.005 -21.879  45.425  0.36 25.40           O
ATOM     94  D  BSER A   5      26.023 -20.128  45.688  0.94 18.55           D
ATOM     95  HA BSER A   5      28.327 -18.675  45.599  0.36 21.03           H
ATOM     96  HB2BSER A   5      29.498 -20.638  45.691  0.36 22.55           H
ATOM     97  HB3BSER A   5      28.462 -20.665  46.898  0.36 23.83           H
ATOM     98  HG BSER A   5      27.486 -22.196  46.000  0.36 22.10           H
TER
HETATM  100  O   DOD B   1      25.202 -21.329 -23.306  1.00 30.00           O
HETATM  101  D1  DOD B   1      25.963 -20.763 -23.255  1.00 30.00           D
HETATM  102  D2  DOD B   1      24.439 -20.764 -23.305  1.00 30.00           D
HETATM  103  O   HOH B   2      26.442 -21.454 -25.349  1.00 30.00           O
HETATM  104  D1  HOH B   2      27.249 -20.953 -25.339  1.00 30.00           D
HETATM  105  O   HOH B   3      24.970 -18.184 -24.460  1.00 30.00           O
HETATM  106  O   HOH B   4      21.573 -23.174 -24.023  1.00 30.00           O
HETATM  107  D2  HOH B   4      20.731 -22.736 -24.071  1.00 30.00           D
HETATM  108  D1 AHOH B   4      22.045 -22.784 -23.297  1.00 30.00           D
HETATM  109  D1 BHOH B   4      22.145 -21.784 -22.297  1.00 30.00           D
HETATM  110  D1  HOH B   5      21.772 -27.767 -28.880  1.00 30.00           D
HETATM  111  O   DOD B   6      17.493 -24.723 -25.229  1.00 20.00           O
HETATM  112  D1  DOD B   6      17.492 -25.660 -25.470  1.00 20.00           D
HETATM  113  D2  DOD B   6      18.304 -24.255 -25.470  1.00 20.00           D
HETATM  114  D3  DOD B   6      16.682 -24.254 -25.470  1.00 20.00           D
TER     115      HOH B   6
HETATM    1  PG  ATP C   1       3.232  -0.948  -8.256  1.00 20.00      A    P
HETATM    2  O1G ATP C   1       4.490  -0.168  -7.985  1.00 20.00      A    O
HETATM    3  O2G ATP C   1       2.572  -0.420  -9.500  1.00 20.00      A    O-1
HETATM    4  O3G ATP C   1       3.573  -2.392  -8.447  1.00 20.00      A    O-1
HETATM    5  PB  ATP C   1       2.368   0.364  -5.856  1.00 20.00      A    P
HETATM    6  O1B ATP C   1       3.702   0.219  -5.162  1.00 20.00      A    O
HETATM    7  O2B ATP C   1       2.287   1.719  -6.506  1.00 20.00      A    O-1
HETATM    8  O3B ATP C   1       2.218  -0.793  -6.996  1.00 20.00      A    O
HETATM    9  PA  ATP C   1       0.926   1.250  -3.494  1.00 20.00      A    P
HETATM   10  O1A ATP C   1      -0.200   2.200  -3.825  1.00 20.00      A    O
HETATM   11  O2A ATP C   1       2.197   2.037  -3.253  1.00 20.00      A    O-1
HETATM   12  O3A ATP C   1       1.155   0.210  -4.753  1.00 20.00      A    O
HETATM   13  O5' ATP C   1       0.538   0.381  -2.115  1.00 20.00      A    O
HETATM   14  C5' ATP C   1      -0.378   0.948  -1.194  1.00 20.00      A    C
HETATM   15  C4' ATP C   1      -1.094  -0.162  -0.442  1.00 20.00      A    C
HETATM   16  O4' ATP C   1      -0.263  -0.783   0.344  1.00 20.00      A    O
HETATM   17  C3' ATP C   1      -2.258   0.478   0.549  1.00 20.00      A    C
HETATM   18  O3' ATP C   1      -3.508   0.701  -0.219  1.00 20.00      A    O
HETATM   19  C2' ATP C   1      -2.450  -0.373   1.436  1.00 20.00      A    C
HETATM   20  O2' ATP C   1      -3.564  -1.296   1.031  1.00 20.00      A    O
HETATM   21  C1' ATP C   1      -1.075  -1.183   1.553  1.00 20.00      A    C
HETATM   22  N9  ATP C   1      -0.436  -0.847   2.669  1.00 20.00      A    N
HETATM   23  C8  ATP C   1       0.891  -0.729   2.488  1.00 20.00      A    C
HETATM   24  N7  ATP C   1       1.445  -0.426   3.672  1.00 20.00      A    N
HETATM   25  C5  ATP C   1       0.455  -0.356   4.593  1.00 20.00      A    C
HETATM   26  C6  ATP C   1       0.464  -0.066   5.953  1.00 20.00      A    C
HETATM   27  N6  ATP C   1       1.576   0.468   6.779  1.00 20.00      A    N
HETATM   28  N1  ATP C   1      -0.678  -0.046   6.637  1.00 20.00      A    N
HETATM   29  C2  ATP C   1      -1.855  -0.311   6.004  1.00 20.00      A    C
HETATM   30  N3  ATP C   1      -1.865  -0.595   4.675  1.00 20.00      A    N
HETATM   31  C4  ATP C   1      -0.703  -0.615   3.975  1.00 20.00      A    C
HETATM   32 H5'1 ATP C   1       0.163   1.581  -0.485  1.00 20.00      A    H
HETATM   33 H5'2 ATP C   1      -1.105   1.545  -1.731  1.00 20.00      A    H
HETATM   34  H4' ATP C   1      -1.548  -0.870  -1.145  1.00 20.00      A    H
HETATM   35  H3' ATP C   1      -1.912   1.393   0.983  1.00 20.00      A    H
HETATM   36 HO3' ATP C   1      -3.892   1.548   0.031  1.00 20.00      A    H
HETATM   37  H2' ATP C   1      -2.680   0.114   2.384  1.00 20.00      A    H
HETATM   38 HO2' ATP C   1      -4.066  -1.553   1.810  1.00 20.00      A    H
HETATM   39  H1' ATP C   1      -1.273  -2.266   1.534  1.00 20.00      A    H
HETATM   40  H8  ATP C   1       1.431  -0.922   1.560  1.00 20.00      A    H
HETATM   41 HN61 ATP C   1       2.477   0.646   6.359  1.00 20.00      A    H
HETATM   42 HN62 ATP C   1       1.445   0.610   7.769  1.00 20.00      A    H
HETATM   43  H2  ATP C   1      -2.804  -0.294   6.573  1.00 20.00      A    H
TER
END
"""

# exercise1 a) The C beta DB2 and DB3 atoms are swapped
pdb_str1a = """
CRYST1   17.955   13.272   13.095  90.00  90.00  90.00 P 1
SCALE1      0.055695  0.000000  0.000000        0.00000
SCALE2      0.000000  0.075347  0.000000        0.00000
SCALE3      0.000000  0.000000  0.076365        0.00000
ATOM      1  N   TYR A 139      10.241   7.920   5.000  1.00 10.00           N
ATOM      2  CA  TYR A 139      10.853   7.555   6.271  1.00 10.00           C
ATOM      3  C   TYR A 139      12.362   7.771   6.227  1.00 10.00           C
ATOM      4  O   TYR A 139      12.955   8.272   7.181  1.00 10.00           O
ATOM      5  CB  TYR A 139      10.540   6.098   6.617  1.00 10.00           C
ATOM      6  CG  TYR A 139       9.063   5.805   6.749  1.00 10.00           C
ATOM      7  CD1 TYR A 139       8.316   5.391   5.654  1.00 10.00           C
ATOM      8  CD2 TYR A 139       8.414   5.943   7.969  1.00 10.00           C
ATOM      9  CE1 TYR A 139       6.966   5.122   5.770  1.00 10.00           C
ATOM     10  CE2 TYR A 139       7.064   5.676   8.095  1.00 10.00           C
ATOM     11  CZ  TYR A 139       6.345   5.266   6.993  1.00 10.00           C
ATOM     12  OH  TYR A 139       5.000   5.000   7.113  1.00 10.00           O
ATOM     13  HA ATYR A 139      10.443   8.186   7.059  0.50 10.00           H
ATOM     14  HB2ATYR A 139      10.938   5.457   5.830  0.50 10.00           H
ATOM     15  HB3ATYR A 139      11.014   5.853   7.567  0.50 10.00           H
ATOM     16  HD1ATYR A 139       8.799   5.277   4.695  0.50 10.00           H
ATOM     17  HD2ATYR A 139       8.974   6.264   8.835  0.50 10.00           H
ATOM     18  HE1ATYR A 139       6.400   4.801   4.908  0.50 10.00           H
ATOM     19  HE2ATYR A 139       6.575   5.788   9.051  0.50 10.00           H
ATOM     20  HH ATYR A 139       4.710   5.148   8.037  0.50 10.00           H
ATOM     21  DA BTYR A 139      10.443   8.186   7.059  0.50 10.00           D
ATOM     22  DB3BTYR A 139      10.938   5.457   5.830  0.50 10.00           D
ATOM     23  DB2BTYR A 139      11.014   5.853   7.567  0.50 10.00           D
ATOM     24  DD1BTYR A 139       8.799   5.277   4.695  0.50 10.00           D
ATOM     25  DD2BTYR A 139       8.974   6.264   8.835  0.50 10.00           D
ATOM     26  DE1BTYR A 139       6.400   4.801   4.908  0.50 10.00           D
ATOM     27  DE2BTYR A 139       6.575   5.788   9.051  0.50 10.00           D
ATOM     28  DH BTYR A 139       4.710   5.148   8.037  0.50 10.00           D
"""

# exercise1 b) The C beta HB2 and HB3 atoms are swapped
pdb_str1b = """
CRYST1   17.955   13.272   13.095  90.00  90.00  90.00 P 1
SCALE1      0.055695  0.000000  0.000000        0.00000
SCALE2      0.000000  0.075347  0.000000        0.00000
SCALE3      0.000000  0.000000  0.076365        0.00000
ATOM      1  N   TYR A 139      10.241   7.920   5.000  1.00 10.00           N
ATOM      2  CA  TYR A 139      10.853   7.555   6.271  1.00 10.00           C
ATOM      3  C   TYR A 139      12.362   7.771   6.227  1.00 10.00           C
ATOM      4  O   TYR A 139      12.955   8.272   7.181  1.00 10.00           O
ATOM      5  CB  TYR A 139      10.540   6.098   6.617  1.00 10.00           C
ATOM      6  CG  TYR A 139       9.063   5.805   6.749  1.00 10.00           C
ATOM      7  CD1 TYR A 139       8.316   5.391   5.654  1.00 10.00           C
ATOM      8  CD2 TYR A 139       8.414   5.943   7.969  1.00 10.00           C
ATOM      9  CE1 TYR A 139       6.966   5.122   5.770  1.00 10.00           C
ATOM     10  CE2 TYR A 139       7.064   5.676   8.095  1.00 10.00           C
ATOM     11  CZ  TYR A 139       6.345   5.266   6.993  1.00 10.00           C
ATOM     12  OH  TYR A 139       5.000   5.000   7.113  1.00 10.00           O
ATOM     13  HA ATYR A 139      10.443   8.186   7.059  0.50 10.00           H
ATOM     14  HB3ATYR A 139      10.938   5.457   5.830  0.50 10.00           H
ATOM     15  HB2ATYR A 139      11.014   5.853   7.567  0.50 10.00           H
ATOM     16  HD1ATYR A 139       8.799   5.277   4.695  0.50 10.00           H
ATOM     17  HD2ATYR A 139       8.974   6.264   8.835  0.50 10.00           H
ATOM     18  HE1ATYR A 139       6.400   4.801   4.908  0.50 10.00           H
ATOM     19  HE2ATYR A 139       6.575   5.788   9.051  0.50 10.00           H
ATOM     20  HH ATYR A 139       4.710   5.148   8.037  0.50 10.00           H
ATOM     21  DA BTYR A 139      10.443   8.186   7.059  0.50 10.00           D
ATOM     22  DB2BTYR A 139      10.938   5.457   5.830  0.50 10.00           D
ATOM     23  DB3BTYR A 139      11.014   5.853   7.567  0.50 10.00           D
ATOM     24  DD1BTYR A 139       8.799   5.277   4.695  0.50 10.00           D
ATOM     25  DD2BTYR A 139       8.974   6.264   8.835  0.50 10.00           D
ATOM     26  DE1BTYR A 139       6.400   4.801   4.908  0.50 10.00           D
ATOM     27  DE2BTYR A 139       6.575   5.788   9.051  0.50 10.00           D
ATOM     28  DH BTYR A 139       4.710   5.148   8.037  0.50 10.00           D
"""

pdb_str2 = """
CRYST1   17.955   13.272   13.095  90.00  90.00  90.00 P 1
SCALE1      0.055695  0.000000  0.000000        0.00000
SCALE2      0.000000  0.075347  0.000000        0.00000
SCALE3      0.000000  0.000000  0.076365        0.00000
ATOM      1  N   TYR A 139      10.241   7.920   5.000  1.00 10.00           N
ATOM      2  CA  TYR A 139      10.853   7.555   6.271  1.00 10.00           C
ATOM      3  C   TYR A 139      12.362   7.771   6.227  1.00 10.00           C
ATOM      4  O   TYR A 139      12.955   8.272   7.181  1.00 10.00           O
ATOM      5  CB  TYR A 139      10.540   6.098   6.617  1.00 10.00           C
ATOM      6  CG  TYR A 139       9.063   5.805   6.749  1.00 10.00           C
ATOM      7  CD1 TYR A 139       8.316   5.391   5.654  1.00 10.00           C
ATOM      8  CD2 TYR A 139       8.414   5.943   7.969  1.00 10.00           C
ATOM      9  CE1 TYR A 139       6.966   5.122   5.770  1.00 10.00           C
ATOM     10  CE2 TYR A 139       7.064   5.676   8.095  1.00 10.00           C
ATOM     11  CZ  TYR A 139       6.345   5.266   6.993  1.00 10.00           C
ATOM     12  OH  TYR A 139       5.000   5.000   7.113  1.00 10.00           O
ATOM     13  HA ATYR A 139      10.443   8.186   7.059  0.50 10.00           H
ATOM     14  HB2ATYR A 139      10.938   5.457   5.830  0.50 10.00           H
ATOM     15  HB3ATYR A 139      11.014   5.853   7.567  0.50 10.00           H
ATOM     16  HD1ATYR A 139       8.799   5.277   4.695  0.50  8.00           H
ATOM     17  HD2ATYR A 139       8.974   6.264   8.835  0.50 10.00           H
ATOM     18  HE1ATYR A 139       6.400   4.801   4.908  0.50 10.00           H
ATOM     19  HE2ATYR A 139       6.575   5.788   9.051  0.50 10.00           H
ATOM     20  HH ATYR A 139       4.564   5.706   7.633  0.60 10.00           H
ATOM     21  DA BTYR A 139      10.543   8.286   7.059  0.50 10.00           D
ATOM     22  DB2BTYR A 139      10.938   5.457   5.830  0.50 10.00           D
ATOM     23  DB3BTYR A 139      11.014   5.853   7.567  0.50 10.00           D
ATOM     24  DD1BTYR A 139       8.799   5.277   4.695  0.50 10.00           D
ATOM     25  DD2BTYR A 139       8.974   6.264   8.835  0.50 10.00           D
ATOM     26  DE1BTYR A 139       6.400   4.801   4.908  0.50 10.00           D
ATOM     27  DE2BTYR A 139       6.575   5.788   9.051  0.50 10.00           D
ATOM     28  DH BTYR A 139       4.710   5.148   8.037  0.40 10.00           D
"""

pdb_str3 = """
CRYST1   17.955   13.272   13.095  90.00  90.00  90.00 P 1
SCALE1      0.055695  0.000000  0.000000        0.00000
SCALE2      0.000000  0.075347  0.000000        0.00000
SCALE3      0.000000  0.000000  0.076365        0.00000
ATOM      1  N   TYR A 139      10.241   7.920   5.000  1.00 10.00           N
ATOM      2  CA  TYR A 139      10.853   7.555   6.271  1.00 10.00           C
ATOM      3  C   TYR A 139      12.362   7.771   6.227  1.00 10.00           C
ATOM      4  O   TYR A 139      12.955   8.272   7.181  1.00 10.00           O
ATOM      5  CB  TYR A 139      10.540   6.098   6.617  1.00 10.00           C
ATOM      6  CG  TYR A 139       9.063   5.805   6.749  1.00 10.00           C
ATOM      7  CD1 TYR A 139       8.316   5.391   5.654  1.00 10.00           C
ATOM      8  CD2 TYR A 139       8.414   5.943   7.969  1.00 10.00           C
ATOM      9  CE1 TYR A 139       6.966   5.122   5.770  1.00 10.00           C
ATOM     10  CE2 TYR A 139       7.064   5.676   8.095  1.00 10.00           C
ATOM     11  CZ  TYR A 139       6.345   5.266   6.993  1.00 10.00           C
ATOM     12  OH  TYR A 139       5.000   5.000   7.113  1.00 10.00           O
ATOM     13  HA ATYR A 139      10.443   8.186   7.059  0.50 10.00           H
ATOM     14  HB2ATYR A 139      10.938   5.457   5.830  0.00 10.00           H
ATOM     15  HB3ATYR A 139      11.014   5.853   7.567  0.50 10.00           H
ATOM     16  HD1 TYR A 139       8.799   5.277   4.695  0.50 10.00           H
ATOM     17  HD2ATYR A 139       8.974   6.264   8.835  0.40 10.00           H
ATOM     18  HE1ATYR A 139       6.400   4.801   4.908  0.50 10.00           H
ATOM     19  HE2ATYR A 139       6.575   5.788   9.051  0.50 10.00           H
ATOM     20  HH ATYR A 139       4.710   5.148   8.037  0.50 10.00           H
ATOM     21  DA BTYR A 139      10.443   8.186   7.059  0.50 10.00           D
ATOM     22  DB2BTYR A 139      10.938   5.457   5.830  1.00 10.00           D
ATOM     23  DB3BTYR A 139      11.014   5.853   7.567  0.50 10.00           D
ATOM     25  DD2BTYR A 139       8.974   6.264   8.835  0.50 10.00           D
ATOM     26  DE1BTYR A 139       6.400   4.801   4.908  0.50 10.00           D
ATOM     27  DE2BTYR A 139       6.575   5.788   9.051  0.60 10.00           D
ATOM     28  DH BTYR A 139       4.710   5.148   8.037  0.50 10.00           D
"""

pdb_str4 = """
CRYST1   17.955   13.272   13.095  90.00  90.00  90.00 P 1
SCALE1      0.055695  0.000000  0.000000        0.00000
SCALE2      0.000000  0.075347  0.000000        0.00000
SCALE3      0.000000  0.000000  0.076365        0.00000
ATOM      1  N   TYR A 139      10.241   7.920   5.000  1.00 10.00           N
ATOM      2  CA  TYR A 139      10.853   7.555   6.271  1.00 10.00           C
ATOM      3  C   TYR A 139      12.362   7.771   6.227  1.00 10.00           C
ATOM      4  O   TYR A 139      12.955   8.272   7.181  1.00 10.00           O
ATOM      5  CB  TYR A 139      10.540   6.098   6.617  1.00 10.00           C
ATOM      6  CG  TYR A 139       9.063   5.805   6.749  1.00 10.00           C
ATOM      7  CD1 TYR A 139       8.316   5.391   5.654  1.00 10.00           C
ATOM      8  CD2 TYR A 139       8.414   5.943   7.969  1.00 10.00           C
ATOM      9  CE1 TYR A 139       6.966   5.122   5.770  1.00 10.00           C
ATOM     10  CE2 TYR A 139       7.064   5.676   8.095  1.00 10.00           C
ATOM     11  CZ  TYR A 139       6.345   5.266   6.993  1.00 10.00           C
ATOM     12  OH  TYR A 139       5.000   5.000   7.113  1.00 10.00           O
ATOM     13  HA  TYR A 139      10.443   8.186   7.059  1.00 10.00           H
ATOM     15  HB3 TYR A 139      11.014   5.853   7.567  1.00 10.00           H
ATOM     16  HD1 TYR A 139       8.799   5.277   4.695  1.00 10.00           H
ATOM     17  HD2 TYR A 139       8.974   6.264   8.835  1.00 10.00           H
ATOM     19  HE2 TYR A 139       6.575   5.788   9.051  1.00 10.00           H
ATOM     20  HH  TYR A 139       4.710   5.148   8.037  1.00 10.00           H
"""

pdb_str5 = """
CRYST1   17.955   13.272   13.095  90.00  90.00  90.00 P 1
SCALE1      0.055695  0.000000  0.000000        0.00000
SCALE2      0.000000  0.075347  0.000000        0.00000
SCALE3      0.000000  0.000000  0.076365        0.00000
ATOM      1  N   TYR A 139      10.241   7.920   5.000  1.00 10.00           N
ATOM      2  CA  TYR A 139      10.853   7.555   6.271  1.00 10.00           C
ATOM      3  C   TYR A 139      12.362   7.771   6.227  1.00 10.00           C
ATOM      4  O   TYR A 139      12.955   8.272   7.181  1.00 10.00           O
ATOM      5  CB  TYR A 139      10.540   6.098   6.617  1.00 10.00           C
ATOM      6  CG  TYR A 139       9.063   5.805   6.749  1.00 10.00           C
ATOM      7  CD1 TYR A 139       8.316   5.391   5.654  1.00 10.00           C
ATOM      8  CD2 TYR A 139       8.414   5.943   7.969  1.00 10.00           C
ATOM      9  CE1 TYR A 139       6.966   5.122   5.770  1.00 10.00           C
ATOM     10  CE2 TYR A 139       7.064   5.676   8.095  1.00 10.00           C
ATOM     11  CZ  TYR A 139       6.345   5.266   6.993  1.00 10.00           C
ATOM     12  OH  TYR A 139       5.000   5.000   7.113  1.00 10.00           O
ATOM     13  DA  TYR A 139      10.443   8.186   7.059  1.00 10.00           D
ATOM     15  DB3 TYR A 139      11.014   5.853   7.567  1.00 10.00           D
ATOM     16  DD1 TYR A 139       8.799   5.277   4.695  1.00 10.00           D
ATOM     17  DD2 TYR A 139       8.974   6.264   8.835  1.00 10.00           D
ATOM     19  DE2 TYR A 139       6.575   5.788   9.051  1.00 10.00           D
ATOM     20  DH  TYR A 139       4.710   5.148   8.037  1.00 10.00           D
"""

pdb_str6 = """
CRYST1   17.955   13.272   13.095  90.00  90.00  90.00 P 1
SCALE1      0.055695  0.000000  0.000000        0.00000
SCALE2      0.000000  0.075347  0.000000        0.00000
SCALE3      0.000000  0.000000  0.076365        0.00000
ATOM      1  N   TYR A 139      10.241   7.920   5.000  1.00 10.00           N
ATOM      2  CA  TYR A 139      10.853   7.555   6.271  1.00 10.00           C
ATOM      3  C   TYR A 139      12.362   7.771   6.227  1.00 10.00           C
ATOM      4  O   TYR A 139      12.955   8.272   7.181  1.00 10.00           O
ATOM      5  CB  TYR A 139      10.540   6.098   6.617  1.00 10.00           C
ATOM      7  CD1 TYR A 139       8.316   5.391   5.654  1.00 10.00           C
ATOM      8  CD2 TYR A 139       8.414   5.943   7.969  1.00 10.00           C
ATOM      9  CE1 TYR A 139       6.966   5.122   5.770  1.00 10.00           C
ATOM     10  CE2 TYR A 139       7.064   5.676   8.095  1.00 10.00           C
ATOM     11  CZ  TYR A 139       6.345   5.266   6.993  1.00 10.00           C
ATOM     12  OH  TYR A 139       5.000   5.000   7.113  1.00 10.00           O
ATOM     13  HA ATYR A 139      10.443   8.186   7.059  0.50 10.00           H
ATOM     14  HB2ATYR A 139      10.938   5.457   5.830  0.50 10.00           H
ATOM     15  HB3ATYR A 139      11.014   5.853   7.567  0.50 10.00           H
ATOM     16  HD1ATYR A 139       8.799   5.277   4.695  0.50 10.00           H
ATOM     19  HE2ATYR A 139       6.575   5.788   9.051  0.50 10.00           H
ATOM     20  HH  TYR A 139       4.710   5.148   8.037  1.00 10.00           H
ATOM     21  DA BTYR A 139      10.443   8.186   7.059  0.50 10.00           D
ATOM     22  DB2BTYR A 139      10.938   5.457   5.830  0.50 10.00           D
ATOM     24  DD1BTYR A 139       8.799   5.277   4.695  0.50 10.00           D
ATOM     26  DE1BTYR A 139       6.400   4.801   4.908  0.50 10.00           D
ATOM     27  DE2BTYR A 139       6.575   5.788   9.051  0.50 10.00           D
"""

pdb_str7 = """
CRYST1   17.955   13.272   13.095  90.00  90.00  90.00 P 1
SCALE1      0.055695  0.000000  0.000000        0.00000
SCALE2      0.000000  0.075347  0.000000        0.00000
SCALE3      0.000000  0.000000  0.076365        0.00000
ATOM      1  N   TYR A 139      10.241   7.920   5.000  1.00 10.00           N
ATOM      2  CA  TYR A 139      10.853   7.555   6.271  1.00 10.00           C
ATOM      3  C   TYR A 139      12.362   7.771   6.227  1.00 10.00           C
ATOM      4  O   TYR A 139      12.955   8.272   7.181  1.00 10.00           O
ATOM      5  CB  TYR A 139      10.540   6.098   6.617  1.00 10.00           C
ATOM      6  CG  TYR A 139       9.063   5.805   6.749  1.00 10.00           C
ATOM      8  CD1 TYR A 139       8.316   5.391   5.654  1.00 10.00           C
ATOM      7  CD2 TYR A 139       8.414   5.943   7.969  1.00 10.00           C
ATOM     10  CE1 TYR A 139       6.966   5.122   5.770  1.00 10.00           C
ATOM      9  CE2 TYR A 139       7.064   5.676   8.095  1.00 10.00           C
ATOM     11  CZ  TYR A 139       6.345   5.266   6.993  1.00 10.00           C
ATOM     12  OH  TYR A 139       5.000   5.000   7.113  1.00 10.00           O
ATOM     13  HA ATYR A 139      10.443   8.186   7.059  0.50 10.00           H
ATOM     14  HB2ATYR A 139      11.057   5.645   5.981  0.50 10.00           H
ATOM     15  HB3ATYR A 139      10.870   5.954   7.475  0.50 10.00           H
ATOM     16  HD1ATYR A 139       8.799   5.277   4.695  0.50 10.00           H
ATOM     17  HD2ATYR A 139       8.792   6.377   9.033  0.50 10.00           H
ATOM     18  HE1ATYR A 139       6.400   4.801   4.908  0.50 10.00           H
ATOM     19  HE2ATYR A 139       6.575   5.788   9.051  0.50 10.00           H
ATOM     20  HH ATYR A 139       4.837   5.050   7.863  0.50 10.00           H
"""

pdb_str8 = """
CRYST1   17.955   13.272   13.095  90.00  90.00  90.00 P 1
SCALE1      0.055695  0.000000  0.000000        0.00000
SCALE2      0.000000  0.075347  0.000000        0.00000
SCALE3      0.000000  0.000000  0.076365        0.00000
ATOM      1  N   TYR A 139      10.241   7.920   5.000  1.00 10.00           N
ATOM      2  CA  TYR A 139      10.853   7.555   6.271  1.00 10.00           C
ATOM      3  C   TYR A 139      12.362   7.771   6.227  1.00 10.00           C
ATOM      4  O   TYR A 139      12.955   8.272   7.181  1.00 10.00           O
ATOM      5  CB  TYR A 139      10.540   6.098   6.617  1.00 10.00           C
ATOM      6  CG  TYR A 139       9.063   5.805   6.749  1.00 10.00           C
ATOM      7  CD1 TYR A 139       8.316   5.391   5.654  1.00 10.00           C
ATOM      8  CD2 TYR A 139       8.414   5.943   7.969  1.00 10.00           C
ATOM      9  CE1 TYR A 139       6.966   5.122   5.770  1.00 10.00           C
ATOM     10  CE2 TYR A 139       7.064   5.676   8.095  1.00 10.00           C
ATOM     11  CZ  TYR A 139       6.345   5.266   6.993  1.00 10.00           C
ATOM     12  OH  TYR A 139       5.000   5.000   7.113  1.00 10.00           O
ATOM     21  DA  TYR A 139      10.443   8.186   7.059  1.00 10.00           D
ATOM     14  DB2 TYR A 139      10.783   5.595   5.785  1.00 10.00           D
ATOM     15  DB3 TYR A 139      11.112   5.843   7.715  1.00 10.00           D
ATOM     16  DD1 TYR A 139       8.781   5.167   4.530  1.00 10.00           D
ATOM     25  DD2 TYR A 139       8.974   6.264   8.835  1.00 10.00           D
ATOM     26  DE1 TYR A 139       6.400   4.801   4.908  1.00 10.00           D
ATOM     19  DE2 TYR A 139       6.754   5.829   8.900  1.00 10.00           D
ATOM     28  DH  TYR A 139       4.710   5.148   8.037  1.00 10.00           D
"""

pdb_str9 = """
CRYST1   17.955   13.272   13.095  90.00  90.00  90.00 P 1
SCALE1      0.055695  0.000000  0.000000        0.00000
SCALE2      0.000000  0.075347  0.000000        0.00000
SCALE3      0.000000  0.000000  0.076365        0.00000
ATOM      1  N   TYR A 139      10.241   7.920   5.000  1.00 10.00           N
ATOM      2  CA  TYR A 139      10.853   7.555   6.271  1.00 10.00           C
ATOM      3  C   TYR A 139      12.362   7.771   6.227  1.00 10.00           C
ATOM      4  O   TYR A 139      12.955   8.272   7.181  1.00 10.00           O
ATOM      5  CB  TYR A 139      10.540   6.098   6.617  1.00 10.00           C
ATOM      6  CG  TYR A 139       9.063   5.805   6.749  1.00 10.00           C
ATOM      7  CD1 TYR A 139       8.316   5.391   5.654  1.00 10.00           C
ATOM      8  CD2 TYR A 139       8.414   5.943   7.969  1.00 10.00           C
ATOM      9  CE1 TYR A 139       6.966   5.122   5.770  1.00 10.00           C
ATOM     10  CE2 TYR A 139       7.064   5.676   8.095  1.00 10.00           C
ATOM     11  CZ  TYR A 139       6.345   5.266   6.993  1.00 10.00           C
ATOM     12  OH  TYR A 139       5.000   5.000   7.113  1.00 10.00           O
ATOM     13  HA ATYR A 139      10.443   8.186   7.059  0.50 10.00           H
ATOM     14  HB2ATYR A 139      10.968   5.639   5.981  0.50 10.00           H
ATOM     15  HB3ATYR A 139      11.014   5.853   7.567  0.50 10.00           H
ATOM     16  HD1ATYR A 139       8.799   5.277   4.695  0.50 10.00           H
ATOM     17  HD2ATYR A 139       8.974   6.264   8.835  0.50 10.00           H
ATOM     18  HE1ATYR A 139       6.400   4.801   4.908  0.50 10.00           H
ATOM     19  HE2ATYR A 139       6.648   5.677   8.989  0.50 10.00           H
ATOM     20  HH ATYR A 139       4.710   5.148   8.037  0.50 10.00           H
ATOM     21  DA BTYR A 139      10.443   8.186   7.059  0.50 10.00           D
ATOM     22  DB2BTYR A 139      10.938   5.457   5.830  0.50 10.00           D
ATOM     23  DB3BTYR A 139      11.014   5.853   7.567  0.50 10.00           D
ATOM     24  DD1BTYR A 139       8.832   5.349   4.523  0.50 10.00           D
ATOM     25  DD2BTYR A 139       8.974   6.264   8.835  0.50 10.00           D
ATOM     26  DE1BTYR A 139       6.400   4.801   4.908  0.50 10.00           D
ATOM     27  DE2BTYR A 139       6.575   5.788   9.051  0.50 10.00           D
ATOM     28  DH BTYR A 139       4.823   5.165   8.210  0.50 10.00           D
"""

pdb_str10 = """
CRYST1   17.955   13.272   13.095  90.00  90.00  90.00 P 1
SCALE1      0.055695  0.000000  0.000000        0.00000
SCALE2      0.000000  0.075347  0.000000        0.00000
SCALE3      0.000000  0.000000  0.076365        0.00000
ATOM      1  N   TYR A 139      10.241   7.920   5.000  1.00 10.00           N
ATOM      2  CA  TYR A 139      10.853   7.555   6.271  1.00 10.00           C
ATOM      3  C   TYR A 139      12.362   7.771   6.227  1.00 10.00           C
ATOM      4  O   TYR A 139      12.955   8.272   7.181  1.00 10.00           O
ATOM      5  CB  TYR A 139      10.540   6.098   6.617  1.00 10.00           C
ATOM      6  CG  TYR A 139       9.063   5.805   6.749  1.00 10.00           C
ATOM      7  CD1 TYR A 139       8.316   5.391   5.654  1.00 10.00           C
ATOM      8  CD2 TYR A 139       8.414   5.943   7.969  1.00 10.00           C
ATOM      9  CE1 TYR A 139       6.966   5.122   5.770  1.00 10.00           C
ATOM     10  CE2 TYR A 139       7.064   5.676   8.095  1.00 10.00           C
ATOM     11  CZ  TYR A 139       6.345   5.266   6.993  1.00 10.00           C
ATOM     12  OH  TYR A 139       5.000   5.000   7.113  1.00 10.00           O
ATOM     13  HA ATYR A 139      10.583   7.992   7.177  0.50 10.00           H
ATOM     14  HB2ATYR A 139      10.938   5.457   5.830  0.50 10.00           H
ATOM     15  HB3ATYR A 139      11.014   5.853   7.567  0.50 10.00           H
ATOM     16  HD1ATYR A 139       8.799   5.277   4.695  0.50 10.00           H
ATOM     17  HD2ATYR A 139       8.974   6.264   8.835  0.50 10.00           H
ATOM     18  HE1ATYR A 139       6.400   4.801   4.908  0.50 10.00           H
ATOM     19  HE2ATYR A 139       6.575   5.788   9.051  0.50 10.00           H
ATOM     20  HH ATYR A 139       4.710   5.148   8.037  0.50 10.00           H
ATOM     21  DA BTYR A 139      10.557   8.334   6.899  0.50 10.00           D
ATOM     22  DB2BTYR A 139      10.938   5.457   5.830  0.50 10.00           D
ATOM     23  DB3BTYR A 139      11.014   5.853   7.567  0.50 10.00           D
ATOM     24  DD1BTYR A 139       8.799   5.277   4.695  0.50 10.00           D
ATOM     25  DD2BTYR A 139       8.974   6.264   8.835  0.50 10.00           D
ATOM     26  DE1BTYR A 139       6.400   4.801   4.908  0.50 10.00           D
ATOM     27  DE2BTYR A 139       6.575   5.788   9.051  0.50 10.00           D
ATOM     28  DH BTYR A 139       4.710   5.148   8.037  0.50 10.00           D
"""

pdb_str11 = """
CRYST1   17.955   13.272   13.095  90.00  90.00  90.00 P 1
SCALE1      0.055695  0.000000  0.000000        0.00000
SCALE2      0.000000  0.075347  0.000000        0.00000
SCALE3      0.000000  0.000000  0.076365        0.00000
ATOM      1  N   TYR A 139      11.036   5.830   4.803  1.00 10.00           N
ATOM      2  CA  TYR A 139      11.024   6.967   5.716  1.00 10.00           C
ATOM      3  C   TYR A 139      12.431   7.528   5.890  1.00 10.00           C
ATOM      4  O   TYR A 139      12.649   8.448   6.679  1.00 10.00           O
ATOM      5  CB  TYR A 139      10.449   6.559   7.076  1.00 10.00           C
ATOM      6  CG  TYR A 139       8.999   6.118   7.041  1.00 10.00           C
ATOM      7  CD1 TYR A 139       8.187   6.397   5.948  1.00 10.00           C
ATOM      8  CD2 TYR A 139       8.444   5.421   8.106  1.00 10.00           C
ATOM      9  CE1 TYR A 139       6.865   5.994   5.918  1.00 10.00           C
ATOM     10  CE2 TYR A 139       7.123   5.014   8.084  1.00 10.00           C
ATOM     11  CZ  TYR A 139       6.339   5.303   6.988  1.00 10.00           C
ATOM     12  OH  TYR A 139       5.023   4.900   6.962  1.00 10.00           O
ATOM     13  HA ATYR A 139      10.470   7.671   5.345  0.50 10.00           H
ATOM     14  HB2ATYR A 139      10.973   5.821   7.425  0.50 10.00           H
ATOM     15  HB3ATYR A 139      10.511   7.317   7.679  0.50 10.00           H
ATOM     16  HD1ATYR A 139       8.536   6.863   5.223  0.50 10.00           H
ATOM     17  HD2ATYR A 139       8.970   5.224   8.847  0.50 10.00           H
ATOM     18  HE1ATYR A 139       6.334   6.188   5.179  0.50 10.00           H
ATOM     19  HE2ATYR A 139       6.765   4.548   8.805  0.50 10.00           H
ATOM     20  HH ATYR A 139       4.834   4.492   7.672  0.50 10.00           H
"""

pdb_str12a = """
CRYST1   19.968   16.881   14.617  90.00  90.00  90.00 P 1
SCALE1      0.050080  0.000000  0.000000        0.00000
SCALE2      0.000000  0.059238  0.000000        0.00000
SCALE3      0.000000  0.000000  0.068413        0.00000
ATOM     62  P     A A   3      24.641  -3.951  -5.491  1.00 29.43           P
ANISOU   62  P     A A   3     4128   3373   3681   -371    815   -398       P
ATOM     63  OP1   A A   3      25.708  -4.265  -6.475  1.00 31.32           O
ANISOU   63  OP1   A A   3     4348   3730   3823   -437   1123   -264       O
ATOM     64  OP2   A A   3      23.848  -2.702  -5.549  1.00 33.50           O
ANISOU   64  OP2   A A   3     5180   3675   3874    -38    594   -122       O
ATOM     65  O5'   A A   3      23.568  -5.100  -5.644  1.00 27.30           O
ANISOU   65  O5'   A A   3     3750   3254   3367   -244    624   -238       O
ATOM     66  C5'   A A   3      24.008  -6.432  -5.684  1.00 26.59           C
ANISOU   66  C5'   A A   3     3613   3318   3174   -268    449    -24       C
ATOM     67  C4'   A A   3      22.856  -7.369  -5.558  1.00 24.31           C
ANISOU   67  C4'   A A   3     2940   3360   2938   -132    191    158       C
ATOM     68  O4'   A A   3      22.216  -7.202  -4.268  1.00 23.51           O
ANISOU   68  O4'   A A   3     2669   3549   2716    229    -49    181       O
ATOM     69  C3'   A A   3      21.713  -7.204  -6.543  1.00 22.64           C
ANISOU   69  C3'   A A   3     2570   3095   2939     23    108     75       C
ATOM     70  O3'   A A   3      22.036  -7.703  -7.822  1.00 21.70           O
ANISOU   70  O3'   A A   3     2381   2989   2875    340    -63   -119       O
ATOM     71  C2'   A A   3      20.618  -7.974  -5.834  1.00 22.54           C
ANISOU   71  C2'   A A   3     2683   2965   2917    254    -84    254       C
ATOM     72  O2'   A A   3      20.877  -9.368  -5.907  1.00 24.68           O
ANISOU   72  O2'   A A   3     3062   3194   3120    501    -66    167       O
ATOM     73  C1'   A A   3      20.844  -7.504  -4.393  1.00 22.32           C
ANISOU   73  C1'   A A   3     2600   3126   2756    137    -50    130       C
ATOM     74  N9    A A   3      20.071  -6.281  -4.150  1.00 22.38           N
ANISOU   74  N9    A A   3     2766   3075   2660     40     47   -196       N
ATOM     75  C8    A A   3      20.479  -4.970  -4.244  1.00 21.65           C
ANISOU   75  C8    A A   3     2769   2846   2611     60     91   -156       C
ATOM     76  N7    A A   3      19.514  -4.113  -4.001  1.00 22.55           N
ANISOU   76  N7    A A   3     2915   3122   2532    126    220   -226       N
ATOM     77  C5    A A   3      18.408  -4.919  -3.782  1.00 22.50           C
ANISOU   77  C5    A A   3     2913   3131   2505     96    130   -148       C
ATOM     78  C6    A A   3      17.070  -4.648  -3.477  1.00 22.18           C
ANISOU   78  C6    A A   3     3024   3082   2321    -26    -12   -123       C
ATOM     79  N6    A A   3      16.576  -3.426  -3.369  1.00 22.36           N
ANISOU   79  N6    A A   3     3152   3016   2329    -60   -158   -237       N
ATOM     80  N1    A A   3      16.209  -5.667  -3.317  1.00 23.05           N
ANISOU   80  N1    A A   3     3000   3481   2278     36    174    -84       N
ATOM     81  C2    A A   3      16.692  -6.903  -3.440  1.00 23.27           C
ANISOU   81  C2    A A   3     2794   3522   2524    122    366     11       C
ATOM     82  N3    A A   3      17.931  -7.310  -3.719  1.00 23.07           N
ANISOU   82  N3    A A   3     2685   3428   2651   -328    327    261       N
ATOM     83  C4    A A   3      18.742  -6.255  -3.880  1.00 22.38           C
ANISOU   83  C4    A A   3     2707   3187   2607   -200    133     38       C
ATOM     84  H5'   A A   3      24.629  -6.587  -4.955  1.00 31.92           H
ATOM     85 H5''   A A   3      24.462  -6.594  -6.526  1.00 31.92           H
ATOM     86  H4'   A A   3      23.200  -8.273  -5.635  1.00 29.18           H
ATOM     87  H3'   A A   3      21.456  -6.273  -6.629  1.00 27.18           H
ATOM     88  H2'   A A   3      19.729  -7.755  -6.155  1.00 27.05           H
ATOM     89 HO2'   A A   3      21.392  -9.583  -5.278  1.00 29.62           H
ATOM     90  H1'   A A   3      20.611  -8.194  -3.752  1.00 26.79           H
ATOM     91  H8    A A   3      21.348  -4.717  -4.457  1.00 25.99           H
ATOM     92  H61   A A   3      15.740  -3.313  -3.205  1.00 26.84           H
ATOM     93  H62   A A   3      17.091  -2.744  -3.464  1.00 26.84           H
ATOM     94  H2    A A   3      16.073  -7.585  -3.310  1.00 27.93           H
"""

pdb_str12b = """
CRYST1   19.968   16.881   14.617  90.00  90.00  90.00 P 1
SCALE1      0.050080  0.000000  0.000000        0.00000
SCALE2      0.000000  0.059238  0.000000        0.00000
SCALE3      0.000000  0.000000  0.068413        0.00000
ATOM     62  P     A A   3      24.641  -3.951  -5.491  1.00 29.43           P
ANISOU   62  P     A A   3     4128   3373   3681   -371    815   -398       P
ATOM     63  OP1   A A   3      25.708  -4.265  -6.475  1.00 31.32           O
ANISOU   63  OP1   A A   3     4348   3730   3823   -437   1123   -264       O
ATOM     64  OP2   A A   3      23.848  -2.702  -5.549  1.00 33.50           O
ANISOU   64  OP2   A A   3     5180   3675   3874    -38    594   -122       O
ATOM     65  O5'   A A   3      23.568  -5.100  -5.644  1.00 27.30           O
ANISOU   65  O5'   A A   3     3750   3254   3367   -244    624   -238       O
ATOM     66  C5'   A A   3      24.008  -6.432  -5.684  1.00 26.59           C
ANISOU   66  C5'   A A   3     3613   3318   3174   -268    449    -24       C
ATOM     67  C4'   A A   3      22.856  -7.369  -5.558  1.00 24.31           C
ANISOU   67  C4'   A A   3     2940   3360   2938   -132    191    158       C
ATOM     68  O4'   A A   3      22.216  -7.202  -4.268  1.00 23.51           O
ANISOU   68  O4'   A A   3     2669   3549   2716    229    -49    181       O
ATOM     69  C3'   A A   3      21.713  -7.204  -6.543  1.00 22.64           C
ANISOU   69  C3'   A A   3     2570   3095   2939     23    108     75       C
ATOM     70  O3'   A A   3      22.036  -7.703  -7.822  1.00 21.70           O
ANISOU   70  O3'   A A   3     2381   2989   2875    340    -63   -119       O
ATOM     71  C2'   A A   3      20.618  -7.974  -5.834  1.00 22.54           C
ANISOU   71  C2'   A A   3     2683   2965   2917    254    -84    254       C
ATOM     72  O2'   A A   3      20.877  -9.368  -5.907  1.00 24.68           O
ANISOU   72  O2'   A A   3     3062   3194   3120    501    -66    167       O
ATOM     73  C1'   A A   3      20.844  -7.504  -4.393  1.00 22.32           C
ANISOU   73  C1'   A A   3     2600   3126   2756    137    -50    130       C
ATOM     74  N9    A A   3      20.071  -6.281  -4.150  1.00 22.38           N
ANISOU   74  N9    A A   3     2766   3075   2660     40     47   -196       N
ATOM     75  C8    A A   3      20.479  -4.970  -4.244  1.00 21.65           C
ANISOU   75  C8    A A   3     2769   2846   2611     60     91   -156       C
ATOM     76  N7    A A   3      19.514  -4.113  -4.001  1.00 22.55           N
ANISOU   76  N7    A A   3     2915   3122   2532    126    220   -226       N
ATOM     77  C5    A A   3      18.408  -4.919  -3.782  1.00 22.50           C
ANISOU   77  C5    A A   3     2913   3131   2505     96    130   -148       C
ATOM     78  C6    A A   3      17.070  -4.648  -3.477  1.00 22.18           C
ANISOU   78  C6    A A   3     3024   3082   2321    -26    -12   -123       C
ATOM     79  N6    A A   3      16.576  -3.426  -3.369  1.00 22.36           N
ANISOU   79  N6    A A   3     3152   3016   2329    -60   -158   -237       N
ATOM     80  N1    A A   3      16.209  -5.667  -3.317  1.00 23.05           N
ANISOU   80  N1    A A   3     3000   3481   2278     36    174    -84       N
ATOM     81  C2    A A   3      16.692  -6.903  -3.440  1.00 23.27           C
ANISOU   81  C2    A A   3     2794   3522   2524    122    366     11       C
ATOM     82  N3    A A   3      17.931  -7.310  -3.719  1.00 23.07           N
ANISOU   82  N3    A A   3     2685   3428   2651   -328    327    261       N
ATOM     83  C4    A A   3      18.742  -6.255  -3.880  1.00 22.38           C
ANISOU   83  C4    A A   3     2707   3187   2607   -200    133     38       C
ATOM     86  H4'   A A   3      23.200  -8.273  -5.635  1.00 29.18           H
ATOM     87  H3'   A A   3      21.456  -6.273  -6.629  1.00 27.18           H
ATOM     88  H2'   A A   3      19.729  -7.755  -6.155  1.00 27.05           H
ATOM     89 HO2'   A A   3      21.392  -9.583  -5.278  1.00 29.62           H
ATOM     90  H1'   A A   3      20.611  -8.194  -3.752  1.00 26.79           H
ATOM     91  H8    A A   3      21.348  -4.717  -4.457  1.00 25.99           H
ATOM     92  H61   A A   3      15.740  -3.313  -3.205  1.00 26.84           H
ATOM     93  H62   A A   3      17.091  -2.744  -3.464  1.00 26.84           H
ATOM     94  H2    A A   3      16.073  -7.585  -3.310  1.00 27.93           H
"""

def get_results_from_validate_H(neutron_distances, pdb_str):
  pdb_interpretation_phil = iotbx.phil.parse(
    input_string = grand_master_phil_str, process_includes = True)
  pi_params = pdb_interpretation_phil.extract()
  pi_params.pdb_interpretation.use_neutron_distances = neutron_distances
  pi_params.pdb_interpretation.flip_symmetric_amino_acids=False

  pdb_inp = iotbx.pdb.input(lines=pdb_str.split("\n"), source_info=None)
  model = mmtbx.model.manager(
    model_input = pdb_inp,
    stop_for_unknowns = False,
    log = null_out())
  model.process(pdb_interpretation_params=pi_params,
    make_restraints=True)

  c = validate_H(model = model,
                 use_neutron_distances = neutron_distances)
  r = c.validate_inputs()
  c.run()
  results = c.get_results()
  return results

def test_output(results):
  out = validate_H_results(results)
  log = open(os.devnull, 'w')
  out.print_results(prefix='  ', log=log)
  log.close()

  # export data for wxGUI
  out.export_renamed_for_wxGUI()
  out.export_occupancies_0_for_wxGUI()
  out.export_occupancies_lt_1_for_wxGUI()
  out.export_missing_HD_atoms_for_wxGUI()
  out.export_outliers_bonds_for_wxGUI()
  out.export_outliers_angles_for_wxGUI()
  out.export_sites_different_xyz_for_wxGUI()
  out.export_sites_different_b_for_wxGUI()
  out.export_sites_sum_occ_for_wxGUI()
  out.export_sites_occ_scattering_for_wxGUI()

def exercise():
  results = get_results_from_validate_H(
    neutron_distances = True,
    pdb_str = pdb_str)

  oc = results.overall_counts_hd
  hd_atoms_with_occ_0 = oc.hd_atoms_with_occ_0

  assert (oc.count_h == 42)
  assert (oc.count_d == 39)
  assert (oc.count_h_protein == 30)
  assert (oc.count_d_protein == 29)
  assert (oc.count_h_water == 0)
  assert (oc.count_d_water == 10)
  assert (oc.count_water == 5 + 1)
  assert (oc.count_water_0h == 1)
  assert (oc.count_water_1h == 1)
  assert (oc.count_water_2h == 1)
  assert (oc.count_water_altconf == 1)
  assert (oc.count_water_no_oxygen == 1)
  assert (oc.count_h_other == 12)
  assert (oc.count_d_other == 0)

  answer = ['DD22ALEU A   3 ', ' HB2ASER A   5 ']
  for item, answer in zip(hd_atoms_with_occ_0, answer):
    assert(item[0][5:-1] == answer)

  renamed_answer = [('DB2', 'DB3'), ('DB3', 'DB2'),('DB2', 'DB3'),
    ('DB3', 'DB2'),('DB2', 'DB3'), ('DB3', 'DB2')]
  renamed = results.renamed
  for entry, answer in zip(renamed, renamed_answer):
    oldname = entry[2].strip()
    newname = entry[1].strip()
    assert(oldname == answer[0])
    assert(newname == answer[1])
    assert (entry[3] is not None)

  assert (results.count_exchanged_sites == 22)

  hd_sites_analysis  = results.hd_sites_analysis
  sites_different_xyz = hd_sites_analysis.sites_different_xyz
  xyz_answer = [0.0712]
  for item, answer in zip(sites_different_xyz, xyz_answer):
    assert approx_equal(item[2],answer, 1.e-2)

  sites_different_b   = hd_sites_analysis.sites_different_b
  b_answer = [-2]
  for item, answer in zip(sites_different_b, b_answer):
    assert approx_equal(item[2],answer, 1.e-1)

  sites_sum_occ_not_1 = hd_sites_analysis.sites_sum_occ_not_1
  sum_occ_answer=[0.58, 0.9]
  for item, answer in zip(sites_sum_occ_not_1, sum_occ_answer):
    assert approx_equal(item[2], answer, 1.e-2)

  sites_occ_sum_no_scattering = hd_sites_analysis.sites_occ_sum_no_scattering
  sum_scatt_answer=[0.4, 0.36]
  for item, answer in zip(sites_occ_sum_no_scattering, sum_scatt_answer):
    assert approx_equal(item[3], answer, 1.e-2)

  missing_HD_atoms   = results.missing_HD_atoms

  test_output(results)

  # XXX TODO

# ------------------------------------------------------------------------------
# Input has H and D everywhere (all exchanged)
# a) The C beta DB2 and DB3 atoms are swapped
# b) The C beta HB2 and HB3 atoms are swapped
# ------------------------------------------------------------------------------
def exercise1():
  renamed_answer = [('DB2', 'DB3')]

  # DB2 and DB3 swapped
  results1 = get_results_from_validate_H(
    neutron_distances = True,
    pdb_str = pdb_str1a)

  for entry, answer in zip(results1.renamed, renamed_answer):
    oldname = entry[2].strip()
    newname = entry[1].strip()
    assert(oldname == answer[0])
    assert(newname == answer[1])
    assert (entry[3] is not None)

  # HB2 and HB3 swapped --> D atoms are renamed
  results2 = get_results_from_validate_H(
    neutron_distances = True,
    pdb_str = pdb_str1b)

  for entry, answer in zip(results1.renamed, renamed_answer):
    oldname = entry[2].strip()
    newname = entry[1].strip()
    assert(oldname == answer[0])
    assert(newname == answer[1])
    assert (entry[3] is not None)

  test_output(results1)
  test_output(results2)

# ------------------------------------------------------------------------------
# PROPERTIES H/D SITES
# a) HA and DA have different coordinates
# b) HD1 and DD1 have different B factors
# c) HH and DH have different coordinates and are within cutoff distance to
#    create a warning for zero scattering sum
# ------------------------------------------------------------------------------
def exercise2():
  results = get_results_from_validate_H(
    neutron_distances = True,
    pdb_str = pdb_str2)
  hd_sites_analysis  = results.hd_sites_analysis

  assert (results.count_exchanged_sites == 8)

  sites_different_xyz = hd_sites_analysis.sites_different_xyz
  xyz_answer = [
    ('pdb=" HA ATYR A 139 "', 'pdb=" DA BTYR A 139 "', 0.141),
    ('pdb=" HH ATYR A 139 "', 'pdb=" DH BTYR A 139 "', 0.704)]
  for item, answer in zip(sites_different_xyz, xyz_answer):
    assert approx_equal(item[2],answer[2], 1.e-2)
    assert (item[3] is not None and item[4] is not None) # make sure xyz exist
    assert (item[0].strip() == answer[0].strip())
    assert (item[1].strip() == answer[1].strip())

  sites_different_b   = hd_sites_analysis.sites_different_b
  b_answer = [('pdb=" HD1ATYR A 139 "', 'pdb=" DD1BTYR A 139 "', -2)]
  for item, answer in zip(sites_different_b, b_answer):
    assert approx_equal(item[2],answer[2], 1.e-1)
    assert (item[3] is not None and item[4] is not None) # make sure xyz exist
    assert (item[0].strip() == answer[0].strip())
    assert (item[1].strip() == answer[1].strip())

  sites_occ_sum_no_scattering = hd_sites_analysis.sites_occ_sum_no_scattering
  sum_scatt_answer=[('pdb=" HH ATYR A 139 "', 'pdb=" DH BTYR A 139 "', 0.6, 0.4)]
  for item, answer in zip(sites_occ_sum_no_scattering, sum_scatt_answer):
    assert approx_equal(item[3], answer[3], 1.e-2)
    assert (item[3] is not None and item[4] is not None) # make sure xyz exist
    assert (item[0].strip() == answer[0].strip())
    assert (item[1].strip() == answer[1].strip())

  test_output(results)

# ------------------------------------------------------------------------------
# OCCUPANCIES
# a) HD2 and DD2 have sum occupancy < 1
# b) HE2 and DD2 have sum occupancy > 1
# c) HB2 has 0 occupancy (while having exchanged partner DB2)
# d) HD1 has occupancy < 1 (no exchanged partner)
# ------------------------------------------------------------------------------
def exercise3():
  results = get_results_from_validate_H(
    neutron_distances = True,
    pdb_str = pdb_str3)
  hd_sites_analysis  = results.hd_sites_analysis

  sites_sum_occ_not_1 = hd_sites_analysis.sites_sum_occ_not_1

  sum_occ_answer=[
    ('pdb=" HD2ATYR A 139 "', 'pdb=" DD2BTYR A 139 "', 0.9),
    ('pdb=" HE2ATYR A 139 "', 'pdb=" DE2BTYR A 139 "', 1.1)]
  for item, answer in zip(sites_sum_occ_not_1, sum_occ_answer):
    assert approx_equal(item[2], answer[2], 1.e-2)
    assert (item[3] is not None and item[4] is not None) # make sure xyz exist
    assert (item[0].strip() == answer[0].strip())
    assert (item[1].strip() == answer[1].strip())

  oc = results.overall_counts_hd
  hd_atoms_with_occ_0 = oc.hd_atoms_with_occ_0
  single_hd_atoms_occ_lt_1 = oc.single_hd_atoms_occ_lt_1

  occ_0_answer = ['pdb=" HB2ATYR A 139 "']
  for item, answer in zip(hd_atoms_with_occ_0, occ_0_answer):
    assert (item[0].strip() == answer.strip())
    assert (item[1] is not None) # make sure xyz exist

  occ_lt_1_answer = [('pdb=" HD1 TYR A 139 "', 0.5)]
  for item, answer in zip(single_hd_atoms_occ_lt_1, occ_lt_1_answer):
    assert (item[0].strip() == answer[0].strip())
    assert (item[1] == answer[1])
    assert (item[2] is not None) # make sure xyz exist

  test_output(results)

# ------------------------------------------------------------------------------
# MISSING ATOMS
# Model has only H atoms
# H, HE1 and HB2 are missing
# (takes into account naming ambiguity HB1+HB2 and HB2+HB3)
# ------------------------------------------------------------------------------
def exercise4():
  results = get_results_from_validate_H(
    neutron_distances = True,
    pdb_str = pdb_str4)
  missing = results.missing_HD_atoms

  missing_answer = [('pdbres="TYR A 139 "', ['HE1', 'H', 'HB2'])]
  for item, answer in zip(missing, missing_answer):
    assert (item[0].strip() == answer[0].strip())
    assert (item[2] is not None) # make sure xyz exist
    for atom, aatom in zip(sorted(item[1]), sorted(answer[1])):
      assert (atom.strip() == aatom.strip())

  test_output(results)

# ------------------------------------------------------------------------------
# MISSING ATOMS
# Model has only D atoms
# H, HE1 and HB2 are missing --> result uses H naming convention!
# (takes into account naming ambiguity HB1+HB2 and HB2+HB3)
# ------------------------------------------------------------------------------
def exercise5():
  results = get_results_from_validate_H(
    neutron_distances = True,
    pdb_str = pdb_str5)
  missing = results.missing_HD_atoms

  missing_answer = [('pdbres="TYR A 139 "', ['HE1', 'H', 'HB2'])]
  for item, answer in zip(missing, missing_answer):
    assert (item[0].strip() == answer[0].strip())
    assert (item[2] is not None) # make sure xyz exist
    for atom, aatom in zip(sorted(item[1]), sorted(answer[1])):
      assert (atom.strip() == aatom.strip())

  test_output(results)

# ------------------------------------------------------------------------------
# MISSING ATOMS
# Model has exchanged sites
# H --> missing
# HD2 --> missing
# CG --> missing, should not be in results because it is non-H atom
# HE1 --> is present as DE1 in conf B but missing HE1 in conf A
# HB3 --> is present as HB3 in conf A but missing DB3 in conf B
# ------------------------------------------------------------------------------
def exercise6():
  results = get_results_from_validate_H(
    neutron_distances = True,
    pdb_str = pdb_str6)
  missing = results.missing_HD_atoms

  #missing_answer = [('pdbres="TYR A 139 "', ['HE1', 'H', 'HD2', 'HB3'])]
  # XXX HB3 was never compared because missing only had 3 items. Removed it
  #  for compatibility with python 3.8
  missing_answer = [('pdbres="TYR A 139 "', ['HE1', 'H', 'HD2'])]
  for item, answer in zip(missing, missing_answer):
    assert (item[0].strip() == answer[0].strip())
    assert (item[2] is not None) # make sure xyz exist
    for atom, aatom in zip(sorted(item[1]), sorted(answer[1])):
      assert (atom.strip() == aatom.strip())
      assert (atom.strip() != 'CG')

  test_output(results)

# ------------------------------------------------------------------------------
# BOND OUTLIERS
# Model has only H atoms and only following outliers
# Bond OH--HH,   observed: 0.769, delta from target:  0.210
# Bond CB--HB3,  observed: 0.930, delta from target:  0.159
# Bond CB--HB2,  observed: 0.936, delta from target:  0.153
# Bond CD2--HD2, observed: 1.209, delta from target: -0.129
# ------------------------------------------------------------------------------
def exercise7():
  print('exercise7')
  results = get_results_from_validate_H(
    neutron_distances = True,
    pdb_str = pdb_str7)
  outliers_bonds = results.outliers_bonds

  outliers_bond_answer = [
    [' A 139 ATYR  HD2', 1.209, 1.08 ],
    [' A 139 ATYR  HB2', 0.936, 1.09 ],
    [' A 139 ATYR  HB3', 0.930, 1.09 ],
    [' A 139 ATYR  HH ', 0.769, 0.98 ]
     ]

  for item, answer in zip(outliers_bonds, outliers_bond_answer):
    #print(item)
    #print(answer)
    assert (item[0].strip() == answer[0].strip()) # pdb_str
    assert (item[5] is not None)                  # make sure xyz exist
    assert approx_equal(item[2],answer[1], 1.e-2) # bond length model
    assert approx_equal(item[4],answer[2], 1.e-1) # target

  test_output(results)

# ------------------------------------------------------------------------------
# BOND OUTLIERS
# Model has only D atoms and only following outliers
# Bond CE2--DE2, observed: 0.876, delta from target:  0.203
# Bond CB--DB3,  observed: 1.264, delta from target: -0.174
# Bond CD1--DD1, observed: 1.236, delta from target: -0.156
# Bond CB--DB2,  observed: 1.002, delta from target:  0.087
# ------------------------------------------------------------------------------
def exercise8():
  results = get_results_from_validate_H(
    neutron_distances = True,
    pdb_str = pdb_str8)
  outliers_bonds = results.outliers_bonds

  outliers_bond_answer = [
    [' A 139  TYR  DB2', 1.002, 1.09],
    [' A 139  TYR  DD1', 1.236, 1.08],
    [' A 139  TYR  DB3', 1.264, 1.09],
    [' A 139  TYR  DE2', 0.876, 1.08]
     ]

  for item, answer in zip(outliers_bonds, outliers_bond_answer):
    assert (item[0].strip() == answer[0].strip()) # pdb_str
    assert (item[5] is not None)                  # make sure xyz exist
    assert approx_equal(item[2],answer[1], 1.e-2) # bond length model
    assert approx_equal(item[4],answer[2], 1.e-1) # target

  test_output(results)

# ------------------------------------------------------------------------------
# BOND OUTLIERS
# Model has H and D atoms, and only the following outliers
# Bond CE2--DE2, observed: 0.876, delta from target:  0.203
# Bond CB--DB3,  observed: 1.264, delta from target: -0.174
# Bond CD1--DD1, observed: 1.236, delta from target: -0.156
# Bond CB--DB2,  observed: 1.002, delta from target:  0.087
# ------------------------------------------------------------------------------
def exercise9():
  results = get_results_from_validate_H(
    neutron_distances = True,
    pdb_str = pdb_str9)
  outliers_bonds = results.outliers_bonds

  outliers_bond_answer = [
    [' A 139 ATYR  HE2',  0.986, 1.08],
    [' A 139 BTYR  DH ',  1.123, 0.98],
    [' A 139 BTYR  DD1',  1.243, 1.08],
    [' A 139 ATYR  HB2',  0.893, 1.09],
     ]

  for item, answer in zip(outliers_bonds, outliers_bond_answer):
    assert (item[0].strip() == answer[0].strip()) # pdb_str
    assert (item[5] is not None)                  # make sure xyz exist
    assert approx_equal(item[2],answer[1], 1.e-2) # bond length model
    assert approx_equal(item[4],answer[2], 1.e-1) # target

  test_output(results)

# ------------------------------------------------------------------------------
# ANGLE OUTLIERS
# Model has H and D atoms, and only the two following outliers
# Angle 'N-CA-HA', observed: 123.01, delta from target: -13.01
# Angle 'CB-CA-DA',observed: 121.11, delta from target: -12.11
# ------------------------------------------------------------------------------
def exercise10():
  results = get_results_from_validate_H(
    neutron_distances = True,
    pdb_str = pdb_str10)
  outliers_angles = results.outliers_angles

  outliers_angles_answer = [
    [' A 139 BTYR  DA ',  121.11, 109.0, (10.557, 8.334, 6.899)],
    [' A 139 ATYR  HA ',  123.01, 110.0, (10.583, 7.992, 7.177)]
      ]

  for item, answer in zip(outliers_angles, outliers_angles_answer):
    assert (item[0].strip() == answer[0].strip()) # pdb_str
    assert (item[5] is not None)                  # make sure xyz exist
    assert approx_equal(item[2],answer[1], 1.e-2) # angle in model
    assert approx_equal(item[4],answer[2], 1.e-1) # target

  test_output(results)

# ------------------------------------------------------------------------------
# Mismatch between expected restraints and X-H(D) bond lengths
# Input model has H at X-ray distances but use_neutron_distances flag is True
# --> xray_distances_used flag should be True
# ------------------------------------------------------------------------------
def exercise11():
  results = get_results_from_validate_H(
    neutron_distances = True,
    pdb_str = pdb_str11)
  bond_results = results.bond_results

  assert(bond_results.xray_distances_used == True)

  test_output(results)


def exercise12():
  '''
  Make sure that RNA H atoms are correctly identified as missing or present
  These atoms have names with '*' in libraries, but most recent used is "'"
  for example: H5*2 is in the database and in the file is H5''
  (issue raised by Jermaine Jenkins July 2019)
  '''
  results = get_results_from_validate_H(
    neutron_distances = False,
    pdb_str = pdb_str12a)
  missing = results.missing_HD_atoms
  assert (len(missing)==0)

  test_output(results)

  results = get_results_from_validate_H(
    neutron_distances = False,
    pdb_str = pdb_str12b)
  missing = results.missing_HD_atoms
  mt = missing[0]
  atom_names = mt[1]
  assert ("H5''" in atom_names and "H5'" in atom_names)
  assert (len(atom_names) == 2)


def exercise_hd_state():
  '''
  CHECK HD STATE (hd_state)
  This is not a result but used internally to decide if H/D site analysis is
  necessary or not
  '''
  pdb_inp = iotbx.pdb.input(lines=pdb_str4.split("\n"), source_info=None)
  model = mmtbx.model.manager(
      model_input = pdb_inp,
      log = null_out())
  c = validate_H(model = model,
                 use_neutron_distances = True)
  assert (c.get_hd_state() == 'all_h')

  pdb_inp = iotbx.pdb.input(lines=pdb_str5.split("\n"), source_info=None)
  model = mmtbx.model.manager(
      model_input = pdb_inp)
  c = validate_H(model = model,
                 use_neutron_distances = True)
  assert (c.get_hd_state() == 'all_d')

  pdb_inp = iotbx.pdb.input(lines=pdb_str3.split("\n"), source_info=None)
  model = mmtbx.model.manager(
      model_input = pdb_inp)
  c = validate_H(model = model,
                 use_neutron_distances = True)
  assert (c.get_hd_state() == 'h_and_d')

def run():
  exercise()
  exercise1()
  exercise2()
  exercise3()
  exercise4()
  exercise5()
  exercise6()
  exercise7()
  exercise8()
  exercise9()
  exercise10()
  exercise11()
  exercise12()
  exercise_hd_state()

if (__name__ == "__main__"):
  t0 = time.time()
  run()
  print("OK. Time: %8.3f"%(time.time()-t0))


 *******************************************************************************
