

 *******************************************************************************
mmtbx/regression/ncs/tst_ncs_search_flips.py
from __future__ import absolute_import, division, print_function
import iotbx.ncs
import iotbx.pdb
import mmtbx.ncs.ncs_utils as nu
from mmtbx.secondary_structure.build.ss_idealization import calculate_rmsd_smart

test_pdb_1 = """\
CRYST1  272.680  272.680  272.680  90.00  90.00  90.00 F 2 3        96
ATOM     17  N   LEU A   7      -3.960 -35.813 -28.701  1.00 59.07           N
ATOM     18  CA  LEU A   7      -2.543 -35.701 -29.071  1.00 52.98           C
ATOM     19  C   LEU A   7      -1.964 -34.379 -28.552  1.00 07.51           C
ATOM     20  O   LEU A   7      -2.502 -33.305 -28.832  1.00 95.11           O
ATOM     21  CB  LEU A   7      -2.337 -35.825 -30.589  1.00 93.68           C
ATOM     22  CG  LEU A   7      -2.092 -37.246 -31.147  1.00 36.57           C
ATOM     23  CD1 LEU A   7      -3.388 -38.030 -31.314  1.00 45.19           C
ATOM     24  CD2 LEU A   7      -1.342 -37.242 -32.482  1.00 52.49           C
TER
ATOM     17  N   LEU B   7       1.133 -33.422 -31.479  1.00 59.07           N
ATOM     18  CA  LEU B   7       2.550 -33.310 -31.849  1.00 52.98           C
ATOM     19  C   LEU B   7       3.129 -31.988 -31.330  1.00 07.51           C
ATOM     20  O   LEU B   7       2.591 -30.914 -31.610  1.00 95.11           O
ATOM     21  CB  LEU B   7       2.756 -33.434 -33.367  1.00 93.68           C
ATOM     22  CG  LEU B   7       3.001 -34.855 -33.925  1.00 36.57           C
ATOM     24  CD1 LEU B   7       3.751 -34.851 -35.260  1.00 52.49           C
ATOM     23  CD2 LEU B   7       1.705 -35.639 -34.092  1.00 45.19           C
END
"""

# same as test_pdb_1, but nothing is flipped
test_pdb_1_1 = """\
CRYST1  272.680  272.680  272.680  90.00  90.00  90.00 F 2 3        96
ATOM     17  N   LEU A   7      -3.960 -35.813 -28.701  1.00 59.07           N
ATOM     18  CA  LEU A   7      -2.543 -35.701 -29.071  1.00 52.98           C
ATOM     19  C   LEU A   7      -1.964 -34.379 -28.552  1.00 07.51           C
ATOM     20  O   LEU A   7      -2.502 -33.305 -28.832  1.00 95.11           O
ATOM     21  CB  LEU A   7      -2.337 -35.825 -30.589  1.00 93.68           C
ATOM     22  CG  LEU A   7      -2.092 -37.246 -31.147  1.00 36.57           C
ATOM     23  CD1 LEU A   7      -3.388 -38.030 -31.314  1.00 45.19           C
ATOM     24  CD2 LEU A   7      -1.342 -37.242 -32.482  1.00 52.49           C
TER
ATOM     17  N   LEU B   7       1.133 -33.422 -31.479  1.00 59.07           N
ATOM     18  CA  LEU B   7       2.550 -33.310 -31.849  1.00 52.98           C
ATOM     19  C   LEU B   7       3.129 -31.988 -31.330  1.00 07.51           C
ATOM     20  O   LEU B   7       2.591 -30.914 -31.610  1.00 95.11           O
ATOM     21  CB  LEU B   7       2.756 -33.434 -33.367  1.00 93.68           C
ATOM     22  CG  LEU B   7       3.001 -34.855 -33.925  1.00 36.57           C
ATOM     23  CD1 LEU B   7       1.705 -35.639 -34.092  1.00 45.19           C
ATOM     24  CD2 LEU B   7       3.751 -34.851 -35.260  1.00 52.49           C
END
"""

test_pdb_2 = """\
CRYST1   53.930  108.200  147.160  90.00  90.00  90.00 P 21 21 21   16
ATOM      1  N   TYR A   1      30.440   8.711   1.306  1.00 64.98           N
ATOM      2  CA  TYR A   1      29.117   9.171   1.763  1.00 67.34           C
ATOM      3  C   TYR A   1      28.007   8.102   1.965  1.00 65.79           C
ATOM      4  O   TYR A   1      26.830   8.428   1.845  1.00 58.29           O
ATOM      5  CB  TYR A   1      29.262  10.057   3.008  1.00 67.25           C
ATOM      6  CG  TYR A   1      29.855  11.415   2.711  1.00 70.44           C
ATOM      8  CD1 TYR A   1      31.185  11.716   3.026  1.00 71.73           C
ATOM      7  CD2 TYR A   1      29.079  12.412   2.112  1.00 68.62           C
ATOM     10  CE1 TYR A   1      31.716  12.971   2.753  1.00 72.09           C
ATOM      9  CE2 TYR A   1      29.603  13.668   1.843  1.00 68.12           C
ATOM     11  CZ  TYR A   1      30.919  13.946   2.160  1.00 69.15           C
ATOM     12  OH  TYR A   1      31.432  15.200   1.886  1.00 61.93           O
TER
ATOM      1  N   TYR B   1      30.440   8.711   6.306  1.00 64.98           N
ATOM      2  CA  TYR B   1      29.117   9.171   6.763  1.00 67.34           C
ATOM      3  C   TYR B   1      28.007   8.102   6.965  1.00 65.79           C
ATOM      4  O   TYR B   1      26.830   8.428   6.845  1.00 58.29           O
ATOM      5  CB  TYR B   1      29.262  10.057   8.008  1.00 67.25           C
ATOM      6  CG  TYR B   1      29.855  11.415   7.711  1.00 70.44           C
ATOM      7  CD1 TYR B   1      29.079  12.412   7.112  1.00 68.62           C
ATOM      8  CD2 TYR B   1      31.185  11.716   8.026  1.00 71.73           C
ATOM      9  CE1 TYR B   1      29.603  13.668   6.843  1.00 68.12           C
ATOM     10  CE2 TYR B   1      31.716  12.971   7.753  1.00 72.09           C
ATOM     11  CZ  TYR B   1      30.919  13.946   7.160  1.00 69.15           C
ATOM     12  OH  TYR B   1      31.432  15.200   6.886  1.00 61.93           O
"""
test_pdb_3 = """\
CRYST1   53.930  108.200  147.160  90.00  90.00  90.00 P 21 21 21   16
ATOM      1  N   TYR A   1      30.440   8.711   1.306  1.00 64.98           N
ATOM      2  CA  TYR A   1      29.117   9.171   1.763  1.00 67.34           C
ATOM      3  C   TYR A   1      28.007   8.102   1.965  1.00 65.79           C
ATOM      4  O   TYR A   1      26.830   8.428   1.845  1.00 58.29           O
ATOM      5  CB  TYR A   1      29.262  10.057   3.008  1.00 67.25           C
ATOM      6  CG  TYR A   1      29.855  11.415   2.711  1.00 70.44           C
ATOM      8  CD1 TYR A   1      31.185  11.716   3.026  1.00 71.73           C
ATOM      7  CD2 TYR A   1      29.079  12.412   2.112  1.00 68.62           C
ATOM      9  CE1 TYR A   1      29.603  13.668   1.843  1.00 68.12           C
ATOM     10  CE2 TYR A   1      31.716  12.971   2.753  1.00 72.09           C
ATOM     11  CZ  TYR A   1      30.919  13.946   2.160  1.00 69.15           C
ATOM     12  OH  TYR A   1      31.432  15.200   1.886  1.00 61.93           O
TER
ATOM      1  N   TYR B   1      30.440   8.711   6.306  1.00 64.98           N
ATOM      2  CA  TYR B   1      29.117   9.171   6.763  1.00 67.34           C
ATOM      3  C   TYR B   1      28.007   8.102   6.965  1.00 65.79           C
ATOM      4  O   TYR B   1      26.830   8.428   6.845  1.00 58.29           O
ATOM      5  CB  TYR B   1      29.262  10.057   8.008  1.00 67.25           C
ATOM      6  CG  TYR B   1      29.855  11.415   7.711  1.00 70.44           C
ATOM      7  CD1 TYR B   1      29.079  12.412   7.112  1.00 68.62           C
ATOM      8  CD2 TYR B   1      31.185  11.716   8.026  1.00 71.73           C
ATOM      9  CE1 TYR B   1      29.603  13.668   6.843  1.00 68.12           C
ATOM     10  CE2 TYR B   1      31.716  12.971   7.753  1.00 72.09           C
ATOM     11  CZ  TYR B   1      30.919  13.946   7.160  1.00 69.15           C
ATOM     12  OH  TYR B   1      31.432  15.200   6.886  1.00 61.93           O
"""

test_pdb_4 = """\
ATOM      1  N   HIS A   3      32.534  13.242   2.403  1.00  0.00           N
ATOM      2  CA  HIS A   3      33.724  12.970   3.202  1.00  0.00           C
ATOM      3  C   HIS A   3      34.993  13.295   2.422  1.00  0.00           C
ATOM      4  O   HIS A   3      35.327  12.618   1.450  1.00  0.00           O
ATOM      5  CB  HIS A   3      33.744  11.503   3.640  1.00  0.00           C
ATOM      6  CG  HIS A   3      32.618  11.130   4.554  1.00  0.00           C
ATOM      7  ND1 HIS A   3      32.586  11.494   5.882  1.00  0.00           N
ATOM      8  CD2 HIS A   3      31.485  10.424   4.330  1.00  0.00           C
ATOM      9  CE1 HIS A   3      31.481  11.029   6.437  1.00  0.00           C
ATOM     10  NE2 HIS A   3      30.795  10.375   5.517  1.00  0.00           N
TER
ATOM      1  N   HIS B   3      34.434   0.922   2.403  1.00  0.00           N
ATOM      2  CA  HIS B   3      35.624   0.650   3.202  1.00  0.00           C
ATOM      3  C   HIS B   3      36.893   0.975   2.422  1.00  0.00           C
ATOM      4  O   HIS B   3      37.227   0.298   1.450  1.00  0.00           O
ATOM      5  CB  HIS B   3      35.644  -0.817   3.640  1.00  0.00           C
ATOM      6  CG  HIS B   3      34.518  -1.190   4.554  1.00  0.00           C
ATOM      7  CD2 HIS B   3      34.486  -0.826   5.882  1.00  0.00           N
ATOM      8  ND1 HIS B   3      33.385  -1.896   4.330  1.00  0.00           C
ATOM      9  NE2 HIS B   3      33.381  -1.291   6.437  1.00  0.00           C
ATOM     10  CE1 HIS B   3      32.695  -1.945   5.517  1.00  0.00           N
"""

test_pdb_5 = """\
ATOM      1  N   ARG A   1      26.061  12.824   1.988  1.00  0.00           N
ATOM      2  CA  ARG A   1      27.253  12.525   2.773  1.00  0.00           C
ATOM      3  C   ARG A   1      28.520  12.882   2.003  1.00  0.00           C
ATOM      4  O   ARG A   1      28.853  12.243   1.005  1.00  0.00           O
ATOM      5  CB  ARG A   1      27.280  11.041   3.156  1.00 10.00           C
ATOM      6  CG  ARG A   1      26.107  10.591   4.022  1.00 10.00           C
ATOM      7  CD  ARG A   1      26.118  11.230   5.409  1.00 10.00           C
ATOM      8  NE  ARG A   1      27.283  10.828   6.201  1.00 10.00           N
ATOM      9  CZ  ARG A   1      27.735  11.441   7.298  1.00 10.00           C
ATOM     10  NH1 ARG A   1      27.146  12.525   7.803  1.00 10.00           N
ATOM     11  NH2 ARG A   1      28.808  10.956   7.908  1.00 10.00           N
ATOM      1  N   ALA A   2      29.223  13.907   2.474  1.00  0.00           N
ATOM      2  CA  ALA A   2      30.455  14.351   1.832  1.00  0.00           C
ATOM      3  C   ALA A   2      31.652  14.171   2.758  1.00  0.00           C
ATOM      4  O   ALA A   2      31.775  14.859   3.772  1.00  0.00           O
ATOM      5  CB  ALA A   2      30.331  15.807   1.408  1.00  0.00           C
ATOM      1  N   HIS A   3      32.534  13.242   2.403  1.00  0.00           N
ATOM      2  CA  HIS A   3      33.724  12.970   3.202  1.00  0.00           C
ATOM      3  C   HIS A   3      34.993  13.295   2.422  1.00  0.00           C
ATOM      4  O   HIS A   3      35.327  12.618   1.450  1.00  0.00           O
ATOM      5  CB  HIS A   3      33.744  11.503   3.640  1.00  0.00           C
ATOM      6  CG  HIS A   3      32.618  11.130   4.554  1.00  0.00           C
ATOM      7  ND1 HIS A   3      32.586  11.494   5.882  1.00  0.00           N
ATOM      8  CD2 HIS A   3      31.485  10.424   4.330  1.00  0.00           C
ATOM      9  CE1 HIS A   3      31.481  11.029   6.437  1.00  0.00           C
ATOM     10  NE2 HIS A   3      30.795  10.375   5.517  1.00  0.00           N
ATOM      1  N   ALA A   4      35.698  14.335   2.856  1.00  0.00           N
ATOM      2  CA  ALA A   4      36.932  14.752   2.201  1.00  0.00           C
ATOM      3  C   ALA A   4      38.127  14.604   3.136  1.00  0.00           C
ATOM      4  O   ALA A   4      38.248  15.329   4.124  1.00  0.00           O
ATOM      5  CB  ALA A   4      36.812  16.192   1.723  1.00  0.00           C
ATOM      1  N   ASP A   5      39.007  13.660   2.818  1.00  0.00           N
ATOM      2  CA  ASP A   5      40.194  13.415   3.630  1.00  0.00           C
ATOM      3  C   ASP A   5      41.467  13.708   2.841  1.00  0.00           C
ATOM      4  O   ASP A   5      41.801  12.995   1.896  1.00  0.00           O
ATOM      5  CB  ASP A   5      40.211  11.966   4.122  1.00  0.00           C
ATOM      6  CG  ASP A   5      41.346  11.691   5.089  1.00  0.00           C
ATOM      7  OD1 ASP A   5      41.256  12.134   6.254  1.00  0.00           O
ATOM      8  OD2 ASP A   5      42.327  11.032   4.685  1.00  0.00           O
ATOM      1  N   ALA A   6      42.172  14.763   3.238  1.00  0.00           N
ATOM      2  CA  ALA A   6      43.409  15.152   2.570  1.00  0.00           C
ATOM      3  C   ALA A   6      44.601  15.036   3.514  1.00  0.00           C
ATOM      4  O   ALA A   6      44.722  15.797   4.474  1.00  0.00           O
ATOM      5  CB  ALA A   6      43.294  16.573   2.039  1.00  0.00           C
ATOM      1  N   GLU A   7      45.480  14.079   3.234  1.00  0.00           N
ATOM      2  CA  GLU A   7      46.665  13.862   4.057  1.00  0.00           C
ATOM      3  C   GLU A   7      47.940  14.122   3.261  1.00  0.00           C
ATOM      4  O   GLU A   7      48.275  13.373   2.344  1.00  0.00           O
ATOM      5  CB  GLU A   7      46.677  12.432   4.604  1.00  0.00           C
ATOM      6  CG  GLU A   7      45.565  12.140   5.599  1.00  0.00           C
ATOM      7  CD  GLU A   7      45.595  10.711   6.103  1.00  0.00           C
ATOM      8  OE1 GLU A   7      46.403   9.912   5.585  1.00  0.00           O
ATOM      9  OE2 GLU A   7      44.809  10.384   7.019  1.00  0.00           O
ATOM      1  N   ALA A   8      48.647  15.189   3.620  1.00  0.00           N
ATOM      2  CA  ALA A   8      49.886  15.550   2.941  1.00  0.00           C
ATOM      3  C   ALA A   8      51.076  15.468   3.892  1.00  0.00           C
ATOM      4  O   ALA A   8      51.196  16.264   4.823  1.00  0.00           O
ATOM      5  CB  ALA A   8      49.776  16.951   2.356  1.00  0.00           C
ATOM      1  N   ALA A  10      55.122  15.615   4.002  1.00  0.00           N
ATOM      2  CA  ALA A  10      56.363  15.948   3.313  1.00  0.00           C
ATOM      3  C   ALA A  10      57.551  15.898   4.269  1.00  0.00           C
ATOM      4  O   ALA A  10      57.671  16.728   5.170  1.00  0.00           O
ATOM      5  CB  ALA A  10      56.258  17.326   2.676  1.00  0.00           C
ATOM      1  N   ASN A  11      58.427  14.919   4.065  1.00  0.00           N
ATOM      2  CA  ASN A  11      59.606  14.759   4.908  1.00  0.00           C
ATOM      3  C   ASN A  11      60.886  14.953   4.102  1.00  0.00           C
ATOM      4  O   ASN A  11      61.222  14.136   3.244  1.00  0.00           O
ATOM      5  CB  ASN A  11      59.609  13.379   5.562  1.00  0.00           C
ATOM      6  CG  ASN A  11      58.532  13.236   6.620  1.00  0.00           C
ATOM      7  OD1 ASN A  11      58.296  14.149   7.410  1.00  0.00           O
ATOM      8  ND2 ASN A  11      57.872  12.083   6.640  1.00  0.00           N
ATOM      1  N   ALA A  12      61.597  16.041   4.383  1.00  0.00           N
ATOM      2  CA  ALA A  12      62.841  16.345   3.686  1.00  0.00           C
ATOM      3  C   ALA A  12      64.025  16.328   4.646  1.00  0.00           C
ATOM      4  O   ALA A  12      64.145  17.191   5.515  1.00  0.00           O
ATOM      5  CB  ALA A  12      62.740  17.698   2.997  1.00  0.00           C
ATOM      1  N   GLN A  13      64.899  15.340   4.481  1.00  0.00           N
ATOM      2  CA  GLN A  13      66.076  15.209   5.332  1.00  0.00           C
ATOM      3  C   GLN A  13      67.359  15.370   4.522  1.00  0.00           C
ATOM      4  O   GLN A  13      67.695  14.521   3.697  1.00  0.00           O
ATOM      5  CB  GLN A  13      66.071  13.849   6.037  1.00  0.00           C
ATOM      6  CG  GLN A  13      67.212  13.651   7.023  1.00  0.00           C
ATOM      7  CD  GLN A  13      67.140  12.317   7.739  1.00  0.00           C
ATOM      8  OE1 GLN A  13      66.251  11.506   7.477  1.00  0.00           O
ATOM      9  NE2 GLN A  13      68.078  12.082   8.650  1.00  0.00           N
ATOM      1  N   ALA A  14      68.071  16.466   4.765  1.00  0.00           N
ATOM      2  CA  ALA A  14      69.318  16.740   4.059  1.00  0.00           C
ATOM      3  C   ALA A  14      70.500  16.757   5.022  1.00  0.00           C
ATOM      4  O   ALA A  14      70.620  17.652   5.859  1.00  0.00           O
ATOM      5  CB  ALA A  14      69.222  18.067   3.320  1.00  0.00           C
ATOM      1  N   LEU A  15      71.372  15.761   4.897  1.00  0.00           N
ATOM      2  CA  LEU A  15      72.547  15.660   5.755  1.00  0.00           C
ATOM      3  C   LEU A  15      73.832  15.788   4.943  1.00  0.00           C
ATOM      4  O   LEU A  15      74.168  14.907   4.151  1.00  0.00           O
ATOM      5  CB  LEU A  15      72.541  14.325   6.508  1.00  0.00           C
ATOM      6  CG  LEU A  15      71.415  14.114   7.526  1.00  0.00           C
ATOM      7  CD1 LEU A  15      71.462  12.699   8.081  1.00  0.00           C
ATOM      8  CD2 LEU A  15      71.487  15.136   8.654  1.00  0.00           C
ATOM      1  N   ALA A  16      74.546  16.890   5.146  1.00  0.00           N
ATOM      2  CA  ALA A  16      75.795  17.135   4.434  1.00  0.00           C
ATOM      3  C   ALA A  16      76.975  17.185   5.399  1.00  0.00           C
ATOM      4  O   ALA A  16      77.095  18.110   6.202  1.00  0.00           O
ATOM      5  CB  ALA A  16      75.704  18.434   3.646  1.00  0.00           C
ATOM      1  N   PHE A  17      77.845  16.184   5.313  1.00  0.00           N
ATOM      2  CA  PHE A  17      79.018  16.111   6.177  1.00  0.00           C
ATOM      3  C   PHE A  17      80.304  16.206   5.364  1.00  0.00           C
ATOM      4  O   PHE A  17      80.640  15.296   4.606  1.00  0.00           O
ATOM      5  CB  PHE A  17      79.005  14.807   6.980  1.00  0.00           C
ATOM      6  CG  PHE A  17      77.889  14.721   7.981  1.00  0.00           C
ATOM      7  CD1 PHE A  17      77.992  15.351   9.210  1.00  0.00           C
ATOM      8  CD2 PHE A  17      76.735  14.009   7.693  1.00  0.00           C
ATOM      9  CE1 PHE A  17      76.966  15.272  10.133  1.00  0.00           C
ATOM     10  CE2 PHE A  17      75.706  13.927   8.612  1.00  0.00           C
ATOM     11  CZ  PHE A  17      75.822  14.560   9.833  1.00  0.00           C
ATOM      1  N   ALA A  18      81.021  17.314   5.528  1.00  0.00           N
ATOM      2  CA  ALA A  18      82.272  17.529   4.810  1.00  0.00           C
ATOM      3  C   ALA A  18      83.450  17.613   5.775  1.00  0.00           C
ATOM      4  O   ALA A  18      83.570  18.567   6.543  1.00  0.00           O
ATOM      5  CB  ALA A  18      82.186  18.797   3.973  1.00  0.00           C
ATOM      1  N   TYR A  19      84.318  16.606   5.729  1.00  0.00           N
ATOM      2  CA  TYR A  19      85.488  16.564   6.598  1.00  0.00           C
ATOM      3  C   TYR A  19      86.777  16.625   5.785  1.00  0.00           C
ATOM      4  O   TYR A  19      87.113  15.687   5.063  1.00  0.00           O
ATOM      5  CB  TYR A  19      85.471  15.292   7.450  1.00  0.00           C
ATOM      6  CG  TYR A  19      84.363  15.258   8.479  1.00  0.00           C
ATOM      7  CD1 TYR A  19      83.662  16.411   8.812  1.00  0.00           C
ATOM      8  CD2 TYR A  19      84.016  14.074   9.116  1.00  0.00           C
ATOM      9  CE1 TYR A  19      82.648  16.386   9.751  1.00  0.00           C
ATOM     10  CE2 TYR A  19      83.002  14.039  10.057  1.00  0.00           C
ATOM     11  CZ  TYR A  19      82.323  15.197  10.369  1.00  0.00           C
ATOM     12  OH  TYR A  19      81.313  15.166  11.305  1.00  0.00           O
ATOM      1  N   ALA A  20      87.496  17.737   5.909  1.00  0.00           N
ATOM      2  CA  ALA A  20      88.749  17.922   5.187  1.00  0.00           C
ATOM      3  C   ALA A  20      89.925  18.039   6.151  1.00  0.00           C
ATOM      4  O   ALA A  20      90.046  19.021   6.883  1.00  0.00           O
ATOM      5  CB  ALA A  20      88.668  19.159   4.303  1.00  0.00           C
ATOM      1  N   VAL A  21      90.791  17.030   6.145  1.00  0.00           N
ATOM      2  CA  VAL A  21      91.959  17.017   7.018  1.00  0.00           C
ATOM      3  C   VAL A  21      93.250  17.045   6.207  1.00  0.00           C
ATOM      4  O   VAL A  21      93.585  16.079   5.521  1.00  0.00           O
ATOM      5  CB  VAL A  21      91.967  15.769   7.925  1.00  0.00           C
ATOM      6  CG1 VAL A  21      93.241  15.722   8.760  1.00  0.00           C
ATOM      7  CG2 VAL A  21      90.735  15.749   8.820  1.00  0.00           C
ATOM      1  N   ALA A  22      93.971  18.159   6.291  1.00  0.00           N
ATOM      2  CA  ALA A  22      95.226  18.315   5.565  1.00  0.00           C
ATOM      3  C   ALA A  22      96.400  18.465   6.527  1.00  0.00           C
ATOM      4  O   ALA A  22      96.521  19.473   7.222  1.00  0.00           O
ATOM      5  CB  ALA A  22      95.150  19.517   4.636  1.00  0.00           C
TER     156      ALA A  22
ATOM      1  N   ARG B   1      27.961   0.504   1.988  1.00  0.00           N
ATOM      2  CA  ARG B   1      29.153   0.205   2.773  1.00  0.00           C
ATOM      3  C   ARG B   1      30.420   0.562   2.003  1.00  0.00           C
ATOM      4  O   ARG B   1      30.753  -0.077   1.005  1.00  0.00           O
ATOM      5  CB  ARG B   1      29.180  -1.279   3.156  1.00 10.00           C
ATOM      6  CG  ARG B   1      28.007  -1.729   4.022  1.00 10.00           C
ATOM      7  CD  ARG B   1      28.018  -1.090   5.409  1.00 10.00           C
ATOM      8  NE  ARG B   1      29.183  -1.492   6.201  1.00 10.00           N
ATOM      9  CZ  ARG B   1      29.635  -0.879   7.298  1.00 10.00           C
ATOM     10  NH2 ARG B   1      29.046   0.205   7.803  1.00 10.00           N
ATOM     11  NH1 ARG B   1      30.708  -1.364   7.908  1.00 10.00           N
ATOM      1  N   ALA B   2      31.123   1.587   2.474  1.00  0.00           N
ATOM      2  CA  ALA B   2      32.355   2.031   1.832  1.00  0.00           C
ATOM      3  C   ALA B   2      33.552   1.851   2.758  1.00  0.00           C
ATOM      4  O   ALA B   2      33.675   2.539   3.772  1.00  0.00           O
ATOM      5  CB  ALA B   2      32.231   3.487   1.408  1.00  0.00           C
ATOM      1  N   HIS B   3      34.434   0.922   2.403  1.00  0.00           N
ATOM      2  CA  HIS B   3      35.624   0.650   3.202  1.00  0.00           C
ATOM      3  C   HIS B   3      36.893   0.975   2.422  1.00  0.00           C
ATOM      4  O   HIS B   3      37.227   0.298   1.450  1.00  0.00           O
ATOM      5  CB  HIS B   3      35.644  -0.817   3.640  1.00  0.00           C
ATOM      6  CG  HIS B   3      34.518  -1.190   4.554  1.00  0.00           C
ATOM      7  CD2 HIS B   3      34.486  -0.826   5.882  1.00  0.00           N
ATOM      8  ND1 HIS B   3      33.385  -1.896   4.330  1.00  0.00           C
ATOM      9  NE2 HIS B   3      33.381  -1.291   6.437  1.00  0.00           C
ATOM     10  CE1 HIS B   3      32.695  -1.945   5.517  1.00  0.00           N
ATOM      1  N   ALA B   4      37.598   2.015   2.856  1.00  0.00           N
ATOM      2  CA  ALA B   4      38.832   2.432   2.201  1.00  0.00           C
ATOM      3  C   ALA B   4      40.027   2.284   3.136  1.00  0.00           C
ATOM      4  O   ALA B   4      40.148   3.009   4.124  1.00  0.00           O
ATOM      5  CB  ALA B   4      38.712   3.872   1.723  1.00  0.00           C
ATOM      1  N   ASP B   5      40.907   1.340   2.818  1.00  0.00           N
ATOM      2  CA  ASP B   5      42.094   1.095   3.630  1.00  0.00           C
ATOM      3  C   ASP B   5      43.367   1.388   2.841  1.00  0.00           C
ATOM      4  O   ASP B   5      43.701   0.675   1.896  1.00  0.00           O
ATOM      5  CB  ASP B   5      42.111  -0.354   4.122  1.00  0.00           C
ATOM      6  CG  ASP B   5      43.246  -0.629   5.089  1.00  0.00           C
ATOM      7  OD2 ASP B   5      43.156  -0.186   6.254  1.00  0.00           O
ATOM      8  OD1 ASP B   5      44.227  -1.288   4.685  1.00  0.00           O
ATOM      1  N   ALA B   6      44.072   2.443   3.238  1.00  0.00           N
ATOM      2  CA  ALA B   6      45.309   2.832   2.570  1.00  0.00           C
ATOM      3  C   ALA B   6      46.501   2.716   3.514  1.00  0.00           C
ATOM      4  O   ALA B   6      46.622   3.477   4.474  1.00  0.00           O
ATOM      5  CB  ALA B   6      45.194   4.253   2.039  1.00  0.00           C
ATOM      1  N   GLU B   7      47.380   1.759   3.234  1.00  0.00           N
ATOM      2  CA  GLU B   7      48.565   1.542   4.057  1.00  0.00           C
ATOM      3  C   GLU B   7      49.840   1.802   3.261  1.00  0.00           C
ATOM      4  O   GLU B   7      50.175   1.053   2.344  1.00  0.00           O
ATOM      5  CB  GLU B   7      48.577   0.112   4.604  1.00  0.00           C
ATOM      6  CG  GLU B   7      47.465  -0.180   5.599  1.00  0.00           C
ATOM      7  CD  GLU B   7      47.495  -1.609   6.103  1.00  0.00           C
ATOM      8  OE2 GLU B   7      48.303  -2.408   5.585  1.00  0.00           O
ATOM      9  OE1 GLU B   7      46.709  -1.936   7.019  1.00  0.00           O
ATOM      1  N   ALA B   8      50.547   2.869   3.620  1.00  0.00           N
ATOM      2  CA  ALA B   8      51.786   3.230   2.941  1.00  0.00           C
ATOM      3  C   ALA B   8      52.976   3.148   3.892  1.00  0.00           C
ATOM      4  O   ALA B   8      53.096   3.944   4.823  1.00  0.00           O
ATOM      5  CB  ALA B   8      51.676   4.631   2.356  1.00  0.00           C
ATOM      1  N   ALA B  10      57.022   3.295   4.002  1.00  0.00           N
ATOM      2  CA  ALA B  10      58.263   3.628   3.313  1.00  0.00           C
ATOM      3  C   ALA B  10      59.451   3.578   4.269  1.00  0.00           C
ATOM      4  O   ALA B  10      59.571   4.408   5.170  1.00  0.00           O
ATOM      5  CB  ALA B  10      58.158   5.006   2.676  1.00  0.00           C
ATOM      1  N   ASN B  11      60.327   2.599   4.065  1.00  0.00           N
ATOM      2  CA  ASN B  11      61.506   2.439   4.908  1.00  0.00           C
ATOM      3  C   ASN B  11      62.786   2.633   4.102  1.00  0.00           C
ATOM      4  O   ASN B  11      63.122   1.816   3.244  1.00  0.00           O
ATOM      5  CB  ASN B  11      61.509   1.059   5.562  1.00  0.00           C
ATOM      6  CG  ASN B  11      60.432   0.916   6.620  1.00  0.00           C
ATOM      7  ND2 ASN B  11      60.196   1.829   7.410  1.00  0.00           O
ATOM      8  OD1 ASN B  11      59.772  -0.237   6.640  1.00  0.00           N
ATOM      1  N   ALA B  12      63.497   3.721   4.383  1.00  0.00           N
ATOM      2  CA  ALA B  12      64.741   4.025   3.686  1.00  0.00           C
ATOM      3  C   ALA B  12      65.925   4.008   4.646  1.00  0.00           C
ATOM      4  O   ALA B  12      66.045   4.871   5.515  1.00  0.00           O
ATOM      5  CB  ALA B  12      64.640   5.378   2.997  1.00  0.00           C
ATOM      1  N   GLN B  13      66.799   3.020   4.481  1.00  0.00           N
ATOM      2  CA  GLN B  13      67.976   2.889   5.332  1.00  0.00           C
ATOM      3  C   GLN B  13      69.259   3.050   4.522  1.00  0.00           C
ATOM      4  O   GLN B  13      69.595   2.201   3.697  1.00  0.00           O
ATOM      5  CB  GLN B  13      67.971   1.529   6.037  1.00  0.00           C
ATOM      6  CG  GLN B  13      69.112   1.331   7.023  1.00  0.00           C
ATOM      7  CD  GLN B  13      69.040  -0.003   7.739  1.00  0.00           C
ATOM      8  NE2 GLN B  13      68.151  -0.814   7.477  1.00  0.00           O
ATOM      9  OE1 GLN B  13      69.978  -0.238   8.650  1.00  0.00           N
ATOM      1  N   ALA B  14      69.971   4.146   4.765  1.00  0.00           N
ATOM      2  CA  ALA B  14      71.218   4.420   4.059  1.00  0.00           C
ATOM      3  C   ALA B  14      72.400   4.437   5.022  1.00  0.00           C
ATOM      4  O   ALA B  14      72.520   5.332   5.859  1.00  0.00           O
ATOM      5  CB  ALA B  14      71.122   5.747   3.320  1.00  0.00           C
ATOM      1  N   LEU B  15      73.272   3.441   4.897  1.00  0.00           N
ATOM      2  CA  LEU B  15      74.447   3.340   5.755  1.00  0.00           C
ATOM      3  C   LEU B  15      75.732   3.468   4.943  1.00  0.00           C
ATOM      4  O   LEU B  15      76.068   2.587   4.151  1.00  0.00           O
ATOM      5  CB  LEU B  15      74.441   2.005   6.508  1.00  0.00           C
ATOM      6  CG  LEU B  15      73.315   1.794   7.526  1.00  0.00           C
ATOM      7  CD2 LEU B  15      73.362   0.379   8.081  1.00  0.00           C
ATOM      8  CD1 LEU B  15      73.387   2.816   8.654  1.00  0.00           C
ATOM      1  N   ALA B  16      76.446   4.570   5.146  1.00  0.00           N
ATOM      2  CA  ALA B  16      77.695   4.815   4.434  1.00  0.00           C
ATOM      3  C   ALA B  16      78.875   4.865   5.399  1.00  0.00           C
ATOM      4  O   ALA B  16      78.995   5.790   6.202  1.00  0.00           O
ATOM      5  CB  ALA B  16      77.604   6.114   3.646  1.00  0.00           C
ATOM      1  N   PHE B  17      79.745   3.864   5.313  1.00  0.00           N
ATOM      2  CA  PHE B  17      80.918   3.791   6.177  1.00  0.00           C
ATOM      3  C   PHE B  17      82.204   3.886   5.364  1.00  0.00           C
ATOM      4  O   PHE B  17      82.540   2.976   4.606  1.00  0.00           O
ATOM      5  CB  PHE B  17      80.905   2.487   6.980  1.00  0.00           C
ATOM      6  CG  PHE B  17      79.789   2.401   7.981  1.00  0.00           C
ATOM      7  CD2 PHE B  17      79.892   3.031   9.210  1.00  0.00           C
ATOM      8  CD1 PHE B  17      78.635   1.689   7.693  1.00  0.00           C
ATOM      9  CE2 PHE B  17      78.866   2.952  10.133  1.00  0.00           C
ATOM     10  CE1 PHE B  17      77.606   1.607   8.612  1.00  0.00           C
ATOM     11  CZ  PHE B  17      77.722   2.240   9.833  1.00  0.00           C
ATOM      1  N   ALA B  18      82.921   4.994   5.528  1.00  0.00           N
ATOM      2  CA  ALA B  18      84.172   5.209   4.810  1.00  0.00           C
ATOM      3  C   ALA B  18      85.350   5.293   5.775  1.00  0.00           C
ATOM      4  O   ALA B  18      85.470   6.247   6.543  1.00  0.00           O
ATOM      5  CB  ALA B  18      84.086   6.477   3.973  1.00  0.00           C
ATOM      1  N   TYR B  19      86.218   4.286   5.729  1.00  0.00           N
ATOM      2  CA  TYR B  19      87.388   4.244   6.598  1.00  0.00           C
ATOM      3  C   TYR B  19      88.677   4.305   5.785  1.00  0.00           C
ATOM      4  O   TYR B  19      89.013   3.367   5.063  1.00  0.00           O
ATOM      5  CB  TYR B  19      87.371   2.972   7.450  1.00  0.00           C
ATOM      6  CG  TYR B  19      86.263   2.938   8.479  1.00  0.00           C
ATOM      7  CD2 TYR B  19      85.562   4.091   8.812  1.00  0.00           C
ATOM      8  CD1 TYR B  19      85.916   1.754   9.116  1.00  0.00           C
ATOM      9  CE2 TYR B  19      84.548   4.066   9.751  1.00  0.00           C
ATOM     10  CE1 TYR B  19      84.902   1.719  10.057  1.00  0.00           C
ATOM     11  CZ  TYR B  19      84.223   2.877  10.369  1.00  0.00           C
ATOM     12  OH  TYR B  19      83.213   2.846  11.305  1.00  0.00           O
ATOM      1  N   ALA B  20      89.396   5.417   5.909  1.00  0.00           N
ATOM      2  CA  ALA B  20      90.649   5.602   5.187  1.00  0.00           C
ATOM      3  C   ALA B  20      91.825   5.719   6.151  1.00  0.00           C
ATOM      4  O   ALA B  20      91.946   6.701   6.883  1.00  0.00           O
ATOM      5  CB  ALA B  20      90.568   6.839   4.303  1.00  0.00           C
ATOM      1  N   VAL B  21      92.691   4.710   6.145  1.00  0.00           N
ATOM      2  CA  VAL B  21      93.859   4.697   7.018  1.00  0.00           C
ATOM      3  C   VAL B  21      95.150   4.725   6.207  1.00  0.00           C
ATOM      4  O   VAL B  21      95.485   3.759   5.521  1.00  0.00           O
ATOM      5  CB  VAL B  21      93.867   3.449   7.925  1.00  0.00           C
ATOM      6  CG2 VAL B  21      95.141   3.402   8.760  1.00  0.00           C
ATOM      7  CG1 VAL B  21      92.635   3.429   8.820  1.00  0.00           C
ATOM      1  N   ALA B  22      95.871   5.839   6.291  1.00  0.00           N
ATOM      2  CA  ALA B  22      97.126   5.995   5.565  1.00  0.00           C
ATOM      3  C   ALA B  22      98.300   6.145   6.527  1.00  0.00           C
ATOM      4  O   ALA B  22      98.421   7.153   7.222  1.00  0.00           O
ATOM      5  CB  ALA B  22      97.050   7.197   4.636  1.00  0.00           C
TER     312      ALA B  22
END
"""

ncs_pars = iotbx.ncs.input.get_default_params()
ncs_pars.ncs_search.chain_max_rmsd=0.1

def test_1():
  h = iotbx.pdb.input(source_info=None, lines=test_pdb_1).construct_hierarchy()
  asc = h.atom_selection_cache()
  ncs_inp = iotbx.ncs.input(
      hierarchy=h,
      params=ncs_pars.ncs_search)
  ncs_groups = ncs_inp.get_ncs_restraints_group_list()
  assert len(ncs_groups) == 1
  # group 1
  assert ncs_groups[0].master_iselection.all_eq(
    asc.selection(string = "chain A").iselection())
  g1_c = ncs_groups[0].copies
  assert len(g1_c)==1
  assert g1_c[0].iselection.all_eq(
    asc.selection(string = "chain B").iselection())

def test_2():
  """ Testing TYR both CD and CE flips"""
  h = iotbx.pdb.input(source_info=None, lines=test_pdb_2).construct_hierarchy()
  asc = h.atom_selection_cache()
  ncs_inp = iotbx.ncs.input(
      hierarchy=h,
      params=ncs_pars.ncs_search)
  ncs_groups = ncs_inp.get_ncs_restraints_group_list()
  assert len(ncs_groups) == 1
  # group 1
  assert ncs_groups[0].master_iselection.all_eq(
    asc.selection(string = "chain A").iselection())
  g1_c = ncs_groups[0].copies
  assert len(g1_c)==1
  assert g1_c[0].iselection.all_eq(
    asc.selection(string = "chain B").iselection())

def test_3():
  """ Testing TYR only CD and flip. Not sure if such flip is valid.
      This test is not working when we use torsion angles because in this
      procedure we don't flip only one atom out of two like in this case"""
  h = iotbx.pdb.input(source_info=None, lines=test_pdb_3).construct_hierarchy()
  asc = h.atom_selection_cache()
  ncs_inp = iotbx.ncs.input(
      hierarchy=h,
      params=ncs_pars.ncs_search)
  ncs_groups = ncs_inp.get_ncs_restraints_group_list()
  assert len(ncs_groups) == 1
  # group 1
  assert ncs_groups[0].master_iselection.all_eq(
    asc.selection(string = "chain A").iselection())
  g1_c = ncs_groups[0].copies
  assert len(g1_c)==1
  assert g1_c[0].iselection.all_eq(
    asc.selection(string = "chain B").iselection())

def test_4():
  """ HIS is interesting because of different atoms can be flipped """
  h = iotbx.pdb.input(source_info=None, lines=test_pdb_4).construct_hierarchy()
  asc = h.atom_selection_cache()
  ncs_inp = iotbx.ncs.input(
      hierarchy=h,
      params=ncs_pars.ncs_search)
  ncs_groups = ncs_inp.get_ncs_restraints_group_list()
  assert len(ncs_groups) == 1
  # group 1
  assert ncs_groups[0].master_iselection.all_eq(
    asc.selection(string = "chain A").iselection())
  g1_c = ncs_groups[0].copies
  assert len(g1_c)==1
  assert g1_c[0].iselection.all_eq(
    asc.selection(string = "chain B").iselection())

def test_5():
  """ Testing all possible residues at once. All flipped wherever possible
  in chain B """
  h = iotbx.pdb.input(source_info=None, lines=test_pdb_5).construct_hierarchy()
  asc = h.atom_selection_cache()
  ncs_inp = iotbx.ncs.input(
      hierarchy=h,
      params=ncs_pars.ncs_search)
  ncs_groups = ncs_inp.get_ncs_restraints_group_list()
  assert len(ncs_groups) == 1
  # group 1
  assert ncs_groups[0].master_iselection.all_eq(
    asc.selection(string = "chain A").iselection())
  g1_c = ncs_groups[0].copies
  assert len(g1_c)==1
  assert g1_c[0].iselection.all_eq(
    asc.selection(string = "chain B").iselection())

def test_6():
  "Actually making flips for test_pdb_1"
  h = iotbx.pdb.input(source_info=None, lines=test_pdb_1_1).construct_hierarchy()
  asc = h.atom_selection_cache()
  ncs_inp = iotbx.ncs.input(
      hierarchy=h,
      params=ncs_pars.ncs_search)
  ncs_groups = ncs_inp.get_ncs_restraints_group_list()

  nu.flip_atoms_in_ncs_groups(h, ncs_groups)
  h.write_pdb_file("test_6_result.pdb")

def test_7():
  "Actually making flips for test_pdb_2"
  answer_pdb_str = """
ATOM      1  N   TYR A   1      30.440   8.711   1.306  1.00 64.98           N
ATOM      2  CA  TYR A   1      29.117   9.171   1.763  1.00 67.34           C
ATOM      3  C   TYR A   1      28.007   8.102   1.965  1.00 65.79           C
ATOM      4  O   TYR A   1      26.830   8.428   1.845  1.00 58.29           O
ATOM      5  CB  TYR A   1      29.262  10.057   3.008  1.00 67.25           C
ATOM      6  CG  TYR A   1      29.855  11.415   2.711  1.00 70.44           C
ATOM      7  CD1 TYR A   1      31.185  11.716   3.026  1.00 71.73           C
ATOM      8  CD2 TYR A   1      29.079  12.412   2.112  1.00 68.62           C
ATOM      9  CE1 TYR A   1      31.716  12.971   2.753  1.00 72.09           C
ATOM     10  CE2 TYR A   1      29.603  13.668   1.843  1.00 68.12           C
ATOM     11  CZ  TYR A   1      30.919  13.946   2.160  1.00 69.15           C
ATOM     12  OH  TYR A   1      31.432  15.200   1.886  1.00 61.93           O
TER
ATOM     13  N   TYR B   1      30.440   8.711   6.306  1.00 64.98           N
ATOM     14  CA  TYR B   1      29.117   9.171   6.763  1.00 67.34           C
ATOM     15  C   TYR B   1      28.007   8.102   6.965  1.00 65.79           C
ATOM     16  O   TYR B   1      26.830   8.428   6.845  1.00 58.29           O
ATOM     17  CB  TYR B   1      29.262  10.057   8.008  1.00 67.25           C
ATOM     18  CG  TYR B   1      29.855  11.415   7.711  1.00 70.44           C
ATOM     19  CD1 TYR B   1      31.187  11.692   8.031  1.00 68.62           C
ATOM     20  CD2 TYR B   1      29.098  12.427   7.109  1.00 71.73           C
ATOM     21  CE1 TYR B   1      31.752  12.929   7.755  1.00 68.12           C
ATOM     22  CE2 TYR B   1      29.658  13.669   6.836  1.00 72.09           C
ATOM     23  CZ  TYR B   1      30.988  13.916   7.161  1.00 69.15           C
ATOM     24  OH  TYR B   1      31.560  15.146   6.892  1.00 61.93           O
TER
  """
  h = iotbx.pdb.input(source_info=None, lines=test_pdb_2).construct_hierarchy()
  anwer_h = iotbx.pdb.input(source_info=None, lines=answer_pdb_str).construct_hierarchy()
  h.write_pdb_file("test_7_before.pdb")

  ncs_inp = iotbx.ncs.input(
      hierarchy=h,
      params=ncs_pars.ncs_search)
  ncs_groups = ncs_inp.get_ncs_restraints_group_list()

  nu.flip_atoms_in_ncs_groups(h, ncs_groups)
  h.write_pdb_file("test_7_result.pdb")
  rmsd_smart = calculate_rmsd_smart(anwer_h, h)
  print(rmsd_smart)
  assert rmsd_smart < 0.01

def test_8():
  """ Actually making flips for test_pdb_5"""
  answer_pdb_str = """
ATOM      1  N   ARG A   1      26.061  12.824   1.988  1.00  0.00           N
ATOM      2  CA  ARG A   1      27.253  12.525   2.773  1.00  0.00           C
ATOM      3  C   ARG A   1      28.520  12.882   2.003  1.00  0.00           C
ATOM      4  O   ARG A   1      28.853  12.243   1.005  1.00  0.00           O
ATOM      5  CB  ARG A   1      27.280  11.041   3.156  1.00 10.00           C
ATOM      6  CG  ARG A   1      26.107  10.591   4.022  1.00 10.00           C
ATOM      7  CD  ARG A   1      26.118  11.230   5.409  1.00 10.00           C
ATOM      8  NE  ARG A   1      27.283  10.828   6.201  1.00 10.00           N
ATOM      9  CZ  ARG A   1      27.735  11.441   7.298  1.00 10.00           C
ATOM     10  NH1 ARG A   1      27.146  12.525   7.803  1.00 10.00           N
ATOM     11  NH2 ARG A   1      28.808  10.956   7.908  1.00 10.00           N
ATOM     12  N   ALA A   2      29.223  13.907   2.474  1.00  0.00           N
ATOM     13  CA  ALA A   2      30.455  14.351   1.832  1.00  0.00           C
ATOM     14  C   ALA A   2      31.652  14.171   2.758  1.00  0.00           C
ATOM     15  O   ALA A   2      31.775  14.859   3.772  1.00  0.00           O
ATOM     16  CB  ALA A   2      30.331  15.807   1.408  1.00  0.00           C
ATOM     17  N   HIS A   3      32.534  13.242   2.403  1.00  0.00           N
ATOM     18  CA  HIS A   3      33.724  12.970   3.202  1.00  0.00           C
ATOM     19  C   HIS A   3      34.993  13.295   2.422  1.00  0.00           C
ATOM     20  O   HIS A   3      35.327  12.618   1.450  1.00  0.00           O
ATOM     21  CB  HIS A   3      33.744  11.503   3.640  1.00  0.00           C
ATOM     22  CG  HIS A   3      32.618  11.130   4.554  1.00  0.00           C
ATOM     23  ND1 HIS A   3      32.586  11.494   5.882  1.00  0.00           N
ATOM     24  CD2 HIS A   3      31.485  10.424   4.330  1.00  0.00           C
ATOM     25  CE1 HIS A   3      31.481  11.029   6.437  1.00  0.00           C
ATOM     26  NE2 HIS A   3      30.795  10.375   5.517  1.00  0.00           N
ATOM     27  N   ALA A   4      35.698  14.335   2.856  1.00  0.00           N
ATOM     28  CA  ALA A   4      36.932  14.752   2.201  1.00  0.00           C
ATOM     29  C   ALA A   4      38.127  14.604   3.136  1.00  0.00           C
ATOM     30  O   ALA A   4      38.248  15.329   4.124  1.00  0.00           O
ATOM     31  CB  ALA A   4      36.812  16.192   1.723  1.00  0.00           C
ATOM     32  N   ASP A   5      39.007  13.660   2.818  1.00  0.00           N
ATOM     33  CA  ASP A   5      40.194  13.415   3.630  1.00  0.00           C
ATOM     34  C   ASP A   5      41.467  13.708   2.841  1.00  0.00           C
ATOM     35  O   ASP A   5      41.801  12.995   1.896  1.00  0.00           O
ATOM     36  CB  ASP A   5      40.211  11.966   4.122  1.00  0.00           C
ATOM     37  CG  ASP A   5      41.346  11.691   5.089  1.00  0.00           C
ATOM     38  OD1 ASP A   5      41.256  12.134   6.254  1.00  0.00           O
ATOM     39  OD2 ASP A   5      42.327  11.032   4.685  1.00  0.00           O
ATOM     40  N   ALA A   6      42.172  14.763   3.238  1.00  0.00           N
ATOM     41  CA  ALA A   6      43.409  15.152   2.570  1.00  0.00           C
ATOM     42  C   ALA A   6      44.601  15.036   3.514  1.00  0.00           C
ATOM     43  O   ALA A   6      44.722  15.797   4.474  1.00  0.00           O
ATOM     44  CB  ALA A   6      43.294  16.573   2.039  1.00  0.00           C
ATOM     45  N   GLU A   7      45.480  14.079   3.234  1.00  0.00           N
ATOM     46  CA  GLU A   7      46.665  13.862   4.057  1.00  0.00           C
ATOM     47  C   GLU A   7      47.940  14.122   3.261  1.00  0.00           C
ATOM     48  O   GLU A   7      48.275  13.373   2.344  1.00  0.00           O
ATOM     49  CB  GLU A   7      46.677  12.432   4.604  1.00  0.00           C
ATOM     50  CG  GLU A   7      45.565  12.140   5.599  1.00  0.00           C
ATOM     51  CD  GLU A   7      45.595  10.711   6.103  1.00  0.00           C
ATOM     52  OE1 GLU A   7      46.403   9.912   5.585  1.00  0.00           O
ATOM     53  OE2 GLU A   7      44.809  10.384   7.019  1.00  0.00           O
ATOM     54  N   ALA A   8      48.647  15.189   3.620  1.00  0.00           N
ATOM     55  CA  ALA A   8      49.886  15.550   2.941  1.00  0.00           C
ATOM     56  C   ALA A   8      51.076  15.468   3.892  1.00  0.00           C
ATOM     57  O   ALA A   8      51.196  16.264   4.823  1.00  0.00           O
ATOM     58  CB  ALA A   8      49.776  16.951   2.356  1.00  0.00           C
ATOM     59  N   ALA A  10      55.122  15.615   4.002  1.00  0.00           N
ATOM     60  CA  ALA A  10      56.363  15.948   3.313  1.00  0.00           C
ATOM     61  C   ALA A  10      57.551  15.898   4.269  1.00  0.00           C
ATOM     62  O   ALA A  10      57.671  16.728   5.170  1.00  0.00           O
ATOM     63  CB  ALA A  10      56.258  17.326   2.676  1.00  0.00           C
ATOM     64  N   ASN A  11      58.427  14.919   4.065  1.00  0.00           N
ATOM     65  CA  ASN A  11      59.606  14.759   4.908  1.00  0.00           C
ATOM     66  C   ASN A  11      60.886  14.953   4.102  1.00  0.00           C
ATOM     67  O   ASN A  11      61.222  14.136   3.244  1.00  0.00           O
ATOM     68  CB  ASN A  11      59.609  13.379   5.562  1.00  0.00           C
ATOM     69  CG  ASN A  11      58.532  13.236   6.620  1.00  0.00           C
ATOM     70  OD1 ASN A  11      58.296  14.149   7.410  1.00  0.00           O
ATOM     71  ND2 ASN A  11      57.872  12.083   6.640  1.00  0.00           N
ATOM     72  N   ALA A  12      61.597  16.041   4.383  1.00  0.00           N
ATOM     73  CA  ALA A  12      62.841  16.345   3.686  1.00  0.00           C
ATOM     74  C   ALA A  12      64.025  16.328   4.646  1.00  0.00           C
ATOM     75  O   ALA A  12      64.145  17.191   5.515  1.00  0.00           O
ATOM     76  CB  ALA A  12      62.740  17.698   2.997  1.00  0.00           C
ATOM     77  N   GLN A  13      64.899  15.340   4.481  1.00  0.00           N
ATOM     78  CA  GLN A  13      66.076  15.209   5.332  1.00  0.00           C
ATOM     79  C   GLN A  13      67.359  15.370   4.522  1.00  0.00           C
ATOM     80  O   GLN A  13      67.695  14.521   3.697  1.00  0.00           O
ATOM     81  CB  GLN A  13      66.071  13.849   6.037  1.00  0.00           C
ATOM     82  CG  GLN A  13      67.212  13.651   7.023  1.00  0.00           C
ATOM     83  CD  GLN A  13      67.140  12.317   7.739  1.00  0.00           C
ATOM     84  OE1 GLN A  13      66.251  11.506   7.477  1.00  0.00           O
ATOM     85  NE2 GLN A  13      68.078  12.082   8.650  1.00  0.00           N
ATOM     86  N   ALA A  14      68.071  16.466   4.765  1.00  0.00           N
ATOM     87  CA  ALA A  14      69.318  16.740   4.059  1.00  0.00           C
ATOM     88  C   ALA A  14      70.500  16.757   5.022  1.00  0.00           C
ATOM     89  O   ALA A  14      70.620  17.652   5.859  1.00  0.00           O
ATOM     90  CB  ALA A  14      69.222  18.067   3.320  1.00  0.00           C
ATOM     91  N   LEU A  15      71.372  15.761   4.897  1.00  0.00           N
ATOM     92  CA  LEU A  15      72.547  15.660   5.755  1.00  0.00           C
ATOM     93  C   LEU A  15      73.832  15.788   4.943  1.00  0.00           C
ATOM     94  O   LEU A  15      74.168  14.907   4.151  1.00  0.00           O
ATOM     95  CB  LEU A  15      72.541  14.325   6.508  1.00  0.00           C
ATOM     96  CG  LEU A  15      71.415  14.114   7.526  1.00  0.00           C
ATOM     97  CD1 LEU A  15      71.462  12.699   8.081  1.00  0.00           C
ATOM     98  CD2 LEU A  15      71.487  15.136   8.654  1.00  0.00           C
ATOM     99  N   ALA A  16      74.546  16.890   5.146  1.00  0.00           N
ATOM    100  CA  ALA A  16      75.795  17.135   4.434  1.00  0.00           C
ATOM    101  C   ALA A  16      76.975  17.185   5.399  1.00  0.00           C
ATOM    102  O   ALA A  16      77.095  18.110   6.202  1.00  0.00           O
ATOM    103  CB  ALA A  16      75.704  18.434   3.646  1.00  0.00           C
ATOM    104  N   PHE A  17      77.845  16.184   5.313  1.00  0.00           N
ATOM    105  CA  PHE A  17      79.018  16.111   6.177  1.00  0.00           C
ATOM    106  C   PHE A  17      80.304  16.206   5.364  1.00  0.00           C
ATOM    107  O   PHE A  17      80.640  15.296   4.606  1.00  0.00           O
ATOM    108  CB  PHE A  17      79.005  14.807   6.980  1.00  0.00           C
ATOM    109  CG  PHE A  17      77.889  14.721   7.981  1.00  0.00           C
ATOM    110  CD1 PHE A  17      77.992  15.351   9.210  1.00  0.00           C
ATOM    111  CD2 PHE A  17      76.735  14.009   7.693  1.00  0.00           C
ATOM    112  CE1 PHE A  17      76.966  15.272  10.133  1.00  0.00           C
ATOM    113  CE2 PHE A  17      75.706  13.927   8.612  1.00  0.00           C
ATOM    114  CZ  PHE A  17      75.822  14.560   9.833  1.00  0.00           C
ATOM    115  N   ALA A  18      81.021  17.314   5.528  1.00  0.00           N
ATOM    116  CA  ALA A  18      82.272  17.529   4.810  1.00  0.00           C
ATOM    117  C   ALA A  18      83.450  17.613   5.775  1.00  0.00           C
ATOM    118  O   ALA A  18      83.570  18.567   6.543  1.00  0.00           O
ATOM    119  CB  ALA A  18      82.186  18.797   3.973  1.00  0.00           C
ATOM    120  N   TYR A  19      84.318  16.606   5.729  1.00  0.00           N
ATOM    121  CA  TYR A  19      85.488  16.564   6.598  1.00  0.00           C
ATOM    122  C   TYR A  19      86.777  16.625   5.785  1.00  0.00           C
ATOM    123  O   TYR A  19      87.113  15.687   5.063  1.00  0.00           O
ATOM    124  CB  TYR A  19      85.471  15.292   7.450  1.00  0.00           C
ATOM    125  CG  TYR A  19      84.363  15.258   8.479  1.00  0.00           C
ATOM    126  CD1 TYR A  19      83.662  16.411   8.812  1.00  0.00           C
ATOM    127  CD2 TYR A  19      84.016  14.074   9.116  1.00  0.00           C
ATOM    128  CE1 TYR A  19      82.648  16.386   9.751  1.00  0.00           C
ATOM    129  CE2 TYR A  19      83.002  14.039  10.057  1.00  0.00           C
ATOM    130  CZ  TYR A  19      82.323  15.197  10.369  1.00  0.00           C
ATOM    131  OH  TYR A  19      81.313  15.166  11.305  1.00  0.00           O
ATOM    132  N   ALA A  20      87.496  17.737   5.909  1.00  0.00           N
ATOM    133  CA  ALA A  20      88.749  17.922   5.187  1.00  0.00           C
ATOM    134  C   ALA A  20      89.925  18.039   6.151  1.00  0.00           C
ATOM    135  O   ALA A  20      90.046  19.021   6.883  1.00  0.00           O
ATOM    136  CB  ALA A  20      88.668  19.159   4.303  1.00  0.00           C
ATOM    137  N   VAL A  21      90.791  17.030   6.145  1.00  0.00           N
ATOM    138  CA  VAL A  21      91.959  17.017   7.018  1.00  0.00           C
ATOM    139  C   VAL A  21      93.250  17.045   6.207  1.00  0.00           C
ATOM    140  O   VAL A  21      93.585  16.079   5.521  1.00  0.00           O
ATOM    141  CB  VAL A  21      91.967  15.769   7.925  1.00  0.00           C
ATOM    142  CG1 VAL A  21      93.241  15.722   8.760  1.00  0.00           C
ATOM    143  CG2 VAL A  21      90.735  15.749   8.820  1.00  0.00           C
ATOM    144  N   ALA A  22      93.971  18.159   6.291  1.00  0.00           N
ATOM    145  CA  ALA A  22      95.226  18.315   5.565  1.00  0.00           C
ATOM    146  C   ALA A  22      96.400  18.465   6.527  1.00  0.00           C
ATOM    147  O   ALA A  22      96.521  19.473   7.222  1.00  0.00           O
ATOM    148  CB  ALA A  22      95.150  19.517   4.636  1.00  0.00           C
TER
ATOM    149  N   ARG B   1      27.961   0.504   1.988  1.00  0.00           N
ATOM    150  CA  ARG B   1      29.153   0.205   2.773  1.00  0.00           C
ATOM    151  C   ARG B   1      30.420   0.562   2.003  1.00  0.00           C
ATOM    152  O   ARG B   1      30.753  -0.077   1.005  1.00  0.00           O
ATOM    153  CB  ARG B   1      29.180  -1.279   3.156  1.00 10.00           C
ATOM    154  CG  ARG B   1      28.007  -1.729   4.022  1.00 10.00           C
ATOM    155  CD  ARG B   1      28.018  -1.090   5.409  1.00 10.00           C
ATOM    156  NE  ARG B   1      29.183  -1.492   6.201  1.00 10.00           N
ATOM    157  CZ  ARG B   1      29.635  -0.879   7.298  1.00 10.00           C
ATOM    158  NH1 ARG B   1      30.708  -1.364   7.908  1.00 10.00           N
ATOM    159  NH2 ARG B   1      29.046   0.205   7.803  1.00 10.00           N
ATOM    160  N   ALA B   2      31.123   1.587   2.474  1.00  0.00           N
ATOM    161  CA  ALA B   2      32.355   2.031   1.832  1.00  0.00           C
ATOM    162  C   ALA B   2      33.552   1.851   2.758  1.00  0.00           C
ATOM    163  O   ALA B   2      33.675   2.539   3.772  1.00  0.00           O
ATOM    164  CB  ALA B   2      32.231   3.487   1.408  1.00  0.00           C
ATOM    165  N   HIS B   3      34.434   0.922   2.403  1.00  0.00           N
ATOM    166  CA  HIS B   3      35.624   0.650   3.202  1.00  0.00           C
ATOM    167  C   HIS B   3      36.893   0.975   2.422  1.00  0.00           C
ATOM    168  O   HIS B   3      37.227   0.298   1.450  1.00  0.00           O
ATOM    169  CB  HIS B   3      35.644  -0.817   3.640  1.00  0.00           C
ATOM    170  CG  HIS B   3      34.518  -1.190   4.554  1.00  0.00           C
ATOM    171  ND1 HIS B   3      34.311  -0.928   5.866  1.00  0.00           C
ATOM    172  CD2 HIS B   3      33.431  -1.925   4.134  1.00  0.00           N
ATOM    173  CE1 HIS B   3      33.113  -1.504   6.211  1.00  0.00           N
ATOM    174  NE2 HIS B   3      32.603  -2.100   5.148  1.00  0.00           C
ATOM    175  N   ALA B   4      37.598   2.015   2.856  1.00  0.00           N
ATOM    176  CA  ALA B   4      38.832   2.432   2.201  1.00  0.00           C
ATOM    177  C   ALA B   4      40.027   2.284   3.136  1.00  0.00           C
ATOM    178  O   ALA B   4      40.148   3.009   4.124  1.00  0.00           O
ATOM    179  CB  ALA B   4      38.712   3.872   1.723  1.00  0.00           C
ATOM    180  N   ASP B   5      40.907   1.340   2.818  1.00  0.00           N
ATOM    181  CA  ASP B   5      42.094   1.095   3.630  1.00  0.00           C
ATOM    182  C   ASP B   5      43.367   1.388   2.841  1.00  0.00           C
ATOM    183  O   ASP B   5      43.701   0.675   1.896  1.00  0.00           O
ATOM    184  CB  ASP B   5      42.111  -0.354   4.122  1.00  0.00           C
ATOM    185  CG  ASP B   5      43.246  -0.629   5.089  1.00  0.00           C
ATOM    186  OD1 ASP B   5      43.158  -0.186   6.253  1.00  0.00           O
ATOM    187  OD2 ASP B   5      44.227  -1.288   4.683  1.00  0.00           O
ATOM    188  N   ALA B   6      44.072   2.443   3.238  1.00  0.00           N
ATOM    189  CA  ALA B   6      45.309   2.832   2.570  1.00  0.00           C
ATOM    190  C   ALA B   6      46.501   2.716   3.514  1.00  0.00           C
ATOM    191  O   ALA B   6      46.622   3.477   4.474  1.00  0.00           O
ATOM    192  CB  ALA B   6      45.194   4.253   2.039  1.00  0.00           C
ATOM    193  N   GLU B   7      47.380   1.759   3.234  1.00  0.00           N
ATOM    194  CA  GLU B   7      48.565   1.542   4.057  1.00  0.00           C
ATOM    195  C   GLU B   7      49.840   1.802   3.261  1.00  0.00           C
ATOM    196  O   GLU B   7      50.175   1.053   2.344  1.00  0.00           O
ATOM    197  CB  GLU B   7      48.577   0.112   4.604  1.00  0.00           C
ATOM    198  CG  GLU B   7      47.465  -0.180   5.599  1.00  0.00           C
ATOM    199  CD  GLU B   7      47.495  -1.609   6.103  1.00  0.00           C
ATOM    200  OE1 GLU B   7      48.305  -2.409   5.584  1.00  0.00           O
ATOM    201  OE2 GLU B   7      46.711  -1.936   7.018  1.00  0.00           O
ATOM    202  N   ALA B   8      50.547   2.869   3.620  1.00  0.00           N
ATOM    203  CA  ALA B   8      51.786   3.230   2.941  1.00  0.00           C
ATOM    204  C   ALA B   8      52.976   3.148   3.892  1.00  0.00           C
ATOM    205  O   ALA B   8      53.096   3.944   4.823  1.00  0.00           O
ATOM    206  CB  ALA B   8      51.676   4.631   2.356  1.00  0.00           C
ATOM    207  N   ALA B  10      57.022   3.295   4.002  1.00  0.00           N
ATOM    208  CA  ALA B  10      58.263   3.628   3.313  1.00  0.00           C
ATOM    209  C   ALA B  10      59.451   3.578   4.269  1.00  0.00           C
ATOM    210  O   ALA B  10      59.571   4.408   5.170  1.00  0.00           O
ATOM    211  CB  ALA B  10      58.158   5.006   2.676  1.00  0.00           C
ATOM    212  N   ASN B  11      60.327   2.599   4.065  1.00  0.00           N
ATOM    213  CA  ASN B  11      61.506   2.439   4.908  1.00  0.00           C
ATOM    214  C   ASN B  11      62.786   2.633   4.102  1.00  0.00           C
ATOM    215  O   ASN B  11      63.122   1.816   3.244  1.00  0.00           O
ATOM    216  CB  ASN B  11      61.509   1.059   5.562  1.00  0.00           C
ATOM    217  CG  ASN B  11      60.432   0.916   6.620  1.00  0.00           C
ATOM    218  OD1 ASN B  11      60.252   1.957   7.425  1.00  0.00           N
ATOM    219  ND2 ASN B  11      59.769  -0.116   6.713  1.00  0.00           O
ATOM    220  N   ALA B  12      63.497   3.721   4.383  1.00  0.00           N
ATOM    221  CA  ALA B  12      64.741   4.025   3.686  1.00  0.00           C
ATOM    222  C   ALA B  12      65.925   4.008   4.646  1.00  0.00           C
ATOM    223  O   ALA B  12      66.045   4.871   5.515  1.00  0.00           O
ATOM    224  CB  ALA B  12      64.640   5.378   2.997  1.00  0.00           C
ATOM    225  N   GLN B  13      66.799   3.020   4.481  1.00  0.00           N
ATOM    226  CA  GLN B  13      67.976   2.889   5.332  1.00  0.00           C
ATOM    227  C   GLN B  13      69.259   3.050   4.522  1.00  0.00           C
ATOM    228  O   GLN B  13      69.595   2.201   3.697  1.00  0.00           O
ATOM    229  CB  GLN B  13      67.971   1.529   6.037  1.00  0.00           C
ATOM    230  CG  GLN B  13      69.112   1.331   7.023  1.00  0.00           C
ATOM    231  CD  GLN B  13      69.040  -0.003   7.739  1.00  0.00           C
ATOM    232  OE1 GLN B  13      68.046  -0.811   7.388  1.00  0.00           N
ATOM    233  NE2 GLN B  13      69.869  -0.305   8.598  1.00  0.00           O
ATOM    234  N   ALA B  14      69.971   4.146   4.765  1.00  0.00           N
ATOM    235  CA  ALA B  14      71.218   4.420   4.059  1.00  0.00           C
ATOM    236  C   ALA B  14      72.400   4.437   5.022  1.00  0.00           C
ATOM    237  O   ALA B  14      72.520   5.332   5.859  1.00  0.00           O
ATOM    238  CB  ALA B  14      71.122   5.747   3.320  1.00  0.00           C
ATOM    239  N   LEU B  15      73.272   3.441   4.897  1.00  0.00           N
ATOM    240  CA  LEU B  15      74.447   3.340   5.755  1.00  0.00           C
ATOM    241  C   LEU B  15      75.732   3.468   4.943  1.00  0.00           C
ATOM    242  O   LEU B  15      76.068   2.587   4.151  1.00  0.00           O
ATOM    243  CB  LEU B  15      74.441   2.005   6.508  1.00  0.00           C
ATOM    244  CG  LEU B  15      73.315   1.794   7.526  1.00  0.00           C
ATOM    245  CD1 LEU B  15      72.426   0.619   7.136  1.00  0.00           C
ATOM    246  CD2 LEU B  15      72.491   3.063   7.674  1.00  0.00           C
ATOM    247  N   ALA B  16      76.446   4.570   5.146  1.00  0.00           N
ATOM    248  CA  ALA B  16      77.695   4.815   4.434  1.00  0.00           C
ATOM    249  C   ALA B  16      78.875   4.865   5.399  1.00  0.00           C
ATOM    250  O   ALA B  16      78.995   5.790   6.202  1.00  0.00           O
ATOM    251  CB  ALA B  16      77.604   6.114   3.646  1.00  0.00           C
ATOM    252  N   PHE B  17      79.745   3.864   5.313  1.00  0.00           N
ATOM    253  CA  PHE B  17      80.918   3.791   6.177  1.00  0.00           C
ATOM    254  C   PHE B  17      82.204   3.886   5.364  1.00  0.00           C
ATOM    255  O   PHE B  17      82.540   2.976   4.606  1.00  0.00           O
ATOM    256  CB  PHE B  17      80.905   2.487   6.980  1.00  0.00           C
ATOM    257  CG  PHE B  17      79.789   2.401   7.981  1.00  0.00           C
ATOM    258  CD1 PHE B  17      79.893   3.032   9.211  1.00  0.00           C
ATOM    259  CD2 PHE B  17      78.636   1.690   7.694  1.00  0.00           C
ATOM    260  CE1 PHE B  17      78.868   2.956  10.134  1.00  0.00           C
ATOM    261  CE2 PHE B  17      77.607   1.611   8.614  1.00  0.00           C
ATOM    262  CZ  PHE B  17      77.724   2.244   9.835  1.00  0.00           C
ATOM    263  N   ALA B  18      82.921   4.994   5.528  1.00  0.00           N
ATOM    264  CA  ALA B  18      84.172   5.209   4.810  1.00  0.00           C
ATOM    265  C   ALA B  18      85.350   5.293   5.775  1.00  0.00           C
ATOM    266  O   ALA B  18      85.470   6.247   6.543  1.00  0.00           O
ATOM    267  CB  ALA B  18      84.086   6.477   3.973  1.00  0.00           C
ATOM    268  N   TYR B  19      86.218   4.286   5.729  1.00  0.00           N
ATOM    269  CA  TYR B  19      87.388   4.244   6.598  1.00  0.00           C
ATOM    270  C   TYR B  19      88.677   4.305   5.785  1.00  0.00           C
ATOM    271  O   TYR B  19      89.013   3.367   5.063  1.00  0.00           O
ATOM    272  CB  TYR B  19      87.371   2.972   7.450  1.00  0.00           C
ATOM    273  CG  TYR B  19      86.263   2.938   8.479  1.00  0.00           C
ATOM    274  CD1 TYR B  19      85.564   4.090   8.814  1.00  0.00           C
ATOM    275  CD2 TYR B  19      85.918   1.753   9.118  1.00  0.00           C
ATOM    276  CE1 TYR B  19      84.550   4.063   9.756  1.00  0.00           C
ATOM    277  CE2 TYR B  19      84.907   1.716  10.059  1.00  0.00           C
ATOM    278  CZ  TYR B  19      84.228   2.874  10.374  1.00  0.00           C
ATOM    279  OH  TYR B  19      83.220   2.843  11.312  1.00  0.00           O
ATOM    280  N   ALA B  20      89.396   5.417   5.909  1.00  0.00           N
ATOM    281  CA  ALA B  20      90.649   5.602   5.187  1.00  0.00           C
ATOM    282  C   ALA B  20      91.825   5.719   6.151  1.00  0.00           C
ATOM    283  O   ALA B  20      91.946   6.701   6.883  1.00  0.00           O
ATOM    284  CB  ALA B  20      90.568   6.839   4.303  1.00  0.00           C
ATOM    285  N   VAL B  21      92.691   4.710   6.145  1.00  0.00           N
ATOM    286  CA  VAL B  21      93.859   4.697   7.018  1.00  0.00           C
ATOM    287  C   VAL B  21      95.150   4.725   6.207  1.00  0.00           C
ATOM    288  O   VAL B  21      95.485   3.759   5.521  1.00  0.00           O
ATOM    289  CB  VAL B  21      93.867   3.449   7.925  1.00  0.00           C
ATOM    290  CG1 VAL B  21      95.105   2.602   7.660  1.00  0.00           C
ATOM    291  CG2 VAL B  21      92.599   2.630   7.720  1.00  0.00           C
ATOM    292  N   ALA B  22      95.871   5.839   6.291  1.00  0.00           N
ATOM    293  CA  ALA B  22      97.126   5.995   5.565  1.00  0.00           C
ATOM    294  C   ALA B  22      98.300   6.145   6.527  1.00  0.00           C
ATOM    295  O   ALA B  22      98.421   7.153   7.222  1.00  0.00           O
ATOM    296  CB  ALA B  22      97.050   7.197   4.636  1.00  0.00           C
TER
  """
  h = iotbx.pdb.input(source_info=None, lines=test_pdb_5).construct_hierarchy()
  anwer_h = iotbx.pdb.input(source_info=None,
                            lines=answer_pdb_str).construct_hierarchy()
  h.write_pdb_file("test_8_before.pdb")

  ncs_inp = iotbx.ncs.input(
    hierarchy=h,
    params=ncs_pars.ncs_search)
  ncs_groups = ncs_inp.get_ncs_restraints_group_list()

  nu.flip_atoms_in_ncs_groups(h, ncs_groups)
  h.write_pdb_file("test_8_result.pdb")
  rmsd_smart = calculate_rmsd_smart(anwer_h, h)
  print(rmsd_smart)
  assert rmsd_smart < 0.01


if __name__=='__main__':
  test_1()
  test_2()
  # test_3() intentional, see docstring in the test.
  test_4()
  test_5()
  test_6()
  test_7()
  test_8()
  print("OK")


 *******************************************************************************


 *******************************************************************************
mmtbx/regression/ncs/tst_ncs_utils.py
from __future__ import absolute_import, division, print_function
from libtbx.test_utils import approx_equal
from scitbx.array_family import flex
import mmtbx.ncs.ncs_utils as nu
import mmtbx.maps.correlation
from scitbx import matrix
import iotbx.ncs as ncs
import iotbx.pdb
import unittest
import math
from six.moves import map

__author__ = 'Youval'

pdb_answer_0 = """\
CRYST1   18.415   14.419   12.493  90.00  90.00  90.00 P 1
ATOM      1  N   THR A   1      11.782  12.419   4.645  1.00 10.00           N
ATOM      2  CA  THR A   1      11.671  11.061   4.125  1.00 10.00           C
ATOM      3  C   THR A   1      11.746  10.033   5.249  1.00 10.00           C
ATOM      4  O   THR A   1      12.561  10.157   6.163  1.00 10.00           O
ATOM      5  CB  THR A   1      12.772  10.760   3.092  1.00 10.00           C
ATOM      6  OG1 THR A   1      12.672  11.682   2.000  1.00 10.00           O
ATOM      7  CG2 THR A   1      12.635   9.340   2.565  1.00 10.00           C
TER
ATOM      1  N   THR B   1       6.768   9.093   9.237  1.00 10.00           N
ATOM      2  CA  THR B   1       7.284   8.654   7.945  1.00 10.00           C
ATOM      3  C   THR B   1       8.638   7.968   8.097  1.00 10.00           C
ATOM      4  O   THR B   1       9.495   8.426   8.852  1.00 10.00           O
ATOM      5  CB  THR B   1       7.423   9.832   6.963  1.00 10.00           C
ATOM      6  OG1 THR B   1       6.144  10.446   6.765  1.00 10.00           O
ATOM      7  CG2 THR B   1       7.962   9.350   5.625  1.00 10.00           C
TER
ATOM      1  N   THR C   1       9.093   2.000  10.493  1.00 10.00           N
ATOM      2  CA  THR C   1       8.879   2.702   9.233  1.00 10.00           C
ATOM      3  C   THR C   1      10.081   3.570   8.875  1.00 10.00           C
ATOM      4  O   THR C   1      10.652   4.241   9.734  1.00 10.00           O
ATOM      5  CB  THR C   1       7.618   3.584   9.284  1.00 10.00           C
ATOM      6  OG1 THR C   1       6.472   2.770   9.559  1.00 10.00           O
ATOM      7  CG2 THR C   1       7.417   4.305   7.960  1.00 10.00           C
END
"""

pdb_poor_0 = """\
CRYST1   18.415   14.419   12.493  90.00  90.00  90.00 P 1
ATOM      1  N   THR A   1      11.120  12.388   4.399  1.00 10.00           N
ATOM      2  CA  THR A   1      11.623  11.024   4.280  1.00 10.00           C
ATOM      3  C   THR A   1      12.335  10.587   5.556  1.00 10.00           C
ATOM      4  O   THR A   1      13.094  11.353   6.149  1.00 10.00           O
ATOM      5  CB  THR A   1      12.588  10.881   3.089  1.00 10.00           C
ATOM      6  OG1 THR A   1      11.911  11.230   1.876  1.00 10.00           O
ATOM      7  CG2 THR A   1      13.099   9.452   2.986  1.00 10.00           C
TER
ATOM      8  N   THR B   1       7.221   8.778   9.110  1.00 10.00           N
ATOM      9  CA  THR B   1       7.661   8.575   7.734  1.00 10.00           C
ATOM     10  C   THR B   1       9.058   7.965   7.687  1.00 10.00           C
ATOM     11  O   THR B   1       9.944   8.359   8.445  1.00 10.00           O
ATOM     12  CB  THR B   1       7.660   9.895   6.941  1.00 10.00           C
ATOM     13  OG1 THR B   1       6.338  10.446   6.927  1.00 10.00           O
ATOM     14  CG2 THR B   1       8.122   9.659   5.511  1.00 10.00           C
TER
ATOM     15  N   THR C   1       8.639   1.605   9.684  1.00 10.00           N
ATOM     16  CA  THR C   1       8.751   2.735   8.769  1.00 10.00           C
ATOM     17  C   THR C   1      10.144   3.354   8.827  1.00 10.00           C
ATOM     18  O   THR C   1      10.716   3.520   9.904  1.00 10.00           O
ATOM     19  CB  THR C   1       7.704   3.820   9.080  1.00 10.00           C
ATOM     20  OG1 THR C   1       6.388   3.265   8.969  1.00 10.00           O
ATOM     21  CG2 THR C   1       7.842   4.986   8.114  1.00 10.00           C
END
"""

class Test_ncs_utils(unittest.TestCase):
  """
  Consider R = Rx(alpha)Ry(beta)Rz(gamma)

  Test the conversion of rotation angles to rotation matrix
  and the rotation matrix to angle
  """
  def setUp(self):
    # set_test_matrix
    self.rot1 = flex.vec3_double([
      (-0.317946, -0.173437, 0.932111),
      ( 0.760735, -0.633422, 0.141629),
      ( 0.565855,  0.754120, 0.333333)])
    self.rot2 = flex.vec3_double([
      (0       ,  0       , 1),
      (0.784042, -0.620708, 0),
      (0.620708,  0.784042, 0)])
    self.rot3 = flex.vec3_double([
      ( 0       ,  0       , -1),
      ( 0.097445, -0.995241,  0),
      (-0.995241, -0.097445,  0)])
    # Angles for rot, in radians
    self.rot_angles1 = flex.double(
      (-0.4017753, 1.2001985, 2.6422171))
    self.rot_angles2 = flex.double(
      (-0.4017753, math.pi/2, 2.6422171))
    self.rot_angles3 = flex.double(
      (-0.4017753, -math.pi/2, 2.6422171))
    self.rot_angles1_deg = flex.double(
      (-0.4017753, 1.2001985, 2.6422171)) * 180/math.pi

  def test_matrix_to_angles(self):
    """
    Note that there are two possible sets of angles for a rotation
    matrix.
    Also note that for the cases where cos(beta)=0, there is no unique
    answer
    """
    # print sys._getframe().f_code.co_name
    r = self.rot1.as_double()
    expected_angles = self.rot_angles1
    angles = nu.rotation_to_angles(rotation=r, deg=False)
    assert approx_equal(expected_angles,angles,1e-3)
    expected_angles = self.rot_angles1_deg
    angles = nu.rotation_to_angles(rotation=r, deg=True)
    assert approx_equal(expected_angles,angles,1e-3)
    # Test cos(beta)=0
    # sin(beta) = 1
    r = self.rot2.as_double()
    # when sin(beta) = 1 the (alpha + gamma) is the solution
    expected_angles_sum = self.rot_angles2[0] + self.rot_angles2[2]
    angles = nu.rotation_to_angles(rotation=r, deg=False)
    angles_sum = angles[0] + angles[2]
    assert approx_equal(expected_angles_sum,angles_sum,1e-3)
    # sin(beta) =  -1
    # when sin(beta) = -1 the (alpha - gamma) is the solution
    expected_angles_sum = self.rot_angles2[0] - self.rot_angles2[2]
    r = self.rot3.as_double()
    angles = nu.rotation_to_angles(rotation=r, deg=False)
    angles_sum = angles[0] - angles[2]
    assert approx_equal(expected_angles_sum,angles_sum,1e-3)

  def test_rotations_are_good(self):
    """
    Make sure that our rotation matrices are good
    """
    # print sys._getframe().f_code.co_name
    for rm in [self.rot1,self.rot2,self.rot3]:
      r = matrix.sqr(rm.as_double())
      assert r.is_r3_rotation_matrix(rms_tolerance=1e-3)

  def test_working_with_tuples(self):
    """
    When working with scitbx matrix.rec or matrix.sqr
    (the form rotation matrices are in)
    the elements of those matrices are available as tuple.

    Verify that we process tuple well
    """
    # print sys._getframe().f_code.co_name
    r = tuple(self.rot1.as_double())
    expected_angles = self.rot_angles1
    angles = nu.rotation_to_angles(rotation=r, deg=False)
    assert approx_equal(expected_angles,angles,1e-3)

  def test_selected_positions(self):
    # print sys._getframe().f_code.co_name

    a=flex.size_t([1,2,5,6,4])
    pos={0,3,4}
    s, d = nu.selected_positions(a,pos)
    assert list(s) == [1,6,4]
    assert list(d) == [2,5]

  def test_remove_items_from_selection(self):
    # print sys._getframe().f_code.co_name
    a=flex.size_t([1,2,5,6,4])
    r = flex.size_t([2,5])
    s = nu.remove_items_from_selection(a,r)
    assert list(s) == [1,6,4]

  def test_get_list_of_best_ncs_copy_map_correlation(self):
    """
    Verifying that we get a list of chain index for the chain with the best
    map correlation
    """
    # print sys._getframe().f_code.co_name

    d_min = 1.0
    pdb_inp = iotbx.pdb.input(lines=pdb_poor_0,source_info=None)
    ncs_inp = ncs.input(hierarchy=pdb_inp.construct_hierarchy())
    ncs_restraints_group_list = ncs_inp.get_ncs_restraints_group_list()

    pdb_inp_poor = iotbx.pdb.input(lines=pdb_poor_0,source_info=None)
    ph_poor = pdb_inp_poor.construct_hierarchy(sort_atoms=False)
    ph_poor.atoms().reset_i_seq()
    xrs_poor = pdb_inp_poor.xray_structure_simple()

    pdb_inp_answer = iotbx.pdb.input(lines=pdb_answer_0,source_info=None)
    ph_answer = pdb_inp_answer.construct_hierarchy()
    ph_answer.atoms().reset_i_seq()
    xrs_answer = pdb_inp_answer.xray_structure_simple()

    fc = xrs_answer.structure_factors(d_min=d_min, algorithm="direct").f_calc()
    fft_map = fc.fft_map(resolution_factor = 0.25)
    fft_map.apply_sigma_scaling()
    map_data = fft_map.real_map_unpadded()

    selections = [flex.size_t([0,1,2,3,4,5,6]),flex.size_t([7,8,9,10,11,12,13]),
                flex.size_t([14,15,16,17,18,19,20])]

    mp = mmtbx.maps.correlation.from_map_and_xray_structure_or_fmodel(
      xray_structure = xrs_poor,
      map_data       = map_data,
      d_min          = d_min)

    cc = mp.cc(selections=selections)

    nu.get_list_of_best_ncs_copy_map_correlation(
      ncs_groups     = ncs_restraints_group_list,
      xray_structure = xrs_poor,
      map_data       = map_data,
      d_min          = d_min)

def run_selected_tests():
  """  Run selected tests

  1) List in "tests" the names of the particular test you want to run
  2) Comment out unittest.main()
  3) Un-comment unittest.TextTestRunner().run(run_selected_tests())
  """
  tests = ['test_transform_update']
  suite = unittest.TestSuite(list(map(Test_ncs_utils,tests)))
  return suite

if __name__=='__main__':
  # use for individual tests
  # unittest.TextTestRunner().run(run_selected_tests())

  # Use to run all tests
  unittest.main(verbosity=0)


 *******************************************************************************


 *******************************************************************************
mmtbx/regression/ncs/tst_restraints.py
from __future__ import absolute_import, division, print_function
from mmtbx import ncs
import mmtbx.ncs.cartesian_restraints
from cctbx.array_family import flex
from libtbx.test_utils import Exception_expected, approx_equal
from libtbx.utils import format_cpu_times
from six.moves import zip
from six.moves import range

def exercise_pair_registry_basic():
  registry = ncs.cartesian_restraints.pair_registry(30, 3)
  assert registry.n_seq() == 30
  assert registry.number_of_additional_isolated_sites == 0
  selection_pairs = registry.selection_pairs()
  assert len(selection_pairs) == 2
  assert list(zip(*selection_pairs[0])) == []
  assert list(zip(*selection_pairs[1])) == []
  registry = ncs.cartesian_restraints.pair_registry(30, 3)
  assert registry.enter(i_seq=0, j_seq=20, j_ncs=1) == (0, 0)
  assert registry.enter(i_seq=0, j_seq=20, j_ncs=1) == (0, 1)
  assert registry.enter(i_seq=20, j_seq=0, j_ncs=1) == (2, 1)
  assert registry.enter(i_seq=20, j_seq=1, j_ncs=1) == (2, 1)
  assert registry.enter(i_seq=21, j_seq=1, j_ncs=1) == (0, 0)
  assert registry.enter(i_seq=21, j_seq=2, j_ncs=1) == (3, 1)
  assert registry.enter(i_seq=0, j_seq=20, j_ncs=2) == (1, 1)
  assert registry.enter(i_seq=0, j_seq=10, j_ncs=2) == (0, 0)
  assert registry.enter(i_seq=0, j_seq=11, j_ncs=2) == (3, 10)
  assert registry.enter(i_seq=0, j_seq=10, j_ncs=2) == (0, 1)
  selection_pairs = registry.selection_pairs()
  assert len(selection_pairs) == 2
  assert list(zip(*selection_pairs[0])) == [(0, 20), (21, 1)]
  assert list(zip(*selection_pairs[1])) == [(0, 10)]
  selection = flex.bool(30, False)
  sel_registry = registry.proxy_select(iselection=selection.iselection())
  selection_pairs = sel_registry.selection_pairs()
  assert len(selection_pairs) == 2
  assert list(zip(*selection_pairs[0])) == []
  assert list(zip(*selection_pairs[1])) == []
  selection = flex.bool(30, True)
  sel_registry = registry
  for i in range(10):
    sel_registry = sel_registry.proxy_select(iselection=selection.iselection())
    selection_pairs = sel_registry.selection_pairs()
    assert len(selection_pairs) == 2
    assert list(zip(*selection_pairs[0])) == [(0, 20), (21, 1)]
    assert list(zip(*selection_pairs[1])) == [(0, 10)]
  selection[0] = False
  sel_registry = registry.proxy_select(iselection=selection.iselection())
  selection_pairs = sel_registry.selection_pairs()
  assert len(selection_pairs) == 2
  assert list(zip(*selection_pairs[0])) == [(20, 0)]
  assert list(zip(*selection_pairs[1])) == []
  selection[0] = True
  selection[1] = False
  sel_registry = registry.proxy_select(iselection=selection.iselection())
  selection_pairs = sel_registry.selection_pairs()
  assert len(selection_pairs) == 2
  assert list(zip(*selection_pairs[0])) == [(0, 19)]
  assert list(zip(*selection_pairs[1])) == [(0, 9)]
  selection[1] = True
  selection[2] = False
  selection[4] = False
  sel_registry = registry.proxy_select(iselection=selection.iselection())
  selection_pairs = sel_registry.selection_pairs()
  assert len(selection_pairs) == 2
  assert list(zip(*selection_pairs[0])) == [(0, 18), (19, 1)]
  assert list(zip(*selection_pairs[1])) == [(0, 8)]
  sel_registry = sel_registry.proxy_select(
    iselection=flex.size_t([0,1,8,18,19,23,27]))
  selection_pairs = sel_registry.selection_pairs()
  assert len(selection_pairs) == 2
  assert list(zip(*selection_pairs[0])) == [(0, 3), (4, 1)]
  assert list(zip(*selection_pairs[1])) == [(0, 2)]
  assert sel_registry.enter(i_seq=0, j_seq=3, j_ncs=1) == (0, 1)
  assert sel_registry.enter(i_seq=0, j_seq=2, j_ncs=1) == (1, 2)
  assert sel_registry.enter(i_seq=3, j_seq=0, j_ncs=1) == (2, 1)
  assert sel_registry.enter(i_seq=0, j_seq=4, j_ncs=1) == (3, 3)
  assert sel_registry.enter(i_seq=6, j_seq=5, j_ncs=1) == (0, 0)
  selection_pairs = sel_registry.selection_pairs()
  assert len(selection_pairs) == 2
  assert list(zip(*selection_pairs[0])) == [(0, 3), (4, 1), (6, 5)]
  assert list(zip(*selection_pairs[1])) == [(0, 2)]
  sel_registry = sel_registry.proxy_select(
    iselection=flex.size_t([0,2,4,1]))
  selection_pairs = sel_registry.selection_pairs()
  assert len(selection_pairs) == 2
  assert list(zip(*selection_pairs[0])) == [(2, 3)]
  assert list(zip(*selection_pairs[1])) == [(0, 1)]
  registry.register_additional_isolated_sites(number=10)
  assert registry.number_of_additional_isolated_sites == 10
  registry.register_additional_isolated_sites(number=3)
  assert registry.number_of_additional_isolated_sites == 13
  selection.resize(43, False)
  sel_registry = registry.proxy_select(iselection=selection.iselection())
  assert sel_registry.number_of_additional_isolated_sites == 0
  selection[35] = True
  sel_registry = registry.proxy_select(iselection=selection.iselection())
  assert sel_registry.number_of_additional_isolated_sites == 1
  selection[38] = True
  selection[42] = True
  sel_registry = registry.proxy_select(iselection=selection.iselection())
  assert sel_registry.number_of_additional_isolated_sites == 3
  selection_pairs = sel_registry.selection_pairs()
  assert len(selection_pairs) == 2
  assert list(zip(*selection_pairs[0])) == [(0, 18), (19, 1)]
  assert list(zip(*selection_pairs[1])) == [(0, 8)]
  #
  iselection = flex.size_t([
    # random permutation with omissions first 30
    8, 10, 6, 12, 20, 15, 16, 22, 11, 23, 14, 27,
    3, 13, 5, 28, 17, 0, 19, 26, 9, 4, 1, 29, 18,
    # random permutation with omissions other 13
    32, 37, 34, 41, 38, 42, 33, 35, 30])
  sel_registry = registry.proxy_select(iselection=iselection)
  assert sel_registry.number_of_additional_isolated_sites == 9
  selection_pairs = sel_registry.selection_pairs()
  assert len(selection_pairs) == 2
  assert list(zip(*selection_pairs[0])) == [(17, 4)]
  assert list(zip(*selection_pairs[1])) == [(17, 1)]
  #
  iselection = flex.size_t([0,1,30])
  sel_registry = registry.proxy_select(iselection=iselection)
  assert sel_registry.number_of_additional_isolated_sites == 1
  iselection = flex.size_t([0,30,1])
  try: registry.proxy_select(iselection=iselection)
  except RuntimeError as e:
    assert str(e).endswith(
      "): MMTBX_ASSERT("
      "result_i_seq < result_n_seq || iselection[result_i_seq] >= n_seq)"
      " failure.")
  else:
    raise Exception_expected

def adp_iso_residual_sum(weight, average_power, u_isos):
  n = u_isos.size()
  u_ave = flex.sum(u_isos) / n
  u_diff = u_isos - u_ave
  return weight * flex.sum_sq(u_diff) / u_ave**average_power

def adp_iso_analytical_gradients(weight, average_power, u_isos):
  """
um = (u1 + u2)/2
r=w*((u1-um)^2+(u2-um)^2)/um^mp
D[r,u1]

um = (u1 + u2 + u3)/3
r=w*((u1-um)^2+(u2-um)^2+(u3-um)^2)/um^mp
D[r,u1]

um = (u1 + u2 + u3 + u4)/4
r=w*((u1-um)^2+(u2-um)^2+(u3-um)^2+(u4-um)^2)/um^mp
D[r,u1]
"""
  n = u_isos.size()
  u_ave = flex.sum(u_isos) / n
  u_diff = u_isos - u_ave
  n_ave_pow = n*u_ave**average_power
  return weight * (  2/n_ave_pow*(u_diff*n-flex.sum(u_diff))
                   - average_power/(n_ave_pow*u_ave)*flex.sum_sq(u_diff))

def adp_iso_finite_difference_gradients(
      weight,
      average_power,
      u_isos,
      eps=1.e-6):
  result = flex.double()
  for i_u_iso in range(u_isos.size()):
    rs = []
    for signed_eps in [eps, -eps]:
      u_isos_eps = u_isos.deep_copy()
      u_isos_eps[i_u_iso] += signed_eps
      r = adp_iso_residual_sum(
        weight=weight, average_power=average_power, u_isos=u_isos_eps)
      rs.append(r)
    result.append((rs[0]-rs[1])/(2*eps))
  return result

def exercise_adp_iso_analytical():
  mersenne_twister = flex.mersenne_twister(seed=0)
  for weight in [1.234, 2.134]:
    for average_power in [0.345, 0.589]:
      for size in range(2,20):
        for i in range(10):
          u_isos = mersenne_twister.random_double(size=size) + 1.e-3
          a = adp_iso_analytical_gradients(
            weight=weight, average_power=average_power, u_isos=u_isos)
          f = adp_iso_finite_difference_gradients(
            weight=weight, average_power=average_power, u_isos=u_isos)
          assert approx_equal(a, f)

def exercise_pair_registry_adp_iso():
  mersenne_twister = flex.mersenne_twister(seed=0)
  for n_seq in range(2,20):
    registry = ncs.cartesian_restraints.pair_registry(n_seq=n_seq, n_ncs=n_seq)
    for j_seq in range(1,n_seq):
      assert registry.enter(i_seq=0, j_seq=j_seq, j_ncs=j_seq) == (0, 0)
    selection_pairs = registry.selection_pairs()
    for j in range(1,n_seq):
      assert list(zip(*selection_pairs[j-1])) == [(0,j)]
    weight = 2.134
    average_power = 0.589
    u_isos = mersenne_twister.random_double(size=n_seq) + 1.e-3
    gradients_in = mersenne_twister.random_double(size=n_seq)
    gradients = gradients_in.deep_copy()
    registry_residual_sum = registry.adp_iso_residual_sum(
      weight=weight,
      average_power=average_power,
      u_isos=u_isos,
      u_average_min=1.e-6,
      gradients=gradients)
    gradients -= gradients_in
    assert approx_equal(
      registry_residual_sum,
      adp_iso_residual_sum(
        weight=weight, average_power=average_power, u_isos=u_isos))
    assert approx_equal(
      gradients,
      adp_iso_analytical_gradients(
        weight=weight, average_power=average_power, u_isos=u_isos))

def exercise():
  exercise_pair_registry_basic()
  exercise_adp_iso_analytical()
  exercise_pair_registry_adp_iso()
  print(format_cpu_times())

if (__name__ == "__main__"):
  exercise()


 *******************************************************************************


 *******************************************************************************
mmtbx/regression/pdb_interpretation/tst_custom_nb_sym_excl.py
from __future__ import absolute_import, division, print_function

from libtbx.test_utils import assert_lines_in_file, assert_lines_not_in_file, assert_lines_in_text
from libtbx import easy_run
import libtbx.load_env
import os

def exercise_01(prefix="tst_custom_nb_sym_excl"):
  fname = libtbx.env.find_in_repositories(
    relative_path="cctbx_project/mmtbx/regression/pdbs/1yjp_h.pdb",
    test=os.path.isfile)
  with open(fname, 'r') as f:
    f_content = f.read()
    f_content = f_content.replace("3.905  1.00 12.26", "3.905  0.33 12.26")
    with open("%s.pdb" % prefix, 'w') as f2:
      f2.write(f_content)

  critical='  nonbonded pdb=" OD1 ASN A   3 "'

  cmd = "mmtbx.pdb_interpretation %s.pdb custom_nonbonded_symmetry_exclusions='resname HOH' custom_nonbonded_symmetry_exclusions='resname HOH and resseq 9' " % prefix
  fb = easy_run.fully_buffered(cmd)
  assert not fb.return_code
  stdout_text = "\n".join(fb.stdout_lines)
  assert_lines_in_text(stdout_text, """\
      WARNING: 1 atom in previous symmetry exclusion group
        Example: pdb=" O   HOH A   9 "
      WARNING: 1 atom with full occupancy
        Example: pdb=" O   HOH A   9 " """)
  assert_lines_in_text(stdout_text, critical)

  cmd = "mmtbx.pdb_interpretation %s.pdb custom_nonbonded_symmetry_exclusions='chain A and resid 3' > %s_2.log" % (prefix, prefix)
  fb = easy_run.fully_buffered(cmd)
  assert not fb.return_code

  assert_lines_not_in_file("%s_2.log" % prefix, critical)
  assert_lines_in_file("%s_2.log" % prefix, """\
      Custom nonbonded symmetry exclusions:
        Atom selection: chain A and resid 3
          Number of atoms selected: 14
          WARNING: 13 atoms with full occupancy
            Example: pdb=" CA  ASN A   3 "
          """)

if(__name__ == "__main__"):
  if libtbx.env.find_in_repositories(relative_path="chem_data") is None:
    print("Skipping exercise_01(): chem_data directory not available")
  else:
    exercise_01()
    print('OK')


 *******************************************************************************


 *******************************************************************************
mmtbx/regression/pdb_interpretation/tst_edits.py
from __future__ import absolute_import, division, print_function
from mmtbx import monomer_library
import mmtbx.monomer_library.server
import mmtbx.monomer_library.pdb_interpretation
import mmtbx.model
from cctbx import geometry_restraints
from cctbx.array_family import flex
from libtbx.test_utils import approx_equal
import iotbx
import sys
from cctbx.geometry_restraints.linking_class import linking_class
origin_ids = linking_class()


raw_records1 = """\
CRYST1   60.800   60.800   97.000  90.00  90.00 120.00 P 32 2 1      6
ORIGX1      1.000000  0.000000  0.000000        0.00000
ORIGX2      0.000000  1.000000  0.000000        0.00000
ORIGX3      0.000000  0.000000  1.000000        0.00000
SCALE1      0.016447  0.009496  0.000000        0.00000
SCALE2      0.000000  0.018992  0.000000        0.00000
SCALE3      0.000000  0.000000  0.010309        0.00000
ATOM   1050  N   LYS A 135      31.992  14.930  -7.233  1.00  9.47           N
ATOM   1051  CA  LYS A 135      31.388  16.216  -7.637  1.00 12.89           C
ATOM   1052  C   LYS A 135      30.807  16.840  -6.406  1.00  6.47           C
ATOM   1053  O   LYS A 135      29.583  16.869  -6.191  1.00 15.74           O
ATOM   1054  CB  LYS A 135      30.263  16.059  -8.655  1.00 13.51           C
ATOM   1055  CG  LYS A 135      30.742  15.277  -9.843  1.00 16.23           C
ATOM   1056  CD  LYS A 135      29.612  15.131 -10.835  1.00 28.55           C
ATOM   1057  CE  LYS A 135      30.173  14.812 -12.216  1.00 34.52           C
ATOM   1058  NZ  LYS A 135      29.396  13.756 -12.899  1.00 46.18           N
TER    1294      LYS A 162
END

""".splitlines()

def make_initial_grm(mon_lib_srv, ener_lib, records, params_edits):
  processed_pdb_file = monomer_library.pdb_interpretation.process(
    mon_lib_srv    = mon_lib_srv,
    ener_lib       = ener_lib,
    # params         = params,
    raw_records    = records,
    force_symmetry = True,
    # log = sys.stdout,
    )

  geometry = processed_pdb_file.geometry_restraints_manager(
    show_energies      = True,
    params_edits       = params_edits,
    plain_pairs_radius = 5.0,
    )
  xrs = processed_pdb_file.xray_structure()
  return geometry, xrs

def exercise_user_edits(mon_lib_srv, ener_lib):
  """
  exercise functions for managing geometry_restraints.edits scope for
  user-supplied restraints.
  """
  params_edits_str = """
    excessive_bond_distance_limit = 10
    bond {
      action = *add delete change
      atom_selection_1 = name CB
      atom_selection_2 = name CE
      symmetry_operation = None
      distance_ideal = 4
      sigma = 0.2
      slack = None
    }
    angle {
      action = *add delete change
      atom_selection_1 = name CB
      atom_selection_2 = name CD
      atom_selection_3 = name NZ
      angle_ideal = 120
      sigma = 3
    }
    dihedral {
      action = *add delete change
      atom_selection_1 = name C
      atom_selection_2 = name CA
      atom_selection_3 = name CB
      atom_selection_4 = name CG
      angle_ideal = 90
      sigma = 10
      periodicity = 1
    }
    planarity {
      action = *add delete change
      atom_selection = name CB or name CD or name CE
      sigma = 0.2
    }
    parallelity {
      action = *add delete change
      atom_selection_1 = name N or name CA or name O
      atom_selection_2 = name CB or name CD or name NZ
      sigma = 0.027
      target_angle_deg = 0
    }  """
  master_phil = iotbx.phil.parse(
      mmtbx.monomer_library.pdb_interpretation.geometry_restraints_edits_str)
  user_phil = iotbx.phil.parse(params_edits_str)
  working_phil = master_phil.fetch(sources=[user_phil])
  # working_phil.show()

  wp_extract = working_phil.extract()
  # print wp_extract.bond[0].atom_selection_1
  # STOP()
  # edits = None
  geometry, xrs = make_initial_grm(mon_lib_srv, ener_lib, raw_records1, wp_extract)
  # Check the .geo file
  geo_fname = "pdb_interpretation_tst_edits_exercise_user_edits.geo"
  geometry.write_geo_file(file_name=geo_fname, site_labels=xrs.scatterers().extract_labels())
  with open(geo_fname, 'r') as f:
    user_suppl_count = 0
    for l in f.readlines():
      if l.find("| User supplied |")>-1:
        user_suppl_count += 1
    # Right now user-supplied planarity is missing from the .geo file.
    assert user_suppl_count == 5, "Expected 5 user-supplied restraints, got %i in the .geo" % user_suppl_count

  # initial
  assert geometry.pair_proxies().bond_proxies.simple.size() == 9
  assert geometry.pair_proxies().bond_proxies.asu.size() == 0
  assert geometry.angle_proxies.size() == 9
  assert geometry.dihedral_proxies.size() == 7
  assert geometry.planarity_proxies.size() == 1
  assert geometry.parallelity_proxies.size() == 1

  ubonds_simpe, ubonds_asu, uangles, udihedrals, uplanarity, uparallelity = \
      geometry.get_user_supplied_restraints()
  assert ubonds_simpe.size() == 1
  assert ubonds_asu.size() == 0
  assert uangles.size() == 1
  assert udihedrals.size() == 1
  assert uplanarity.size() == 1
  assert uparallelity.size() == 1
  # make sure geometry stays the same
  assert geometry.pair_proxies().bond_proxies.simple.size() == 9
  assert geometry.pair_proxies().bond_proxies.asu.size() == 0
  assert geometry.angle_proxies.size() == 9
  assert geometry.dihedral_proxies.size() == 7
  assert geometry.planarity_proxies.size() == 1
  assert geometry.parallelity_proxies.size() == 1
  # test functions one by one
  simple, asu = geometry.get_bond_proxies_without_user_supplied()
  assert simple.size() == 8
  assert asu.size() == 0
  angle = geometry.get_angle_proxies_without_user_supplied()
  assert angle.size() == 8
  dihed = geometry.get_dihedral_proxies_without_user_supplied()
  assert dihed.size() == 6
  plan = geometry.get_planarity_proxies_without_user_supplied()
  assert plan.size() == 0
  par = geometry.get_parallelity_proxies_without_user_supplied()
  assert par.size() == 0
  # make sure geometry stays the same
  assert geometry.pair_proxies().bond_proxies.simple.size() == 9
  assert geometry.pair_proxies().bond_proxies.asu.size() == 0
  assert geometry.angle_proxies.size() == 9
  assert geometry.planarity_proxies.size() == 1
  assert geometry.parallelity_proxies.size() == 1

raw_records2 = """\
CRYST1   17.963   15.643   19.171  90.00  90.00  90.00 P 1
SCALE1      0.055670  0.000000  0.000000        0.00000
SCALE2      0.000000  0.063926  0.000000        0.00000
SCALE3      0.000000  0.000000  0.052162        0.00000
HETATM    1  N   ALA A   1      12.431   5.924  12.511  1.00 20.00      A    N
HETATM    2  CA  ALA A   1      11.018   6.145  12.230  1.00 20.00      A    C
HETATM    3  C   ALA A   1      10.790   7.554  11.693  1.00 20.00      A    C
HETATM    4  O   ALA A   1      11.665   8.411  11.803  1.00 20.00      A    O
HETATM    5  CB  ALA A   1      10.187   5.914  13.482  1.00 20.00      A    C
HETATM   13  N   ALA A   2       9.597   7.776  11.142  1.00 20.00      A    N
HETATM   14  CA  ALA A   2       9.208   9.039  10.514  1.00 20.00      A    C
HETATM   15  C   ALA A   2       8.148   8.584   9.515  1.00 20.00      A    C
HETATM   16  O   ALA A   2       7.467   7.584   9.741  1.00 20.00      A    O
HETATM   17  CB  ALA A   2      10.376   9.748   9.832  1.00 20.00      A    C
HETATM   23  N   ALA A   3       8.007   9.313   8.411  1.00 20.00      A    N
HETATM   24  CA  ALA A   3       7.032   8.963   7.385  1.00 20.00      A    C
HETATM   25  C   ALA A   3       7.369   9.651   6.067  1.00 20.00      A    C
HETATM   26  O   ALA A   3       8.098  10.643   6.037  1.00 20.00      A    O
HETATM   27  CB  ALA A   3       5.630   9.338   7.836  1.00 20.00      A    C
HETATM   28  OXT ALA A   3       6.921   9.231   5.000  1.00 20.00      A    O1-
""".splitlines()

def exercise_angle_edits_change(mon_lib_srv, ener_lib):
  edits = """\
refinement.geometry_restraints.edits {
  n_2_selection = chain A and resname ALA and resid 2 and name N
  ca_2_selection = chain A and resname ALA and resid 2 and name CA
  c_2_selection = chain A and resname ALA and resid 2 and name C
  angle {
    action = *change
    atom_selection_1 = $n_2_selection
    atom_selection_2 = $ca_2_selection
    atom_selection_3 = $c_2_selection
    angle_ideal = 100.00
    sigma = 5
  }
}"""
  gm_phil = iotbx.phil.parse(
      monomer_library.pdb_interpretation.grand_master_phil_str,
      process_includes=True)
  edits_phil = iotbx.phil.parse(edits)
  working_phil = gm_phil.fetch(edits_phil)
  params = working_phil.extract()
  # print params.geometry_restraints.edits.parallelity[0].atom_selection_1
  assert params.geometry_restraints.edits.angle[0].atom_selection_1.find("name N")
  processed_pdb_file = monomer_library.pdb_interpretation.process(
      mon_lib_srv=mon_lib_srv,
      ener_lib=ener_lib,
      file_name=None,
      raw_records=raw_records2,
      params = params.pdb_interpretation,
      log=None)
  grm = processed_pdb_file.geometry_restraints_manager(
      params_edits=params.geometry_restraints.edits,
      params_remove=params.geometry_restraints.remove)
  assert grm.angle_proxies.size() == 20
  user_defined = grm.angle_proxies.proxy_select(origin_id=origin_ids.get_origin_id('edits'))
  assert user_defined.size() == 1
  udp = user_defined[0]
  assert list(udp.i_seqs) == [5,6,7]
  assert approx_equal(udp.angle_ideal, 100, eps=1e-4)
  assert approx_equal(udp.weight, 0.04, eps=1e-4)

  from libtbx.test_utils import open_tmp_file
  from libtbx import easy_run
  pdb_file = open_tmp_file(suffix="aaa.pdb")
  pdb_file.write('\n'.join(raw_records2))
  pdb_file.close()
  edits_file = open_tmp_file(suffix="tau.edits")
  edits_file.write(edits)
  edits_file.close()
  cmd = "phenix.pdb_interpretation \"%s\" \"%s\" write_geo_files=True" %(
    pdb_file.name, edits_file.name)
  result = easy_run.fully_buffered(cmd).raise_if_errors()
  geo_file = open(pdb_file.name+'.geo', "r")
  # geo_file = open(pdb_file.name.replace(".pdb", '_minimized.geo'), "r")
  geo_file_str = geo_file.read()
  assert '''| User supplied | restraints: 1
Sorted by residual:
angle pdb=" N   ALA A   2 " segid="A   "
      pdb=" CA  ALA A   2 " segid="A   "
      pdb=" C   ALA A   2 " segid="A   "
    ideal   model   delta    sigma   weight residual
   100.00''' in geo_file_str

def exercise_dihedral_edits_change():
  edits = """\
geometry_restraints.edits {
  dihedral {
    action = *change
    atom_selection_1 = resid 1 and name CA
    atom_selection_2 = resid 1 and name C
    atom_selection_3 = resid 2 and name N
    atom_selection_4 = resid 2 and name CA
    angle_ideal = 100.00
    alt_angle_ideals = 90,110
    sigma = 2
    periodicity = 2
  }
}"""
  def_params = mmtbx.model.manager.get_default_pdb_interpretation_scope()
  edits_phil = iotbx.phil.parse(edits)
  working_phil = def_params.fetch(edits_phil)
  params = working_phil.extract()
  inp = iotbx.pdb.input(lines=raw_records2, source_info=None)
  model = mmtbx.model.manager(model_input = inp)
  model.process(make_restraints=True)
  grm = model.get_restraints_manager().geometry
  assert grm.dihedral_proxies.size() == 9
  dih1 = grm.dihedral_proxies.proxy_select(
      n_seq=model.get_number_of_atoms(),
      iselection=flex.size_t([1,2,5,6]))
  assert dih1.size() == 1
  dp1 = dih1[0]
  assert approx_equal(dp1.angle_ideal, 180)
  assert dp1.alt_angle_ideals == None
  assert dp1.origin_id == 0
  assert dp1.periodicity == 0
  assert dp1.slack == 0
  assert not dp1.top_out
  assert approx_equal(dp1.weight, 0.04)

  # Now with modifications
  inp = iotbx.pdb.input(lines=raw_records2, source_info=None)
  model2 = mmtbx.model.manager(model_input = inp)
  model2.process(pdb_interpretation_params=params,
    make_restraints=True)
  grm2 = model2.get_restraints_manager().geometry
  assert grm2.dihedral_proxies.size() == 9
  dih2 = grm2.dihedral_proxies.proxy_select(
      n_seq=model2.get_number_of_atoms(),
      iselection=flex.size_t([1,2,5,6]))
  assert dih2.size() == 1
  dp2 = dih2[0]
  assert approx_equal(dp2.angle_ideal, 100)
  assert dp2.alt_angle_ideals == (90,110)
  assert dp2.origin_id == origin_ids.get_origin_id('edits')
  assert dp2.periodicity == 2
  assert dp2.slack == 0
  assert not dp2.top_out
  assert approx_equal(dp2.weight, 0.25)

def exercise():
  mon_lib_srv = None
  ener_lib = None
  try:
    mon_lib_srv = monomer_library.server.server()
    ener_lib = monomer_library.server.ener_lib()
  except: # intentional
    print("Can not initialize monomer_library, skipping test.")
  if mon_lib_srv is not None and ener_lib is not None:
    exercise_user_edits(mon_lib_srv, ener_lib)
    exercise_angle_edits_change(mon_lib_srv, ener_lib)
    exercise_dihedral_edits_change()

if (__name__ == "__main__"):
  exercise()
  print("OK")


 *******************************************************************************


 *******************************************************************************
mmtbx/regression/pdb_interpretation/tst_edits_actions.py
from __future__ import absolute_import, division, print_function
import os, time
from libtbx import easy_run
from libtbx.test_utils import assert_lines_in_file

# QUESTION: if we try to change something that is not there shall we Sorry or
# do actualy change "nothing" with something that is provided?
# Depending on the asnwer: check for expected lines using assert_lines_in_file or
# check for expected Sorry in r.stderr_lines[0] .
# ANSWER: For ALL edits the behavior is following:
# add when restraint is there - Sorry
# change when restraint is not there - Sorry.

pdb_str = """\
CRYST1   18.319   14.631   14.035  90.00  90.00  90.00 P 1
ATOM      1  N   ILE A   7       7.541   5.492   8.708  1.00 27.82           N
ATOM      2  CA  ILE A   7       8.118   5.291   7.390  1.00 27.92           C
ATOM      3  C   ILE A   7       9.585   5.691   7.394  1.00 26.95           C
ATOM      4  O   ILE A   7      10.426   5.000   6.823  1.00 27.42           O
ATOM      5  CB  ILE A   7       7.326   6.122   6.344  1.00 28.34           C
ATOM      6  CG1 ILE A   7       5.922   5.540   6.179  1.00 29.61           C
ATOM      7  CG2 ILE A   7       8.046   6.109   5.000  1.00 29.41           C
ATOM      8  CD1 ILE A   7       5.000   6.390   5.343  1.00 30.63           C
TER
END
"""

cmd_base = "phenix.pdb_interpretation write_geo=true %s.pdb %s.eff"

def run_bond(prefix):
  edits = """
refinement {
  geometry_restraints.edits {
    bond {
      action = %s
      atom_selection_1 = %s
      atom_selection_2 = %s
      distance_ideal = 2.0
      sigma = 1.0
    }
  }
}
"""
  sel_old_1 = "chain A and resseq 7 and name C"
  sel_old_2 = "chain A and resseq 7 and name O"
  sel_new_1 = "chain A and resseq 7 and name CA"
  sel_new_2 = "chain A and resseq 7 and name O"
  cntr=0
  for action in ["add","delete","change"]:
    for kind in ["new","old"]:
      prefix_ = "%s_bond_%s_%s"%(prefix, kind, action)
      with open("%s.eff"%prefix_, "w") as f:
        f.write(edits%(action, eval("sel_%s_1"%kind), eval("sel_%s_2"%kind)))
      cmd = cmd_base%(prefix, prefix_)
      print (cmd)
      r = easy_run.fully_buffered(cmd)
      if action == "delete":
        cntr+=1
        assert r.stderr_lines[0] == \
            'Sorry: geometry_restraints.edits.bond.action = delete not implemented.'
      else:
        if kind == "new":
          if action == 'add':
            cntr+=1
            assert_lines_in_file(
                file_name = "%s.pdb.geo"%prefix,
                lines     = """bond pdb=" CA  ILE A   7 "
                             pdb=" O   ILE A   7 "
                          ideal  model  delta    sigma   weight residual
                          2.000  2.394 -0.394 1.00e+00 1.00e+00 1.56e-01""")
          elif action == 'change':
            cntr += 1
            assert r.stderr_lines[0] == "Sorry: Bond below does not exists, use action=add instead."
        elif(kind == "old"):
          if action == 'add':
            cntr += 1
            assert r.stderr_lines[0] == "Sorry: Bond below exists, use action=change instead."
          elif action == 'change':
            cntr+=1
            assert_lines_in_file(
                file_name = "%s.pdb.geo"%prefix,
                lines     = """bond pdb=" C   ILE A   7 "
                                  pdb=" O   ILE A   7 "
                          ideal  model  delta    sigma   weight residual
                          2.000  1.229  0.771 1.00e+00 1.00e+00 5.94e-01""")
  assert cntr==6

def run_angle(prefix):
  edits = """
refinement {
  geometry_restraints.edits {
    angle {
      action = %s
      atom_selection_1 = %s
      atom_selection_2 = %s
      atom_selection_3 = %s
      angle_ideal = 10
      sigma = 1
    }
  }
}
"""
  sel_old_1 = "chain A and resseq 7 and name N"
  sel_old_2 = "chain A and resseq 7 and name CA"
  sel_old_3 = "chain A and resseq 7 and name CB"
  sel_new_1 = "chain A and resseq 7 and name N"
  sel_new_2 = "chain A and resseq 7 and name CA"
  sel_new_3 = "chain A and resseq 7 and name CG2"
  cntr=0
  for action in ["add","delete","change"]:
    for kind in ["new","old"]:
      prefix_ = "%s_angle_%s_%s"%(prefix, kind, action)
      with open("%s.eff"%prefix_, "w") as f:
        f.write(edits%(action, eval("sel_%s_1"%kind),
                               eval("sel_%s_2"%kind),
                               eval("sel_%s_3"%kind)))
      cmd = cmd_base%(prefix, prefix_)
      print (cmd)
      r = easy_run.fully_buffered(cmd)
      if action == "add":
        if kind == "new":
          cntr+=1
          assert_lines_in_file(
              file_name = "%s.pdb.geo"%prefix,
              lines     = """
angle pdb=" N   ILE A   7 "
      pdb=" CA  ILE A   7 "
      pdb=" CG2 ILE A   7 "
    ideal   model   delta    sigma   weight residual
    10.00  143.31 -133.31 1.00e+00 1.00e+00 1.78e+04""")
        elif kind == "old":
          cntr+=1
          assert r.stderr_lines[0] == \
              "Sorry: Some (1) restraints were not added because they are already present."
      if action == "delete":
        cntr+=1
        assert r.stderr_lines[0] == \
            'Sorry: geometry_restraints.edits.angle.action = delete not implemented.'
      if action == "change":
        if kind == "new":
          cntr+=1
          assert r.stderr_lines[0] == \
              'Sorry: Angle below is not restrained, nothing to change.'
        elif kind == "old":
          cntr+=1
          assert_lines_in_file(
              file_name = "%s.pdb.geo"%prefix,
              lines     = """
angle pdb=" N   ILE A   7 "
      pdb=" CA  ILE A   7 "
      pdb=" CB  ILE A   7 "
    ideal   model   delta    sigma   weight residual
    10.00  109.54  -99.54 1.00e+00 1.00e+00 9.91e+03""")
  assert cntr==6


def run(prefix = os.path.basename(__file__).replace(".py","")):
  """
  Test edits: add/delete/change actions for bonds and angles.
  TODO: add dihedral
  """
  with open("%s.pdb"%prefix, "w") as f:
    f.write(pdb_str)
  run_bond(prefix)
  run_angle(prefix)

if (__name__ == "__main__"):
  t0 = time.time()
  run()
  print("Time: %5.2f"%(time.time()-t0))
  print("OK")


 *******************************************************************************


 *******************************************************************************
mmtbx/regression/pdb_interpretation/tst_tardy_geo.py
from __future__ import absolute_import, division, print_function

from mmtbx.regression import model_1yjp
from libtbx.test_utils import assert_lines_in_file, assert_lines_not_in_file
from libtbx import easy_run
import libtbx.load_env

def exercise_01(prefix="tst_tardy_geo"):
  fname = "%s.pdb" % prefix
  with open(fname, 'w') as f:
    f.write(model_1yjp)
  cmd = "mmtbx.pdb_interpretation %s write_geo_files=True write_tardy_geo_files=True" % fname
  assert not easy_run.call(cmd)
  assert_lines_in_file(file_name="%s.pdb.geo" % prefix, lines="Bond | covalent geometry | restraints: 59")
  assert_lines_not_in_file(file_name="%s.pdb.tardy.geo" % prefix, lines="Bond restraints")

if(__name__ == "__main__"):
  if libtbx.env.find_in_repositories(relative_path="chem_data") is None:
    print("Skipping exercise_01(): chem_data directory not available")
  else:
    exercise_01()
    print('OK')


 *******************************************************************************


 *******************************************************************************
mmtbx/regression/pdb_interpretation/tst_using_ncs_1.py
from __future__ import absolute_import, division, print_function

import iotbx.pdb
import mmtbx.model
import libtbx.load_env
from libtbx.test_utils import show_diff, assert_lines_in_text
from six.moves import cStringIO as StringIO

pdb_str1 = """\
ATOM      1  N   GLY A   1      12.928   4.612   6.102  1.00 16.77           N
ATOM      2  CA  GLY A   1      12.885   4.207   4.651  1.00 16.57           C
ATOM      3  C   GLY A   1      13.922   3.140   4.419  1.00 16.16           C
ATOM      4  O   GLY A   1      14.414   2.521   5.381  1.00 16.78           O
ATOM      5  H1  GLY A   1      11.977   4.525   6.514  0.00 16.77           H
ATOM      6  H2  GLY A   1      13.586   3.992   6.616  0.00 16.77           H
ATOM      7  H3  GLY A   1      13.250   5.598   6.177  0.00 16.77           H
ATOM      8  HA2 GLY A   1      11.900   3.815   4.398  0.00 16.57           H
ATOM      9  HA3 GLY A   1      13.100   5.065   4.014  0.00 16.57           H
ATOM     10  N   ASN A   2      14.281   2.923   3.155  1.00 15.02           N
ATOM     11  CA  ASN A   2      15.415   2.038   2.831  1.00 14.10           C
ATOM     12  C   ASN A   2      16.696   2.537   3.427  1.00 13.13           C
ATOM     13  O   ASN A   2      16.959   3.742   3.426  1.00 11.91           O
ATOM     14  CB  ASN A   2      15.591   1.881   1.341  1.00 15.38           C
ATOM     15  CG  ASN A   2      14.353   1.342   0.692  1.00 14.08           C
ATOM     16  OD1 ASN A   2      13.912   0.227   1.016  1.00 17.46           O
ATOM     17  ND2 ASN A   2      13.733   2.155  -0.169  1.00 11.72           N
ATOM     18  H   ASN A   2      13.820   3.334   2.343  0.00 15.02           H
ATOM     19  HA  ASN A   2      15.193   1.057   3.252  0.00 14.10           H
ATOM     20  HB2 ASN A   2      15.813   2.853   0.900  0.00 15.38           H
ATOM     21  HB3 ASN A   2      16.409   1.188   1.146  0.00 15.38           H
ATOM     22 HD21 ASN A   2      12.885   1.845  -0.643  0.00 11.72           H
ATOM     23 HD22 ASN A   2      14.108   3.086  -0.352  0.00 11.72           H
ATOM     24  N   ASN A   3      17.499   1.590   3.905  1.00 12.26           N
ATOM     25  CA  ASN A   3      18.744   1.904   4.589  1.00 11.74           C
ATOM     26  C   ASN A   3      19.982   1.332   3.895  1.00 11.10           C
ATOM     27  O   ASN A   3      20.065   0.119   3.648  1.00 10.42           O
ATOM     28  CB  ASN A   3      18.678   1.378   6.042  1.00 12.15           C
ATOM     29  CG  ASN A   3      19.931   1.739   6.861  1.00 12.82           C
ATOM     30  OD1 ASN A   3      20.235   2.925   7.072  1.00 15.05           O
ATOM     31  ND2 ASN A   3      20.666   0.715   7.306  1.00 13.48           N
ATOM     32  OXT ASN A   3      20.908   2.077   3.576  1.00 11.10           O
ATOM     33  H   ASN A   3      17.311   0.590   3.832  0.00 12.26           H
ATOM     34  HA  ASN A   3      18.863   2.987   4.586  0.00 11.74           H
ATOM     35  HB2 ASN A   3      17.812   1.815   6.539  0.00 12.15           H
ATOM     36  HB3 ASN A   3      18.588   0.292   6.023  0.00 12.15           H
ATOM     37 HD21 ASN A   3      21.508   0.892   7.854  0.00 13.48           H
ATOM     38 HD22 ASN A   3      20.385  -0.243   7.097  0.00 13.48           H
TER
ATOM     39  N   GLY B   1      12.928  -0.254   6.102  1.00 16.77           N
ATOM     40  CA  GLY B   1      12.885  -0.659   4.651  1.00 16.57           C
ATOM     41  C   GLY B   1      13.922  -1.726   4.419  1.00 16.16           C
ATOM     42  O   GLY B   1      14.414  -2.345   5.381  1.00 16.78           O
ATOM     43  H1  GLY B   1      11.977  -0.341   6.514  0.00 16.77           H
ATOM     44  H2  GLY B   1      13.586  -0.874   6.616  0.00 16.77           H
ATOM     45  H3  GLY B   1      13.250   0.732   6.177  0.00 16.77           H
ATOM     46  HA2 GLY B   1      11.900  -1.051   4.398  0.00 16.57           H
ATOM     47  HA3 GLY B   1      13.100   0.199   4.014  0.00 16.57           H
ATOM     48  N   ASN B   2      14.281  -1.943   3.155  1.00 15.02           N
ATOM     49  CA  ASN B   2      15.415  -2.828   2.831  1.00 14.10           C
ATOM     50  C   ASN B   2      16.696  -2.329   3.427  1.00 13.13           C
ATOM     51  O   ASN B   2      16.959  -1.124   3.426  1.00 11.91           O
ATOM     52  CB  ASN B   2      15.591  -2.985   1.341  1.00 15.38           C
ATOM     53  CG  ASN B   2      14.353  -3.524   0.692  1.00 14.08           C
ATOM     54  OD1 ASN B   2      13.912  -4.639   1.016  1.00 17.46           O
ATOM     55  ND2 ASN B   2      13.733  -2.711  -0.169  1.00 11.72           N
ATOM     56  H   ASN B   2      13.820  -1.532   2.343  0.00 15.02           H
ATOM     57  HA  ASN B   2      15.193  -3.809   3.252  0.00 14.10           H
ATOM     58  HB2 ASN B   2      15.813  -2.013   0.900  0.00 15.38           H
ATOM     59  HB3 ASN B   2      16.409  -3.678   1.146  0.00 15.38           H
ATOM     60 HD21 ASN B   2      12.885  -3.021  -0.643  0.00 11.72           H
ATOM     61 HD22 ASN B   2      14.108  -1.780  -0.352  0.00 11.72           H
ATOM     62  N   ASN B   3      17.499  -3.276   3.905  1.00 12.26           N
ATOM     63  CA  ASN B   3      18.744  -2.962   4.589  1.00 11.74           C
ATOM     64  C   ASN B   3      19.982  -3.534   3.895  1.00 11.10           C
ATOM     65  O   ASN B   3      20.065  -4.747   3.648  1.00 10.42           O
ATOM     66  CB  ASN B   3      18.678  -3.488   6.042  1.00 12.15           C
ATOM     67  CG  ASN B   3      19.931  -3.127   6.861  1.00 12.82           C
ATOM     68  OD1 ASN B   3      20.235  -1.941   7.072  1.00 15.05           O
ATOM     69  ND2 ASN B   3      20.666  -4.151   7.306  1.00 13.48           N
ATOM     70  OXT ASN B   3      20.908  -2.789   3.576  1.00 11.10           O
ATOM     71  H   ASN B   3      17.311  -4.276   3.832  0.00 12.26           H
ATOM     72  HA  ASN B   3      18.863  -1.879   4.586  0.00 11.74           H
ATOM     73  HB2 ASN B   3      17.812  -3.051   6.539  0.00 12.15           H
ATOM     74  HB3 ASN B   3      18.588  -4.574   6.023  0.00 12.15           H
ATOM     75 HD21 ASN B   3      21.508  -3.974   7.854  0.00 13.48           H
ATOM     76 HD22 ASN B   3      20.385  -5.109   7.097  0.00 13.48           H
TER
ATOM     77  N   GLY C   1      12.928   9.478   6.102  1.00 16.77           N
ATOM     78  CA  GLY C   1      12.885   9.073   4.651  1.00 16.57           C
ATOM     79  C   GLY C   1      13.922   8.006   4.419  1.00 16.16           C
ATOM     80  O   GLY C   1      14.414   7.387   5.381  1.00 16.78           O
ATOM     81  H1  GLY C   1      11.977   9.391   6.514  0.00 16.77           H
ATOM     82  H2  GLY C   1      13.586   8.858   6.616  0.00 16.77           H
ATOM     83  H3  GLY C   1      13.250  10.464   6.177  0.00 16.77           H
ATOM     84  HA2 GLY C   1      11.900   8.681   4.398  0.00 16.57           H
ATOM     85  HA3 GLY C   1      13.100   9.931   4.014  0.00 16.57           H
ATOM     86  N   ASN C   2      14.281   7.789   3.155  1.00 15.02           N
ATOM     87  CA  ASN C   2      15.415   6.904   2.831  1.00 14.10           C
ATOM     88  C   ASN C   2      16.696   7.403   3.427  1.00 13.13           C
ATOM     89  O   ASN C   2      16.959   8.608   3.426  1.00 11.91           O
ATOM     90  CB  ASN C   2      15.591   6.747   1.341  1.00 15.38           C
ATOM     91  CG  ASN C   2      14.353   6.208   0.692  1.00 14.08           C
ATOM     92  OD1 ASN C   2      13.912   5.093   1.016  1.00 17.46           O
ATOM     93  ND2 ASN C   2      13.733   7.021  -0.169  1.00 11.72           N
ATOM     94  H   ASN C   2      13.820   8.200   2.343  0.00 15.02           H
ATOM     95  HA  ASN C   2      15.193   5.923   3.252  0.00 14.10           H
ATOM     96  HB2 ASN C   2      15.813   7.719   0.900  0.00 15.38           H
ATOM     97  HB3 ASN C   2      16.409   6.054   1.146  0.00 15.38           H
ATOM     98 HD21 ASN C   2      12.885   6.711  -0.643  0.00 11.72           H
ATOM     99 HD22 ASN C   2      14.108   7.952  -0.352  0.00 11.72           H
ATOM    100  N   ASN C   3      17.499   6.456   3.905  1.00 12.26           N
ATOM    101  CA  ASN C   3      18.744   6.770   4.589  1.00 11.74           C
ATOM    102  C   ASN C   3      19.982   6.198   3.895  1.00 11.10           C
ATOM    103  O   ASN C   3      20.065   4.985   3.648  1.00 10.42           O
ATOM    104  CB  ASN C   3      18.678   6.244   6.042  1.00 12.15           C
ATOM    105  CG  ASN C   3      19.931   6.605   6.861  1.00 12.82           C
ATOM    106  OD1 ASN C   3      20.235   7.791   7.072  1.00 15.05           O
ATOM    107  ND2 ASN C   3      20.666   5.581   7.306  1.00 13.48           N
ATOM    108  OXT ASN C   3      20.908   6.943   3.576  1.00 11.10           O
ATOM    109  H   ASN C   3      17.311   5.456   3.832  0.00 12.26           H
ATOM    110  HA  ASN C   3      18.863   7.853   4.586  0.00 11.74           H
ATOM    111  HB2 ASN C   3      17.812   6.681   6.539  0.00 12.15           H
ATOM    112  HB3 ASN C   3      18.588   5.158   6.023  0.00 12.15           H
ATOM    113 HD21 ASN C   3      21.508   5.758   7.854  0.00 13.48           H
ATOM    114 HD22 ASN C   3      20.385   4.623   7.097  0.00 13.48           H
TER
ATOM    115  N   GLY D   1       9.009   2.179  -6.102  1.00 16.77           N
ATOM    116  CA  GLY D   1       9.052   1.774  -4.651  1.00 16.57           C
ATOM    117  C   GLY D   1       8.015   0.707  -4.419  1.00 16.16           C
ATOM    118  O   GLY D   1       7.523   0.088  -5.381  1.00 16.78           O
ATOM    119  H1  GLY D   1       9.960   2.092  -6.514  0.00 16.77           H
ATOM    120  H2  GLY D   1       8.351   1.559  -6.616  0.00 16.77           H
ATOM    121  H3  GLY D   1       8.687   3.165  -6.177  0.00 16.77           H
ATOM    122  HA2 GLY D   1      10.037   1.382  -4.398  0.00 16.57           H
ATOM    123  HA3 GLY D   1       8.837   2.632  -4.014  0.00 16.57           H
ATOM    124  N   ASN D   2       7.656   0.490  -3.155  1.00 15.02           N
ATOM    125  CA  ASN D   2       6.522  -0.395  -2.831  1.00 14.10           C
ATOM    126  C   ASN D   2       5.241   0.104  -3.427  1.00 13.13           C
ATOM    127  O   ASN D   2       4.978   1.309  -3.426  1.00 11.91           O
ATOM    128  CB  ASN D   2       6.346  -0.552  -1.341  1.00 15.38           C
ATOM    129  CG  ASN D   2       7.584  -1.091  -0.692  1.00 14.08           C
ATOM    130  OD1 ASN D   2       8.025  -2.206  -1.016  1.00 17.46           O
ATOM    131  ND2 ASN D   2       8.204  -0.278   0.169  1.00 11.72           N
ATOM    132  H   ASN D   2       8.117   0.901  -2.343  0.00 15.02           H
ATOM    133  HA  ASN D   2       6.744  -1.376  -3.252  0.00 14.10           H
ATOM    134  HB2 ASN D   2       6.124   0.420  -0.900  0.00 15.38           H
ATOM    135  HB3 ASN D   2       5.528  -1.245  -1.146  0.00 15.38           H
ATOM    136 HD21 ASN D   2       9.052  -0.588   0.643  0.00 11.72           H
ATOM    137 HD22 ASN D   2       7.829   0.653   0.352  0.00 11.72           H
TER
ATOM    138  N   ASN E   2       7.656   5.356  -3.155  1.00 15.02           N
ATOM    139  CA  ASN E   2       6.522   4.471  -2.831  1.00 14.10           C
ATOM    140  C   ASN E   2       5.241   4.970  -3.427  1.00 13.13           C
ATOM    141  O   ASN E   2       4.978   6.175  -3.426  1.00 11.91           O
ATOM    142  CB  ASN E   2       6.346   4.314  -1.341  1.00 15.38           C
ATOM    143  CG  ASN E   2       7.584   3.775  -0.692  1.00 14.08           C
ATOM    144  OD1 ASN E   2       8.025   2.660  -1.016  1.00 17.46           O
ATOM    145  ND2 ASN E   2       8.204   4.588   0.169  1.00 11.72           N
ATOM    146  H   ASN E   2       8.117   5.767  -2.343  0.00 15.02           H
ATOM    147  HA  ASN E   2       6.744   3.490  -3.252  0.00 14.10           H
ATOM    148  HB2 ASN E   2       6.124   5.286  -0.900  0.00 15.38           H
ATOM    149  HB3 ASN E   2       5.528   3.621  -1.146  0.00 15.38           H
ATOM    150 HD21 ASN E   2       9.052   4.278   0.643  0.00 11.72           H
ATOM    151 HD22 ASN E   2       7.829   5.519   0.352  0.00 11.72           H
TER
"""

pdb_str2 = """\
CRYST1  375.603  375.603  375.603  90.00  90.00  90.00 P 1
SCALE1      0.002662  0.000000  0.000000        0.00000
SCALE2      0.000000  0.002662  0.000000        0.00000
SCALE3      0.000000  0.000000  0.002662        0.00000
ATOM      1  N   CYS A 297     227.220 185.092 125.379  1.00999.99           N
ATOM      2  CA  CYS A 297     225.963 185.127 124.647  1.00999.99           C
ATOM      3  C   CYS A 297     224.877 185.625 125.592  1.00999.99           C
ATOM      4  O   CYS A 297     224.219 184.840 126.270  1.00999.99           O
ATOM      5  CB  CYS A 297     225.615 183.730 124.139  1.00999.99           C
ATOM      6  SG  CYS A 297     226.811 183.022 122.967  1.00999.99           S
ATOM      7  N   GLU A 298     224.716 186.916 125.639  1.00648.62           N
ATOM      8  CA  GLU A 298     223.728 187.536 126.517  1.00645.56           C
ATOM      9  C   GLU A 298     222.295 187.114 126.232  1.00645.40           C
ATOM     10  O   GLU A 298     221.459 187.089 127.131  1.00640.46           O
ATOM     11  CB  GLU A 298     223.832 189.061 126.422  1.00642.27           C
ATOM     12  CG  GLU A 298     225.230 189.619 126.682  1.00643.47           C
ATOM     13  CD  GLU A 298     225.697 189.398 128.108  1.00645.41           C
ATOM     14  OE1 GLU A 298     226.840 189.793 128.419  1.00643.53           O
ATOM     15  OE2 GLU A 298     224.924 188.841 128.918  1.00646.12           O
ATOM     16  N   GLU A 299     222.008 186.787 124.984  1.00585.91           N
ATOM     17  CA  GLU A 299     220.652 186.396 124.616  1.00583.20           C
ATOM     18  C   GLU A 299     220.337 184.916 124.811  1.00583.15           C
ATOM     19  O   GLU A 299     219.196 184.502 124.639  1.00579.28           O
ATOM     20  CB  GLU A 299     220.373 186.785 123.164  1.00582.77           C
ATOM     21  CG  GLU A 299     221.129 185.959 122.138  1.00585.70           C
ATOM     22  CD  GLU A 299     220.873 186.420 120.713  1.00582.39           C
ATOM     23  OE1 GLU A 299     219.693 186.515 120.327  1.00578.25           O
ATOM     24  OE2 GLU A 299     221.853 186.684 119.987  1.00581.99           O
ATOM     25  N   CYS A 300     221.328 184.123 125.161  1.00527.54           N
ATOM     26  CA  CYS A 300     221.094 182.699 125.369  1.00525.47           C
ATOM     27  C   CYS A 300     220.292 182.507 126.653  1.00524.01           C
ATOM     28  O   CYS A 300     220.523 183.185 127.650  1.00523.47           O
ATOM     29  CB  CYS A 300     222.418 181.945 125.481  1.00525.96           C
ATOM     30  SG  CYS A 300     223.422 181.883 123.976  1.00524.97           S
ATOM     31  N   SER A 301     219.342 181.573 126.612  1.00379.92           N
ATOM     32  CA  SER A 301     218.528 181.276 127.781  1.00380.07           C
ATOM     33  C   SER A 301     219.235 180.206 128.603  1.00379.21           C
ATOM     34  O   SER A 301     220.285 179.702 128.210  1.00380.71           O
ATOM     35  CB  SER A 301     217.144 180.773 127.363  1.00384.83           C
ATOM     36  OG  SER A 301     216.422 181.791 126.707  1.00386.80           O
ATOM     37  N   ILE A 302     218.715 179.908 129.795  1.00581.17           N
ATOM     38  CA  ILE A 302     219.250 178.884 130.669  1.00583.33           C
ATOM     39  C   ILE A 302     219.564 177.578 129.951  1.00585.23           C
ATOM     40  O   ILE A 302     220.659 177.049 130.091  1.00584.97           O
ATOM     41  CB  ILE A 302     218.296 178.592 131.846  1.00582.75           C
ATOM     42  CG1 ILE A 302     218.591 177.219 132.447  1.00582.73           C
ATOM     43  CG2 ILE A 302     216.839 178.644 131.419  1.00578.32           C
ATOM     44  CD1 ILE A 302     217.920 176.995 133.782  1.00582.08           C
ATOM     45  N   ASP A 303     218.629 177.059 129.165  1.00493.36           N
ATOM     46  CA  ASP A 303     218.872 175.809 128.456  1.00493.27           C
ATOM     47  C   ASP A 303     219.956 175.979 127.410  1.00492.13           C
ATOM     48  O   ASP A 303     220.802 175.106 127.219  1.00490.32           O
ATOM     49  CB  ASP A 303     217.598 175.326 127.772  1.00492.03           C
ATOM     50  CG  ASP A 303     216.746 174.485 128.677  1.00491.47           C
ATOM     51  OD1 ASP A 303     216.867 174.632 129.911  1.00492.91           O
ATOM     52  OD2 ASP A 303     215.942 173.680 128.162  1.00486.37           O
ATOM     53  N   GLU A 304     219.919 177.117 126.732  1.00365.23           N
ATOM     54  CA  GLU A 304     220.871 177.408 125.674  1.00365.48           C
ATOM     55  C   GLU A 304     222.301 177.653 126.173  1.00365.04           C
ATOM     56  O   GLU A 304     222.501 178.158 127.278  1.00364.59           O
ATOM     57  CB  GLU A 304     220.389 178.601 124.865  1.00365.54           C
ATOM     58  CG  GLU A 304     218.935 178.513 124.429  1.00366.36           C
ATOM     59  CD  GLU A 304     218.500 179.703 123.596  1.00366.87           C
ATOM     60  OE1 GLU A 304     219.284 180.669 123.482  1.00365.33           O
ATOM     61  OE2 GLU A 304     217.374 179.672 123.056  1.00365.00           O
ATOM     62  N   ASP A 305     223.290 177.295 125.354  1.00691.19           N
ATOM     63  CA  ASP A 305     224.694 177.477 125.703  1.00690.89           C
ATOM     64  C   ASP A 305     225.365 178.422 124.706  1.00691.37           C
ATOM     65  O   ASP A 305     224.938 178.527 123.556  1.00693.54           O
ATOM     66  CB  ASP A 305     225.426 176.133 125.701  1.00690.77           C
ATOM     67  CG  ASP A 305     225.039 175.252 126.874  1.00689.21           C
ATOM     68  OD1 ASP A 305     224.326 175.734 127.778  1.00688.73           O
ATOM     69  OD2 ASP A 305     225.455 174.075 126.893  1.00688.92           O
ATOM     70  N   CYS A 306     226.416 179.106 125.149  1.00999.99           N
ATOM     71  CA  CYS A 306     227.140 180.035 124.307  1.00999.99           C
ATOM     72  C   CYS A 306     228.259 179.313 123.540  1.00999.99           C
ATOM     73  O   CYS A 306     229.299 178.997 124.116  1.00999.99           O
ATOM     74  CB  CYS A 306     227.756 181.153 125.144  1.00999.99           C
ATOM     75  SG  CYS A 306     228.389 182.520 124.142  1.00999.99           S
TER
ATOM      1  N   CYS B 297     227.220 185.092 225.379  1.00999.99           N
ATOM      2  CA  CYS B 297     225.963 185.127 224.647  1.00999.99           C
ATOM      3  C   CYS B 297     224.877 185.625 225.592  1.00999.99           C
ATOM      4  O   CYS B 297     224.219 184.840 226.270  1.00999.99           O
ATOM      5  CB  CYS B 297     225.615 183.730 224.139  1.00999.99           C
ATOM      6  SG  CYS B 297     226.811 183.022 222.967  1.00999.99           S
ATOM      7  N   GLU B 298     224.716 186.916 225.639  1.00648.62           N
ATOM      8  CA  GLU B 298     223.728 187.536 226.517  1.00645.56           C
ATOM      9  C   GLU B 298     222.295 187.114 226.232  1.00645.40           C
ATOM     10  O   GLU B 298     221.459 187.089 227.131  1.00640.46           O
ATOM     11  CB  GLU B 298     223.832 189.061 226.422  1.00642.27           C
ATOM     12  CG  GLU B 298     225.230 189.619 226.682  1.00643.47           C
ATOM     13  CD  GLU B 298     225.697 189.398 228.108  1.00645.41           C
ATOM     14  OE1 GLU B 298     226.840 189.793 228.419  1.00643.53           O
ATOM     15  OE2 GLU B 298     224.924 188.841 228.918  1.00646.12           O
ATOM     16  N   GLU B 299     222.008 186.787 224.984  1.00585.91           N
ATOM     17  CA  GLU B 299     220.652 186.396 224.616  1.00583.20           C
ATOM     18  C   GLU B 299     220.337 184.916 224.811  1.00583.15           C
ATOM     19  O   GLU B 299     219.196 184.502 224.639  1.00579.28           O
ATOM     20  CB  GLU B 299     220.373 186.785 223.164  1.00582.77           C
ATOM     21  CG  GLU B 299     221.129 185.959 222.138  1.00585.70           C
ATOM     22  CD  GLU B 299     220.873 186.420 220.713  1.00582.39           C
ATOM     23  OE1 GLU B 299     219.693 186.515 220.327  1.00578.25           O
ATOM     24  OE2 GLU B 299     221.853 186.684 219.987  1.00581.99           O
ATOM     25  N   CYS B 300     221.328 184.123 225.161  1.00527.54           N
ATOM     26  CA  CYS B 300     221.094 182.699 225.369  1.00525.47           C
ATOM     27  C   CYS B 300     220.292 182.507 226.653  1.00524.01           C
ATOM     28  O   CYS B 300     220.523 183.185 227.650  1.00523.47           O
ATOM     29  CB  CYS B 300     222.418 181.945 225.481  1.00525.96           C
ATOM     30  SG  CYS B 300     223.422 181.883 223.976  1.00524.97           S
ATOM     31  N   SER B 301     219.342 181.573 226.612  1.00379.92           N
ATOM     32  CA  SER B 301     218.528 181.276 227.781  1.00380.07           C
ATOM     33  C   SER B 301     219.235 180.206 228.603  1.00379.21           C
ATOM     34  O   SER B 301     220.285 179.702 228.210  1.00380.71           O
ATOM     35  CB  SER B 301     217.144 180.773 227.363  1.00384.83           C
ATOM     36  OG  SER B 301     216.422 181.791 226.707  1.00386.80           O
ATOM     37  N   ILE B 302     218.715 179.908 229.795  1.00581.17           N
ATOM     38  CA  ILE B 302     219.250 178.884 230.669  1.00583.33           C
ATOM     39  C   ILE B 302     219.564 177.578 229.951  1.00585.23           C
ATOM     40  O   ILE B 302     220.659 177.049 230.091  1.00584.97           O
ATOM     41  CB  ILE B 302     218.296 178.592 231.846  1.00582.75           C
ATOM     42  CG1 ILE B 302     218.591 177.219 232.447  1.00582.73           C
ATOM     43  CG2 ILE B 302     216.839 178.644 231.419  1.00578.32           C
ATOM     44  CD1 ILE B 302     217.920 176.995 233.782  1.00582.08           C
ATOM     45  N   ASP B 303     218.629 177.059 229.165  1.00493.36           N
ATOM     46  CA  ASP B 303     218.872 175.809 228.456  1.00493.27           C
ATOM     47  C   ASP B 303     219.956 175.979 227.410  1.00492.13           C
ATOM     48  O   ASP B 303     220.802 175.106 227.219  1.00490.32           O
ATOM     49  CB  ASP B 303     217.598 175.326 227.772  1.00492.03           C
ATOM     50  CG  ASP B 303     216.746 174.485 228.677  1.00491.47           C
ATOM     51  OD1 ASP B 303     216.867 174.632 229.911  1.00492.91           O
ATOM     52  OD2 ASP B 303     215.942 173.680 228.162  1.00486.37           O
ATOM     53  N   GLU B 304     219.919 177.117 226.732  1.00365.23           N
ATOM     54  CA  GLU B 304     220.871 177.408 225.674  1.00365.48           C
ATOM     55  C   GLU B 304     222.301 177.653 226.173  1.00365.04           C
ATOM     56  O   GLU B 304     222.501 178.158 227.278  1.00364.59           O
ATOM     57  CB  GLU B 304     220.389 178.601 224.865  1.00365.54           C
ATOM     58  CG  GLU B 304     218.935 178.513 224.429  1.00366.36           C
ATOM     59  CD  GLU B 304     218.500 179.703 223.596  1.00366.87           C
ATOM     60  OE1 GLU B 304     219.284 180.669 223.482  1.00365.33           O
ATOM     61  OE2 GLU B 304     217.374 179.672 223.056  1.00365.00           O
ATOM     62  N   ASP B 305     223.290 177.295 225.354  1.00691.19           N
ATOM     63  CA  ASP B 305     224.694 177.477 225.703  1.00690.89           C
ATOM     64  C   ASP B 305     225.365 178.422 224.706  1.00691.37           C
ATOM     65  O   ASP B 305     224.938 178.527 223.556  1.00693.54           O
ATOM     66  CB  ASP B 305     225.426 176.133 225.701  1.00690.77           C
ATOM     67  CG  ASP B 305     225.039 175.252 226.874  1.00689.21           C
ATOM     68  OD1 ASP B 305     224.326 175.734 227.778  1.00688.73           O
ATOM     69  OD2 ASP B 305     225.455 174.075 226.893  1.00688.92           O
ATOM     70  N   CYS B 306     226.416 179.106 225.149  1.00999.99           N
ATOM     71  CA  CYS B 306     227.140 180.035 224.307  1.00999.99           C
ATOM     72  C   CYS B 306     228.259 179.313 223.540  1.00999.99           C
ATOM     73  O   CYS B 306     229.299 178.997 224.116  1.00999.99           O
ATOM     74  CB  CYS B 306     227.756 181.153 225.144  1.00999.99           C
ATOM     75  SG  CYS B 306     228.389 182.520 224.142  1.00999.99           S
TER
ATOM     76  N   CYS K 297     148.993 236.016 133.302  1.00999.99           N
ATOM     77  CA  CYS K 297     150.246 236.048 134.041  1.00999.99           C
ATOM     78  C   CYS K 297     151.341 236.533 133.099  1.00999.99           C
ATOM     79  O   CYS K 297     151.997 235.740 132.429  1.00999.99           O
ATOM     80  CB  CYS K 297     150.583 234.652 134.559  1.00999.99           C
ATOM     81  SG  CYS K 297     149.376 233.958 135.729  1.00999.99           S
ATOM     82  N   GLU K 298     151.510 237.823 133.045  1.00648.62           N
ATOM     83  CA  GLU K 298     152.507 238.431 132.169  1.00645.56           C
ATOM     84  C   GLU K 298     153.936 238.002 132.464  1.00645.40           C
ATOM     85  O   GLU K 298     154.776 237.966 131.570  1.00640.46           O
ATOM     86  CB  GLU K 298     152.412 239.957 132.254  1.00642.27           C
ATOM     87  CG  GLU K 298     151.019 240.522 131.982  1.00643.47           C
ATOM     88  CD  GLU K 298     150.559 240.295 130.555  1.00645.41           C
ATOM     89  OE1 GLU K 298     149.420 240.696 130.235  1.00643.53           O
ATOM     90  OE2 GLU K 298     151.332 239.729 129.753  1.00646.12           O
ATOM     91  N   GLU K 299     154.214 237.680 133.716  1.00585.91           N
ATOM     92  CA  GLU K 299     155.565 237.283 134.094  1.00583.20           C
ATOM     93  C   GLU K 299     155.872 235.800 133.909  1.00583.15           C
ATOM     94  O   GLU K 299     157.009 235.380 134.090  1.00579.28           O
ATOM     95  CB  GLU K 299     155.838 237.679 135.545  1.00582.77           C
ATOM     96  CG  GLU K 299     155.072 236.864 136.572  1.00585.70           C
ATOM     97  CD  GLU K 299     155.323 237.333 137.995  1.00582.39           C
ATOM     98  OE1 GLU K 299     156.501 237.423 138.387  1.00578.25           O
ATOM     99  OE2 GLU K 299     154.340 237.607 138.714  1.00581.99           O
ATOM    100  N   CYS K 300     154.878 235.011 133.559  1.00527.54           N
ATOM    101  CA  CYS K 300     155.104 233.584 133.361  1.00525.47           C
ATOM    102  C   CYS K 300     155.912 233.380 132.082  1.00524.01           C
ATOM    103  O   CYS K 300     155.690 234.053 131.080  1.00523.47           O
ATOM    104  CB  CYS K 300     153.776 232.838 133.246  1.00525.96           C
ATOM    105  SG  CYS K 300     152.763 232.792 134.746  1.00524.97           S
ATOM    106  N   SER K 301     156.855 232.440 132.134  1.00379.92           N
ATOM    107  CA  SER K 301     157.674 232.130 130.972  1.00380.07           C
ATOM    108  C   SER K 301     156.965 231.060 130.152  1.00379.21           C
ATOM    109  O   SER K 301     155.909 230.565 130.543  1.00380.71           O
ATOM    110  CB  SER K 301     159.052 231.621 131.401  1.00384.83           C
ATOM    111  OG  SER K 301     159.777 232.639 132.054  1.00386.80           O
ATOM    112  N   ILE K 302     157.489 230.751 128.965  1.00581.17           N
ATOM    113  CA  ILE K 302     156.953 229.725 128.095  1.00583.33           C
ATOM    114  C   ILE K 302     156.627 228.426 128.819  1.00585.23           C
ATOM    115  O   ILE K 302     155.529 227.903 128.676  1.00584.97           O
ATOM    116  CB  ILE K 302     157.911 229.420 126.925  1.00582.75           C
ATOM    117  CG1 ILE K 302     157.611 228.045 126.330  1.00582.73           C
ATOM    118  CG2 ILE K 302     159.366 229.466 127.359  1.00578.32           C
ATOM    119  CD1 ILE K 302     158.288 227.809 125.001  1.00582.08           C
ATOM    120  N   ASP K 303     157.554 227.906 129.613  1.00493.36           N
ATOM    121  CA  ASP K 303     157.299 226.662 130.328  1.00493.27           C
ATOM    122  C   ASP K 303     156.210 226.845 131.367  1.00492.13           C
ATOM    123  O   ASP K 303     155.358 225.979 131.559  1.00490.32           O
ATOM    124  CB  ASP K 303     158.566 226.175 131.022  1.00492.03           C
ATOM    125  CG  ASP K 303     159.418 225.323 130.127  1.00491.47           C
ATOM    126  OD1 ASP K 303     159.304 225.463 128.892  1.00492.91           O
ATOM    127  OD2 ASP K 303     160.214 224.516 130.652  1.00486.37           O
ATOM    128  N   GLU K 304     156.251 227.987 132.038  1.00365.23           N
ATOM    129  CA  GLU K 304     155.295 228.290 133.089  1.00365.48           C
ATOM    130  C   GLU K 304     153.869 228.541 132.581  1.00365.04           C
ATOM    131  O   GLU K 304     153.678 229.041 131.472  1.00364.59           O
ATOM    132  CB  GLU K 304     155.780 229.485 133.894  1.00365.54           C
ATOM    133  CG  GLU K 304     157.231 229.391 134.338  1.00366.36           C
ATOM    134  CD  GLU K 304     157.669 230.583 135.166  1.00366.87           C
ATOM    135  OE1 GLU K 304     156.890 231.555 135.270  1.00365.33           O
ATOM    136  OE2 GLU K 304     158.792 230.548 135.713  1.00365.00           O
ATOM    137  N   ASP K 305     152.873 228.195 133.397  1.00691.19           N
ATOM    138  CA  ASP K 305     151.473 228.383 133.039  1.00690.89           C
ATOM    139  C   ASP K 305     150.802 229.339 134.026  1.00691.37           C
ATOM    140  O   ASP K 305     151.223 229.448 135.178  1.00693.54           O
ATOM    141  CB  ASP K 305     150.732 227.044 133.045  1.00690.77           C
ATOM    142  CG  ASP K 305     151.120 226.153 131.879  1.00689.21           C
ATOM    143  OD1 ASP K 305     151.841 226.625 130.976  1.00688.73           O
ATOM    144  OD2 ASP K 305     150.697 224.979 131.865  1.00688.92           O
ATOM    145  N   CYS K 306     149.758 230.027 133.573  1.00999.99           N
ATOM    146  CA  CYS K 306     149.035 230.965 134.405  1.00999.99           C
ATOM    147  C   CYS K 306     147.907 230.255 135.170  1.00999.99           C
ATOM    148  O   CYS K 306     146.869 229.942 134.591  1.00999.99           O
ATOM    149  CB  CYS K 306     148.431 232.082 133.558  1.00999.99           C
ATOM    150  SG  CYS K 306     147.801 233.459 134.548  1.00999.99           S
TER
END
"""

def get_geometry_stats(lines, use_ncs=True):
  log_str=StringIO()
  pdb_inp = iotbx.pdb.input(source_info=None, lines=lines)
  m = mmtbx.model.manager(model_input = pdb_inp, log = log_str)
  p = m.get_default_pdb_interpretation_params()
  p.pdb_interpretation.use_ncs_to_build_restraints = use_ncs
  m.process(make_restraints=True, pdb_interpretation_params=p)
  geom=StringIO()
  g = m.geometry_statistics()
  g.show(log=geom, exclude_protein_only_stats=True)
  return geom.getvalue(), log_str.getvalue()

def exercise_01():
  geom_ncs, log_ncs=get_geometry_stats(pdb_str1, True)
  geom_no_ncs, log_no_ncs=get_geometry_stats(pdb_str1, False)
  assert not show_diff(geom_ncs, geom_no_ncs)
  # assert not show_diff(log_ncs, log_no_ncs)
  assert_lines_in_text(log_ncs, """ Restraints were copied for chains:
    B, C
""")
  # print(log_ncs)

def exercise_02():
  geom_ncs, log_ncs=get_geometry_stats(pdb_str2, True)
  # print(geom_ncs)
  # print(log_ncs)
  geom_no_ncs, log_no_ncs=get_geometry_stats(pdb_str2, False)
  assert not show_diff(geom_ncs, geom_no_ncs)
  assert_lines_in_text(log_ncs, """\
    Simple disulfide: pdb=" SG  CYS A 297 " - pdb=" SG  CYS A 306 " distance=2.03
    Simple disulfide: pdb=" SG  CYS B 297 " - pdb=" SG  CYS B 306 " distance=2.03
    Simple disulfide: pdb=" SG  CYS K 297 " - pdb=" SG  CYS K 306 " distance=2.03
""")
  # print(log_ncs)

if(__name__ == "__main__"):
  if libtbx.env.find_in_repositories(relative_path="chem_data") is None:
    print("Skipping exercise_01(): chem_data directory not available")
  else:
    exercise_01()
    exercise_02()
    print('OK')


 *******************************************************************************


 *******************************************************************************
mmtbx/regression/pdb_interpretation/tst_using_ncs_2.py
from __future__ import absolute_import, division, print_function

import libtbx.load_env
from libtbx.test_utils import show_diff, assert_lines_in_text
from mmtbx.regression.pdb_interpretation.tst_using_ncs_1 import get_geometry_stats

pdb_str = """\
ATOM      1  N   GLY A   1      -9.009   4.612   6.102  1.00 16.77           N
ATOM      2  CA  GLY A   1      -9.052   4.207   4.651  1.00 16.57           C
ATOM      3  C   GLY A   1      -8.015   3.140   4.419  1.00 16.16           C
ATOM      4  O   GLY A   1      -7.523   2.521   5.381  1.00 16.78           O
ATOM      5  N   ASN A   2      -7.656   2.923   3.155  1.00 15.02           N
ATOM      6  CA  ASN A   2      -6.522   2.038   2.831  1.00 14.10           C
ATOM      7  C   ASN A   2      -5.241   2.537   3.427  1.00 13.13           C
ATOM      8  O   ASN A   2      -4.978   3.742   3.426  1.00 11.91           O
ATOM      9  CB  ASN A   2      -6.346   1.881   1.341  1.00 15.38           C
ATOM     10  CG  ASN A   2      -7.584   1.342   0.692  1.00 14.08           C
ATOM     11  OD1 ASN A   2      -8.025   0.227   1.016  1.00 17.46           O
ATOM     12  ND2 ASN A   2      -8.204   2.155  -0.169  1.00 11.72           N
ATOM     13  N   ASN A   3      -4.438   1.590   3.905  1.00 12.26           N
ATOM     14  CA  ASN A   3      -3.193   1.904   4.589  1.00 11.74           C
ATOM     15  C   ASN A   3      -1.955   1.332   3.895  1.00 11.10           C
ATOM     16  O   ASN A   3      -1.872   0.119   3.648  1.00 10.42           O
ATOM     17  CB  ASN A   3      -3.259   1.378   6.042  1.00 12.15           C
ATOM     18  CG  ASN A   3      -2.006   1.739   6.861  1.00 12.82           C
ATOM     19  OD1 ASN A   3      -1.702   2.925   7.072  1.00 15.05           O
ATOM     20  ND2 ASN A   3      -1.271   0.715   7.306  1.00 13.48           N
ATOM     21  N   GLN A   4      -1.005   2.228   3.598  1.00 10.29           N
ATOM     22  CA  GLN A   4       0.384   1.888   3.199  1.00 10.53           C
ATOM     23  C   GLN A   4       1.435   2.606   4.088  1.00 10.24           C
ATOM     24  O   GLN A   4       1.547   3.843   4.115  1.00  8.86           O
ATOM     25  CB  GLN A   4       0.656   2.148   1.711  1.00  9.80           C
ATOM     26  CG  GLN A   4       1.944   1.458   1.213  1.00 10.25           C
ATOM     27  CD  GLN A   4       2.504   2.044  -0.089  1.00 12.43           C
ATOM     28  OE1 GLN A   4       2.744   3.268  -0.190  1.00 14.62           O
ATOM     29  NE2 GLN A   4       2.750   1.161  -1.091  1.00  9.05           N
ATOM     30  N   GLN A   5       2.154   1.821   4.871  1.00 10.38           N
ATOM     31  CA  GLN A   5       3.270   2.361   5.640  1.00 11.39           C
ATOM     32  C   GLN A   5       4.594   1.768   5.172  1.00 11.52           C
ATOM     33  O   GLN A   5       4.768   0.546   5.054  1.00 12.05           O
ATOM     34  CB  GLN A   5       3.056   2.183   7.147  1.00 11.96           C
ATOM     35  CG  GLN A   5       1.829   2.950   7.647  1.00 10.81           C
ATOM     36  CD  GLN A   5       1.344   2.414   8.954  1.00 13.10           C
ATOM     37  OE1 GLN A   5       0.774   1.325   9.002  1.00 10.65           O
ATOM     38  NE2 GLN A   5       1.549   3.187  10.039  1.00 12.30           N
ATOM     39  N   ASN A   6       5.514   2.664   4.856  1.00 11.99           N
ATOM     40  CA  ASN A   6       6.831   2.310   4.318  1.00 12.30           C
ATOM     41  C   ASN A   6       7.854   2.761   5.324  1.00 13.40           C
ATOM     42  O   ASN A   6       8.219   3.943   5.374  1.00 13.92           O
ATOM     43  CB  ASN A   6       7.065   3.016   2.993  1.00 12.13           C
ATOM     44  CG  ASN A   6       5.961   2.735   2.003  1.00 12.77           C
ATOM     45  OD1 ASN A   6       5.798   1.604   1.551  1.00 14.27           O
ATOM     46  ND2 ASN A   6       5.195   3.747   1.679  1.00 10.07           N
ATOM     47  N   TYR A   7       8.292   1.817   6.147  1.00 14.70           N
ATOM     48  CA  TYR A   7       9.159   2.144   7.299  1.00 15.18           C
ATOM     49  C   TYR A   7      10.603   2.331   6.885  1.00 15.91           C
ATOM     50  O   TYR A   7      11.041   1.811   5.855  1.00 15.76           O
ATOM     51  CB  TYR A   7       9.061   1.065   8.369  1.00 15.35           C
ATOM     52  CG  TYR A   7       7.665   0.929   8.902  1.00 14.45           C
ATOM     53  CD1 TYR A   7       7.210   1.756   9.920  1.00 14.80           C
ATOM     54  CD2 TYR A   7       6.771   0.021   8.327  1.00 15.68           C
ATOM     55  CE1 TYR A   7       5.904   1.649  10.416  1.00 14.33           C
ATOM     56  CE2 TYR A   7       5.480  -0.094   8.796  1.00 13.46           C
ATOM     57  CZ  TYR A   7       5.047   0.729   9.831  1.00 15.09           C
ATOM     58  OH  TYR A   7       3.766   0.589  10.291  1.00 14.39           O
ATOM     59  OXT TYR A   7      11.358   2.999   7.612  1.00 17.49           O
TER
HETATM   60  O   HOH A   8      -6.471   5.227   7.124  1.00 22.62           O
HETATM   61  O   HOH A   9      10.431   1.858   3.216  1.00 19.71           O
HETATM   62  O   HOH A  10     -11.286   1.756  -1.468  1.00 17.08           O
HETATM   63  O   HOH A  11      11.808   4.179   9.970  1.00 23.99           O
HETATM   64  O   HOH A  12      13.605   1.327   9.198  1.00 26.17           O
HETATM   65  O   HOH A  13      -2.749   3.429  10.024  1.00 39.15           O
HETATM   66  O   HOH A  14      -1.500   0.682  10.967  1.00 43.49           O
ATOM     67  N   GLY B   1      -9.009  -0.254   6.102  1.00 16.77           N
ATOM     68  CA  GLY B   1      -9.052  -0.659   4.651  1.00 16.57           C
ATOM     69  C   GLY B   1      -8.015  -1.726   4.419  1.00 16.16           C
ATOM     70  O   GLY B   1      -7.523  -2.345   5.381  1.00 16.78           O
ATOM     71  N   ASN B   2      -7.656  -1.943   3.155  1.00 15.02           N
ATOM     72  CA  ASN B   2      -6.522  -2.828   2.831  1.00 14.10           C
ATOM     73  C   ASN B   2      -5.241  -2.329   3.427  1.00 13.13           C
ATOM     74  O   ASN B   2      -4.978  -1.124   3.426  1.00 11.91           O
ATOM     75  CB  ASN B   2      -6.346  -2.985   1.341  1.00 15.38           C
ATOM     76  CG  ASN B   2      -7.584  -3.524   0.692  1.00 14.08           C
ATOM     77  OD1 ASN B   2      -8.025  -4.639   1.016  1.00 17.46           O
ATOM     78  ND2 ASN B   2      -8.204  -2.711  -0.169  1.00 11.72           N
ATOM     79  N   ASN B   3      -4.438  -3.276   3.905  1.00 12.26           N
ATOM     80  CA  ASN B   3      -3.193  -2.962   4.589  1.00 11.74           C
ATOM     81  C   ASN B   3      -1.955  -3.534   3.895  1.00 11.10           C
ATOM     82  O   ASN B   3      -1.872  -4.747   3.648  1.00 10.42           O
ATOM     83  CB  ASN B   3      -3.259  -3.488   6.042  1.00 12.15           C
ATOM     84  CG  ASN B   3      -2.006  -3.127   6.861  1.00 12.82           C
ATOM     85  OD1 ASN B   3      -1.702  -1.941   7.072  1.00 15.05           O
ATOM     86  ND2 ASN B   3      -1.271  -4.151   7.306  1.00 13.48           N
ATOM     87  N   GLN B   4      -1.005  -2.638   3.598  1.00 10.29           N
ATOM     88  CA  GLN B   4       0.384  -2.978   3.199  1.00 10.53           C
ATOM     89  C   GLN B   4       1.435  -2.260   4.088  1.00 10.24           C
ATOM     90  O   GLN B   4       1.547  -1.023   4.115  1.00  8.86           O
ATOM     91  CB  GLN B   4       0.656  -2.718   1.711  1.00  9.80           C
ATOM     92  CG  GLN B   4       1.944  -3.408   1.213  1.00 10.25           C
ATOM     93  CD  GLN B   4       2.504  -2.822  -0.089  1.00 12.43           C
ATOM     94  OE1 GLN B   4       2.744  -1.598  -0.190  1.00 14.62           O
ATOM     95  NE2 GLN B   4       2.750  -3.705  -1.091  1.00  9.05           N
ATOM     96  N   GLN B   5       2.154  -3.045   4.871  1.00 10.38           N
ATOM     97  CA  GLN B   5       3.270  -2.505   5.640  1.00 11.39           C
ATOM     98  C   GLN B   5       4.594  -3.098   5.172  1.00 11.52           C
ATOM     99  O   GLN B   5       4.768  -4.320   5.054  1.00 12.05           O
ATOM    100  CB  GLN B   5       3.056  -2.683   7.147  1.00 11.96           C
ATOM    101  CG  GLN B   5       1.829  -1.916   7.647  1.00 10.81           C
ATOM    102  CD  GLN B   5       1.344  -2.452   8.954  1.00 13.10           C
ATOM    103  OE1 GLN B   5       0.774  -3.541   9.002  1.00 10.65           O
ATOM    104  NE2 GLN B   5       1.549  -1.679  10.039  1.00 12.30           N
ATOM    105  N   ASN B   6       5.514  -2.202   4.856  1.00 11.99           N
ATOM    106  CA  ASN B   6       6.831  -2.556   4.318  1.00 12.30           C
ATOM    107  C   ASN B   6       7.854  -2.105   5.324  1.00 13.40           C
ATOM    108  O   ASN B   6       8.219  -0.923   5.374  1.00 13.92           O
ATOM    109  CB  ASN B   6       7.065  -1.850   2.993  1.00 12.13           C
ATOM    110  CG  ASN B   6       5.961  -2.131   2.003  1.00 12.77           C
ATOM    111  OD1 ASN B   6       5.798  -3.262   1.551  1.00 14.27           O
ATOM    112  ND2 ASN B   6       5.195  -1.119   1.679  1.00 10.07           N
ATOM    113  N   TYR B   7       8.292  -3.049   6.147  1.00 14.70           N
ATOM    114  CA  TYR B   7       9.159  -2.722   7.299  1.00 15.18           C
ATOM    115  C   TYR B   7      10.603  -2.535   6.885  1.00 15.91           C
ATOM    116  O   TYR B   7      11.041  -3.055   5.855  1.00 15.76           O
ATOM    117  CB  TYR B   7       9.061  -3.801   8.369  1.00 15.35           C
ATOM    118  CG  TYR B   7       7.665  -3.937   8.902  1.00 14.45           C
ATOM    119  CD1 TYR B   7       7.210  -3.110   9.920  1.00 14.80           C
ATOM    120  CD2 TYR B   7       6.771  -4.845   8.327  1.00 15.68           C
ATOM    121  CE1 TYR B   7       5.904  -3.217  10.416  1.00 14.33           C
ATOM    122  CE2 TYR B   7       5.480  -4.960   8.796  1.00 13.46           C
ATOM    123  CZ  TYR B   7       5.047  -4.137   9.831  1.00 15.09           C
ATOM    124  OH  TYR B   7       3.766  -4.277  10.291  1.00 14.39           O
ATOM    125  OXT TYR B   7      11.358  -1.867   7.612  1.00 17.49           O
TER
HETATM  126  O   HOH C   8      -6.471   0.361   7.124  1.00 22.62           O
HETATM  127  O   HOH C   9      10.431  -3.008   3.216  1.00 19.71           O
HETATM  128  O   HOH C  10     -11.286  -3.110  -1.468  1.00 17.08           O
HETATM  129  O   HOH C  11      11.808  -0.687   9.970  1.00 23.99           O
HETATM  130  O   HOH C  12      13.605  -3.539   9.198  1.00 26.17           O
HETATM  131  O   HOH C  13      -2.749  -1.437  10.024  1.00 39.15           O
HETATM  132  O   HOH C  14      -1.500  -4.184  10.967  1.00 43.49           O
HETATM  133  O   HOH E  13      -4.146   0.996  12.418  1.00 39.15           O
HETATM  134  O   HOH E  14      -5.395  -1.751  11.475  1.00 43.49           O
HETATM  135  O   HOH G  13      -4.146   5.862  12.418  1.00 39.15           O
HETATM  136  O   HOH G  14      -5.395   3.115  11.475  1.00 43.49           O
ATOM    137  N   GLY H   1      -9.009   9.478   6.102  1.00 16.77           N
ATOM    138  CA  GLY H   1      -9.052   9.073   4.651  1.00 16.57           C
ATOM    139  C   GLY H   1      -8.015   8.006   4.419  1.00 16.16           C
ATOM    140  O   GLY H   1      -7.523   7.387   5.381  1.00 16.78           O
ATOM    141  N   ASN H   2      -7.656   7.789   3.155  1.00 15.02           N
ATOM    142  CA  ASN H   2      -6.522   6.904   2.831  1.00 14.10           C
ATOM    143  C   ASN H   2      -5.241   7.403   3.427  1.00 13.13           C
ATOM    144  O   ASN H   2      -4.978   8.608   3.426  1.00 11.91           O
ATOM    145  CB  ASN H   2      -6.346   6.747   1.341  1.00 15.38           C
ATOM    146  CG  ASN H   2      -7.584   6.208   0.692  1.00 14.08           C
ATOM    147  OD1 ASN H   2      -8.025   5.093   1.016  1.00 17.46           O
ATOM    148  ND2 ASN H   2      -8.204   7.021  -0.169  1.00 11.72           N
ATOM    149  N   ASN H   3      -4.438   6.456   3.905  1.00 12.26           N
ATOM    150  CA  ASN H   3      -3.193   6.770   4.589  1.00 11.74           C
ATOM    151  C   ASN H   3      -1.955   6.198   3.895  1.00 11.10           C
ATOM    152  O   ASN H   3      -1.872   4.985   3.648  1.00 10.42           O
ATOM    153  CB  ASN H   3      -3.259   6.244   6.042  1.00 12.15           C
ATOM    154  CG  ASN H   3      -2.006   6.605   6.861  1.00 12.82           C
ATOM    155  OD1 ASN H   3      -1.702   7.791   7.072  1.00 15.05           O
ATOM    156  ND2 ASN H   3      -1.271   5.581   7.306  1.00 13.48           N
ATOM    157  N   GLN H   4      -1.005   7.094   3.598  1.00 10.29           N
ATOM    158  CA  GLN H   4       0.384   6.754   3.199  1.00 10.53           C
ATOM    159  C   GLN H   4       1.435   7.472   4.088  1.00 10.24           C
ATOM    160  O   GLN H   4       1.547   8.709   4.115  1.00  8.86           O
ATOM    161  CB  GLN H   4       0.656   7.014   1.711  1.00  9.80           C
ATOM    162  CG  GLN H   4       1.944   6.324   1.213  1.00 10.25           C
ATOM    163  CD  GLN H   4       2.504   6.910  -0.089  1.00 12.43           C
ATOM    164  OE1 GLN H   4       2.744   8.134  -0.190  1.00 14.62           O
ATOM    165  NE2 GLN H   4       2.750   6.027  -1.091  1.00  9.05           N
ATOM    166  N   GLN H   5       2.154   6.687   4.871  1.00 10.38           N
ATOM    167  CA  GLN H   5       3.270   7.227   5.640  1.00 11.39           C
ATOM    168  C   GLN H   5       4.594   6.634   5.172  1.00 11.52           C
ATOM    169  O   GLN H   5       4.768   5.412   5.054  1.00 12.05           O
ATOM    170  CB  GLN H   5       3.056   7.049   7.147  1.00 11.96           C
ATOM    171  CG  GLN H   5       1.829   7.816   7.647  1.00 10.81           C
ATOM    172  CD  GLN H   5       1.344   7.280   8.954  1.00 13.10           C
ATOM    173  OE1 GLN H   5       0.774   6.191   9.002  1.00 10.65           O
ATOM    174  NE2 GLN H   5       1.549   8.053  10.039  1.00 12.30           N
ATOM    175  N   ASN H   6       5.514   7.530   4.856  1.00 11.99           N
ATOM    176  CA  ASN H   6       6.831   7.176   4.318  1.00 12.30           C
ATOM    177  C   ASN H   6       7.854   7.627   5.324  1.00 13.40           C
ATOM    178  O   ASN H   6       8.219   8.809   5.374  1.00 13.92           O
ATOM    179  CB  ASN H   6       7.065   7.882   2.993  1.00 12.13           C
ATOM    180  CG  ASN H   6       5.961   7.601   2.003  1.00 12.77           C
ATOM    181  OD1 ASN H   6       5.798   6.470   1.551  1.00 14.27           O
ATOM    182  ND2 ASN H   6       5.195   8.613   1.679  1.00 10.07           N
ATOM    183  N   TYR H   7       8.292   6.683   6.147  1.00 14.70           N
ATOM    184  CA  TYR H   7       9.159   7.010   7.299  1.00 15.18           C
ATOM    185  C   TYR H   7      10.603   7.197   6.885  1.00 15.91           C
ATOM    186  O   TYR H   7      11.041   6.677   5.855  1.00 15.76           O
ATOM    187  CB  TYR H   7       9.061   5.931   8.369  1.00 15.35           C
ATOM    188  CG  TYR H   7       7.665   5.795   8.902  1.00 14.45           C
ATOM    189  CD1 TYR H   7       7.210   6.622   9.920  1.00 14.80           C
ATOM    190  CD2 TYR H   7       6.771   4.887   8.327  1.00 15.68           C
ATOM    191  CE1 TYR H   7       5.904   6.515  10.416  1.00 14.33           C
ATOM    192  CE2 TYR H   7       5.480   4.772   8.796  1.00 13.46           C
ATOM    193  CZ  TYR H   7       5.047   5.595   9.831  1.00 15.09           C
ATOM    194  OH  TYR H   7       3.766   5.455  10.291  1.00 14.39           O
ATOM    195  OXT TYR H   7      11.358   7.865   7.612  1.00 17.49           O
TER
HETATM  196  O   HOH I   9      10.431   6.724   3.216  1.00 19.71           O
HETATM  197  O   HOH I  10     -11.286   6.622  -1.468  1.00 17.08           O
HETATM  198  O   HOH I  12      13.605   6.193   9.198  1.00 26.17           O
HETATM  199  O   HOH I  14      -1.500   5.548  10.967  1.00 43.49           O
ATOM    200  N   GLN L   5      12.888   4.254  17.571  1.00 10.38           N
ATOM    201  CA  GLN L   5      11.772   4.794  16.802  1.00 11.39           C
ATOM    202  C   GLN L   5      10.448   4.201  17.270  1.00 11.52           C
ATOM    203  O   GLN L   5      10.274   2.979  17.388  1.00 12.05           O
ATOM    204  CB  GLN L   5      11.986   4.616  15.295  1.00 11.96           C
ATOM    205  CG  GLN L   5      13.213   5.383  14.795  1.00 10.81           C
ATOM    206  CD  GLN L   5      13.698   4.847  13.488  1.00 13.10           C
ATOM    207  OE1 GLN L   5      14.268   3.758  13.440  1.00 10.65           O
ATOM    208  NE2 GLN L   5      13.493   5.620  12.403  1.00 12.30           N
ATOM    209  N   TYR L   7       6.750   4.250  16.295  1.00 14.70           N
ATOM    210  CA  TYR L   7       5.883   4.577  15.143  1.00 15.18           C
ATOM    211  C   TYR L   7       4.439   4.764  15.557  1.00 15.91           C
ATOM    212  O   TYR L   7       4.001   4.244  16.587  1.00 15.76           O
ATOM    213  CB  TYR L   7       5.981   3.498  14.073  1.00 15.35           C
ATOM    214  CG  TYR L   7       7.377   3.362  13.540  1.00 14.45           C
ATOM    215  CD1 TYR L   7       7.832   4.189  12.522  1.00 14.80           C
ATOM    216  CD2 TYR L   7       8.271   2.454  14.115  1.00 15.68           C
ATOM    217  CE1 TYR L   7       9.138   4.082  12.026  1.00 14.33           C
ATOM    218  CE2 TYR L   7       9.562   2.339  13.646  1.00 13.46           C
ATOM    219  CZ  TYR L   7       9.995   3.162  12.611  1.00 15.09           C
ATOM    220  OH  TYR L   7      11.276   3.022  12.151  1.00 14.39           O
ATOM    221  OXT TYR L   7       3.684   5.432  14.830  1.00 17.49           O
TER
HETATM  222  O   HOH M  11       3.234   6.612  12.472  1.00 23.99           O
HETATM  223  O   HOH M  12       1.437   3.760  13.244  1.00 26.17           O
HETATM  224  O   HOH M  14      16.542   3.115  11.475  1.00 43.49           O
ATOM    225  N   ASN N   2       7.656   0.490  -3.155  1.00 15.02           N
ATOM    226  CA  ASN N   2       6.522  -0.395  -2.831  1.00 14.10           C
ATOM    227  C   ASN N   2       5.241   0.104  -3.427  1.00 13.13           C
ATOM    228  O   ASN N   2       4.978   1.309  -3.426  1.00 11.91           O
ATOM    229  CB  ASN N   2       6.346  -0.552  -1.341  1.00 15.38           C
ATOM    230  CG  ASN N   2       7.584  -1.091  -0.692  1.00 14.08           C
ATOM    231  OD1 ASN N   2       8.025  -2.206  -1.016  1.00 17.46           O
ATOM    232  ND2 ASN N   2       8.204  -0.278   0.169  1.00 11.72           N
ATOM    233  N   ASN N   3       4.438  -0.843  -3.905  1.00 12.26           N
ATOM    234  CA  ASN N   3       3.193  -0.529  -4.589  1.00 11.74           C
ATOM    235  C   ASN N   3       1.955  -1.101  -3.895  1.00 11.10           C
ATOM    236  O   ASN N   3       1.872  -2.314  -3.648  1.00 10.42           O
ATOM    237  CB  ASN N   3       3.259  -1.055  -6.042  1.00 12.15           C
ATOM    238  CG  ASN N   3       2.006  -0.694  -6.861  1.00 12.82           C
ATOM    239  OD1 ASN N   3       1.702   0.492  -7.072  1.00 15.05           O
ATOM    240  ND2 ASN N   3       1.271  -1.718  -7.306  1.00 13.48           N
ATOM    241  N   GLN N   4       1.005  -0.205  -3.598  1.00 10.29           N
ATOM    242  CA  GLN N   4      -0.384  -0.545  -3.199  1.00 10.53           C
ATOM    243  C   GLN N   4      -1.435   0.173  -4.088  1.00 10.24           C
ATOM    244  O   GLN N   4      -1.547   1.410  -4.115  1.00  8.86           O
ATOM    245  CB  GLN N   4      -0.656  -0.285  -1.711  1.00  9.80           C
ATOM    246  CG  GLN N   4      -1.944  -0.975  -1.213  1.00 10.25           C
ATOM    247  CD  GLN N   4      -2.504  -0.389   0.089  1.00 12.43           C
ATOM    248  OE1 GLN N   4      -2.744   0.835   0.190  1.00 14.62           O
ATOM    249  NE2 GLN N   4      -2.750  -1.272   1.091  1.00  9.05           N
ATOM    250  N   ASN N   6      -5.514   0.231  -4.856  1.00 11.99           N
ATOM    251  CA  ASN N   6      -6.831  -0.123  -4.318  1.00 12.30           C
ATOM    252  C   ASN N   6      -7.854   0.328  -5.324  1.00 13.40           C
ATOM    253  O   ASN N   6      -8.219   1.510  -5.374  1.00 13.92           O
ATOM    254  CB  ASN N   6      -7.065   0.583  -2.993  1.00 12.13           C
ATOM    255  CG  ASN N   6      -5.961   0.302  -2.003  1.00 12.77           C
ATOM    256  OD1 ASN N   6      -5.798  -0.829  -1.551  1.00 14.27           O
ATOM    257  ND2 ASN N   6      -5.195   1.314  -1.679  1.00 10.07           N
TER
HETATM  258  O   HOH O   9     -10.431  -0.575  -3.216  1.00 19.71           O
HETATM  259  O   HOH O  10      11.286  -0.677   1.468  1.00 17.08           O
ATOM    260  N   ASN P   2       7.656   5.356  -3.155  1.00 15.02           N
ATOM    261  CA  ASN P   2       6.522   4.471  -2.831  1.00 14.10           C
ATOM    262  C   ASN P   2       5.241   4.970  -3.427  1.00 13.13           C
ATOM    263  O   ASN P   2       4.978   6.175  -3.426  1.00 11.91           O
ATOM    264  CB  ASN P   2       6.346   4.314  -1.341  1.00 15.38           C
ATOM    265  CG  ASN P   2       7.584   3.775  -0.692  1.00 14.08           C
ATOM    266  OD1 ASN P   2       8.025   2.660  -1.016  1.00 17.46           O
ATOM    267  ND2 ASN P   2       8.204   4.588   0.169  1.00 11.72           N
ATOM    268  N   ASN P   3       4.438   4.023  -3.905  1.00 12.26           N
ATOM    269  CA  ASN P   3       3.193   4.337  -4.589  1.00 11.74           C
ATOM    270  C   ASN P   3       1.955   3.765  -3.895  1.00 11.10           C
ATOM    271  O   ASN P   3       1.872   2.552  -3.648  1.00 10.42           O
ATOM    272  CB  ASN P   3       3.259   3.811  -6.042  1.00 12.15           C
ATOM    273  CG  ASN P   3       2.006   4.172  -6.861  1.00 12.82           C
ATOM    274  OD1 ASN P   3       1.702   5.358  -7.072  1.00 15.05           O
ATOM    275  ND2 ASN P   3       1.271   3.148  -7.306  1.00 13.48           N
ATOM    276  N   GLN P   4       1.005   4.661  -3.598  1.00 10.29           N
ATOM    277  CA  GLN P   4      -0.384   4.321  -3.199  1.00 10.53           C
ATOM    278  C   GLN P   4      -1.435   5.039  -4.088  1.00 10.24           C
ATOM    279  O   GLN P   4      -1.547   6.276  -4.115  1.00  8.86           O
ATOM    280  CB  GLN P   4      -0.656   4.581  -1.711  1.00  9.80           C
ATOM    281  CG  GLN P   4      -1.944   3.891  -1.213  1.00 10.25           C
ATOM    282  CD  GLN P   4      -2.504   4.477   0.089  1.00 12.43           C
ATOM    283  OE1 GLN P   4      -2.744   5.701   0.190  1.00 14.62           O
ATOM    284  NE2 GLN P   4      -2.750   3.594   1.091  1.00  9.05           N
ATOM    285  N   ASN P   6      -5.514   5.097  -4.856  1.00 11.99           N
ATOM    286  CA  ASN P   6      -6.831   4.743  -4.318  1.00 12.30           C
ATOM    287  C   ASN P   6      -7.854   5.194  -5.324  1.00 13.40           C
ATOM    288  O   ASN P   6      -8.219   6.376  -5.374  1.00 13.92           O
ATOM    289  CB  ASN P   6      -7.065   5.449  -2.993  1.00 12.13           C
ATOM    290  CG  ASN P   6      -5.961   5.168  -2.003  1.00 12.77           C
ATOM    291  OD1 ASN P   6      -5.798   4.037  -1.551  1.00 14.27           O
ATOM    292  ND2 ASN P   6      -5.195   6.180  -1.679  1.00 10.07           N
ATOM    293  N   TYR P   7      -8.292   4.250  -6.147  1.00 14.70           N
ATOM    294  CA  TYR P   7      -9.159   4.577  -7.299  1.00 15.18           C
ATOM    295  C   TYR P   7     -10.603   4.764  -6.885  1.00 15.91           C
ATOM    296  O   TYR P   7     -11.041   4.244  -5.855  1.00 15.76           O
ATOM    297  CB  TYR P   7      -9.061   3.498  -8.369  1.00 15.35           C
ATOM    298  CG  TYR P   7      -7.665   3.362  -8.902  1.00 14.45           C
ATOM    299  CD1 TYR P   7      -7.210   4.189  -9.920  1.00 14.80           C
ATOM    300  CD2 TYR P   7      -6.771   2.454  -8.327  1.00 15.68           C
ATOM    301  CE1 TYR P   7      -5.904   4.082 -10.416  1.00 14.33           C
ATOM    302  CE2 TYR P   7      -5.480   2.339  -8.796  1.00 13.46           C
ATOM    303  CZ  TYR P   7      -5.047   3.162  -9.831  1.00 15.09           C
ATOM    304  OH  TYR P   7      -3.766   3.022 -10.291  1.00 14.39           O
ATOM    305  OXT TYR P   7     -11.358   5.432  -7.612  1.00 17.49           O
TER
HETATM  306  O   HOH Q   9     -10.431   4.291  -3.216  1.00 19.71           O
HETATM  307  O   HOH Q  10      11.286   4.189   1.468  1.00 17.08           O
ATOM    308  N   GLN R   5      12.888  -0.612  17.571  1.00 10.38           N
ATOM    309  CA  GLN R   5      11.772  -0.072  16.802  1.00 11.39           C
ATOM    310  C   GLN R   5      10.448  -0.665  17.270  1.00 11.52           C
ATOM    311  O   GLN R   5      10.274  -1.887  17.388  1.00 12.05           O
ATOM    312  CB  GLN R   5      11.986  -0.250  15.295  1.00 11.96           C
ATOM    313  CG  GLN R   5      13.213   0.517  14.795  1.00 10.81           C
ATOM    314  CD  GLN R   5      13.698  -0.019  13.488  1.00 13.10           C
ATOM    315  OE1 GLN R   5      14.268  -1.108  13.440  1.00 10.65           O
ATOM    316  NE2 GLN R   5      13.493   0.754  12.403  1.00 12.30           N
ATOM    317  N   TYR R   7       6.750  -0.616  16.295  1.00 14.70           N
ATOM    318  CA  TYR R   7       5.883  -0.289  15.143  1.00 15.18           C
ATOM    319  C   TYR R   7       4.439  -0.102  15.557  1.00 15.91           C
ATOM    320  O   TYR R   7       4.001  -0.622  16.587  1.00 15.76           O
ATOM    321  CB  TYR R   7       5.981  -1.368  14.073  1.00 15.35           C
ATOM    322  CG  TYR R   7       7.377  -1.504  13.540  1.00 14.45           C
ATOM    323  CD1 TYR R   7       7.832  -0.677  12.522  1.00 14.80           C
ATOM    324  CD2 TYR R   7       8.271  -2.412  14.115  1.00 15.68           C
ATOM    325  CE1 TYR R   7       9.138  -0.784  12.026  1.00 14.33           C
ATOM    326  CE2 TYR R   7       9.562  -2.527  13.646  1.00 13.46           C
ATOM    327  CZ  TYR R   7       9.995  -1.704  12.611  1.00 15.09           C
ATOM    328  OH  TYR R   7      11.276  -1.844  12.151  1.00 14.39           O
ATOM    329  OXT TYR R   7       3.684   0.566  14.830  1.00 17.49           O
TER
HETATM  330  O   HOH S  11       3.234   1.746  12.472  1.00 23.99           O
HETATM  331  O   HOH S  12       1.437  -1.106  13.244  1.00 26.17           O
ATOM    332  N   ASN V   6     -16.423   2.664   4.856  1.00 11.99           N
ATOM    333  CA  ASN V   6     -15.106   2.310   4.318  1.00 12.30           C
ATOM    334  C   ASN V   6     -14.083   2.761   5.324  1.00 13.40           C
ATOM    335  O   ASN V   6     -13.718   3.943   5.374  1.00 13.92           O
ATOM    336  CB  ASN V   6     -14.872   3.016   2.993  1.00 12.13           C
ATOM    337  CG  ASN V   6     -15.976   2.735   2.003  1.00 12.77           C
ATOM    338  OD1 ASN V   6     -16.139   1.604   1.551  1.00 14.27           O
ATOM    339  ND2 ASN V   6     -16.742   3.747   1.679  1.00 10.07           N
ATOM    340  N   TYR V   7     -13.645   1.817   6.147  1.00 14.70           N
ATOM    341  CA  TYR V   7     -12.778   2.144   7.299  1.00 15.18           C
ATOM    342  C   TYR V   7     -11.334   2.331   6.885  1.00 15.91           C
ATOM    343  O   TYR V   7     -10.896   1.811   5.855  1.00 15.76           O
ATOM    344  CB  TYR V   7     -12.876   1.065   8.369  1.00 15.35           C
ATOM    345  CG  TYR V   7     -14.272   0.929   8.902  1.00 14.45           C
ATOM    346  CD1 TYR V   7     -14.727   1.756   9.920  1.00 14.80           C
ATOM    347  CD2 TYR V   7     -15.166   0.021   8.327  1.00 15.68           C
ATOM    348  CE1 TYR V   7     -16.033   1.649  10.416  1.00 14.33           C
ATOM    349  CE2 TYR V   7     -16.457  -0.094   8.796  1.00 13.46           C
ATOM    350  CZ  TYR V   7     -16.890   0.729   9.831  1.00 15.09           C
ATOM    351  OH  TYR V   7     -18.171   0.589  10.291  1.00 14.39           O
ATOM    352  OXT TYR V   7     -10.579   2.999   7.612  1.00 17.49           O
TER
HETATM  353  O   HOH W   9     -11.506   1.858   3.216  1.00 19.71           O
HETATM  354  O   HOH W  11     -10.129   4.179   9.970  1.00 23.99           O
HETATM  355  O   HOH W  12      -8.332   1.327   9.198  1.00 26.17           O
ATOM    356  N   GLY X   1     -12.928   2.179  -6.102  1.00 16.77           N
ATOM    357  CA  GLY X   1     -12.885   1.774  -4.651  1.00 16.57           C
ATOM    358  C   GLY X   1     -13.922   0.707  -4.419  1.00 16.16           C
ATOM    359  O   GLY X   1     -14.414   0.088  -5.381  1.00 16.78           O
ATOM    360  N   ASN X   2     -14.281   0.490  -3.155  1.00 15.02           N
ATOM    361  CA  ASN X   2     -15.415  -0.395  -2.831  1.00 14.10           C
ATOM    362  C   ASN X   2     -16.696   0.104  -3.427  1.00 13.13           C
ATOM    363  O   ASN X   2     -16.959   1.309  -3.426  1.00 11.91           O
ATOM    364  CB  ASN X   2     -15.591  -0.552  -1.341  1.00 15.38           C
ATOM    365  CG  ASN X   2     -14.353  -1.091  -0.692  1.00 14.08           C
ATOM    366  OD1 ASN X   2     -13.912  -2.206  -1.016  1.00 17.46           O
ATOM    367  ND2 ASN X   2     -13.733  -0.278   0.169  1.00 11.72           N
TER
HETATM  368  O   HOH Y  10     -10.651  -0.677   1.468  1.00 17.08           O
ATOM    369  N   ASN Z   2     -14.281   5.356  -3.155  1.00 15.02           N
ATOM    370  CA  ASN Z   2     -15.415   4.471  -2.831  1.00 14.10           C
ATOM    371  C   ASN Z   2     -16.696   4.970  -3.427  1.00 13.13           C
ATOM    372  O   ASN Z   2     -16.959   6.175  -3.426  1.00 11.91           O
ATOM    373  CB  ASN Z   2     -15.591   4.314  -1.341  1.00 15.38           C
ATOM    374  CG  ASN Z   2     -14.353   3.775  -0.692  1.00 14.08           C
ATOM    375  OD1 ASN Z   2     -13.912   2.660  -1.016  1.00 17.46           O
ATOM    376  ND2 ASN Z   2     -13.733   4.588   0.169  1.00 11.72           N
TER
HETATM  377  O   HOH 0  10     -10.651   4.189   1.468  1.00 17.08           O
ATOM    378  N   GLY 1   1      12.928  -0.254   6.102  1.00 16.77           N
ATOM    379  CA  GLY 1   1      12.885  -0.659   4.651  1.00 16.57           C
ATOM    380  C   GLY 1   1      13.922  -1.726   4.419  1.00 16.16           C
ATOM    381  O   GLY 1   1      14.414  -2.345   5.381  1.00 16.78           O
TER
HETATM  382  O   HOH 2   8      15.466   0.361   7.124  1.00 22.62           O
ATOM    383  N   GLY 3   1      12.928   4.612   6.102  1.00 16.77           N
ATOM    384  CA  GLY 3   1      12.885   4.207   4.651  1.00 16.57           C
ATOM    385  C   GLY 3   1      13.922   3.140   4.419  1.00 16.16           C
ATOM    386  O   GLY 3   1      14.414   2.521   5.381  1.00 16.78           O
ATOM    387  N   ASN 3   2      14.281   2.923   3.155  1.00 15.02           N
ATOM    388  CA  ASN 3   2      15.415   2.038   2.831  1.00 14.10           C
ATOM    389  C   ASN 3   2      16.696   2.537   3.427  1.00 13.13           C
ATOM    390  O   ASN 3   2      16.959   3.742   3.426  1.00 11.91           O
ATOM    391  CB  ASN 3   2      15.591   1.881   1.341  1.00 15.38           C
ATOM    392  CG  ASN 3   2      14.353   1.342   0.692  1.00 14.08           C
ATOM    393  OD1 ASN 3   2      13.912   0.227   1.016  1.00 17.46           O
ATOM    394  ND2 ASN 3   2      13.733   2.155  -0.169  1.00 11.72           N
TER
HETATM  395  O   HOH 4   8      15.466   5.227   7.124  1.00 22.62           O
HETATM  396  O   HOH 4  10      10.651   1.756  -1.468  1.00 17.08           O
HETATM  397  O   HOH 8  11       3.234  -3.120  12.472  1.00 23.99           O
ATOM    398  N   TYR 9   7     -13.645   6.683   6.147  1.00 14.70           N
ATOM    399  CA  TYR 9   7     -12.778   7.010   7.299  1.00 15.18           C
ATOM    400  C   TYR 9   7     -11.334   7.197   6.885  1.00 15.91           C
ATOM    401  O   TYR 9   7     -10.896   6.677   5.855  1.00 15.76           O
ATOM    402  CB  TYR 9   7     -12.876   5.931   8.369  1.00 15.35           C
ATOM    403  CG  TYR 9   7     -14.272   5.795   8.902  1.00 14.45           C
ATOM    404  CD1 TYR 9   7     -14.727   6.622   9.920  1.00 14.80           C
ATOM    405  CD2 TYR 9   7     -15.166   4.887   8.327  1.00 15.68           C
ATOM    406  CE1 TYR 9   7     -16.033   6.515  10.416  1.00 14.33           C
ATOM    407  CE2 TYR 9   7     -16.457   4.772   8.796  1.00 13.46           C
ATOM    408  CZ  TYR 9   7     -16.890   5.595   9.831  1.00 15.09           C
ATOM    409  OH  TYR 9   7     -18.171   5.455  10.291  1.00 14.39           O
ATOM    410  OXT TYR 9   7     -10.579   7.865   7.612  1.00 17.49           O
TER
HETATM  411  O   HOH a   9     -11.506   6.724   3.216  1.00 19.71           O
HETATM  412  O   HOH a  12      -8.332   6.193   9.198  1.00 26.17           O
ATOM    413  N   ASN f   2      14.281   7.789   3.155  1.00 15.02           N
ATOM    414  CA  ASN f   2      15.415   6.904   2.831  1.00 14.10           C
ATOM    415  C   ASN f   2      16.696   7.403   3.427  1.00 13.13           C
ATOM    416  O   ASN f   2      16.959   8.608   3.426  1.00 11.91           O
ATOM    417  CB  ASN f   2      15.591   6.747   1.341  1.00 15.38           C
ATOM    418  CG  ASN f   2      14.353   6.208   0.692  1.00 14.08           C
ATOM    419  OD1 ASN f   2      13.912   5.093   1.016  1.00 17.46           O
ATOM    420  ND2 ASN f   2      13.733   7.021  -0.169  1.00 11.72           N
TER
ATOM    421  N   TYR h   7       6.750   9.116  16.295  1.00 14.70           N
ATOM    422  CA  TYR h   7       5.883   9.443  15.143  1.00 15.18           C
ATOM    423  C   TYR h   7       4.439   9.630  15.557  1.00 15.91           C
ATOM    424  O   TYR h   7       4.001   9.110  16.587  1.00 15.76           O
ATOM    425  CB  TYR h   7       5.981   8.364  14.073  1.00 15.35           C
ATOM    426  CG  TYR h   7       7.377   8.228  13.540  1.00 14.45           C
ATOM    427  CD1 TYR h   7       7.832   9.055  12.522  1.00 14.80           C
ATOM    428  CD2 TYR h   7       8.271   7.320  14.115  1.00 15.68           C
ATOM    429  CE1 TYR h   7       9.138   8.948  12.026  1.00 14.33           C
ATOM    430  CE2 TYR h   7       9.562   7.205  13.646  1.00 13.46           C
ATOM    431  CZ  TYR h   7       9.995   8.028  12.611  1.00 15.09           C
ATOM    432  OH  TYR h   7      11.276   7.888  12.151  1.00 14.39           O
ATOM    433  OXT TYR h   7       3.684  10.298  14.830  1.00 17.49           O
TER
"""

def exercise_01():
  geom_ncs, log_ncs=get_geometry_stats(pdb_str, True)
  geom_no_ncs, log_no_ncs=get_geometry_stats(pdb_str, False)
  assert not show_diff(geom_ncs, geom_no_ncs)
  # assert not show_diff(log_ncs, log_no_ncs)
  assert_lines_in_text(log_ncs, """   Restraints were copied for chains:
    X, h, B, H, R, f
""")
  # print(log_ncs)

if(__name__ == "__main__"):
  if libtbx.env.find_in_repositories(relative_path="chem_data") is None:
    print("Skipping exercise_01(): chem_data directory not available")
  else:
    exercise_01()
    print('OK')



 *******************************************************************************


 *******************************************************************************
mmtbx/regression/real_space_refine_chain/tst_00.py
from __future__ import absolute_import, division, print_function
import time
import iotbx.pdb
import mmtbx.utils
from scitbx.array_family import flex
from cctbx import maptbx
from libtbx import adopt_init_args
from mmtbx import monomer_library
import mmtbx.refinement.real_space.explode_and_refine

pdb_str_answer = """\
CRYST1   29.475   46.191   27.490  90.00  90.00  90.00 P 21 21 21
HELIX    1   1 ALA E    1  ALA E   16  1                                  16
ATOM      1  N   ALA E   1      14.622  35.477  13.274  1.00 40.00           N
ATOM      2  CA  ALA E   1      14.323  35.055  14.635  1.00 40.00           C
ATOM      3  C   ALA E   1      13.442  33.808  14.656  1.00 40.00           C
ATOM      4  O   ALA E   1      13.848  32.796  15.227  1.00 40.00           O
ATOM      5  CB  ALA E   1      13.675  36.191  15.414  1.00 40.00           C
ATOM      6  N   ALA E   2      12.256  33.870  14.012  1.00 40.00           N
ATOM      7  CA  ALA E   2      11.288  32.768  13.916  1.00 40.00           C
ATOM      8  C   ALA E   2      11.847  31.573  13.125  1.00 40.00           C
ATOM      9  O   ALA E   2      11.553  30.422  13.462  1.00 40.00           O
ATOM     10  CB  ALA E   2      10.000  33.267  13.276  1.00 40.00           C
ATOM     11  N   ALA E   3      12.664  31.856  12.084  1.00 40.00           N
ATOM     12  CA  ALA E   3      13.313  30.854  11.231  1.00 40.00           C
ATOM     13  C   ALA E   3      14.391  30.082  11.994  1.00 40.00           C
ATOM     14  O   ALA E   3      14.616  28.906  11.687  1.00 40.00           O
ATOM     15  CB  ALA E   3      13.915  31.517  10.000  1.00 40.00           C
ATOM     16  N   ALA E   4      15.063  30.744  12.976  1.00 40.00           N
ATOM     17  CA  ALA E   4      16.089  30.116  13.822  1.00 40.00           C
ATOM     18  C   ALA E   4      15.441  29.043  14.703  1.00 40.00           C
ATOM     19  O   ALA E   4      15.888  27.897  14.671  1.00 40.00           O
ATOM     20  CB  ALA E   4      16.785  31.160  14.683  1.00 40.00           C
ATOM     21  N   ALA E   5      14.338  29.398  15.423  1.00 40.00           N
ATOM     22  CA  ALA E   5      13.573  28.488  16.298  1.00 40.00           C
ATOM     23  C   ALA E   5      13.042  27.288  15.513  1.00 40.00           C
ATOM     24  O   ALA E   5      12.981  26.179  16.048  1.00 40.00           O
ATOM     25  CB  ALA E   5      12.433  29.233  16.975  1.00 40.00           C
ATOM     26  N   ALA E   6      12.715  27.518  14.221  1.00 40.00           N
ATOM     27  CA  ALA E   6      12.258  26.514  13.260  1.00 40.00           C
ATOM     28  C   ALA E   6      13.440  25.620  12.865  1.00 40.00           C
ATOM     29  O   ALA E   6      13.361  24.405  13.060  1.00 40.00           O
ATOM     30  CB  ALA E   6      11.664  27.193  12.032  1.00 40.00           C
ATOM     31  N   ALA E   7      14.556  26.234  12.374  1.00 40.00           N
ATOM     32  CA  ALA E   7      15.788  25.543  11.962  1.00 40.00           C
ATOM     33  C   ALA E   7      16.411  24.694  13.075  1.00 40.00           C
ATOM     34  O   ALA E   7      16.954  23.625  12.782  1.00 40.00           O
ATOM     35  CB  ALA E   7      16.806  26.540  11.433  1.00 40.00           C
ATOM     36  N   ALA E   8      16.327  25.168  14.343  1.00 40.00           N
ATOM     37  CA  ALA E   8      16.846  24.459  15.515  1.00 40.00           C
ATOM     38  C   ALA E   8      16.009  23.197  15.768  1.00 40.00           C
ATOM     39  O   ALA E   8      16.568  22.097  15.858  1.00 40.00           O
ATOM     40  CB  ALA E   8      16.833  25.368  16.742  1.00 40.00           C
ATOM     41  N   ALA E   9      14.664  23.357  15.803  1.00 40.00           N
ATOM     42  CA  ALA E   9      13.716  22.261  15.994  1.00 40.00           C
ATOM     43  C   ALA E   9      13.754  21.279  14.822  1.00 40.00           C
ATOM     44  O   ALA E   9      13.654  20.075  15.051  1.00 40.00           O
ATOM     45  CB  ALA E   9      12.314  22.805  16.193  1.00 40.00           C
ATOM     46  N   ALA E  10      13.942  21.791  13.578  1.00 40.00           N
ATOM     47  CA  ALA E  10      14.063  20.985  12.357  1.00 40.00           C
ATOM     48  C   ALA E  10      15.322  20.116  12.421  1.00 40.00           C
ATOM     49  O   ALA E  10      15.235  18.910  12.169  1.00 40.00           O
ATOM     50  CB  ALA E  10      14.105  21.881  11.130  1.00 40.00           C
ATOM     51  N   ALA E  11      16.480  20.722  12.803  1.00 40.00           N
ATOM     52  CA  ALA E  11      17.754  20.018  12.967  1.00 40.00           C
ATOM     53  C   ALA E  11      17.631  18.976  14.089  1.00 40.00           C
ATOM     54  O   ALA E  11      18.074  17.837  13.908  1.00 40.00           O
ATOM     55  CB  ALA E  11      18.870  21.004  13.279  1.00 40.00           C
ATOM     56  N   ALA E  12      16.972  19.356  15.217  1.00 40.00           N
ATOM     57  CA  ALA E  12      16.721  18.483  16.371  1.00 40.00           C
ATOM     58  C   ALA E  12      15.851  17.277  15.972  1.00 40.00           C
ATOM     59  O   ALA E  12      16.201  16.140  16.310  1.00 40.00           O
ATOM     60  CB  ALA E  12      16.052  19.269  17.490  1.00 40.00           C
ATOM     61  N   ALA E  13      14.748  17.535  15.215  1.00 40.00           N
ATOM     62  CA  ALA E  13      13.821  16.516  14.708  1.00 40.00           C
ATOM     63  C   ALA E  13      14.530  15.563  13.752  1.00 40.00           C
ATOM     64  O   ALA E  13      14.266  14.360  13.793  1.00 40.00           O
ATOM     65  CB  ALA E  13      12.636  17.173  14.008  1.00 40.00           C
ATOM     66  N   ALA E  14      15.437  16.112  12.903  1.00 40.00           N
ATOM     67  CA  ALA E  14      16.246  15.367  11.939  1.00 40.00           C
ATOM     68  C   ALA E  14      17.277  14.511  12.676  1.00 40.00           C
ATOM     69  O   ALA E  14      17.512  13.363  12.286  1.00 40.00           O
ATOM     70  CB  ALA E  14      16.942  16.329  10.986  1.00 40.00           C
ATOM     71  N   ALA E  15      17.863  15.069  13.767  1.00 40.00           N
ATOM     72  CA  ALA E  15      18.847  14.407  14.629  1.00 40.00           C
ATOM     73  C   ALA E  15      18.213  13.257  15.427  1.00 40.00           C
ATOM     74  O   ALA E  15      18.922  12.322  15.816  1.00 40.00           O
ATOM     75  CB  ALA E  15      19.475  15.418  15.573  1.00 40.00           C
ATOM     76  N   ALA E  16      16.879  13.325  15.652  1.00 40.00           N
ATOM     77  CA  ALA E  16      16.099  12.317  16.370  1.00 40.00           C
ATOM     78  C   ALA E  16      15.822  11.106  15.488  1.00 40.00           C
ATOM     79  O   ALA E  16      15.658  10.000  15.999  1.00 40.00           O
ATOM     80  CB  ALA E  16      14.790  12.918  16.852  1.00 40.00           C
TER
END
"""

pdb_str_poor = """\
CRYST1   29.475   46.191   27.490  90.00  90.00  90.00 P 21 21 21
ATOM      1  N   ALA E   1      17.517  34.071   6.538  1.00 40.00           N
ATOM      2  CA  ALA E   1      17.992  35.348   7.004  1.00 40.00           C
ATOM      3  C   ALA E   1      16.863  35.986   7.792  1.00 40.00           C
ATOM      4  O   ALA E   1      16.713  37.242   7.909  1.00 40.00           O
ATOM      5  CB  ALA E   1      18.477  36.116   5.812  1.00 40.00           C
ATOM      6  N   ALA E   2      16.080  35.113   8.348  1.00 40.00           N
ATOM      7  CA  ALA E   2      15.254  35.581   9.495  1.00 40.00           C
ATOM      8  C   ALA E   2      15.628  35.262  10.863  1.00 40.00           C
ATOM      9  O   ALA E   2      16.066  36.143  11.629  1.00 40.00           O
ATOM     10  CB  ALA E   2      13.821  35.144   9.297  1.00 40.00           C
ATOM     11  N   ALA E   3      15.670  34.035  11.221  1.00 40.00           N
ATOM     12  CA  ALA E   3      15.746  33.569  12.729  1.00 40.00           C
ATOM     13  C   ALA E   3      16.380  32.197  13.043  1.00 40.00           C
ATOM     14  O   ALA E   3      17.557  32.017  13.009  1.00 40.00           O
ATOM     15  CB  ALA E   3      14.390  33.574  13.297  1.00 40.00           C
ATOM     16  N   ALA E   4      15.437  31.334  13.516  1.00 40.00           N
ATOM     17  CA  ALA E   4      15.810  29.953  13.900  1.00 40.00           C
ATOM     18  C   ALA E   4      14.876  28.948  13.219  1.00 40.00           C
ATOM     19  O   ALA E   4      15.088  28.561  12.135  1.00 40.00           O
ATOM     20  CB  ALA E   4      15.807  29.747  15.562  1.00 40.00           C
ATOM     21  N   ALA E   5      13.827  28.582  13.930  1.00 40.00           N
ATOM     22  CA  ALA E   5      12.803  27.643  13.582  1.00 40.00           C
ATOM     23  C   ALA E   5      11.925  27.972  12.295  1.00 40.00           C
ATOM     24  O   ALA E   5      11.311  29.016  12.217  1.00 40.00           O
ATOM     25  CB  ALA E   5      11.884  27.496  14.800  1.00 40.00           C
ATOM     26  N   ALA E   6      11.824  27.002  11.326  1.00 40.00           N
ATOM     27  CA  ALA E   6      11.579  27.271   9.948  1.00 40.00           C
ATOM     28  C   ALA E   6      10.688  26.172   9.315  1.00 40.00           C
ATOM     29  O   ALA E   6       9.810  26.435   8.479  1.00 40.00           O
ATOM     30  CB  ALA E   6      12.892  27.434   9.163  1.00 40.00           C
ATOM     31  N   ALA E   7      10.985  24.936   9.568  1.00 40.00           N
ATOM     32  CA  ALA E   7      10.223  23.915   8.805  1.00 40.00           C
ATOM     33  C   ALA E   7       9.182  23.205   9.603  1.00 40.00           C
ATOM     34  O   ALA E   7       7.945  23.417   9.434  1.00 40.00           O
ATOM     35  CB  ALA E   7      11.183  22.804   8.200  1.00 40.00           C
ATOM     36  N   ALA E   8       9.745  22.435  10.542  1.00 40.00           N
ATOM     37  CA  ALA E   8       9.210  21.425  11.476  1.00 40.00           C
ATOM     38  C   ALA E   8      10.256  20.419  11.733  1.00 40.00           C
ATOM     39  O   ALA E   8       9.992  19.490  12.460  1.00 40.00           O
ATOM     40  CB  ALA E   8       7.965  20.817  10.947  1.00 40.00           C
ATOM     41  N   ALA E   9      11.466  20.737  11.268  1.00 40.00           N
ATOM     42  CA  ALA E   9      12.607  19.889  11.232  1.00 40.00           C
ATOM     43  C   ALA E   9      12.924  19.328  12.523  1.00 40.00           C
ATOM     44  O   ALA E   9      12.790  20.050  13.539  1.00 40.00           O
ATOM     45  CB  ALA E   9      13.739  20.662  10.656  1.00 40.00           C
ATOM     46  N   ALA E  10      13.495  18.150  12.482  1.00 40.00           N
ATOM     47  CA  ALA E  10      14.007  17.595  13.654  1.00 40.00           C
ATOM     48  C   ALA E  10      15.157  16.724  13.724  1.00 40.00           C
ATOM     49  O   ALA E  10      15.159  16.000  14.620  1.00 40.00           O
ATOM     50  CB  ALA E  10      12.870  16.878  14.366  1.00 40.00           C
ATOM     51  N   ALA E  11      16.092  16.782  12.766  1.00 40.00           N
ATOM     52  CA  ALA E  11      17.076  15.791  12.430  1.00 40.00           C
ATOM     53  C   ALA E  11      16.462  14.506  11.790  1.00 40.00           C
ATOM     54  O   ALA E  11      15.459  14.602  11.077  1.00 40.00           O
ATOM     55  CB  ALA E  11      17.943  15.352  13.622  1.00 40.00           C
ATOM     56  N   ALA E  12      17.191  13.458  11.773  1.00 40.00           N
ATOM     57  CA  ALA E  12      16.985  12.246  11.074  1.00 40.00           C
ATOM     58  C   ALA E  12      17.956  11.169  11.712  1.00 40.00           C
ATOM     59  O   ALA E  12      18.839  10.657  11.173  1.00 40.00           O
ATOM     60  CB  ALA E  12      17.278  12.440   9.655  1.00 40.00           C
ATOM     61  N   ALA E  13      17.693  10.781  12.936  1.00 40.00           N
ATOM     62  CA  ALA E  13      18.559   9.862  13.648  1.00 40.00           C
ATOM     63  C   ALA E  13      17.678   8.677  14.105  1.00 40.00           C
ATOM     64  O   ALA E  13      16.810   8.236  13.332  1.00 40.00           O
ATOM     65  CB  ALA E  13      19.221  10.551  14.826  1.00 40.00           C
ATOM     66  N   ALA E  14      17.647   8.453  15.439  1.00 40.00           N
ATOM     67  CA  ALA E  14      16.666   7.551  16.066  1.00 40.00           C
ATOM     68  C   ALA E  14      15.298   8.147  16.400  1.00 40.00           C
ATOM     69  O   ALA E  14      14.633   7.785  17.376  1.00 40.00           O
ATOM     70  CB  ALA E  14      17.224   7.034  17.308  1.00 40.00           C
ATOM     71  N   ALA E  15      14.855   9.000  15.485  1.00 40.00           N
ATOM     72  CA  ALA E  15      13.517   9.710  15.635  1.00 40.00           C
ATOM     73  C   ALA E  15      12.304   8.858  15.586  1.00 40.00           C
ATOM     74  O   ALA E  15      11.625   8.812  14.564  1.00 40.00           O
ATOM     75  CB  ALA E  15      13.302  10.842  14.526  1.00 40.00           C
ATOM     76  N   ALA E  16      12.014   8.140  16.649  1.00 40.00           N
ATOM     77  CA  ALA E  16      11.279   6.863  16.560  1.00 40.00           C
ATOM     78  C   ALA E  16      10.003   6.986  17.409  1.00 40.00           C
ATOM     79  O   ALA E  16       9.883   8.020  18.086  1.00 40.00           O
ATOM     80  CB  ALA E  16      12.188   5.653  16.999  1.00 40.00           C
TER
"""

def ccp4_map(crystal_symmetry, file_name, map_data):
  from iotbx import mrcfile
  mrcfile.write_ccp4_map(
      file_name=file_name,
      unit_cell=crystal_symmetry.unit_cell(),
      space_group=crystal_symmetry.space_group(),
      #gridding_first=(0,0,0),# This causes a bug (map gets shifted)
      #gridding_last=n_real,  # This causes a bug (map gets shifted)
      map_data=map_data,
      labels=flex.std_string([""]))

class scorer(object):
  def __init__(self, pdb_hierarchy, unit_cell, map_data):
    adopt_init_args(self, locals())
    self.sites_cart = self.pdb_hierarchy.atoms().extract_xyz()
    self.target = maptbx.real_space_target_simple(
      unit_cell   = self.unit_cell,
      density_map = self.map_data,
      sites_cart  = self.sites_cart)

  def update(self, sites_cart):
    target = maptbx.real_space_target_simple(
      unit_cell   = self.unit_cell,
      density_map = self.map_data,
      sites_cart  = sites_cart)
    if(target > self.target):
      self.target = target
      self.sites_cart = sites_cart
    print(self.target, target) # XXX for debugging

def run(prefix="tst_00"):
  # Good answer model
  pdb_file_name_answer = "%s_answer.pdb"%prefix
  pdb_inp = iotbx.pdb.input(source_info=None, lines = pdb_str_answer)
  pdb_inp.write_pdb_file(file_name="%s_answer.pdb"%prefix)
  ph_answer = pdb_inp.construct_hierarchy()
  ph_answer.atoms().reset_i_seq()
  xrs_answer = pdb_inp.xray_structure_simple()
  # Poor model that we want to refine so it matches the answer
  pdb_file_name_poor = "%s_poor.pdb"%prefix
  pdb_inp = iotbx.pdb.input(source_info=None, lines = pdb_str_poor)
  pdb_inp.write_pdb_file(file_name="%s_poor.pdb"%prefix)
  ph_poor = pdb_inp.construct_hierarchy()
  ph_poor.atoms().reset_i_seq()
  xrs_poor = pdb_inp.xray_structure_simple()
  # Initialize states accumulator
  states = mmtbx.utils.states(pdb_hierarchy=ph_answer)
  states.add(sites_cart = xrs_poor.sites_cart())
  # Compute target map
  fc = xrs_answer.structure_factors(d_min=3.5).f_calc()
  fft_map = fc.fft_map(resolution_factor = 0.25)
  fft_map.apply_sigma_scaling()
  target_map_data = fft_map.real_map_unpadded()
  ccp4_map(crystal_symmetry=fc.crystal_symmetry(), file_name="map.ccp4",
    map_data=target_map_data)
  # Output map coefficients
  mtz_dataset = fc.as_mtz_dataset(column_root_label="FC")
  mtz_object = mtz_dataset.mtz_object()
  mtz_object.write(file_name = "map.mtz")
  # Build geometry restraints
  params = monomer_library.pdb_interpretation.master_params.extract()
  #params.nonbonded_weight=200
  #params.peptide_link.ramachandran_restraints=True
  #params.peptide_link.rama_potential="emsley"
  processed_pdb_file = monomer_library.pdb_interpretation.process(
    mon_lib_srv              = monomer_library.server.server(),
    ener_lib                 = monomer_library.server.ener_lib(),
    raw_records              = pdb_str_poor,
    params                   = params,
    strict_conflict_handling = True,
    force_symmetry           = True,
    log                      = None)

  geometry = processed_pdb_file.geometry_restraints_manager(
    show_energies                = False,
    plain_pairs_radius           = 5,
    assume_hydrogens_all_missing = True)
  restraints_manager = mmtbx.restraints.manager(
    geometry      = geometry,
    normalization = True)
  # Do real-space refinement
  t0=time.time()
  ear = mmtbx.refinement.real_space.explode_and_refine.run(
    xray_structure          = xrs_poor,
    pdb_hierarchy           = ph_poor,
    map_data                = target_map_data,
    restraints_manager      = restraints_manager,
    states                  = states,
    nproc=1)
  print("Time: %6.4f"%(time.time()-t0))
  ear.pdb_hierarchy.write_pdb_file(file_name="%s_refined.pdb"%prefix)
  states.write(file_name="%s_refined_all_states.pdb"%prefix)

if (__name__ == "__main__"):
  run()
  print("OK")


 *******************************************************************************
