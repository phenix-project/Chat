

 *******************************************************************************
mmtbx/hydrogens/tst_connectivity.py
from __future__ import absolute_import, division, print_function
import time
import mmtbx.model
import iotbx.pdb
from mmtbx.hydrogens import connectivity
from libtbx.utils import null_out

pdb_str = """\
CRYST1   17.955   13.272   13.095  90.00  90.00  90.00 P 1
ATOM      1  N   TYR A 139      10.241   7.920   5.000  1.00 10.00           N
ATOM      2  CA  TYR A 139      10.853   7.555   6.271  1.00 10.00           C
ATOM      3  C   TYR A 139      12.362   7.771   6.227  1.00 10.00           C
ATOM      4  O   TYR A 139      12.955   8.272   7.181  1.00 10.00           O
ATOM      5  CB  TYR A 139      10.540   6.098   6.617  1.00 10.00           C
ATOM      6  CG  TYR A 139       9.063   5.805   6.749  1.00 10.00           C
ATOM      7  CD1 TYR A 139       8.316   5.391   5.654  1.00 10.00           C
ATOM      8  CD2 TYR A 139       8.414   5.943   7.969  1.00 10.00           C
ATOM      9  CE1 TYR A 139       6.966   5.122   5.770  1.00 10.00           C
ATOM     10  CE2 TYR A 139       7.064   5.676   8.095  1.00 10.00           C
ATOM     11  CZ  TYR A 139       6.345   5.266   6.993  1.00 10.00           C
ATOM     12  OH  TYR A 139       5.000   5.000   7.113  1.00 10.00           O
ATOM     13  HA  TYR A 139      10.480   8.127   6.960  1.00 10.00           H
ATOM     14  HB2 TYR A 139      10.915   5.524   5.931  1.00 10.00           H
ATOM     15  HB3 TYR A 139      10.982   5.870   7.450  1.00 10.00           H
ATOM     16  HD1 TYR A 139       8.732   5.293   4.828  1.00 10.00           H
ATOM     17  HD2 TYR A 139       8.896   6.220   8.714  1.00 10.00           H
ATOM     18  HE1 TYR A 139       6.479   4.845   5.028  1.00 10.00           H
ATOM     19  HE2 TYR A 139       6.643   5.772   8.919  1.00 10.00           H
ATOM     20  HH  TYR A 139       4.759   5.128   7.907  1.00 10.00           H
TER
END
"""

#----------------------------------------------------
# This test checks for residue Tyr (pdb_str above):
# - if all bonds involving H atoms are recognized
# - if all angles involving H atoms are recognized
# - if 3rd neighbors of HH atom are correctly found
#----------------------------------------------------

def exercise():
  pdb_inp = iotbx.pdb.input(lines=pdb_str.split("\n"), source_info=None)
  model = mmtbx.model.manager(
    model_input = pdb_inp,
    log         = null_out())
  model.process(make_restraints=True)
  restraints_manager = model.get_restraints_manager()
  angle_proxies = restraints_manager.geometry.get_all_angle_proxies()

  connectivity_manager = connectivity.determine_connectivity(
    pdb_hierarchy       = model.get_hierarchy(),
    geometry_restraints = restraints_manager.geometry)
  h_connectivity = connectivity_manager.h_connectivity

# get bonds stored in connectivity
  bond_list = {}
  angle_list = {}
  for neighbors in h_connectivity:
    if (neighbors is None): continue
    ih = neighbors.ih
    a0 = neighbors.a0
    i_a0 = a0['iseq']
    a1 = neighbors.a1
    i_a1 = a1['iseq']
    bond_list[ih] = [i_a0, a0['dist_ideal']]
    selected_atoms = tuple(sorted([ih, i_a0, i_a1]))
    angle_list[selected_atoms] = a1['angle_ideal']
    if neighbors.a2:
      a2 = neighbors.a2
      selected_atoms2 = tuple(sorted([ih, i_a0, a2['iseq']]))
      angle_list[selected_atoms2] = a2['angle_ideal']
    if neighbors.a3:
      a3 = neighbors.a3
      selected_atoms3 = tuple(sorted([ih, i_a0, a3['iseq']]))
      angle_list[selected_atoms3] = a3['angle_ideal']
    if neighbors.h1:
      h1 = neighbors.h1
      selected_atoms4 = tuple(sorted([ih, i_a0, h1['iseq']]))
      angle_list[selected_atoms4] =h1['angle_ideal']
    if neighbors.b1:
      i_b1 = neighbors.b1['iseq']
      third_nb_dict = {ih: i_b1}

  bond_ctrl = {}
  for i in model.xh_connectivity_table():
    bond_ctrl[i[1]]=[i[0],i[3]]

# List of angle restraints
  angles = [
    (4, 1, 12),

    (0, 1, 12),
    (2, 1, 12),
    (13, 4, 14),
    (5, 4, 14),
    (5, 4, 13),
    (1, 4, 13),
    (1, 4, 14),
    (8, 6, 15),
    (5, 6, 15),
    (9, 7, 16),
    (5, 7, 16),
    (10, 8, 17),
    (6, 8, 17),
    (10, 11, 19),
    (7, 9, 18),
    (10, 9, 18)]

  angle_ctrl = {}
  for ap in angle_proxies:
    if(ap.i_seqs in angles):
      angle_ctrl[tuple(sorted(list(ap.i_seqs)))] = ap.angle_ideal

# HH needs also third neighbors:
  third_nb_ctrl = {19: 8}

  assert (bond_list == bond_ctrl), '1-2 neighbors and distance_ideal are wrong'
  assert (angle_list == angle_ctrl), '1-3 neighbors and angle_ideal are wrong'
  assert (third_nb_dict == third_nb_ctrl), '1-4 neighbors are wrong'

if (__name__ == "__main__"):
  t0 = time.time()
  exercise()
  print("OK. Time: %8.3f"%(time.time()-t0))


 *******************************************************************************


 *******************************************************************************
mmtbx/hydrogens/tst_parameterization_1.py
from __future__ import absolute_import, division, print_function
import time
import mmtbx.model
import iotbx.pdb
from libtbx.utils import null_out
from six.moves import zip

#-----------------------------------------------------------------------------
# This test checks the parameterization of hydrogen atoms for amino acids
# Steps:
# 1) determine parameterization
# 2) Compare calculated position of H from parameterization to input position
# test fails if distance is > 0.001 A (= precision of coordinates)
#-----------------------------------------------------------------------------

def exercise():
  pdb_inp = iotbx.pdb.input(lines=pdb_str.split("\n"), source_info=None)
  model = mmtbx.model.manager(
    model_input = pdb_inp,
    log         = null_out())
  model.process(make_restraints=True)
  pdb_hierarchy = model.get_hierarchy()
  sites_cart = model.get_sites_cart()
  atoms = pdb_hierarchy.atoms()

  model.setup_riding_h_manager()
  riding_h_manager = model.get_riding_h_manager()

  h_parameterization = riding_h_manager.h_parameterization

  diagnostics = riding_h_manager.diagnostics(
    sites_cart         = sites_cart,
    threshold          = 0.05)

  h_distances        = diagnostics.h_distances
  type_list          = diagnostics.type_list

# number of H atoms in model
  number_h = model.get_hd_selection().count(True)
# number of H in parameterization
  number_h_para = len(h_parameterization) - h_parameterization.count(None)

# There are 152 H atoms in pdb_string, check if all of them are parameterized
  assert (number_h_para == number_h), 'Not all H atoms are parameterized'

# For each H atom, check if distance compared to input model is not > 0.05
# 0.0014 = uncertainty for distance if uncertainty of coordinate = 0.001
  for ih in h_distances:
    labels = atoms[ih].fetch_labels()
    assert (h_distances[ih] < 0.05), \
      'distance too large: %s  atom: %s (%s) residue: %s ' \
      % (h_parameterization[ih].htype, atoms[ih].name, ih, labels.resseq.strip())

# KEEP: useful for debugging
  #for ih in h_parameterization.keys():
  #  hp = h_parameterization[ih]
  #  print "'"+hp.htype+"'"+',',

  for type1, type2 in zip(type_list, type_list_known):
    assert (type1 == type2)

# Ideal amino acids
pdb_str = """\
CRYST1   30.000   30.000   30.000  90.00  90.00  90.00 P 1
SCALE1      0.033333  0.000000  0.000000        0.00000
SCALE2      0.000000  0.033333  0.000000        0.00000
SCALE3      0.000000  0.000000  0.033333        0.00000
ATOM      1  N   ARG A   2       3.050  19.481  25.856  1.00  0.00           N
ATOM      2  CA  ARG A   2       3.759  20.265  24.852  1.00  0.00           C
ATOM      3  C   ARG A   2       5.253  20.304  25.155  1.00  0.00           C
ATOM      4  O   ARG A   2       5.659  20.516  26.298  1.00  0.00           O
ATOM      5  CB  ARG A   2       3.197  21.687  24.787  1.00  0.00           C
ATOM      6  CG  ARG A   2       3.800  22.542  23.684  1.00  0.00           C
ATOM      7  CD  ARG A   2       3.128  23.904  23.607  1.00  0.00           C
ATOM      8  NE  ARG A   2       3.721  24.751  22.576  1.00  0.00           N
ATOM      9  CZ  ARG A   2       3.311  25.983  22.290  1.00  0.00           C
ATOM     10  NH1 ARG A   2       2.301  26.525  22.957  1.00  0.00           N1+
ATOM     11  NH2 ARG A   2       3.914  26.676  21.334  1.00  0.00           N
ATOM     12  HA  ARG A   2       3.638  19.852  23.983  1.00  0.00           H
ATOM     13  HB2 ARG A   2       2.240  21.637  24.633  1.00  0.00           H
ATOM     14  HB3 ARG A   2       3.370  22.129  25.633  1.00  0.00           H
ATOM     15  HG2 ARG A   2       4.743  22.680  23.864  1.00  0.00           H
ATOM     16  HG3 ARG A   2       3.682  22.096  22.831  1.00  0.00           H
ATOM     17  HD2 ARG A   2       2.189  23.783  23.396  1.00  0.00           H
ATOM     18  HD3 ARG A   2       3.224  24.355  24.460  1.00  0.00           H
ATOM     19  HE  ARG A   2       4.380  24.432  22.124  1.00  0.00           H
ATOM     20 HH11 ARG A   2       1.905  26.082  23.579  1.00  0.00           H
ATOM     21 HH12 ARG A   2       2.041  27.322  22.767  1.00  0.00           H
ATOM     22 HH21 ARG A   2       4.569  26.329  20.898  1.00  0.00           H
ATOM     23 HH22 ARG A   2       3.649  27.473  21.149  1.00  0.00           H
ATOM     24  N   HIS A   3       6.067  20.098  24.123  1.00  0.00           N
ATOM     25  CA  HIS A   3       7.516  20.107  24.260  1.00  0.00           C
ATOM     26  C   HIS A   3       8.133  20.732  23.018  1.00  0.00           C
ATOM     27  O   HIS A   3       7.638  20.536  21.904  1.00  0.00           O
ATOM     28  CB  HIS A   3       8.069  18.691  24.464  1.00  0.00           C
ATOM     29  CG  HIS A   3       7.630  18.050  25.743  1.00  0.00           C
ATOM     30  ND1 HIS A   3       8.154  18.399  26.969  1.00  0.00           N
ATOM     31  CD2 HIS A   3       6.716  17.080  25.988  1.00  0.00           C
ATOM     32  CE1 HIS A   3       7.582  17.674  27.913  1.00  0.00           C
ATOM     33  NE2 HIS A   3       6.706  16.865  27.344  1.00  0.00           N
ATOM     34  H   HIS A   3       5.797  19.948  23.320  1.00  0.00           H
ATOM     35  HA  HIS A   3       7.764  20.646  25.027  1.00  0.00           H
ATOM     36  HB2 HIS A   3       7.768  18.129  23.732  1.00  0.00           H
ATOM     37  HB3 HIS A   3       9.038  18.731  24.470  1.00  0.00           H
ATOM     38  HD2 HIS A   3       6.194  16.642  25.355  1.00  0.00           H
ATOM     39  HE1 HIS A   3       7.765  17.723  28.824  1.00  0.00           H
ATOM     40  N   LYS A   4       9.213  21.483  23.217  1.00  0.00           N
ATOM     41  CA  LYS A   4       9.902  22.139  22.116  1.00  0.00           C
ATOM     42  C   LYS A   4      11.340  22.409  22.530  1.00  0.00           C
ATOM     43  O   LYS A   4      11.602  22.774  23.678  1.00  0.00           O
ATOM     44  CB  LYS A   4       9.205  23.447  21.722  1.00  0.00           C
ATOM     45  CG  LYS A   4       9.799  24.121  20.495  1.00  0.00           C
ATOM     46  CD  LYS A   4       9.008  25.357  20.102  1.00  0.00           C
ATOM     47  CE  LYS A   4       9.606  26.035  18.880  1.00  0.00           C
ATOM     48  NZ  LYS A   4       8.842  27.250  18.484  1.00  0.00           N1+
ATOM     49  H   LYS A   4       9.568  21.628  23.987  1.00  0.00           H
ATOM     50  HA  LYS A   4       9.909  21.551  21.344  1.00  0.00           H
ATOM     51  HB2 LYS A   4       8.272  23.258  21.533  1.00  0.00           H
ATOM     52  HB3 LYS A   4       9.270  24.070  22.462  1.00  0.00           H
ATOM     53  HG2 LYS A   4      10.710  24.392  20.688  1.00  0.00           H
ATOM     54  HG3 LYS A   4       9.784  23.500  19.750  1.00  0.00           H
ATOM     55  HD2 LYS A   4       8.096  25.101  19.892  1.00  0.00           H
ATOM     56  HD3 LYS A   4       9.018  25.991  20.837  1.00  0.00           H
ATOM     57  HE2 LYS A   4      10.517  26.302  19.078  1.00  0.00           H
ATOM     58  HE3 LYS A   4       9.594  25.415  18.135  1.00  0.00           H
ATOM     59  HZ1 LYS A   4       9.215  27.624  17.768  1.00  0.00           H
ATOM     60  HZ2 LYS A   4       8.001  27.031  18.292  1.00  0.00           H
ATOM     61  HZ3 LYS A   4       8.842  27.840  19.151  1.00  0.00           H
ATOM     62  N   ASP A   5      12.263  22.226  21.588  1.00  0.00           N
ATOM     63  CA  ASP A   5      13.678  22.447  21.845  1.00  0.00           C
ATOM     64  C   ASP A   5      14.374  22.763  20.531  1.00  0.00           C
ATOM     65  O   ASP A   5      14.035  22.197  19.489  1.00  0.00           O
ATOM     66  CB  ASP A   5      14.324  21.224  22.508  1.00  0.00           C
ATOM     67  CG  ASP A   5      15.729  21.504  23.005  1.00  0.00           C
ATOM     68  OD1 ASP A   5      16.213  22.640  22.819  1.00  0.00           O
ATOM     69  OD2 ASP A   5      16.350  20.587  23.582  1.00  0.00           O1-
ATOM     70  H   ASP A   5      12.091  21.972  20.785  1.00  0.00           H
ATOM     71  HA  ASP A   5      13.783  23.208  22.438  1.00  0.00           H
ATOM     72  HB2 ASP A   5      13.785  20.954  23.267  1.00  0.00           H
ATOM     73  HB3 ASP A   5      14.372  20.503  21.861  1.00  0.00           H
ATOM     74  N   GLU A   6      15.346  23.668  20.589  1.00  0.00           N
ATOM     75  CA  GLU A   6      16.096  24.064  19.403  1.00  0.00           C
ATOM     76  C   GLU A   6      17.433  24.684  19.794  1.00  0.00           C
ATOM     77  O   GLU A   6      17.829  24.647  20.959  1.00  0.00           O
ATOM     78  CB  GLU A   6      15.283  25.051  18.561  1.00  0.00           C
ATOM     79  CG  GLU A   6      15.942  25.433  17.245  1.00  0.00           C
ATOM     80  CD  GLU A   6      15.076  26.352  16.405  1.00  0.00           C
ATOM     81  OE1 GLU A   6      13.969  26.708  16.861  1.00  0.00           O
ATOM     82  OE2 GLU A   6      15.503  26.718  15.290  1.00  0.00           O1-
ATOM     83  H   GLU A   6      15.592  24.070  21.309  1.00  0.00           H
ATOM     84  HA  GLU A   6      16.273  23.279  18.862  1.00  0.00           H
ATOM     85  HB2 GLU A   6      14.424  24.651  18.356  1.00  0.00           H
ATOM     86  HB3 GLU A   6      15.153  25.864  19.073  1.00  0.00           H
ATOM     87  HG2 GLU A   6      16.776  25.893  17.428  1.00  0.00           H
ATOM     88  HG3 GLU A   6      16.112  24.628  16.730  1.00  0.00           H
TER
ATOM     89  N   SER B   2      10.846   4.462  24.534  1.00  0.00           N
ATOM     90  CA  SER B   2      11.518   5.747  24.391  1.00  0.00           C
ATOM     91  C   SER B   2      13.032   5.575  24.457  1.00  0.00           C
ATOM     92  O   SER B   2      13.532   4.595  25.009  1.00  0.00           O
ATOM     93  CB  SER B   2      11.052   6.719  25.477  1.00  0.00           C
ATOM     94  OG  SER B   2      11.455   6.279  26.762  1.00  0.00           O
ATOM     95  HA  SER B   2      11.295   6.129  23.528  1.00  0.00           H
ATOM     96  HB2 SER B   2      11.440   7.591  25.307  1.00  0.00           H
ATOM     97  HB3 SER B   2      10.084   6.777  25.453  1.00  0.00           H
ATOM     98  HG  SER B   2      11.125   5.523  26.924  1.00  0.00           H
ATOM     99  N   THR B   3      13.758   6.536  23.889  1.00  0.00           N
ATOM    100  CA  THR B   3      15.212   6.498  23.880  1.00  0.00           C
ATOM    101  C   THR B   3      15.741   7.920  23.778  1.00  0.00           C
ATOM    102  O   THR B   3      15.212   8.733  23.015  1.00  0.00           O
ATOM    103  CB  THR B   3      15.746   5.652  22.717  1.00  0.00           C
ATOM    104  OG1 THR B   3      15.230   4.319  22.813  1.00  0.00           O
ATOM    105  CG2 THR B   3      17.268   5.606  22.740  1.00  0.00           C
ATOM    106  H   THR B   3      13.425   7.226  23.499  1.00  0.00           H
ATOM    107  HA  THR B   3      15.530   6.111  24.711  1.00  0.00           H
ATOM    108  HB  THR B   3      15.465   6.046  21.876  1.00  0.00           H
ATOM    109  HG1 THR B   3      15.519   3.852  22.178  1.00  0.00           H
ATOM    110 HG21 THR B   3      17.587   4.933  22.118  1.00  0.00           H
ATOM    111 HG22 THR B   3      17.633   6.467  22.484  1.00  0.00           H
ATOM    112 HG23 THR B   3      17.580   5.381  23.631  1.00  0.00           H
ATOM    113  N   ASN B   4      16.785   8.212  24.552  1.00  0.00           N
ATOM    114  CA  ASN B   4      17.402   9.533  24.564  1.00  0.00           C
ATOM    115  C   ASN B   4      18.904   9.364  24.725  1.00  0.00           C
ATOM    116  O   ASN B   4      19.359   8.747  25.692  1.00  0.00           O
ATOM    117  CB  ASN B   4      16.835  10.400  25.693  1.00  0.00           C
ATOM    118  CG  ASN B   4      15.357  10.690  25.518  1.00  0.00           C
ATOM    119  OD1 ASN B   4      14.528  10.254  26.317  1.00  0.00           O
ATOM    120  ND2 ASN B   4      15.019  11.430  24.468  1.00  0.00           N
ATOM    121  H   ASN B   4      17.158   7.651  25.086  1.00  0.00           H
ATOM    122  HA  ASN B   4      17.232   9.979  23.719  1.00  0.00           H
ATOM    123  HB2 ASN B   4      16.953   9.937  26.537  1.00  0.00           H
ATOM    124  HB3 ASN B   4      17.307  11.247  25.709  1.00  0.00           H
ATOM    125 HD21 ASN B   4      14.193  11.622  24.326  1.00  0.00           H
ATOM    126 HD22 ASN B   4      15.626  11.717  23.931  1.00  0.00           H
ATOM    127  N   GLN B   5      19.666   9.908  23.781  1.00  0.00           N
ATOM    128  CA  GLN B   5      21.121   9.817  23.821  1.00  0.00           C
ATOM    129  C   GLN B   5      21.756  11.122  23.352  1.00  0.00           C
ATOM    130  O   GLN B   5      21.299  11.734  22.387  1.00  0.00           O
ATOM    131  CB  GLN B   5      21.610   8.654  22.957  1.00  0.00           C
ATOM    132  CG  GLN B   5      21.217   7.283  23.483  1.00  0.00           C
ATOM    133  CD  GLN B   5      21.709   6.155  22.598  1.00  0.00           C
ATOM    134  OE1 GLN B   5      22.296   6.391  21.542  1.00  0.00           O
ATOM    135  NE2 GLN B   5      21.472   4.920  23.025  1.00  0.00           N
ATOM    136  H   GLN B   5      19.362  10.339  23.102  1.00  0.00           H
ATOM    137  HA  GLN B   5      21.406   9.656  24.734  1.00  0.00           H
ATOM    138  HB2 GLN B   5      21.235   8.747  22.067  1.00  0.00           H
ATOM    139  HB3 GLN B   5      22.578   8.686  22.909  1.00  0.00           H
ATOM    140  HG2 GLN B   5      21.600   7.161  24.366  1.00  0.00           H
ATOM    141  HG3 GLN B   5      20.250   7.227  23.530  1.00  0.00           H
ATOM    142 HE21 GLN B   5      21.732   4.246  22.559  1.00  0.00           H
ATOM    143 HE22 GLN B   5      21.059   4.795  23.769  1.00  0.00           H
TER
ATOM    144  N   CYS C   2      14.789  22.141   7.021  1.00  0.00           N
ATOM    145  CA  CYS C   2      15.170  23.547   7.063  1.00  0.00           C
ATOM    146  C   CYS C   2      16.660  23.696   7.350  1.00  0.00           C
ATOM    147  O   CYS C   2      17.074  23.780   8.506  1.00  0.00           O
ATOM    148  CB  CYS C   2      14.354  24.292   8.122  1.00  0.00           C
ATOM    149  SG  CYS C   2      14.698  26.064   8.213  1.00  0.00           S
ATOM    150  HA  CYS C   2      14.987  23.952   6.201  1.00  0.00           H
ATOM    151  HB2 CYS C   2      13.411  24.185   7.920  1.00  0.00           H
ATOM    152  HB3 CYS C   2      14.548  23.908   8.991  1.00  0.00           H
ATOM    153  HG  CYS C   2      14.012  26.553   9.067  1.00  0.00           H
ATOM    154  N   GLY C   3      17.463  23.727   6.287  1.00  0.00           N
ATOM    155  CA  GLY C   3      18.892  23.864   6.428  1.00  0.00           C
ATOM    156  C   GLY C   3      19.301  25.288   6.737  1.00  0.00           C
ATOM    157  O   GLY C   3      18.476  26.206   6.840  1.00  0.00           O
ATOM    158  H   GLY C   3      17.194  23.670   5.472  1.00  0.00           H
ATOM    159  HA2 GLY C   3      19.202  23.291   7.146  1.00  0.00           H
ATOM    160  HA3 GLY C   3      19.325  23.590   5.604  1.00  0.00           H
ATOM    161  N   PRO C   4      20.618  25.490   6.891  1.00  0.00           N
ATOM    162  CA  PRO C   4      21.173  26.813   7.198  1.00  0.00           C
ATOM    163  C   PRO C   4      21.113  27.768   6.010  1.00  0.00           C
ATOM    164  O   PRO C   4      21.345  27.333   4.882  1.00  0.00           O
ATOM    165  CB  PRO C   4      22.622  26.503   7.578  1.00  0.00           C
ATOM    166  CG  PRO C   4      22.943  25.252   6.843  1.00  0.00           C
ATOM    167  CD  PRO C   4      21.667  24.460   6.790  1.00  0.00           C
ATOM    168  HA  PRO C   4      20.715  27.207   7.957  1.00  0.00           H
ATOM    169  HB2 PRO C   4      23.199  27.228   7.291  1.00  0.00           H
ATOM    170  HB3 PRO C   4      22.689  26.366   8.536  1.00  0.00           H
ATOM    171  HG2 PRO C   4      23.244  25.471   5.947  1.00  0.00           H
ATOM    172  HG3 PRO C   4      23.628  24.761   7.322  1.00  0.00           H
ATOM    173  HD2 PRO C   4      21.599  23.988   5.945  1.00  0.00           H
ATOM    174  HD3 PRO C   4      21.617  23.851   7.543  1.00  0.00           H
TER
ATOM    175  N   ALA D   2       2.619   6.211   7.571  1.00  0.00           N
ATOM    176  CA  ALA D   2       3.623   7.047   8.219  1.00  0.00           C
ATOM    177  C   ALA D   2       4.961   6.321   8.294  1.00  0.00           C
ATOM    178  O   ALA D   2       5.056   5.233   8.863  1.00  0.00           O
ATOM    179  CB  ALA D   2       3.159   7.450   9.610  1.00  0.00           C
ATOM    180  HA  ALA D   2       3.748   7.855   7.697  1.00  0.00           H
ATOM    181  HB1 ALA D   2       3.840   8.005  10.021  1.00  0.00           H
ATOM    182  HB2 ALA D   2       2.329   7.947   9.534  1.00  0.00           H
ATOM    183  HB3 ALA D   2       3.018   6.650  10.139  1.00  0.00           H
ATOM    184  N   LEU D   3       6.002   6.934   7.712  1.00  0.00           N
ATOM    185  CA  LEU D   3       7.348   6.371   7.695  1.00  0.00           C
ATOM    186  C   LEU D   3       8.344   7.510   7.935  1.00  0.00           C
ATOM    187  O   LEU D   3       9.150   7.868   7.078  1.00  0.00           O
ATOM    188  CB  LEU D   3       7.634   5.644   6.379  1.00  0.00           C
ATOM    189  CG  LEU D   3       6.792   4.396   6.105  1.00  0.00           C
ATOM    190  CD1 LEU D   3       7.036   3.888   4.692  1.00  0.00           C
ATOM    191  CD2 LEU D   3       7.088   3.307   7.125  1.00  0.00           C
ATOM    192  H   LEU D   3       5.945   7.694   7.313  1.00  0.00           H
ATOM    193  HA  LEU D   3       7.438   5.734   8.421  1.00  0.00           H
ATOM    194  HB2 LEU D   3       7.479   6.264   5.649  1.00  0.00           H
ATOM    195  HB3 LEU D   3       8.565   5.371   6.377  1.00  0.00           H
ATOM    196  HG  LEU D   3       5.853   4.628   6.180  1.00  0.00           H
ATOM    197 HD11 LEU D   3       6.493   3.099   4.543  1.00  0.00           H
ATOM    198 HD12 LEU D   3       6.791   4.583   4.061  1.00  0.00           H
ATOM    199 HD13 LEU D   3       7.975   3.668   4.594  1.00  0.00           H
ATOM    200 HD21 LEU D   3       6.619   2.498   6.867  1.00  0.00           H
ATOM    201 HD22 LEU D   3       8.044   3.144   7.143  1.00  0.00           H
ATOM    202 HD23 LEU D   3       6.785   3.600   7.998  1.00  0.00           H
ATOM    203  N   ILE D   4       8.286   8.091   9.130  1.00  0.00           N
ATOM    204  CA  ILE D   4       9.174   9.189   9.499  1.00  0.00           C
ATOM    205  C   ILE D   4      10.531   8.595   9.863  1.00  0.00           C
ATOM    206  O   ILE D   4      10.691   7.990  10.926  1.00  0.00           O
ATOM    207  CB  ILE D   4       8.599  10.013  10.657  1.00  0.00           C
ATOM    208  CG1 ILE D   4       7.284  10.674  10.236  1.00  0.00           C
ATOM    209  CG2 ILE D   4       9.604  11.067  11.108  1.00  0.00           C
ATOM    210  CD1 ILE D   4       6.474  11.224  11.392  1.00  0.00           C
ATOM    211  H   ILE D   4       7.736   7.865   9.751  1.00  0.00           H
ATOM    212  HA  ILE D   4       9.293   9.777   8.736  1.00  0.00           H
ATOM    213  HB  ILE D   4       8.421   9.417  11.401  1.00  0.00           H
ATOM    214 HG12 ILE D   4       7.482  11.410   9.637  1.00  0.00           H
ATOM    215 HG13 ILE D   4       6.734  10.018   9.778  1.00  0.00           H
ATOM    216 HG21 ILE D   4       9.158  11.702  11.690  1.00  0.00           H
ATOM    217 HG22 ILE D   4      10.326  10.633  11.590  1.00  0.00           H
ATOM    218 HG23 ILE D   4       9.953  11.525  10.328  1.00  0.00           H
ATOM    219 HD11 ILE D   4       5.603  11.498  11.065  1.00  0.00           H
ATOM    220 HD12 ILE D   4       6.373  10.531  12.063  1.00  0.00           H
ATOM    221 HD13 ILE D   4       6.939  11.986  11.771  1.00  0.00           H
ATOM    222  N   MET D   5      11.514   8.768   8.978  1.00  0.00           N
ATOM    223  CA  MET D   5      12.863   8.258   9.192  1.00  0.00           C
ATOM    224  C   MET D   5      13.872   9.277   8.657  1.00  0.00           C
ATOM    225  O   MET D   5      14.680   9.000   7.775  1.00  0.00           O
ATOM    226  CB  MET D   5      13.042   6.896   8.525  1.00  0.00           C
ATOM    227  CG  MET D   5      12.226   5.783   9.162  1.00  0.00           C
ATOM    228  SD  MET D   5      12.466   4.191   8.350  1.00  0.00           S
ATOM    229  CE  MET D   5      11.320   3.166   9.268  1.00  0.00           C
ATOM    230  H   MET D   5      11.418   9.186   8.232  1.00  0.00           H
ATOM    231  HA  MET D   5      13.009   8.144  10.144  1.00  0.00           H
ATOM    232  HB2 MET D   5      12.772   6.965   7.596  1.00  0.00           H
ATOM    233  HB3 MET D   5      13.977   6.644   8.577  1.00  0.00           H
ATOM    234  HG2 MET D   5      12.490   5.689  10.091  1.00  0.00           H
ATOM    235  HG3 MET D   5      11.284   6.009   9.107  1.00  0.00           H
ATOM    236  HE1 MET D   5      11.356   2.262   8.918  1.00  0.00           H
ATOM    237  HE2 MET D   5      11.574   3.169  10.204  1.00  0.00           H
ATOM    238  HE3 MET D   5      10.425   3.525   9.167  1.00  0.00           H
ATOM    239  N   PHE D   6      13.825  10.488   9.205  1.00  0.00           N
ATOM    240  CA  PHE D   6      14.731  11.547   8.787  1.00  0.00           C
ATOM    241  C   PHE D   6      16.111  11.331   9.393  1.00  0.00           C
ATOM    242  O   PHE D   6      16.244  10.831  10.514  1.00  0.00           O
ATOM    243  CB  PHE D   6      14.186  12.914   9.206  1.00  0.00           C
ATOM    244  CG  PHE D   6      12.873  13.276   8.562  1.00  0.00           C
ATOM    245  CD1 PHE D   6      12.416  12.605   7.437  1.00  0.00           C
ATOM    246  CD2 PHE D   6      12.093  14.294   9.087  1.00  0.00           C
ATOM    247  CE1 PHE D   6      11.210  12.943   6.852  1.00  0.00           C
ATOM    248  CE2 PHE D   6      10.887  14.635   8.506  1.00  0.00           C
ATOM    249  CZ  PHE D   6      10.445  13.959   7.388  1.00  0.00           C
ATOM    250  H   PHE D   6      13.274  10.720   9.823  1.00  0.00           H
ATOM    251  HA  PHE D   6      14.827  11.530   7.822  1.00  0.00           H
ATOM    252  HB2 PHE D   6      14.055  12.916  10.167  1.00  0.00           H
ATOM    253  HB3 PHE D   6      14.833  13.595   8.962  1.00  0.00           H
ATOM    254  HD1 PHE D   6      12.924  11.919   7.069  1.00  0.00           H
ATOM    255  HD2 PHE D   6      12.386  14.753   9.841  1.00  0.00           H
ATOM    256  HE1 PHE D   6      10.914  12.486   6.099  1.00  0.00           H
ATOM    257  HE2 PHE D   6      10.373  15.320   8.869  1.00  0.00           H
ATOM    258  HZ  PHE D   6       9.634  14.188   6.995  1.00  0.00           H
ATOM    259  N   TRP D   7      17.142  11.711   8.641  1.00  0.00           N
ATOM    260  CA  TRP D   7      18.523  11.570   9.084  1.00  0.00           C
ATOM    261  C   TRP D   7      19.334  12.742   8.558  1.00  0.00           C
ATOM    262  O   TRP D   7      19.223  13.098   7.381  1.00  0.00           O
ATOM    263  CB  TRP D   7      19.129  10.247   8.600  1.00  0.00           C
ATOM    264  CG  TRP D   7      18.518   9.038   9.242  1.00  0.00           C
ATOM    265  CD1 TRP D   7      17.534   8.246   8.727  1.00  0.00           C
ATOM    266  CD2 TRP D   7      18.852   8.483  10.520  1.00  0.00           C
ATOM    267  NE1 TRP D   7      17.234   7.232   9.605  1.00  0.00           N
ATOM    268  CE2 TRP D   7      18.030   7.356  10.713  1.00  0.00           C
ATOM    269  CE3 TRP D   7      19.767   8.831  11.519  1.00  0.00           C
ATOM    270  CZ2 TRP D   7      18.095   6.573  11.864  1.00  0.00           C
ATOM    271  CZ3 TRP D   7      19.829   8.053  12.661  1.00  0.00           C
ATOM    272  CH2 TRP D   7      18.998   6.937  12.824  1.00  0.00           C
ATOM    273  H   TRP D   7      17.064  12.059   7.859  1.00  0.00           H
ATOM    274  HA  TRP D   7      18.555  11.585  10.053  1.00  0.00           H
ATOM    275  HB2 TRP D   7      18.996  10.173   7.642  1.00  0.00           H
ATOM    276  HB3 TRP D   7      20.077  10.244   8.803  1.00  0.00           H
ATOM    277  HD1 TRP D   7      17.125   8.373   7.901  1.00  0.00           H
ATOM    278  HE1 TRP D   7      16.644   6.620   9.479  1.00  0.00           H
ATOM    279  HE3 TRP D   7      20.322   9.570  11.418  1.00  0.00           H
ATOM    280  HZ2 TRP D   7      17.544   5.832  11.976  1.00  0.00           H
ATOM    281  HZ3 TRP D   7      20.434   8.274  13.332  1.00  0.00           H
ATOM    282  HH2 TRP D   7      19.063   6.433  13.603  1.00  0.00           H
ATOM    283  N   TYR D   8      20.146  13.338   9.431  1.00  0.00           N
ATOM    284  CA  TYR D   8      20.988  14.478   9.066  1.00  0.00           C
ATOM    285  C   TYR D   8      22.308  14.337   9.818  1.00  0.00           C
ATOM    286  O   TYR D   8      22.402  14.703  10.993  1.00  0.00           O
ATOM    287  CB  TYR D   8      20.302  15.800   9.392  1.00  0.00           C
ATOM    288  CG  TYR D   8      19.076  16.075   8.551  1.00  0.00           C
ATOM    289  CD1 TYR D   8      19.192  16.579   7.263  1.00  0.00           C
ATOM    290  CD2 TYR D   8      17.801  15.832   9.046  1.00  0.00           C
ATOM    291  CE1 TYR D   8      18.075  16.832   6.490  1.00  0.00           C
ATOM    292  CE2 TYR D   8      16.678  16.082   8.282  1.00  0.00           C
ATOM    293  CZ  TYR D   8      16.820  16.582   7.005  1.00  0.00           C
ATOM    294  OH  TYR D   8      15.704  16.833   6.240  1.00  0.00           O
ATOM    295  H   TYR D   8      20.228  13.097  10.252  1.00  0.00           H
ATOM    296  HA  TYR D   8      21.173  14.454   8.115  1.00  0.00           H
ATOM    297  HB2 TYR D   8      20.027  15.788  10.322  1.00  0.00           H
ATOM    298  HB3 TYR D   8      20.931  16.523   9.244  1.00  0.00           H
ATOM    299  HD1 TYR D   8      20.037  16.749   6.913  1.00  0.00           H
ATOM    300  HD2 TYR D   8      17.703  15.494   9.907  1.00  0.00           H
ATOM    301  HE1 TYR D   8      18.168  17.170   5.629  1.00  0.00           H
ATOM    302  HE2 TYR D   8      15.831  15.914   8.626  1.00  0.00           H
ATOM    303  HH  TYR D   8      15.010  16.638   6.671  1.00  0.00           H
ATOM    304  N   VAL D   9      23.320  13.807   9.139  1.00  0.00           N
ATOM    305  CA  VAL D   9      24.632  13.618   9.743  1.00  0.00           C
ATOM    306  C   VAL D   9      25.377  14.947   9.786  1.00  0.00           C
ATOM    307  O   VAL D   9      25.756  15.491   8.749  1.00  0.00           O
ATOM    308  CB  VAL D   9      25.449  12.559   8.980  1.00  0.00           C
ATOM    309  CG1 VAL D   9      26.843  12.427   9.578  1.00  0.00           C
ATOM    310  CG2 VAL D   9      24.726  11.220   8.995  1.00  0.00           C
ATOM    311  H   VAL D   9      23.271  13.548   8.320  1.00  0.00           H
ATOM    312  HA  VAL D   9      24.518  13.309  10.655  1.00  0.00           H
ATOM    313  HB  VAL D   9      25.544  12.838   8.056  1.00  0.00           H
ATOM    314 HG11 VAL D   9      27.251  11.612   9.245  1.00  0.00           H
ATOM    315 HG12 VAL D   9      27.376  13.193   9.316  1.00  0.00           H
ATOM    316 HG13 VAL D   9      26.769  12.386  10.544  1.00  0.00           H
ATOM    317 HG21 VAL D   9      25.275  10.560   8.542  1.00  0.00           H
ATOM    318 HG22 VAL D   9      24.578  10.952   9.915  1.00  0.00           H
ATOM    319 HG23 VAL D   9      23.876  11.314   8.536  1.00  0.00           H
TER
END
"""

type_list_known = ['3neigbs', '2tetra', '2tetra', '2tetra', '2tetra', '2tetra',
  '2tetra', 'flat_2neigbs', 'alg1a', 'alg1a', 'alg1a', 'alg1a', 'flat_2neigbs',
  '3neigbs', '2tetra', '2tetra', 'flat_2neigbs', 'flat_2neigbs', 'flat_2neigbs',
  '3neigbs', '2tetra', '2tetra', '2tetra', '2tetra', '2tetra', '2tetra', '2tetra',
  '2tetra', 'prop', 'prop', 'prop', 'flat_2neigbs', '3neigbs', '2tetra', '2tetra',
  'flat_2neigbs', '3neigbs', '2tetra', '2tetra', '2tetra', '2tetra', '3neigbs',
  '2tetra', '2tetra', 'alg1b', 'flat_2neigbs', '3neigbs', '3neigbs', 'alg1b',
  'prop', 'prop', 'prop', 'flat_2neigbs', '3neigbs', '2tetra', '2tetra', 'alg1a',
  'alg1a', 'flat_2neigbs', '3neigbs', '2tetra', '2tetra', '2tetra', '2tetra',
  'alg1a', 'alg1a', '3neigbs', '2tetra', '2tetra', 'alg1b', 'flat_2neigbs',
  '2tetra', '2tetra', '3neigbs', '2tetra', '2tetra', '2tetra', '2tetra', '2tetra',
  '2tetra', '3neigbs', 'prop', 'prop', 'prop', 'flat_2neigbs', '3neigbs', '2tetra',
  '2tetra', '3neigbs', 'prop', 'prop', 'prop', 'prop', 'prop', 'prop', 'flat_2neigbs',
  '3neigbs', '3neigbs', '2tetra', '2tetra', 'prop', 'prop', 'prop', 'prop', 'prop',
  'prop', 'flat_2neigbs', '3neigbs', '2tetra', '2tetra', '2tetra', '2tetra', 'prop',
  'prop', 'prop', 'flat_2neigbs', '3neigbs', '2tetra', '2tetra', 'flat_2neigbs',
  'flat_2neigbs', 'flat_2neigbs', 'flat_2neigbs', 'flat_2neigbs', 'flat_2neigbs',
  '3neigbs', '2tetra', '2tetra', 'flat_2neigbs', 'flat_2neigbs', 'flat_2neigbs',
  'flat_2neigbs', 'flat_2neigbs', 'flat_2neigbs', 'flat_2neigbs', '3neigbs',
  '2tetra', '2tetra', 'flat_2neigbs', 'flat_2neigbs', 'flat_2neigbs', 'flat_2neigbs',
  'alg1b', 'flat_2neigbs', '3neigbs', '3neigbs', 'prop', 'prop', 'prop', 'prop',
  'prop', 'prop']


if (__name__ == "__main__"):
  t0 = time.time()
  exercise()
  print("OK. Time: %8.3f"%(time.time()-t0))


 *******************************************************************************


 *******************************************************************************
mmtbx/hydrogens/tst_parameterization_2.py
from __future__ import absolute_import, division, print_function
import time
import mmtbx.model
import iotbx.pdb
from libtbx.utils import null_out
from six.moves import zip

#-----------------------------------------------------------------------------
# This test checks the parameterization of hydrogen atoms for nucleic acids
# Steps:
# 1) determine parameterization
# 2) Compare calculated position of H from parameterization to input position
# test fails if distance is > 0.001 A (= precision of coordinates)
#-----------------------------------------------------------------------------

def exercise():
  pdb_inp = iotbx.pdb.input(lines=pdb_str.split("\n"), source_info=None)
  model = mmtbx.model.manager(
    model_input = pdb_inp,
    log         = null_out())
  model.process(make_restraints=True)
  pdb_hierarchy = model.get_hierarchy()
  sites_cart = model.get_sites_cart()
  atoms = pdb_hierarchy.atoms()

  model.setup_riding_h_manager()
  riding_h_manager = model.get_riding_h_manager()

  h_parameterization = riding_h_manager.h_parameterization

  diagnostics = riding_h_manager.diagnostics(
    sites_cart = sites_cart,
    threshold  = 0.05)
  h_distances   = diagnostics.h_distances
  type_list     = diagnostics.type_list

  number_h = model.get_hd_selection().count(True)
  number_h_para = len(h_parameterization) - h_parameterization.count(None)

# There are 90 H atoms in pdb_string, check if all of them are recognized
  assert (number_h_para == number_h), 'Not all H atoms are parameterized'

# For every H , check if distance between computed H and H in input model is
# < 0.03 A
  for ih in h_distances:
    labels = atoms[ih].fetch_labels()
    assert (h_distances[ih] < 0.03), 'distance too large: %s  atom: %s (%s) residue: %s ' \
      % (h_parameterization[ih].htype, atoms[ih].name, ih, labels.resseq.strip())

# Check if parameterization types are correct
  for type1, type2 in zip(type_list, type_list_known):
    assert (type1 == type2)

# DNA and RNA nucleic acids
pdb_str = """\
CRYST1   30.000   30.000   30.000  90.00  90.00  90.00 P 1
SCALE1      0.033333  0.000000  0.000000        0.00000
SCALE2      0.000000  0.033333  0.000000        0.00000
SCALE3      0.000000  0.000000  0.033333        0.00000
ATOM      1  P    DA A   1       4.321   6.421   9.951  1.00 76.88           P
ATOM      2  OP1  DA A   1       3.975   5.004  10.200  1.00 78.59           O
ATOM      3  OP2  DA A   1       3.621   7.495  10.691  1.00 75.20           O
ATOM      4  O5'  DA A   1       5.895   6.618  10.165  1.00 78.76           O
ATOM      5  C5'  DA A   1       6.704   5.513  10.551  1.00 77.93           C
ATOM      6  C4'  DA A   1       8.179   5.858  10.453  1.00 78.66           C
ATOM      7  O4'  DA A   1       8.521   6.124   9.066  1.00 79.49           O
ATOM      8  C3'  DA A   1       8.598   7.103  11.220  1.00 78.23           C
ATOM      9  O3'  DA A   1       8.961   6.778  12.559  1.00 77.17           O
ATOM     10  C2'  DA A   1       9.776   7.622  10.408  1.00 79.34           C
ATOM     11  C1'  DA A   1       9.411   7.226   8.980  1.00 78.22           C
ATOM     12  N9   DA A   1       8.758   8.292   8.225  1.00 20.00           N
ATOM     13  C8   DA A   1       7.414   8.503   8.091  1.00 20.00           C
ATOM     14  N7   DA A   1       7.112   9.543   7.350  1.00 20.00           N
ATOM     15  C5   DA A   1       8.344  10.050   6.971  1.00 20.00           C
ATOM     16  C6   DA A   1       8.713  11.153   6.176  1.00 20.00           C
ATOM     17  N6   DA A   1       7.829  11.974   5.600  1.00 20.00           N
ATOM     18  N1   DA A   1      10.031  11.381   5.996  1.00 20.00           N
ATOM     19  C2   DA A   1      10.913  10.557   6.575  1.00 20.00           C
ATOM     20  N3   DA A   1      10.687   9.491   7.341  1.00 20.00           N
ATOM     21  C4   DA A   1       9.369   9.291   7.502  1.00 20.00           C
ATOM     22  H5'  DA A   1       6.514   4.760   9.969  1.00 77.93           H
ATOM     23 H5''  DA A   1       6.494   5.269  11.466  1.00 77.93           H
ATOM     24  H4'  DA A   1       8.701   5.104  10.767  1.00 78.66           H
ATOM     25  H3'  DA A   1       7.879   7.754  11.217  1.00 78.23           H
ATOM     26  H2'  DA A   1       9.849   8.586  10.488  1.00 79.34           H
ATOM     27 H2''  DA A   1      10.599   7.190  10.683  1.00 79.34           H
ATOM     28  H1'  DA A   1      10.214   6.951   8.511  1.00 78.22           H
ATOM     29  H8   DA A   1       6.772   7.960   8.488  1.00 20.00           H
ATOM     30  H61  DA A   1       8.103  12.635   5.123  1.00 20.00           H
ATOM     31  H62  DA A   1       6.986  11.841   5.706  1.00 20.00           H
ATOM     32  H2   DA A   1      11.808  10.757   6.421  1.00 20.00           H
ATOM     33  P    DC A   2       8.575   7.768  13.765  1.00 76.88           P
ATOM     34  OP1  DC A   2       8.992   7.120  15.028  1.00 78.59           O
ATOM     35  OP2  DC A   2       7.165   8.176  13.578  1.00 75.20           O
ATOM     36  O5'  DC A   2       9.494   9.054  13.516  1.00 78.76           O
ATOM     37  C5'  DC A   2      10.911   8.922  13.497  1.00 77.93           C
ATOM     38  C4'  DC A   2      11.571  10.212  13.045  1.00 78.66           C
ATOM     39  O4'  DC A   2      11.202  10.488  11.669  1.00 79.49           O
ATOM     40  C3'  DC A   2      11.163  11.450  13.828  1.00 78.23           C
ATOM     41  O3'  DC A   2      11.993  11.627  14.972  1.00 77.17           O
ATOM     42  C2'  DC A   2      11.332  12.566  12.806  1.00 79.34           C
ATOM     43  C1'  DC A   2      10.997  11.881  11.483  1.00 78.22           C
ATOM     44  N1   DC A   2       9.591  12.099  11.036  1.00 20.00           N
ATOM     45  C2   DC A   2       9.254  13.276  10.359  1.00 20.00           C
ATOM     46  O2   DC A   2      10.133  14.120  10.143  1.00 20.00           O
ATOM     47  N3   DC A   2       7.972  13.459   9.959  1.00 20.00           N
ATOM     48  C4   DC A   2       7.054  12.524  10.212  1.00 20.00           C
ATOM     49  N4   DC A   2       5.802  12.749   9.798  1.00 20.00           N
ATOM     50  C5   DC A   2       7.378  11.318  10.900  1.00 20.00           C
ATOM     51  C6   DC A   2       8.646  11.149  11.290  1.00 20.00           C
ATOM     52  H5'  DC A   2      11.156   8.208  12.888  1.00 77.93           H
ATOM     53 H5''  DC A   2      11.222   8.701  14.389  1.00 77.93           H
ATOM     54  H4'  DC A   2      12.534  10.109  13.099  1.00 78.66           H
ATOM     55  H3'  DC A   2      10.233  11.382  14.095  1.00 78.23           H
ATOM     56  H2'  DC A   2      10.711  13.290  12.984  1.00 79.34           H
ATOM     57 H2''  DC A   2      12.247  12.890  12.802  1.00 79.34           H
ATOM     58  H1'  DC A   2      11.602  12.202  10.797  1.00 78.22           H
ATOM     59  H41  DC A   2       5.188  12.166   9.949  1.00 20.00           H
ATOM     60  H42  DC A   2       5.612  13.476   9.380  1.00 20.00           H
ATOM     61  H5   DC A   2       6.731  10.673  11.071  1.00 20.00           H
ATOM     62  H6   DC A   2       8.886  10.372  11.740  1.00 20.00           H
ATOM     63  P    DG A   3      11.380  12.226  16.332  1.00 76.88           P
ATOM     64  OP1  DG A   3      12.439  12.169  17.364  1.00 78.59           O
ATOM     65  OP2  DG A   3      10.081  11.560  16.572  1.00 75.20           O
ATOM     66  O5'  DG A   3      11.087  13.759  15.979  1.00 78.76           O
ATOM     67  C5'  DG A   3      12.153  14.613  15.582  1.00 77.93           C
ATOM     68  C4'  DG A   3      11.625  15.948  15.088  1.00 78.66           C
ATOM     69  O4'  DG A   3      10.821  15.738  13.897  1.00 79.49           O
ATOM     70  C3'  DG A   3      10.718  16.679  16.065  1.00 78.23           C
ATOM     71  O3'  DG A   3      11.476  17.512  16.939  1.00 77.17           O
ATOM     72  C2'  DG A   3       9.805  17.477  15.146  1.00 79.34           C
ATOM     73  C1'  DG A   3       9.678  16.578  13.920  1.00 78.22           C
ATOM     74  N9   DG A   3       8.483  15.738  13.931  1.00 20.00           N
ATOM     75  C8   DG A   3       8.377  14.458  14.419  1.00 20.00           C
ATOM     76  N7   DG A   3       7.181  13.952  14.294  1.00 20.00           N
ATOM     77  C5   DG A   3       6.447  14.961  13.684  1.00 20.00           C
ATOM     78  C6   DG A   3       5.086  14.991  13.297  1.00 20.00           C
ATOM     79  O6   DG A   3       4.233  14.102  13.422  1.00 20.00           O
ATOM     80  N1   DG A   3       4.744  16.208  12.711  1.00 20.00           N
ATOM     81  C2   DG A   3       5.609  17.261  12.523  1.00 20.00           C
ATOM     82  N2   DG A   3       5.096  18.354  11.940  1.00 20.00           N
ATOM     83  N3   DG A   3       6.886  17.245  12.881  1.00 20.00           N
ATOM     84  C4   DG A   3       7.234  16.067  13.454  1.00 20.00           C
ATOM     85  H5'  DG A   3      12.655  14.186  14.870  1.00 77.93           H
ATOM     86 H5''  DG A   3      12.740  14.763  16.340  1.00 77.93           H
ATOM     87  H4'  DG A   3      12.376  16.521  14.865  1.00 78.66           H
ATOM     88  H3'  DG A   3      10.199  16.041  16.579  1.00 78.23           H
ATOM     89  H2'  DG A   3       8.938  17.616  15.561  1.00 79.34           H
ATOM     90 H2''  DG A   3      10.213  18.325  14.909  1.00 79.34           H
ATOM     91  H1'  DG A   3       9.672  17.129  13.121  1.00 78.22           H
ATOM     92  H8   DG A   3       9.088  13.997  14.801  1.00 20.00           H
ATOM     93  H1   DG A   3       3.932  16.308  12.447  1.00 20.00           H
ATOM     94  H21  DG A   3       5.594  19.042  11.803  1.00 20.00           H
ATOM     95  H22  DG A   3       4.269  18.367  11.703  1.00 20.00           H
ATOM     96  P    DT A   4      11.038  17.682  18.476  1.00 76.88           P
ATOM     97  OP1  DT A   4      12.063  18.517  19.142  1.00 78.59           O
ATOM     98  OP2  DT A   4      10.727  16.337  19.007  1.00 75.20           O
ATOM     99  O5'  DT A   4       9.670  18.508  18.398  1.00 78.76           O
ATOM    100  C5'  DT A   4       9.648  19.790  17.782  1.00 77.93           C
ATOM    101  C4'  DT A   4       8.226  20.307  17.653  1.00 78.66           C
ATOM    102  O4'  DT A   4       7.471  19.434  16.774  1.00 79.49           O
ATOM    103  C3'  DT A   4       7.437  20.345  18.951  1.00 78.23           C
ATOM    104  O3'  DT A   4       7.650  21.574  19.642  1.00 77.17           O
ATOM    105  C2'  DT A   4       5.998  20.186  18.477  1.00 79.34           C
ATOM    106  C1'  DT A   4       6.134  19.307  17.235  1.00 78.22           C
ATOM    107  N1   DT A   4       5.854  17.865  17.489  1.00 20.00           N
ATOM    108  C2   DT A   4       4.559  17.407  17.408  1.00 20.00           C
ATOM    109  O2   DT A   4       3.613  18.124  17.136  1.00 20.00           O
ATOM    110  N3   DT A   4       4.408  16.069  17.658  1.00 20.00           N
ATOM    111  C4   DT A   4       5.402  15.162  17.975  1.00 20.00           C
ATOM    112  O4   DT A   4       5.166  13.976  18.183  1.00 20.00           O
ATOM    113  C5   DT A   4       6.738  15.708  18.044  1.00 20.00           C
ATOM    114  C7   DT A   4       7.899  14.820  18.380  1.00 20.00           C
ATOM    115  C6   DT A   4       6.898  17.018  17.800  1.00 20.00           C
ATOM    116  H5'  DT A   4      10.044  19.726  16.899  1.00 77.93           H
ATOM    117 H5''  DT A   4      10.164  20.411  18.319  1.00 77.93           H
ATOM    118  H4'  DT A   4       8.247  21.198  17.270  1.00 78.66           H
ATOM    119  H3'  DT A   4       7.687  19.597  19.515  1.00 78.23           H
ATOM    120 HO3'  DT A   4       7.975  21.569  20.416  1.00 77.17           H
ATOM    121  H2'  DT A   4       5.463  19.742  19.153  1.00 79.34           H
ATOM    122 H2''  DT A   4       5.617  21.047  18.247  1.00 79.34           H
ATOM    123  H1'  DT A   4       5.530  19.632  16.549  1.00 78.22           H
ATOM    124  H3   DT A   4       3.607  15.760  17.614  1.00 20.00           H
ATOM    125  H71  DT A   4       8.506  14.781  17.623  1.00 20.00           H
ATOM    126  H72  DT A   4       8.367  15.177  19.151  1.00 20.00           H
ATOM    127  H73  DT A   4       7.577  13.927  18.582  1.00 20.00           H
ATOM    128  H6   DT A   4       7.756  17.372  17.844  1.00 20.00           H
TER
ATOM    129  P     A B   1      18.553   9.499  13.673  1.00 76.88           P
ATOM    130  OP1   A B   1      18.244   8.077  13.965  1.00 78.59           O
ATOM    131  OP2   A B   1      18.063  10.559  14.590  1.00 75.20           O
ATOM    132  O5'   A B   1      20.135   9.645  13.551  1.00 78.76           O
ATOM    133  C5'   A B   1      20.984   8.516  13.690  1.00 77.93           C
ATOM    134  C4'   A B   1      22.397   8.832  13.268  1.00 78.66           C
ATOM    135  O4'   A B   1      22.420   9.197  11.863  1.00 79.49           O
ATOM    136  C3'   A B   1      23.053  10.012  13.969  1.00 78.23           C
ATOM    137  O3'   A B   1      23.578   9.678  15.242  1.00 77.17           O
ATOM    138  C2'   A B   1      24.112  10.447  12.965  1.00 79.34           C
ATOM    139  O2'   A B   1      25.261   9.616  13.036  1.00 79.34           O
ATOM    140  C1'   A B   1      23.396  10.192  11.639  1.00 78.22           C
ATOM    141  N9    A B   1      22.725  11.403  11.128  1.00 20.00           N
ATOM    142  C8    A B   1      21.387  11.706  11.176  1.00 20.00           C
ATOM    143  N7    A B   1      21.088  12.863  10.637  1.00 20.00           N
ATOM    144  C5    A B   1      22.312  13.355  10.204  1.00 20.00           C
ATOM    145  C6    A B   1      22.676  14.544   9.548  1.00 20.00           C
ATOM    146  N6    A B   1      21.805  15.494   9.199  1.00 20.00           N
ATOM    147  N1    A B   1      23.983  14.727   9.259  1.00 20.00           N
ATOM    148  C2    A B   1      24.857  13.775   9.609  1.00 20.00           C
ATOM    149  N3    A B   1      24.636  12.617  10.227  1.00 20.00           N
ATOM    150  C4    A B   1      23.329  12.466  10.500  1.00 20.00           C
ATOM    151  H5'   A B   1      20.643   7.794  13.139  1.00 77.93           H
ATOM    152 H5''   A B   1      20.986   8.233  14.618  1.00 77.93           H
ATOM    153  H4'   A B   1      22.948   8.043  13.397  1.00 78.66           H
ATOM    154  H3'   A B   1      22.401  10.723  14.070  1.00 78.23           H
ATOM    155  H2'   A B   1      24.339  11.384  13.071  1.00 79.34           H
ATOM    156 HO2'   A B   1      25.651   9.749  13.767  1.00 79.34           H
ATOM    157  H1'   A B   1      24.035   9.875  10.982  1.00 78.22           H
ATOM    158  H8    A B   1      20.752  11.143  11.556  1.00 20.00           H
ATOM    159  H61   A B   1      22.081  16.203   8.797  1.00 20.00           H
ATOM    160  H62   A B   1      20.969  15.398   9.376  1.00 20.00           H
ATOM    161  H2    A B   1      25.744  13.946   9.388  1.00 20.00           H
ATOM    162  P     C B   2      23.325  10.645  16.500  1.00 76.88           P
ATOM    163  OP1   C B   2      23.900   9.992  17.704  1.00 78.59           O
ATOM    164  OP2   C B   2      21.895  11.044  16.495  1.00 75.20           O
ATOM    165  O5'   C B   2      24.199  11.937  16.177  1.00 78.76           O
ATOM    166  C5'   C B   2      25.609  11.848  16.041  1.00 77.93           C
ATOM    167  C4'   C B   2      26.197  13.135  15.518  1.00 78.66           C
ATOM    168  O4'   C B   2      25.672  13.412  14.193  1.00 79.49           O
ATOM    169  C3'   C B   2      25.871  14.389  16.315  1.00 78.23           C
ATOM    170  O3'   C B   2      26.696  14.550  17.457  1.00 77.17           O
ATOM    171  C2'   C B   2      26.036  15.493  15.280  1.00 79.34           C
ATOM    172  O2'   C B   2      27.405  15.824  15.094  1.00 79.34           O
ATOM    173  C1'   C B   2      25.517  14.805  14.017  1.00 78.22           C
ATOM    174  N1    C B   2      24.086  15.094  13.772  1.00 20.00           N
ATOM    175  C2    C B   2      23.736  16.306  13.170  1.00 20.00           C
ATOM    176  O2    C B   2      24.634  17.102  12.859  1.00 20.00           O
ATOM    177  N3    C B   2      22.430  16.578  12.942  1.00 20.00           N
ATOM    178  C4    C B   2      21.494  15.695  13.292  1.00 20.00           C
ATOM    179  N4    C B   2      20.218  16.005  13.048  1.00 20.00           N
ATOM    180  C5    C B   2      21.823  14.452  13.907  1.00 20.00           C
ATOM    181  C6    C B   2      23.119  14.195  14.126  1.00 20.00           C
ATOM    182  H5'   C B   2      25.824  11.130  15.426  1.00 77.93           H
ATOM    183 H5''   C B   2      25.999  11.651  16.907  1.00 77.93           H
ATOM    184  H4'   C B   2      27.161  13.040  15.462  1.00 78.66           H
ATOM    185  H3'   C B   2      24.943  14.354  16.595  1.00 78.23           H
ATOM    186  H2'   C B   2      25.505  16.273  15.503  1.00 79.34           H
ATOM    187 HO2'   C B   2      27.694  16.194  15.791  1.00 79.34           H
ATOM    188  H1'   C B   2      26.041  15.093  13.253  1.00 78.22           H
ATOM    189  H41   C B   2      19.593  15.456  13.265  1.00 20.00           H
ATOM    190  H42   C B   2      20.022  16.754  12.674  1.00 20.00           H
ATOM    191  H5    C B   2      21.163  13.843  14.147  1.00 20.00           H
ATOM    192  H6    C B   2      23.364  13.393  14.526  1.00 20.00           H
ATOM    193  P     G B   3      26.058  15.013  18.858  1.00 76.88           P
ATOM    194  OP1   G B   3      27.123  14.941  19.891  1.00 78.59           O
ATOM    195  OP2   G B   3      24.791  14.266  19.059  1.00 75.20           O
ATOM    196  O5'   G B   3      25.696  16.547  18.630  1.00 78.76           O
ATOM    197  C5'   G B   3      26.713  17.507  18.380  1.00 77.93           C
ATOM    198  C4'   G B   3      26.131  18.843  17.993  1.00 78.66           C
ATOM    199  O4'   G B   3      25.392  18.715  16.750  1.00 79.49           O
ATOM    200  C3'   G B   3      25.121  19.437  18.964  1.00 78.23           C
ATOM    201  O3'   G B   3      25.730  20.093  20.063  1.00 77.17           O
ATOM    202  C2'   G B   3      24.308  20.364  18.072  1.00 79.34           C
ATOM    203  O2'   G B   3      24.988  21.590  17.846  1.00 79.34           O
ATOM    204  C1'   G B   3      24.268  19.570  16.766  1.00 78.22           C
ATOM    205  N9    G B   3      23.049  18.747  16.654  1.00 20.00           N
ATOM    206  C8    G B   3      22.948  17.389  16.836  1.00 20.00           C
ATOM    207  N7    G B   3      21.735  16.938  16.671  1.00 20.00           N
ATOM    208  C5    G B   3      20.988  18.066  16.360  1.00 20.00           C
ATOM    209  C6    G B   3      19.605  18.202  16.074  1.00 20.00           C
ATOM    210  O6    G B   3      18.735  17.324  16.037  1.00 20.00           O
ATOM    211  N1    G B   3      19.265  19.526  15.812  1.00 20.00           N
ATOM    212  C2    G B   3      20.142  20.583  15.823  1.00 20.00           C
ATOM    213  N2    G B   3      19.620  21.786  15.544  1.00 20.00           N
ATOM    214  N3    G B   3      21.433  20.469  16.088  1.00 20.00           N
ATOM    215  C4    G B   3      21.785  19.192  16.345  1.00 20.00           C
ATOM    216  H5'   G B   3      27.279  17.188  17.659  1.00 77.93           H
ATOM    217 H5''   G B   3      27.250  17.615  19.180  1.00 77.93           H
ATOM    218  H4'   G B   3      26.854  19.476  17.865  1.00 78.66           H
ATOM    219  H3'   G B   3      24.546  18.729  19.295  1.00 78.23           H
ATOM    220  H2'   G B   3      23.416  20.507  18.427  1.00 79.34           H
ATOM    221 HO2'   G B   3      25.624  21.654  18.390  1.00 79.34           H
ATOM    222  H1'   G B   3      24.316  20.182  16.014  1.00 78.22           H
ATOM    223  H8    G B   3      23.671  16.847  17.056  1.00 20.00           H
ATOM    224  H1    G B   3      18.442  19.695  15.629  1.00 20.00           H
ATOM    225  H21   G B   3      18.776  21.865  15.394  1.00 20.00           H
ATOM    226  H22   G B   3      20.128  22.479  15.515  1.00 20.00           H
ATOM    227  P     U B   4      25.038  20.052  21.513  1.00 76.88           P
ATOM    228  OP1   U B   4      25.946  20.728  22.475  1.00 78.59           O
ATOM    229  OP2   U B   4      24.599  18.658  21.776  1.00 75.20           O
ATOM    230  O5'   U B   4      23.737  20.955  21.346  1.00 78.76           O
ATOM    231  C5'   U B   4      23.842  22.322  20.974  1.00 77.93           C
ATOM    232  C4'   U B   4      22.492  22.914  20.655  1.00 78.66           C
ATOM    233  O4'   U B   4      21.908  22.220  19.522  1.00 79.49           O
ATOM    234  C3'   U B   4      21.438  22.796  21.745  1.00 78.23           C
ATOM    235  O3'   U B   4      21.564  23.790  22.747  1.00 77.17           O
ATOM    236  C2'   U B   4      20.136  22.882  20.959  1.00 79.34           C
ATOM    237  O2'   U B   4      19.818  24.228  20.636  1.00 79.34           O
ATOM    238  C1'   U B   4      20.506  22.137  19.676  1.00 78.22           C
ATOM    239  N1    U B   4      20.119  20.709  19.729  1.00 20.00           N
ATOM    240  C2    U B   4      18.803  20.391  19.462  1.00 20.00           C
ATOM    241  O2    U B   4      17.962  21.229  19.188  1.00 20.00           O
ATOM    242  N3    U B   4      18.508  19.052  19.527  1.00 20.00           N
ATOM    243  C4    U B   4      19.379  18.023  19.826  1.00 20.00           C
ATOM    244  O4    U B   4      18.961  16.865  19.845  1.00 20.00           O
ATOM    245  C5    U B   4      20.725  18.433  20.091  1.00 20.00           C
ATOM    246  C6    U B   4      21.037  19.732  20.034  1.00 20.00           C
ATOM    247  H5'   U B   4      24.413  22.395  20.194  1.00 77.93           H
ATOM    248 H5''   U B   4      24.240  22.819  21.706  1.00 77.93           H
ATOM    249  H4'   U B   4      22.605  23.850  20.427  1.00 78.66           H
ATOM    250  H3'   U B   4      21.503  21.920  22.156  1.00 78.23           H
ATOM    251 HO3'   U B   4      20.932  24.324  22.892  1.00 77.17           H
ATOM    252  H2'   U B   4      19.409  22.442  21.427  1.00 79.34           H
ATOM    253 HO2'   U B   4      19.611  24.636  21.340  1.00 79.34           H
ATOM    254  H1'   U B   4      20.072  22.562  18.920  1.00 78.22           H
ATOM    255  H5    U B   4      21.375  17.802  20.301  1.00 20.00           H
ATOM    256  H3    U B   4      17.694  18.830  19.364  1.00 20.00           H
ATOM    257  H6    U B   4      21.915  19.985  20.208  1.00 20.00           H
TER
END
"""

type_list_known = ['2tetra', '2tetra', '3neigbs', '3neigbs', '2tetra',
  '2tetra', '3neigbs', 'flat_2neigbs', 'alg1a', 'alg1a', 'flat_2neigbs',
  '2tetra', '2tetra', '3neigbs', '3neigbs', '2tetra', '2tetra', '3neigbs',
  'alg1a', 'alg1a', 'flat_2neigbs', 'flat_2neigbs', '2tetra', '2tetra',
  '3neigbs', '3neigbs', '2tetra', '2tetra', '3neigbs', 'flat_2neigbs',
  'flat_2neigbs', 'alg1a', 'alg1a', '2tetra', '2tetra', '3neigbs',
  '3neigbs', 'alg1b', '2tetra', '2tetra', '3neigbs', 'flat_2neigbs',
  'prop', 'prop', 'prop', 'flat_2neigbs', '2tetra', '2tetra', '3neigbs',
  '3neigbs', '3neigbs', 'alg1b', '3neigbs', 'flat_2neigbs', 'alg1a',
  'alg1a', 'flat_2neigbs', '2tetra', '2tetra', '3neigbs', '3neigbs',
  '3neigbs', 'alg1b', '3neigbs', 'alg1a', 'alg1a', 'flat_2neigbs',
  'flat_2neigbs', '2tetra', '2tetra', '3neigbs', '3neigbs', '3neigbs',
  'alg1b', '3neigbs', 'flat_2neigbs', 'flat_2neigbs', 'alg1a', 'alg1a',
  '2tetra', '2tetra', '3neigbs', '3neigbs', 'alg1b', '3neigbs', 'alg1b',
  '3neigbs', 'flat_2neigbs', 'flat_2neigbs', 'flat_2neigbs']


if (__name__ == "__main__"):
  t0 = time.time()
  exercise()
  print("OK. Time: %8.3f"%(time.time()-t0))



 *******************************************************************************


 *******************************************************************************
mmtbx/hydrogens/tst_parameterization_3.py
from __future__ import absolute_import, division, print_function
import time
import mmtbx.model
import iotbx.pdb
from libtbx.utils import null_out
from six.moves import zip

#-----------------------------------------------------------------------------
# This test checks the parameterization of hydrogen atoms for planar X-H2 groups
# Aim is to test if ideal dihedral angles are correct for any configuration
#-----------------------------------------------------------------------------

def exercise(pdb_str):
  pdb_inp = iotbx.pdb.input(lines=pdb_str.split("\n"), source_info=None)
  model = mmtbx.model.manager(
    model_input = pdb_inp,
    log         = null_out())
  model.process(make_restraints=True)
  pdb_hierarchy = model.get_hierarchy()
  sites_cart = model.get_sites_cart()
  atoms = pdb_hierarchy.atoms()

  model.setup_riding_h_manager()
  riding_h_manager = model.get_riding_h_manager()

  h_parameterization = riding_h_manager.h_parameterization

  diagnostics = riding_h_manager.diagnostics(
    sites_cart         = sites_cart,
    threshold          = 0.05)

  diagnostics = riding_h_manager.diagnostics(
    sites_cart         = sites_cart,
    threshold          = 0.05)
  h_distances   = diagnostics.h_distances

  number_h = model.get_hd_selection().count(True)
  number_h_para = len(h_parameterization) - h_parameterization.count(None)

# There are 90 H atoms in pdb_string, check if all of them are recognized
  assert (number_h_para == number_h), 'Not all H atoms are parameterized'

  for ih in h_distances:
    labels = atoms[ih].fetch_labels()
    assert (h_distances[ih] < 0.01), \
      'distance too large: %s  atom: %s (%s) residue: %s ' \
      % (h_parameterization[ih].htype, atoms[ih].name, ih, labels.resseq.strip())


pdb_str_00 = """
CRYST1   13.889   13.738   13.126  90.00  90.00  90.00 P 1
SCALE1      0.071999  0.000000  0.000000        0.00000
SCALE2      0.000000  0.072791  0.000000        0.00000
SCALE3      0.000000  0.000000  0.076185        0.00000
ATOM      1  N   ASN A   1       5.264   6.323   6.229  1.00 10.00           N
ATOM      2  CA  ASN A   1       6.108   7.341   6.843  1.00 10.00           C
ATOM      3  C   ASN A   1       5.944   8.680   6.132  1.00 10.00           C
ATOM      4  O   ASN A   1       5.516   8.733   4.979  1.00 10.00           O
ATOM      5  CB  ASN A   1       7.575   6.907   6.817  1.00 10.00           C
ATOM      6  CG  ASN A   1       7.857   5.750   7.754  1.00 10.00           C
ATOM      7  OD1 ASN A   1       7.361   5.713   8.880  1.00 10.00           O
ATOM      8  ND2 ASN A   1       8.659   4.797   7.294  1.00 10.00           N
ATOM      9  HA  ASN A   1       5.844   7.457   7.769  1.00 10.00           H
ATOM     10  HB2 ASN A   1       7.806   6.628   5.917  1.00 10.00           H
ATOM     11  HB3 ASN A   1       8.131   7.655   7.086  1.00 10.00           H
ATOM     12 HD21 ASN A   1       8.849   4.119   7.787  1.00 10.00           H
ATOM     13 HD22 ASN A   1       8.988   4.857   6.501  1.00 10.00           H
"""

pdb_str_01 = """
CRYST1   13.889   13.738   13.126  90.00  90.00  90.00 P 1
SCALE1      0.071999  0.000000  0.000000        0.00000
SCALE2      0.000000  0.072791  0.000000        0.00000
SCALE3      0.000000  0.000000  0.076185        0.00000
ATOM      1  N   ASN A   1       5.264   6.323   6.229  1.00 10.00           N
ATOM      2  CA  ASN A   1       6.108   7.341   6.843  1.00 10.00           C
ATOM      3  C   ASN A   1       5.944   8.680   6.132  1.00 10.00           C
ATOM      4  O   ASN A   1       5.516   8.733   4.979  1.00 10.00           O
ATOM      5  CB  ASN A   1       7.575   6.907   6.817  1.00 10.00           C
ATOM      6  CG  ASN A   1       7.857   5.750   7.754  1.00 10.00           C
ATOM      7  OD1 ASN A   1       7.361   5.713   8.880  1.00 10.00           O
ATOM      8  ND2 ASN A   1       8.659   4.797   7.294  1.00 10.00           N
ATOM      9  HA  ASN A   1       5.844   7.457   7.769  1.00 10.00           H
ATOM     10  HB2 ASN A   1       7.806   6.628   5.917  1.00 10.00           H
ATOM     11  HB3 ASN A   1       8.131   7.655   7.086  1.00 10.00           H
ATOM     12 HD21 ASN A   1       8.988   4.857   6.501  1.00 10.00           H
ATOM     13 HD22 ASN A   1       8.849   4.119   7.787  1.00 10.00           H
"""

pdb_str_02 = """
CRYST1   14.446   16.451   11.913  90.00  90.00  90.00 P 1
SCALE1      0.069223  0.000000  0.000000        0.00000
SCALE2      0.000000  0.060787  0.000000        0.00000
SCALE3      0.000000  0.000000  0.083942        0.00000
ATOM      1  N   ARG A  50       6.725  11.631   6.607  1.00 10.00           N
ATOM      2  CA  ARG A  50       7.490  10.491   6.117  1.00 10.00           C
ATOM      3  C   ARG A  50       8.914  10.908   5.763  1.00 10.00           C
ATOM      4  O   ARG A  50       9.701  11.267   6.639  1.00 10.00           O
ATOM      5  CB  ARG A  50       6.806   9.870   4.897  1.00 10.00           C
ATOM      6  CG  ARG A  50       5.402   9.344   5.166  1.00 10.00           C
ATOM      7  CD  ARG A  50       5.419   8.122   6.072  1.00 10.00           C
ATOM      8  NE  ARG A  50       6.111   6.992   5.457  1.00 10.00           N
ATOM      9  CZ  ARG A  50       6.529   5.916   6.119  1.00 10.00           C
ATOM     10  NH1 ARG A  50       6.327   5.812   7.427  1.00 10.00           N
ATOM     11  NH2 ARG A  50       7.150   4.940   5.472  1.00 10.00           N
ATOM     12  HA  ARG A  50       7.540   9.818   6.814  1.00 10.00           H
ATOM     13  HB2 ARG A  50       6.740  10.543   4.202  1.00 10.00           H
ATOM     14  HB3 ARG A  50       7.345   9.127   4.582  1.00 10.00           H
ATOM     15  HG2 ARG A  50       4.880  10.036   5.600  1.00 10.00           H
ATOM     16  HG3 ARG A  50       4.990   9.092   4.325  1.00 10.00           H
ATOM     17  HD2 ARG A  50       5.872   8.343   6.900  1.00 10.00           H
ATOM     18  HD3 ARG A  50       4.505   7.851   6.254  1.00 10.00           H
ATOM     19  HE  ARG A  50       6.259   7.024   4.611  1.00 10.00           H
ATOM     20 HH11 ARG A  50       5.925   6.440   7.855  1.00 10.00           H
ATOM     21 HH12 ARG A  50       6.600   5.114   7.847  1.00 10.00           H
ATOM     22 HH21 ARG A  50       7.283   5.003   4.624  1.00 10.00           H
ATOM     23 HH22 ARG A  50       7.420   4.245   5.899  1.00 10.00           H
"""

pdb_str_03 = """
CRYST1   14.446   16.451   11.913  90.00  90.00  90.00 P 1
SCALE1      0.069223  0.000000  0.000000        0.00000
SCALE2      0.000000  0.060787  0.000000        0.00000
SCALE3      0.000000  0.000000  0.083942        0.00000
ATOM      1  N   ARG A  50       6.725  11.631   6.607  1.00 10.00           N
ATOM      2  CA  ARG A  50       7.490  10.491   6.117  1.00 10.00           C
ATOM      3  C   ARG A  50       8.914  10.908   5.763  1.00 10.00           C
ATOM      4  O   ARG A  50       9.701  11.267   6.639  1.00 10.00           O
ATOM      5  CB  ARG A  50       6.806   9.870   4.897  1.00 10.00           C
ATOM      6  CG  ARG A  50       5.402   9.344   5.166  1.00 10.00           C
ATOM      7  CD  ARG A  50       5.419   8.122   6.072  1.00 10.00           C
ATOM      8  NE  ARG A  50       6.111   6.992   5.457  1.00 10.00           N
ATOM      9  CZ  ARG A  50       6.529   5.916   6.119  1.00 10.00           C
ATOM     10  NH1 ARG A  50       6.327   5.812   7.427  1.00 10.00           N
ATOM     11  NH2 ARG A  50       7.150   4.940   5.472  1.00 10.00           N
ATOM     12  HA  ARG A  50       7.540   9.818   6.814  1.00 10.00           H
ATOM     13  HB2 ARG A  50       6.740  10.543   4.202  1.00 10.00           H
ATOM     14  HB3 ARG A  50       7.345   9.127   4.582  1.00 10.00           H
ATOM     15  HG2 ARG A  50       4.880  10.036   5.600  1.00 10.00           H
ATOM     16  HG3 ARG A  50       4.990   9.092   4.325  1.00 10.00           H
ATOM     17  HD2 ARG A  50       5.872   8.343   6.900  1.00 10.00           H
ATOM     18  HD3 ARG A  50       4.505   7.851   6.254  1.00 10.00           H
ATOM     19  HE  ARG A  50       6.259   7.024   4.611  1.00 10.00           H
ATOM     21 HH11 ARG A  50       6.600   5.114   7.847  1.00 10.00           H
ATOM     20 HH12 ARG A  50       5.925   6.440   7.855  1.00 10.00           H
ATOM     23 HH21 ARG A  50       7.420   4.245   5.899  1.00 10.00           H
ATOM     22 HH22 ARG A  50       7.283   5.003   4.624  1.00 10.00           H
"""

pdb_str_04 = """
CRYST1   14.547   13.375   15.374  90.00  90.00  90.00 P 1
SCALE1      0.068743  0.000000  0.000000        0.00000
SCALE2      0.000000  0.074766  0.000000        0.00000
SCALE3      0.000000  0.000000  0.065045        0.00000
ATOM      1  N   GLN A  70       6.510   6.937   4.976  1.00 10.00           N
ATOM      2  CA  GLN A  70       6.727   6.312   6.275  1.00 10.00           C
ATOM      3  C   GLN A  70       5.406   6.141   7.018  1.00 10.00           C
ATOM      4  O   GLN A  70       4.992   5.022   7.317  1.00 10.00           O
ATOM      5  CB  GLN A  70       7.700   7.144   7.113  1.00 10.00           C
ATOM      6  CG  GLN A  70       8.079   6.506   8.440  1.00 10.00           C
ATOM      7  CD  GLN A  70       9.104   7.319   9.206  1.00 10.00           C
ATOM      8  OE1 GLN A  70       9.517   8.392   8.767  1.00 10.00           O
ATOM      9  NE2 GLN A  70       9.521   6.810  10.360  1.00 10.00           N
ATOM     10  HA  GLN A  70       7.116   5.433   6.144  1.00 10.00           H
ATOM     11  HB2 GLN A  70       8.516   7.275   6.605  1.00 10.00           H
ATOM     12  HB3 GLN A  70       7.292   8.003   7.304  1.00 10.00           H
ATOM     13  HG2 GLN A  70       7.287   6.427   8.993  1.00 10.00           H
ATOM     14  HG3 GLN A  70       8.456   5.628   8.273  1.00 10.00           H
ATOM     15 HE21 GLN A  70       9.210   6.057  10.635  1.00 10.00           H
ATOM     16 HE22 GLN A  70      10.103   7.233  10.832  1.00 10.00           H
"""

pdb_str_05 = """
CRYST1   14.547   13.375   15.374  90.00  90.00  90.00 P 1
SCALE1      0.068743  0.000000  0.000000        0.00000
SCALE2      0.000000  0.074766  0.000000        0.00000
SCALE3      0.000000  0.000000  0.065045        0.00000
ATOM      1  N   GLN A  70       6.510   6.937   4.976  1.00 10.00           N
ATOM      2  CA  GLN A  70       6.727   6.312   6.275  1.00 10.00           C
ATOM      3  C   GLN A  70       5.406   6.141   7.018  1.00 10.00           C
ATOM      4  O   GLN A  70       4.992   5.022   7.317  1.00 10.00           O
ATOM      5  CB  GLN A  70       7.700   7.144   7.113  1.00 10.00           C
ATOM      6  CG  GLN A  70       8.079   6.506   8.440  1.00 10.00           C
ATOM      7  CD  GLN A  70       9.104   7.319   9.206  1.00 10.00           C
ATOM      8  OE1 GLN A  70       9.517   8.392   8.767  1.00 10.00           O
ATOM      9  NE2 GLN A  70       9.521   6.810  10.360  1.00 10.00           N
ATOM     10  HA  GLN A  70       7.116   5.433   6.144  1.00 10.00           H
ATOM     11  HB2 GLN A  70       8.516   7.275   6.605  1.00 10.00           H
ATOM     12  HB3 GLN A  70       7.292   8.003   7.304  1.00 10.00           H
ATOM     13  HG2 GLN A  70       7.287   6.427   8.993  1.00 10.00           H
ATOM     14  HG3 GLN A  70       8.456   5.628   8.273  1.00 10.00           H
ATOM     16 HE21 GLN A  70      10.103   7.233  10.832  1.00 10.00           H
ATOM     15 HE22 GLN A  70       9.210   6.057  10.635  1.00 10.00           H
"""

pdb_list = [pdb_str_00, pdb_str_01, pdb_str_02, pdb_str_03,
  pdb_str_04, pdb_str_05]

pdb_list_name = ['pdb_str_00', 'pdb_str_01', 'pdb_str_02', 'pdb_str_03',
  'pdb_str_04', 'pdb_str_05']

def run():
  for pdb_str, str_name in zip(pdb_list,pdb_list_name):
    #print 'pdb_string:', str_name, 'use_ideal_bonds_angles =', True
    exercise(pdb_str=pdb_str)

if (__name__ == "__main__"):
  t0 = time.time()
  run()
  print("OK. Time: %8.3f"%(time.time()-t0))


 *******************************************************************************


 *******************************************************************************
mmtbx/hydrogens/tst_parameterization_4.py
from __future__ import absolute_import, division, print_function
import time
import mmtbx.model
import iotbx.pdb
import mmtbx.refinement.geometry_minimization
import scitbx.lbfgs
import cctbx.geometry_restraints
from mmtbx.hydrogens import riding
from libtbx.utils import null_out
from six.moves import zip

#-----------------------------------------------------------------------------
# This test checks the parameterization of hydrogen atoms for all H geometries
# for each fragment, the coordinates are minimized before computation of
# new H atom positions.
#-----------------------------------------------------------------------------


def exercise(pdb_str, use_ideal_bonds_angles):
# --------------------------------------------------------------
#          code to switch off CDL
# --------------------------------------------------------------
  #params_line = grand_master_phil_str
  #params = iotbx.phil.parse(
  #    input_string=params_line, process_includes=True).extract()
  #params.pdb_interpretation.restraints_library.cdl=False
# ---------------------------------------------------------------

  pdb_inp = iotbx.pdb.input(lines=pdb_str.split("\n"), source_info=None)
  model = mmtbx.model.manager(model_input=pdb_inp, log=null_out())
  model.process(make_restraints=True)
  pdb_hierarchy = model.get_hierarchy()
  geometry_restraints = model.get_restraints_manager().geometry
  xray_structure = model.get_xray_structure()

  sites_cart = model.get_sites_cart()

  grf = cctbx.geometry_restraints.flags.flags(default=True)
  minimized = mmtbx.refinement.geometry_minimization.lbfgs(
      sites_cart                         = sites_cart,
      correct_special_position_tolerance = 1.0,
      geometry_restraints_manager        = geometry_restraints,
      geometry_restraints_flags          = grf,
      lbfgs_termination_params           = scitbx.lbfgs.termination_parameters(
        max_iterations=500))
  xray_structure.set_sites_cart(sites_cart)
  pdb_hierarchy.adopt_xray_structure(xray_structure)
  atoms = pdb_hierarchy.atoms()
  sites_cart = xray_structure.sites_cart()

  riding_h_manager = riding.manager(
    pdb_hierarchy       = pdb_hierarchy,
    geometry_restraints = geometry_restraints,
    use_ideal_bonds_angles = use_ideal_bonds_angles)

  h_parameterization = riding_h_manager.h_parameterization

  diagnostics = riding_h_manager.diagnostics(
    sites_cart = sites_cart,
    threshold  = 0.05)
  h_distances   = diagnostics.h_distances

  number_h = model.get_hd_selection().count(True)
  number_h_para = len(h_parameterization) - h_parameterization.count(None)

  assert (number_h_para == number_h), 'Not all H atoms are parameterized'

  for ih in h_distances:
    labels = atoms[ih].fetch_labels()
    if use_ideal_bonds_angles:
      assert (h_distances[ih] < 0.03), \
        'distance too large: %s  atom: %s (%s) residue: %s ' \
        % (h_parameterization[ih].htype, atoms[ih].name, ih, labels.resseq.strip())
    else:
      assert (h_distances[ih] < 1e-7), \
        'distance too large: %s  atom: %s (%s) residue: %s  distance %s' \
        % (h_parameterization[ih].htype, atoms[ih].name, ih, labels.resseq.strip(), h_distances[ih])

# alg2a - flat two neighbors
pdb_str_00 = """
CRYST1   27.805   30.931   25.453  90.00  90.00  90.00 P 1
SCALE1      0.035965  0.000000  0.000000        0.00000
SCALE2      0.000000  0.032330  0.000000        0.00000
SCALE3      0.000000  0.000000  0.039288        0.00000
ATOM      6  C   ASN A   1      15.183  17.286  10.105  1.00  9.67           C
ANISOU    6  C   ASN A   1     1289   1143   1241   -122   -106    160       C
ATOM     15  N   SER A   2      15.981  16.452  10.758  1.00  9.28           N
ANISOU   15  N   SER A   2     1274    902   1350    -21    -87    -74       N
ATOM     17  CA  SER A   2      15.404  15.325  11.479  1.00  9.47           C
ANISOU   17  CA  SER A   2     1420    764   1413     89    320   -137       C
ATOM     22  H   SER A   2      16.836  16.507  10.826  1.00 11.14           H
"""

# 2tetra
pdb_str_01 = """
CRYST1   27.805   30.931   25.453  90.00  90.00  90.00 P 1
SCALE1      0.035965  0.000000  0.000000        0.00000
SCALE2      0.000000  0.032330  0.000000        0.00000
SCALE3      0.000000  0.000000  0.039288        0.00000
ATOM      1  CB  SER A   3      10.251  13.658  12.560  1.00  6.41           C
ANISOU    1  CB  SER A   3      638    591   1207   -162    148    106       C
ATOM      2  OG  SER A   3       9.057  14.277  12.222  1.00  7.60           O
ANISOU    2  OG  SER A   3      680    955   1251   -244   -164    339       O
ATOM      3  HB2 SER A   3      10.809  13.573  11.771  1.00  6.41           H
ATOM      4  HB3 SER A   3      10.073  12.759  12.879  1.00  6.41           H
ATOM     12  CA  SER A   3      11.103  14.453  13.643  1.00  5.95           C
ANISOU   12  CA  SER A   3      582    671   1007   -168    135    158       C
"""

# 3tetra
pdb_str_02 = """
CRYST1   27.805   30.931   25.453  90.00  90.00  90.00 P 1
SCALE1      0.035965  0.000000  0.000000        0.00000
SCALE2      0.000000  0.032330  0.000000        0.00000
SCALE3      0.000000  0.000000  0.039288        0.00000
ATOM     16  CA  SER A   4       7.228  18.726  13.388  1.00  5.95           C
ANISOU   16  CA  SER A   4      582    671   1007   -168    135    158       C
ATOM     18  HA  SER A   4       6.548  18.900  14.058  1.00  5.95           H
ATOM     20  N   SER A   4       7.555  19.994  12.853  1.00  5.10           N
ANISOU   20  N   SER A   4      500    632    808   -107     58    104       N
ATOM     21  C   SER A   4       8.298  17.964  14.019  1.00  5.79           C
ANISOU   21  C   SER A   4      661    588    952   -116    206    135       C
ATOM     23  CB  SER A   4       6.376  17.931  12.305  1.00  6.41           C
ANISOU   23  CB  SER A   4      638    591   1207   -162    148    106       C
"""

# alg1a
pdb_str_03 = """
CRYST1   27.805   30.931   25.453  90.00  90.00  90.00 P 1
SCALE1      0.035965  0.000000  0.000000        0.00000
SCALE2      0.000000  0.032330  0.000000        0.00000
SCALE3      0.000000  0.000000  0.039288        0.00000
ATOM      8  NE  ARG A   5       6.123   6.987   5.466  1.00 10.00           N
ATOM      9  CZ  ARG A   5       6.527   5.903   6.122  1.00 10.00           C
ATOM     10  NH1 ARG A   5       6.329   5.797   7.429  1.00 10.00           N
ATOM     20 HH11 ARG A   5       5.938   6.429   7.862  1.00 10.00           H
ATOM     21 HH12 ARG A   5       6.593   5.093   7.846  1.00 10.00           H
"""

# alg1b
pdb_str_04 = """
CRYST1   27.805   30.931   25.453  90.00  90.00  90.00 P 1
SCALE1      0.035965  0.000000  0.000000        0.00000
SCALE2      0.000000  0.032330  0.000000        0.00000
SCALE3      0.000000  0.000000  0.039288        0.00000
ATOM     32  OG  SER A   6       8.321  21.302  15.330  1.00  7.60           O
ANISOU   32  OG  SER A   6      680    955   1251   -244   -164    339       O
ATOM     33  HG  SER A   6       8.020  20.964  14.622  1.00  7.60           H
ATOM     35  CA  SER A   6      10.267  21.478  16.751  1.00  5.95           C
ANISOU   35  CA  SER A   6      582    671   1007   -168    135    158       C
ATOM     38  CB  SER A   6       9.515  20.683  15.668  1.00  6.41           C
ANISOU   38  CB  SER A   6      638    591   1207   -162    148    106       C
"""

# propeller
pdb_str_05 = """
CRYST1   27.805   30.931   25.453  90.00  90.00  90.00 P 1
SCALE1      0.035965  0.000000  0.000000        0.00000
SCALE2      0.000000  0.032330  0.000000        0.00000
SCALE3      0.000000  0.000000  0.039288        0.00000
ATOM     83  CA AVAL A   7      17.913   8.982  14.720  0.44 10.37           C
ANISOU   83  CA AVAL A   7     1783    902   1255     67   -148    -14       C
ATOM     84  CB AVAL A   7      16.666   8.901  13.831  0.44 11.26           C
ANISOU   84  CB AVAL A   7     1571    963   1743     96   -176     62       C
ATOM     85  CG1AVAL A   7      16.663  10.050  12.901  0.44 11.06           C
ANISOU   85  CG1AVAL A   7     1704   1072   1425    125   -105     37       C
ATOM     88 HG11AVAL A   7      16.650  10.872  13.416  0.44 13.27           H
ATOM     89 HG12AVAL A   7      15.875   9.999  12.339  0.44 13.27           H
ATOM     90 HG13AVAL A   7      17.463  10.015  12.354  0.44 13.27           H
"""


#type_list_known = ['flat_2neigbs', '2tetra', '2tetra', '3neigbs', 'alg1a',
#  'alg1a', 'alg1b', 'prop', 'prop', 'prop']

pdb_list = [pdb_str_00, pdb_str_01, pdb_str_02, pdb_str_03,
  pdb_str_04, pdb_str_05]

pdb_list_name = ['pdb_str_00', 'pdb_str_01', 'pdb_str_02', 'pdb_str_03',
  'pdb_str_04', 'pdb_str_05']

def run():
  for use_ideal_bonds_angles in [True, False]:
    print('use_ideal_bonds_angles =', use_ideal_bonds_angles)
    for pdb_str, str_name in zip(pdb_list,pdb_list_name):
      exercise(pdb_str=pdb_str, use_ideal_bonds_angles=use_ideal_bonds_angles)

if (__name__ == "__main__"):
  t0 = time.time()
  run()
  print("OK. Time: %8.3f"%(time.time()-t0))


 *******************************************************************************


 *******************************************************************************
mmtbx/hydrogens/tst_parameterization_5.py
from __future__ import absolute_import, division, print_function
import time
import mmtbx.model
import iotbx.pdb
from libtbx.utils import null_out
from six.moves import zip

#-----------------------------------------------------------------------------
# This test checks the parameterization of H atoms for multiple conformations
# These examples are from pdb and initially failed
#-----------------------------------------------------------------------------

def exercise(pdb_str, type_list_known):
  pdb_inp = iotbx.pdb.input(lines=pdb_str.split("\n"), source_info=None)
  model = mmtbx.model.manager(
    model_input = pdb_inp,
    log         = null_out())
  model.process(make_restraints=True)
  pdb_hierarchy = model.get_hierarchy()
  sites_cart = model.get_sites_cart()
  atoms = pdb_hierarchy.atoms()

  model.setup_riding_h_manager()
  riding_h_manager = model.get_riding_h_manager()

  h_para = riding_h_manager.h_parameterization

  diagnostics = riding_h_manager.diagnostics(
    sites_cart = sites_cart,
    threshold  = 0.05)
  h_distances   = diagnostics.h_distances
  type_list     = diagnostics.type_list

  number_h = model.get_hd_selection().count(True)
  number_h_para = len(h_para) - h_para.count(None)

  assert (number_h_para == number_h), 'Not all H atoms are parameterized'

  for ih in h_distances:
    labels = atoms[ih].fetch_labels()
    assert (h_distances[ih] < 0.2), \
      'distance too large: %s  atom: %s (%s) residue: %s ' \
      % (h_para[ih].htype, atoms[ih].name, ih, labels.resseq.strip())

  for type1, type2 in zip(type_list, type_list_known):
    assert (type1 == type2)
    #print "'%s'," % type1,

# Several fragments from pdb with double conformations which caused crashes
# There are 68 H atoms in the pdb_string, check if all of them are recognized
# Note: one H atom (VAL 7 HA) is bound to two CA atoms at once
pdb_str1 = """\
CRYST1   27.832   30.931   25.475  90.00  90.00  90.00 P 1
SCALE1      0.035930  0.000000  0.000000        0.00000
SCALE2      0.000000  0.032330  0.000000        0.00000
SCALE3      0.000000  0.000000  0.039254        0.00000
ATOM      1  CB  SER A   1      10.278  16.843  12.582  1.00  6.41           C
ANISOU    1  CB  SER A   1      638    591   1207   -162    148    106       C
ATOM      2  OG  SER A   1       9.084  17.462  12.244  1.00  7.60           O
ANISOU    2  OG  SER A   1      680    955   1251   -244   -164    339       O
ATOM      3  HB2 SER A   1      10.836  16.758  11.793  1.00  6.41           H
ATOM      4  HB3 SER A   1      10.100  15.944  12.901  1.00  6.41           H
ATOM      5  HG  SER A   1       8.783  17.124  11.536  1.00  7.60           H
ATOM      6  N  ASER A   1      11.457  18.906  13.130  0.40  5.10           N
ANISOU    6  N  ASER A   1      500    632    808   -107     58    104       N
ATOM      7  CA ASER A   1      11.030  17.638  13.665  0.40  5.95           C
ANISOU    7  CA ASER A   1      582    671   1007   -168    135    158       C
ATOM      8  C  ASER A   1      12.200  16.876  14.296  0.40  5.79           C
ANISOU    8  C  ASER A   1      661    588    952   -116    206    135       C
ATOM      9  O  ASER A   1      12.094  16.315  15.382  0.40  6.83           O
ANISOU    9  O  ASER A   1      874    705   1015    -39    314    258       O
ATOM     10  HA ASER A   1      10.350  17.812  14.335  0.40  5.95           H
ATOM     11  N  BSER A   1      11.557  18.906  13.130  0.60  5.10           N
ANISOU   11  N  BSER A   1      500    632    808   -107     58    104       N
ATOM     12  CA BSER A   1      11.130  17.638  13.665  0.60  5.95           C
ANISOU   12  CA BSER A   1      582    671   1007   -168    135    158       C
ATOM     13  C  BSER A   1      12.300  16.876  14.296  0.60  5.79           C
ANISOU   13  C  BSER A   1      661    588    952   -116    206    135       C
ATOM     14  O  BSER A   1      12.194  16.315  15.382  0.60  6.83           O
ANISOU   14  O  BSER A   1      874    705   1015    -39    314    258       O
ATOM     15  HA BSER A   1      10.450  17.812  14.335  0.60  5.95           H
ATOM     16  CA  SER A   2       7.255  21.911  13.410  1.00  5.95           C
ANISOU   16  CA  SER A   2      582    671   1007   -168    135    158       C
ATOM     17  OG  SER A   2       5.325  21.752  11.965  1.00  7.60           O
ANISOU   17  OG  SER A   2      680    955   1251   -244   -164    339       O
ATOM     18  HA  SER A   2       6.575  22.085  14.080  1.00  5.95           H
ATOM     19  HG  SER A   2       5.027  21.411  11.258  1.00  7.60           H
ATOM     20  N  ASER A   2       7.582  23.179  12.875  0.40  5.10           N
ANISOU   20  N  ASER A   2      500    632    808   -107     58    104       N
ATOM     21  C  ASER A   2       8.325  21.149  14.041  0.40  5.79           C
ANISOU   21  C  ASER A   2      661    588    952   -116    206    135       C
ATOM     22  O  ASER A   2       8.219  20.588  15.127  0.40  6.83           O
ANISOU   22  O  ASER A   2      874    705   1015    -39    314    258       O
ATOM     23  CB ASER A   2       6.403  21.116  12.327  0.40  6.41           C
ANISOU   23  CB ASER A   2      638    591   1207   -162    148    106       C
ATOM     24  HB2ASER A   2       6.961  21.031  11.538  0.40  6.41           H
ATOM     25  HB3ASER A   2       6.225  20.217  12.646  0.40  6.41           H
ATOM     26  N  BSER A   2       7.682  23.179  12.875  0.60  5.10           N
ANISOU   26  N  BSER A   2      500    632    808   -107     58    104       N
ATOM     27  C  BSER A   2       8.425  21.149  14.041  0.60  5.79           C
ANISOU   27  C  BSER A   2      661    588    952   -116    206    135       C
ATOM     28  O  BSER A   2       8.319  20.588  15.127  0.60  6.83           O
ANISOU   28  O  BSER A   2      874    705   1015    -39    314    258       O
ATOM     29  CB BSER A   2       6.503  21.116  12.327  0.60  6.41           C
ANISOU   29  CB BSER A   2      638    591   1207   -162    148    106       C
ATOM     30  HB2BSER A   2       7.070  21.011  11.547  0.60  6.41           H
ATOM     31  HB3BSER A   2       6.305  20.224  12.655  0.60  6.41           H
ATOM     32  OG  SER A   3       8.348  24.487  15.352  1.00  7.60           O
ANISOU   32  OG  SER A   3      680    955   1251   -244   -164    339       O
ATOM     33  HG  SER A   3       8.047  24.149  14.644  1.00  7.60           H
ATOM     34  N  ASER A   3      10.721  25.931  16.238  0.40  5.10           N
ANISOU   34  N  ASER A   3      500    632    808   -107     58    104       N
ATOM     35  CA ASER A   3      10.294  24.663  16.773  0.40  5.95           C
ANISOU   35  CA ASER A   3      582    671   1007   -168    135    158       C
ATOM     36  C  ASER A   3      11.464  23.901  17.404  0.40  5.79           C
ANISOU   36  C  ASER A   3      661    588    952   -116    206    135       C
ATOM     37  O  ASER A   3      11.358  23.340  18.490  0.40  6.83           O
ANISOU   37  O  ASER A   3      874    705   1015    -39    314    258       O
ATOM     38  CB ASER A   3       9.542  23.868  15.690  0.40  6.41           C
ANISOU   38  CB ASER A   3      638    591   1207   -162    148    106       C
ATOM     39  HA ASER A   3       9.614  24.837  17.443  0.40  5.95           H
ATOM     40  HB2ASER A   3      10.100  23.783  14.901  0.40  6.41           H
ATOM     41  HB3ASER A   3       9.364  22.969  16.009  0.40  6.41           H
ATOM     42  N  BSER A   3      10.821  25.931  16.238  0.60  5.10           N
ANISOU   42  N  BSER A   3      500    632    808   -107     58    104       N
ATOM     43  CA BSER A   3      10.394  24.663  16.773  0.60  5.95           C
ANISOU   43  CA BSER A   3      582    671   1007   -168    135    158       C
ATOM     44  C  BSER A   3      11.564  23.901  17.404  0.60  5.79           C
ANISOU   44  C  BSER A   3      661    588    952   -116    206    135       C
ATOM     45  O  BSER A   3      11.458  23.340  18.490  0.60  6.83           O
ANISOU   45  O  BSER A   3      874    705   1015    -39    314    258       O
ATOM     46  CB BSER A   3       9.642  23.868  15.690  0.60  6.41           C
ANISOU   46  CB BSER A   3      638    591   1207   -162    148    106       C
ATOM     47  HA BSER A   3       9.714  24.837  17.443  0.60  5.95           H
ATOM     48  HB2BSER A   3      10.209  23.763  14.910  0.60  6.41           H
ATOM     49  HB3BSER A   3       9.444  22.976  16.018  0.60  6.41           H
ATOM     50  CA  TYR A   4      22.290  10.873   7.693  1.00 13.00           C
ANISOU   50  CA  TYR A   4     2514   1244   1180    -28    116    139       C
ATOM     51  C   TYR A   4      22.074   9.526   7.008  1.00 11.81           C
ANISOU   51  C   TYR A   4     2332   1026   1130   -105     88    190       C
ATOM     52  O   TYR A   4      21.538   8.599   7.605  1.00 12.59           O
ANISOU   52  O   TYR A   4     2489   1154   1140    -72    111    219       O
ATOM     53  N   VAL A   5      22.517   9.437   5.761  1.00 10.80           N
ANISOU   53  N   VAL A   5     2053    884   1167    -29     80    167       N
ATOM     54  H   VAL A   5      22.832  10.103   5.318  1.00 12.96           H
ATOM     55  CA AVAL A   5      22.516   8.185   5.022  0.40 10.37           C
ANISOU   55  CA AVAL A   5     1783    902   1255     67   -148    -14       C
ATOM     56  CA BVAL A   5      22.616   8.185   5.022  0.60 10.37           C
ANISOU   56  CA BVAL A   5     1783    902   1255     67   -148    -14       C
ATOM     57  N   SER A   6      17.758  20.026  12.546  1.00  4.20           N
ANISOU   57  N   SER A   6      578    469    547    -59     10   -119       N
ATOM     58  CA  SER A   6      17.692  20.410  11.150  1.00  4.34           C
ANISOU   58  CA  SER A   6      576    472    600     -2      0      0       C
ATOM     59  C   SER A   6      18.920  19.904  10.378  1.00  3.90           C
ANISOU   59  C   SER A   6      554    387    543    -50    -15    -34       C
ATOM     60  O   SER A   6      18.798  19.501   9.222  1.00  4.24           O
ANISOU   60  O   SER A   6      634    443    534    -77    -67    -59       O
ATOM     62  HA  SER A   6      16.905  19.937  10.839  1.00  4.34           H
ATOM     63  CB ASER A   6      17.651  21.951  11.144  0.60  5.87           C
ANISOU   63  CB ASER A   6      843    568    821    229    -39    -32       C
ATOM     64  OG ASER A   6      17.494  22.382   9.839  0.60  6.95           O
ANISOU   64  OG ASER A   6     1107    702    833    257    200    132       O
ATOM     65  HB2ASER A   6      16.919  22.271  11.695  0.60  4.80           H
ATOM     66  HB3ASER A   6      18.469  22.311  11.522  0.60  4.80           H
ATOM     67  HG ASER A   6      16.967  23.036   9.821  0.60  4.95           H
ATOM     68  CB BSER A   6      17.234  21.814  10.776  0.20  4.89           C
ANISOU   68  CB BSER A   6      429    509    922     98    134    102       C
ATOM     69  OG BSER A   6      18.212  22.672  11.327  0.20  5.81           O
ANISOU   69  OG BSER A   6      757    477    971     72     15   -142       O
ATOM     70  HB2BSER A   6      17.175  21.920   9.814  0.20  4.80           H
ATOM     71  HB3BSER A   6      16.354  22.005  11.137  0.20  4.80           H
ATOM     72  HG BSER A   6      18.020  23.469  11.146  0.20  4.95           H
ATOM     73  CB CSER A   6      17.677  21.930  10.974  0.20  4.80           C
ANISOU   73  CB CSER A   6      432    322   1070   -132    173      4       C
ATOM     74  OG CSER A   6      16.492  22.377  11.598  0.20  4.95           O
ANISOU   74  OG CSER A   6      511    563    806    114    -22    -75       O
ATOM     75  HB2CSER A   6      18.459  22.335  11.381  0.20  4.80           H
ATOM     76  HB3CSER A   6      17.688  22.172  10.035  0.20  4.80           H
ATOM     77  HG CSER A   6      16.620  22.446  12.425  0.20  4.95           H
ATOM     78  N   VAL A   7      17.941  13.419  15.481  1.00 10.80           N
ANISOU   78  N   VAL A   7     2053    884   1167    -29     80    167       N
ATOM     79  C   VAL A   7      19.247  12.139  13.940  1.00  9.56           C
ANISOU   79  C   VAL A   7     1874    685   1073      3   -185     85       C
ATOM     80  O   VAL A   7      19.671  13.155  13.422  1.00 10.25           O
ANISOU   80  O   VAL A   7     2013    634   1247     25      7     95       O
ATOM     81  HA  VAL A   7      17.920  11.415  15.343  0.44 12.11           H
ATOM     82  CA AVAL A   7      17.940  12.167  14.742  0.44 10.37           C
ANISOU   82  CA AVAL A   7     1783    902   1255     67   -148    -14       C
ATOM     83  CB AVAL A   7      16.693  12.086  13.853  0.44 11.26           C
ANISOU   83  CB AVAL A   7     1571    963   1743     96   -176     62       C
ATOM     84  CG1AVAL A   7      16.690  13.235  12.923  0.44 11.06           C
ANISOU   84  CG1AVAL A   7     1704   1072   1425    125   -105     37       C
ATOM     85  CG2AVAL A   7      16.608  10.757  13.097  0.44 10.02           C
ANISOU   85  CG2AVAL A   7     1510    782   1516    -92     19    232       C
ATOM     86  HB AVAL A   7      15.905  12.157  14.414  0.44 13.51           H
ATOM     87 HG11AVAL A   7      16.677  14.057  13.438  0.44 13.27           H
ATOM     88 HG12AVAL A   7      15.902  13.184  12.361  0.44 13.27           H
ATOM     89 HG13AVAL A   7      17.490  13.200  12.376  0.44 13.27           H
ATOM     90 HG21AVAL A   7      15.789  10.303  13.349  0.44 12.03           H
ATOM     91 HG22AVAL A   7      17.375  10.211  13.331  0.44 12.03           H
ATOM     92 HG23AVAL A   7      16.608  10.936  12.143  0.44 12.03           H
ATOM     93  CA BVAL A   7      17.935  12.170  14.724  0.56 10.10           C
ANISOU   93  CA BVAL A   7     1914    779   1143    -16      5    185       C
ATOM     94  CB BVAL A   7      16.746  12.075  13.715  0.56 11.08           C
ANISOU   94  CB BVAL A   7     1662   1363   1184     84    -25     58       C
ATOM     95  CG1BVAL A   7      16.699  10.688  13.068  0.56 12.75           C
ANISOU   95  CG1BVAL A   7     1479   1600   1766    255   -607   -238       C
ATOM     96  CG2BVAL A   7      15.398  12.392  14.382  0.56 11.66           C
ANISOU   96  CG2BVAL A   7     1508   1829   1094    214   -319     28       C
ATOM     97  HB BVAL A   7      16.885  12.725  13.009  0.56 13.29           H
ATOM     98 HG11BVAL A   7      17.532  10.533  12.595  0.56 15.30           H
ATOM     99 HG12BVAL A   7      15.954  10.654  12.448  0.56 15.30           H
ATOM    100 HG13BVAL A   7      16.583  10.020  13.762  0.56 15.30           H
ATOM    101 HG21BVAL A   7      14.999  13.157  13.939  0.56 13.99           H
ATOM    102 HG22BVAL A   7      15.550  12.594  15.318  0.56 13.99           H
ATOM    103 HG23BVAL A   7      14.817  11.620  14.299  0.56 13.99           H
ATOM    104  N   SER A   8      14.526  19.060  18.223  1.00  5.10           N
ANISOU  104  N   SER A   8      500    632    808   -107     58    104       N
ATOM    105  CA  SER A   8      14.099  17.792  18.758  1.00  5.95           C
ANISOU  105  CA  SER A   8      582    671   1007   -168    135    158       C
ATOM    106  C   SER A   8      15.269  17.030  19.389  1.00  5.79           C
ANISOU  106  C   SER A   8      661    588    952   -116    206    135       C
ATOM    107  O   SER A   8      15.163  16.469  20.475  1.00  6.83           O
ANISOU  107  O   SER A   8      874    705   1015    -39    314    258       O
ATOM    108  HA  SER A   8      13.419  17.966  19.428  1.00  5.95           H
ATOM    109  CB ASER A   8      13.570  16.905  17.583  0.52 10.56           C
ANISOU  109  CB ASER A   8     1137    993   1883   -635   -478    170       C
ATOM    110  OG ASER A   8      13.140  15.675  18.052  0.52 13.20           O
ANISOU  110  OG ASER A   8     1612   1164   2238   -898    145    -29       O
ATOM    111  HB2ASER A   8      12.840  17.358  17.133  0.52  6.41           H
ATOM    112  HB3ASER A   8      14.272  16.778  16.926  0.52  6.41           H
ATOM    113  HG ASER A   8      12.347  15.739  18.322  0.52  7.60           H
ATOM    114  CB BSER A   8      13.347  16.997  17.675  0.47  6.41           C
ANISOU  114  CB BSER A   8      638    591   1207   -162    148    106       C
ATOM    115  OG BSER A   8      12.153  17.616  17.337  0.47  7.60           O
ANISOU  115  OG BSER A   8      680    955   1251   -244   -164    339       O
ATOM    116  HB2BSER A   8      13.905  16.912  16.886  0.47  6.41           H
ATOM    117  HB3BSER A   8      13.169  16.098  17.994  0.47  6.41           H
ATOM    118  HG BSER A   8      11.852  17.278  16.629  0.47  7.60           H
ATOM    119  C  AASN A   9      19.204   6.973  12.924  0.46 10.01           C
ANISOU  119  C  AASN A   9     1311   1084   1408    -15   -324    -40       C
ATOM    120  C  BASN A   9      19.123   6.961  12.995  0.54  9.67           C
ANISOU  120  C  BASN A   9     1289   1143   1241   -122   -106    160       C
ATOM    121  N   SER A  10      19.921   6.127  13.648  1.00  9.28           N
ANISOU  121  N   SER A  10     1274    902   1350    -21    -87    -74       N
ATOM    122  H   SER A  10      20.776   6.182  13.716  1.00 11.14           H
ATOM    123  CA ASER A  10      19.327   5.020  14.363  0.63  9.94           C
ANISOU  123  CA ASER A  10     1406    774   1598     87   -335   -196       C
ATOM    124  CA BSER A  10      19.344   5.000  14.369  0.37  9.47           C
ANISOU  124  CA BSER A  10     1420    764   1413     89    320   -137       C
ATOM    125  N   TYR A  11       9.640   8.356   6.598  1.00 15.00           N
ATOM    126  C   TYR A  11      11.549   9.847   6.197  1.00 15.00           C
ATOM    127  O   TYR A  11      11.823   9.939   5.000  1.00 15.00           O
ATOM    128  HA  TYR A  11       9.553  10.281   6.071  1.00 15.00           H
ATOM    129  CA ATYR A  11      10.100   9.738   6.660  0.50 15.00           C
ATOM    130  CB ATYR A  11       9.960  10.286   8.081  0.50 15.00           C
ATOM    131  CG ATYR A  11       8.637   9.956   8.735  0.50 15.00           C
ATOM    132  CD1ATYR A  11       7.436  10.254   8.105  0.50 15.00           C
ATOM    133  CD2ATYR A  11       8.589   9.348   9.982  0.50 15.00           C
ATOM    134  CE1ATYR A  11       6.224   9.955   8.699  0.50 15.00           C
ATOM    135  CE2ATYR A  11       7.383   9.044  10.584  0.50 15.00           C
ATOM    136  CZ ATYR A  11       6.203   9.350   9.938  0.50 15.00           C
ATOM    137  OH ATYR A  11       5.000   9.050  10.533  0.50 15.00           O
ATOM    138  HB2ATYR A  11      10.664   9.911   8.632  0.50 15.00           H
ATOM    139  HB3ATYR A  11      10.044  11.252   8.053  0.50 15.00           H
ATOM    140  HD1ATYR A  11       7.446  10.662   7.270  0.50 15.00           H
ATOM    141  HD2ATYR A  11       9.383   9.140  10.420  0.50 15.00           H
ATOM    142  HE1ATYR A  11       5.427  10.160   8.265  0.50 15.00           H
ATOM    143  HE2ATYR A  11       7.366   8.637  11.419  0.50 15.00           H
ATOM    144  HH ATYR A  11       5.131   8.687  11.279  0.50 15.00           H
ATOM    145  CA BTYR A  11      10.100   9.738   6.660  0.50 15.00           C
ATOM    146  CB BTYR A  11       9.960  10.286   8.081  0.50 15.00           C
ATOM    147  CG BTYR A  11      10.474  11.698   8.244  0.50 15.00           C
ATOM    148  CD1BTYR A  11       9.764  12.780   7.741  0.50 15.00           C
ATOM    149  CD2BTYR A  11      11.671  11.950   8.902  0.50 15.00           C
ATOM    150  CE1BTYR A  11      10.230  14.072   7.888  0.50 15.00           C
ATOM    151  CE2BTYR A  11      12.146  13.239   9.053  0.50 15.00           C
ATOM    152  CZ BTYR A  11      11.422  14.296   8.545  0.50 15.00           C
ATOM    153  OH BTYR A  11      11.890  15.582   8.693  0.50 15.00           O
ATOM    154  HB2BTYR A  11       9.021  10.283   8.326  0.50 15.00           H
ATOM    155  HB3BTYR A  11      10.459   9.717   8.687  0.50 15.00           H
ATOM    156  HD1BTYR A  11       8.960  12.632   7.297  0.50 15.00           H
ATOM    157  HD2BTYR A  11      12.162  11.239   9.246  0.50 15.00           H
ATOM    158  HE1BTYR A  11       9.744  14.787   7.545  0.50 15.00           H
ATOM    159  HE2BTYR A  11      12.949  13.393   9.496  0.50 15.00           H
ATOM    160  HH BTYR A  11      12.620  15.575   9.109  0.50 15.00           H
TER
END
"""

type_list_known1 = ['2tetra', '2tetra', 'alg1b', '3neigbs', '3neigbs',
  '3neigbs', 'alg1b', '2tetra', '2tetra', '2tetra', '2tetra', 'alg1b',
  '3neigbs', '2tetra', '2tetra', '3neigbs', '2tetra', '2tetra', 'flat_2neigbs',
  '3neigbs', '2tetra', '2tetra', 'alg1b', '2tetra', '2tetra', 'alg1b',
  '2tetra', '2tetra', 'alg1b', '3neigbs', '3neigbs', 'prop', 'prop', 'prop',
  'prop', 'prop', 'prop', '3neigbs', 'prop', 'prop', 'prop', 'prop', 'prop',
  'prop', '3neigbs', '2tetra', '2tetra', 'alg1b', '2tetra', '2tetra', 'alg1b',
  'flat_2neigbs', '3neigbs', '2tetra', '2tetra', 'flat_2neigbs', 'flat_2neigbs',
  'flat_2neigbs', 'flat_2neigbs', 'alg1b', '2tetra', '2tetra', 'flat_2neigbs',
  'flat_2neigbs', 'flat_2neigbs', 'flat_2neigbs', 'alg1b']

pdb_str2 = """
CRYST1   13.142   13.841   12.524  90.00  90.00  90.00 P 1
SCALE1      0.076092  0.000000  0.000000        0.00000
SCALE2      0.000000  0.072249  0.000000        0.00000
SCALE3      0.000000  0.000000  0.079847        0.00000
ATOM    285  CB  ALA A  25      21.105  -3.928  25.422  1.00 11.78           C
ATOM    286  N  AALA A  25      18.694  -4.221  25.276  0.50  9.87           N
ATOM    287  CA AALA A  25      19.812  -3.247  25.214  0.50 10.86           C
ATOM    288  C  AALA A  25      19.902  -2.496  23.898  0.50  9.98           C
ATOM    289  O  AALA A  25      20.720  -1.565  23.768  0.50  7.99           O
ATOM    291  HA AALA A  25      19.625  -2.606  25.918  0.50 11.03           H
ATOM    292  HB1AALA A  25      21.824  -3.278  25.378  0.50 11.78           H
ATOM    293  HB2AALA A  25      21.109  -4.356  26.292  0.50 11.78           H
ATOM    294  HB3AALA A  25      21.233  -4.598  24.732  0.50 11.78           H
ATOM    295  N  BALA A  25      18.682  -4.224  25.328  0.50 10.05           N
ATOM    296  CA BALA A  25      19.756  -3.242  25.276  0.50 11.02           C
ATOM    297  C  BALA A  25      19.678  -2.389  23.992  0.50  9.97           C
ATOM    298  O  BALA A  25      20.024  -1.203  24.029  0.50 11.29           O
ATOM    300  HA BALA A  25      19.650  -2.631  26.022  0.50 11.03           H
ATOM    301  HB1BALA A  25      21.811  -3.264  25.386  0.50 11.78           H
ATOM    302  HB2BALA A  25      21.142  -4.393  26.273  0.50 11.78           H
ATOM    303  HB3BALA A  25      21.224  -4.566  24.701  0.50 11.78           H
"""

type_list_known2 = ['3neigbs', 'prop', 'prop', 'prop',
  '3neigbs', 'prop', 'prop', 'prop']


# This fragment is from PDB model 1qjh
# A residue (Arg 71 in 1qjh) is close to its symmetry mate.
# The geo file lists two asu bond restraints for atom HH22 (there should be
# only one, IMHO!).
# The fact that HH22 has no simple bond proxy, but angle proxies, caused
# an error (asu covalent bond restraints are currently ignored).

pdb_str3 = """
CRYST1   49.701   49.701   73.255  90.00  90.00  90.00 P 42 21 2     8
ORIGX1      1.000000  0.000000  0.000000        0.00000
ORIGX2      0.000000  1.000000  0.000000        0.00000
ORIGX3      0.000000  0.000000  1.000000        0.00000
SCALE1      0.020120  0.000000  0.000000        0.00000
SCALE2      0.000000  0.020120  0.000000        0.00000
SCALE3      0.000000  0.000000  0.013651        0.00000
ATOM    575  N   ARG A  71       4.405  19.140  21.765  1.00 56.18           N
ATOM    576  CA  ARG A  71       4.384  20.597  21.643  1.00 50.81           C
ATOM    577  C   ARG A  71       5.782  21.217  21.647  1.00 45.46           C
ATOM    578  O   ARG A  71       5.933  22.440  21.582  1.00 46.55           O
ATOM    579  CB  ARG A  71       3.558  21.214  22.773  1.00 51.01           C
ATOM    580  CG  ARG A  71       2.166  20.635  22.956  1.00 52.13           C
ATOM    581  CD  ARG A  71       1.358  20.625  21.661  1.00 60.92           C
ATOM    582  NE  ARG A  71       1.134  21.965  21.122  1.00 63.41           N
ATOM    583  CZ  ARG A  71       0.470  22.927  21.755  1.00 62.11           C
ATOM    584  NH1 ARG A  71      -0.038  22.699  22.955  1.00 60.26           N
ATOM    585  NH2 ARG A  71       0.310  24.119  21.188  1.00 62.26           N
ATOM      0  HA  ARG A  71       3.979  20.793  20.783  1.00 50.81           H
ATOM      0  HB2 ARG A  71       4.047  21.109  23.604  1.00 51.01           H
ATOM      0  HB3 ARG A  71       3.476  22.167  22.610  1.00 51.01           H
ATOM      0  HG2 ARG A  71       2.238  19.729  23.295  1.00 52.13           H
ATOM      0  HG3 ARG A  71       1.690  21.151  23.626  1.00 52.13           H
ATOM      0  HD2 ARG A  71       1.822  20.088  20.999  1.00 60.92           H
ATOM      0  HD3 ARG A  71       0.502  20.199  21.822  1.00 60.92           H
ATOM      0  HE  ARG A  71       1.453  22.143  20.343  1.00 63.41           H
ATOM      0 HH11 ARG A  71       0.062  21.929  23.325  1.00 60.26           H
ATOM      0 HH12 ARG A  71      -0.468  23.321  23.365  1.00 60.26           H
ATOM      0 HH21 ARG A  71       0.637  24.271  20.407  1.00 62.26           H
ATOM      0 HH22 ARG A  71      -0.120  24.738  21.602  1.00 62.26           H
"""

type_list_known3 = ['3neigbs', '2tetra', '2tetra', '2tetra', '2tetra',
 '2tetra', '2tetra', 'flat_2neigbs', 'alg1a', 'alg1a']

def exercise3(pdb_str, type_list_known):
  pdb_inp = iotbx.pdb.input(lines=pdb_str.split("\n"), source_info=None)
  params = mmtbx.model.manager.get_default_pdb_interpretation_scope().extract()
  params.pdb_interpretation.allow_polymer_cross_special_position=True
  model = mmtbx.model.manager(
    model_input = pdb_inp,
    log         = null_out())
  model.process(pdb_interpretation_params=params, make_restraints=True)
  pdb_hierarchy = model.get_hierarchy()
  sites_cart = model.get_sites_cart()
  atoms = pdb_hierarchy.atoms()

  model.setup_riding_h_manager()
  riding_h_manager = model.get_riding_h_manager()

  h_para = riding_h_manager.h_parameterization

  diagnostics = riding_h_manager.diagnostics(
    sites_cart = sites_cart,
    threshold  = 0.05)
  h_distances   = diagnostics.h_distances
  type_list     = diagnostics.type_list

  number_h = model.get_hd_selection().count(True)
  number_h_para = len(h_para) - h_para.count(None)

  assert (number_h_para == number_h-2), 'Not all H atoms are parameterized'

  for ih in h_distances:
    labels = atoms[ih].fetch_labels()
    assert (h_distances[ih] < 0.2), \
      'distance too large: %s  atom: %s (%s) residue: %s ' \
      % (h_para[ih].htype, atoms[ih].name, ih, labels.resseq.strip())

  for type1, type2 in zip(type_list, type_list_known):
    assert (type1 == type2)

if (__name__ == "__main__"):
  t0 = time.time()
  exercise(pdb_str = pdb_str1, type_list_known = type_list_known1)
  exercise(pdb_str = pdb_str2, type_list_known = type_list_known2)
  exercise3(pdb_str = pdb_str3, type_list_known = type_list_known3)

  print("OK. Time: %8.3f"%(time.time()-t0))


 *******************************************************************************


 *******************************************************************************
mmtbx/hydrogens/tst_parameterization_6.py
from __future__ import absolute_import, division, print_function
import time
import mmtbx.model
import iotbx.pdb
from libtbx.utils import null_out
from six.moves import zip

#-----------------------------------------------------------------------------
# This test checks the parameterization of H/D atoms in models containing
# both H and D atoms
#-----------------------------------------------------------------------------

def exercise(pdb_str):
  params = mmtbx.model.manager.get_default_pdb_interpretation_params()
  params.pdb_interpretation.use_neutron_distances = True

  pdb_inp = iotbx.pdb.input(lines=pdb_str.split("\n"), source_info=None)
  model = mmtbx.model.manager(
    model_input = pdb_inp,
    log         = null_out())
  model.process(pdb_interpretation_params=params, make_restraints=True)

  pdb_hierarchy = model.get_hierarchy()
  sites_cart = model.get_sites_cart()
  atoms = pdb_hierarchy.atoms()

  model.setup_riding_h_manager()
  riding_h_manager = model.get_riding_h_manager()

  h_parameterization = riding_h_manager.h_parameterization

  diagnostics = riding_h_manager.diagnostics(
    sites_cart         = sites_cart,
    threshold          = 0.05)
  h_distances        = diagnostics.h_distances

  number_h = model.get_hd_selection().count(True)
  number_h_para = len(h_parameterization) - h_parameterization.count(None)

  if (pdb_str != pdb_str_02):
    assert (number_h_para == number_h), 'Not all H atoms are parameterized'

# For each H atom, check if distance between computed H and that in input model is
# not too large
  for ih in h_distances:
    labels = atoms[ih].fetch_labels()
    assert (h_distances[ih] < 0.1), \
      'distance too large: %s  atom: %s (%s) residue: %s ' \
      % (h_parameterization[ih].htype, atoms[ih].name, ih, labels.resseq.strip())

  #for type1, type2 in zip(type_list, type_list_known):
  #  assert (type1 == type2)


pdb_str_00 = """\
CRYST1   14.815   23.523   21.068  90.00  90.00  90.00 P 1
SCALE1      0.067499  0.000000  0.000000        0.00000
SCALE2      0.000000  0.042512  0.000000        0.00000
SCALE3      0.000000  0.000000  0.047465        0.00000
ATOM      1  N   ARG A 161       5.235  16.231  12.444  1.00  7.68           N
ATOM      2  CA  ARG A 161       6.309  16.550  13.364  1.00  9.47           C
ATOM      3  C   ARG A 161       7.140  17.751  12.856  1.00 10.84           C
ATOM      4  O   ARG A 161       7.669  18.523  13.658  1.00 11.74           O
ATOM      5  CB  ARG A 161       7.186  15.310  13.584  1.00 13.82           C
ATOM      6  CG  ARG A 161       6.357  14.097  14.068  1.00 16.56           C
ATOM      7  CD  ARG A 161       7.166  13.049  14.764  1.00 11.41           C
ATOM      8  NE  ARG A 161       6.350  11.919  15.227  1.00 18.74           N
ATOM      9  CZ  ARG A 161       6.279  10.732  14.648  1.00 12.24           C
ATOM     10  NH1 ARG A 161       6.967  10.428  13.537  1.00 11.51           N
ATOM     11  NH2 ARG A 161       5.503   9.814  15.194  1.00 16.77           N
ATOM     12  DE  ARG A 161       5.791  12.059  16.068  1.00 22.49           D
ATOM     13 DH11 ARG A 161       7.580  11.112  13.087  1.00 13.81           D
ATOM     14 DH21 ARG A 161       5.000  10.019  16.043  1.00 20.13           D
ATOM     15  HA  ARG A 161       5.875  16.826  14.327  1.00 11.37           H
ATOM     16  HB2 ARG A 161       7.666  15.039  12.643  1.00 16.58           H
ATOM     17  HB3 ARG A 161       7.940  15.534  14.339  1.00 16.58           H
ATOM     18  HG2 ARG A 161       5.598  14.449  14.766  1.00 19.87           H
ATOM     19  HG3 ARG A 161       5.878  13.631  13.205  1.00 19.87           H
ATOM     20  HD2 ARG A 161       7.917  12.663  14.076  1.00 13.70           H
ATOM     21  HD3 ARG A 161       7.651  13.492  15.635  1.00 13.70           H
ATOM     22 HH12AARG A 161       6.870   9.515  13.114  0.26 13.81           H
ATOM     23 HH22AARG A 161       5.423   8.890  14.766  0.54 20.13           H
ATOM     24 DH12BARG A 161       6.870   9.515  13.114  0.74 13.81           D
ATOM     25 DH22BARG A 161       5.423   8.890  14.766  0.46 20.13           D
TER
ATOM     26  N   GLY B   2      12.057   9.922   8.317  1.00 27.73           N
ATOM     27  CA  GLY B   2      11.194  10.314   7.218  1.00 26.03           C
ATOM     28  C   GLY B   2       9.719  10.240   7.559  1.00 24.25           C
ATOM     29  O   GLY B   2       9.041  11.263   7.653  1.00 20.41           O
ATOM     30  N   ILE B   3       9.220   9.022   7.744  1.00 27.73           N
ATOM     31  CA  ILE B   3       7.818   8.811   8.076  1.00 26.03           C
ATOM     32  C   ILE B   3       7.565   9.227   9.520  1.00 24.25           C
ATOM     33  O   ILE B   3       8.276   8.806  10.431  1.00 20.41           O
ATOM     34  CB  ILE B   3       7.404   7.345   7.845  1.00 27.04           C
ATOM     35  CG1 ILE B   3       7.452   7.006   6.354  1.00 28.51           C
ATOM     36  CG2 ILE B   3       6.009   7.089   8.398  1.00 26.88           C
ATOM     37  CD1 ILE B   3       7.628   5.530   6.070  1.00 28.93           C
ATOM     38  DA  ILE B   3       7.203   9.439   7.432  1.00 26.09           D
ATOM     39  DB  ILE B   3       8.109   6.700   8.370  1.00 25.53           D
ATOM     40 DD11 ILE B   3       8.556   5.190   6.530  1.00 27.61           D
ATOM     41 DG12 ILE B   3       6.516   7.323   5.893  1.00 27.88           D
ATOM     42  D  AILE B   3       9.763   8.161   7.671  0.96 27.94           D
ATOM     43 DD12AILE B   3       7.670   5.378   4.992  0.43 28.45           D
ATOM     44 DD13AILE B   3       6.783   4.984   6.490  0.86 28.24           D
ATOM     45 DG13AILE B   3       8.288   7.536   5.896  0.69 28.21           D
ATOM     46 DG21AILE B   3       5.354   7.909   8.103  0.96 27.70           D
ATOM     47 DG22AILE B   3       6.062   7.027   9.485  0.78 27.54           D
ATOM     48 DG23AILE B   3       5.635   6.149   7.993  0.81 27.54           D
ATOM     49  H  BILE B   3       9.763   8.161   7.671  0.04 27.94           H
ATOM     50 HG13BILE B   3       8.288   7.536   5.896  0.31 28.21           H
ATOM     51 HG21BILE B   3       5.354   7.909   8.103  0.04 27.70           H
ATOM     52 HG22BILE B   3       6.062   7.027   9.485  0.22 27.54           H
ATOM     53 HG23BILE B   3       5.635   6.149   7.993  0.19 27.54           H
ATOM     54 HD12BILE B   3       7.670   5.378   4.992  0.57 28.45           H
ATOM     55 HD13BILE B   3       6.783   4.984   6.490  0.14 28.24           H
TER
"""

pdb_str_01 = """
CRYST1   14.630   14.210   14.547  90.00  90.00  90.00 P 1
SCALE1      0.068353  0.000000  0.000000        0.00000
SCALE2      0.000000  0.070373  0.000000        0.00000
SCALE3      0.000000  0.000000  0.068743        0.00000
ATOM   1387  N   ILE A  63      21.154 -27.868 -37.969  1.00 22.34           N
ATOM   1388  CA  ILE A  63      21.399 -26.570 -38.585  1.00 21.95           C
ATOM   1389  C   ILE A  63      20.231 -25.648 -38.320  1.00 23.15           C
ATOM   1390  O   ILE A  63      19.079 -25.992 -38.576  1.00 24.15           O
ATOM   1391  CB  ILE A  63      21.593 -26.710 -40.099  1.00 23.08           C
ATOM   1392  CG1 ILE A  63      22.822 -27.578 -40.395  1.00 23.79           C
ATOM   1393  CG2 ILE A  63      21.745 -25.345 -40.744  1.00 23.03           C
ATOM   1394  CD1 ILE A  63      22.871 -28.137 -41.811  1.00 25.99           C
ATOM   1397  DA AILE A  63      22.287 -26.154 -38.157  0.44 22.47           D
ATOM   1398  HA BILE A  63      22.287 -26.154 -38.157  0.56 22.47           H
ATOM   1399  DB AILE A  63      20.719 -27.170 -40.493  0.99 23.45           D
ATOM   1400  HB BILE A  63      20.719 -27.170 -40.493  0.01 23.45           H
ATOM   1401 DG12AILE A  63      23.709 -26.976 -40.253  0.54 23.93           D
ATOM   1402 HG12BILE A  63      23.709 -26.976 -40.253  0.46 23.93           H
ATOM   1403 DG13AILE A  63      22.850 -28.402 -39.700  0.65 23.97           D
ATOM   1404 HG13BILE A  63      22.850 -28.402 -39.700  0.35 23.97           H
ATOM   1405 HG21 ILE A  63      21.066 -24.629 -40.306  1.00 22.80           H
ATOM   1406 DG22AILE A  63      21.541 -25.426 -41.799  0.51 22.86           D
ATOM   1407 HG22BILE A  63      21.541 -25.426 -41.799  0.49 22.86           H
ATOM   1408 DG23 ILE A  63      22.758 -25.015 -40.597  1.00 23.40           D
ATOM   1409 DD11AILE A  63      21.935 -28.641 -42.033  0.67 24.71           D
ATOM   1410 HD11BILE A  63      21.935 -28.641 -42.033  0.33 24.71           H
ATOM   1411 DD12AILE A  63      23.680 -28.839 -41.891  0.44 24.81           D
ATOM   1412 HD12BILE A  63      23.680 -28.839 -41.891  0.56 24.81           H
ATOM   1413 DD13AILE A  63      23.024 -27.344 -42.516  0.90 24.27           D
ATOM   1414 HD13BILE A  63      23.024 -27.344 -42.516  0.10 24.27           H
"""

pdb_str_02 = """
CRYST1   15.636   16.098   18.562  90.00  90.00  90.00 P 1
SCALE1      0.063955  0.000000  0.000000        0.00000
SCALE2      0.000000  0.062120  0.000000        0.00000
SCALE3      0.000000  0.000000  0.053874        0.00000
ATOM    517  N   GLU A  30       4.726  39.084   1.924  1.00 18.34           N
ATOM    519  C   GLU A  30       6.556  40.664   2.421  1.00 20.67           C
ATOM    533  D   GLU A  31       5.082  40.344   3.856  1.00 21.59           D
ATOM    534  N  AGLU A  31       5.986  40.754   3.619  0.29 20.27           N
ATOM    535  CA AGLU A  31       6.623  41.467   4.722  0.29 21.76           C
ATOM    536  C  AGLU A  31       7.429  40.530   5.617  0.29 20.64           C
ATOM    548  N  CGLU A  31       5.986  40.753   3.620  0.71 20.17           N
ATOM    549  CA CGLU A  31       6.621  41.462   4.726  0.71 21.77           C
ATOM    550  C  CGLU A  31       7.488  40.540   5.574  0.71 20.61           C
"""

pdb_list = [pdb_str_00, pdb_str_01, pdb_str_02]

pdb_list_name = ['pdb_str_00', 'pdb_str_01', 'pdb_str_02']

#type_list_known = ['2tetra', '2tetra', 'alg1b', '3neigbs', '3neigbs',
#  '3neigbs', 'alg1b', '2tetra', '2tetra', '2tetra', '2tetra', 'alg1b',
#  '3neigbs', '2tetra', '2tetra', '3neigbs', '2tetra', '2tetra',
#  'flat_2neigbs', 'alg1b', '3neigbs', '2tetra', '2tetra', 'alg1b',
#  '2tetra', '2tetra', 'alg1b', '2tetra', '2tetra', 'alg1b', '3neigbs',
#  'prop', 'prop', 'prop', 'prop', 'prop', 'prop', '3neigbs', 'prop',
#  'prop', 'prop', 'prop', 'prop', 'prop', '3neigbs', '2tetra', '2tetra',
#  'alg1b', '2tetra', '2tetra', 'alg1b', 'flat_2neigbs']

def run():
  for pdb_str, str_name in zip(pdb_list,pdb_list_name):
    exercise(pdb_str=pdb_str)


if (__name__ == "__main__"):
  t0 = time.time()
  run()
  print("OK. Time: %8.3f"%(time.time()-t0))


 *******************************************************************************


 *******************************************************************************
mmtbx/hydrogens/tst_parameterization_7.py
from __future__ import absolute_import, division, print_function
import time
import mmtbx.model
import iotbx.pdb
import iotbx.cif
from libtbx.utils import null_out
from six.moves import zip

def prepare_inputs(pdb_str, cif_str):
  pdb_inp = iotbx.pdb.input(lines=pdb_str.split("\n"), source_info=None)
  cif_object = iotbx.cif.reader(input_string = cif_str).model()
  # bla.cif does not exist, but cif_objects needs a filename in first position
  # of the tuple
  cif_objects = [('bla.cif', cif_object)]

  model = mmtbx.model.manager(
    model_input=pdb_inp,
    restraint_objects = cif_objects,
    log = null_out())
  model.process(make_restraints=True)
  model.setup_riding_h_manager()
  riding_h_manager = model.get_riding_h_manager()

  return model

#-----------------------------------------------------------------------------
# For this ligand, three H cannot be parameterized
# NH2 group is planar, but there are no dihedral restraints
# no dihedral restraint for H11
#-----------------------------------------------------------------------------

def exercise1(pdb_str, cif_str):
  model = prepare_inputs(pdb_str, cif_str)
  riding_h_manager = model.get_riding_h_manager()
  atoms = model.get_hierarchy().atoms()

  h_para = riding_h_manager.h_parameterization

  diagnostics = riding_h_manager.diagnostics(
    sites_cart = model.get_sites_cart(),
    threshold  = 0.05)
  h_distances   = diagnostics.h_distances
  type_list     = diagnostics.type_list

# number of H atoms
  number_h = model.get_hd_selection().count(True)
  number_h_para = len(h_para) - h_para.count(None)

  assert (number_h_para == number_h-3), 'Not all H atoms are parameterized'

  for ih in h_distances:
    # One atom is expected to be moved
    if (ih == 16):
      continue
    labels = atoms[ih].fetch_labels()
    assert (h_distances[ih] < 0.1), \
      'distance too large: %s  atom: %s (%s) residue: %s ' \
      % (h_para[ih].htype, atoms[ih].name, ih, labels.resseq.strip())

  for type1, type2 in zip(type_list, type_list_known1):
    assert (type1 == type2)
    #print "'%s'," % type1,

def exercise2(pdb_str, cif_str):
  model = prepare_inputs(pdb_str, cif_str)
  riding_h_manager = model.get_riding_h_manager()
  atoms = model.get_hierarchy().atoms()

  h_para = riding_h_manager.h_parameterization

  diagnostics = riding_h_manager.diagnostics(
    sites_cart = model.get_sites_cart(),
    threshold  = 0.05)
  h_distances   = diagnostics.h_distances
  type_list     = diagnostics.type_list

# number of H atoms
  number_h = model.get_hd_selection().count(True)
  number_h_para = len(h_para) - h_para.count(None)

  assert (number_h_para == 0), 'Not all H atoms are parameterized'

pdb_str1 = """\
REMARK iotbx.pdb.box_around_molecule --buffer-layer=5 "02.updated.nomin..pdb"
REMARK Date 2017-07-10 Time 12:11:01 PDT -0700 (1499713861.46 s)
CRYST1   15.938   15.073   11.550  90.00  90.00  90.00 P 1
SCALE1      0.062743  0.000000  0.000000        0.00000
SCALE2      0.000000  0.066344  0.000000        0.00000
SCALE3      0.000000  0.000000  0.086580        0.00000
HETATM    1  C1  3HA   401       7.842   9.143   5.222  1.00 83.17           C
HETATM    2  C2  3HA   401       7.240   7.911   5.459  1.00 81.93           C
HETATM    3  C3  3HA   401       8.027   6.770   5.589  1.00 82.00           C
HETATM    4  C4  3HA   401       9.411   6.864   5.486  1.00 82.52           C
HETATM    5  C5  3HA   401      10.012   8.097   5.252  1.00 83.82           C
HETATM    6  C6  3HA   401       9.226   9.238   5.118  1.00 84.24           C
HETATM    7  C7  3HA   401       5.719   7.834   5.619  1.00 81.09           C
HETATM    8  N10 3HA   401       7.463   5.583   5.793  1.00 82.31           N
HETATM    9  O11 3HA   401      10.183   5.752   5.619  1.00 82.09           O
HETATM   10  O8  3HA   401       5.197   6.868   6.174  1.00 81.05           O
HETATM   11  O9  3HA   401       5.000   8.734   5.190  1.00 78.80           O
HETATM   12  H1  3HA   401       7.315   9.910   5.134  1.00 83.17           H
HETATM   13  H11 3HA   401      10.719   5.854   6.276  1.00 82.09           H
HETATM   14  H5  3HA   401      10.938   8.151   5.134  1.00 83.82           H
HETATM   15  H6  3HA   401       9.630  10.073   5.000  1.00 84.24           H
HETATM   16 H101 3HA   401       7.572   5.175   6.550  1.00 82.31           H
HETATM   17 H102 3HA   401       7.435   5.000   5.152  1.00 82.31           H
TER
END
"""


cif_str1 = """
#
data_comp_list
loop_
_chem_comp.id
_chem_comp.three_letter_code
_chem_comp.name
_chem_comp.group
_chem_comp.number_atoms_all
_chem_comp.number_atoms_nh
_chem_comp.desc_level
3HA 3HA "Unknown                  " ligand 17 11 .
#
data_comp_3HA
#
loop_
_chem_comp_atom.comp_id
_chem_comp_atom.atom_id
_chem_comp_atom.type_symbol
_chem_comp_atom.type_energy
_chem_comp_atom.charge
_chem_comp_atom.partial_charge
_chem_comp_atom.x
_chem_comp_atom.y
_chem_comp_atom.z
3HA        O8      O   OC    -1 .         -2.5304   -0.3544    2.0294
3HA        C7      C   C      0 .         -1.2760   -0.4611    2.0390
3HA        O9      O   O      0 .         -0.6571   -0.5146    3.1342
3HA        C2      C   CR6    0 .         -0.5023   -0.4939    0.7224
3HA        C1      C   CR16   0 .         -0.2734   -1.7018    0.0834
3HA        C6      C   CR16   0 .          0.4107   -1.7296   -1.1210
3HA        C5      C   CR16   0 .          0.8659   -0.5495   -1.6865
3HA        C4      C   CR6    0 .          0.6370    0.6583   -1.0475
3HA        O11     O   OH1    0 .          1.1017    1.8508   -1.6167
3HA        C3      C   CR6    0 .         -0.0471    0.6861    0.1569
3HA        N10     N   NH2    0 .         -0.3039    1.9536    0.8168
3HA        H1      H   HCR6   0 .         -0.6294   -2.6246    0.5256
3HA        H6      H   HCR6   0 .          0.5887   -2.6740   -1.6213
3HA        H5      H   HCR6   0 .          1.4009   -0.5713   -2.6283
3HA        H11     H   HOH1   0 .          2.0033    1.7449   -1.8770
3HA        H101    H   HNH2   0 .          0.0644    2.1253    1.7332
3HA        H102    H   HNH2   0 .         -0.8528    2.6556    0.3576
#
loop_
_chem_comp_bond.comp_id
_chem_comp_bond.atom_id_1
_chem_comp_bond.atom_id_2
_chem_comp_bond.type
_chem_comp_bond.value_dist
_chem_comp_bond.value_dist_esd
_chem_comp_bond.value_dist_neutron
3HA  O8      C7     deloc         1.259 0.020     1.259
3HA  C7      O9     deloc         1.259 0.020     1.259
3HA  C7      C2     single        1.527 0.020     1.527
3HA  C2      C1     aromatic      1.386 0.020     1.386
3HA  C2      C3     aromatic      1.385 0.020     1.385
3HA  C1      C6     aromatic      1.385 0.020     1.385
3HA  C1      H1     single        0.930 0.020     1.080
3HA  C6      C5     aromatic      1.385 0.020     1.385
3HA  C6      H6     single        0.930 0.020     1.080
3HA  C5      C4     aromatic      1.385 0.020     1.385
3HA  C5      H5     single        0.930 0.020     1.080
3HA  C4      O11    single        1.401 0.020     1.401
3HA  C4      C3     aromatic      1.385 0.020     1.385
3HA  O11     H11    single        0.850 0.020     0.980
3HA  C3      N10    single        1.452 0.020     1.452
3HA  N10     H101   single        0.860 0.020     1.020
3HA  N10     H102   single        0.860 0.020     1.020
#
loop_
_chem_comp_angle.comp_id
_chem_comp_angle.atom_id_1
_chem_comp_angle.atom_id_2
_chem_comp_angle.atom_id_3
_chem_comp_angle.value_angle
_chem_comp_angle.value_angle_esd
3HA  C2      C7      O9           120.00 3.000
3HA  C2      C7      O8           119.99 3.000
3HA  O9      C7      O8           120.00 3.000
3HA  C3      C2      C1           120.00 3.000
3HA  C3      C2      C7           120.00 3.000
3HA  C1      C2      C7           120.00 3.000
3HA  H1      C1      C6           120.00 3.000
3HA  H1      C1      C2           120.00 3.000
3HA  C6      C1      C2           120.00 3.000
3HA  H6      C6      C5           120.00 3.000
3HA  H6      C6      C1           120.00 3.000
3HA  C5      C6      C1           120.00 3.000
3HA  H5      C5      C4           120.00 3.000
3HA  H5      C5      C6           120.00 3.000
3HA  C4      C5      C6           120.00 3.000
3HA  C3      C4      O11          120.00 3.000
3HA  C3      C4      C5           120.00 3.000
3HA  O11     C4      C5           120.00 3.000
3HA  H11     O11     C4           109.47 3.000
3HA  N10     C3      C4           120.00 3.000
3HA  N10     C3      C2           120.00 3.000
3HA  C4      C3      C2           120.00 3.000
3HA  H102    N10     H101         120.00 3.000
3HA  H102    N10     C3           120.00 3.000
3HA  H101    N10     C3           120.00 3.000
#
loop_
_chem_comp_tor.comp_id
_chem_comp_tor.id
_chem_comp_tor.atom_id_1
_chem_comp_tor.atom_id_2
_chem_comp_tor.atom_id_3
_chem_comp_tor.atom_id_4
_chem_comp_tor.value_angle
_chem_comp_tor.value_angle_esd
_chem_comp_tor.period
3HA CONST_01      C5      C6      C1      C2             0.00   0.0 0
3HA CONST_02      C5      C4      C3      C2             0.00   0.0 0
3HA CONST_03      C4      C3      C2      C1            -0.00   0.0 0
3HA CONST_04      C4      C5      C6      C1            -0.00   0.0 0
3HA CONST_05      C3      C2      C1      C6             0.00   0.0 0
3HA CONST_06      C3      C4      C5      C6             0.00   0.0 0
3HA CONST_07      C6      C1      C2      C7           179.02   0.0 0
3HA CONST_08      C4      C3      C2      C7          -179.02   0.0 0
3HA CONST_09      O11     C4      C3      C2          -179.76   0.0 0
3HA CONST_10      N10     C3      C2      C1           179.11   0.0 0
3HA CONST_11      O11     C4      C5      C6           179.76   0.0 0
3HA CONST_12      N10     C3      C4      C5          -179.11   0.0 0
3HA CONST_13      H6      C6      C1      C2          -179.93   0.0 0
3HA CONST_14      H5      C5      C6      C1           180.00   0.0 0
3HA CONST_15      H1      C1      C6      C5          -180.00   0.0 0
3HA CONST_16      H101    N10     C3      C2            61.62   0.0 0
3HA CONST_17      H102    N10     C3      C2          -118.12   0.0 0
3HA Var_01        C1      C2      C7      O8           -88.86  30.0 2
#
loop_
_chem_comp_plane_atom.comp_id
_chem_comp_plane_atom.plane_id
_chem_comp_plane_atom.atom_id
_chem_comp_plane_atom.dist_esd
3HA plan-1  C7     0.020
3HA plan-1  C2     0.020
3HA plan-1  C1     0.020
3HA plan-1  C6     0.020
3HA plan-1  C5     0.020
3HA plan-1  C4     0.020
3HA plan-1  O11    0.020
3HA plan-1  C3     0.020
3HA plan-1  N10    0.020
3HA plan-1  H1     0.020
3HA plan-1  H6     0.020
3HA plan-1  H5     0.020
3HA plan-2  C3     0.020
3HA plan-2  N10    0.020
3HA plan-2  H101   0.020
3HA plan-2  H102   0.020
3HA plan-3  O8     0.020
3HA plan-3  C7     0.020
3HA plan-3  O9     0.020
3HA plan-3  C2     0.020
"""

#type_list_known1 = ['flat_2neigbs', 'alg1b', 'flat_2neigbs', 'flat_2neigbs',
#  'alg1a', 'alg1a']
type_list_known1 = ['flat_2neigbs', 'flat_2neigbs', 'flat_2neigbs']

# Zundelion ( [H2O -- H -- OH2]+)

pdb_str2 = """
CRYST1   12.247   13.433   12.428  90.00  90.00  90.00 P 1
SCALE1      0.081653  0.000000  0.000000        0.00000
SCALE2      0.000000  0.074444  0.000000        0.00000
SCALE3      0.000000  0.000000  0.080463        0.00000
HETATM    1  O   ZDL A   1       0.414   0.852  -0.974  1.00 30.00           O
HETATM    2  H1  ZDL A   1      -0.135   1.630  -0.847  1.00 30.00           H
HETATM    3  H2  ZDL A   1       1.338   1.093  -0.875  1.00 30.00           H
HETATM    4  O1  ZDL A   1      -0.233  -1.018   0.869  1.00 30.00           O
HETATM    5  H3  ZDL A   1      -0.566  -1.803   0.427  1.00 30.00           H
HETATM    6  H4  ZDL A   1      -0.909  -0.670   1.454  1.00 30.00           H
HETATM    7  H5  ZDL A   1       0.091  -0.084  -0.054  1.00 30.00           H
"""

cif_str2 = """
data_comp_list
loop_
_chem_comp.id
_chem_comp.three_letter_code
_chem_comp.name
_chem_comp.group
_chem_comp.number_atoms_all
_chem_comp.number_atoms_nh
_chem_comp.desc_level
ZDL        ZDL 'zundel ion                  ' ligand 7 6 .
#
data_comp_ZDL
#
loop_
_chem_comp_atom.comp_id
_chem_comp_atom.atom_id
_chem_comp_atom.type_symbol
_chem_comp_atom.type_energy
_chem_comp_atom.charge
_chem_comp_atom.partial_charge
_chem_comp_atom.x
_chem_comp_atom.y
_chem_comp_atom.z
ZDL         O      O   O      0    .       1.8400   38.7010   -3.2140
ZDL         H1     H   H      0    .       1.3350   39.4980   -3.3000
ZDL         H2     H   H      0    .       2.7520   38.9490   -3.2430
ZDL         O1     O   O      0    .       1.0410   36.8380   -1.5510
ZDL         H3     H   H      0    .       0.8620   35.9420   -1.8460
ZDL         H4     H   H      0    .       0.5460   37.0160   -0.7480
ZDL         H5     H   H     +1    .       1.2760   37.8090   -2.1650
#
loop_
_chem_comp_bond.comp_id
_chem_comp_bond.atom_id_1
_chem_comp_bond.atom_id_2
_chem_comp_bond.type
_chem_comp_bond.value_dist
_chem_comp_bond.value_dist_esd
_chem_comp_bond.value_dist_neutron
ZDL   O       H1    single        0.960 0.020     0.960
ZDL   O       H2    single        0.960 0.020     0.960
ZDL   O       H5    single        1.350 0.350     1.350
ZDL   O1      H5    single        1.350 0.350     1.350
ZDL   O1      H4    single        0.960 0.020     0.960
ZDL   O1      H3    single        0.960 0.020     0.960
#
loop_
_chem_comp_angle.comp_id
_chem_comp_angle.atom_id_1
_chem_comp_angle.atom_id_2
_chem_comp_angle.atom_id_3
_chem_comp_angle.value_angle
_chem_comp_angle.value_angle_esd
ZDL   H2      O       H1          109.47 3.000
ZDL   H3      O1      H4          109.47 3.000
ZDL   H1      O       H5          109.49 6.000
ZDL   H2      O       H5          109.49 6.000
ZDL   H3      O1      H5          109.49 6.000
ZDL   H4      O1      H5          109.49 6.000
ZDL   O       H5      O1          180.00 9.000
"""

if (__name__ == "__main__"):
  t0 = time.time()
  exercise1(pdb_str1, cif_str1)
  exercise2(pdb_str2, cif_str2)
  print("OK. Time: %8.3f"%(time.time()-t0))


 *******************************************************************************


 *******************************************************************************
mmtbx/hydrogens/tst_parameterization_8.py
from __future__ import absolute_import, division, print_function
import time
import mmtbx.model
import iotbx.pdb
import iotbx.phil
from mmtbx.hydrogens import connectivity
from libtbx.utils import null_out
from mmtbx.monomer_library.pdb_interpretation import grand_master_phil_str
from six.moves import zip


def exercise1():

  pdb_str = """
CRYST1   21.850   24.325   24.603  90.00  90.00  90.00 P 1
SCALE1      0.045767  0.000000  0.000000        0.00000
SCALE2      0.000000  0.041110  0.000000        0.00000
SCALE3      0.000000  0.000000  0.040645        0.00000
ATOM      1  N   CYS D  37       8.132  18.794  15.343  1.00143.27      D    N
ANISOU    1  N   CYS D  37    26762  17628  10046  -3652   3033    538  D    N
ATOM      2  CA  CYS D  37       9.229  18.179  14.592  1.00143.16      D    C
ANISOU    2  CA  CYS D  37    26739  17512  10144  -3661   2916    574  D    C
ATOM      3  C   CYS D  37      10.551  18.924  14.744  1.00143.18      D    C
ANISOU    3  C   CYS D  37    26760  17474  10166  -3627   2815    455  D    C
ATOM      4  O   CYS D  37      11.615  18.295  14.696  1.00141.47      D    O
ANISOU    4  O   CYS D  37    26571  17211   9972  -3636   2700    489  D    O
ATOM      5  CB  CYS D  37       8.857  18.048  13.112  1.00144.61      D    C
ANISOU    5  CB  CYS D  37    26841  17595  10509  -3672   2948    608  D    C
ATOM      6  SG  CYS D  37       7.159  17.517  12.843  1.00142.64      D    S
ANISOU    6  SG  CYS D  37    26553  17390  10253  -3704   3086    716  D    S
ATOM      8  HA  CYS D  37       9.365  17.282  14.934  1.00171.95      D    H
ATOM      9  HB2 CYS D  37       8.970  18.910  12.683  1.00173.69      D    H
ATOM     10  HB3 CYS D  37       9.442  17.394  12.699  1.00173.69      D    H
ATOM     11  N   CYS D  40      13.775  17.698  16.644  1.00154.41      D    N
ANISOU   11  N   CYS D  40    28359  18912  11399  -3629   2475    474  D    N
ATOM     12  CA  CYS D  40      14.636  16.639  16.128  1.00149.28      D    C
ANISOU   12  CA  CYS D  40    27712  18183  10825  -3653   2369    564  D    C
ATOM     13  C   CYS D  40      15.084  16.830  14.685  1.00148.00      D    C
ANISOU   13  C   CYS D  40    27476  17888  10868  -3647   2342    540  D    C
ATOM     14  O   CYS D  40      16.158  16.339  14.335  1.00149.38      D    O
ANISOU   14  O   CYS D  40    27657  17989  11113  -3652   2233    563  D    O
ATOM     15  CB  CYS D  40      13.921  15.279  16.208  1.00140.80      D    C
ANISOU   15  CB  CYS D  40    26653  17143   9703  -3698   2398    729  D    C
ATOM     16  SG  CYS D  40      13.262  14.779  17.830  1.00136.64      D    S
ANISOU   16  SG  CYS D  40    26211  16771   8936  -3714   2439    794  D    S
ATOM     18  HA  CYS D  40      15.432  16.588  16.680  1.00179.29      D    H
ATOM     19  HB2 CYS D  40      13.174  15.295  15.590  1.00169.12      D    H
ATOM     20  HB3 CYS D  40      14.548  14.592  15.932  1.00169.12      D    H
HETATM   21  NB  HEC D1001       9.421  13.220  11.858  1.00140.59           N
ANISOU   21  NB  HEC D1001    26354  16953  10112  -3810   2765   1093       N
HETATM   22  ND  HEC D1001      12.886  11.034  12.753  1.00144.24           N
ANISOU   22  ND  HEC D1001    26954  17334  10517  -3839   2396   1214       N
HETATM   23  C1A HEC D1001      12.227  10.592   9.833  1.00139.00           C
ANISOU   23  C1A HEC D1001    26141  16470  10203  -3864   2452   1283       C
HETATM   24  C1B HEC D1001       8.860  13.248  10.595  1.00143.63           C
ANISOU   24  C1B HEC D1001    26666  17264  10645  -3817   2816   1110       C
HETATM   25  C1C HEC D1001      10.125  13.804  14.697  1.00139.27           C
ANISOU   25  C1C HEC D1001    26337  16981   9599  -3780   2714   1003       C
HETATM   26  C1D HEC D1001      13.435  10.960  14.028  1.00134.69           C
ANISOU   26  C1D HEC D1001    25819  16201   9156  -3833   2339   1204       C
HETATM   27  C2A HEC D1001      11.928  10.386   8.429  1.00142.28           C
ANISOU   27  C2A HEC D1001    26487  16789  10784  -3875   2476   1314       C
HETATM   28  C2B HEC D1001       7.789  14.214  10.617  1.00141.94           C
ANISOU   28  C2B HEC D1001    26417  17097  10418  -3798   2937   1044       C
HETATM   29  C2C HEC D1001      10.451  14.023  16.100  1.00140.94           C
ANISOU   29  C2C HEC D1001    26625  17289   9635  -3766   2687    965       C
HETATM   30  C2D HEC D1001      14.546  10.022  13.991  1.00142.48           C
ANISOU   30  C2D HEC D1001    26834  17133  10168  -3850   2214   1270       C
HETATM   31  C3A HEC D1001      10.804  11.059   8.149  1.00136.41           C
ANISOU   31  C3A HEC D1001    25701  16075  10056  -3866   2591   1279       C
HETATM   32  C3B HEC D1001       7.744  14.781  11.826  1.00143.82           C
ANISOU   32  C3B HEC D1001    26706  17431  10509  -3780   2957    983       C
HETATM   33  C3C HEC D1001      11.528  13.271  16.400  1.00137.87           C
ANISOU   33  C3C HEC D1001    26282  16879   9224  -3777   2567   1011       C
HETATM   34  C3D HEC D1001      14.632   9.534  12.538  1.00144.35           C
ANISOU   34  C3D HEC D1001    27005  17250  10590  -3867   2201   1319       C
HETATM   35  C4A HEC D1001      10.358  11.714   9.366  1.00144.69           C
ANISOU   35  C4A HEC D1001    26789  17236  10949  -3849   2645   1224       C
HETATM   36  C4B HEC D1001       8.768  14.145  12.649  1.00137.78           C
ANISOU   36  C4B HEC D1001    26012  16687   9651  -3787   2848   1015       C
HETATM   37  C4C HEC D1001      11.920  12.537  15.214  1.00134.63           C
ANISOU   37  C4C HEC D1001    25826  16356   8971  -3798   2515   1081       C
HETATM   38  C4D HEC D1001      13.570  10.218  11.849  1.00138.72           C
ANISOU   38  C4D HEC D1001    26232  16533   9944  -3858   2317   1280       C
HETATM   39  CAA HEC D1001      12.769   9.532   7.451  1.00132.04           C
ANISOU   39  CAA HEC D1001    25171  15378   9621  -3893   2385   1376       C
HETATM   40  CAB HEC D1001       6.719  15.866  12.240  1.00138.71           C
ANISOU   40  CAB HEC D1001    26042  16858   9803  -3757   3079    901       C
HETATM   41  CAC HEC D1001      12.297  13.190  17.738  1.00135.76           C
ANISOU   41  CAC HEC D1001    26101  16686   8794  -3768   2488    993       C
HETATM   42  CAD HEC D1001      15.637   8.535  11.925  1.00138.75           C
ANISOU   42  CAD HEC D1001    26295  16445   9980  -3888   2089   1394       C
HETATM   43  CBA HEC D1001      11.998   8.251   7.139  1.00132.66           C
ANISOU   43  CBA HEC D1001    25237  15456   9711  -3938   2416   1524       C
HETATM   44  CBB HEC D1001       5.650  15.212  13.142  1.00135.28           C
ANISOU   44  CBB HEC D1001    25642  16531   9227  -3784   3158    997       C
HETATM   45  CBC HEC D1001      11.427  12.956  18.987  1.00146.99           C
ANISOU   45  CBC HEC D1001    27580  18242  10026  -3778   2561   1040       C
HETATM   46  CBD HEC D1001      14.919   7.222  11.642  1.00139.54           C
ANISOU   46  CBD HEC D1001    26386  16545  10089  -3933   2120   1549       C
HETATM   47  CGA HEC D1001      12.527   7.624   5.875  1.00128.84           C
ANISOU   47  CGA HEC D1001    24714  14851   9389  -3953   2359   1570       C
HETATM   48  CGD HEC D1001      15.891   6.207  11.098  1.00141.03           C
ANISOU   48  CGD HEC D1001    26575  16642  10368  -3955   2011   1625       C
HETATM   49  CHA HEC D1001      13.299  10.063  10.513  1.00146.02           C
ANISOU   49  CHA HEC D1001    27088  17363  11029  -3868   2342   1305       C
HETATM   50  CHB HEC D1001       9.227  12.490   9.500  1.00144.37           C
ANISOU   50  CHB HEC D1001    26723  17255  10876  -3837   2764   1179       C
HETATM   51  CHC HEC D1001       9.083  14.384  13.975  1.00144.74           C
ANISOU   51  CHC HEC D1001    26964  17660  10370  -3774   2826    976       C
HETATM   52  CHD HEC D1001      12.978  11.644  15.133  1.00137.25           C
ANISOU   52  CHD HEC D1001    26183  16634   9330  -3815   2394   1143       C
HETATM   53  CMA HEC D1001      10.090  11.136   6.782  1.00134.85           C
ANISOU   53  CMA HEC D1001    25424  15802  10009  -3872   2656   1294       C
HETATM   54  CMB HEC D1001       6.909  14.580   9.402  1.00138.00           C
ANISOU   54  CMB HEC D1001    25835  16541  10059  -3798   3022   1038       C
HETATM   55  CMC HEC D1001       9.714  15.017  17.030  1.00140.17           C
ANISOU   55  CMC HEC D1001    26549  17298   9410  -3741   2781    878       C
HETATM   56  CMD HEC D1001      15.472   9.587  15.143  1.00143.64           C
ANISOU   56  CMD HEC D1001    27061  17330  10186  -3851   2112   1287       C
HETATM   57  NA  HEC D1001      11.246  11.403  10.381  1.00142.02           N
ANISOU   57  NA  HEC D1001    26521  16938  10501  -3848   2558   1228       N
HETATM   58  NC  HEC D1001      11.031  12.874  14.214  1.00135.40           N
ANISOU   58  NC  HEC D1001    25852  16413   9183  -3799   2607   1074       N
HETATM   59  O1A HEC D1001      13.768   7.499   5.723  1.00127.91           O
ANISOU   59  O1A HEC D1001    24612  14669   9319  -3944   2254   1548       O
HETATM   60  O1D HEC D1001      15.705   5.000  11.405  1.00143.73           O
ANISOU   60  O1D HEC D1001    26943  17007  10662  -3991   1995   1754       O
HETATM   61  O2A HEC D1001      11.708   7.243   5.000  1.00126.20           O
ANISOU   61  O2A HEC D1001    24330  14482   9138  -3973   2418   1629       O
HETATM   62  O2D HEC D1001      16.850   6.595  10.375  1.00138.38           O
ANISOU   62  O2D HEC D1001    26214  16212  10153  -3936   1943   1558       O
HETATM   63 FE   HEC D1001      11.115  12.157  12.415  1.00158.39          Fe
ANISOU   63 FE   HEC D1001    28683  19178  12321  -3824   2585   1151      Fe
HETATM   64  HAB HEC D1001       6.266  16.109  11.430  1.00166.61           H
HETATM   65  HAC HEC D1001      13.016  12.556  17.688  1.00163.06           H
HETATM   66  HHA HEC D1001      13.931   9.523   9.993  1.00175.38           H
HETATM   67  HHB HEC D1001       8.617  12.507   8.733  1.00173.40           H
HETATM   68  HHC HEC D1001       8.518  15.025  14.454  1.00173.84           H
HETATM   69  HHD HEC D1001      13.462  11.479  15.969  1.00164.85           H
HETATM   70 HAA1 HEC D1001      13.619   9.309   7.860  1.00158.61           H
HETATM   71 HAA2 HEC D1001      12.922  10.028   6.632  1.00158.61           H
HETATM   72 HAD1 HEC D1001      16.364   8.380  12.549  1.00166.66           H
HETATM   73 HAD2 HEC D1001      15.991   8.897  11.097  1.00166.66           H
HETATM   74 HBA1 HEC D1001      11.058   8.462   7.024  1.00159.35           H
HETATM   75 HBA2 HEC D1001      12.100   7.627   7.874  1.00159.35           H
HETATM   76 HBB1 HEC D1001       5.203  14.504  12.651  1.00162.49           H
HETATM   77 HBB2 HEC D1001       5.000  15.880  13.409  1.00162.49           H
HETATM   78 HBB3 HEC D1001       6.076  14.841  13.930  1.00162.49           H
HETATM   79 HBC1 HEC D1001      11.697  12.130  19.419  1.00176.54           H
HETATM   80 HBC2 HEC D1001      10.495  12.894  18.725  1.00176.54           H
HETATM   81 HBC3 HEC D1001      11.541  13.696  19.603  1.00176.54           H
HETATM   82 HBD1 HEC D1001      14.216   7.374  10.991  1.00167.61           H
HETATM   83 HBD2 HEC D1001      14.529   6.885  12.463  1.00167.61           H
HETATM   84 HMA1 HEC D1001       9.181  10.779   6.867  1.00161.97           H
HETATM   85 HMA2 HEC D1001      10.588  10.607   6.123  1.00161.97           H
HETATM   86 HMA3 HEC D1001      10.048  12.069   6.487  1.00161.97           H
HETATM   87 HMB1 HEC D1001       7.003  15.525   9.208  1.00165.76           H
HETATM   88 HMB2 HEC D1001       5.981  14.382   9.604  1.00165.76           H
HETATM   89 HMB3 HEC D1001       7.190  14.061   8.632  1.00165.76           H
HETATM   90 HMC1 HEC D1001       9.327  14.535  17.777  1.00168.36           H
HETATM   91 HMC2 HEC D1001       9.010  15.463  16.534  1.00168.36           H
HETATM   92 HMC3 HEC D1001      10.343  15.677  17.362  1.00168.36           H
HETATM   93 HMD1 HEC D1001      16.399   9.817  14.922  1.00172.53           H
HETATM   94 HMD2 HEC D1001      15.399   8.618  15.274  1.00172.53           H
HETATM   95 HMD3 HEC D1001      15.209  10.048  15.966  1.00172.53           H
TER
END
  """

  edits = """
geometry_restraints.edits {
  bond {
    atom_selection_1 = chain D and resseq 40 and name SG
    atom_selection_2 = chain D and resseq 1001 and name CAC
    distance_ideal = 1.81
    sigma = 0.05
  }
  bond {
    atom_selection_1 = chain D and resseq 37 and name SG
    atom_selection_2 = chain D and resseq 1001 and name CAB
    distance_ideal = 1.81
    sigma = 0.05
  }
  angle {
    atom_selection_1 = chain D and resseq 40 and name SG
    atom_selection_2 = chain D and resseq 1001 and name CAC
    atom_selection_3 = chain D and resseq 1001 and name CBC
    angle_ideal = 109
    sigma = 2
  }
  angle {
    atom_selection_1 = chain D and resseq 40 and name SG
    atom_selection_2 = chain D and resseq 1001 and name CAC
    atom_selection_3 = chain D and resseq 1001 and name C3C
    angle_ideal = 109
    sigma = 2
  }
  angle {
    atom_selection_1 = chain D and resseq 37 and name SG
    atom_selection_2 = chain D and resseq 1001 and name CAB
    atom_selection_3 = chain D and resseq 1001 and name CBB
    angle_ideal = 109
    sigma = 2
  }
  angle {
    atom_selection_1 = chain D and resseq 1001 and name HAB
    atom_selection_2 = chain D and resseq 1001 and name CAB
    atom_selection_3 = chain D and resseq 37 and name SG
    angle_ideal = 109
    sigma = 1.1
  }
  angle {
    atom_selection_1 = chain D and resseq 1001 and name HAC
    atom_selection_2 = chain D and resseq 1001 and name CAC
    atom_selection_3 = chain D and resseq 40 and name SG
    angle_ideal = 109
    sigma = 1.1
  }
}
  """

  gm_phil = iotbx.phil.parse(
      input_string     = grand_master_phil_str,
      process_includes = True)
  edits_phil = iotbx.phil.parse(edits)
  working_phil = gm_phil.fetch(edits_phil)
  params = working_phil.extract()

  # Make sure the angle edit is present
  assert (params.geometry_restraints.edits.angle[3].atom_selection_1 == \
    "chain D and resseq 1001 and name HAB")

  pdb_inp = iotbx.pdb.input(lines=pdb_str.split("\n"), source_info=None)

  model = mmtbx.model.manager(
    model_input = pdb_inp,
    log         = null_out())
  model.process(pdb_interpretation_params=params,
    make_restraints=True)
  pdb_hierarchy = model.get_hierarchy()
  sites_cart = model.get_sites_cart()
  atoms = pdb_hierarchy.atoms()

  model.setup_riding_h_manager()
  riding_h_manager = model.get_riding_h_manager()

  h_para = riding_h_manager.h_parameterization

  diagnostics = riding_h_manager.diagnostics(
    sites_cart = sites_cart,
    threshold  = 0.05)
  h_distances   = diagnostics.h_distances
  type_list     = diagnostics.type_list

  number_h = model.get_hd_selection().count(True)
  number_h_para = len(h_para) - h_para.count(None)

  for rc in h_para:
    if rc:
      assert(rc.ih != 61), 'Wrong atom not recognized.'

# Test if number of paramterized H atoms is correct
  assert (number_h == number_h_para + 1), 'Not all H atoms are parameterized'

  type_list_known = ['3neigbs', '2tetra', '2tetra', '3neigbs',
    '2tetra', '2tetra', '3neigbs', 'flat_2neigbs', 'flat_2neigbs',
    'flat_2neigbs', 'flat_2neigbs', '2tetra', '2tetra', '2tetra', '2tetra',
    '2tetra', '2tetra', 'prop', 'prop', 'prop', 'prop', 'prop', 'prop',
    '2tetra', '2tetra', 'prop', 'prop', 'prop', 'prop', 'prop', 'prop',
    'prop', 'prop', 'prop', 'prop', 'prop', 'prop']

  for ih in h_distances:
    # One H atom is expected to be far (HAC)
    if (ih == 62):
      continue
    labels = atoms[ih].fetch_labels()
    if (h_distances[ih] > 0.1):
      assert (h_distances[ih] < 0.1), \
        'distance too large: %s  atom: %s (%s) residue: %s ' \
        % (h_para[ih].htype, atoms[ih].name, ih, labels.resseq.strip())
#
  for type1, type2 in zip(type_list, type_list_known):
    assert (type1 == type2)
    #print "'%s'," % type1,

def exercise2():
  pdb_str = """
CRYST1   16.660   12.742   18.240  90.00  90.00  90.00 P 1
SCALE1      0.060024  0.000000  0.000000        0.00000
SCALE2      0.000000  0.078481  0.000000        0.00000
SCALE3      0.000000  0.000000  0.054825        0.00000
ATOM      1  N   TYR A   7       9.837   5.000   6.625  1.00 15.00           N
ATOM      2  CA  TYR A   7      10.084   6.426   6.798  1.00 15.00           C
ATOM      3  C   TYR A   7      11.431   6.813   6.197  1.00 15.00           C
ATOM      4  O   TYR A   7      11.660   6.642   5.000  1.00 15.00           O
ATOM      5  CB  TYR A   7      10.042   6.803   8.281  1.00 15.00           C
ATOM      6  CG  TYR A   7       8.697   6.593   8.948  1.00 15.00           C
ATOM      7  CD1 TYR A   7       7.540   6.413   8.198  1.00 15.00           C
ATOM      8  CD2 TYR A   7       8.586   6.575  10.332  1.00 15.00           C
ATOM      9  CE1 TYR A   7       6.315   6.222   8.807  1.00 15.00           C
ATOM     10  CE2 TYR A   7       7.364   6.384  10.950  1.00 15.00           C
ATOM     11  CZ  TYR A   7       6.233   6.208  10.183  1.00 15.00           C
ATOM     12  OH  TYR A   7       5.015   6.018  10.794  1.00 15.00           O
ATOM     13  HA  TYR A   7       9.398   6.930   6.331  1.00 15.00           H
ATOM     14  HB2 TYR A   7      10.693   6.264   8.757  1.00 15.00           H
ATOM     15  HB3 TYR A   7      10.270   7.742   8.369  1.00 15.00           H
ATOM     16  HD1 TYR A   7       7.589   6.422   7.269  1.00 15.00           H
ATOM     17  HD2 TYR A   7       9.347   6.694  10.853  1.00 15.00           H
ATOM     18  HE1 TYR A   7       5.550   6.103   8.292  1.00 15.00           H
ATOM     19  HE2 TYR A   7       7.306   6.375  11.878  1.00 15.00           H
ATOM     20  HH  TYR A   7       5.000   6.415  11.534  1.00 15.00           H
TER
HETATM   21  O   HOH B   1       5.307   7.545  13.240  1.00 30.00           O
TER
END
  """

  edits = """
geometry_restraints.edits {
  bond {
    atom_selection_1 = chain A and resseq 7 and name HH
    atom_selection_2 = chain B and resseq 1 and name O
    distance_ideal = 1.81
    sigma = 0.05
  }
}
  """

  type_list_known = ['3neigbs', '2tetra', '2tetra', 'flat_2neigbs',
    'flat_2neigbs', 'flat_2neigbs', 'flat_2neigbs', 'alg1b']


  gm_phil = iotbx.phil.parse(
      input_string     = grand_master_phil_str,
      process_includes = True)
  edits_phil = iotbx.phil.parse(edits)
  working_phil = gm_phil.fetch(edits_phil)
  params = working_phil.extract()

  # Make sure the angle edit is present
  assert (params.geometry_restraints.edits.bond[0].atom_selection_1 == \
    "chain A and resseq 7 and name HH")

  pdb_inp = iotbx.pdb.input(lines=pdb_str.split("\n"), source_info=None)

  model = mmtbx.model.manager(
    model_input = pdb_inp,
    log         = null_out())
  model.process(pdb_interpretation_params=params,
    make_restraints=True)
  pdb_hierarchy = model.get_hierarchy()
  sites_cart = model.get_sites_cart()
  atoms = pdb_hierarchy.atoms()

  model.setup_riding_h_manager()
  riding_h_manager = model.get_riding_h_manager()

  h_para = riding_h_manager.h_parameterization

  diagnostics = riding_h_manager.diagnostics(
    sites_cart = sites_cart,
    threshold  = 0.05)
  h_distances   = diagnostics.h_distances
  type_list     = diagnostics.type_list

  number_h = model.get_hd_selection().count(True)
  number_h_para = len(h_para) - h_para.count(None)

  connectivity_manager = connectivity.determine_connectivity(
    pdb_hierarchy       = pdb_hierarchy,
    geometry_restraints = model.get_restraints_manager().geometry)
  double_H = connectivity_manager.double_H

# Test if number of paramterized H atoms is correct
  assert (number_h == number_h_para), 'Not all H atoms are parameterized'
  assert (double_H[19] == [11, 20]), 'H bound to two atoms wrongly recognized'
  assert (number_h_para == 8), 'Not all H atoms are parameterized'

  for ih in h_distances:
   labels = atoms[ih].fetch_labels()
   if (h_distances[ih] > 0.1):
     assert (h_distances[ih] < 0.1), \
       'distance too large: %s  atom: %s (%s) residue: %s ' \
       % (h_para[ih].htype, atoms[ih].name, ih, labels.resseq.strip())

  for type1, type2 in zip(type_list, type_list_known):
    assert (type1 == type2)

if (__name__ == "__main__"):
  t0 = time.time()
  exercise1()
  exercise2()
  print("OK. Time: %8.3f"%(time.time()-t0))


 *******************************************************************************


 *******************************************************************************
mmtbx/hydrogens/tst_parameterization_9.py
from __future__ import absolute_import, division, print_function
import time, sys, os
from six.moves import cStringIO as StringIO
import libtbx.load_env
import mmtbx.model
import iotbx.pdb
from mmtbx.monomer_library import pdb_interpretation
from cctbx.array_family import flex


def run():
  verbose = "--verbose" in sys.argv[1:]
  exercise_00(verbose=verbose)
  exercise_01(verbose=verbose)
  exercise_02(verbose=verbose)
  exercise_03(verbose=verbose)

def get_model(file_name, log, pdb_str=None, make_restraints=True):
  pdb_interpretation_params = iotbx.phil.parse(
          input_string=pdb_interpretation.grand_master_phil_str, process_includes=True).extract()
  pdb_interpretation_params.pdb_interpretation.sort_atoms=False
  if not pdb_str:
    pdb_inp = iotbx.pdb.input(file_name=file_name)
  else:
    pdb_inp = iotbx.pdb.input(lines=pdb_str, source_info=None)
  model = mmtbx.model.manager(
      model_input = pdb_inp,
      stop_for_unknowns = False,
      log=log)
  model.process(pdb_interpretation_params=pdb_interpretation_params,
                make_restraints = make_restraints)
  return model


def setup_riding(model):
  model.setup_riding_h_manager(ignore_h_with_dof = True)
  riding_h_manager = model.get_riding_h_manager()
  h_para = riding_h_manager.h_parameterization
  sel_h = model.get_hd_selection()
  sel_h_in_para = flex.bool(
    [bool(x) for x in riding_h_manager.h_parameterization])
  sel_h_not_in_para = sel_h_in_para.exclusive_or(sel_h)
  return(list(sel_h_not_in_para.iselection()))


def exercise_00(verbose):
  if (verbose): log = sys.stdout
  else: log = StringIO()
  model = get_model(file_name = None,
                    log       = log,
                    pdb_str   = pdb_str_1)
  rotatable_hd_sel = model.rotatable_hd_selection(use_shortcut = True)
  list_sel_h_not_in_para = setup_riding(model = model)
  s1 = set(list(rotatable_hd_sel))
  s2 = set(list_sel_h_not_in_para)
  assert(s1 == s2)
  ph = model.get_hierarchy()
  atoms = ph.atoms()


def exercise_01(verbose):
  if (verbose): log = sys.stdout
  else: log = StringIO()
  pdb_file = libtbx.env.find_in_repositories(
    relative_path="phenix_regression/pdb/ala_hd.pdb",
    test=os.path.isfile)
  model = get_model(pdb_file, log)
  # gives wrong result here: ignores D1,D2,D3
  #rotatable_hd_sel = model.rotatable_hd_selection(use_shortcut = True)
  list_sel_h_not_in_para = setup_riding(model = model)
  s1 = set([5, 6, 7, 9, 10, 11, 12, 13, 14])
  s2 = set(list_sel_h_not_in_para)
  assert(s1 == s2)


def exercise_02(verbose):
  if (verbose): log = sys.stdout
  else: log = StringIO()
  pdb_file = libtbx.env.find_in_repositories(
    relative_path="phenix_regression/pdb/ala_lys_arg_ser_tyr_neutron_hd.pdb",
    test=os.path.isfile)
  model = get_model(pdb_file, log)
  # here rotatable has 6,7,8 twice in the selection???
  rotatable_hd_sel = model.rotatable_hd_selection(use_shortcut = True)
  list_sel_h_not_in_para = setup_riding(model = model)
  s1 = set(list(rotatable_hd_sel))
  s2 = set(list_sel_h_not_in_para)
  assert(s1 == s2)


def exercise_03(verbose):
  """
  Check incomplete propellers in H/D exchanged sites
  """
  if (verbose): log = sys.stdout
  else: log = StringIO()
  model = get_model(file_name = None,
                    log       = log,
                    pdb_str   = pdb_str_2)
  rotatable_hd_sel = model.rotatable_hd_selection(use_shortcut = True)
  list_sel_h_not_in_para = setup_riding(model = model)
  #s1 = set(list(rotatable_hd_sel))
  s1 = set([12, 13, 14, 15, 18, 19, 20, 21, 31, 34, 41, 51])
  s2 = set(list_sel_h_not_in_para)
  #print(list(rotatable_hd_sel))
  #print(list_sel_h_not_in_para)
  assert(s1 == s2)
  ph = model.get_hierarchy()
  atoms = ph.atoms()

  #ph = model.get_hierarchy()
  #atoms = ph.atoms()
  #for bla in list_sel_h_not_in_para:
  #  print(atoms[bla].id_str())


# Ideal amino acids
pdb_str_1 = """\
CRYST1   30.000   30.000   30.000  90.00  90.00  90.00 P 1
SCALE1      0.033333  0.000000  0.000000        0.00000
SCALE2      0.000000  0.033333  0.000000        0.00000
SCALE3      0.000000  0.000000  0.033333        0.00000
ATOM      1  N   ARG A   2       3.050  19.481  25.856  1.00  0.00           N
ATOM      2  CA  ARG A   2       3.759  20.265  24.852  1.00  0.00           C
ATOM      3  C   ARG A   2       5.253  20.304  25.155  1.00  0.00           C
ATOM      4  O   ARG A   2       5.659  20.516  26.298  1.00  0.00           O
ATOM      5  CB  ARG A   2       3.197  21.687  24.787  1.00  0.00           C
ATOM      6  CG  ARG A   2       3.800  22.542  23.684  1.00  0.00           C
ATOM      7  CD  ARG A   2       3.128  23.904  23.607  1.00  0.00           C
ATOM      8  NE  ARG A   2       3.721  24.751  22.576  1.00  0.00           N
ATOM      9  CZ  ARG A   2       3.311  25.983  22.290  1.00  0.00           C
ATOM     10  NH1 ARG A   2       2.301  26.525  22.957  1.00  0.00           N1+
ATOM     11  NH2 ARG A   2       3.914  26.676  21.334  1.00  0.00           N
ATOM     12  HA  ARG A   2       3.638  19.852  23.983  1.00  0.00           H
ATOM     13  HB2 ARG A   2       2.240  21.637  24.633  1.00  0.00           H
ATOM     14  HB3 ARG A   2       3.370  22.129  25.633  1.00  0.00           H
ATOM     15  HG2 ARG A   2       4.743  22.680  23.864  1.00  0.00           H
ATOM     16  HG3 ARG A   2       3.682  22.096  22.831  1.00  0.00           H
ATOM     17  HD2 ARG A   2       2.189  23.783  23.396  1.00  0.00           H
ATOM     18  HD3 ARG A   2       3.224  24.355  24.460  1.00  0.00           H
ATOM     19  HE  ARG A   2       4.380  24.432  22.124  1.00  0.00           H
ATOM     20 HH11 ARG A   2       1.905  26.082  23.579  1.00  0.00           H
ATOM     21 HH12 ARG A   2       2.041  27.322  22.767  1.00  0.00           H
ATOM     22 HH21 ARG A   2       4.569  26.329  20.898  1.00  0.00           H
ATOM     23 HH22 ARG A   2       3.649  27.473  21.149  1.00  0.00           H
ATOM     24  N   HIS A   3       6.067  20.098  24.123  1.00  0.00           N
ATOM     25  CA  HIS A   3       7.516  20.107  24.260  1.00  0.00           C
ATOM     26  C   HIS A   3       8.133  20.732  23.018  1.00  0.00           C
ATOM     27  O   HIS A   3       7.638  20.536  21.904  1.00  0.00           O
ATOM     28  CB  HIS A   3       8.069  18.691  24.464  1.00  0.00           C
ATOM     29  CG  HIS A   3       7.630  18.050  25.743  1.00  0.00           C
ATOM     30  ND1 HIS A   3       8.154  18.399  26.969  1.00  0.00           N
ATOM     31  CD2 HIS A   3       6.716  17.080  25.988  1.00  0.00           C
ATOM     32  CE1 HIS A   3       7.582  17.674  27.913  1.00  0.00           C
ATOM     33  NE2 HIS A   3       6.706  16.865  27.344  1.00  0.00           N
ATOM     34  H   HIS A   3       5.797  19.948  23.320  1.00  0.00           H
ATOM     35  HA  HIS A   3       7.764  20.646  25.027  1.00  0.00           H
ATOM     36  HB2 HIS A   3       7.768  18.129  23.732  1.00  0.00           H
ATOM     37  HB3 HIS A   3       9.038  18.731  24.470  1.00  0.00           H
ATOM     38  HD2 HIS A   3       6.194  16.642  25.355  1.00  0.00           H
ATOM     39  HE1 HIS A   3       7.765  17.723  28.824  1.00  0.00           H
ATOM     40  N   LYS A   4       9.213  21.483  23.217  1.00  0.00           N
ATOM     41  CA  LYS A   4       9.902  22.139  22.116  1.00  0.00           C
ATOM     42  C   LYS A   4      11.340  22.409  22.530  1.00  0.00           C
ATOM     43  O   LYS A   4      11.602  22.774  23.678  1.00  0.00           O
ATOM     44  CB  LYS A   4       9.205  23.447  21.722  1.00  0.00           C
ATOM     45  CG  LYS A   4       9.799  24.121  20.495  1.00  0.00           C
ATOM     46  CD  LYS A   4       9.008  25.357  20.102  1.00  0.00           C
ATOM     47  CE  LYS A   4       9.606  26.035  18.880  1.00  0.00           C
ATOM     48  NZ  LYS A   4       8.842  27.250  18.484  1.00  0.00           N1+
ATOM     49  H   LYS A   4       9.568  21.628  23.987  1.00  0.00           H
ATOM     50  HA  LYS A   4       9.909  21.551  21.344  1.00  0.00           H
ATOM     51  HB2 LYS A   4       8.272  23.258  21.533  1.00  0.00           H
ATOM     52  HB3 LYS A   4       9.270  24.070  22.462  1.00  0.00           H
ATOM     53  HG2 LYS A   4      10.710  24.392  20.688  1.00  0.00           H
ATOM     54  HG3 LYS A   4       9.784  23.500  19.750  1.00  0.00           H
ATOM     55  HD2 LYS A   4       8.096  25.101  19.892  1.00  0.00           H
ATOM     56  HD3 LYS A   4       9.018  25.991  20.837  1.00  0.00           H
ATOM     57  HE2 LYS A   4      10.517  26.302  19.078  1.00  0.00           H
ATOM     58  HE3 LYS A   4       9.594  25.415  18.135  1.00  0.00           H
ATOM     59  HZ1 LYS A   4       9.215  27.624  17.768  1.00  0.00           H
ATOM     60  HZ2 LYS A   4       8.001  27.031  18.292  1.00  0.00           H
ATOM     61  HZ3 LYS A   4       8.842  27.840  19.151  1.00  0.00           H
ATOM     62  N   ASP A   5      12.263  22.226  21.588  1.00  0.00           N
ATOM     63  CA  ASP A   5      13.678  22.447  21.845  1.00  0.00           C
ATOM     64  C   ASP A   5      14.374  22.763  20.531  1.00  0.00           C
ATOM     65  O   ASP A   5      14.035  22.197  19.489  1.00  0.00           O
ATOM     66  CB  ASP A   5      14.324  21.224  22.508  1.00  0.00           C
ATOM     67  CG  ASP A   5      15.729  21.504  23.005  1.00  0.00           C
ATOM     68  OD1 ASP A   5      16.213  22.640  22.819  1.00  0.00           O
ATOM     69  OD2 ASP A   5      16.350  20.587  23.582  1.00  0.00           O1-
ATOM     70  H   ASP A   5      12.091  21.972  20.785  1.00  0.00           H
ATOM     71  HA  ASP A   5      13.783  23.208  22.438  1.00  0.00           H
ATOM     72  HB2 ASP A   5      13.785  20.954  23.267  1.00  0.00           H
ATOM     73  HB3 ASP A   5      14.372  20.503  21.861  1.00  0.00           H
ATOM     74  N   GLU A   6      15.346  23.668  20.589  1.00  0.00           N
ATOM     75  CA  GLU A   6      16.096  24.064  19.403  1.00  0.00           C
ATOM     76  C   GLU A   6      17.433  24.684  19.794  1.00  0.00           C
ATOM     77  O   GLU A   6      17.829  24.647  20.959  1.00  0.00           O
ATOM     78  CB  GLU A   6      15.283  25.051  18.561  1.00  0.00           C
ATOM     79  CG  GLU A   6      15.942  25.433  17.245  1.00  0.00           C
ATOM     80  CD  GLU A   6      15.076  26.352  16.405  1.00  0.00           C
ATOM     81  OE1 GLU A   6      13.969  26.708  16.861  1.00  0.00           O
ATOM     82  OE2 GLU A   6      15.503  26.718  15.290  1.00  0.00           O1-
ATOM     83  H   GLU A   6      15.592  24.070  21.309  1.00  0.00           H
ATOM     84  HA  GLU A   6      16.273  23.279  18.862  1.00  0.00           H
ATOM     85  HB2 GLU A   6      14.424  24.651  18.356  1.00  0.00           H
ATOM     86  HB3 GLU A   6      15.153  25.864  19.073  1.00  0.00           H
ATOM     87  HG2 GLU A   6      16.776  25.893  17.428  1.00  0.00           H
ATOM     88  HG3 GLU A   6      16.112  24.628  16.730  1.00  0.00           H
TER
ATOM     89  N   SER B   2      10.846   4.462  24.534  1.00  0.00           N
ATOM     90  CA  SER B   2      11.518   5.747  24.391  1.00  0.00           C
ATOM     91  C   SER B   2      13.032   5.575  24.457  1.00  0.00           C
ATOM     92  O   SER B   2      13.532   4.595  25.009  1.00  0.00           O
ATOM     93  CB  SER B   2      11.052   6.719  25.477  1.00  0.00           C
ATOM     94  OG  SER B   2      11.455   6.279  26.762  1.00  0.00           O
ATOM     95  HA  SER B   2      11.295   6.129  23.528  1.00  0.00           H
ATOM     96  HB2 SER B   2      11.440   7.591  25.307  1.00  0.00           H
ATOM     97  HB3 SER B   2      10.084   6.777  25.453  1.00  0.00           H
ATOM     98  HG  SER B   2      11.125   5.523  26.924  1.00  0.00           H
ATOM     99  N   THR B   3      13.758   6.536  23.889  1.00  0.00           N
ATOM    100  CA  THR B   3      15.212   6.498  23.880  1.00  0.00           C
ATOM    101  C   THR B   3      15.741   7.920  23.778  1.00  0.00           C
ATOM    102  O   THR B   3      15.212   8.733  23.015  1.00  0.00           O
ATOM    103  CB  THR B   3      15.746   5.652  22.717  1.00  0.00           C
ATOM    104  OG1 THR B   3      15.230   4.319  22.813  1.00  0.00           O
ATOM    105  CG2 THR B   3      17.268   5.606  22.740  1.00  0.00           C
ATOM    106  H   THR B   3      13.425   7.226  23.499  1.00  0.00           H
ATOM    107  HA  THR B   3      15.530   6.111  24.711  1.00  0.00           H
ATOM    108  HB  THR B   3      15.465   6.046  21.876  1.00  0.00           H
ATOM    109  HG1 THR B   3      15.519   3.852  22.178  1.00  0.00           H
ATOM    110 HG21 THR B   3      17.587   4.933  22.118  1.00  0.00           H
ATOM    111 HG22 THR B   3      17.633   6.467  22.484  1.00  0.00           H
ATOM    112 HG23 THR B   3      17.580   5.381  23.631  1.00  0.00           H
ATOM    113  N   ASN B   4      16.785   8.212  24.552  1.00  0.00           N
ATOM    114  CA  ASN B   4      17.402   9.533  24.564  1.00  0.00           C
ATOM    115  C   ASN B   4      18.904   9.364  24.725  1.00  0.00           C
ATOM    116  O   ASN B   4      19.359   8.747  25.692  1.00  0.00           O
ATOM    117  CB  ASN B   4      16.835  10.400  25.693  1.00  0.00           C
ATOM    118  CG  ASN B   4      15.357  10.690  25.518  1.00  0.00           C
ATOM    119  OD1 ASN B   4      14.528  10.254  26.317  1.00  0.00           O
ATOM    120  ND2 ASN B   4      15.019  11.430  24.468  1.00  0.00           N
ATOM    121  H   ASN B   4      17.158   7.651  25.086  1.00  0.00           H
ATOM    122  HA  ASN B   4      17.232   9.979  23.719  1.00  0.00           H
ATOM    123  HB2 ASN B   4      16.953   9.937  26.537  1.00  0.00           H
ATOM    124  HB3 ASN B   4      17.307  11.247  25.709  1.00  0.00           H
ATOM    125 HD21 ASN B   4      14.193  11.622  24.326  1.00  0.00           H
ATOM    126 HD22 ASN B   4      15.626  11.717  23.931  1.00  0.00           H
ATOM    127  N   GLN B   5      19.666   9.908  23.781  1.00  0.00           N
ATOM    128  CA  GLN B   5      21.121   9.817  23.821  1.00  0.00           C
ATOM    129  C   GLN B   5      21.756  11.122  23.352  1.00  0.00           C
ATOM    130  O   GLN B   5      21.299  11.734  22.387  1.00  0.00           O
ATOM    131  CB  GLN B   5      21.610   8.654  22.957  1.00  0.00           C
ATOM    132  CG  GLN B   5      21.217   7.283  23.483  1.00  0.00           C
ATOM    133  CD  GLN B   5      21.709   6.155  22.598  1.00  0.00           C
ATOM    134  OE1 GLN B   5      22.296   6.391  21.542  1.00  0.00           O
ATOM    135  NE2 GLN B   5      21.472   4.920  23.025  1.00  0.00           N
ATOM    136  H   GLN B   5      19.362  10.339  23.102  1.00  0.00           H
ATOM    137  HA  GLN B   5      21.406   9.656  24.734  1.00  0.00           H
ATOM    138  HB2 GLN B   5      21.235   8.747  22.067  1.00  0.00           H
ATOM    139  HB3 GLN B   5      22.578   8.686  22.909  1.00  0.00           H
ATOM    140  HG2 GLN B   5      21.600   7.161  24.366  1.00  0.00           H
ATOM    141  HG3 GLN B   5      20.250   7.227  23.530  1.00  0.00           H
ATOM    142 HE21 GLN B   5      21.732   4.246  22.559  1.00  0.00           H
ATOM    143 HE22 GLN B   5      21.059   4.795  23.769  1.00  0.00           H
TER
ATOM    144  N   CYS C   2      14.789  22.141   7.021  1.00  0.00           N
ATOM    145  CA  CYS C   2      15.170  23.547   7.063  1.00  0.00           C
ATOM    146  C   CYS C   2      16.660  23.696   7.350  1.00  0.00           C
ATOM    147  O   CYS C   2      17.074  23.780   8.506  1.00  0.00           O
ATOM    148  CB  CYS C   2      14.354  24.292   8.122  1.00  0.00           C
ATOM    149  SG  CYS C   2      14.698  26.064   8.213  1.00  0.00           S
ATOM    150  HA  CYS C   2      14.987  23.952   6.201  1.00  0.00           H
ATOM    151  HB2 CYS C   2      13.411  24.185   7.920  1.00  0.00           H
ATOM    152  HB3 CYS C   2      14.548  23.908   8.991  1.00  0.00           H
ATOM    153  HG  CYS C   2      14.012  26.553   9.067  1.00  0.00           H
ATOM    154  N   GLY C   3      17.463  23.727   6.287  1.00  0.00           N
ATOM    155  CA  GLY C   3      18.892  23.864   6.428  1.00  0.00           C
ATOM    156  C   GLY C   3      19.301  25.288   6.737  1.00  0.00           C
ATOM    157  O   GLY C   3      18.476  26.206   6.840  1.00  0.00           O
ATOM    158  H   GLY C   3      17.194  23.670   5.472  1.00  0.00           H
ATOM    159  HA2 GLY C   3      19.202  23.291   7.146  1.00  0.00           H
ATOM    160  HA3 GLY C   3      19.325  23.590   5.604  1.00  0.00           H
ATOM    161  N   PRO C   4      20.618  25.490   6.891  1.00  0.00           N
ATOM    162  CA  PRO C   4      21.173  26.813   7.198  1.00  0.00           C
ATOM    163  C   PRO C   4      21.113  27.768   6.010  1.00  0.00           C
ATOM    164  O   PRO C   4      21.345  27.333   4.882  1.00  0.00           O
ATOM    165  CB  PRO C   4      22.622  26.503   7.578  1.00  0.00           C
ATOM    166  CG  PRO C   4      22.943  25.252   6.843  1.00  0.00           C
ATOM    167  CD  PRO C   4      21.667  24.460   6.790  1.00  0.00           C
ATOM    168  HA  PRO C   4      20.715  27.207   7.957  1.00  0.00           H
ATOM    169  HB2 PRO C   4      23.199  27.228   7.291  1.00  0.00           H
ATOM    170  HB3 PRO C   4      22.689  26.366   8.536  1.00  0.00           H
ATOM    171  HG2 PRO C   4      23.244  25.471   5.947  1.00  0.00           H
ATOM    172  HG3 PRO C   4      23.628  24.761   7.322  1.00  0.00           H
ATOM    173  HD2 PRO C   4      21.599  23.988   5.945  1.00  0.00           H
ATOM    174  HD3 PRO C   4      21.617  23.851   7.543  1.00  0.00           H
TER
ATOM    175  N   ALA D   2       2.619   6.211   7.571  1.00  0.00           N
ATOM    176  CA  ALA D   2       3.623   7.047   8.219  1.00  0.00           C
ATOM    177  C   ALA D   2       4.961   6.321   8.294  1.00  0.00           C
ATOM    178  O   ALA D   2       5.056   5.233   8.863  1.00  0.00           O
ATOM    179  CB  ALA D   2       3.159   7.450   9.610  1.00  0.00           C
ATOM    180  HA  ALA D   2       3.748   7.855   7.697  1.00  0.00           H
ATOM    181  HB1 ALA D   2       3.840   8.005  10.021  1.00  0.00           H
ATOM    182  HB2 ALA D   2       2.329   7.947   9.534  1.00  0.00           H
ATOM    183  HB3 ALA D   2       3.018   6.650  10.139  1.00  0.00           H
ATOM    184  N   LEU D   3       6.002   6.934   7.712  1.00  0.00           N
ATOM    185  CA  LEU D   3       7.348   6.371   7.695  1.00  0.00           C
ATOM    186  C   LEU D   3       8.344   7.510   7.935  1.00  0.00           C
ATOM    187  O   LEU D   3       9.150   7.868   7.078  1.00  0.00           O
ATOM    188  CB  LEU D   3       7.634   5.644   6.379  1.00  0.00           C
ATOM    189  CG  LEU D   3       6.792   4.396   6.105  1.00  0.00           C
ATOM    190  CD1 LEU D   3       7.036   3.888   4.692  1.00  0.00           C
ATOM    191  CD2 LEU D   3       7.088   3.307   7.125  1.00  0.00           C
ATOM    192  H   LEU D   3       5.945   7.694   7.313  1.00  0.00           H
ATOM    193  HA  LEU D   3       7.438   5.734   8.421  1.00  0.00           H
ATOM    194  HB2 LEU D   3       7.479   6.264   5.649  1.00  0.00           H
ATOM    195  HB3 LEU D   3       8.565   5.371   6.377  1.00  0.00           H
ATOM    196  HG  LEU D   3       5.853   4.628   6.180  1.00  0.00           H
ATOM    197 HD11 LEU D   3       6.493   3.099   4.543  1.00  0.00           H
ATOM    198 HD12 LEU D   3       6.791   4.583   4.061  1.00  0.00           H
ATOM    199 HD13 LEU D   3       7.975   3.668   4.594  1.00  0.00           H
ATOM    200 HD21 LEU D   3       6.619   2.498   6.867  1.00  0.00           H
ATOM    201 HD22 LEU D   3       8.044   3.144   7.143  1.00  0.00           H
ATOM    202 HD23 LEU D   3       6.785   3.600   7.998  1.00  0.00           H
ATOM    203  N   ILE D   4       8.286   8.091   9.130  1.00  0.00           N
ATOM    204  CA  ILE D   4       9.174   9.189   9.499  1.00  0.00           C
ATOM    205  C   ILE D   4      10.531   8.595   9.863  1.00  0.00           C
ATOM    206  O   ILE D   4      10.691   7.990  10.926  1.00  0.00           O
ATOM    207  CB  ILE D   4       8.599  10.013  10.657  1.00  0.00           C
ATOM    208  CG1 ILE D   4       7.284  10.674  10.236  1.00  0.00           C
ATOM    209  CG2 ILE D   4       9.604  11.067  11.108  1.00  0.00           C
ATOM    210  CD1 ILE D   4       6.474  11.224  11.392  1.00  0.00           C
ATOM    211  H   ILE D   4       7.736   7.865   9.751  1.00  0.00           H
ATOM    212  HA  ILE D   4       9.293   9.777   8.736  1.00  0.00           H
ATOM    213  HB  ILE D   4       8.421   9.417  11.401  1.00  0.00           H
ATOM    214 HG12 ILE D   4       7.482  11.410   9.637  1.00  0.00           H
ATOM    215 HG13 ILE D   4       6.734  10.018   9.778  1.00  0.00           H
ATOM    216 HG21 ILE D   4       9.158  11.702  11.690  1.00  0.00           H
ATOM    217 HG22 ILE D   4      10.326  10.633  11.590  1.00  0.00           H
ATOM    218 HG23 ILE D   4       9.953  11.525  10.328  1.00  0.00           H
ATOM    219 HD11 ILE D   4       5.603  11.498  11.065  1.00  0.00           H
ATOM    220 HD12 ILE D   4       6.373  10.531  12.063  1.00  0.00           H
ATOM    221 HD13 ILE D   4       6.939  11.986  11.771  1.00  0.00           H
ATOM    222  N   MET D   5      11.514   8.768   8.978  1.00  0.00           N
ATOM    223  CA  MET D   5      12.863   8.258   9.192  1.00  0.00           C
ATOM    224  C   MET D   5      13.872   9.277   8.657  1.00  0.00           C
ATOM    225  O   MET D   5      14.680   9.000   7.775  1.00  0.00           O
ATOM    226  CB  MET D   5      13.042   6.896   8.525  1.00  0.00           C
ATOM    227  CG  MET D   5      12.226   5.783   9.162  1.00  0.00           C
ATOM    228  SD  MET D   5      12.466   4.191   8.350  1.00  0.00           S
ATOM    229  CE  MET D   5      11.320   3.166   9.268  1.00  0.00           C
ATOM    230  H   MET D   5      11.418   9.186   8.232  1.00  0.00           H
ATOM    231  HA  MET D   5      13.009   8.144  10.144  1.00  0.00           H
ATOM    232  HB2 MET D   5      12.772   6.965   7.596  1.00  0.00           H
ATOM    233  HB3 MET D   5      13.977   6.644   8.577  1.00  0.00           H
ATOM    234  HG2 MET D   5      12.490   5.689  10.091  1.00  0.00           H
ATOM    235  HG3 MET D   5      11.284   6.009   9.107  1.00  0.00           H
ATOM    236  HE1 MET D   5      11.356   2.262   8.918  1.00  0.00           H
ATOM    237  HE2 MET D   5      11.574   3.169  10.204  1.00  0.00           H
ATOM    238  HE3 MET D   5      10.425   3.525   9.167  1.00  0.00           H
ATOM    239  N   PHE D   6      13.825  10.488   9.205  1.00  0.00           N
ATOM    240  CA  PHE D   6      14.731  11.547   8.787  1.00  0.00           C
ATOM    241  C   PHE D   6      16.111  11.331   9.393  1.00  0.00           C
ATOM    242  O   PHE D   6      16.244  10.831  10.514  1.00  0.00           O
ATOM    243  CB  PHE D   6      14.186  12.914   9.206  1.00  0.00           C
ATOM    244  CG  PHE D   6      12.873  13.276   8.562  1.00  0.00           C
ATOM    245  CD1 PHE D   6      12.416  12.605   7.437  1.00  0.00           C
ATOM    246  CD2 PHE D   6      12.093  14.294   9.087  1.00  0.00           C
ATOM    247  CE1 PHE D   6      11.210  12.943   6.852  1.00  0.00           C
ATOM    248  CE2 PHE D   6      10.887  14.635   8.506  1.00  0.00           C
ATOM    249  CZ  PHE D   6      10.445  13.959   7.388  1.00  0.00           C
ATOM    250  H   PHE D   6      13.274  10.720   9.823  1.00  0.00           H
ATOM    251  HA  PHE D   6      14.827  11.530   7.822  1.00  0.00           H
ATOM    252  HB2 PHE D   6      14.055  12.916  10.167  1.00  0.00           H
ATOM    253  HB3 PHE D   6      14.833  13.595   8.962  1.00  0.00           H
ATOM    254  HD1 PHE D   6      12.924  11.919   7.069  1.00  0.00           H
ATOM    255  HD2 PHE D   6      12.386  14.753   9.841  1.00  0.00           H
ATOM    256  HE1 PHE D   6      10.914  12.486   6.099  1.00  0.00           H
ATOM    257  HE2 PHE D   6      10.373  15.320   8.869  1.00  0.00           H
ATOM    258  HZ  PHE D   6       9.634  14.188   6.995  1.00  0.00           H
ATOM    259  N   TRP D   7      17.142  11.711   8.641  1.00  0.00           N
ATOM    260  CA  TRP D   7      18.523  11.570   9.084  1.00  0.00           C
ATOM    261  C   TRP D   7      19.334  12.742   8.558  1.00  0.00           C
ATOM    262  O   TRP D   7      19.223  13.098   7.381  1.00  0.00           O
ATOM    263  CB  TRP D   7      19.129  10.247   8.600  1.00  0.00           C
ATOM    264  CG  TRP D   7      18.518   9.038   9.242  1.00  0.00           C
ATOM    265  CD1 TRP D   7      17.534   8.246   8.727  1.00  0.00           C
ATOM    266  CD2 TRP D   7      18.852   8.483  10.520  1.00  0.00           C
ATOM    267  NE1 TRP D   7      17.234   7.232   9.605  1.00  0.00           N
ATOM    268  CE2 TRP D   7      18.030   7.356  10.713  1.00  0.00           C
ATOM    269  CE3 TRP D   7      19.767   8.831  11.519  1.00  0.00           C
ATOM    270  CZ2 TRP D   7      18.095   6.573  11.864  1.00  0.00           C
ATOM    271  CZ3 TRP D   7      19.829   8.053  12.661  1.00  0.00           C
ATOM    272  CH2 TRP D   7      18.998   6.937  12.824  1.00  0.00           C
ATOM    273  H   TRP D   7      17.064  12.059   7.859  1.00  0.00           H
ATOM    274  HA  TRP D   7      18.555  11.585  10.053  1.00  0.00           H
ATOM    275  HB2 TRP D   7      18.996  10.173   7.642  1.00  0.00           H
ATOM    276  HB3 TRP D   7      20.077  10.244   8.803  1.00  0.00           H
ATOM    277  HD1 TRP D   7      17.125   8.373   7.901  1.00  0.00           H
ATOM    278  HE1 TRP D   7      16.644   6.620   9.479  1.00  0.00           H
ATOM    279  HE3 TRP D   7      20.322   9.570  11.418  1.00  0.00           H
ATOM    280  HZ2 TRP D   7      17.544   5.832  11.976  1.00  0.00           H
ATOM    281  HZ3 TRP D   7      20.434   8.274  13.332  1.00  0.00           H
ATOM    282  HH2 TRP D   7      19.063   6.433  13.603  1.00  0.00           H
ATOM    283  N   TYR D   8      20.146  13.338   9.431  1.00  0.00           N
ATOM    284  CA  TYR D   8      20.988  14.478   9.066  1.00  0.00           C
ATOM    285  C   TYR D   8      22.308  14.337   9.818  1.00  0.00           C
ATOM    286  O   TYR D   8      22.402  14.703  10.993  1.00  0.00           O
ATOM    287  CB  TYR D   8      20.302  15.800   9.392  1.00  0.00           C
ATOM    288  CG  TYR D   8      19.076  16.075   8.551  1.00  0.00           C
ATOM    289  CD1 TYR D   8      19.192  16.579   7.263  1.00  0.00           C
ATOM    290  CD2 TYR D   8      17.801  15.832   9.046  1.00  0.00           C
ATOM    291  CE1 TYR D   8      18.075  16.832   6.490  1.00  0.00           C
ATOM    292  CE2 TYR D   8      16.678  16.082   8.282  1.00  0.00           C
ATOM    293  CZ  TYR D   8      16.820  16.582   7.005  1.00  0.00           C
ATOM    294  OH  TYR D   8      15.704  16.833   6.240  1.00  0.00           O
ATOM    295  H   TYR D   8      20.228  13.097  10.252  1.00  0.00           H
ATOM    296  HA  TYR D   8      21.173  14.454   8.115  1.00  0.00           H
ATOM    297  HB2 TYR D   8      20.027  15.788  10.322  1.00  0.00           H
ATOM    298  HB3 TYR D   8      20.931  16.523   9.244  1.00  0.00           H
ATOM    299  HD1 TYR D   8      20.037  16.749   6.913  1.00  0.00           H
ATOM    300  HD2 TYR D   8      17.703  15.494   9.907  1.00  0.00           H
ATOM    301  HE1 TYR D   8      18.168  17.170   5.629  1.00  0.00           H
ATOM    302  HE2 TYR D   8      15.831  15.914   8.626  1.00  0.00           H
ATOM    303  HH  TYR D   8      15.010  16.638   6.671  1.00  0.00           H
ATOM    304  N   VAL D   9      23.320  13.807   9.139  1.00  0.00           N
ATOM    305  CA  VAL D   9      24.632  13.618   9.743  1.00  0.00           C
ATOM    306  C   VAL D   9      25.377  14.947   9.786  1.00  0.00           C
ATOM    307  O   VAL D   9      25.756  15.491   8.749  1.00  0.00           O
ATOM    308  CB  VAL D   9      25.449  12.559   8.980  1.00  0.00           C
ATOM    309  CG1 VAL D   9      26.843  12.427   9.578  1.00  0.00           C
ATOM    310  CG2 VAL D   9      24.726  11.220   8.995  1.00  0.00           C
ATOM    311  H   VAL D   9      23.271  13.548   8.320  1.00  0.00           H
ATOM    312  HA  VAL D   9      24.518  13.309  10.655  1.00  0.00           H
ATOM    313  HB  VAL D   9      25.544  12.838   8.056  1.00  0.00           H
ATOM    314 HG11 VAL D   9      27.251  11.612   9.245  1.00  0.00           H
ATOM    315 HG12 VAL D   9      27.376  13.193   9.316  1.00  0.00           H
ATOM    316 HG13 VAL D   9      26.769  12.386  10.544  1.00  0.00           H
ATOM    317 HG21 VAL D   9      25.275  10.560   8.542  1.00  0.00           H
ATOM    318 HG22 VAL D   9      24.578  10.952   9.915  1.00  0.00           H
ATOM    319 HG23 VAL D   9      23.876  11.314   8.536  1.00  0.00           H
TER
END
"""

pdb_str_2 = """
CRYST1   43.705   48.284   96.292  90.00  90.00  90.00 P 1
SCALE1      0.022881  0.000000  0.000000        0.00000
SCALE2      0.000000  0.020711  0.000000        0.00000
SCALE3      0.000000  0.000000  0.010385        0.00000
ATOM     37  N   LEU A   3      23.374 -21.865 -28.222  1.00 15.90           N
ATOM     38  CA  LEU A   3      23.342 -21.224 -29.530  1.00 15.47           C
ATOM     39  C   LEU A   3      23.637 -19.727 -29.491  1.00 18.18           C
ATOM     40  O   LEU A   3      24.174 -19.175 -30.462  1.00 20.24           O
ATOM     41  CB  LEU A   3      22.021 -21.521 -30.238  1.00 15.76           C
ATOM     42  CG  LEU A   3      21.790 -23.005 -30.533  1.00 19.30           C
ATOM     43  CD1 LEU A   3      20.460 -23.197 -31.290  1.00 20.74           C
ATOM     44  CD2 LEU A   3      22.957 -23.627 -31.336  1.00 17.02           C
ATOM     45  DA  LEU A   3      24.132 -21.653 -30.101  1.00 12.76           D
ATOM     46  DB3 LEU A   3      21.233 -21.196 -29.610  1.00 17.93           D
ATOM     48  DB2ALEU A   3      21.964 -20.976 -31.155  0.67 16.51           D
ATOM     49  DG ALEU A   3      21.719 -23.530 -29.581  0.68 18.31           D
REMARK ATOM     50 DD11ALEU A   3      19.620 -22.925 -30.652  0.74 20.52           D
ATOM     51 DD12ALEU A   3      20.364 -24.239 -31.597  0.77 19.78           D
ATOM     52 DD13ALEU A   3      20.458 -22.568 -32.171  0.49 20.26           D
ATOM     53 DD21ALEU A   3      23.466 -22.855 -31.890  0.40 16.87           D
REMARK ATOM     54 DD22ALEU A   3      22.563 -24.357 -32.028  0.00 16.68           D
ATOM     55 DD23ALEU A   3      23.653 -24.109 -30.673  0.89 14.39           D
ATOM     57  HB2BLEU A   3      21.964 -20.976 -31.155  0.33 14.51           H
ATOM     58  HG BLEU A   3      21.719 -23.530 -29.581  0.32 18.31           H
ATOM     59 HD11BLEU A   3      19.620 -22.925 -30.652  0.26 20.52           H
ATOM     60 HD12BLEU A   3      20.364 -24.239 -31.597  0.23 19.78           H
REMARK ATOM     61 HD13BLEU A   3      20.458 -22.568 -32.171  0.51 20.26           H
REMARK ATOM     62 HD21BLEU A   3      23.466 -22.855 -31.890  0.60 16.87           H
ATOM     63 HD22BLEU A   3      22.563 -24.357 -32.028  0.58 16.68           H
ATOM     64 HD23BLEU A   3      23.653 -24.109 -30.673  0.11 14.39           H
ATOM     65  N   SER A   4       9.243 -32.509 -36.471  1.00 38.02           N
ATOM     66  CA  SER A   4      10.063 -33.604 -36.981  1.00 39.55           C
ATOM     67  C   SER A   4      11.459 -33.153 -37.367  1.00 37.45           C
ATOM     68  O   SER A   4      11.633 -32.304 -38.239  1.00 38.82           O
ATOM     69  CB  SER A   4       9.384 -34.279 -38.180  1.00 41.66           C
ATOM     70  OG  SER A   4       8.375 -35.181 -37.753  1.00 44.91           O
ATOM     71  DA  SER A   4      10.165 -34.324 -36.187  1.00 38.72           D
ATOM     73  DB2ASER A   4      10.116 -34.818 -38.774  0.63 41.36           D
ATOM     74  DB3ASER A   4       8.918 -33.518 -38.793  0.36 41.73           D
ATOM     75  DG ASER A   4       8.699 -36.084 -37.842  0.36 43.61           D
ATOM     77  HB2BSER A   4       8.918 -33.518 -38.793  0.64 41.73           H
ATOM     78  HB3BSER A   4      10.116 -34.818 -38.774  0.37 41.36           H
ATOM     79  HG BSER A   4       8.699 -36.084 -37.842  0.64 43.61           H
ATOM     80  N   SER A   5      26.478 -19.398  45.776  1.00 19.78           N
ATOM     81  C   SER A   5      27.940 -19.562  43.818  1.00 21.99           C
ATOM     82  O   SER A   5      29.005 -19.770  43.306  1.00 21.20           O
ATOM     83  CA ASER A   5      27.849 -19.441  45.318  0.64 18.99           C
ATOM     84  CB ASER A   5      28.611 -20.590  45.987  0.64 21.66           C
ATOM     85  OG ASER A   5      28.819 -20.337  47.363  0.64 23.21           O
ATOM     86  DG ASER A   5      29.639 -20.155  47.499  0.64 22.10           D
ATOM     88  HA ASER A   5      28.296 -18.610  45.561  0.64 20.89           H
ATOM     89  HB2ASER A   5      28.094 -21.408  45.903  0.00 22.17           H
ATOM     90  HB3ASER A   5      29.468 -20.686  45.544  0.64 22.38           H
ATOM     91  CA BSER A   5      27.851 -19.476  45.322  0.36 19.02           C
ATOM     92  CB BSER A   5      28.561 -20.680  45.932  0.36 21.98           C
ATOM     93  OG BSER A   5      28.005 -21.879  45.425  0.36 25.40           O
ATOM     95  HA BSER A   5      28.327 -18.675  45.599  0.36 21.03           H
ATOM     96  HB2BSER A   5      29.498 -20.638  45.691  0.36 22.55           H
ATOM     97  HB3BSER A   5      28.462 -20.665  46.898  0.36 23.83           H
ATOM     98  HG BSER A   5      27.486 -22.196  46.000  0.36 22.10           H
TER
"""

if (__name__ == "__main__"):
  t0 = time.time()
  run()
  print("OK. Time: %8.3f"%(time.time()-t0))


 *******************************************************************************
